---
title: Mise à jour de compatibilité des disques au format avancé (4K)
description: Mise à jour de compatibilité des disques au format avancé (4K)
ms.assetid: 2C9EB0CF-D27B-457A-8FE6-24824BCC084C
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fbad505575c4479bd750f09ccd83bc4da4c39667
ms.sourcegitcommit: 78b64f3865e64768b5319d4f010032ee68924a98
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/13/2021
ms.locfileid: "107314972"
---
# <a name="advanced-format-4k-disk-compatibility-update"></a><span data-ttu-id="3cc78-103">Mise à jour de compatibilité des disques au format avancé (4K)</span><span class="sxs-lookup"><span data-stu-id="3cc78-103">Advanced format (4K) disk compatibility update</span></span>

## <a name="platforms"></a><span data-ttu-id="3cc78-104">Plateformes</span><span class="sxs-lookup"><span data-stu-id="3cc78-104">Platforms</span></span>

<span data-ttu-id="3cc78-105">**Clients**   Windows XP, Windows Vista, Windows 7, Windows 7 SP1, Windows 8</span><span class="sxs-lookup"><span data-stu-id="3cc78-105">**Clients**   Windows XP, Windows Vista, Windows 7, Windows 7 SP1, Windows 8</span></span>  
<span data-ttu-id="3cc78-106">**Serveurs**   Windows Server 2003, Windows Server 2008, Windows Server 2008 R2, Windows Server 2008 R2 SP1, Windows Server 2012, Windows Server 2012 R2 et Windows Server 2016</span><span class="sxs-lookup"><span data-stu-id="3cc78-106">**Servers**   Windows Server 2003, Windows Server 2008, Windows Server 2008 R2, Windows Server 2008 R2 SP1, Windows Server 2012, Windows Server 2012 R2, Windows Server 2016</span></span>  


## <a name="description"></a><span data-ttu-id="3cc78-107">Description</span><span class="sxs-lookup"><span data-stu-id="3cc78-107">Description</span></span>

<span data-ttu-id="3cc78-108">Cet article est une version mise à jour de l’article intitulé mise à jour de compatibilité des disques émulation (émulation de l’octet 512) qui a été publiée pour Windows 7 SP1 et Windows Server 2008 R2 SP1.</span><span class="sxs-lookup"><span data-stu-id="3cc78-108">This article is an updated version of the article titled  512-byte Emulation (512e) Disk Compatibility Update  which was released for Windows 7 SP1 and Windows Server 2008 R2 SP1.</span></span> <span data-ttu-id="3cc78-109">Cette mise à jour contient des informations très nouvelles, dont certaines s’appliquent uniquement à Windows 8 et Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="3cc78-109">This update contains much new info, some of which is applicable only to Windows 8 and Windows Server 2012.</span></span>

<span data-ttu-id="3cc78-110">Les densités de zone sont en augmentation annuelle et avec l’avènement récente de disques de 3 to, les mécanismes de correction d’erreur utilisés pour gérer le rapport de signal à bruit (SNR) diminuant la baisse de l’espace sont devenus inefficaces. autrement dit, une augmentation de la charge est nécessaire pour garantir que le média est utilisable.</span><span class="sxs-lookup"><span data-stu-id="3cc78-110">Areal densities are increasing yearly, and with the recent advent of 3 TB disks, the error correction mechanisms used to deal with the decreasing signal-to-noise-ratio (SNR) are becoming space inefficient; that is, an increased amount of overhead is required to ensure the media is usable.</span></span> <span data-ttu-id="3cc78-111">L’une des solutions de l’industrie du stockage pour améliorer ce mécanisme de correction des erreurs consiste à introduire un format de support physique différent qui comprend une plus grande taille de secteur physique.</span><span class="sxs-lookup"><span data-stu-id="3cc78-111">One of the storage industry solutions for improving this error correction mechanism is to introduce a different physical media format that includes a larger physical sector size.</span></span> <span data-ttu-id="3cc78-112">Ce nouveau format de média physique est appelé format avancé.</span><span class="sxs-lookup"><span data-stu-id="3cc78-112">This new physical media format is called Advanced Format.</span></span> <span data-ttu-id="3cc78-113">Par conséquent, il n’est plus sûr de faire des hypothèses concernant la taille des secteurs des appareils de stockage modernes, et les développeurs doivent étudier les hypothèses sous-jacentes de leur code pour déterminer s’il y a un impact.</span><span class="sxs-lookup"><span data-stu-id="3cc78-113">Therefore, it is no longer safe to make any assumptions regarding the sector size of modern storage devices, and developers will need to study the assumptions underlying their code to determine if there is an impact.</span></span>

<span data-ttu-id="3cc78-114">Cette rubrique présente l’effet des dispositifs de stockage de format avancés sur les logiciels, explique ce que les applications peuvent faire pour aider à prendre en charge ce type de média et présente l’infrastructure que Microsoft a introduite avec Windows Vista, Windows 7 et Windows 8 pour permettre aux développeurs de prendre en charge ces types d’appareils.</span><span class="sxs-lookup"><span data-stu-id="3cc78-114">This topic introduces the effect of Advanced Format storage devices on software, discusses what apps can do to help support this type of media, and discusses the infrastructure that Microsoft introduced with Windows Vista, Windows 7, and Windows 8 to enable developers to support these types of devices.</span></span> <span data-ttu-id="3cc78-115">Tandis que les éléments présentés dans cette rubrique fournissent des instructions pour améliorer la compatibilité avec les disques au format avancé, les informations s’appliquent généralement à tous les systèmes avec des disques au format avancé exécutant Windows Vista, Windows 7 et Windows 8.</span><span class="sxs-lookup"><span data-stu-id="3cc78-115">While the material presented in this topic provides guidelines for improving compatibility with Advanced Format disks, the info applies generally to all systems with Advanced Format disks running Windows Vista, Windows 7, and Windows 8.</span></span>

<span data-ttu-id="3cc78-116">**Résumé des nouvelles fonctionnalités liées aux grands secteurs**</span><span class="sxs-lookup"><span data-stu-id="3cc78-116">**Summary of new large sector related features**</span></span>

<span data-ttu-id="3cc78-117">La liste ci-dessous récapitule les nouvelles fonctionnalités fournies dans le cadre de Windows 8 et de Windows Server 2012 afin d’améliorer l’expérience des clients et des développeurs avec des disques de secteurs importants.</span><span class="sxs-lookup"><span data-stu-id="3cc78-117">The below list summarizes the new features delivered as part of Windows 8 and Windows Server 2012 to help improve customer and developer experience with large sector disks.</span></span> <span data-ttu-id="3cc78-118">Description plus détaillée de chaque élément.</span><span class="sxs-lookup"><span data-stu-id="3cc78-118">More detailed description for each item follow.</span></span>

-   <span data-ttu-id="3cc78-119">S’appuie sur la prise en charge de Windows 7 SP1 pour les disques 4 Ko avec émulation (émulation) et fournit une prise en charge complète de la boîte de réception pour les disques avec une taille de secteur de 4 Ko sans émulation (4 Ko natifs).</span><span class="sxs-lookup"><span data-stu-id="3cc78-119">Builds upon the Windows 7 SP1 support for 4K disks with emulation (512e), and provides full inbox support for disks with 4K sector size without emulation (4K Native).</span></span> <span data-ttu-id="3cc78-120">Voici quelques exemples d’applications et de scénarios pris en charge :</span><span class="sxs-lookup"><span data-stu-id="3cc78-120">Some supported apps and scenarios include:</span></span>
    -   <span data-ttu-id="3cc78-121">Possibilité d’installer Windows to et de démarrer à partir d’un disque de secteur 4K sans émulation (disque natif 4K)</span><span class="sxs-lookup"><span data-stu-id="3cc78-121">Ability to install Windows to and boot from a 4K sector disk without emulation (4K Native Disk)</span></span>
    -   <span data-ttu-id="3cc78-122">VHD et nouveau format de fichier VHDX</span><span class="sxs-lookup"><span data-stu-id="3cc78-122">VHD and new VHDX file format</span></span>
    -   <span data-ttu-id="3cc78-123">Prise en charge de HyperV complète</span><span class="sxs-lookup"><span data-stu-id="3cc78-123">Full HyperV support</span></span>
    -   <span data-ttu-id="3cc78-124">Sauvegarde Windows</span><span class="sxs-lookup"><span data-stu-id="3cc78-124">Windows backup</span></span>
    -   <span data-ttu-id="3cc78-125">Prise en charge complète dans le système de fichiers NT (NTFS)</span><span class="sxs-lookup"><span data-stu-id="3cc78-125">Full support in the NT file system (NTFS)</span></span>
    -   <span data-ttu-id="3cc78-126">Prise en charge complète avec de nouveaux espaces de stockage et pools (SSP)</span><span class="sxs-lookup"><span data-stu-id="3cc78-126">Full support with new Storage Spaces and Pools (SSP)</span></span>
    -   <span data-ttu-id="3cc78-127">Prise en charge complète avec Windows Defender</span><span class="sxs-lookup"><span data-stu-id="3cc78-127">Full support with Windows Defender</span></span>
-   <span data-ttu-id="3cc78-128">Fournit une nouvelle API pour interroger la taille de secteur physique (FileFsSectorSizeInformation) :</span><span class="sxs-lookup"><span data-stu-id="3cc78-128">Provides a new API to query for physical sector size (FileFsSectorSizeInformation):</span></span>
    -   <span data-ttu-id="3cc78-129">Disponible pour les volumes réseau</span><span class="sxs-lookup"><span data-stu-id="3cc78-129">Available for network volumes</span></span>
    -   <span data-ttu-id="3cc78-130">Peut être délivré à n’importe quel handle de fichier</span><span class="sxs-lookup"><span data-stu-id="3cc78-130">Can be issued to any file handle</span></span>
    -   <span data-ttu-id="3cc78-131">Disponible pour les applications non privilégiées</span><span class="sxs-lookup"><span data-stu-id="3cc78-131">Available for unprivileged apps</span></span>
    -   <span data-ttu-id="3cc78-132">Modèle d’utilisation plus convivial</span><span class="sxs-lookup"><span data-stu-id="3cc78-132">Friendlier usage model</span></span>
-   <span data-ttu-id="3cc78-133">Comprend l’utilitaire de ligne de commande fsutil amélioré pour interroger la taille de secteur logique et physique du volume avec les informations d’alignement (la version de base de l’utilitaire sans informations d’alignement est disponible pour Windows 7 avec Microsoft KB 982018 et Windows Server 2008 R2 avec Microsoft KB 982018)</span><span class="sxs-lookup"><span data-stu-id="3cc78-133">Includes enhanced  fsutil  command line utility to query for logical and physical sector size of volume with alignment info (basic version of utility without alignment info is available for Windows 7 with Microsoft KB 982018 and Windows Server 2008 R2 with Microsoft KB 982018)</span></span>

<span data-ttu-id="3cc78-134">**Présentation des disques au format avancé (4 Ko)**</span><span class="sxs-lookup"><span data-stu-id="3cc78-134">**Introduction to advanced format (4K) disks**</span></span>

<span data-ttu-id="3cc78-135">L’un des problèmes liés à l’introduction de cette modification dans le format multimédia est la possibilité d’introduire des problèmes de compatibilité avec les logiciels et le matériel existants.</span><span class="sxs-lookup"><span data-stu-id="3cc78-135">One of the problems of introducing this change in the media format is the potential for introducing compatibility issues with existing software and hardware.</span></span> <span data-ttu-id="3cc78-136">En guise de solution de compatibilité temporaire, le secteur du stockage commence par introduire des disques qui émulent un disque de secteur standard de 512 octets, mais qui rendent disponibles des informations sur la taille réelle des secteurs via des commandes ATA et SCSI standard.</span><span class="sxs-lookup"><span data-stu-id="3cc78-136">As a temporary compatibility solution, the storage industry is initially introducing disks that emulate a regular 512-byte sector disk, but make available info about the true sector size through standard ATA and SCSI commands.</span></span> <span data-ttu-id="3cc78-137">À la suite de cette émulation, il existe, essentiellement, deux tailles de secteur :</span><span class="sxs-lookup"><span data-stu-id="3cc78-137">As a result of this emulation, there are, in essence, two sector sizes:</span></span>

<span data-ttu-id="3cc78-138">**Secteur logique :** Unité utilisée pour l’adressage de bloc logique pour le média.</span><span class="sxs-lookup"><span data-stu-id="3cc78-138">**Logical sector:** The unit that is used for logical block addressing for the media.</span></span> <span data-ttu-id="3cc78-139">Nous pouvons également considérer qu’il s’agit de la plus petite unité d’écriture que le stockage peut accepter.</span><span class="sxs-lookup"><span data-stu-id="3cc78-139">We can also think of it as the smallest unit of write that the storage can accept.</span></span> <span data-ttu-id="3cc78-140">Il s’agit de l’émulation.</span><span class="sxs-lookup"><span data-stu-id="3cc78-140">This is the  emulation.</span></span>   
<span data-ttu-id="3cc78-141">**Secteur physique :** L’unité pour laquelle les opérations de lecture et d’écriture sont effectuées sur l’appareil en une seule opération.</span><span class="sxs-lookup"><span data-stu-id="3cc78-141">**Physical sector:** The unit for which read and write operations to the device are completed in a single operation.</span></span> <span data-ttu-id="3cc78-142">Il s’agit de l’unité d’écriture atomique.</span><span class="sxs-lookup"><span data-stu-id="3cc78-142">This is the unit of atomic write.</span></span>  
 <span data-ttu-id="3cc78-143">La plupart des API Windows actuelles, telles \_ que \_ le disque IOCTL obtiennent \_ \_ une géométrie de lecteur, retournent la taille de secteur logique, mais la taille de secteur physique peut être récupérée par le biais du code de contrôle de propriété de <a href="/windows-hardware/drivers/ddi/content/ntddstor/ni-ntddstor-ioctl_storage_query_property"> \_ \_ requête \_ de stockage IOCTL</a> , avec les informations pertinentes contenues dans le champ BytesPerPhysicalSector de la structure du <a href="/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor"> \_ \_ \_ descripteur d’alignement de l’accès au stockage</a> .</span><span class="sxs-lookup"><span data-stu-id="3cc78-143">Most current Windows APIs, such as IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY will return the logical sector size, but the physical sector size can be retrieved through the <a href="/windows-hardware/drivers/ddi/content/ntddstor/ni-ntddstor-ioctl_storage_query_property">IOCTL\_STORAGE\_QUERY\_PROPERTY</a> control code, with the relevant info contained in the BytesPerPhysicalSector field in the <a href="/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor">STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR</a> structure.</span></span> <span data-ttu-id="3cc78-144">Ce sujet est abordé plus en détail plus loin dans cet article.</span><span class="sxs-lookup"><span data-stu-id="3cc78-144">This is discussed in more detail later in the article.</span></span>

<span data-ttu-id="3cc78-145">**Types initiaux des médias de grands secteurs**</span><span class="sxs-lookup"><span data-stu-id="3cc78-145">**Initial types of large sector media**</span></span>

<span data-ttu-id="3cc78-146">Le secteur du stockage a rapidement mis en œuvre des efforts de transition vers ce nouveau type de stockage avancé pour les médias ayant une taille de secteur physique de 4 Ko.</span><span class="sxs-lookup"><span data-stu-id="3cc78-146">The storage industry is quickly ramping up efforts to transition to this new Advanced Format type of storage for media having a 4 KB physical sector size.</span></span> <span data-ttu-id="3cc78-147">Deux types de médias seront publiés sur le marché :</span><span class="sxs-lookup"><span data-stu-id="3cc78-147">Two types of media will be released to the market:</span></span>

<span data-ttu-id="3cc78-148">**4 Ko natifs :** Ce support n’a pas de couche d’émulation et expose directement 4 Ko comme taille de secteur logique et physique.</span><span class="sxs-lookup"><span data-stu-id="3cc78-148">**4 KB native:** This media has no emulation layer and directly exposes 4 KB as its logical and physical sector size.</span></span> <span data-ttu-id="3cc78-149">Le problème global de ce nouveau type de média est que la majorité des applications et des systèmes d’exploitation ne recherchent pas et alignent les e/s sur la taille de secteur physique, ce qui peut entraîner des e/s ayant échoué inattendues.</span><span class="sxs-lookup"><span data-stu-id="3cc78-149">The overall issue with this new type of media is that the majority of apps and operating systems do not query for and align I/Os to the physical sector size, which can result in unexpected failed I/Os.</span></span>  
<span data-ttu-id="3cc78-150">**512-émulation d’octet (émulation) :** Ce support a une couche d’émulation comme indiqué dans la section précédente et expose 512-octets comme taille de secteur logique (semblable à un disque normal aujourd’hui), mais rend ses informations de taille de secteur physique (4 Ko) disponibles.</span><span class="sxs-lookup"><span data-stu-id="3cc78-150">**512-byte emulation (512e):** This media has an emulation layer as discussed in the previous section and exposes 512-bytes as its logical sector size (similar to a regular disk today), but makes its physical sector size info (4 KB) available.</span></span> <span data-ttu-id="3cc78-151">Le problème global de ce nouveau type de média est que la majorité des applications et des systèmes d’exploitation ne comprennent pas l’existence de la taille de secteur physique, ce qui peut entraîner un certain nombre de problèmes, comme indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="3cc78-151">The overall issue with this new type of media is that the majority of app and operating systems do not understand the existence of the physical sector size, which can result in a number of issues as will be discussed below.</span></span>  
<span data-ttu-id="3cc78-152">**Prise en charge globale de Windows pour les grands secteurs**</span><span class="sxs-lookup"><span data-stu-id="3cc78-152">**Overall Windows support for large sector media**</span></span>

<span data-ttu-id="3cc78-153">Ce tableau décrit la politique officielle de support Microsoft pour les différents médias et leurs tailles de secteurs signalées.</span><span class="sxs-lookup"><span data-stu-id="3cc78-153">This table documents the official Microsoft support policy for various media and their resulting reported sector sizes.</span></span> <span data-ttu-id="3cc78-154">Pour plus d’informations, consultez cet article de la [base de connaissances](https://support.microsoft.com/kb/2510009) .</span><span class="sxs-lookup"><span data-stu-id="3cc78-154">See this [KB article](https://support.microsoft.com/kb/2510009) for details.</span></span>



| <span data-ttu-id="3cc78-155">Noms communs</span><span class="sxs-lookup"><span data-stu-id="3cc78-155">Common Names</span></span>                                  | <span data-ttu-id="3cc78-156">Taille de secteur logique signalée</span><span class="sxs-lookup"><span data-stu-id="3cc78-156">Reported Logical Sector Size</span></span> | <span data-ttu-id="3cc78-157">Taille de secteur physique signalée</span><span class="sxs-lookup"><span data-stu-id="3cc78-157">Reported Physical Sector Size</span></span> | <span data-ttu-id="3cc78-158">Version de Windows avec prise en charge</span><span class="sxs-lookup"><span data-stu-id="3cc78-158">Windows Version with Support</span></span>                                                                                                                                                                                                                                                                             |
|-----------------------------------------------|------------------------------|-------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="3cc78-159">512 octets natif, 512N</span><span class="sxs-lookup"><span data-stu-id="3cc78-159">512-byte Native, 512n</span></span>                         | <span data-ttu-id="3cc78-160">512 octets</span><span class="sxs-lookup"><span data-stu-id="3cc78-160">512 bytes</span></span>                    | <span data-ttu-id="3cc78-161">512 octets</span><span class="sxs-lookup"><span data-stu-id="3cc78-161">512 bytes</span></span>                     | <span data-ttu-id="3cc78-162">Toutes les versions de Windows</span><span class="sxs-lookup"><span data-stu-id="3cc78-162">All Windows versions</span></span>                                                                                                                                                                                                                                                                                     |
| <span data-ttu-id="3cc78-163">Format avancé, émulation, AF, émulation de 512 octets</span><span class="sxs-lookup"><span data-stu-id="3cc78-163">Advanced Format, 512e, AF, 512-byte Emulation</span></span> | <span data-ttu-id="3cc78-164">512 octets</span><span class="sxs-lookup"><span data-stu-id="3cc78-164">512 bytes</span></span>                    | <span data-ttu-id="3cc78-165">4 Ko</span><span class="sxs-lookup"><span data-stu-id="3cc78-165">4 KB</span></span>                          | <span data-ttu-id="3cc78-166">Windows Vista avec MS KB 2553708</span><span class="sxs-lookup"><span data-stu-id="3cc78-166">Windows Vista w/ MS KB 2553708</span></span> <br/> <span data-ttu-id="3cc78-167">Windows Server 2008 \* avec MS ko 2553708</span><span class="sxs-lookup"><span data-stu-id="3cc78-167">Windows Server 2008\* w/ MS KB 2553708</span></span> <br/> <span data-ttu-id="3cc78-168">Windows 7 avec MS KB 982018</span><span class="sxs-lookup"><span data-stu-id="3cc78-168">Windows 7 w/ MS KB 982018</span></span> <br/> <span data-ttu-id="3cc78-169">Windows Server 2008 R2 \* avec MS KB 982018</span><span class="sxs-lookup"><span data-stu-id="3cc78-169">Windows Server 2008 R2\* w/ MS KB 982018</span></span> <br/> <span data-ttu-id="3cc78-170">Toutes les versions de Windows à partir de Windows 7 SP1 et versions ultérieures.</span><span class="sxs-lookup"><span data-stu-id="3cc78-170">All Windows versions from Windows 7 SP1 and beyond.</span></span> <br/> <span data-ttu-id="3cc78-171">Toutes les versions serveur du serveur 2008 R2 SP1 et versions ultérieures.</span><span class="sxs-lookup"><span data-stu-id="3cc78-171">All Server versions from Server 2008 R2 SP1 and beyond.</span></span> <br/> <br/> <span data-ttu-id="3cc78-172">\*Sauf pour Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="3cc78-172">\*Except for Hyper-V.</span></span> <span data-ttu-id="3cc78-173">Consultez la section [« spécifications de prise en charge des applications pour les lecteurs de secteurs importants »](https://support.microsoft.com/help/2510009/microsoft-support-policy-for-4k-sector-hard-drives-in-windows) .</span><span class="sxs-lookup"><span data-stu-id="3cc78-173">See the ["Application support requirements for large-sector drives"](https://support.microsoft.com/help/2510009/microsoft-support-policy-for-4k-sector-hard-drives-in-windows) section.</span></span> |
| <span data-ttu-id="3cc78-174">Advanced format, AF, 4K native, 4Kn</span><span class="sxs-lookup"><span data-stu-id="3cc78-174">Advance Format, AF, 4K Native, 4Kn</span></span>            | <span data-ttu-id="3cc78-175">4 Ko</span><span class="sxs-lookup"><span data-stu-id="3cc78-175">4 KB</span></span>                         | <span data-ttu-id="3cc78-176">4 Ko</span><span class="sxs-lookup"><span data-stu-id="3cc78-176">4 KB</span></span>                          | <span data-ttu-id="3cc78-177">Toutes les versions de Windows à partir de Windows 8 et versions ultérieures</span><span class="sxs-lookup"><span data-stu-id="3cc78-177">All Windows versions from Windows 8 and beyond</span></span> <br/> <span data-ttu-id="3cc78-178">Toutes les versions serveur de Windows Server 2012 et versions ultérieures</span><span class="sxs-lookup"><span data-stu-id="3cc78-178">All Server versions from Windows Server 2012 and beyond</span></span> <br/>                                                                                                                                                                                                                                                      |
| <span data-ttu-id="3cc78-179">Autres</span><span class="sxs-lookup"><span data-stu-id="3cc78-179">Other</span></span>                                         | <span data-ttu-id="3cc78-180">Pas 4 Ko ou 512 octets</span><span class="sxs-lookup"><span data-stu-id="3cc78-180">Not 4 KB or 512 bytes</span></span>        | <span data-ttu-id="3cc78-181">Pas 4 Ko ou 512 octets</span><span class="sxs-lookup"><span data-stu-id="3cc78-181">Not 4 KB or 512 bytes</span></span>         | <span data-ttu-id="3cc78-182">Non pris en charge</span><span class="sxs-lookup"><span data-stu-id="3cc78-182">Not supported</span></span>                                                                                                                                                                                                                                                                                            |



 

> [!Note]  
> <span data-ttu-id="3cc78-183">Bien qu’ils ne soient pas soulignés dans le tableau précédent, Windows XP, Windows Server 2003 et Windows Server 2003 R2 ne prennent pas en charge les supports émulation ou 4Kn.</span><span class="sxs-lookup"><span data-stu-id="3cc78-183">While not stressed in the preceding table, Windows XP, Windows Server 2003, and Windows Server 2003 R2 do not support 512e or 4Kn media.</span></span> <span data-ttu-id="3cc78-184">Si le système peut démarrer et être en mesure de fonctionner au minimum, il peut y avoir des scénarios inconnus de problèmes de fonctionnalité, de perte de données ou de performances non optimales.</span><span class="sxs-lookup"><span data-stu-id="3cc78-184">While the system may boot up and be able to operate minimally, there may be unknown scenarios of functionality issues, data loss, or sub-optimal performance.</span></span> <span data-ttu-id="3cc78-185">Par conséquent, Microsoft recommande vivement d’utiliser des médias émulation avec Windows XP ou d’autres produits basés sur le code base Windows XP (par exemple, Windows édition Windows Server 1,0, Windows Server 2003, Windows Server 2003 R2, Windows XP 64 bits, Windows XP Embedded, Windows Small Business Server 2003 et Windows Small Business Server 2003 R2).</span><span class="sxs-lookup"><span data-stu-id="3cc78-185">Thus, Microsoft strongly cautions against using 512e media with Windows XP or other products based on the Windows XP codebase (such as Windows Home Server 1.0, Windows Server 2003, Windows Server 2003 R2, Windows XP 64-bit Edition, Windows XP Embedded, Windows Small Business Server 2003, and Windows Small Business Server 2003 R2).</span></span>

 

## <a name="how-emulation-works-read-modify-write-rmw"></a><span data-ttu-id="3cc78-186">Fonctionnement de l’émulation : lecture-modification-écriture (RMW)</span><span class="sxs-lookup"><span data-stu-id="3cc78-186">How emulation works: read-modify-write (RMW)</span></span>

<span data-ttu-id="3cc78-187">Un support de stockage a une certaine unité dans laquelle le support physique peut être modifié.</span><span class="sxs-lookup"><span data-stu-id="3cc78-187">A storage medium has a certain unit within which the physical medium can be modified.</span></span> <span data-ttu-id="3cc78-188">Autrement dit, le support peut uniquement être écrit, ou réécrit, dans des unités de la taille de secteur physique.</span><span class="sxs-lookup"><span data-stu-id="3cc78-188">That is, the media can only be written, or rewritten, in units of the physical sector size.</span></span> <span data-ttu-id="3cc78-189">Par conséquent, les écritures qui ne sont pas exécutées à ce niveau d’unité nécessitent des étapes supplémentaires, que nous allons examiner dans l’exemple ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="3cc78-189">Thus, writes that are not performed at this unit level would require additional steps, which we will walk through the example below.</span></span>

<span data-ttu-id="3cc78-190">Dans ce scénario, une application doit mettre à jour le contenu d’un enregistrement DataStor situé dans un secteur logique de 512 octets.</span><span class="sxs-lookup"><span data-stu-id="3cc78-190">In this scenario, an app needs to update the contents of a Datastor record located within a 512-byte logical sector.</span></span> <span data-ttu-id="3cc78-191">Ce diagramme illustre les étapes nécessaires pour que le périphérique de stockage termine l’écriture :</span><span class="sxs-lookup"><span data-stu-id="3cc78-191">This diagram illustrates the steps necessary for the storage device to complete the write:</span></span>

![étapes pour qu’un dispositif de stockage termine une écriture](images/512ermwsteps.png)

<span data-ttu-id="3cc78-193">Comme illustré ci-dessus, ce processus implique un travail du dispositif de stockage qui peut entraîner une perte de performances.</span><span class="sxs-lookup"><span data-stu-id="3cc78-193">As illustrated above, this process involves some work by the storage device that can result in a performance loss.</span></span> <span data-ttu-id="3cc78-194">Pour éviter ce travail supplémentaire, les applications doivent être mises à jour pour :</span><span class="sxs-lookup"><span data-stu-id="3cc78-194">To avoid this additional work, apps must be updated to:</span></span>

-   <span data-ttu-id="3cc78-195">Requête pour la taille de secteur physique</span><span class="sxs-lookup"><span data-stu-id="3cc78-195">Query for the physical sector size</span></span>
-   <span data-ttu-id="3cc78-196">Vérifier que les écritures sont alignées sur la taille de secteur physique indiquée</span><span class="sxs-lookup"><span data-stu-id="3cc78-196">Ensure writes are aligned to that reported physical sector size</span></span>

<span data-ttu-id="3cc78-197">Bien que cela puisse paraître initialement être un problème de performance, il peut y avoir un problème plus sérieux.</span><span class="sxs-lookup"><span data-stu-id="3cc78-197">While this may initially appear to be only a performance issue, there can be more serious issue.</span></span> <span data-ttu-id="3cc78-198">Passons à ce sujet dans la section suivante.</span><span class="sxs-lookup"><span data-stu-id="3cc78-198">Let s discuss this in the next section.</span></span>

<span data-ttu-id="3cc78-199">**Résilience : coût masqué de lecture-modification-écriture**</span><span class="sxs-lookup"><span data-stu-id="3cc78-199">**Resiliency: the hidden cost of read-modify-write**</span></span>

<span data-ttu-id="3cc78-200">La résilience est la capacité d’une application à récupérer l’état entre les sessions.</span><span class="sxs-lookup"><span data-stu-id="3cc78-200">Resiliency speaks of the ability of an app to recover state between sessions.</span></span> <span data-ttu-id="3cc78-201">Nous avons vu ce qui est nécessaire pour qu’un dispositif de stockage émulation exécute un secteur de 512 octets pour écrire le cycle de lecture-modification-écriture.</span><span class="sxs-lookup"><span data-stu-id="3cc78-201">We have seen what is necessary for a 512e storage device to perform a 512-byte sector write   the Read-Modify-Write cycle.</span></span> <span data-ttu-id="3cc78-202">Observons ce qui se passe si le processus de remplacement du secteur physique précédent sur le support a été interrompu.</span><span class="sxs-lookup"><span data-stu-id="3cc78-202">Let s look at what would happen if the process of overwriting the previous physical sector on the media was interrupted.</span></span> <span data-ttu-id="3cc78-203">Quelles sont les conséquences ?</span><span class="sxs-lookup"><span data-stu-id="3cc78-203">What would be the consequences?</span></span>

-   <span data-ttu-id="3cc78-204">Étant donné que la plupart des lecteurs de disque dur sont mis à jour en place, le secteur physique qui est, la partie du support où se trouvait le secteur physique pourrait avoir été endommagé avec des informations incomplètes en raison d’un remplacement partiel.</span><span class="sxs-lookup"><span data-stu-id="3cc78-204">Because most hard disk drives update in place, the physical sector   that is, the portion of the media where the physical sector was located   could have been corrupted with incomplete info due to a partial overwrite.</span></span> <span data-ttu-id="3cc78-205">En d’autres termes, vous pouvez le considérer comme susceptible d’avoir perdu les 8 secteurs logiques que le secteur physique contient logiquement.</span><span class="sxs-lookup"><span data-stu-id="3cc78-205">Put another way, you can think of it as potentially having lost all 8 logical sectors (which the physical sector logically contains).</span></span>
-   <span data-ttu-id="3cc78-206">Alors que la plupart des applications avec un magasin de données sont conçues avec la possibilité de récupérer à partir d’erreurs de support, la perte de huit secteurs ou d’une autre façon, la perte de huit enregistrements de validation, peut potentiellement empêcher la récupération normale de la Banque de données.</span><span class="sxs-lookup"><span data-stu-id="3cc78-206">While most apps with a data store are designed with the capability to recover from media errors, the loss of eight sectors, or put another way, the loss of eight commit records, can potentially make it impossible for the data store to recover gracefully.</span></span> <span data-ttu-id="3cc78-207">Un administrateur peut avoir besoin de restaurer manuellement la base de données à partir d’une sauvegarde ou de devoir effectuer une reconstruction longue.</span><span class="sxs-lookup"><span data-stu-id="3cc78-207">An administrator may need to manually restore the database from a backup or may even need to perform a lengthy rebuild.</span></span>
-   <span data-ttu-id="3cc78-208">Un impact plus important est que l’acte d’une autre application provoquant un cycle de lecture-modification-écriture peut potentiellement entraîner la perte de vos données même si votre application n’est pas en cours d’exécution !</span><span class="sxs-lookup"><span data-stu-id="3cc78-208">One more important impact is that the act of another app causing a Read-Modify-Write cycle can potentially cause your data to be lost   even if your app is not running!</span></span> <span data-ttu-id="3cc78-209">Cela est tout simplement dû au fait que vos données et les autres données de l’application peuvent se trouver dans le même secteur physique.</span><span class="sxs-lookup"><span data-stu-id="3cc78-209">This is simply because your data and the other app s data could be located within the same physical sector.</span></span>

<span data-ttu-id="3cc78-210">Dans ce cas, il est important que les logiciels d’application réévaluent les hypothèses prises dans le code, et qu’ils soient conscients de la différence de taille de secteur physique logique, ainsi que certains scénarios clients intéressants décrits plus loin dans cet article.</span><span class="sxs-lookup"><span data-stu-id="3cc78-210">With this in mind, it is important that app software reevaluate any assumptions taken in the code, and be aware of the logical-physical sector size distinction, along with some interesting customer scenarios discussed later in this article.</span></span>

<span data-ttu-id="3cc78-211">**Faire la bonne chose (éviter les opérations de lecture-modification-écriture)**</span><span class="sxs-lookup"><span data-stu-id="3cc78-211">**Doing the right thing (avoiding read-modify-write)**</span></span>

<span data-ttu-id="3cc78-212">Si certains fournisseurs de stockage peuvent introduire des niveaux d’atténuation au sein de certains dispositifs de stockage émulation pour tenter de faciliter les problèmes de performances et de résilience du cycle de lecture-modification-écriture, il n’y a que peu d’atténuation pouvant être gérée en termes de charge de travail.</span><span class="sxs-lookup"><span data-stu-id="3cc78-212">While some storage vendors may be introducing some levels of mitigation within certain 512e storage devices to try to ease the performance and resiliency issues of the Read-Modify-Write cycle, there is only so much any mitigation can handle in terms of workload.</span></span> <span data-ttu-id="3cc78-213">Par conséquent, les applications ne doivent pas s’appuyer sur cette atténuation comme une solution à long terme.</span><span class="sxs-lookup"><span data-stu-id="3cc78-213">As such, apps should not rely on this mitigation as a long-term solution.</span></span> <span data-ttu-id="3cc78-214">De plus, il n’y a aucune garantie que toutes les classes de disques auront cette atténuation en place, et qu’il n’y a pas de garantie que l’atténuation est bien conçue.</span><span class="sxs-lookup"><span data-stu-id="3cc78-214">Moreover, there is no guarantee that all classes of disks will have this mitigation in place, nor is there a guarantee that the mitigation is well-designed.</span></span>

<span data-ttu-id="3cc78-215">La solution à cela n’est pas une atténuation dans le lecteur, mais pour concevoir des applications qui font le bon ensemble de choses pour aider à prendre en charge ce type de média.</span><span class="sxs-lookup"><span data-stu-id="3cc78-215">The solution to this is not in-drive mitigation, but to design apps to do the right set of things to help support this type of media.</span></span> <span data-ttu-id="3cc78-216">Cette section décrit les scénarios courants dans lesquels les applications peuvent rencontrer des problèmes avec les disques de secteurs importants et suggère un moyen d’investigation pour essayer et résoudre chaque problème.</span><span class="sxs-lookup"><span data-stu-id="3cc78-216">This section discusses common scenarios where apps may have issues with large sector disks, and suggests an avenue of investigation to try and resolve each issue.</span></span>

<span data-ttu-id="3cc78-217">**Problème 1 : la partition n’est pas alignée sur une limite de secteur physique**</span><span class="sxs-lookup"><span data-stu-id="3cc78-217">**Issue 1: the partition is not aligned to a physical sector boundary**</span></span>

<span data-ttu-id="3cc78-218">Lorsque l’administrateur/l’utilisateur partitionne le disque, la première partition n’a peut-être pas été créée sur une limite alignée.</span><span class="sxs-lookup"><span data-stu-id="3cc78-218">When the administrator/user partitions the disk, the first partition may not have been created on an aligned boundary.</span></span> <span data-ttu-id="3cc78-219">Cela peut entraîner la non-alignement de toutes les écritures suivantes sur les limites du secteur physique.</span><span class="sxs-lookup"><span data-stu-id="3cc78-219">This may cause all subsequent writes to become unaligned to physical sector boundaries.</span></span> <span data-ttu-id="3cc78-220">À compter de Windows Vista SP1 et de Windows Server 2008, la première partition est placée au premier 1024 Ko du disque (pour les disques 4 Go ou plus, sinon l’alignement est de 64 Ko) qui est aligné sur une limite de secteur physique de 4 Ko.</span><span class="sxs-lookup"><span data-stu-id="3cc78-220">As of Windows Vista SP1 and Windows Server 2008, the first partition is placed at the first 1024 KB of the disk (for disks 4GB or larger, otherwise the alignment is 64 KB) that is aligned to a 4 KB physical sector boundary.</span></span> <span data-ttu-id="3cc78-221">Toutefois, étant donné le partitionnement par défaut dans Windows XP, un utilitaire de partitionnement tiers ou une utilisation incorrecte des API Windows, les partitions créées peuvent ne pas être alignées sur une limite de secteur physique.</span><span class="sxs-lookup"><span data-stu-id="3cc78-221">However, given the default partitioning in Windows XP, a 3rd party partitioning utility or incorrect usage of Windows APIs, created partitions may not be aligned to a physical sector boundary.</span></span> <span data-ttu-id="3cc78-222">Les développeurs doivent s’assurer que les API correctes sont utilisées pour garantir l’alignement.</span><span class="sxs-lookup"><span data-stu-id="3cc78-222">Developers will need to ensure that the correct APIs are used to help ensure alignment.</span></span> <span data-ttu-id="3cc78-223">Les API recommandées pour garantir l’alignement des partitions sont décrites ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="3cc78-223">The recommended APIs to help ensure partition alignment are outlined below.</span></span>

<span data-ttu-id="3cc78-224">Les API IVdsPack :: CreateVolume et IVdsPack2 :: CreateVolume2 n’utilisent pas le paramètre d’alignement spécifié lors de la création d’un nouveau volume, mais utilisent plutôt la valeur d’alignement par défaut pour le système d’exploitation (pré-Windows Vista SP1 utilise 63 octets, et Windows Vista SP1 utilise les valeurs par défaut indiquées ci-dessus).</span><span class="sxs-lookup"><span data-stu-id="3cc78-224">The IVdsPack::CreateVolume and IVdsPack2::CreateVolume2 APIs do not use the specified alignment parameter when a new volume is created, but rather use the alignment value default for the operating system (Pre-Windows Vista SP1 will use 63 bytes, and post Windows Vista SP1 will use the defaults stated above).</span></span> <span data-ttu-id="3cc78-225">Utilisez plutôt les API IVdsCreatePartitionEx :: CreatePartitionEx ou IVdsAdvancedDisk :: CreatePartition qui utilisent le paramètre d’alignement spécifié pour les applications qui doivent créer des partitions.</span><span class="sxs-lookup"><span data-stu-id="3cc78-225">Instead, use the IVdsCreatePartitionEx::CreatePartitionEx or IVdsAdvancedDisk::CreatePartition APIs that use the specified alignment parameter for those apps that need to create partitions.</span></span>

<span data-ttu-id="3cc78-226">La meilleure façon de s’assurer que l’alignement est correct est de le faire juste lors de la création initiale de la partition.</span><span class="sxs-lookup"><span data-stu-id="3cc78-226">The best way to help ensure that alignment is correct is to do it right when initially creating the partition.</span></span> <span data-ttu-id="3cc78-227">Dans le cas contraire, votre application devra prendre en compte l’alignement lors de l’exécution d’écritures ou de l’initialisation, ce qui peut être un processus très complexe.</span><span class="sxs-lookup"><span data-stu-id="3cc78-227">Otherwise your app will need to take alignment into account when performing writes or at initialization   which can be a very complex process.</span></span>

<span data-ttu-id="3cc78-228">**Problème 2 : écritures non mises en mémoire tampon non alignées sur la taille de secteur physique**</span><span class="sxs-lookup"><span data-stu-id="3cc78-228">**Issue 2: unbuffered writes not aligned to physical sector size**</span></span>

<span data-ttu-id="3cc78-229">Le problème le plus simple est que les écritures non mises en mémoire tampon ne sont pas alignées sur la taille de secteur physique indiquée du support de stockage.</span><span class="sxs-lookup"><span data-stu-id="3cc78-229">The simplest issue is that unbuffered writes are not aligned to the reported physical sector size of the storage media.</span></span> <span data-ttu-id="3cc78-230">Les écritures mises en mémoire tampon, en revanche, sont alignées sur la taille de page de 4 Ko, ce qui est par conséquent la taille de secteur physique de la première génération de médias de grands secteurs.</span><span class="sxs-lookup"><span data-stu-id="3cc78-230">Buffered writes, on the other hand, are aligned to the page size   4 KB   which coincidently is the physical sector size of the first generation of large sector media.</span></span> <span data-ttu-id="3cc78-231">Toutefois, la plupart des applications avec un magasin de données effectuent des écritures non mises en mémoire tampon et doivent donc s’assurer que ces écritures sont effectuées dans des unités de la taille de secteur physique.</span><span class="sxs-lookup"><span data-stu-id="3cc78-231">However, most apps with a data store perform unbuffered writes, and thus will need to ensure these writes are performed in units of the physical sector size.</span></span>

<span data-ttu-id="3cc78-232">Voici quelques exemples de scénarios dans lesquels l’e/s d’application obtenue n’est pas alignée :</span><span class="sxs-lookup"><span data-stu-id="3cc78-232">Some examples of scenarios where the resulting app I/O is unaligned:</span></span>

<span data-ttu-id="3cc78-233">**Les enregistrements de validation sont remplis à des secteurs de 512 octets :** Les applications avec un magasin de données ont généralement une forme d’enregistrement de validation qui conserve des informations sur les modifications des métadonnées ou gère la structure de la Banque de données.</span><span class="sxs-lookup"><span data-stu-id="3cc78-233">**Commit records are padded to 512-byte sectors:** Apps with a data store typically have some form of commit record that either maintains info about metadata changes or maintains the structure of the data store.</span></span> <span data-ttu-id="3cc78-234">Pour éviter que la perte d’un secteur n’affecte plusieurs enregistrements, cet enregistrement de validation est généralement rempli à une taille de secteur.</span><span class="sxs-lookup"><span data-stu-id="3cc78-234">In order to ensure that the loss of a sector does not affect multiple records, this commit record is typically padded out to a sector size.</span></span> <span data-ttu-id="3cc78-235">Avec un disque avec une plus grande taille de secteur physique, l’application doit interroger la taille de secteur physique comme indiqué dans la section précédente et vérifier que chaque enregistrement de validation est rempli à cette taille.</span><span class="sxs-lookup"><span data-stu-id="3cc78-235">With a disk with a larger physical sector size, the app will need to query for the physical sector size as shown in the prior section, and ensure each commit record is padded to that size.</span></span> <span data-ttu-id="3cc78-236">Avec un disque de 4 Ko, cela garantit que les e/s n’échouent pas.</span><span class="sxs-lookup"><span data-stu-id="3cc78-236">With a 4K disk, this ensures I/Os do not fail.</span></span> <span data-ttu-id="3cc78-237">Avec un disque émulation, non seulement vous évitez le cycle de lecture-modification-écriture, mais cela permet de garantir que, en cas de perte d’un secteur physique, un seul enregistrement de validation serait perdu.</span><span class="sxs-lookup"><span data-stu-id="3cc78-237">With a 512e disk, not only does this avoid the Read-Modify-Write cycle, it helps ensure that if a physical sector was lost, only one Commit Record would be lost.</span></span>  
<span data-ttu-id="3cc78-238">**Les fichiers journaux sont écrits dans des blocs non alignés :** Les e/s non mises en mémoire tampon sont généralement utilisées lors de la mise à jour ou de l’ajout d’un fichier journal.</span><span class="sxs-lookup"><span data-stu-id="3cc78-238">**Log files are written to in unaligned chunks:** Unbuffered I/O is typically used when updating or appending to a log file.</span></span> <span data-ttu-id="3cc78-239">Les applications peuvent basculer vers des e/s mises en mémoire tampon ou mettre en mémoire tampon les mises à jour des journaux vers des unités de la taille de secteur physique pour éviter les e/s qui ont échoué ou déclencher une lecture-modification-écriture.</span><span class="sxs-lookup"><span data-stu-id="3cc78-239">Apps can either switch to buffered I/O, or internally buffer the log updates to units of the physical sector size to avoid failed I/Os or triggering a Read-Modify-Write.</span></span>  
 <span data-ttu-id="3cc78-240">Pour vous aider à déterminer si votre application émet des e/s non mises en mémoire tampon, veillez à inclure l' \_ \_ indicateur de fichier sans indicateur \_ de mise en mémoire tampon dans le paramètre *dwFlagsAndAttributes* lorsque vous appelez la fonction CreateFile.</span><span class="sxs-lookup"><span data-stu-id="3cc78-240">To help determine if your app issues unbuffered I/O, make sure to include the FILE\_FLAG\_NO\_BUFFERING flag in the *dwFlagsAndAttributes* parameter when you are call the CreateFile function.</span></span>

<span data-ttu-id="3cc78-241">En outre, si vous alignez actuellement les écritures sur la taille de secteur, cette taille de secteur est très probablement la taille de secteur logique, car la plupart des API existantes qui interrogent la taille de secteur des supports interrogent simplement l’unité d’adressage, c’est-à-dire la taille de secteur logique.</span><span class="sxs-lookup"><span data-stu-id="3cc78-241">Moreover, if you are currently aligning the writes to the sector size, this sector size is most likely just the logical sector size, as most existing APIs that query for the sector size of the media just query the unit of addressing   that is, the logical sector size.</span></span> <span data-ttu-id="3cc78-242">La taille de secteur d’intérêt ici est la taille de secteur physique, qui est l’unité réelle d’atomicité.</span><span class="sxs-lookup"><span data-stu-id="3cc78-242">The sector size of interest here is the physical sector size, which is the real unit of atomicity.</span></span> <span data-ttu-id="3cc78-243">Voici quelques exemples d’API qui récupèrent la taille de secteur logique :</span><span class="sxs-lookup"><span data-stu-id="3cc78-243">Some examples of APIs that retrieve the logical sector size are:</span></span>

-   <span data-ttu-id="3cc78-244">GetDiskFreeSpace, GetDiskFreeSpaceEx</span><span class="sxs-lookup"><span data-stu-id="3cc78-244">GetDiskFreeSpace, GetDiskFreeSpaceEx</span></span>
-   <span data-ttu-id="3cc78-245">FileFsVolumeInformation</span><span class="sxs-lookup"><span data-stu-id="3cc78-245">FileFsVolumeInformation</span></span>
-   <span data-ttu-id="3cc78-246">\_disque IOCTL \_ obtient la géométrie du \_ lecteur \_ , IOCTL \_ Disk \_ obtient la géométrie du \_ lecteur \_ \_ ex</span><span class="sxs-lookup"><span data-stu-id="3cc78-246">IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY, IOCTL\_DISK\_GET\_DRIVE\_GEOMETRY\_EX</span></span>
-   <span data-ttu-id="3cc78-247">IVdsDisk :: GetProperties, IVdsDisk3 :: GetProperties2</span><span class="sxs-lookup"><span data-stu-id="3cc78-247">IVdsDisk::GetProperties, IVdsDisk3::GetProperties2</span></span>

<span data-ttu-id="3cc78-248">Voici comment vous pouvez interroger la taille de secteur physique :</span><span class="sxs-lookup"><span data-stu-id="3cc78-248">Here s how you can query for the physical sector size:</span></span>

<span data-ttu-id="3cc78-249">**Méthode recommandée pour Windows 8**</span><span class="sxs-lookup"><span data-stu-id="3cc78-249">**Preferred method for Windows 8**</span></span>

<span data-ttu-id="3cc78-250">Avec Windows 8, Microsoft a introduit une nouvelle API qui permet aux développeurs d’intégrer facilement la prise en charge 4K dans leurs applications.</span><span class="sxs-lookup"><span data-stu-id="3cc78-250">With Windows 8, Microsoft has introduced a new API that enables developers to easily integrate 4K support within their apps.</span></span> <span data-ttu-id="3cc78-251">Cette nouvelle API prend en charge un nombre de scénarios encore plus élevé que la méthode héritée pour Windows Vista et Windows 7, comme indiqué ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="3cc78-251">This new API supports even greater numbers of scenarios than the legacy method for Windows Vista and Windows 7 discussed below.</span></span> <span data-ttu-id="3cc78-252">Cette API active ces scénarios d’appel :</span><span class="sxs-lookup"><span data-stu-id="3cc78-252">This API enables these calling scenarios:</span></span>

-   <span data-ttu-id="3cc78-253">Appel à partir d’une application non privilégiée</span><span class="sxs-lookup"><span data-stu-id="3cc78-253">Calling from an unprivileged app</span></span>
-   <span data-ttu-id="3cc78-254">Appel à un handle de fichier valide</span><span class="sxs-lookup"><span data-stu-id="3cc78-254">Calling to any valid file handle</span></span>
-   <span data-ttu-id="3cc78-255">Appel à un descripteur de fichier sur un volume distant sur SMB2</span><span class="sxs-lookup"><span data-stu-id="3cc78-255">Calling to a file handle on a remote volume over SMB2</span></span>
-   <span data-ttu-id="3cc78-256">Modèle de programmation simplifié</span><span class="sxs-lookup"><span data-stu-id="3cc78-256">Simplified programming model</span></span>

<span data-ttu-id="3cc78-257">L’API se présente sous la forme d’une nouvelle classe d’informations, FileFsSectorSizeInformation, avec les informations de taille de secteur FS de fichier de structure associées \_ \_ \_ \_ , définies comme suit :</span><span class="sxs-lookup"><span data-stu-id="3cc78-257">The API is in the form of a new info class, FileFsSectorSizeInformation, with associated structure FILE\_FS\_SECTOR\_SIZE\_INFORMATION, defined as follows:</span></span>


```
typedef struct _FILE_FS_SECTOR_SIZE_INFORMATION {  
    ULONG LogicalBytesPerSector;  
    ULONG PhysicalBytesPerSectorForAtomicity;  
    ULONG PhysicalBytesPerSectorForPerformance;  
    ULONG FileSystemEffectivePhysicalBytesPerSectorForAtomicity;  
    ULONG Flags;  
    ULONG ByteOffsetForSectorAlignment;  
    ULONG ByteOffsetForPartitionAlignment;  
} FILE_FS_SECTOR_SIZE_INFORMATION, *PFILE_FS_SECTOR_SIZE_INFORMATION;
```



<span data-ttu-id="3cc78-258">**Méthode héritée pour Windows 7 et Windows Vista**</span><span class="sxs-lookup"><span data-stu-id="3cc78-258">**Legacy method for Windows 7 and Windows Vista**</span></span>

<span data-ttu-id="3cc78-259">Windows Vista et Windows Server 2008 ont introduit des API pour interroger la taille de secteur physique de l’unité de stockage connectée pour les contrôleurs de stockage basés sur AHCI.</span><span class="sxs-lookup"><span data-stu-id="3cc78-259">Windows Vista and Windows Server 2008 introduced APIs to query for the physical sector size of the attached storage device for AHCI-based storage controllers.</span></span> <span data-ttu-id="3cc78-260">Avec Windows 7 et Windows Server 2008 R2, à compter de SP1 (ou de la base de connaissances Microsoft 982018), cette prise en charge est étendue aux contrôleurs de stockage basés sur Storport.</span><span class="sxs-lookup"><span data-stu-id="3cc78-260">With Windows 7 and Windows Server 2008 R2, as of SP1 (or Microsoft Knowledge Base 982018), this support is extended to Storport-based storage controllers.</span></span> <span data-ttu-id="3cc78-261">Microsoft a fourni un [exemple de code](/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor) sur MSDN détaillant comment une application peut interroger la taille de secteur physique du volume.</span><span class="sxs-lookup"><span data-stu-id="3cc78-261">Microsoft has provided a [code sample](/windows/desktop/api/winioctl/ns-winioctl-storage_access_alignment_descriptor) on MSDN detailing how an app can query for the physical sector size of the volume.</span></span>

<span data-ttu-id="3cc78-262">Bien que l’exemple de code ci-dessus vous permette d’obtenir la taille de secteur physique du volume, vous devez effectuer un contrôle d’intégrité de base de la taille de secteur physique indiquée avant de l’utiliser, car il a été observé que certains pilotes ne retournent pas de données correctement mises en forme :</span><span class="sxs-lookup"><span data-stu-id="3cc78-262">While the code sample above allows you to get the physical sector size of the volume, you should do some basic sanity checking of the reported physical sector size before using it, as it has been observed that some drivers may not return correctly formatted data:</span></span>

-   <span data-ttu-id="3cc78-263">Assurez-vous que la taille de secteur physique indiquée est >= la taille de secteur logique signalée ; Si ce n’est pas le cas, votre application doit utiliser une taille de secteur physique égale à la taille de secteur logique signalée</span><span class="sxs-lookup"><span data-stu-id="3cc78-263">Make sure that the reported physical sector size is >= the reported logical sector size; if it is not, your app should use a physical sector size equal to the reported logical sector size</span></span>
-   <span data-ttu-id="3cc78-264">Assurez-vous que la taille de secteur physique indiquée est une puissance de deux ; Si ce n’est pas le cas, votre application doit utiliser une taille de secteur physique égale à la taille de secteur logique signalée</span><span class="sxs-lookup"><span data-stu-id="3cc78-264">Make sure that the reported physical sector size is a power of two; if it is not, your app should use a physical sector size equal to the reported logical sector size</span></span>
-   <span data-ttu-id="3cc78-265">Si la taille de secteur physique est une valeur Power-of-Two comprise entre 512 octets et 4 Ko, vous devez envisager d’utiliser une taille de secteur physique arrondie à la taille de secteur logique signalée.</span><span class="sxs-lookup"><span data-stu-id="3cc78-265">If the physical sector size is a power-of-two value between 512-bytes and 4 KB, you should consider using a physical sector size rounded down to the reported logical sector size</span></span>
-   <span data-ttu-id="3cc78-266">Si la taille de secteur physique est une valeur Power-of-Two supérieure à 4 Ko, vous devez évaluer la capacité de votre application à gérer ce scénario avant d’utiliser cette valeur. dans le cas contraire, vous devez envisager d’utiliser une taille de secteur physique arrondie à 4 Ko.</span><span class="sxs-lookup"><span data-stu-id="3cc78-266">If the physical sector size is a power-of-two value greater than 4 KB, you should evaluate your app s ability to handle this scenario before using that value; otherwise, you should consider using a physical sector size rounded down to 4 KB</span></span>

<span data-ttu-id="3cc78-267">L’utilisation de cette IOCTL pour obtenir la taille de secteur physique présente plusieurs limitations.</span><span class="sxs-lookup"><span data-stu-id="3cc78-267">Using this IOCTL to get the physical sector size does have several limitations.</span></span> <span data-ttu-id="3cc78-268">Elle effectue les actions suivantes :</span><span class="sxs-lookup"><span data-stu-id="3cc78-268">It:</span></span>

-   <span data-ttu-id="3cc78-269">Requiert un privilège élevé ; Si votre application ne s’exécute pas avec le privilège, vous devrez peut-être écrire une application de service Windows comme indiqué ci-dessus</span><span class="sxs-lookup"><span data-stu-id="3cc78-269">Requires elevated privilege; if your app is not running with privilege, you may need to write a Windows Service Application as noted above</span></span>
-   <span data-ttu-id="3cc78-270">Ne prend pas en charge les volumes SMB ; vous devrez peut-être également écrire une application de service Windows pour prendre en charge l’interrogation de la taille des secteurs physiques sur ces volumes</span><span class="sxs-lookup"><span data-stu-id="3cc78-270">Does not support SMB volumes; you may also need to write a Windows Service Application to support physical sector size querying on these volumes</span></span>
-   <span data-ttu-id="3cc78-271">Ne peut pas être émis pour un handle de fichier (l’IOCTL doit être délivré à un handle de volume)</span><span class="sxs-lookup"><span data-stu-id="3cc78-271">Cannot be issued to any file handle (the IOCTL must be issued to a Volume Handle)</span></span>

<span data-ttu-id="3cc78-272">**Problème 3 : formats de fichiers basés sur des secteurs de 512 octets**</span><span class="sxs-lookup"><span data-stu-id="3cc78-272">**Issue 3: file formats relying on 512-byte sectors**</span></span>

<span data-ttu-id="3cc78-273">Certaines applications avec des formats de fichier standard (tels que VHD 1,0) peuvent avoir des fichiers codés en dur pour supposer une taille de secteur de 512 octets.</span><span class="sxs-lookup"><span data-stu-id="3cc78-273">Some apps with standard file formats (such as VHD 1.0) may have these files hard-coded to assume a 512-byte sector size.</span></span> <span data-ttu-id="3cc78-274">Ainsi, les mises à jour et les écritures dans ce fichier entraîneraient un cycle de lecture-modification-écriture sur l’appareil, ce qui entraînera potentiellement des problèmes de performances et de résilience pour vos clients.</span><span class="sxs-lookup"><span data-stu-id="3cc78-274">Thus, updates and writes to this file would result in a Read-Modify-Write cycle on the device  which will potentially result in performance and resiliency issues for your customers.</span></span> <span data-ttu-id="3cc78-275">Toutefois, il existe des moyens pour une application de prendre en charge l’utilisation de ce type de média, par exemple :</span><span class="sxs-lookup"><span data-stu-id="3cc78-275">However, there are ways for an app to provide support for operating on this type of media, for example:</span></span>

-   <span data-ttu-id="3cc78-276">Utilisez la mise en mémoire tampon pour vous assurer que les écritures sont effectuées dans les unités de la taille de secteur physique</span><span class="sxs-lookup"><span data-stu-id="3cc78-276">Use buffering to ensure that writes are performed in units of the physical sector size</span></span>
-   <span data-ttu-id="3cc78-277">Implémentez une lecture-modification-écriture interne qui peut aider à garantir que les mises à jour sont effectuées dans les unités de la taille de secteur physique indiquée.</span><span class="sxs-lookup"><span data-stu-id="3cc78-277">Implement an internal Read-Modify-Write that can help ensure that updates are performed in units of the reported physical sector size</span></span>
-   <span data-ttu-id="3cc78-278">Si possible, compléter les enregistrements dans un secteur physique, de telle sorte que le remplissage soit interprété comme un espace vide</span><span class="sxs-lookup"><span data-stu-id="3cc78-278">If possible, pad records out to a physical sector, in such a way that the padding would be interpreted as empty space</span></span>
-   <span data-ttu-id="3cc78-279">Envisagez de reconcevoir une version de la structure de données de l’application avec prise en charge des secteurs plus grands</span><span class="sxs-lookup"><span data-stu-id="3cc78-279">Consider redesigning a version of the app data structure with support for larger sectors</span></span>

<span data-ttu-id="3cc78-280">**Problème 4 : la taille de secteur physique signalée peut changer d’une session à l’autre**</span><span class="sxs-lookup"><span data-stu-id="3cc78-280">**Issue 4: the reported physical sector size can change between sessions**</span></span>

<span data-ttu-id="3cc78-281">Il existe de nombreux scénarios dans lesquels la taille de secteur physique signalée du stockage sous-jacent qui héberge le DataStor peut changer.</span><span class="sxs-lookup"><span data-stu-id="3cc78-281">There are many scenarios where the reported physical sector size of the underlying storage that hosts the Datastor may change.</span></span> <span data-ttu-id="3cc78-282">Le plus souvent, c’est lorsque vous migrez le DataStor vers un autre volume, ou même sur le réseau.</span><span class="sxs-lookup"><span data-stu-id="3cc78-282">The most common of these is when you migrate the Datastor to another volume, or even across the network.</span></span> <span data-ttu-id="3cc78-283">Une modification de la taille de secteur physique signalée peut être un événement inattendu pour de nombreuses applications et peut entraîner l’échec de la réinitialisation de certaines applications.</span><span class="sxs-lookup"><span data-stu-id="3cc78-283">A change in the reported physical sector size may be an unexpected event for many apps and potentially can result in some apps failing to re-initialize.</span></span>

<span data-ttu-id="3cc78-284">Il ne s’agit pas du scénario le plus simple pour prendre en charge et est mentionné ici comme un avis.</span><span class="sxs-lookup"><span data-stu-id="3cc78-284">This is not the easiest scenario to support, and is mentioned here as an advisory.</span></span> <span data-ttu-id="3cc78-285">Vous devez prendre en compte les besoins de mobilité de vos clients et ajuster votre support en conséquence pour vous assurer que les clients ne sont pas affectés négativement à l’aide d’un média émulation ou natif 4K.</span><span class="sxs-lookup"><span data-stu-id="3cc78-285">You should consider the mobility requirements of your customers and adjust your support accordingly to help ensure customers are not negatively impacted by using 4K native or 512e media.</span></span>

<span data-ttu-id="3cc78-286">**Comment un utilisateur peut récupérer la taille de secteur logique et physique pour un volume**</span><span class="sxs-lookup"><span data-stu-id="3cc78-286">**How a user can retrieve the logical and physical sector size for a volume**</span></span>

<span data-ttu-id="3cc78-287">L’utilitaire with Windows est un utilitaire permettant d’afficher les informations de taille de secteur pour un volume.</span><span class="sxs-lookup"><span data-stu-id="3cc78-287">In-box with Windows is a utility to display the sector size info for a volume.</span></span> <span data-ttu-id="3cc78-288">Les versions de Windows avec fsutil pris en charge sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="3cc78-288">Versions of Windows with supported  fsutil  are:</span></span>

-   <span data-ttu-id="3cc78-289">Windows 8</span><span class="sxs-lookup"><span data-stu-id="3cc78-289">Windows 8</span></span>
-   <span data-ttu-id="3cc78-290">Windows Server 2012</span><span class="sxs-lookup"><span data-stu-id="3cc78-290">Windows Server 2012</span></span>
-   <span data-ttu-id="3cc78-291">Windows 7 SP1 avec Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="3cc78-291">Windows 7 SP1 with Microsoft KB 982018</span></span>
-   <span data-ttu-id="3cc78-292">Windows 7 avec Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="3cc78-292">Windows 7 with Microsoft KB 982018</span></span>
-   <span data-ttu-id="3cc78-293">Windows Server 2008 R2 SP1 avec Microsoft KB 982018 (v3)</span><span class="sxs-lookup"><span data-stu-id="3cc78-293">Windows Server 2008 R2 SP1 with Microsoft KB 982018 (v3)</span></span>
-   <span data-ttu-id="3cc78-294">Windows Server 2008 R2 avec Microsoft KB 982018 (v3)</span><span class="sxs-lookup"><span data-stu-id="3cc78-294">Windows Server 2008 R2 with Microsoft KB 982018 (v3)</span></span>
-   <span data-ttu-id="3cc78-295">Windows Vista avec Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="3cc78-295">Windows Vista with Microsoft KB 2553708</span></span>
-   <span data-ttu-id="3cc78-296">Windows Server 2008 avec Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="3cc78-296">Windows Server 2008 with Microsoft KB 2553708</span></span>

<span data-ttu-id="3cc78-297">Pour afficher les informations sur la taille des secteurs, appelez l’utilitaire comme suit à partir d’une invite de commandes avec élévation de privilèges :</span><span class="sxs-lookup"><span data-stu-id="3cc78-297">To get the sector size info, call the utility as follows from an elevated command prompt:</span></span>


```
fsutil fsinfo ntfsinfo <drive letter>
```



<span data-ttu-id="3cc78-298">Un disque de secteur 4K avec émulation de 512 octets a le champ octets par secteur défini sur 512 et le champ octets par secteur physique défini sur 4096 comme suit :</span><span class="sxs-lookup"><span data-stu-id="3cc78-298">A 4K Sector Disk with 512-byte Emulation has the  Bytes Per Sector  field set to 512 and the  Bytes Per Physical Sector  field set to 4096 as follows:</span></span>

![octets par secteur et par secteur physique d’un disque de secteur 4k avec émulation de 512 octets](images/4ksectordiskwith512emulation.png)

<span data-ttu-id="3cc78-300">Un disque natif de 4 Ko contient le nombre d’octets par secteur et d’octets par champ de secteur physique définis sur 4096 comme suit :</span><span class="sxs-lookup"><span data-stu-id="3cc78-300">A 4K Native Disk has the  Bytes Per Sector  and  Bytes Per Physical Sector  fields both set to 4096 as follows:</span></span>

![octets par secteur et par secteur physique d’un disque natif de 4 Ko](images/4knativedisk.png)

> [!Note]  
> <span data-ttu-id="3cc78-302">Si le champ octet par secteur physique affiche non pris en charge, soit le pilote de stockage ne prend pas en charge la \_ \_ propriété de requête de stockage IOCTL, soit \_ une erreur s’est produite lors de la récupération des informations.</span><span class="sxs-lookup"><span data-stu-id="3cc78-302">If the  Byte Per Physical Sector  field displays  Not Supported  then either the storage driver does not support IOCTL\_STORAGE\_QUERY\_PROPERTY, or there was an error in retrieving the info.</span></span>

 

## <a name="resources"></a><span data-ttu-id="3cc78-303">Ressources</span><span class="sxs-lookup"><span data-stu-id="3cc78-303">Resources</span></span>

-   [<span data-ttu-id="3cc78-304">Déclaration de support général Windows</span><span class="sxs-lookup"><span data-stu-id="3cc78-304">Windows General Support Statement</span></span>](https://support.microsoft.com/kb/2510009)
-   [<span data-ttu-id="3cc78-305">Microsoft KB 982018</span><span class="sxs-lookup"><span data-stu-id="3cc78-305">Microsoft KB 982018</span></span>](https://support.microsoft.com/kb/982018)
-   [<span data-ttu-id="3cc78-306">Microsoft KB 2553708</span><span class="sxs-lookup"><span data-stu-id="3cc78-306">Microsoft KB 2553708</span></span>](https://support.microsoft.com/kb/2553708)
-   [<span data-ttu-id="3cc78-307">Correctif logiciel pour Windows 7 et Windows Server 2008 R2</span><span class="sxs-lookup"><span data-stu-id="3cc78-307">Hotfix for Windows 7 and Windows Server 2008 R2</span></span>](https://support.microsoft.com/kb/982018)
-   [<span data-ttu-id="3cc78-308">Correctif logiciel pour Windows Vista et Windows Server 2008</span><span class="sxs-lookup"><span data-stu-id="3cc78-308">Hotfix for Windows Vista and Windows Server 2008</span></span>](https://support.microsoft.com/kb/2553708)
-   [<span data-ttu-id="3cc78-309">HyperV (instruction de prise en charge)</span><span class="sxs-lookup"><span data-stu-id="3cc78-309">HyperV Support Statement</span></span>](https://support.microsoft.com/kb/2515143)
-   [<span data-ttu-id="3cc78-310">Informations générales sur le code de contrôle de la propriété de requête de \_ stockage IOCTL \_ \_</span><span class="sxs-lookup"><span data-stu-id="3cc78-310">General information about the IOCTL\_STORAGE\_QUERY\_PROPERTY control code</span></span>](/windows-hardware/drivers/ddi/ntddstor/ni-ntddstor-ioctl_storage_query_property)
-   [<span data-ttu-id="3cc78-311">\_Code de \_ contrôle de propriété de requête de stockage IOCTL \_</span><span class="sxs-lookup"><span data-stu-id="3cc78-311">IOCTL\_STORAGE\_QUERY\_PROPERTY Control Code</span></span>](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_query_property)
-   [<span data-ttu-id="3cc78-312">Informations générales sur la \_ structure du \_ descripteur d’alignement de l’accès au stockage \_</span><span class="sxs-lookup"><span data-stu-id="3cc78-312">General information about the STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR structure</span></span>](/windows-hardware/drivers/ddi/ntddstor/ns-ntddstor-_storage_access_alignment_descriptor)
-   [<span data-ttu-id="3cc78-313">Description de la terminologie standard utilisée pour décrire les mises à jour logicielles Microsoft</span><span class="sxs-lookup"><span data-stu-id="3cc78-313">Description of the standard terminology used to describe Microsoft software updates</span></span>](https://support.microsoft.com/kb/824684/)
-   [<span data-ttu-id="3cc78-314">Exemple de code WDK avec des détails sur la façon d’extraire les informations d’alignement d’accès de stockage signalées à partir de la \_ structure du descripteur d’alignement de l’accès au stockage \_ lors d' \_ un appel au \_ Code de contrôle de propriété de requête de stockage IOCTL \_ \_</span><span class="sxs-lookup"><span data-stu-id="3cc78-314">WDK sample code with details for how to extract the reported storage access alignment info from the STORAGE\_ACCESS\_ALIGNMENT\_DESCRIPTOR structure when making a call to the IOCTL\_STORAGE\_QUERY\_PROPERTY control code</span></span>](/windows/win32/api/winioctl/ns-winioctl-storage_access_alignment_descriptor)
-   <span data-ttu-id="3cc78-315">[Informations générales sur les options d’ImageX Command-Line](/previous-versions/windows/it-pro/windows-7/dd799302(v=ws.10))</span><span class="sxs-lookup"><span data-stu-id="3cc78-315">[General information about ImageX Command-Line Options](/previous-versions/windows/it-pro/windows-7/dd799302(v=ws.10))</span></span>
-   [<span data-ttu-id="3cc78-316">Pilotes de chipset Intel requis pour prendre en charge les lecteurs de secteur de 4 Ko</span><span class="sxs-lookup"><span data-stu-id="3cc78-316">Intel Chipset driver requirements to support 4 KB Sector Drives</span></span>](https://www.intel.com/support/chipsets/imsm/sb/CS-031502.htm)

 

