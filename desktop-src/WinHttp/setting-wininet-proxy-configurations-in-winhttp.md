---
description: Les applications qui portent à partir de WinINet vers WinHTTP peuvent avoir besoin d’utiliser les mêmes paramètres de proxy autorécupérables sous WinINet ou Internet Explorer (IE).
ms.assetid: c3e867d8-9d67-4e6a-8551-1fa846e089ed
title: Définition des configurations du proxy WinINet dans WinHTTP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91306f6591e0aab0f96fa010ee2a83d3f32c8fb4
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "103953046"
---
# <a name="setting-wininet-proxy-configurations-in-winhttp"></a><span data-ttu-id="7867e-103">Définition des configurations du proxy WinINet dans WinHTTP</span><span class="sxs-lookup"><span data-stu-id="7867e-103">Setting WinINet Proxy Configurations in WinHTTP</span></span>

## <a name="setting-automatic-proxy-on-winhttp-51"></a><span data-ttu-id="7867e-104">Définition du proxy automatique sur WinHTTP 5,1</span><span class="sxs-lookup"><span data-stu-id="7867e-104">Setting Automatic Proxy on WinHTTP 5.1</span></span>

<span data-ttu-id="7867e-105">Les applications qui portent à partir de WinINet vers WinHTTP peuvent avoir besoin d’utiliser les mêmes paramètres de proxy autorécupérables sous WinINet ou Internet Explorer (IE).</span><span class="sxs-lookup"><span data-stu-id="7867e-105">Applications that port from WinINet to WinHTTP may need to use the same autoproxy settings that they can retrieve under WinINet or Internet Explorer (IE).</span></span> <span data-ttu-id="7867e-106">L’API WinHTTP version 5,1 peut récupérer et utiliser ces paramètres de proxy.</span><span class="sxs-lookup"><span data-stu-id="7867e-106">The WinHTTP version 5.1 API can retrieve and use these proxy settings.</span></span> <span data-ttu-id="7867e-107">En général, WinHTTP spécifie les serveurs proxy et proxy de contournement par session lors de la création de la session.</span><span class="sxs-lookup"><span data-stu-id="7867e-107">In general, WinHTTP specifies the proxy and proxy bypass servers on a per-session basis when the session is created.</span></span> <span data-ttu-id="7867e-108">Ces paramètres peuvent être remplacés par demande.</span><span class="sxs-lookup"><span data-stu-id="7867e-108">These settings can be overridden on a per-request basis.</span></span>

<span data-ttu-id="7867e-109">Pour utiliser la même configuration de proxy que WinINet ou IE, le client WinHTTP doit définir des paramètres de proxy pour la session.</span><span class="sxs-lookup"><span data-stu-id="7867e-109">To use the same proxy configuration as WinINet or IE, the WinHTTP client should set proxy settings for the session.</span></span> <span data-ttu-id="7867e-110">En outre, si IE ou WinINet sont configurés pour utiliser le protocole WPAD (Web Proxy Auto-Discovery), le client WinHTTP qui utilise ces paramètres doit définir des paramètres de proxy pour chaque demande.</span><span class="sxs-lookup"><span data-stu-id="7867e-110">In addition, if IE or WinINet are configured to use Web Proxy Auto-Discovery (WPAD), the WinHTTP client that uses those settings must set proxy settings on a per-request basis.</span></span> <span data-ttu-id="7867e-111">Les sections suivantes décrivent comment spécifier les paramètres de proxy pour une session et une demande :</span><span class="sxs-lookup"><span data-stu-id="7867e-111">The following sections describe how to specify the proxy settings for a session and a request:</span></span>

-   [<span data-ttu-id="7867e-112">Définition de la configuration du proxy sur une session</span><span class="sxs-lookup"><span data-stu-id="7867e-112">Setting the Proxy Configuration on a Session</span></span>](#setting-the-proxy-configuration-on-a-session)
-   [<span data-ttu-id="7867e-113">Définition de la configuration du proxy sur une demande unique</span><span class="sxs-lookup"><span data-stu-id="7867e-113">Setting the Proxy Configuration on a Single Request</span></span>](#setting-the-proxy-configuration-on-a-single-request)

## <a name="setting-the-proxy-configuration-on-a-session"></a><span data-ttu-id="7867e-114">Définition de la configuration du proxy sur une session</span><span class="sxs-lookup"><span data-stu-id="7867e-114">Setting the Proxy Configuration on a Session</span></span>

## <a name="the-application-is-running-on-a-user-account"></a><span data-ttu-id="7867e-115">L’application est en cours d’exécution sur un compte d’utilisateur</span><span class="sxs-lookup"><span data-stu-id="7867e-115">The Application is Running on a User Account</span></span>

<span data-ttu-id="7867e-116">Avant la création d’une session, l’application appelle [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) pour obtenir les paramètres du proxy IE.</span><span class="sxs-lookup"><span data-stu-id="7867e-116">Before a session is created, the application calls [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) to get the IE proxy settings.</span></span> <span data-ttu-id="7867e-117">L’application doit s’exécuter en tant que compte d’utilisateur pour obtenir ces paramètres.</span><span class="sxs-lookup"><span data-stu-id="7867e-117">The application must be running as a user account to obtain these settings.</span></span> <span data-ttu-id="7867e-118">Le paramètre *pProxyConfig* est un pointeur vers une structure de [**\_ \_ \_ \_ \_ configuration de proxy Internet Explorer de l’utilisateur courant WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) qui contient le nom du proxy (*LpszProxy*) et les serveurs de contournement du proxy (*lpszProxyBypass*).</span><span class="sxs-lookup"><span data-stu-id="7867e-118">The *pProxyConfig* parameter is a pointer to a [**WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) structure that contains the proxy name (*lpszProxy*) and proxy bypass (*lpszProxyBypass*) servers.</span></span> <span data-ttu-id="7867e-119">Le nom du proxy et les valeurs de contournement du proxy de la structure de **\_ \_ \_ \_ \_ configuration du proxy IE de l’utilisateur actuel** sont ensuite utilisés pour initialiser la session WinHTTP.</span><span class="sxs-lookup"><span data-stu-id="7867e-119">The proxy name and proxy bypass values of the **WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG** structure are then used to initialize the WinHTTP session.</span></span> <span data-ttu-id="7867e-120">La session est initialisée en appelant [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) avec les paramètres *pwszProxyName* et *pwszProxyBypass* obtenus à partir des membres **lpszProxy** et **lpszProxyBypass** de la structure de **\_ \_ \_ \_ \_ configuration du proxy IE de l’utilisateur actuel WinHTTP** .</span><span class="sxs-lookup"><span data-stu-id="7867e-120">The session is initialized by calling [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) with the *pwszProxyName* and *pwszProxyBypass* parameters obtained from the **lpszProxy** and **lpszProxyBypass** members of the **WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG** structure.</span></span>

## <a name="the-application-is-running-as-a-service"></a><span data-ttu-id="7867e-121">L’application s’exécute en tant que service</span><span class="sxs-lookup"><span data-stu-id="7867e-121">The Application is Running as a Service</span></span>

<span data-ttu-id="7867e-122">L’application doit s’assurer que les paramètres du Registre pour un utilisateur individuel sont chargés dans le registre avant d’appeler [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="7867e-122">The application must ensure that the registry settings for an individual user are loaded into the registry before calling [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span> <span data-ttu-id="7867e-123">Si ces paramètres ne sont pas chargés dans le registre, **WinHttpGetIEProxyConfigForCurrentUser** ne peut pas obtenir les paramètres du proxy.</span><span class="sxs-lookup"><span data-stu-id="7867e-123">If these settings are not loaded into the registry, **WinHttpGetIEProxyConfigForCurrentUser** cannot obtain the proxy settings.</span></span> <span data-ttu-id="7867e-124">Les paramètres du Registre pour un utilisateur individuel peuvent être chargés dans le registre en appelant la fonction **LoadUserProfile** .</span><span class="sxs-lookup"><span data-stu-id="7867e-124">Registry settings for an individual user can be loaded into the registry by calling the **LoadUserProfile** function.</span></span> <span data-ttu-id="7867e-125">Si le chargement des paramètres du registre de l’utilisateur n’est pas une option, l’application peut appeler [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) avec le **\_ \_ \_ \_ proxy par défaut du type d’accès WinHTTP** spécifié dans le paramètre *dwAcessType* .</span><span class="sxs-lookup"><span data-stu-id="7867e-125">If loading the user's registry settings is not an option, the application can call [**WinHttpOpen**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopen) with the **WINHTTP\_ACCESS\_TYPE\_DEFAULT\_PROXY** specified in the *dwAcessType* parameter.</span></span> <span data-ttu-id="7867e-126">La spécification du proxy par défaut dans l’appel à **WinHttpOpen** indique à l’API WinHTTP de récupérer le jeu de configuration du proxy à l’aide de l’utilitaire de [**proxycfg.exe**](proxycfg-exe--a-proxy-configuration-tool.md) WinHTTP.</span><span class="sxs-lookup"><span data-stu-id="7867e-126">Specifying the default proxy in the call to **WinHttpOpen** tells the WinHTTP API to retrieve the proxy configuration set by using the WinHTTP [**proxycfg.exe**](proxycfg-exe--a-proxy-configuration-tool.md) utility.</span></span> <span data-ttu-id="7867e-127">Une fois que les paramètres du Registre pour un utilisateur individuel ont été chargés, l’application suit les étapes décrites dans [l’application s’exécute sur un compte d’utilisateur](#the-application-is-running-on-a-user-account) pour définir le nom du proxy et les serveurs de contournement du proxy.</span><span class="sxs-lookup"><span data-stu-id="7867e-127">After the registry settings for an individual user have been loaded, the application follows the steps outlined under [The application is running on a user account](#the-application-is-running-on-a-user-account) to set the proxy name and proxy bypass servers.</span></span>

## <a name="setting-the-proxy-configuration-on-a-single-request"></a><span data-ttu-id="7867e-128">Définition de la configuration du proxy sur une demande unique</span><span class="sxs-lookup"><span data-stu-id="7867e-128">Setting the Proxy Configuration on a Single Request</span></span>

<span data-ttu-id="7867e-129">Avant la création de la session, l’application appelle [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) pour déterminer si WinInet et IE sont configurés pour utiliser WPAD.</span><span class="sxs-lookup"><span data-stu-id="7867e-129">Before the session is created, the application calls [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) to determine if WinINet and IE are configured to use WPAD.</span></span> <span data-ttu-id="7867e-130">**WinHttpGetIEProxyConfigForCurrentUser** retourne la structure de [**\_ \_ \_ \_ \_ configuration du proxy IE de l’utilisateur actuel WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) qui contient le membre **fAutoDetect** .</span><span class="sxs-lookup"><span data-stu-id="7867e-130">**WinHttpGetIEProxyConfigForCurrentUser** returns the [**WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) structure that contains the **fAutoDetect** member.</span></span> <span data-ttu-id="7867e-131">La valeur **true** pour ce membre indique que le protocole WPAD est utilisé et que le membre **LPSZAUTOCONFIGURL** contient l’URL WPAD.</span><span class="sxs-lookup"><span data-stu-id="7867e-131">A value of **TRUE** for this member indicates that WPAD is used, and the **lpszAutoConfigUrl** member contains the WPAD URL.</span></span>

## <a name="automatic-proxy-configuration-is-used"></a><span data-ttu-id="7867e-132">La configuration automatique du proxy est utilisée</span><span class="sxs-lookup"><span data-stu-id="7867e-132">Automatic Proxy Configuration Is Used</span></span>

<span data-ttu-id="7867e-133">Si WPAD est utilisé, l’application appelle [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) pour récupérer le proxy de la demande.</span><span class="sxs-lookup"><span data-stu-id="7867e-133">If WPAD is used, the application calls [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl) to retrieve the proxy for the request.</span></span> <span data-ttu-id="7867e-134">Le paramètre *lpwszUrl* contient l’URL à laquelle la demande est envoyée, et le paramètre *pAutoProxyOptions* contient un pointeur vers la structure ([**\_ \_ options AutoProxy WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_autoproxy_options)) qui contient les options du proxy AutoProxy.</span><span class="sxs-lookup"><span data-stu-id="7867e-134">The *lpwszUrl* parameter contains the URL that the request is being sent to, and the *pAutoProxyOptions* parameter contains a pointer to the structure ([**WINHTTP\_AUTOPROXY\_OPTIONS**](/windows/win32/api/winhttp/ns-winhttp-winhttp_autoproxy_options)) that contains the autoproxy options.</span></span> <span data-ttu-id="7867e-135">L’application initialise la structure **des \_ \_ options de proxy automatique WinHTTP** avec les paramètres retournés à partir de la structure de [**\_ \_ \_ \_ \_ configuration du proxy IE de l’utilisateur actuel WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) dans l’appel à [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="7867e-135">The application initializes the **WINHTTP\_AUTOPROXY\_OPTIONS** structure with the settings returned from the [**WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG**](/windows/win32/api/winhttp/ns-winhttp-winhttp_current_user_ie_proxy_config) structure in the call to [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span> <span data-ttu-id="7867e-136">L’indicateur d’URL de configuration du PROXY automatique WinHTTP est spécifié dans le membre **dwFlags** de la structure des **options de \_ proxy \_ automatique WinHTTP** et le membre **lpszAutoconfigUrl** contient l’URL de configuration automatique du proxy de la structure de configuration **\_ \_ \_** de **\_ \_ \_ \_ \_ proxy d’utilisateur active WinHTTP** .</span><span class="sxs-lookup"><span data-stu-id="7867e-136">The **WINHTTP\_AUTOPROXY\_CONFIG\_URL** flag is specified in the **dwFlags** member of the **WINHTTP\_AUTOPROXY\_OPTIONS** structure, and the **lpszAutoconfigUrl** member contains the proxy auto-configuration URL from the **WINHTTP\_CURRENT\_USER\_IE\_PROXY\_CONFIG** structure.</span></span> <span data-ttu-id="7867e-137">La fonction **WinHttpGetProxyForUrl** retourne le nom du proxy et la liste de contournement du proxy dans les membres **lpszProxy** et **lpszProxyBypass** de la structure d' [**\_ \_ informations du proxy WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) .</span><span class="sxs-lookup"><span data-stu-id="7867e-137">The **WinHttpGetProxyForUrl** function returns the proxy name and the proxy bypass list in the **lpszProxy** and **lpszProxyBypass** members of the [**WINHTTP\_PROXY\_INFO**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) structure.</span></span>

<span data-ttu-id="7867e-138">Une fois que le proxy pour la requête est obtenu à partir de [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl), l’application crée la demande avec [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest).</span><span class="sxs-lookup"><span data-stu-id="7867e-138">After the proxy for the request is obtained from [**WinHttpGetProxyForUrl**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetproxyforurl), the application creates the request with [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest).</span></span> <span data-ttu-id="7867e-139">[**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) est alors appelé pour définir le proxy pour la demande en spécifiant le handle de requête dans le paramètre *hInternet* .</span><span class="sxs-lookup"><span data-stu-id="7867e-139">Then [**WinHttpSetOption**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpsetoption) is called to set the proxy for the request by specifying the request handle in the *hInternet* parameter.</span></span> <span data-ttu-id="7867e-140">Le paramètre *valeur dwOption* dans l’appel à **WinHttpSetOption** doit avoir la valeur **WinHTTP \_ option \_ proxy** et le paramètre *lpBuffer* est un pointeur vers une structure d' [**\_ \_ informations proxy WinHTTP**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) qui contient le proxy et le contournement du proxy à utiliser pour la requête.</span><span class="sxs-lookup"><span data-stu-id="7867e-140">The *dwOption* parameter in the call to **WinHttpSetOption** should be set to **WINHTTP\_OPTION\_PROXY** and the *lpBuffer* parameter is a pointer to a [**WINHTTP\_PROXY\_INFO**](/windows/win32/api/winhttp/ns-winhttp-winhttp_proxy_info) structure that contains the proxy and proxy bypass to be used for the request.</span></span>

## <a name="automatic-proxy-configuration-is-not-used"></a><span data-ttu-id="7867e-141">La configuration automatique du proxy n’est pas utilisée</span><span class="sxs-lookup"><span data-stu-id="7867e-141">Automatic Proxy Configuration Is Not Used</span></span>

<span data-ttu-id="7867e-142">Si l’appel à [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) indique que le proxy AutoProxy n’est pas utilisé, l’application peut simplement créer la demande avec [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest).</span><span class="sxs-lookup"><span data-stu-id="7867e-142">If the call to [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser) indicates that autoproxy is not used, the application can simply create the request with [**WinHttpOpenRequest**](/windows/desktop/api/Winhttp/nf-winhttp-winhttpopenrequest).</span></span> <span data-ttu-id="7867e-143">La configuration du proxy est la même pour l’ensemble de la session et les modifications par demande ne sont pas nécessaires.</span><span class="sxs-lookup"><span data-stu-id="7867e-143">The proxy configuration is the same for the entire session, and per-request changes are not needed.</span></span>

 

 



