---
title: Durée de vie et synchronisation des ressources
description: Afin d’éviter un comportement indéfini, votre application DirectML doit gérer correctement les durées de vie des objets et la synchronisation entre l’UC et le GPU.
ms.custom: Windows 10 May 2019 Update
ms.localizationpriority: high
ms.topic: article
ms.date: 04/19/2019
ms.openlocfilehash: 6e8ab30c5c87c135ef3bdac0c1bc2a3d64040787
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/16/2019
ms.locfileid: "74104802"
---
# <a name="resource-lifetime-and-synchronization"></a><span data-ttu-id="31286-103">Durée de vie et synchronisation des ressources</span><span class="sxs-lookup"><span data-stu-id="31286-103">Resource lifetime and synchronization</span></span>

<span data-ttu-id="31286-104">Tout comme avec Direct3D 12, votre application DirectML doit (afin d’éviter un comportement indéfini) gérer correctement les durées de vie des objets et la synchronisation entre l’UC et le GPU.</span><span class="sxs-lookup"><span data-stu-id="31286-104">Just as with Direct3D 12, your DirectML application must (in order to avoid undefined behavior) correctly manage object lifetimes and synchronization between the CPU and the GPU.</span></span> <span data-ttu-id="31286-105">DirectML suit un modèle de durée de vie des ressources identique à celui de Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="31286-105">DirectML follows an identical resource lifetime model to that of Direct3D 12.</span></span>

- <span data-ttu-id="31286-106">Les dépendances de durée de vie entre deux objets UC sont gérées par DirectML à l’aide de décomptes de références forts.</span><span class="sxs-lookup"><span data-stu-id="31286-106">Lifetime dependencies between two CPU objects are maintained by DirectML using strong reference counts.</span></span> <span data-ttu-id="31286-107">Votre application n’a pas besoin de gérer manuellement les dépendances de durée de vie du processeur.</span><span class="sxs-lookup"><span data-stu-id="31286-107">Your application needn't manually manage CPU lifetime dependencies.</span></span> <span data-ttu-id="31286-108">Par exemple, chaque enfant d’appareil détient une référence forte à son appareil parent.</span><span class="sxs-lookup"><span data-stu-id="31286-108">For example, every device child holds a strong reference to its parent device.</span></span>
- <span data-ttu-id="31286-109">Les dépendances de durée de vie entre les objets GPU &mdash; ou les dépendances qui couvrent le processeur et le GPU &mdash; ne sont pas gérées automatiquement.</span><span class="sxs-lookup"><span data-stu-id="31286-109">Lifetime dependencies between GPU objects&mdash;or dependencies that span across CPU and GPU&mdash;aren't automatically managed.</span></span> <span data-ttu-id="31286-110">C’est la responsabilité de votre application de s’assurer que les ressources GPU se trouvent au moins jusqu’à ce que tout le travail à l’aide de cette ressource ait terminé l’exécution sur le GPU.</span><span class="sxs-lookup"><span data-stu-id="31286-110">It's your application's responsibility to ensure that GPU resources live at least until all work using that resource has completed execution on the GPU.</span></span>

## <a name="directml-devices"></a><span data-ttu-id="31286-111">Appareils DirectML</span><span class="sxs-lookup"><span data-stu-id="31286-111">DirectML devices</span></span>

<span data-ttu-id="31286-112">L’appareil DirectML est un objet de fabrique sans état thread-safe.</span><span class="sxs-lookup"><span data-stu-id="31286-112">The DirectML device is a thread-safe stateless factory object.</span></span> <span data-ttu-id="31286-113">Chaque enfant d’appareil (voir [**IDMLDeviceChild**](/windows/desktop/api/directml/nn-directml-idmldevicechild)) contient une référence forte à son appareil DirectML parent (voir [**IDMLDevice**](/windows/desktop/api/directml/nn-directml-idmldevice)).</span><span class="sxs-lookup"><span data-stu-id="31286-113">Every device child (see [**IDMLDeviceChild**](/windows/desktop/api/directml/nn-directml-idmldevicechild)) holds a strong reference to its parent DirectML device (see [**IDMLDevice**](/windows/desktop/api/directml/nn-directml-idmldevice)).</span></span> <span data-ttu-id="31286-114">Cela signifie que vous pouvez toujours récupérer l’interface d’appareil parent à partir de n’importe quelle interface enfant d’appareil.</span><span class="sxs-lookup"><span data-stu-id="31286-114">That means that you can always retrieve the parent device interface from any device child interface.</span></span>

<span data-ttu-id="31286-115">Un appareil DirectML contient à son tour une référence forte au périphérique Direct3D 12 qui a été utilisé pour le créer (consultez [**ID3D12Device**](/windows/desktop/api/d3d12/nn-d3d12-id3d12device), et interfaces dérivées).</span><span class="sxs-lookup"><span data-stu-id="31286-115">A DirectML device in turn holds a strong reference to the Direct3D 12 device that was used to create it (see [**ID3D12Device**](/windows/desktop/api/d3d12/nn-d3d12-id3d12device), and derived interfaces).</span></span>

<span data-ttu-id="31286-116">Étant donné que l’appareil DirectML est sans État, il est implicitement thread-safe.</span><span class="sxs-lookup"><span data-stu-id="31286-116">Because the DirectML device is stateless, it's implicitly thread-safe.</span></span> <span data-ttu-id="31286-117">Vous pouvez appeler des méthodes sur l’appareil DirectML à partir de plusieurs threads simultanément, sans nécessiter de synchronisation externe.</span><span class="sxs-lookup"><span data-stu-id="31286-117">You may call methods on the DirectML device from multiple threads simultaneously without the need for external synchronization.</span></span>

<span data-ttu-id="31286-118">Toutefois, contrairement à l’appareil Direct3D 12, l’appareil DirectML n’est pas un objet singleton.</span><span class="sxs-lookup"><span data-stu-id="31286-118">However, unlike the Direct3D 12 device, the DirectML device is not a singleton object.</span></span> <span data-ttu-id="31286-119">Vous êtes libre de créer autant d’appareils DirectML que vous le souhaitez.</span><span class="sxs-lookup"><span data-stu-id="31286-119">You're free to create as many DirectML devices as you wish.</span></span> <span data-ttu-id="31286-120">Toutefois, vous ne pouvez pas mélanger et faire correspondre des enfants d’appareils qui appartiennent à des appareils différents.</span><span class="sxs-lookup"><span data-stu-id="31286-120">However, you may not mix and match device children that belong to different devices.</span></span> <span data-ttu-id="31286-121">Par exemple, [**IDMLBindingTable**](/windows/desktop/api/directml/nn-directml-idmlbindingtable) et [**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) sont deux genres d’enfants d’appareil (les deux interfaces dérivent directement ou indirectement de **IDMLDeviceChild**).</span><span class="sxs-lookup"><span data-stu-id="31286-121">For example, [**IDMLBindingTable**](/windows/desktop/api/directml/nn-directml-idmlbindingtable) and [**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) are two kinds of device children (both interfaces derive directly or indirectly from **IDMLDeviceChild**).</span></span> <span data-ttu-id="31286-122">Et vous ne pouvez pas utiliser une table de liaison (**IDMLBindingTable**) pour effectuer une liaison pour un opérateur (**IDMLCompiledOperator**) si l’opérateur et la table de liaison appartiennent à différentes instances d’appareil DirectML.</span><span class="sxs-lookup"><span data-stu-id="31286-122">And you may not use a binding table (**IDMLBindingTable**) to bind for an operator (**IDMLCompiledOperator**) if the operator and the binding table belong to different DirectML device instances.</span></span>

<span data-ttu-id="31286-123">Étant donné que l’appareil DirectML n’est pas un singleton, la suppression de l’appareil s’effectue en fonction de l’appareil, plutôt que d’être un événement à l’échelle du processus, comme pour un appareil Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="31286-123">Because the DirectML device is not a singleton, device removal occurs on a per-device basis, rather than being a process-wide event as it is for a Direct3D 12 device.</span></span> <span data-ttu-id="31286-124">Pour plus d’informations, consultez [gestion des erreurs et suppression d’appareils dans DirectML](dml-errors.md).</span><span class="sxs-lookup"><span data-stu-id="31286-124">For more information, see [Handling errors and device removal in DirectML](dml-errors.md).</span></span>

## <a name="lifetime-requirements-of-gpu-resources"></a><span data-ttu-id="31286-125">Exigences de durée de vie des ressources GPU</span><span class="sxs-lookup"><span data-stu-id="31286-125">Lifetime requirements of GPU resources</span></span>

<span data-ttu-id="31286-126">Comme Direct3D 12, DirectML ne se synchronise pas automatiquement entre l’UC et le GPU. elle ne conserve pas non plus automatiquement les ressources actives pendant qu’elles sont utilisées par le GPU.</span><span class="sxs-lookup"><span data-stu-id="31286-126">Like Direct3D 12, DirectML doesn't automatically synchronize between the CPU and GPU; nor does it automatically keep resources alive while they're in use by the GPU.</span></span> <span data-ttu-id="31286-127">Au lieu de cela, il s’agit des responsabilités de votre application.</span><span class="sxs-lookup"><span data-stu-id="31286-127">Instead, these are responsibilities of your application.</span></span>

<span data-ttu-id="31286-128">Lors de l’exécution d’une liste de commandes contenant des distributions DirectML, votre application doit s’assurer que les ressources GPU restent actives jusqu’à ce que toutes les tâches utilisant ces ressources aient terminé leur exécution sur le GPU.</span><span class="sxs-lookup"><span data-stu-id="31286-128">When executing a command list that contains DirectML dispatches, your application must ensure that GPU resources are kept alive until all work using those resources has completed execution on the GPU.</span></span>

<span data-ttu-id="31286-129">Dans le cas de [**IDMLCommandRecorder :: RecordDispatch**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) pour un opérateur DirectML, qui comprend les objets suivants.</span><span class="sxs-lookup"><span data-stu-id="31286-129">In the case of [**IDMLCommandRecorder::RecordDispatch**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) for a DirectML operator, that includes the following objects.</span></span>

- <span data-ttu-id="31286-130">[**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) en cours d’exécution (ou [**IDMLOperatorInitializer**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer) à la place, en cas d’initialisation d’opérateur).</span><span class="sxs-lookup"><span data-stu-id="31286-130">The [**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator) being executed (or [**IDMLOperatorInitializer**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer) instead, if performing operator initialization).</span></span>
- <span data-ttu-id="31286-131">**IDMLCompiledOperator** sauvegardant la table de liaison utilisée pour lier l’opérateur.</span><span class="sxs-lookup"><span data-stu-id="31286-131">The **IDMLCompiledOperator** backing the binding table being used to bind the operator.</span></span>
- <span data-ttu-id="31286-132">Objets [**ID3D12Resource**](/windows/desktop/api/d3d12/nn-d3d12-id3d12resource) liés en tant qu’entrées/sorties de l’opérateur.</span><span class="sxs-lookup"><span data-stu-id="31286-132">The [**ID3D12Resource**](/windows/desktop/api/d3d12/nn-d3d12-id3d12resource) objects bound as the inputs/outputs of the operator.</span></span>
- <span data-ttu-id="31286-133">Objets **ID3D12Resource** liés en tant que ressources persistantes et temporaires, le cas échéant.</span><span class="sxs-lookup"><span data-stu-id="31286-133">The **ID3D12Resource** objects bound as persistent and temporary resources, if applicable.</span></span>
- <span data-ttu-id="31286-134">[**ID3D12CommandAllocator**](/windows/desktop/api/d3d12/nn-d3d12-id3d12commandallocator) sauvegardant la liste de commandes elle-même.</span><span class="sxs-lookup"><span data-stu-id="31286-134">The [**ID3D12CommandAllocator**](/windows/desktop/api/d3d12/nn-d3d12-id3d12commandallocator) backing the command list itself.</span></span>

<span data-ttu-id="31286-135">Toutes les interfaces DirectML ne représentent pas les ressources GPU.</span><span class="sxs-lookup"><span data-stu-id="31286-135">Not all DirectML interfaces represent GPU resources.</span></span> <span data-ttu-id="31286-136">Par exemple, une table de liaison n’a pas besoin d’être gardée active tant que toutes les distributions qui l’utilisent n’ont *pas* été exécutées sur le GPU.</span><span class="sxs-lookup"><span data-stu-id="31286-136">For example, a binding table does *not* need to be kept alive until all dispatches using it have completed execution on the GPU.</span></span> <span data-ttu-id="31286-137">Cela est dû au fait que la table de liaison elle-même ne possède aucune ressource GPU.</span><span class="sxs-lookup"><span data-stu-id="31286-137">That's because the binding table itself doesn't own any GPU resources.</span></span> <span data-ttu-id="31286-138">Au lieu de cela, le tas du descripteur.</span><span class="sxs-lookup"><span data-stu-id="31286-138">Rather, the descriptor heap does.</span></span> <span data-ttu-id="31286-139">Par conséquent, le *tas du descripteur* sous-jacent est l’objet qui doit rester actif jusqu’à ce que l’exécution se termine, et non la table de liaison elle-même.</span><span class="sxs-lookup"><span data-stu-id="31286-139">Therefore, the underlying *descriptor heap* is the object that must be kept alive until execution completes, and not the binding table itself.</span></span>

<span data-ttu-id="31286-140">Un concept similaire existe dans Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="31286-140">A similar concept exists in Direct3D 12.</span></span> <span data-ttu-id="31286-141">Un *allocateur* de commande doit rester actif jusqu’à ce que toutes les exécutions qui l’utilisent soient terminées sur le GPU. dans la mesure où elle possède la mémoire GPU.</span><span class="sxs-lookup"><span data-stu-id="31286-141">A command *allocator* must be kept alive until all executions using it have completed on the GPU; since it owns GPU memory.</span></span> <span data-ttu-id="31286-142">Toutefois, une *liste* de commandes ne possède pas de mémoire GPU. elle peut donc être réinitialisée ou libérée dès qu’elle a été soumise pour exécution.</span><span class="sxs-lookup"><span data-stu-id="31286-142">But, a command *list* doesn't own GPU memory, so it can therefore be reset or released as soon as it's been submitted for execution.</span></span>

<span data-ttu-id="31286-143">Dans DirectML, les opérateurs compilés ([**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator)) et les initialiseurs d’opérateur ([**IDMLOperatorInitializer**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer)) possèdent tous les deux des ressources GPU directement. ils doivent donc être maintenus actifs jusqu’à ce que toutes les distributions qui les utilisent aient terminé leur exécution sur le GPU.</span><span class="sxs-lookup"><span data-stu-id="31286-143">In DirectML, compiled operators ([**IDMLCompiledOperator**](/windows/desktop/api/directml/nn-directml-idmlcompiledoperator)) and operator initializers ([**IDMLOperatorInitializer**](/windows/desktop/api/directml/nn-directml-idmloperatorinitializer)) both own GPU resources directly, so they must be kept alive until all dispatches using them have completed execution on the GPU.</span></span> <span data-ttu-id="31286-144">En outre, toute ressource Direct3D 12 utilisée (allocateurs de commandes, tas de descripteurs, mémoires tampons, par exemple) doit être conservée de la même façon que votre application.</span><span class="sxs-lookup"><span data-stu-id="31286-144">In addition, any Direct3D 12 resource being used (command allocators, descriptor heaps, buffers, as examples) must similarly be kept alive by your application.</span></span>

<span data-ttu-id="31286-145">Si vous libérez prématurément un objet alors qu’il est toujours utilisé par le GPU, le résultat est un comportement indéfini, ce qui risque de provoquer la suppression du périphérique ou d’autres erreurs.</span><span class="sxs-lookup"><span data-stu-id="31286-145">If you prematurely release an object while it's still in use by the GPU, the result is undefined behavior, which has the potential to cause device removal or other errors.</span></span>

## <a name="cpu-and-gpu-synchronization"></a><span data-ttu-id="31286-146">Synchronisation du processeur et du GPU</span><span class="sxs-lookup"><span data-stu-id="31286-146">CPU and GPU synchronization</span></span>

<span data-ttu-id="31286-147">DirectML n’envoie pas lui-même de travail d’exécution sur le GPU.</span><span class="sxs-lookup"><span data-stu-id="31286-147">DirectML doesn't itself submit any work for execution on the GPU.</span></span> <span data-ttu-id="31286-148">Au lieu de cela, la [méthode **IDMLCommandRecorder :: RecordDispatch**](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) *enregistre* la distribution de ce travail dans une liste de commandes en vue d’une exécution ultérieure.</span><span class="sxs-lookup"><span data-stu-id="31286-148">Instead, the [**IDMLCommandRecorder::RecordDispatch** method](/windows/desktop/api/directml/nf-directml-idmlcommandrecorder-recorddispatch) *records* the dispatch of that work into a command list for later execution.</span></span> <span data-ttu-id="31286-149">Votre application doit ensuite fermer et soumettre sa liste de commandes pour exécution en appelant [**ID3D12CommandQueue :: ExecuteCommandLists**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-executecommandlists), comme avec n’importe quelle liste de commandes Direct3D 12.</span><span class="sxs-lookup"><span data-stu-id="31286-149">Your application must then close and submit its command list for execution by calling [**ID3D12CommandQueue::ExecuteCommandLists**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-executecommandlists), as with any Direct3D 12 command list.</span></span>

<span data-ttu-id="31286-150">Étant donné que DirectML n’envoie pas lui-même de travail d’exécution sur le GPU, il ne crée pas non plus de délimiteurs et n’exécute aucune forme de synchronisation de processeur/GPU à votre place.</span><span class="sxs-lookup"><span data-stu-id="31286-150">Because DirectML doesn't itself submit any work for execution on the GPU, it also doesn't create any fences, nor perform any form of CPU/GPU synchronization on your behalf.</span></span> <span data-ttu-id="31286-151">Il est de la responsabilité de votre application d’utiliser les primitives Direct3D 12 appropriées pour attendre la fin de l’exécution du travail soumis sur le GPU, si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="31286-151">It is the responsibility of your application to use the appropriate Direct3D 12 primitives to wait for submitted work to complete execution on the GPU, if necessary.</span></span> <span data-ttu-id="31286-152">Pour plus d’informations, consultez [**ID3D12Fence**](/windows/desktop/api/d3d12/nn-d3d12-id3d12fence) et [**ID3D12CommandQueue :: signal**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-signal).</span><span class="sxs-lookup"><span data-stu-id="31286-152">For more info, see [**ID3D12Fence**](/windows/desktop/api/d3d12/nn-d3d12-id3d12fence) and [**ID3D12CommandQueue::Signal**](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-signal).</span></span>

## <a name="see-also"></a><span data-ttu-id="31286-153">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="31286-153">See also</span></span>

* [<span data-ttu-id="31286-154">Exécution et synchronisation de listes de commandes</span><span class="sxs-lookup"><span data-stu-id="31286-154">Executing and synchronizing command lists</span></span>](/windows/desktop/direct3d12/executing-and-synchronizing-command-lists)
* [<span data-ttu-id="31286-155">Gestion des erreurs et suppression des appareils dans DirectML</span><span class="sxs-lookup"><span data-stu-id="31286-155">Handling errors and device removal in DirectML</span></span>](dml-errors.md)