---
description: Prise en charge de DXVA 2,0 dans Media Foundation
ms.assetid: d7330370-adb3-4c6a-962a-7b46c344500c
title: Prise en charge de DXVA 2,0 dans Media Foundation
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ce144c24a1aeeda6281ddb423757f3e339903440
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/03/2021
ms.locfileid: "106522887"
---
# <a name="supporting-dxva-20-in-media-foundation"></a><span data-ttu-id="bfe8a-103">Prise en charge de DXVA 2,0 dans Media Foundation</span><span class="sxs-lookup"><span data-stu-id="bfe8a-103">Supporting DXVA 2.0 in Media Foundation</span></span>

<span data-ttu-id="bfe8a-104">Cette rubrique explique comment prendre en charge DirectX Video Acceleration (DXVA) 2,0 dans une transformation de Media Foundation (MFT) à l’aide de Microsoft Direct3D 9, mais décrit la communication entre le décodeur et le convertisseur vidéo, qui est pris en charge par le chargeur de topologie.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-104">This topic describes how to support DirectX Video Acceleration (DXVA) 2.0 in a Media Foundation transform (MFT) using Microsoft Direct3D 9 Specifically, it describes the communication between the decoder and the video renderer, which is mediated by the topology loader.</span></span> <span data-ttu-id="bfe8a-105">Cette rubrique ne décrit pas comment implémenter le décodage DXVA.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-105">This topic does not describe how to implement DXVA decoding.</span></span>

<span data-ttu-id="bfe8a-106">Dans le reste de cette rubrique, le *décodeur* de terme fait référence à la table MFT du décodeur, qui reçoit la vidéo compressée et génère des sorties vidéo non compressées.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-106">In the remainder of this topic, the term *decoder* refers to the decoder MFT, which receives compressed video and outputs uncompressed video.</span></span> <span data-ttu-id="bfe8a-107">L' *appareil décodeur* terme fait référence à un accélérateur vidéo matériel implémenté par le pilote Graphics.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-107">The term *decoder device* refers to a hardware video accelerator implemented by the graphics driver.</span></span>

> [!TIP]
> <span data-ttu-id="bfe8a-108">Pour plus d’informations sur le décodage vidéo de Microsoft Direct3D 11, consultez [prise en charge du décodage vidéo Direct3D 11 dans Media Foundation](supporting-direct3d-11-video-decoding-in-media-foundation.md).</span><span class="sxs-lookup"><span data-stu-id="bfe8a-108">For info on Microsoft Direct3D 11 video decoding see, [Supporting Direct3D 11 Video Decoding in Media Foundation](supporting-direct3d-11-video-decoding-in-media-foundation.md).</span></span>

 

> [!Note]  
> <span data-ttu-id="bfe8a-109">Les applications du Windows Store doivent utiliser Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-109">Windows Store apps must use Direct3D 11.</span></span>

 

<span data-ttu-id="bfe8a-110">Voici les étapes de base qu’un décodeur doit effectuer pour prendre en charge DXVA 2,0 dans Media Foundation :</span><span class="sxs-lookup"><span data-stu-id="bfe8a-110">Here are the basic steps that a decoder must perform to support DXVA 2.0 in Media Foundation:</span></span>

1.  <span data-ttu-id="bfe8a-111">Ouvrez un handle vers l’appareil Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-111">Open a handle to the Direct3D 9 device.</span></span>
2.  <span data-ttu-id="bfe8a-112">Recherchez une configuration de décodeur DXVA.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-112">Find a DXVA decoder configuration.</span></span>
3.  <span data-ttu-id="bfe8a-113">Allouez des tampons non compressés.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-113">Allocate uncompressed Buffers.</span></span>
4.  <span data-ttu-id="bfe8a-114">Décodez les frames.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-114">Decode frames.</span></span>

<span data-ttu-id="bfe8a-115">Ces étapes sont décrites plus en détail dans le reste de cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-115">These steps are described in more detail in the remainder of this topic.</span></span>

## <a name="opening-a-direct3d-device-handle"></a><span data-ttu-id="bfe8a-116">Ouverture d’un handle de périphérique Direct3D</span><span class="sxs-lookup"><span data-stu-id="bfe8a-116">Opening a Direct3D Device Handle</span></span>

<span data-ttu-id="bfe8a-117">La table MFT utilise le gestionnaire de périphériques Microsoft Direct3D pour obtenir un descripteur de l’appareil Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-117">The MFT uses the Microsoft Direct3D device manager to get a handle to the Direct3D 9 device.</span></span> <span data-ttu-id="bfe8a-118">Pour ouvrir le descripteur de l’appareil, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="bfe8a-118">To open the device handle, perform the following steps:</span></span>

1.  <span data-ttu-id="bfe8a-119">Exposez l’attribut [ \_ prenant en \_ \_ charge Direct3D sa](mf-sa-d3d-aware-attribute.md) avec la valeur **true**.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-119">Expose the [MF\_SA\_D3D\_AWARE](mf-sa-d3d-aware-attribute.md) attribute with the value **TRUE**.</span></span> <span data-ttu-id="bfe8a-120">Le chargeur de topologie interroge cet attribut en appelant [**IMFTransform :: GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes).</span><span class="sxs-lookup"><span data-stu-id="bfe8a-120">The topology loader queries this attribute by calling [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes).</span></span> <span data-ttu-id="bfe8a-121">L’affectation de la **valeur true** à l’attribut indique au chargeur de topologie que la table MFT prend en charge DXVA.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-121">Setting the attribute to **TRUE** notifies the topology loader that the MFT supports DXVA.</span></span>
2.  <span data-ttu-id="bfe8a-122">Lorsque la négociation de format commence, le chargeur de topologie appelle [**IMFTransform ::P rocessmessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) avec le message de l' [**ensemble de messages MFT du \_ \_ \_ \_ Gestionnaire D3D**](mft-message-set-d3d-manager.md) .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-122">When format negotiation begins, the topology loader calls [**IMFTransform::ProcessMessage**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processmessage) with the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message.</span></span> <span data-ttu-id="bfe8a-123">Le paramètre *ulParam* est un pointeur **IUnknown** vers le gestionnaire de périphériques Direct3D du convertisseur vidéo.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-123">The *ulParam* parameter is an **IUnknown** pointer to the video renderer's Direct3D device manager.</span></span> <span data-ttu-id="bfe8a-124">Interrogez ce pointeur sur l’interface [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-124">Query this pointer for the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span>
3.  <span data-ttu-id="bfe8a-125">Appelez [**IDirect3DDeviceManager9 :: OpenDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-opendevicehandle) pour obtenir un handle sur le périphérique Direct3D du convertisseur.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-125">Call [**IDirect3DDeviceManager9::OpenDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-opendevicehandle) to get a handle to the renderer's Direct3D device.</span></span>
4.  <span data-ttu-id="bfe8a-126">Appelez [**IDirect3DDeviceManager9 :: GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) et transmettez le descripteur de l’appareil.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-126">Call [**IDirect3DDeviceManager9::GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) and pass in the device handle.</span></span> <span data-ttu-id="bfe8a-127">Cette méthode retourne un pointeur vers l’interface [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-127">This method returns a pointer to the [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) interface.</span></span>
5.  <span data-ttu-id="bfe8a-128">Mettez en cache les pointeurs et le handle d’appareil.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-128">Cache the pointers and the device handle.</span></span>

## <a name="finding-a-decoder-configuration"></a><span data-ttu-id="bfe8a-129">Recherche d’une configuration de décodeur</span><span class="sxs-lookup"><span data-stu-id="bfe8a-129">Finding a Decoder Configuration</span></span>

<span data-ttu-id="bfe8a-130">La table MFT doit trouver une configuration compatible pour le périphérique décodeur DXVA.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-130">The MFT must find a compatible configuration for the DXVA decoder device.</span></span> <span data-ttu-id="bfe8a-131">Effectuez les étapes suivantes à l’intérieur de la méthode [**IMFTransform :: SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) , après avoir validé le type d’entrée :</span><span class="sxs-lookup"><span data-stu-id="bfe8a-131">Perform the following steps inside the [**IMFTransform::SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) method, after validating the input type:</span></span>

1.  <span data-ttu-id="bfe8a-132">Appelez [**IDirectXVideoDecoderService :: GetDecoderDeviceGuids**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderdeviceguids).</span><span class="sxs-lookup"><span data-stu-id="bfe8a-132">Call [**IDirectXVideoDecoderService::GetDecoderDeviceGuids**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderdeviceguids).</span></span> <span data-ttu-id="bfe8a-133">Cette méthode retourne un tableau de GUID d’appareil de décodage.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-133">This method returns an array of decoder device GUIDs.</span></span>
2.  <span data-ttu-id="bfe8a-134">Parcourez le tableau de GUID de décodeur pour trouver ceux que le décodeur prend en charge.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-134">Loop through the array of decoder GUIDs to find the ones that the decoder supports.</span></span> <span data-ttu-id="bfe8a-135">Par exemple, pour un décodeur MPEG-2, vous devez rechercher **DXVA2 \_ ModeMPEG2 \_ MOCOMP**, **DXVA2 \_ ModeMPEG2 \_ IDCT** ou DXVA2 ModeMPEG2 **\_ \_ VLD**.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-135">For example, for an MPEG-2 decoder, you would look for **DXVA2\_ModeMPEG2\_MOCOMP**, **DXVA2\_ModeMPEG2\_IDCT**, or **DXVA2\_ModeMPEG2\_VLD**.</span></span>

3.  <span data-ttu-id="bfe8a-136">Lorsque vous trouvez un GUID d’appareil décodeur candidat, transmettez le GUID à la méthode [**IDirectXVideoDecoderService :: GetDecoderRenderTargets**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderrendertargets) .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-136">When you find a candidate decoder device GUID, pass the GUID to the [**IDirectXVideoDecoderService::GetDecoderRenderTargets**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderrendertargets) method.</span></span> <span data-ttu-id="bfe8a-137">Cette méthode retourne un tableau de formats de cible de rendu, spécifiés en tant que valeurs **D3DFORMAT** .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-137">This method returns an array of render target formats, specified as **D3DFORMAT** values.</span></span>
4.  <span data-ttu-id="bfe8a-138">Parcourez les formats des cibles de rendu et recherchez un format pris en charge par le décodeur.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-138">Loop through the render target formats and look for a format supported by the decoder.</span></span>
5.  <span data-ttu-id="bfe8a-139">Appelez [**IDirectXVideoDecoderService :: GetDecoderConfigurations**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderconfigurations).</span><span class="sxs-lookup"><span data-stu-id="bfe8a-139">Call [**IDirectXVideoDecoderService::GetDecoderConfigurations**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-getdecoderconfigurations).</span></span> <span data-ttu-id="bfe8a-140">Transmettez le même GUID de périphérique décodeur, ainsi qu’une structure [**DXVA2 \_ VideoDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videodesc) qui décrit le format de sortie proposé.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-140">Pass in the same decoder device GUID, along with a [**DXVA2\_VideoDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_videodesc) structure that describes the proposed output format.</span></span> <span data-ttu-id="bfe8a-141">La méthode retourne un tableau de structures [**DXVA2 \_ ConfigPictureDecode**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_configpicturedecode) .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-141">The method returns an array of [**DXVA2\_ConfigPictureDecode**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_configpicturedecode) structures.</span></span> <span data-ttu-id="bfe8a-142">Chaque structure décrit une configuration possible pour l’appareil décodeur.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-142">Each structure describes one possible configuration for the decoder device.</span></span> <span data-ttu-id="bfe8a-143">Recherchez une configuration prise en charge par le décodeur.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-143">Look for a configuration that the decoder supports.</span></span>
6.  <span data-ttu-id="bfe8a-144">Stockez le format et la configuration de la cible de rendu.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-144">Store the render target format and configuration.</span></span>

<span data-ttu-id="bfe8a-145">Dans la méthode [**IMFTransform :: GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) , retourne un format vidéo non compressé, en fonction du format de cible de rendu proposé.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-145">In the [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) method, return an uncompressed video format, based on the proposed render target format.</span></span>

<span data-ttu-id="bfe8a-146">Dans la méthode [**IMFTransform :: SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) , vérifiez le type de média par rapport au format de la cible de rendu.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-146">In the [**IMFTransform::SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) method, check the media type against the render target format.</span></span>

### <a name="fallback-to-software-decoding"></a><span data-ttu-id="bfe8a-147">Revenir au décodage logiciel</span><span class="sxs-lookup"><span data-stu-id="bfe8a-147">Fallback to Software Decoding</span></span>

<span data-ttu-id="bfe8a-148">Si la MFT ne trouve pas de configuration DXVA (par exemple, si le pilote Graphics n’a pas les bonnes fonctionnalités), il doit retourner le code d’erreur **MF \_ E \_ \_ \_ type D3D non pris en charge** à partir des méthodes [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) et [**SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-148">If the MFT cannot find a DXVA configuration (for example, if the graphics driver does not have the right capabilities), it should return the error code **MF\_E\_UNSUPPORTED\_D3D\_TYPE** from the [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype) and [**SetOutputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setoutputtype) methods.</span></span> <span data-ttu-id="bfe8a-149">Le chargeur de topologie répond en envoyant le message de [**l' \_ ensemble de messages MFT du \_ \_ \_ Gestionnaire D3D**](mft-message-set-d3d-manager.md) avec la valeur **null** pour le paramètre *ulParam* .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-149">The topology loader will respond by sending the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message with the value **NULL** for the *ulParam* parameter.</span></span> <span data-ttu-id="bfe8a-150">La table MFT doit libérer son pointeur vers l’interface [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-150">The MFT should release its pointer to the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span> <span data-ttu-id="bfe8a-151">Le chargeur de topologie renégocie ensuite le type de média et la table MFT peut utiliser le décodage logiciel.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-151">The topology loader will then renegotiate the media type, and the MFT can use software decoding.</span></span>

## <a name="allocating-uncompressed-buffers"></a><span data-ttu-id="bfe8a-152">Allocation de mémoires tampons non compressées</span><span class="sxs-lookup"><span data-stu-id="bfe8a-152">Allocating Uncompressed Buffers</span></span>

<span data-ttu-id="bfe8a-153">Dans DXVA 2,0, le décodeur est chargé d’allouer des surfaces Direct3D à utiliser comme mémoires tampons vidéo non compressées.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-153">In DXVA 2.0, the decoder is responsible for allocating Direct3D surfaces to use as uncompressed video buffers.</span></span> <span data-ttu-id="bfe8a-154">Le décodeur doit allouer 3 surfaces pour le EVR à utiliser pour l’entrelacement.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-154">The decoder should allocate 3 surfaces for the EVR to use for deinterlacing.</span></span> <span data-ttu-id="bfe8a-155">Ce nombre est fixe, car Media Foundation ne permet pas au EVR de spécifier le nombre de surfaces nécessaires au pilote Graphics pour l’entrelacement.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-155">This number is fixed, because Media Foundation does not provide a way for the EVR to specify how many surfaces the graphics driver requires for deinterlacing.</span></span> <span data-ttu-id="bfe8a-156">Trois surfaces doivent être suffisantes pour n’importe quel pilote.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-156">Three surfaces should be sufficient for any driver.</span></span>

<span data-ttu-id="bfe8a-157">Dans la méthode [**IMFTransform :: GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) , définissez le **flux de sortie MFT fournit l’indicateur \_ \_ \_ \_ Samples** dans la structure d' [**informations du \_ \_ flux \_ de sortie MFT**](/windows/desktop/api/mftransform/ns-mftransform-mft_output_stream_info) .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-157">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag in the [**MFT\_OUTPUT\_STREAM\_INFO**](/windows/desktop/api/mftransform/ns-mftransform-mft_output_stream_info) structure.</span></span> <span data-ttu-id="bfe8a-158">Cet indicateur signale à la session multimédia que la table MFT alloue ses propres exemples de sortie.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-158">This flag notifies the Media Session that the MFT allocates its own output samples.</span></span>

<span data-ttu-id="bfe8a-159">Pour créer les surfaces, appelez [**IDirectXVideoAccelerationService :: CreateSurface**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoaccelerationservice-createsurface).</span><span class="sxs-lookup"><span data-stu-id="bfe8a-159">To create the surfaces, call [**IDirectXVideoAccelerationService::CreateSurface**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideoaccelerationservice-createsurface).</span></span> <span data-ttu-id="bfe8a-160">(L’interface [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) hérite de cette méthode de [**IDirectXVideoAccelerationService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoaccelerationservice).) Vous pouvez le faire dans [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype), après avoir trouvé le format de la cible du rendu.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-160">(The [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) interface inherits this method from [**IDirectXVideoAccelerationService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoaccelerationservice).) You can do this in [**SetInputType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-setinputtype), after finding the render target format.</span></span>

<span data-ttu-id="bfe8a-161">Pour chaque surface, appelez [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) pour créer un échantillon de support destiné à accueillir l’aire.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-161">For each surface, call [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface) to create a media sample to hold the surface.</span></span> <span data-ttu-id="bfe8a-162">La méthode retourne un pointeur vers l’interface [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-162">The method returns a pointer to the [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) interface.</span></span>

## <a name="decoding"></a><span data-ttu-id="bfe8a-163">Décodage</span><span class="sxs-lookup"><span data-stu-id="bfe8a-163">Decoding</span></span>

<span data-ttu-id="bfe8a-164">Pour créer l’appareil de décodage, appelez [**IDirectXVideoDecoderService :: CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="bfe8a-164">To create the decoder device, call [**IDirectXVideoDecoderService::CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span></span> <span data-ttu-id="bfe8a-165">La méthode retourne un pointeur vers l’interface [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) de l’appareil décodeur.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-165">The method returns a pointer to the [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) interface of the decoder device.</span></span>

<span data-ttu-id="bfe8a-166">Le décodage doit se produire à l’intérieur de la méthode [**IMFTransform ::P rocessoutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-166">Decoding should occur inside the [**IMFTransform::ProcessOutput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processoutput) method.</span></span> <span data-ttu-id="bfe8a-167">Sur chaque frame, appelez [**IDirect3DDeviceManager9 :: TestDevice**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-testdevice) pour tester le handle de l’appareil.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-167">On each frame, call [**IDirect3DDeviceManager9::TestDevice**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-testdevice) to test the device handle.</span></span> <span data-ttu-id="bfe8a-168">Si l’appareil a changé, la méthode retourne **DXVA2 \_ E \_ New \_ Video \_ Device**.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-168">If the device has changed, the method returns **DXVA2\_E\_NEW\_VIDEO\_DEVICE**.</span></span> <span data-ttu-id="bfe8a-169">Si cela se produit, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="bfe8a-169">If this occurs, do the following:</span></span>

1.  <span data-ttu-id="bfe8a-170">Fermez le handle d’appareil en appelant [**IDirect3DDeviceManager9 :: CloseDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-closedevicehandle).</span><span class="sxs-lookup"><span data-stu-id="bfe8a-170">Close the device handle by calling [**IDirect3DDeviceManager9::CloseDeviceHandle**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-closedevicehandle).</span></span>
2.  <span data-ttu-id="bfe8a-171">Libérez les pointeurs [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) et [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-171">Release the [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice) and [**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder) pointers.</span></span>
3.  <span data-ttu-id="bfe8a-172">Ouvrez un nouveau descripteur d’appareil.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-172">Open a new device handle.</span></span>
4.  <span data-ttu-id="bfe8a-173">Négociez une nouvelle configuration de décodeur, comme décrit dans la section « recherche d’une configuration de décodeur », plus haut dans cette page.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-173">Negotiate a new decoder configuration, as described in "Finding a Decoder Configuration" earlier on this page.</span></span>
5.  <span data-ttu-id="bfe8a-174">Créez un appareil de décodage.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-174">Create a new decoder device.</span></span>

<span data-ttu-id="bfe8a-175">En supposant que le descripteur de l’appareil est valide, le processus de décodage fonctionne comme suit :</span><span class="sxs-lookup"><span data-stu-id="bfe8a-175">Assuming that the device handle is valid, the decoding process works as follows:</span></span>

1.  <span data-ttu-id="bfe8a-176">Obtient une surface disponible qui n’est pas en cours d’utilisation.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-176">Get an available surface that is not currently in use.</span></span> <span data-ttu-id="bfe8a-177">(Initialement, toutes les surfaces sont disponibles.)</span><span class="sxs-lookup"><span data-stu-id="bfe8a-177">(Initially all of the surfaces are available.)</span></span>
2.  <span data-ttu-id="bfe8a-178">Interrogez l’exemple de support pour l’interface [**IMFTrackedSample**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) .</span><span class="sxs-lookup"><span data-stu-id="bfe8a-178">Query the media sample for the [**IMFTrackedSample**](/windows/win32/api/mfidl/nn-mfidl-imftrackedsample) interface.</span></span>
3.  <span data-ttu-id="bfe8a-179">Appelez [**IMFTrackedSample :: SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) et fournissez un pointeur vers l’interface [**IMFAsyncCallback**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) , implémentée par le décodeur.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-179">Call [**IMFTrackedSample::SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) and provide a pointer to the [**IMFAsyncCallback**](/windows/desktop/api/mfobjects/nn-mfobjects-imfasynccallback) interface, implemented by the decoder.</span></span> <span data-ttu-id="bfe8a-180">Quand le convertisseur vidéo libère l’exemple, le rappel du décodeur est appelé.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-180">When the video renderer releases the sample, the decoder's callback will be invoked.</span></span>
4.  <span data-ttu-id="bfe8a-181">Appelez [**IDirectXVideoDecoder :: BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe).</span><span class="sxs-lookup"><span data-stu-id="bfe8a-181">Call [**IDirectXVideoDecoder::BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe).</span></span>
5.  <span data-ttu-id="bfe8a-182">Effectuez les opérations suivantes une ou plusieurs fois :</span><span class="sxs-lookup"><span data-stu-id="bfe8a-182">Do the following one or more times:</span></span>
    1.  <span data-ttu-id="bfe8a-183">Appelez [**IDirectXVideoDecoder :: GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) pour obtenir une mémoire tampon de décodeur DXVA.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-183">Call [**IDirectXVideoDecoder::GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) to get a DXVA decoder buffer.</span></span>
    2.  <span data-ttu-id="bfe8a-184">Remplir la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-184">Fill the buffer.</span></span>
    3.  <span data-ttu-id="bfe8a-185">Appelez [**IDirectXVideoDecoder :: ReleaseBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-releasebuffer).</span><span class="sxs-lookup"><span data-stu-id="bfe8a-185">Call [**IDirectXVideoDecoder::ReleaseBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-releasebuffer).</span></span>
    4.  <span data-ttu-id="bfe8a-186">Appelez [**IDirectXVideoDecoder :: Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) pour effectuer les opérations de décodage sur le frame.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-186">Call [**IDirectXVideoDecoder::Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) to perform the decoding operations on the frame.</span></span>

<span data-ttu-id="bfe8a-187">DXVA 2,0 utilise les mêmes structures de données que DXVA 1,0 pour les opérations de décodage.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-187">DXVA 2.0 uses the same data structures as DXVA 1.0 for decoding operations.</span></span> <span data-ttu-id="bfe8a-188">Pour l’ensemble initial de profils DXVA (pour H. 261, H. 263 et MPEG-2), ces structures de données sont décrites dans la [spécification DXVA 1,0](/windows-hardware/drivers/display/directx-video-acceleration).</span><span class="sxs-lookup"><span data-stu-id="bfe8a-188">For the original set of DXVA profiles (for H.261, H.263, and MPEG-2), these data structures are described in the [DXVA 1.0 specification](/windows-hardware/drivers/display/directx-video-acceleration).</span></span>

<span data-ttu-id="bfe8a-189">Au sein de chaque paire d’appels [**BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe) / [**Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) , vous pouvez appeler [**GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) plusieurs fois, mais une seule fois pour chaque type de mémoire tampon DXVA.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-189">Within each pair of [**BeginFrame**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-beginframe)/[**Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) calls, you may call [**GetBuffer**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-getbuffer) multiple times, but only once for each type of DXVA buffer.</span></span> <span data-ttu-id="bfe8a-190">Si vous l’appelez deux fois avec le même type de mémoire tampon, vous allez remplacer les données.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-190">If you call it twice with the same buffer type, you will overwrite the data.</span></span>

<span data-ttu-id="bfe8a-191">Utilisez le rappel à partir de la méthode [**SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) (étape 3) pour effectuer le suivi des exemples qui sont actuellement disponibles et qui sont en cours d’utilisation.</span><span class="sxs-lookup"><span data-stu-id="bfe8a-191">Use the callback from the [**SetAllocator**](/windows/win32/api/mfidl/nf-mfidl-imftrackedsample-setallocator) method (step 3) to keep track of which samples are currently available and which are in use.</span></span>

## <a name="related-topics"></a><span data-ttu-id="bfe8a-192">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="bfe8a-192">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="bfe8a-193">Accélération vidéo DirectX 2,0</span><span class="sxs-lookup"><span data-stu-id="bfe8a-193">DirectX Video Acceleration 2.0</span></span>](directx-video-acceleration-2-0.md)
</dt> <dt>

[<span data-ttu-id="bfe8a-194">Transformations de Media Foundation</span><span class="sxs-lookup"><span data-stu-id="bfe8a-194">Media Foundation Transforms</span></span>](media-foundation-transforms.md)
</dt> </dl>

 

 
