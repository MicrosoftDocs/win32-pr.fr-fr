---
description: Génération de nouveaux paquets de données ASF
ms.assetid: 7afa9694-c965-40e2-8549-e32ff48def2a
title: Génération de nouveaux paquets de données ASF
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 78f3432ecf34c58247a1533adb202b75f59d770c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104484072"
---
# <a name="generating-new-asf-data-packets"></a><span data-ttu-id="b9b85-103">Génération de nouveaux paquets de données ASF</span><span class="sxs-lookup"><span data-stu-id="b9b85-103">Generating New ASF Data Packets</span></span>

<span data-ttu-id="b9b85-104">Le *multiplexeur* ASF est un composant de couche WMContainer qui fonctionne avec l' [objet de données ASF](asf-file-structure.md) et donne à une application la possibilité de générer des paquets de données ASF pour un flux qui correspond aux exigences définies dans l’objet ContentInfo.</span><span class="sxs-lookup"><span data-stu-id="b9b85-104">The ASF *multiplexer* is a WMContainer layer component that works with the [ASF Data Object](asf-file-structure.md) and gives an application the ability to generate ASF data packets for a stream that match the requirements defined in the ContentInfo object.</span></span>

<span data-ttu-id="b9b85-105">Le multiplexeur a une entrée et une sortie.</span><span class="sxs-lookup"><span data-stu-id="b9b85-105">The multiplexer has one input and one output.</span></span> <span data-ttu-id="b9b85-106">Elle reçoit un exemple de flux qui contient des données multimédias numériques et produit un ou plusieurs paquets de données qui peuvent être écrits dans un conteneur ASF.</span><span class="sxs-lookup"><span data-stu-id="b9b85-106">It receives a stream sample that contains digital media data and produces one or more data packet that can be written to an ASF container.</span></span>

<span data-ttu-id="b9b85-107">La liste suivante résume le processus de génération de paquets de données ASF :</span><span class="sxs-lookup"><span data-stu-id="b9b85-107">The following list summarizes the process of generating ASF data packets:</span></span>

1.  <span data-ttu-id="b9b85-108">Transmettez les données d’entrée au multiplexeur dans [**IMFASFMultiplexer ::P rocesssample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="b9b85-108">Pass input data to the multiplexer in [**IMFASFMultiplexer::ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span>
2.  <span data-ttu-id="b9b85-109">Collectez les paquets de données en appelant [**IMFASFMultiplexer :: GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) dans une boucle jusqu’à ce que tous les paquets complets aient été récupérés.</span><span class="sxs-lookup"><span data-stu-id="b9b85-109">Collect the data packets by calling [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop until all the complete packets have been retrieved.</span></span>
3.  <span data-ttu-id="b9b85-110">Une fois les données d’entrée converties en paquets complets, il peut y avoir des données en attente dans le multiplexeur, qui n’a pas été récupéré par [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span><span class="sxs-lookup"><span data-stu-id="b9b85-110">After the input data has been converted into complete packets there might be some pending data in the multiplexer, which was not retrieved by [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span></span> <span data-ttu-id="b9b85-111">Appelez [**IMFASFMultiplexer :: Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) pour paqueter les exemples en attente et les collecter à partir du multiplexeur en appelant à nouveau **GetNextPacket** .</span><span class="sxs-lookup"><span data-stu-id="b9b85-111">Call [**IMFASFMultiplexer::Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) to packetize the pending samples and collect them from the multiplexer by calling **GetNextPacket** again.</span></span>
4.  <span data-ttu-id="b9b85-112">Mettez à jour les objets d’en-tête ASF associés en appelant [**IMFASFMultiplexer :: end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) pour refléter les modifications apportées par le multiplexeur pendant la génération des paquets de données.</span><span class="sxs-lookup"><span data-stu-id="b9b85-112">Update the associated ASF Header Objects by calling [**IMFASFMultiplexer::End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) to reflect changes made by the multiplexer during data packet generation.</span></span>

<span data-ttu-id="b9b85-113">Le diagramme suivant illustre la génération de paquets de données pour un fichier ASF par le biais du multiplexeur.</span><span class="sxs-lookup"><span data-stu-id="b9b85-113">The following diagram illustrates data packet generation for an ASF file through the multiplexer.</span></span>

![Diagramme montrant la génération de paquets de données pour un fichier ASF](images/packet.gif)

## <a name="asf-data-packet-creation"></a><span data-ttu-id="b9b85-115">Création de paquets de données ASF</span><span class="sxs-lookup"><span data-stu-id="b9b85-115">ASF Data Packet Creation</span></span>

<span data-ttu-id="b9b85-116">Après avoir créé et initialisé le multiplexeur comme décrit dans [création de l’objet multiplexeur](creating-the-multiplexer-object.md), appelez [**IMFASFMultiplexer ::P rocesssample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) pour transmettre des données d’entrée au multiplexeur en vue de leur traitement dans des paquets de données.</span><span class="sxs-lookup"><span data-stu-id="b9b85-116">After creating and initializing the multiplexer as described in [Creating the Multiplexer Object](creating-the-multiplexer-object.md), call [**IMFASFMultiplexer::ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) to pass input data to the multiplexer for processing into data packets.</span></span> <span data-ttu-id="b9b85-117">L’entrée spécifiée doit se trouver dans un échantillon de média (interface [**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) ) qui peut avoir un ou plusieurs tampons de média (interface [**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) ) contenant les données d’un flux.</span><span class="sxs-lookup"><span data-stu-id="b9b85-117">The specified input must be in a media sample ([**IMFSample**](/windows/desktop/api/mfobjects/nn-mfobjects-imfsample) interface) that can have one or more media buffers ([**IMFMediaBuffer**](/windows/desktop/api/mfobjects/nn-mfobjects-imfmediabuffer) interface) containing the data for a stream.</span></span> <span data-ttu-id="b9b85-118">Dans le cas d’un transcodage ASF-à-ASF, l’exemple de média d’entrée peut être généré à partir du séparateur qui crée des exemples de flux paquets.</span><span class="sxs-lookup"><span data-stu-id="b9b85-118">In case of ASF-to-ASF transcoding, the input media sample can be generated from the splitter that creates packetized stream samples.</span></span> <span data-ttu-id="b9b85-119">Pour plus d’informations, consultez [séparateur ASF](asf-splitter.md).</span><span class="sxs-lookup"><span data-stu-id="b9b85-119">For more information, see [ASF Splitter](asf-splitter.md).</span></span>

<span data-ttu-id="b9b85-120">Avant d’appeler [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample), assurez-vous que l’horodatage de l’exemple de média d’entrée est une heure de présentation valide. sinon **ProcessSample** échoue et retourne l' \_ exemple de code d’horodatage MF E \_ no \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="b9b85-120">Before calling [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample), make sure that the time stamp of the input media sample is a valid presentation time; otherwise **ProcessSample** fails and returns the MF\_E\_NO\_SAMPLE\_TIMESTAMP code.</span></span>

<span data-ttu-id="b9b85-121">Le multiplexeur peut accepter les entrées en tant qu’exemples de supports compressés ou non compressés via [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="b9b85-121">The multiplexer can accept input as compressed or uncompressed media samples through [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span> <span data-ttu-id="b9b85-122">Le multiplexeur attribue des heures d’envoi à ces exemples en fonction de l’utilisation de la bande passante du flux.</span><span class="sxs-lookup"><span data-stu-id="b9b85-122">The multiplexer assigns send times to these samples depending on the bandwidth usage of the stream.</span></span> <span data-ttu-id="b9b85-123">Pendant ce processus, le multiplexeur vérifie les paramètres de compartiment avec fuite (taux de bits et utilisation de la fenêtre de mémoire tampon) et peut rejeter des exemples qui n’adhèrent pas à ces valeurs.</span><span class="sxs-lookup"><span data-stu-id="b9b85-123">During this process, the multiplexer checks the leaky bucket parameters (bit rate and buffer window utilization) and can reject samples that do not adhere to those values.</span></span> <span data-ttu-id="b9b85-124">L’exemple de média d’entrée peut faire échouer la vérification de la bande passante pour l’une des raisons suivantes :</span><span class="sxs-lookup"><span data-stu-id="b9b85-124">The input media sample can fail the bandwidth check for either of the following reasons:</span></span>

-   <span data-ttu-id="b9b85-125">Si l’exemple de média d’entrée est arrivé à expiration parce que l’heure d’envoi du dernier assignée est supérieure à l’horodatage de cet exemple de support.</span><span class="sxs-lookup"><span data-stu-id="b9b85-125">If the input media sample arrived late because the last-assigned send time is greater than the time stamp on this media sample.</span></span> <span data-ttu-id="b9b85-126">[**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) échoue et retourne l’exemple de code d’erreur **MF \_ E \_ Late \_** .</span><span class="sxs-lookup"><span data-stu-id="b9b85-126">[**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) fails and returns the **MF\_E\_LATE\_SAMPLE** error code.</span></span>
-   <span data-ttu-id="b9b85-127">Si l’horodatage sur l’échantillon de média d’entrée est antérieur à l’heure d’envoi affectée (cela indique un dépassement de mémoire tampon).</span><span class="sxs-lookup"><span data-stu-id="b9b85-127">If the time stamp on the input media sample is earlier than the assigned send time (this indicates buffer overflow).</span></span> <span data-ttu-id="b9b85-128">Le multiplexeur peut ignorer cette situation s’il est configuré pour ajuster la vitesse de transmission en définissant l’indicateur de vitesse de **\_ \_ \_ transmission** du multiplexeur MFASF au cours de l’initialisation du multiplexeur.</span><span class="sxs-lookup"><span data-stu-id="b9b85-128">The multiplexer can ignore this situation if it is configured to adjust the bit rate by setting the **MFASF\_MULTIPLEXER\_AUTOADJUST\_BITRATE** flag during multiplexer initialization.</span></span> <span data-ttu-id="b9b85-129">Pour plus d’informations, consultez « initialisation du multiplexeur et paramètres des compartiments de fuites » dans [création de l’objet multiplexeur](creating-the-multiplexer-object.md).</span><span class="sxs-lookup"><span data-stu-id="b9b85-129">For more information, see "Multiplexer Initialization and Leaky Bucket Settings" in [Creating the Multiplexer Object](creating-the-multiplexer-object.md).</span></span> <span data-ttu-id="b9b85-130">Si cet indicateur n’est pas défini et que le multiplexeur rencontre une saturation de la bande passante, [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) échoue et retourne le code d’erreur de **\_ \_ \_ dépassement de bande passante MF E** .</span><span class="sxs-lookup"><span data-stu-id="b9b85-130">If this flag is not set and the multiplexer encounters bandwidth overrun, [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) fails and returns the **MF\_E\_BANDWIDTH\_OVERRUN** error code.</span></span>

<span data-ttu-id="b9b85-131">Une fois que le multiplexeur a affecté l’heure d’envoi, l’exemple de média d’entrée est ajouté à la *fenêtre d’envoi*, c’est-à-dire une liste d’exemples de médias d’entrée classés par heure d’envoi et prêts à être traités dans des paquets de données.</span><span class="sxs-lookup"><span data-stu-id="b9b85-131">After the multiplexer assigns the send time, the input media sample is added to the *send window*—a list of input media samples ordered by send times and ready to be processed into data packets.</span></span> <span data-ttu-id="b9b85-132">Pendant la construction des paquets de données, l’exemple de média d’entrée est analysé et les données pertinentes sont écrites dans un paquet de données comme charge utile.</span><span class="sxs-lookup"><span data-stu-id="b9b85-132">During data packet construction, the input media sample is parsed and relevant data is written to a data packet as payload.</span></span> <span data-ttu-id="b9b85-133">Un paquet de données complet peut contenir des données provenant d’un ou de plusieurs exemples de supports d’entrée.</span><span class="sxs-lookup"><span data-stu-id="b9b85-133">A complete data packet can contain data from one or more input media samples.</span></span>

<span data-ttu-id="b9b85-134">Quand de nouveaux exemples de médias d’entrée arrivent dans la fenêtre d’envoi, ils sont ajoutés à une file d’attente jusqu’à ce qu’il y ait suffisamment d’échantillons de supports pour former un paquet complet.</span><span class="sxs-lookup"><span data-stu-id="b9b85-134">When new input media samples arrive in the send window, they are added to a queue until there are enough media samples to form one complete packet.</span></span> <span data-ttu-id="b9b85-135">Les données dans les mémoires tampons de média contenues par l’exemple de média d’entrée ne sont pas copiées dans le paquet de données généré.</span><span class="sxs-lookup"><span data-stu-id="b9b85-135">The data in media buffers contained by the input media sample are not copied to the generated data packet.</span></span> <span data-ttu-id="b9b85-136">Le paquet de données conserve les références aux tampons du média d’entrée jusqu’à ce que l’exemple de média d’entrée ait été entièrement packeted et que le paquet complet ait été collecté du multiplexeur.</span><span class="sxs-lookup"><span data-stu-id="b9b85-136">The data packet hold references to the input media buffers until the input media sample has been fully packetized and the complete packet have been collected from the multiplexer.</span></span>

<span data-ttu-id="b9b85-137">Lorsqu’un paquet de données complet est disponible, il peut être récupéré en appelant [**IMFASFMultiplexer :: GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span><span class="sxs-lookup"><span data-stu-id="b9b85-137">When a complete data packet is available, it can be retrieved by calling [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket).</span></span> <span data-ttu-id="b9b85-138">Si vous appelez [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) alors que des paquets complets sont prêts pour la récupération, il échoue et retourne le code d’erreur **MF \_ E \_ NOTACCEPTING** .</span><span class="sxs-lookup"><span data-stu-id="b9b85-138">If you call [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample) while there are complete packets ready for retrieval, it fails and returns the **MF\_E\_NOTACCEPTING** error code.</span></span> <span data-ttu-id="b9b85-139">Cela indique que le multiplexeur ne peut pas accepter plus d’entrée et vous devez appeler **GetNextPacket** pour récupérer les paquets en attente.</span><span class="sxs-lookup"><span data-stu-id="b9b85-139">This indicates that the multiplexer cannot accept more input and you must call **GetNextPacket** to retrieve the waiting packets.</span></span> <span data-ttu-id="b9b85-140">Dans l’idéal, chaque appel **ProcessSample** doit être suivi par un ou plusieurs appels **GetNextPacket** pour obtenir les paquets de données complets.</span><span class="sxs-lookup"><span data-stu-id="b9b85-140">Ideally, every **ProcessSample** call should be followed by one or more **GetNextPacket** calls to get the complete data packets.</span></span> <span data-ttu-id="b9b85-141">Plusieurs exemples de média d’entrée peuvent être nécessaires pour créer un paquet de données complet.</span><span class="sxs-lookup"><span data-stu-id="b9b85-141">It may take more than one input media sample to create a complete data packet.</span></span> <span data-ttu-id="b9b85-142">À l’inverse, les données d’un exemple de média d’entrée peuvent s’étendre sur plusieurs paquets.</span><span class="sxs-lookup"><span data-stu-id="b9b85-142">Conversely, data in one input media sample might span multiple packets.</span></span> <span data-ttu-id="b9b85-143">Par conséquent, tous les appels à **ProcessSample** produiront des exemples de supports de sortie.</span><span class="sxs-lookup"><span data-stu-id="b9b85-143">Therefore, not all calls to **ProcessSample** will yield output media samples.</span></span>

<span data-ttu-id="b9b85-144">Si l’exemple de média d’entrée contient une image clé indiquée par l’attribut [**MFSampleExtension \_ CleanPoint**](mfsampleextension-cleanpoint-attribute.md) , le multiplexeur copie l’attribut dans le paquet.</span><span class="sxs-lookup"><span data-stu-id="b9b85-144">If the input media sample contains a key frame indicated by the [**MFSampleExtension\_CleanPoint**](mfsampleextension-cleanpoint-attribute.md) attribute, the multiplexer copies the attribute to the packet.</span></span>

## <a name="getting-asf-data-packets"></a><span data-ttu-id="b9b85-145">Obtention de paquets de données ASF</span><span class="sxs-lookup"><span data-stu-id="b9b85-145">Getting ASF Data Packets</span></span>

<span data-ttu-id="b9b85-146">Pour collecter les exemples de supports de sortie pour un paquet de données complet généré par le multiplexeur, appelez [**IMFASFMultiplexer :: GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) dans une boucle jusqu’à ce qu’il n’y ait plus d’échantillons de média de sortie pour le paquet.</span><span class="sxs-lookup"><span data-stu-id="b9b85-146">To collect the output media samples for a complete data packet generated by the multiplexer, call [**IMFASFMultiplexer::GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop until there are no more output media samples left for the packet.</span></span> <span data-ttu-id="b9b85-147">La liste suivante répertorie les cas de réussite :</span><span class="sxs-lookup"><span data-stu-id="b9b85-147">The following lists the success cases:</span></span>

-   <span data-ttu-id="b9b85-148">Si un paquet de données complet est disponible, [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) reçoit l’indicateur d' **\_ État ASF \_ \_ incomplet** dans le paramètre *pdwStatusFlags* ; le paramètre *ppIPacket* reçoit un pointeur vers le premier paquet de données.</span><span class="sxs-lookup"><span data-stu-id="b9b85-148">If there is a complete data packet available, [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) receives the **ASF\_STATUS\_FLAGS\_INCOMPLETE** flag in the *pdwStatusFlags* parameter; the *ppIPacket* parameter receives a pointer to the first data packet.</span></span> <span data-ttu-id="b9b85-149">Vous devez appeler cette méthode aussi longtemps qu’elle reçoit cet indicateur.</span><span class="sxs-lookup"><span data-stu-id="b9b85-149">You must call this method as long it receives this flag.</span></span> <span data-ttu-id="b9b85-150">Avec chaque itération, *ppIPacket* pointe vers le paquet suivant dans la file d’attente.</span><span class="sxs-lookup"><span data-stu-id="b9b85-150">With every iteration, *ppIPacket* points to the next packet in the queue.</span></span>
-   <span data-ttu-id="b9b85-151">S’il n’existe qu’un seul paquet de données, *ppIPacket* pointe vers celui-ci et l’indicateur **ASF \_ Status \_ Flags \_ incomplet** n’est pas reçu dans *pdwStatusFlags*.</span><span class="sxs-lookup"><span data-stu-id="b9b85-151">If there is only one data packet, *ppIPacket* points to it and the **ASF\_STATUS\_FLAGS\_INCOMPLETE** flag is not received in *pdwStatusFlags*.</span></span>
-   <span data-ttu-id="b9b85-152">[**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) peut aboutir sans générer de paquets de données si le multiplexeur est toujours en train de transmettre et d’ajouter des paquets de données.</span><span class="sxs-lookup"><span data-stu-id="b9b85-152">[**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) can succeed without yielding any data packets if the multiplexer is still in the process of packetizing and adding data packets.</span></span> <span data-ttu-id="b9b85-153">Dans ce cas, *ppIPacket* pointe vers la **valeur null**.</span><span class="sxs-lookup"><span data-stu-id="b9b85-153">In this case, *ppIPacket* points to **NULL**.</span></span> <span data-ttu-id="b9b85-154">Pour continuer, vous devez fournir au multiplexeur plus d’exemples de supports d’entrée en appelant [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span><span class="sxs-lookup"><span data-stu-id="b9b85-154">To proceed, you must provide the multiplexer with more input media samples by calling [**ProcessSample**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-processsample).</span></span>

<span data-ttu-id="b9b85-155">L’exemple de code suivant illustre une fonction qui génère des paquets de données à l’aide du multiplexeur.</span><span class="sxs-lookup"><span data-stu-id="b9b85-155">The following example code shows a function that generates data packets by using the multiplexer.</span></span> <span data-ttu-id="b9b85-156">Le contenu du paquet de données généré sera écrit dans le flux d’octets de données alloué par l’appelant.</span><span class="sxs-lookup"><span data-stu-id="b9b85-156">The generated data packet contents will be written to the data byte stream allocated by the caller.</span></span>


```C++
//-------------------------------------------------------------------
// GenerateASFDataPackets
// 
// Gets data packets from the mux. This function is called after 
// calling IMFASFMultiplexer::ProcessSample. 
//-------------------------------------------------------------------

HRESULT GenerateASFDataPackets( 
    IMFASFMultiplexer *pMux, 
    IMFByteStream *pDataStream
    )
{
    HRESULT hr = S_OK;

    IMFSample *pOutputSample = NULL;
    IMFMediaBuffer *pDataPacketBuffer = NULL;

    DWORD dwMuxStatus = ASF_STATUSFLAGS_INCOMPLETE;

    while (dwMuxStatus & ASF_STATUSFLAGS_INCOMPLETE)
    {
        hr = pMux->GetNextPacket(&dwMuxStatus, &pOutputSample);

        if (FAILED(hr))
        {
            break;
        }

        if (pOutputSample)
        {
            //Convert to contiguous buffer
            hr = pOutputSample->ConvertToContiguousBuffer(&pDataPacketBuffer);
            
            if (FAILED(hr))
            {
                break;
            }

            //Write buffer to byte stream
            hr = WriteBufferToByteStream(pDataStream, pDataPacketBuffer, NULL);

            if (FAILED(hr))
            {
                break;
            }
        }

        SafeRelease(&pDataPacketBuffer);
        SafeRelease(&pOutputSample);
    }

    SafeRelease(&pOutputSample);
    SafeRelease(&pDataPacketBuffer);
    return hr;
}
```



<span data-ttu-id="b9b85-157">La `WriteBufferToByteStream` fonction est présentée dans la rubrique [**IMFByteStream :: Write**](/windows/desktop/api/mfobjects/nf-mfobjects-imfbytestream-write).</span><span class="sxs-lookup"><span data-stu-id="b9b85-157">The `WriteBufferToByteStream` function is shown in the topic [**IMFByteStream::Write**](/windows/desktop/api/mfobjects/nf-mfobjects-imfbytestream-write).</span></span>

<span data-ttu-id="b9b85-158">Pour voir une application complète qui utilise cet exemple de code, consultez [Didacticiel : copie de flux de fichiers ASF d’un fichier vers un autre](tutorial--copying-asf-streams-from-one-file-to-another.md).</span><span class="sxs-lookup"><span data-stu-id="b9b85-158">To see a complete application that uses this code example, see [Tutorial: Copying ASF Streams from One File to Another](tutorial--copying-asf-streams-from-one-file-to-another.md).</span></span>

## <a name="post-packet-generation-calls"></a><span data-ttu-id="b9b85-159">Appels de Packet-Generation de publication</span><span class="sxs-lookup"><span data-stu-id="b9b85-159">Post Packet-Generation Calls</span></span>

<span data-ttu-id="b9b85-160">Pour vous assurer qu’il n’y a pas de paquets de données complets en attente dans le multiplexeur, appelez [**IMFASFMultiplexer :: Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush).</span><span class="sxs-lookup"><span data-stu-id="b9b85-160">To make sure that there are no complete data packets waiting in the multiplexer, call [**IMFASFMultiplexer::Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush).</span></span> <span data-ttu-id="b9b85-161">Cela force le multiplexeur à empaqueter tous les exemples de supports en cours.</span><span class="sxs-lookup"><span data-stu-id="b9b85-161">This forces the multiplexer to packetize all the media samples that are in progress.</span></span> <span data-ttu-id="b9b85-162">L’application peut collecter ces paquets sous forme d’échantillons de médias via **GetNextPacket** dans une boucle jusqu’à ce qu’il n’y ait plus aucun paquet à récupérer.</span><span class="sxs-lookup"><span data-stu-id="b9b85-162">The application can collect these packets in form of media samples through **GetNextPacket** in a loop until there are no more packets left to be retrieved.</span></span>

<span data-ttu-id="b9b85-163">Une fois tous les exemples de médias générés, appelez [**IMFASFMultiplexer :: end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) pour mettre à jour l’objet d’en-tête ASF associé à ces paquets de données.</span><span class="sxs-lookup"><span data-stu-id="b9b85-163">After all the media samples are generated, call [**IMFASFMultiplexer::End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) to update the ASF Header Object that is associated with these data packets.</span></span> <span data-ttu-id="b9b85-164">L’objet d’en-tête est spécifié en passant l’objet ContentInfo qui a été utilisé pour initialiser le multiplexeur.</span><span class="sxs-lookup"><span data-stu-id="b9b85-164">The Header Object is specified by passing the ContentInfo object that was used to initialize the multiplexer.</span></span> <span data-ttu-id="b9b85-165">Cet appel met à jour différents objets d’en-tête pour refléter les modifications apportées par le multiplexeur pendant la génération des paquets de données.</span><span class="sxs-lookup"><span data-stu-id="b9b85-165">This call updates various Header Objects to reflect changes made by the multiplexer during data packet generation.</span></span> <span data-ttu-id="b9b85-166">Ces informations incluent le nombre de paquets, la durée d’envoi, la durée de lecture et les numéros de flux de tous les flux.</span><span class="sxs-lookup"><span data-stu-id="b9b85-166">This information includes packet count, send duration, play duration, and stream numbers of all the streams.</span></span> <span data-ttu-id="b9b85-167">La taille globale de l’en-tête est également mise à jour.</span><span class="sxs-lookup"><span data-stu-id="b9b85-167">The overall header size is also updated.</span></span>

<span data-ttu-id="b9b85-168">Vous devez vous assurer que [**end**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) est appelé après que tous les paquets de données ont été récupérés.</span><span class="sxs-lookup"><span data-stu-id="b9b85-168">You must ensure that [**End**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-end) is called after all the data packets have been retrieved.</span></span> <span data-ttu-id="b9b85-169">Si des paquets sont en attente dans le multiplexeur, **end** échoue et retourne le code d’erreur **MF \_ E \_ flush \_ requis** .</span><span class="sxs-lookup"><span data-stu-id="b9b85-169">If there are any packets waiting in the multiplexer, **End** will fail and return the **MF\_E\_FLUSH\_NEEDED** error code.</span></span> <span data-ttu-id="b9b85-170">Dans ce cas, récupérez le paquet en attente en appelant [**flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) et [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) dans une boucle.</span><span class="sxs-lookup"><span data-stu-id="b9b85-170">In this case, get the waiting packet by calling [**Flush**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-flush) and [**GetNextPacket**](/windows/desktop/api/wmcontainer/nf-wmcontainer-imfasfmultiplexer-getnextpacket) in a loop.</span></span>

> [!Note]  
> <span data-ttu-id="b9b85-171">Pour l’encodage VBR, après avoir appelé **end**, vous devez définir les statistiques d’encodage dans les propriétés d’encodage de l’objet ContentInfo.</span><span class="sxs-lookup"><span data-stu-id="b9b85-171">For VBR encoding, after calling **End**, you must set the encoding statistics in the ContentInfo object's encoding properties.</span></span> <span data-ttu-id="b9b85-172">Pour plus d’informations sur ce processus, consultez « Configuration de l’objet ContentInfo avec les paramètres de l’encodeur » dans [définition des propriétés dans l’objet ContentInfo](setting-properties-in-the-contentinfo-object.md).</span><span class="sxs-lookup"><span data-stu-id="b9b85-172">For information about this process, see "Configuring the ContentInfo Object with Encoder Settings" in [Setting Properties in the ContentInfo Object](setting-properties-in-the-contentinfo-object.md).</span></span> <span data-ttu-id="b9b85-173">La liste suivante répertorie les propriétés spécifiques à définir :</span><span class="sxs-lookup"><span data-stu-id="b9b85-173">The following list shows the specific properties to set:</span></span>
>
> -   <span data-ttu-id="b9b85-174">[**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md) est la vitesse de transmission moyenne du contenu VBR.</span><span class="sxs-lookup"><span data-stu-id="b9b85-174">[**MFPKEY\_RAVG**](mfpkey-ravgproperty.md) is the average bit rate of the VBR content.</span></span>
> -   <span data-ttu-id="b9b85-175">[**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md) est la fenêtre de mémoire tampon pour la vitesse de transmission moyenne.</span><span class="sxs-lookup"><span data-stu-id="b9b85-175">[**MFPKEY\_BAVG**](mfpkey-bavgproperty.md) is the buffer window for the average bit rate.</span></span>
> -   <span data-ttu-id="b9b85-176">[**MFPKEY \_ RMAX**](mfpkey-rmaxproperty.md) est le taux binaire de pointe du contenu VBR.</span><span class="sxs-lookup"><span data-stu-id="b9b85-176">[**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md) is the peak bit rate of the VBR content.</span></span>
> -   <span data-ttu-id="b9b85-177">[**MFPKEY \_ BMAX**](mfpkey-bmaxproperty.md) est la fenêtre de mémoire tampon de pointe.</span><span class="sxs-lookup"><span data-stu-id="b9b85-177">[**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) is the peak buffer window.</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="b9b85-178">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="b9b85-178">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="b9b85-179">Multiplexeur ASF</span><span class="sxs-lookup"><span data-stu-id="b9b85-179">ASF Multiplexer</span></span>](asf-multiplexer.md)
</dt> <dt>

[<span data-ttu-id="b9b85-180">Didacticiel : copie de flux de fichiers ASF d’un fichier à un autre</span><span class="sxs-lookup"><span data-stu-id="b9b85-180">Tutorial: Copying ASF Streams from One File to Another</span></span>](tutorial--copying-asf-streams-from-one-file-to-another.md)
</dt> <dt>

[<span data-ttu-id="b9b85-181">Didacticiel : écriture d’un fichier WMA à l’aide de l’encodage CBR</span><span class="sxs-lookup"><span data-stu-id="b9b85-181">Tutorial: Writing a WMA File by Using CBR Encoding</span></span>](tutorial--writing-a-wma-file-by-using-cbr-encoding.md)
</dt> </dl>

 

 



