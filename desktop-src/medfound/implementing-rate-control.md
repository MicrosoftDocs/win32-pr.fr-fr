---
description: Cette rubrique décrit comment les objets de pipeline personnalisés peuvent prendre en charge des vitesses de lecture variables, y compris la lecture inversée. Pour plus d’informations sur l’utilisation du contrôle de taux d’une application, consultez la section contrôle de la fréquence.
ms.assetid: 077678db-ca5a-423b-9430-93497113d639
title: Mise en œuvre du contrôle de taux
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f5fd78cbbb95316a0d4ed12a50c9d3aa8954fe8a
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "104034898"
---
# <a name="implementing-rate-control"></a><span data-ttu-id="9745a-104">Mise en œuvre du contrôle de taux</span><span class="sxs-lookup"><span data-stu-id="9745a-104">Implementing Rate Control</span></span>

<span data-ttu-id="9745a-105">Cette rubrique décrit comment les objets de pipeline personnalisés peuvent prendre en charge des vitesses de lecture variables, y compris la lecture inversée.</span><span class="sxs-lookup"><span data-stu-id="9745a-105">This topic describes how custom pipeline objects can support variable playback rates, including reverse playback.</span></span> <span data-ttu-id="9745a-106">Pour plus d’informations sur l’utilisation du contrôle de taux d’une application, consultez la section contrôle de la [fréquence](rate-control.md).</span><span class="sxs-lookup"><span data-stu-id="9745a-106">For information about using rate control from an application, see [Rate Control](rate-control.md).</span></span>

<span data-ttu-id="9745a-107">Cette rubrique contient les sections suivantes :</span><span class="sxs-lookup"><span data-stu-id="9745a-107">This topic contains the following sections:</span></span>

-   [<span data-ttu-id="9745a-108">Sources multimédias</span><span class="sxs-lookup"><span data-stu-id="9745a-108">Media Sources</span></span>](#media-sources)
-   [<span data-ttu-id="9745a-109">Transformations de Media Foundation</span><span class="sxs-lookup"><span data-stu-id="9745a-109">Media Foundation Transforms</span></span>](#media-foundation-transforms)
    -   [<span data-ttu-id="9745a-110">Lecture inversée</span><span class="sxs-lookup"><span data-stu-id="9745a-110">Reverse Playback</span></span>](#reverse-playback)
-   [<span data-ttu-id="9745a-111">Récepteurs de médias</span><span class="sxs-lookup"><span data-stu-id="9745a-111">Media Sinks</span></span>](#media-sinks)
-   [<span data-ttu-id="9745a-112">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="9745a-112">Related topics</span></span>](#related-topics)

<span data-ttu-id="9745a-113">Si vous écrivez un objet de pipeline Microsoft Media Foundation (une source multimédia, une transformation ou un récepteur multimédia), vous devrez peut-être prendre en charge des taux de lecture variables.</span><span class="sxs-lookup"><span data-stu-id="9745a-113">If you are writing a Microsoft Media Foundation pipeline object (a media source, transform, or media sink), you might need to support variable playback rates.</span></span> <span data-ttu-id="9745a-114">Pour ce faire, implémentez les interfaces suivantes :</span><span class="sxs-lookup"><span data-stu-id="9745a-114">To do so, implement the following interfaces:</span></span>

1.  <span data-ttu-id="9745a-115">Implémentez l’interface [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) .</span><span class="sxs-lookup"><span data-stu-id="9745a-115">Implement the [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) interface.</span></span>
2.  <span data-ttu-id="9745a-116">Prendre en charge le service de contrôle de la **\_ Vitesse \_ \_ MF** .</span><span class="sxs-lookup"><span data-stu-id="9745a-116">Support the **MF\_RATE\_CONTROL\_SERVICE** service.</span></span> <span data-ttu-id="9745a-117">(Voir [interfaces de service](service-interfaces.md).)</span><span class="sxs-lookup"><span data-stu-id="9745a-117">(See [Service Interfaces](service-interfaces.md).)</span></span>
3.  <span data-ttu-id="9745a-118">Implémentez l’interface [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) , qui obtient les vitesses de lecture prises en charge par l’objet.</span><span class="sxs-lookup"><span data-stu-id="9745a-118">Implement the [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) interface, which gets the playback rates supported by the object.</span></span>
4.  <span data-ttu-id="9745a-119">Implémentez l’interface [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol) , qui obtient ou définit la vitesse de lecture.</span><span class="sxs-lookup"><span data-stu-id="9745a-119">Implement the [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol) interface, which gets or sets the playback rate.</span></span>

## <a name="media-sources"></a><span data-ttu-id="9745a-120">Sources multimédias</span><span class="sxs-lookup"><span data-stu-id="9745a-120">Media Sources</span></span>

<span data-ttu-id="9745a-121">Si une source de média prend en charge le contrôle de fréquence, elle doit implémenter à la fois [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) et [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol).</span><span class="sxs-lookup"><span data-stu-id="9745a-121">If a media source supports rate control, it should implement both [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) and [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol).</span></span> <span data-ttu-id="9745a-122">Dans le cas contraire, la session multimédia signale que la vitesse de lecture minimale et maximale est 1,0, quels que soient les autres composants du pipeline.</span><span class="sxs-lookup"><span data-stu-id="9745a-122">Otherwise, the Media Session reports that the minimum and maximum playback rate is 1.0, regardless of what other components are in the pipeline.</span></span>

<span data-ttu-id="9745a-123">La vitesse de lecture n’affecte pas les durées de présentation des échantillons, de sorte que la source du média ne doit pas ajuster ses horodatages.</span><span class="sxs-lookup"><span data-stu-id="9745a-123">The playback rate does not affect the presentation times of the samples, so the media source should not adjust its time stamps.</span></span> <span data-ttu-id="9745a-124">Au lieu de cela, l’horloge de la présentation s’exécute à une vitesse plus rapide ou plus lente.</span><span class="sxs-lookup"><span data-stu-id="9745a-124">Instead, the presentation clock runs at a faster or slower speed.</span></span> <span data-ttu-id="9745a-125">Pour la lecture inversée, la source remet les échantillons dans l’ordre inverse, avec des horodateurs réduits.</span><span class="sxs-lookup"><span data-stu-id="9745a-125">For reverse playback, the source delivers samples in reverse order, with decreasing time stamps.</span></span>

<span data-ttu-id="9745a-126">Le paramètre *fThin* de la méthode [**IMFRateControl ::**](/windows/desktop/api/mfidl/nf-mfidl-imfratecontrol-setrate) sesupported indique si la source du média doit *Finer* le contenu.</span><span class="sxs-lookup"><span data-stu-id="9745a-126">The *fThin* parameter of the [**IMFRateControl::SetRate**](/windows/desktop/api/mfidl/nf-mfidl-imfratecontrol-setrate) method indicates whether media source should *thin* the content.</span></span> <span data-ttu-id="9745a-127">L’affinage s’applique principalement aux flux vidéo.</span><span class="sxs-lookup"><span data-stu-id="9745a-127">Thinning applies primarily to video streams.</span></span> <span data-ttu-id="9745a-128">En mode éclairci, la source supprime les images Delta et ne remet que les images clés.</span><span class="sxs-lookup"><span data-stu-id="9745a-128">In thinned mode, the source drops delta frames and deliver only key frames.</span></span> <span data-ttu-id="9745a-129">À des taux de lecture très élevés, la source peut ignorer certaines images clés (par exemple, remettre toutes les autres images clés).</span><span class="sxs-lookup"><span data-stu-id="9745a-129">At very high playback rates, the source might skip some key frames (for example, deliver every other key frame).</span></span>

<span data-ttu-id="9745a-130">La source n’a pas besoin de déposer des échantillons audio en mode éclairci.</span><span class="sxs-lookup"><span data-stu-id="9745a-130">The source does not have to drop audio samples in thinned mode.</span></span> <span data-ttu-id="9745a-131">Toutefois, avec des taux de lecture très élevés, la source peut ne pas être en mesure de lire des données rapides nough pour remplir les exemples de demandes du pipeline.</span><span class="sxs-lookup"><span data-stu-id="9745a-131">At very high playback rates, however, the source might not be able to read data fast nough to fill the pipeline's sample requests.</span></span> <span data-ttu-id="9745a-132">Dans ce cas, il se peut que la source doive supprimer des données audio.</span><span class="sxs-lookup"><span data-stu-id="9745a-132">In that case, the source might need to drop some audio data.</span></span> <span data-ttu-id="9745a-133">Dans ce cas, il doit tenter de remettre des échantillons audio qui sont proches des exemples de vidéos (en supposant que la source a les deux types de flux).</span><span class="sxs-lookup"><span data-stu-id="9745a-133">If so, it should attempt to deliver audio samples that are close in time to the video samples (assuming that the source has both types of stream).</span></span>

<span data-ttu-id="9745a-134">Lorsqu’un flux passe du mode éclairci et non dilué, il envoie un événement [MEStreamThinMode](mestreamthinmode.md) .</span><span class="sxs-lookup"><span data-stu-id="9745a-134">When a stream transitions between thinned and non-thinned mode, it sends an [MEStreamThinMode](mestreamthinmode.md) event.</span></span>

<span data-ttu-id="9745a-135">Lorsque la source du média termine un appel [**à**](/windows/desktop/api/mfidl/nf-mfidl-imfratecontrol-setrate)sesupport, elle envoie l’événement [MESourceRateChanged](mesourceratechanged.md) .</span><span class="sxs-lookup"><span data-stu-id="9745a-135">When the media source completes a call to [**SetRate**](/windows/desktop/api/mfidl/nf-mfidl-imfratecontrol-setrate), it sends the [MESourceRateChanged](mesourceratechanged.md) event.</span></span>

<span data-ttu-id="9745a-136">Pendant la lecture inversée :</span><span class="sxs-lookup"><span data-stu-id="9745a-136">During reverse playback:</span></span>

-   <span data-ttu-id="9745a-137">La source du média fournit des échantillons dans l’ordre inverse, sans ajuster les horodatages.</span><span class="sxs-lookup"><span data-stu-id="9745a-137">The media source delivers samples in reverse order, without adjusting the time stamps.</span></span>
-   <span data-ttu-id="9745a-138">Les horodatages dans un flux doivent diminuer de façon monotone.</span><span class="sxs-lookup"><span data-stu-id="9745a-138">Time stamps within a stream should monotonically decrease.</span></span>
-   <span data-ttu-id="9745a-139">Le début du contenu est considéré comme la fin du flux.</span><span class="sxs-lookup"><span data-stu-id="9745a-139">The beginning of the content is considered the end of the stream.</span></span> <span data-ttu-id="9745a-140">Une fois que chaque flux multimédia remet le premier échantillon dans le flux (autrement dit, l’heure de la présentation = 0), il envoie l’événement [MEEndOfStream](meendofstream.md) .</span><span class="sxs-lookup"><span data-stu-id="9745a-140">After each media stream delivers the first sample in the stream (that is, presentation time = 0), it sends the [MEEndOfStream](meendofstream.md) event.</span></span>

## <a name="media-foundation-transforms"></a><span data-ttu-id="9745a-141">Transformations de Media Foundation</span><span class="sxs-lookup"><span data-stu-id="9745a-141">Media Foundation Transforms</span></span>

<span data-ttu-id="9745a-142">En général, une Media Foundation Transform (MFT) n’a pas besoin d’une prise en charge explicite du contrôle de la fréquence, sauf si la table MFT implémente une lecture inversée non fine.</span><span class="sxs-lookup"><span data-stu-id="9745a-142">In general, a Media Foundation transform (MFT) does not need explicit support for rate control, unless the MFT implements non-thinned reverse playback.</span></span>

<span data-ttu-id="9745a-143">Si une MFT n’implémente pas l’interface [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) , la session multimédia suppose les points suivants :</span><span class="sxs-lookup"><span data-stu-id="9745a-143">If an MFT does not implement the [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) interface, the Media Session assumes the following:</span></span>

-   <span data-ttu-id="9745a-144">La table MFT prend en charge les vitesses de lecture arbitraire pour la lecture en avant, à la fois fine et non fine.</span><span class="sxs-lookup"><span data-stu-id="9745a-144">The MFT supports arbitary playback rates for forward playback, both thinned and non-thinned.</span></span>
-   <span data-ttu-id="9745a-145">La table MFT prend en charge la lecture inverse fine, mais ne prend pas en charge la lecture inversée non fine.</span><span class="sxs-lookup"><span data-stu-id="9745a-145">The MFT supports thinned reverse playback, but does not support non-thinned reverse playback.</span></span>

<span data-ttu-id="9745a-146">Si l’une de ces conditions n’est pas remplie, la table MFT doit implémenter [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) et [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol).</span><span class="sxs-lookup"><span data-stu-id="9745a-146">If either of these conditions is not true, the MFT should implement [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) and [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol).</span></span>

### <a name="reverse-playback"></a><span data-ttu-id="9745a-147">Lecture inversée</span><span class="sxs-lookup"><span data-stu-id="9745a-147">Reverse Playback</span></span>

<span data-ttu-id="9745a-148">La session multimédia peut être lue en sens inverse même si une ou plusieurs transformations du pipeline ne prennent pas en charge explicitement la lecture inversée.</span><span class="sxs-lookup"><span data-stu-id="9745a-148">The Media Session can play in reverse even if one or more transforms in the pipeline do not explicitly support reverse playback.</span></span>

<span data-ttu-id="9745a-149">Si une MFT n’expose pas l’interface [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) , la session multimédia *utilise l'* affinage pour la lecture inversée, comme suit :</span><span class="sxs-lookup"><span data-stu-id="9745a-149">If an MFT does not expose the [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) interface, the Media Session uses *thinning* for reverse playback, as follows:</span></span>

-   <span data-ttu-id="9745a-150">La session multimédia envoie les images clés à la MFT de la manière habituelle, en appelant [**IMFTransform ::P rocessinput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput).</span><span class="sxs-lookup"><span data-stu-id="9745a-150">The Media Session sends key frames to the MFT in the usual way, by calling [**IMFTransform::ProcessInput**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-processinput).</span></span>

-   <span data-ttu-id="9745a-151">La session multimédia supprime les images Delta et les remplace par les événements [MEStreamTick](mestreamtick.md) .</span><span class="sxs-lookup"><span data-stu-id="9745a-151">The Media Session drops delta frames and replaces them with [MEStreamTick](mestreamtick.md) events.</span></span>

-   <span data-ttu-id="9745a-152">Entre chaque exemple, la session de média vide la MFT, afin d’éviter toute erreur provoquée par le fait que les horodatages diminuent.</span><span class="sxs-lookup"><span data-stu-id="9745a-152">Between each sample, the Media Session flushes the MFT, to avoid any errors caused by the fact that the time stamps are decreasing.</span></span>

<span data-ttu-id="9745a-153">Un exemple est considéré comme une image clé si l’attribut [MFSampleExtension \_ CleanPoint](mfsampleextension-cleanpoint-attribute.md) est défini sur **true**, et est considéré comme un frame Delta si cet attribut a la valeur **false** ou n’est pas défini.</span><span class="sxs-lookup"><span data-stu-id="9745a-153">A sample is considered a key frame if it has the [MFSampleExtension\_CleanPoint](mfsampleextension-cleanpoint-attribute.md) attribute set to **TRUE**, and is considered a delta frame if this attribute is **FALSE** or not set.</span></span>

<span data-ttu-id="9745a-154">Si la table MFT implémente [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport), la session multimédia utilise cette interface pour déterminer si la table MFT prend en charge la lecture inversée non fine.</span><span class="sxs-lookup"><span data-stu-id="9745a-154">If the MFT implements [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport), the Media Session uses this interface to discover whether the MFT supports non-thinned reverse playback.</span></span> <span data-ttu-id="9745a-155">Si la MFT prend en charge la lecture inversée non fine, la session multimédia remet tous les exemples, dans l’ordre inverse, sans supprimer les échantillons ni vider la MFT.</span><span class="sxs-lookup"><span data-stu-id="9745a-155">If the MFT supports non-thinned reverse playback, the Media Session delivers all of the samples, in reverse order, without dropping samples or flushing the MFT.</span></span>

<span data-ttu-id="9745a-156">Si une table MFT prend en charge la lecture inversée non fine, elle doit implémenter l’interface [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol) .</span><span class="sxs-lookup"><span data-stu-id="9745a-156">If an MFT supports non-thinned reverse playback, it should implement the [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol) interface.</span></span> <span data-ttu-id="9745a-157">La session multimédia utilise cette interface pour notifier la table MFT en cas de lecture inversée.</span><span class="sxs-lookup"><span data-stu-id="9745a-157">The Media Session will use this interface to notify the MFT when reverse playback occurs.</span></span> <span data-ttu-id="9745a-158">À ce stade, la MFT doit être préparée pour que les horodatages diminuent et que les images Delta arrivent dans l’ordre inverse.</span><span class="sxs-lookup"><span data-stu-id="9745a-158">At that point, the MFT must be prepared for the time stamps to decrease and for delta frames to arrive in reverse order.</span></span> <span data-ttu-id="9745a-159">Un décodeur doit généralement mettre en mémoire tampon des échantillons jusqu’à ce qu’il ait reçu un groupe entier d’images, puis décoder l’ensemble du groupe d’images et sortir les images décodées dans l’ordre (inverse) correct.</span><span class="sxs-lookup"><span data-stu-id="9745a-159">A decoder will typically need to buffer samples until it has received an entire group of pictures (GOP), then decode the entire GOP and output the decoded frames in the correct (reverse) order.</span></span>

## <a name="media-sinks"></a><span data-ttu-id="9745a-160">Récepteurs de médias</span><span class="sxs-lookup"><span data-stu-id="9745a-160">Media Sinks</span></span>

<span data-ttu-id="9745a-161">Si un récepteur multimédia est sans *débit*, la session de média suppose que le récepteur multimédia peut gérer n’importe quel taux de lecture.</span><span class="sxs-lookup"><span data-stu-id="9745a-161">If a media sink is *rateless*, the Media Session assumes that media sink can handle any playback rate.</span></span> <span data-ttu-id="9745a-162">Le récepteur multimédia n’a pas besoin d’implémenter [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport).</span><span class="sxs-lookup"><span data-stu-id="9745a-162">The media sink does not need to implement [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport).</span></span> <span data-ttu-id="9745a-163">(Un récepteur multimédia à débit retourne le MEDIASINK \_ Indicateur de débit à partir de la méthode [**IMFMediaSink :: GetCharacteristics**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasink-getcharacteristics) .)</span><span class="sxs-lookup"><span data-stu-id="9745a-163">(A rateless media sink returns the MEDIASINK\_RATELESS flag from the [**IMFMediaSink::GetCharacteristics**](/windows/desktop/api/mfidl/nf-mfidl-imfmediasink-getcharacteristics) method.)</span></span>

<span data-ttu-id="9745a-164">Dans le cas contraire, un récepteur multimédia doit implémenter [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) s’il peut gérer des vitesses de lecture autres que 1,0.</span><span class="sxs-lookup"><span data-stu-id="9745a-164">Otherwise, a media sink should implement [**IMFRateSupport**](/windows/desktop/api/mfidl/nn-mfidl-imfratesupport) if it can handle playback rates other than 1.0.</span></span>

<span data-ttu-id="9745a-165">Les récepteurs multimédias ne doivent pas implémenter [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol).</span><span class="sxs-lookup"><span data-stu-id="9745a-165">Media sinks should not implement [**IMFRateControl**](/windows/desktop/api/mfidl/nn-mfidl-imfratecontrol).</span></span> <span data-ttu-id="9745a-166">Lorsque la vitesse de lecture change, l’horloge de la présentation appelle la méthode [**IMFClockStateSink :: OnClockSetRate**](/windows/desktop/api/mfidl/nf-mfidl-imfclockstatesink-onclocksetrate) du récepteur multimédia.</span><span class="sxs-lookup"><span data-stu-id="9745a-166">When the playback rate changes, the presentation clock calls the media sink's [**IMFClockStateSink::OnClockSetRate**](/windows/desktop/api/mfidl/nf-mfidl-imfclockstatesink-onclocksetrate) method.</span></span>

## <a name="related-topics"></a><span data-ttu-id="9745a-167">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="9745a-167">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="9745a-168">Contrôle de la fréquence</span><span class="sxs-lookup"><span data-stu-id="9745a-168">Rate Control</span></span>](rate-control.md)
</dt> <dt>

[<span data-ttu-id="9745a-169">Recherche, avance rapide et lecture inversée</span><span class="sxs-lookup"><span data-stu-id="9745a-169">Seeking, Fast Forward, and Reverse Play</span></span>](seeking--fast-forward--and-reverse-play.md)
</dt> </dl>

 

 



