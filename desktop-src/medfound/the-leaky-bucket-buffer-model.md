---
description: Le &\# 0034 ; compartiment à fuite&\# 0034 ; le modèle est un moyen de modéliser les exigences de mise en mémoire tampon pour une lecture fluide.
ms.assetid: 2f7f80d6-3abb-462f-a571-b223a1d59da6
title: Modèle de mémoire tampon de compartiment avec fuite (Microsoft Media Foundation)
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0f5a99932fb121808f6a49323360c47c09d0acbb
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/05/2021
ms.locfileid: "106520246"
---
# <a name="the-leaky-bucket-buffer-model-microsoft-media-foundation"></a><span data-ttu-id="5d687-103">Modèle de mémoire tampon de compartiment avec fuite (Microsoft Media Foundation)</span><span class="sxs-lookup"><span data-stu-id="5d687-103">The Leaky Bucket Buffer Model (Microsoft Media Foundation)</span></span>

<span data-ttu-id="5d687-104">Lorsque vous diffusez du contenu multimédia sur un réseau, le décodeur reçoit des données encodées à un taux théoriquement constant (vitesse de transmission).</span><span class="sxs-lookup"><span data-stu-id="5d687-104">When you stream media over a network, the decoder receives encoded data at a theoretically constant rate (the transmission rate).</span></span> <span data-ttu-id="5d687-105">Le décodeur utilise ces données pour produire une sortie décodée.</span><span class="sxs-lookup"><span data-stu-id="5d687-105">The decoder consumes this data to produce decoded output.</span></span> <span data-ttu-id="5d687-106">Toutefois, dans le cas général, le décodeur consomme les données à une vitesse *variable* , car l’encodeur peut utiliser un taux d’encodage variable.</span><span class="sxs-lookup"><span data-stu-id="5d687-106">In the general case, however, the decoder consumes the data at a *variable* rate, because then encoder can use a variable encoding rate.</span></span>

<span data-ttu-id="5d687-107">Le modèle « compartiment perdu » est un moyen de modéliser les exigences de mise en mémoire tampon pour une lecture en douceur.</span><span class="sxs-lookup"><span data-stu-id="5d687-107">The "leaky bucket" model is a way to model the buffering requirements for smooth playback.</span></span> <span data-ttu-id="5d687-108">Dans ce modèle, le décodeur gère une mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="5d687-108">In this model, the decoder maintains a buffer.</span></span> <span data-ttu-id="5d687-109">Les données encodées passent du réseau dans la mémoire tampon et de la mémoire tampon dans le décodeur.</span><span class="sxs-lookup"><span data-stu-id="5d687-109">Encoded data goes from the network into the buffer, and from the buffer into the decoder.</span></span> <span data-ttu-id="5d687-110">Si la mémoire tampon est dépassée, cela signifie que le décodeur supprime les données de la mémoire tampon plus rapidement que le réseau ne les fournit.</span><span class="sxs-lookup"><span data-stu-id="5d687-110">If the buffer underflows, it means the decoder is removing data from the buffer faster than the network is delivering it.</span></span> <span data-ttu-id="5d687-111">En cas de dépassement de la mémoire tampon, cela signifie que le réseau fournit des données plus rapidement que le décodeur ne l’utilise.</span><span class="sxs-lookup"><span data-stu-id="5d687-111">If the buffer overflows, it means the network is delivering data faster than the decoder consumes it.</span></span>

<span data-ttu-id="5d687-112">Cette rubrique décrit le modèle de « compartiment perdu » de mémoires tampons pour l’encodage et le décodage.</span><span class="sxs-lookup"><span data-stu-id="5d687-112">This topic describes the "leaky bucket" model of buffers for encoding and decoding.</span></span>

-   [<span data-ttu-id="5d687-113">Le compartiment avec fuite</span><span class="sxs-lookup"><span data-stu-id="5d687-113">The Leaky Bucket</span></span>](#the-leaky-bucket)
-   [<span data-ttu-id="5d687-114">Le compartiment en cours d’utilisation</span><span class="sxs-lookup"><span data-stu-id="5d687-114">The Bucket in Use</span></span>](#the-bucket-in-use)
-   [<span data-ttu-id="5d687-115">Définition des valeurs de compartiment fuites pour les flux ASF</span><span class="sxs-lookup"><span data-stu-id="5d687-115">Setting Leaky Bucket Values for ASF Streams</span></span>](#setting-leaky-bucket-values-for-asf-streams)
-   [<span data-ttu-id="5d687-116">Valeurs de compartiment avec fuite dans le multiplexeur ASF</span><span class="sxs-lookup"><span data-stu-id="5d687-116">Leaky Bucket Values in the ASF Multiplexer</span></span>](#leaky-bucket-values-in-the-asf-multiplexer)
-   [<span data-ttu-id="5d687-117">Mise à jour des valeurs de compartiment avec fuite dans le récepteur de média ASF</span><span class="sxs-lookup"><span data-stu-id="5d687-117">Updating Leaky Bucket Values in the ASF Media Sink</span></span>](#updating-leaky-bucket-values-in-the-asf-media-sink)
-   [<span data-ttu-id="5d687-118">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="5d687-118">Related topics</span></span>](#related-topics)

## <a name="the-leaky-bucket"></a><span data-ttu-id="5d687-119">Le compartiment avec fuite</span><span class="sxs-lookup"><span data-stu-id="5d687-119">The Leaky Bucket</span></span>

<span data-ttu-id="5d687-120">Pour comprendre le modèle de compartiments avec fuite, envisagez un compartiment avec un petit trou en bas.</span><span class="sxs-lookup"><span data-stu-id="5d687-120">To understand the leaky bucket model, consider a bucket with a small hole at the bottom.</span></span> <span data-ttu-id="5d687-121">Trois paramètres définissent le compartiment :</span><span class="sxs-lookup"><span data-stu-id="5d687-121">Three parameters define the bucket:</span></span>

-   <span data-ttu-id="5d687-122">La capacité (B)</span><span class="sxs-lookup"><span data-stu-id="5d687-122">The capacity (B)</span></span>
-   <span data-ttu-id="5d687-123">Vitesse à laquelle le flux d’eau sort du compartiment (R)</span><span class="sxs-lookup"><span data-stu-id="5d687-123">The rate at which water flows out of the bucket (R)</span></span>
-   <span data-ttu-id="5d687-124">Remplissage initial du compartiment (F)</span><span class="sxs-lookup"><span data-stu-id="5d687-124">The initial fullness of the bucket (F)</span></span>

<span data-ttu-id="5d687-125">Dans cette métaphore, le compartiment est le tampon :</span><span class="sxs-lookup"><span data-stu-id="5d687-125">In this metaphor, the bucket is the buffer:</span></span>

![Illustration montrant une mémoire tampon en tant que compartiment, taux d’entrée pour l’entrée d’eau dans le compartiment et vitesse de sortie en tant qu’eau quittant un trou dans le compartiment](images/asf-components03.png)

<span data-ttu-id="5d687-127">Si l’eau est dans le compartiment au taux exact *R*, le compartiment restera à F, car le taux d’entrée est égal au taux de sortie.</span><span class="sxs-lookup"><span data-stu-id="5d687-127">If water is poured into the bucket at exactly rate *R*, the bucket will remain at F, because the input rate equals the output rate.</span></span> <span data-ttu-id="5d687-128">Si la vitesse d’entrée augmente alors que *R* reste constant, le compartiment accumule de l’eau.</span><span class="sxs-lookup"><span data-stu-id="5d687-128">If the input rate increases while *R* remains constant, the bucket accumulates water.</span></span> <span data-ttu-id="5d687-129">Si la vitesse d’entrée est supérieure à *R* pendant une période prolongée, le compartiment finit par dépasser.</span><span class="sxs-lookup"><span data-stu-id="5d687-129">If the input rate is larger than *R* for a sustained period, eventually the bucket overflows.</span></span> <span data-ttu-id="5d687-130">Toutefois, le taux d’entrée peut varier de *R* sans déborder le compartiment, tant que la vitesse d’entrée moyenne ne dépasse pas la capacité du compartiment.</span><span class="sxs-lookup"><span data-stu-id="5d687-130">However, the input rate can vary around *R* without overflowing the bucket, as long as the average input rate does not exceed the capacity of the bucket.</span></span> <span data-ttu-id="5d687-131">Plus la capacité est grande, plus le taux d’entrée peut varier dans une fenêtre de temps donnée.</span><span class="sxs-lookup"><span data-stu-id="5d687-131">The larger the capacity, the more the input rate can vary within a given window of time.</span></span>

<span data-ttu-id="5d687-132">En ASF, le compartiment avec fuite est défini par trois paramètres :</span><span class="sxs-lookup"><span data-stu-id="5d687-132">In ASF, the leaky bucket is defined by three parameters:</span></span>

-   <span data-ttu-id="5d687-133">Vitesse de transmission moyenne, en octets par seconde, qui correspond au taux de sortie (*R*)</span><span class="sxs-lookup"><span data-stu-id="5d687-133">The average bit rate, in bytes per second, which corresponds to the output rate (*R*)</span></span>
-   <span data-ttu-id="5d687-134">Fenêtre de mémoire tampon, mesurée en millisecondes, qui correspond à la capacité de compartiment (*B*).</span><span class="sxs-lookup"><span data-stu-id="5d687-134">The buffer window, measured in milliseconds, which corresponds to the bucket capacity (*B*).</span></span>
-   <span data-ttu-id="5d687-135">La saturation de la mémoire tampon initiale, qui est généralement définie à zéro.</span><span class="sxs-lookup"><span data-stu-id="5d687-135">The initial buffer fullness, which is generally set to zero.</span></span>

<span data-ttu-id="5d687-136">La vitesse de transmission mesure le nombre moyen de bits par seconde dans le flux encodé.</span><span class="sxs-lookup"><span data-stu-id="5d687-136">The bit rate measures the average number of bits per second in the encoded stream.</span></span> <span data-ttu-id="5d687-137">La fenêtre de mémoire tampon mesure le nombre de millisecondes de données à la vitesse de transmission qui peut tenir dans la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="5d687-137">The buffer window measures the number of milliseconds of data at that bit rate that can fit in the buffer.</span></span> <span data-ttu-id="5d687-138">La taille de la mémoire tampon en bits est égale à R \* (B/1000).</span><span class="sxs-lookup"><span data-stu-id="5d687-138">The size of the buffer in bits is equal to R \* (B / 1000).</span></span>

<span data-ttu-id="5d687-139">Les données de charge utile ASF peuvent entrer dans le compartiment présentant des fuites à des moments irréguliers et en quantités irrégulières, mais doivent laisser le compartiment à une vitesse de transmission positive constante.</span><span class="sxs-lookup"><span data-stu-id="5d687-139">ASF payload data may enter the leaky bucket at irregular times and in irregular amounts, but must leave the bucket at a constant positive bit rate.</span></span> <span data-ttu-id="5d687-140">En raison de la fenêtre de mémoire tampon, il existe un délai entre le moment où la charge utile entre dans le compartiment et le moment où elle sort.</span><span class="sxs-lookup"><span data-stu-id="5d687-140">Because of the buffer window, there is a possible delay between the time that payload enters the bucket and when it leaves.</span></span> <span data-ttu-id="5d687-141">Le délai maximal qui peut se produire est de *B* / *R*.</span><span class="sxs-lookup"><span data-stu-id="5d687-141">The maximum delay that can occur is *B*/*R*.</span></span> <span data-ttu-id="5d687-142">Les données de charge utile qui entrent dans le compartiment sont en fonction de l’heure de présentation et ne doivent jamais dépasser le compartiment.</span><span class="sxs-lookup"><span data-stu-id="5d687-142">The payload data that enters into the bucket is according to the presentation time and must never overflow the bucket.</span></span> <span data-ttu-id="5d687-143">Outre l’heure de la présentation, chaque charge utile a également un temps d’envoi, c’est-à-dire l’heure à laquelle les données de la charge utile quittent le compartiment en fonction de la vitesse de transmission.</span><span class="sxs-lookup"><span data-stu-id="5d687-143">In addition to the presentation time, each payload also has a send time—the time at which the payload data leaves the bucket according to the bit rate.</span></span> <span data-ttu-id="5d687-144">L’heure d’envoi doit être antérieure à l’heure de la présentation pour garantir que, lorsque le compartiment de fuite est proche de plein, chaque charge utile quitte le compartiment avant ou pendant sa présentation.</span><span class="sxs-lookup"><span data-stu-id="5d687-144">Send time must be earlier than the presentation time to ensure that, when the leaky bucket gets close to being full, every payload leaves the bucket before or at its presentation time.</span></span> <span data-ttu-id="5d687-145">Pour ce faire, les durées de présentation sont décalées par rapport à la valeur *B* / *R* (le *préroll*) et les heures d’envoi commencent à zéro.</span><span class="sxs-lookup"><span data-stu-id="5d687-145">To accomplish this, the presentation times are shifted ahead by the *B*/*R* value (the *preroll*), and the send times get a head start starting at zero.</span></span> <span data-ttu-id="5d687-146">L’heure d’envoi ne doit pas être postérieure à l’heure de la présentation, car cela indiquerait que la charge utile entrée dans le compartiment est trop tardive et ne peut pas être incluse dans l’objet de données.</span><span class="sxs-lookup"><span data-stu-id="5d687-146">The send time must be no later than the presentation time because that would indicate that the payload entered the bucket too late and cannot be included in the data object.</span></span> <span data-ttu-id="5d687-147">La valeur du préroll est incluse dans l' [objet d’en-tête ASF](asf-file-structure.md) .</span><span class="sxs-lookup"><span data-stu-id="5d687-147">The preroll value is included in the [ASF Header Object](asf-file-structure.md) .</span></span>

<span data-ttu-id="5d687-148">Pour la diffusion en continu sans problème sur le réseau, les flux compressés dans le contenu du média doivent conserver une vitesse de transmission constante pendant toute la durée de la lecture.</span><span class="sxs-lookup"><span data-stu-id="5d687-148">For glitch-free streaming over the network, compressed streams within the media content must maintain a constant bit rate throughout the playback duration.</span></span> <span data-ttu-id="5d687-149">Le modèle de compartiment présentant des fuites ASF garantit que les données multimédias sont envoyées sur le réseau à une vitesse de transmission constante.</span><span class="sxs-lookup"><span data-stu-id="5d687-149">The ASF leaky bucket model ensures that media data is sent across the network at a constant bit rate.</span></span> <span data-ttu-id="5d687-150">Les paramètres du compartiment avec fuite sont spécifiés dans l’objet de propriétés de flux étendu de l' [objet d’en-tête ASF](asf-file-structure.md).</span><span class="sxs-lookup"><span data-stu-id="5d687-150">The parameters of the leaky bucket are specified in the Extended Stream Properties Object of the [ASF Header Object](asf-file-structure.md).</span></span> <span data-ttu-id="5d687-151">Dans Microsoft Media Foundation, ils sont définis en tant qu’attributs sur le type de média qui représente le flux.</span><span class="sxs-lookup"><span data-stu-id="5d687-151">In Microsoft Media Foundation, they are set as attributes on the media type that represents the stream.</span></span>

<span data-ttu-id="5d687-152">Les valeurs des compartiments de fuites sont définies dans le récepteur de fichiers ASF et l’objet multiplexeur ASF sous-jacent, et l’encodeur Windows Media.</span><span class="sxs-lookup"><span data-stu-id="5d687-152">The leaky bucket values are defined both in the ASF file sink and the underlying ASF multiplexer object, and the Windows Media encoder.</span></span> <span data-ttu-id="5d687-153">Ces valeurs peuvent être identiques ou différentes.</span><span class="sxs-lookup"><span data-stu-id="5d687-153">These values could be same or different.</span></span> <span data-ttu-id="5d687-154">Prenons l’exemple d’un scénario de diffusion en continu, qui requiert la livraison des échantillons audio plus tard que les exemples de vidéos afin que le fichier puisse être diffusé en continu sans latence.</span><span class="sxs-lookup"><span data-stu-id="5d687-154">For example, consider a streaming scenario, which requires the audio samples to be delivered later than the video samples so that the file can be streamed without latency.</span></span> <span data-ttu-id="5d687-155">Pour ce faire, le compartiment fuite du flux audio dans le récepteur multimédia peut être défini sur une valeur supérieure à la valeur définie dans l’encodeur audio Windows Media.</span><span class="sxs-lookup"><span data-stu-id="5d687-155">To achieve this, the audio stream's leaky bucket in the media sink can be set to a value higher than the value set in the Windows Media audio encoder.</span></span>

<span data-ttu-id="5d687-156">Pour définir des valeurs B/R dans l’encodeur, l’application doit définir les propriétés [**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md), [**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md), [**MFPKEY \_ Rmax**](mfpkey-rmaxproperty.md)et [**MFPKEY BMAX. \_**](mfpkey-bmaxproperty.md)</span><span class="sxs-lookup"><span data-stu-id="5d687-156">To set B/R values in the encoder, the application must set the [**MFPKEY\_RAVG**](mfpkey-ravgproperty.md), [**MFPKEY\_BAVG**](mfpkey-bavgproperty.md), [**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md), and [**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) properties.</span></span> <span data-ttu-id="5d687-157">Pour plus d’informations sur la définition des propriétés dans l’encodeur, consultez [Propriétés de codage](configuring-the-encoder.md).</span><span class="sxs-lookup"><span data-stu-id="5d687-157">For information about setting properties in the encoder, see [Encoding Properties](configuring-the-encoder.md).</span></span>

## <a name="the-bucket-in-use"></a><span data-ttu-id="5d687-158">Le compartiment en cours d’utilisation</span><span class="sxs-lookup"><span data-stu-id="5d687-158">The Bucket in Use</span></span>

<span data-ttu-id="5d687-159">L’objectif d’un encodeur est de s’assurer que le contenu ne dépasse jamais la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="5d687-159">The goal of an encoder is to ensure that the content never overflows the buffer.</span></span> <span data-ttu-id="5d687-160">L’encodeur utilise les valeurs de la vitesse de transmission et de la fenêtre de mémoire tampon comme guides.</span><span class="sxs-lookup"><span data-stu-id="5d687-160">The encoder uses the bit rate and buffer window values as guides.</span></span> <span data-ttu-id="5d687-161">Le nombre réel de bits transmis sur une période de temps égale à la fenêtre de mémoire tampon ne peut jamais être supérieur à deux fois la taille de la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="5d687-161">The actual number of bits passed over any period of time equal to the buffer window can never be greater than twice the size of the buffer.</span></span>

<span data-ttu-id="5d687-162">Prenons l’exemple suivant : vous avez un compartiment à 3 litres avec un trou dans lequel 1 litre peut circuler par minute.</span><span class="sxs-lookup"><span data-stu-id="5d687-162">Consider the following example: You have a 3-gallon bucket with a hole in it through which 1 gallon can flow per minute.</span></span> <span data-ttu-id="5d687-163">Vous placez le compartiment sous un emboîtement et ouvrez la vanne pour laisser l’eau à un taux de 1 gallon par minute.</span><span class="sxs-lookup"><span data-stu-id="5d687-163">You put the bucket under a spigot and open the valve to let out water at a rate of 1 gallon per minute.</span></span> <span data-ttu-id="5d687-164">L’eau sort du compartiment aussi rapidement qu’elle entre, sans aucun supplément dans le compartiment.</span><span class="sxs-lookup"><span data-stu-id="5d687-164">The water flows out of the bucket as quickly as it enters, leaving no extra in the bucket.</span></span> <span data-ttu-id="5d687-165">Vous augmentez ensuite le passage de l’emboîtement à 2 litres par minute.</span><span class="sxs-lookup"><span data-stu-id="5d687-165">Then you increase the flow from the spigot to 2 gallons per minute.</span></span> <span data-ttu-id="5d687-166">Chaque minute, le flux de l’eau atteint ce débit, 2 gallons entrent dans le compartiment et 1 litre de fuites, laissant 1 litre dans le compartiment.</span><span class="sxs-lookup"><span data-stu-id="5d687-166">Each minute that the water flows at this rate, 2 gallons go into the bucket and 1 gallon leaks out, leaving 1 gallon in the bucket.</span></span> <span data-ttu-id="5d687-167">À la fin de 3 minutes, 6 gallons d’eau sont allés dans le compartiment, 3 gallons ont disparu et le compartiment est plein.</span><span class="sxs-lookup"><span data-stu-id="5d687-167">At the end of 3 minutes, 6 gallons of water have gone into the bucket, 3 gallons have leaked out, and the bucket is full.</span></span>

<span data-ttu-id="5d687-168">Dans la pratique, le débit de données maximal théorique sur un intervalle égal à la fenêtre de mémoire tampon n’est jamais atteint.</span><span class="sxs-lookup"><span data-stu-id="5d687-168">In practice, the theoretical maximum data rate over an interval equal to the buffer window is never achieved.</span></span> <span data-ttu-id="5d687-169">L’exemple précédent supposait une vitesse de données constante.</span><span class="sxs-lookup"><span data-stu-id="5d687-169">The previous example assumed a constant data rate.</span></span> <span data-ttu-id="5d687-170">À partir du même compartiment de 3 litres, vous pouvez augmenter le débit de l’emboîtement à 6 litres par minute pendant une minute, puis désactiver l’emboîtement pendant deux minutes.</span><span class="sxs-lookup"><span data-stu-id="5d687-170">Given the same 3-gallon bucket, you could increase the flow rate from the spigot to 6 gallons per minute for one minute and then turn the spigot off for two minutes.</span></span> <span data-ttu-id="5d687-171">Même si la quantité totale d’eau placée dans le compartiment est comprise dans la valeur théorique maximale de la fenêtre tampon, la concentration de cette valeur dans une partie de la fenêtre provoque un dépassement de capacité du compartiment.</span><span class="sxs-lookup"><span data-stu-id="5d687-171">Even though the total amount of water put into the bucket is within the theoretical maximum for the buffer window, the concentration of that amount into one part of the window causes the bucket to overflow.</span></span> <span data-ttu-id="5d687-172">À 6 litres par minute, le compartiment à 3 litres déborde peu de temps après 30 secondes.</span><span class="sxs-lookup"><span data-stu-id="5d687-172">At 6 gallons per minute, the 3-gallon bucket overflows shortly after 30 seconds pass.</span></span> <span data-ttu-id="5d687-173">Par conséquent, la quantité maximale réelle de données qui peut être remise à la mémoire tampon sur la durée d’un intervalle égal au paramètre de la fenêtre tampon dépend de la taille des échantillons individuels et de la date de livraison.</span><span class="sxs-lookup"><span data-stu-id="5d687-173">Therefore, the actual maximum amount of data that can be delivered to the buffer over the duration of any interval equal to the buffer window setting depends upon the size of individual samples and when they are delivered.</span></span>

<span data-ttu-id="5d687-174">Jusqu’à présent, les exemples ont uniquement abordé la mémoire tampon utilisée par le décodeur, mais une mémoire tampon de compartiment perdue est également utilisée par l’encodeur qui crée le contenu compressé.</span><span class="sxs-lookup"><span data-stu-id="5d687-174">So far the examples have only discussed the buffer used by the decoder, but a leaky bucket buffer is also used by the encoder which creates the compressed content.</span></span> <span data-ttu-id="5d687-175">L’encodeur effectue les ajustements nécessaires aux algorithmes de compression pour conserver la vitesse de transmission des échantillons compressés dans les limites décrites par la fenêtre de mémoire tampon et la vitesse de transmission, en supposant que les exemples seront remis au décodeur à une vitesse constante.</span><span class="sxs-lookup"><span data-stu-id="5d687-175">The encoder makes whatever adjustments are necessary to the compression algorithms to keep the bit rate of the compressed samples within the boundaries described by the bit rate and buffer window, assuming that the samples will be delivered to the decoder at a constant rate.</span></span> <span data-ttu-id="5d687-176">Vous pouvez considérer le compartiment d’encodeur comme une mise en miroir du compartiment décodeur.</span><span class="sxs-lookup"><span data-stu-id="5d687-176">You can think of the encoder bucket as mirroring the decoder bucket.</span></span> <span data-ttu-id="5d687-177">Le compartiment de l’encodeur est rempli à un débit variable déterminé par la taille des échantillons individuels et des fuites à une vitesse constante égale à la vitesse de transmission moyenne.</span><span class="sxs-lookup"><span data-stu-id="5d687-177">The encoder bucket is filled at a variable rate determined by the size of the individual samples and leaks at a constant rate equal to the average bit rate.</span></span>

<span data-ttu-id="5d687-178">Prenons l’exemple suivant d’un encodeur et d’un décodeur connectés ensemble sur un réseau.</span><span class="sxs-lookup"><span data-stu-id="5d687-178">Consider the following example of an encoder and decoder connected together over a network.</span></span> <span data-ttu-id="5d687-179">Vous encodez un fichier vidéo à 30 images par seconde avec une vitesse de transmission de 6 000 bits par seconde et une fenêtre tampon de 3 secondes (taille totale de la mémoire tampon de 18 000 bits).</span><span class="sxs-lookup"><span data-stu-id="5d687-179">You encode a video file at 30 frames per second with a bit rate of 6,000 bits per second and a buffer window of 3 seconds (a total buffer size of 18,000 bits).</span></span> <span data-ttu-id="5d687-180">Le premier échantillon est encodé sous la forme d’une image clé et occupe 7 000 bits.</span><span class="sxs-lookup"><span data-stu-id="5d687-180">The first sample is encoded as a key frame and takes up 7,000 bits.</span></span> <span data-ttu-id="5d687-181">La mémoire tampon de l’encodeur contient désormais 7 000 bits.</span><span class="sxs-lookup"><span data-stu-id="5d687-181">The encoder buffer now contains 7,000 bits.</span></span> <span data-ttu-id="5d687-182">Les 29 images suivantes sont toutes des images Delta qui totalisent 3 000 bits.</span><span class="sxs-lookup"><span data-stu-id="5d687-182">The next 29 frames are all delta frames that total 3,000 bits.</span></span> <span data-ttu-id="5d687-183">Par conséquent, la première seconde de contenu (30 frames) placerait la saturation de la mémoire tampon à 10 000 bits si rien ne se produisait. Nous savons que la vitesse de transmission du flux est de 6 000 bits par seconde. par conséquent, une fois que la première seconde du contenu encodé est placée dans la mémoire tampon de l’encodeur, l’intégralité chute à 4 000 bits.</span><span class="sxs-lookup"><span data-stu-id="5d687-183">So the first second of content (30 frames) would put the buffer fullness at 10,000 bits if nothing were leaking out. We know that the bit rate of the stream is 6,000 bits per second, so after the first second of encoded content is put in the encoder buffer, the fullness drops to 4,000 bits.</span></span> <span data-ttu-id="5d687-184">Dans l’application de décodage, ce flux est remis à la mémoire tampon du décodeur à 6 000 bits par seconde.</span><span class="sxs-lookup"><span data-stu-id="5d687-184">In the decoding application, this stream is delivered to the decoder buffer at 6,000 bits per second.</span></span> <span data-ttu-id="5d687-185">Après une seconde, la mémoire tampon contient 6 000 bits.</span><span class="sxs-lookup"><span data-stu-id="5d687-185">After one second, the buffer contains 6,000 bits.</span></span> <span data-ttu-id="5d687-186">Le premier exemple contient 7 000 bits, de sorte que la mémoire tampon du décodeur doit être remplie plus avant que le décodeur commence à supprimer des échantillons.</span><span class="sxs-lookup"><span data-stu-id="5d687-186">The first sample contains 7,000 bits, so the decoder buffer must be filled more before the decoder begins removing samples.</span></span>

## <a name="setting-leaky-bucket-values-for-asf-streams"></a><span data-ttu-id="5d687-187">Définition des valeurs de compartiment fuites pour les flux ASF</span><span class="sxs-lookup"><span data-stu-id="5d687-187">Setting Leaky Bucket Values for ASF Streams</span></span>

<span data-ttu-id="5d687-188">Dans un scénario d’encodage de fichiers, une application peut définir les valeurs de compartiment avec fuites lors de la configuration des flux dans le [Profil ASF](asf-profile.md).</span><span class="sxs-lookup"><span data-stu-id="5d687-188">In a file-encoding scenario, an application can set the leaky bucket values while configuring the streams in the [ASF Profile](asf-profile.md).</span></span>

<span data-ttu-id="5d687-189">Une fois que vous avez créé le flux et que vous avez une référence à l’interface [**IMFASFStreamConfig**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) du flux, vous pouvez définir les valeurs à l’aide des attributs suivants :</span><span class="sxs-lookup"><span data-stu-id="5d687-189">After you have created the stream and have a reference to the stream's [**IMFASFStreamConfig**](/windows/desktop/api/wmcontainer/nn-wmcontainer-imfasfstreamconfig) interface, you can set the values by using the following attributes:</span></span>

-   <span data-ttu-id="5d687-190">[**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (valeurs de compartiment de fuite moyenne)</span><span class="sxs-lookup"><span data-stu-id="5d687-190">[**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) (average leaky bucket values)</span></span>
-   <span data-ttu-id="5d687-191">[**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (valeurs de compartiment à fuites maximales)</span><span class="sxs-lookup"><span data-stu-id="5d687-191">[**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) (maximum leaky bucket values)</span></span>

<span data-ttu-id="5d687-192">Pour plus d’informations sur l’ajout de flux et l’obtention du pointeur **IMFASFStreamConfig** , consultez [Ajout d’informations de flux au récepteur de fichiers ASF](adding-stream-information-to-the-asf-file-sink.md).</span><span class="sxs-lookup"><span data-stu-id="5d687-192">For information about adding streams and getting the **IMFASFStreamConfig** pointer, see [Adding Stream Information to the ASF File Sink](adding-stream-information-to-the-asf-file-sink.md).</span></span>

<span data-ttu-id="5d687-193">Ces valeurs contiennent les informations suivantes :</span><span class="sxs-lookup"><span data-stu-id="5d687-193">These values contain the following set of information:</span></span>

-   <span data-ttu-id="5d687-194">Vitesse de transmission moyenne : obtient la vitesse de transmission moyenne à partir du type de média de sortie sélectionné lors de la négociation de type de média.</span><span class="sxs-lookup"><span data-stu-id="5d687-194">Average bit rate: Get the average bit rate from the output media type that is selected during media type negotiation.</span></span> <span data-ttu-id="5d687-195">Utilisez l' [**attribut \_ \_ \_ nombre moyen d' \_ octets \_ par \_ seconde du son**](mf-mt-audio-avg-bytes-per-second-attribute.md) (pour les flux audio) ou l’attribut de [**vitesse de \_ \_ \_ transmission moyenne MF MT**](mf-mt-avg-bitrate-attribute.md) (pour les flux vidéo).</span><span class="sxs-lookup"><span data-stu-id="5d687-195">Use the [**MF\_MT\_AUDIO\_AVG\_BYTES\_PER\_SECOND**](mf-mt-audio-avg-bytes-per-second-attribute.md) attribute (for audio streams) or the [**MF\_MT\_AVG\_BITRATE**](mf-mt-avg-bitrate-attribute.md) attribute (for video streams).</span></span>
-   <span data-ttu-id="5d687-196">Fenêtre de mémoire tampon : Si vous avez une instance de l’encodeur et que vous avez négocié des types de médias de sortie, vous pouvez mettre à jour cette valeur ultérieurement en interrogeant l’encodeur pour l’interface [**IWMCodecLeakyBucket**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) , puis en appelant [**IWMCodecLeakyBucket :: GetBufferSizeBits**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (wmcodecifaces. h, wmcodecdspuuid. lib).</span><span class="sxs-lookup"><span data-stu-id="5d687-196">Buffer window: If you have an instance of the encoder and have negotiated output media types, you can update this value later by querying the encoder for the [**IWMCodecLeakyBucket**](/windows/desktop/api/wmcodecdsp/nn-wmcodecdsp-iwmcodecleakybucket) interface and then calling [**IWMCodecLeakyBucket::GetBufferSizeBits**](../wmformat/iwmcodecleakybucket-getbuffersizebits.md) (wmcodecifaces.h, wmcodecdspuuid.lib).</span></span> <span data-ttu-id="5d687-197">Dans le cas contraire, utilisez la valeur par défaut de 3000 millisecondes.</span><span class="sxs-lookup"><span data-stu-id="5d687-197">Otherwise, Use the default value of 3000 milliseconds.</span></span>
-   <span data-ttu-id="5d687-198">Taille de la mémoire tampon initiale : définie sur 0.</span><span class="sxs-lookup"><span data-stu-id="5d687-198">Initial buffer size: Set to 0.</span></span>

<span data-ttu-id="5d687-199">Les valeurs fournies par l’application dépendent du type d’encodage et du type de média du flux.</span><span class="sxs-lookup"><span data-stu-id="5d687-199">The values provided by the application depend on the type of encoding and the media type of the stream.</span></span> <span data-ttu-id="5d687-200">Par exemple, l' [encodage à vitesse de transmission constante](constant-bit-rate-encoding.md) requiert une vitesse de transmission fixe prédéterminée et une fenêtre de mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="5d687-200">For example, [Constant Bit Rate Encoding](constant-bit-rate-encoding.md) requires a predetermined fixed bit rate and a buffer window.</span></span> <span data-ttu-id="5d687-201">L’application peut spécifier ces valeurs de compartiment avec fuites en définissant la propriété de codage [**MFPKEY \_ VIDEOWINDOW**](mfpkey-videowindowproperty.md) et l’attribut [**\_ \_ LEAKYBUCKET1 ASFSTREAMCONFIG MF**](mf-asfstreamconfig-leakybucket1-attribute.md) sur le flux.</span><span class="sxs-lookup"><span data-stu-id="5d687-201">The application can specify these leaky bucket values by setting the [**MFPKEY\_VIDEOWINDOW**](mfpkey-videowindowproperty.md) encoding property and the [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) attribute on the stream.</span></span> <span data-ttu-id="5d687-202">Les valeurs de fenêtre de mémoire tampon spécifiées sont utilisées pour s’assurer que le fichier encodé a les heures d’envoi correctes marquées sur les paquets de données et que la valeur de préroll s’affiche dans l’objet d’en-tête ASF.</span><span class="sxs-lookup"><span data-stu-id="5d687-202">The specified buffer window values are used to make sure that the encoded file has the correct send times marked on the data packets and the preroll value appears in the ASF Header Object.</span></span> <span data-ttu-id="5d687-203">Il suffit de définir **MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1** , car ces valeurs spécifiées sont copiées dans l’attribut [**\_ \_ LEAKYBUCKET2 de ASFSTREAMCONFIG MF**](mf-asfstreamconfig-leakybucket2-attribute.md) .</span><span class="sxs-lookup"><span data-stu-id="5d687-203">It is sufficient to set **MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1** because these specified values are copied into the [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) attribute.</span></span>

<span data-ttu-id="5d687-204">Pour les modes d’encodage à 2 passes, vous devez définir ces deux attributs pour spécifier les valeurs moyennes et maximales.</span><span class="sxs-lookup"><span data-stu-id="5d687-204">For 2-pass encoding modes you need to set both of these attributes to specify the average and maximum values.</span></span>

<span data-ttu-id="5d687-205">Pour l’encodage VBR, l’application peut interroger les valeurs de compartiment perdues utilisées par l’encodeur uniquement une fois le test d’encodage terminé.</span><span class="sxs-lookup"><span data-stu-id="5d687-205">For VBR encoding, the application can query for the leaky bucket values used by the encoder only after the encoding pass is complete.</span></span> <span data-ttu-id="5d687-206">Par conséquent, lors de la configuration du récepteur multimédia, l’application peut choisir de ne pas définir les attributs ou les propriétés liés aux compartiments perdus.</span><span class="sxs-lookup"><span data-stu-id="5d687-206">Therefore, while configuring the media sink, the application can choose not to set the attributes or properties related to leaky buckets.</span></span> <span data-ttu-id="5d687-207">Après l’encodage, l’application doit interroger l’encodeur pour les propriétés [**MFPKEY \_ RAVG**](mfpkey-ravgproperty.md), [**MFPKEY \_ BAVG**](mfpkey-bavgproperty.md), [**MFPKEY \_ Rmax**](mfpkey-rmaxproperty.md)et [**MFPKEY \_**](mfpkey-bmaxproperty.md) BMAX et les définir dans le récepteur multimédia afin que les valeurs exactes soient reflétées dans l’objet d’en-tête.</span><span class="sxs-lookup"><span data-stu-id="5d687-207">After encoding, the application must query the encoder for the [**MFPKEY\_RAVG**](mfpkey-ravgproperty.md), [**MFPKEY\_BAVG**](mfpkey-bavgproperty.md), [**MFPKEY\_RMAX**](mfpkey-rmaxproperty.md), and [**MFPKEY\_BMAX**](mfpkey-bmaxproperty.md) properties and set them in the media sink so that the accurate values are reflected in the Header Object.</span></span> <span data-ttu-id="5d687-208">Pour obtenir un exemple de code sur la façon de mettre à jour les valeurs pour l’encodage VBR, consultez « mettre à jour les propriétés d’encodage dans le récepteur de fichiers » dans le [Didacticiel : 1-passer l’encodage Windows Media](tutorial--1-pass-windows-media-encoding.md).</span><span class="sxs-lookup"><span data-stu-id="5d687-208">For code example about how to update the values for VBR encoding, see "Update Encoding Properties in the File Sink" in [Tutorial: 1-Pass Windows Media Encoding](tutorial--1-pass-windows-media-encoding.md).</span></span>

<span data-ttu-id="5d687-209">Si vous copiez du contenu Windows Media de la source vers le récepteur multimédia sans encodage, les valeurs des compartiments de fuites doivent être définies dans le récepteur multimédia.</span><span class="sxs-lookup"><span data-stu-id="5d687-209">If you are copying Windows Media content from source to media sink without encoding, the leaky bucket values must be set in the media sink.</span></span>

## <a name="leaky-bucket-values-in-the-asf-multiplexer"></a><span data-ttu-id="5d687-210">Valeurs de compartiment avec fuite dans le multiplexeur ASF</span><span class="sxs-lookup"><span data-stu-id="5d687-210">Leaky Bucket Values in the ASF Multiplexer</span></span>

<span data-ttu-id="5d687-211">Dans Media Foundation, les valeurs de compartiment perdues sont utilisées par le [multiplexeur ASF](asf-multiplexer.md) pour configurer les valeurs de compartiment de fuites internes qu’il utilise pour générer des paquets de données.</span><span class="sxs-lookup"><span data-stu-id="5d687-211">In Media Foundation, the leaky bucket values are used by the [ASF Multiplexer](asf-multiplexer.md) to set up the internal leaky bucket values that it uses to generate data packets.</span></span> <span data-ttu-id="5d687-212">La charge utile est contenue dans un exemple de média et une série d’exemples de médias constitue un paquet de données ASF.</span><span class="sxs-lookup"><span data-stu-id="5d687-212">The payload is contained within a media sample and a series of media samples constitutes an ASF data packet.</span></span> <span data-ttu-id="5d687-213">En fonction des valeurs de compartiment perdues et de l’heure de présentation, le multiplexeur attribue un délai d’envoi pour chaque échantillon de support afin que les débits binaires des paquets envoyés sur le réseau soient à une vitesse de transmission constante (*R*).</span><span class="sxs-lookup"><span data-stu-id="5d687-213">Based on the leaky bucket values and the presentation time, the multiplexer assigns a send time for each media sample so that the bit rates of the packets being sent across the network is at a constant bit rate (*R*).</span></span>

<span data-ttu-id="5d687-214">Une application ne peut pas définir directement de valeurs de compartiment fuites dans le multiplexeur.</span><span class="sxs-lookup"><span data-stu-id="5d687-214">An application cannot set leaky bucket values in the multiplexer directly.</span></span> <span data-ttu-id="5d687-215">Les valeurs doivent être fournies sur le récepteur multimédia ASF, qui définit les valeurs appropriées sur le multiplexeur.</span><span class="sxs-lookup"><span data-stu-id="5d687-215">The values must be provided on the ASF media sink, which sets the appropriate values on the multiplexer.</span></span> <span data-ttu-id="5d687-216">Les valeurs définies dans les modèles [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) et [**MF \_ ASFSTREAMCONFIG \_ LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) sont utilisées par le multiplexeur pour valider les exemples envoyés au récepteur multimédia ASF sont générés à l’aide des valeurs spécifiées.</span><span class="sxs-lookup"><span data-stu-id="5d687-216">The values set in [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET1**](mf-asfstreamconfig-leakybucket1-attribute.md) and [**MF\_ASFSTREAMCONFIG\_LEAKYBUCKET2**](mf-asfstreamconfig-leakybucket2-attribute.md) are used by the multiplexer to validate the samples sent to the ASF media sink are generated by using the specified values.</span></span>

## <a name="updating-leaky-bucket-values-in-the-asf-media-sink"></a><span data-ttu-id="5d687-217">Mise à jour des valeurs de compartiment avec fuite dans le récepteur de média ASF</span><span class="sxs-lookup"><span data-stu-id="5d687-217">Updating Leaky Bucket Values in the ASF Media Sink</span></span>

<span data-ttu-id="5d687-218">Une application peut remplacer les valeurs de compartiment avec fuite au niveau du flux (définies dans le profil ASF lors de la création du flux) en définissant la propriété [**MFPKEY \_ ASFSTREAMSINK \_ corrigé \_ LEAKYBUCKET**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) dans la Banque de propriétés du récepteur multimédia.</span><span class="sxs-lookup"><span data-stu-id="5d687-218">An application can overwrite the stream-level leaky bucket values (set in the ASF profile during stream creation) by setting the [**MFPKEY\_ASFSTREAMSINK\_CORRECTED\_LEAKYBUCKET**](mfpkey-asfstreamsink-corrected-leakybucket-property.md) property in the media sink's property store.</span></span> <span data-ttu-id="5d687-219">Pour obtenir une référence à la Banque de propriétés, utilisez l’objet ContentInfo implémenté par le récepteur multimédia.</span><span class="sxs-lookup"><span data-stu-id="5d687-219">To get a reference to the property store, use the ContentInfo object implemented by the media sink.</span></span> <span data-ttu-id="5d687-220">Pour plus d’informations, consultez [définition des propriétés dans le récepteur de fichiers](setting-properties-in-the-file-sink.md).</span><span class="sxs-lookup"><span data-stu-id="5d687-220">For more information, see [Setting Properties in the File Sink](setting-properties-in-the-file-sink.md).</span></span>

<span data-ttu-id="5d687-221">**Remarque**  Cette opération est autorisée uniquement pour les flux audio.</span><span class="sxs-lookup"><span data-stu-id="5d687-221">**Note**  This operation is only allowed for audio streams.</span></span>

<span data-ttu-id="5d687-222">Cette propriété doit être définie après que vous avez défini le type de sortie sur l’encodeur.</span><span class="sxs-lookup"><span data-stu-id="5d687-222">This property must be set after you have set the output type on the encoder.</span></span> <span data-ttu-id="5d687-223">En fonction de la vitesse de transmission définie dans le type de média, l’encodeur calcule la taille de la mémoire tampon pour s’assurer que les exemples de supports générés ne dépassent jamais la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="5d687-223">Based on the bit rate set in the media type, the encoder calculates the buffer size to ensure that the generated media samples never overflow the buffer.</span></span> <span data-ttu-id="5d687-224">L’encodeur effectue des ajustements nécessaires pendant la compression pour conserver la vitesse de transmission des échantillons compressés dans les limites décrites par la vitesse de transmission et la fenêtre de mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="5d687-224">The encoder makes necessary adjustments during compression to keep the bit rate of the compressed samples within the boundaries described by the bit rate and buffer window.</span></span>

<span data-ttu-id="5d687-225">À l’instar des attributs de configuration de flux pour les compartiments avec fuite, définissez la vitesse de transmission moyenne et la taille de la mémoire tampon, ainsi que la saturation de la mémoire tampon initiale dans un tableau de DWORDs.</span><span class="sxs-lookup"><span data-stu-id="5d687-225">Similar to the stream configuration attributes for leaky buckets, set the average bit rate and the buffer size, and the initial buffer fullness in an array of DWORDs.</span></span> <span data-ttu-id="5d687-226">Pour plus d’informations, consultez la section « Définition des valeurs des compartiments de fuites pour les flux ASF » dans cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="5d687-226">For more information, see "Setting Leaky Bucket Values for ASF Streams" section in this topic.</span></span>

## <a name="related-topics"></a><span data-ttu-id="5d687-227">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="5d687-227">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5d687-228">Prise en charge ASF dans Media Foundation</span><span class="sxs-lookup"><span data-stu-id="5d687-228">ASF Support in Media Foundation</span></span>](asf-support-in-media-foundation.md)
</dt> <dt>

[<span data-ttu-id="5d687-229">Codecs Windows Media</span><span class="sxs-lookup"><span data-stu-id="5d687-229">Windows Media Codecs</span></span>](windows-media-codecs.md)
</dt> </dl>

 

 
