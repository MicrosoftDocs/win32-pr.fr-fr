---
description: Décrit le contenu vidéo&\# 8211 ; fonctionnalités de protection qu’un pilote Graphics peut fournir.
ms.assetid: FD0625BB-484A-43E6-8931-DB635D4F017F
title: GPU-Based protection du contenu
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6bbc1a0f88cae199b9aab38e5ec429ea5427f44b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104571362"
---
# <a name="gpu-based-content-protection"></a><span data-ttu-id="89d32-103">GPU-Based protection du contenu</span><span class="sxs-lookup"><span data-stu-id="89d32-103">GPU-Based Content Protection</span></span>

<span data-ttu-id="89d32-104">Cette rubrique décrit les fonctionnalités de protection du contenu vidéo qu’un pilote Graphics peut fournir.</span><span class="sxs-lookup"><span data-stu-id="89d32-104">This topic describes video content–protection capabilities that a graphics driver can provide.</span></span>

-   [<span data-ttu-id="89d32-105">Introduction</span><span class="sxs-lookup"><span data-stu-id="89d32-105">Introduction</span></span>](#introduction)
-   [<span data-ttu-id="89d32-106">Vue d’ensemble du processus de décodage</span><span class="sxs-lookup"><span data-stu-id="89d32-106">Overview of the Decoding Process</span></span>](#overview-of-the-decoding-process)
-   [<span data-ttu-id="89d32-107">Chiffrement de mémoires tampons vidéo compressées pour le décodeur</span><span class="sxs-lookup"><span data-stu-id="89d32-107">Encrypting Compressed Video Buffers for the Decoder</span></span>](#encrypting-compressed-video-buffers-for-the-decoder)
    -   [<span data-ttu-id="89d32-108">1. interroger les fonctionnalités protection du contenu du pilote</span><span class="sxs-lookup"><span data-stu-id="89d32-108">1. Query the Content Protection Capabilities of the Driver</span></span>](#1-query-the-content-protection-capabilities-of-the-driver)
    -   [<span data-ttu-id="89d32-109">2. configurer le canal authentifié</span><span class="sxs-lookup"><span data-stu-id="89d32-109">2. Configure the Authenticated Channel</span></span>](#2-configure-the-authenticated-channel)
    -   [<span data-ttu-id="89d32-110">3. configurer la session de chiffrement</span><span class="sxs-lookup"><span data-stu-id="89d32-110">3. Configure the Cryptographic Session</span></span>](#3-configure-the-cryptographic-session)
    -   [<span data-ttu-id="89d32-111">4. obtenir un descripteur de l’appareil décodeur DXVA</span><span class="sxs-lookup"><span data-stu-id="89d32-111">4. Get a Handle to the DXVA Decoder Device</span></span>](#4-get-a-handle-to-the-dxva-decoder-device)
    -   [<span data-ttu-id="89d32-112">5. associer le décodeur DXVA à la session de chiffrement</span><span class="sxs-lookup"><span data-stu-id="89d32-112">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>](#5-associate-the-dxva-decoder-with-the-cryptographic-session)
-   [<span data-ttu-id="89d32-113">Envoi de commandes de canal authentifié</span><span class="sxs-lookup"><span data-stu-id="89d32-113">Sending Authenticated Channel Commands</span></span>](#sending-authenticated-channel-commands)
-   [<span data-ttu-id="89d32-114">Envoi de requêtes de canal authentifié</span><span class="sxs-lookup"><span data-stu-id="89d32-114">Sending Authenticated Channel Queries</span></span>](#sending-authenticated-channel-queries)
-   [<span data-ttu-id="89d32-115">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="89d32-115">Related topics</span></span>](#related-topics)

## <a name="introduction"></a><span data-ttu-id="89d32-116">Introduction</span><span class="sxs-lookup"><span data-stu-id="89d32-116">Introduction</span></span>

<span data-ttu-id="89d32-117">Le diagramme suivant montre une vue simplifiée de la façon dont le contenu de la vidéo protégée transite par le pipeline pour être rendu.</span><span class="sxs-lookup"><span data-stu-id="89d32-117">The following diagram shows a simplified view of how protected video content travels through the pipeline to be rendered.</span></span>

![diagramme qui affiche le contenu vidéo protégé.](images/d3d9video01.png)

> [!Note]  
> <span data-ttu-id="89d32-119">Le [chemin d’accès au média protégé](protected-media-path.md) (PMP) n’est pas représenté dans ce diagramme.</span><span class="sxs-lookup"><span data-stu-id="89d32-119">The [Protected Media Path](protected-media-path.md) (PMP) is not depicted in this diagram.</span></span> <span data-ttu-id="89d32-120">Le workflow illustré ici peut se produire dans un processus PMP ou dans un processus d’application.</span><span class="sxs-lookup"><span data-stu-id="89d32-120">The data flow that is shown here might occur within a PMP process, or within an application process.</span></span>

 

<span data-ttu-id="89d32-121">Le décodeur reçoit des données vidéo chiffrées et compressées à partir d’une source externe.</span><span class="sxs-lookup"><span data-stu-id="89d32-121">The decoder receives encrypted, compressed video data from an external source.</span></span> <span data-ttu-id="89d32-122">Il est supposé également que le décodeur reçoit également une clé de chiffrement pour déchiffrer ces données.</span><span class="sxs-lookup"><span data-stu-id="89d32-122">It is assumed also the decoder also receives a cryptographic key to decrypt this data.</span></span> <span data-ttu-id="89d32-123">Cette rubrique ne décrit pas l’échange de clés entre la source et le décodeur vidéo, mais le PMP définit un mécanisme possible.</span><span class="sxs-lookup"><span data-stu-id="89d32-123">This topic does not describe the key exchange between the video source and decoder, but the PMP defines one possible mechanism.</span></span> <span data-ttu-id="89d32-124">Le GPU n’est pas impliqué à ce niveau.</span><span class="sxs-lookup"><span data-stu-id="89d32-124">The GPU is not involved at this stage.</span></span>

<span data-ttu-id="89d32-125">Pour le décodage à accélération matérielle, le décodeur logiciel transmet le contenu vidéo compressé au GPU.</span><span class="sxs-lookup"><span data-stu-id="89d32-125">For hardware-accelerated decoding, the software decoder passes compressed video content to the GPU.</span></span> <span data-ttu-id="89d32-126">Pour protéger ce contenu, le décodeur rechiffre les données, généralement en utilisant AES-CTR, avant de les transmettre à l’accélérateur matériel.</span><span class="sxs-lookup"><span data-stu-id="89d32-126">To protect this content, the decoder re-encrypts the data, typically using AES-CTR, before passing it to the hardware accelerator.</span></span> <span data-ttu-id="89d32-127">Un mécanisme d’échange de clés est défini entre le décodeur et le pilote Graphics.</span><span class="sxs-lookup"><span data-stu-id="89d32-127">A key-exchange mechanism is defined between the decoder and the graphics driver.</span></span>

<span data-ttu-id="89d32-128">Les trames vidéo décodées sont stockées dans la mémoire vidéo, généralement en clair.</span><span class="sxs-lookup"><span data-stu-id="89d32-128">Decoded video frames are stored in video memory, generally in the clear.</span></span> <span data-ttu-id="89d32-129">À ce stade, les trames sont traitées et présentées.</span><span class="sxs-lookup"><span data-stu-id="89d32-129">At this point, the frames are processed and then presented.</span></span> <span data-ttu-id="89d32-130">Il existe deux options principales pour la présentation.</span><span class="sxs-lookup"><span data-stu-id="89d32-130">There are two main options for presentation.</span></span>

-   <span data-ttu-id="89d32-131">Les frames peuvent être présentés à l’aide d’une superposition matérielle.</span><span class="sxs-lookup"><span data-stu-id="89d32-131">Frames can be presented using a hardware overlay.</span></span> <span data-ttu-id="89d32-132">Pour plus d’informations, consultez [prise en charge de la superposition matérielle](hardware-overlay-support.md).</span><span class="sxs-lookup"><span data-stu-id="89d32-132">For more information, see [Hardware Overlay Support](hardware-overlay-support.md).</span></span>
-   <span data-ttu-id="89d32-133">Les frames peuvent être présentés par la gestion de la fenêtre du Bureau (DWM) à l’aide d’une surface partagée.</span><span class="sxs-lookup"><span data-stu-id="89d32-133">Frames can be presented by the Desktop Window Manage (DWM) using a shared surface.</span></span>

<span data-ttu-id="89d32-134">La dernière étape consiste à afficher le cadre sur le moniteur, ce qui peut nécessiter une protection de liaison entre la carte graphique et le périphérique d’affichage.</span><span class="sxs-lookup"><span data-stu-id="89d32-134">The last step is to display the frame on the monitor, which may require link protection between the graphics card and the display device.</span></span> <span data-ttu-id="89d32-135">Un exemple de protection de liaison est High-Bandwidth la protection du contenu numérique (HDCP).</span><span class="sxs-lookup"><span data-stu-id="89d32-135">An example of link protection is High-Bandwidth Digital Content Protection (HDCP).</span></span> <span data-ttu-id="89d32-136">La protection de liaison est configurée à l’aide de la protection de [sortie](output-protection-manager.md) (OPM).</span><span class="sxs-lookup"><span data-stu-id="89d32-136">Link protection is configured using [Output Protection Manager](output-protection-manager.md) (OPM).</span></span> <span data-ttu-id="89d32-137">Cette rubrique ne décrit pas OPM ; Pour plus d’informations, consultez [utilisation de Output Protection Manager](using-output-protection-manager.md).</span><span class="sxs-lookup"><span data-stu-id="89d32-137">This topic does not describe OPM; for more information, see [Using Output Protection Manager](using-output-protection-manager.md).</span></span>

## <a name="overview-of-the-decoding-process"></a><span data-ttu-id="89d32-138">Vue d’ensemble du processus de décodage</span><span class="sxs-lookup"><span data-stu-id="89d32-138">Overview of the Decoding Process</span></span>

<span data-ttu-id="89d32-139">Lors du décodage accéléré par le matériel, le décodeur logiciel doit transmettre les données vidéo compressées à la carte graphique.</span><span class="sxs-lookup"><span data-stu-id="89d32-139">During hardware-accelerated decoding, the software decoder must pass compressed video data to the graphics card.</span></span> <span data-ttu-id="89d32-140">Pour le contenu Premium, ces données doivent généralement être chiffrées, à l’aide d’un chiffrement à clé symétrique, avant d’être envoyées au GPU.</span><span class="sxs-lookup"><span data-stu-id="89d32-140">For premium content, this data typically must be encrypted, using symmetric-key encryption, before it is sent to the GPU.</span></span>

<span data-ttu-id="89d32-141">Pour chiffrer la vidéo en vue du décodage, le décodeur logiciel utilise les interfaces suivantes :</span><span class="sxs-lookup"><span data-stu-id="89d32-141">To encrypt the video for decoding, the software decoder uses the following interfaces:</span></span>

-   <span data-ttu-id="89d32-142">[**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="89d32-142">[**IDirectXVideoDecoder**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder).</span></span> <span data-ttu-id="89d32-143">Représente l’appareil du décodeur DXVA, également appelé accélérateur.</span><span class="sxs-lookup"><span data-stu-id="89d32-143">Represents the DXVA decoder device, also called the accelerator.</span></span>
-   <span data-ttu-id="89d32-144">[**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9).</span><span class="sxs-lookup"><span data-stu-id="89d32-144">[**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9).</span></span> <span data-ttu-id="89d32-145">Représente une session de chiffrement, qui fournit la clé de chiffrement.</span><span class="sxs-lookup"><span data-stu-id="89d32-145">Represents a cryptographic session, which provides the encryption key.</span></span>
-   <span data-ttu-id="89d32-146">[**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9).</span><span class="sxs-lookup"><span data-stu-id="89d32-146">[**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9).</span></span> <span data-ttu-id="89d32-147">Représente un canal authentifié qui permet au décodeur logiciel d’associer la session de chiffrement au décodeur DXVA.</span><span class="sxs-lookup"><span data-stu-id="89d32-147">Represents an authenticated channel, which enables the software decoder to associate the cryptographic session with the DXVA decoder.</span></span>

![diagramme qui montre les interfaces de décodage Direct3D9.](images/d3d9video02.png)

<span data-ttu-id="89d32-149">Toutes ces interfaces sont obtenues à partir du périphérique Direct3D, comme suit :</span><span class="sxs-lookup"><span data-stu-id="89d32-149">All of these interfaces are obtained from the Direct3D device, as follows:</span></span>



| <span data-ttu-id="89d32-150">Interface</span><span class="sxs-lookup"><span data-stu-id="89d32-150">Interface</span></span>                                                                | <span data-ttu-id="89d32-151">Création</span><span class="sxs-lookup"><span data-stu-id="89d32-151">Creation</span></span>                                                                                                                                                                      |
|--------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="89d32-152">**IDirectXVideoDecoder**</span><span class="sxs-lookup"><span data-stu-id="89d32-152">**IDirectXVideoDecoder**</span></span>](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoder)                     | <span data-ttu-id="89d32-153">Appelez [**IDirectXVideoDecoderService :: CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span><span class="sxs-lookup"><span data-stu-id="89d32-153">Call [**IDirectXVideoDecoderService::CreateVideoDecoder**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoderservice-createvideodecoder).</span></span> <span data-ttu-id="89d32-154">L’appareil de décodage DXVA est identifié par un GUID de profil DXVA.</span><span class="sxs-lookup"><span data-stu-id="89d32-154">The DXVA decoder device is identified by a DXVA profile GUID.</span></span> |
| [<span data-ttu-id="89d32-155">**IDirect3DCryptoSession9**</span><span class="sxs-lookup"><span data-stu-id="89d32-155">**IDirect3DCryptoSession9**</span></span>](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9)               | <span data-ttu-id="89d32-156">Appelez [**IDirect3DDevice9Video :: CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession).</span><span class="sxs-lookup"><span data-stu-id="89d32-156">Call [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession).</span></span>                                                                         |
| [<span data-ttu-id="89d32-157">**IDirect3DAuthenticatedChannel9**</span><span class="sxs-lookup"><span data-stu-id="89d32-157">**IDirect3DAuthenticatedChannel9**</span></span>](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) | <span data-ttu-id="89d32-158">Appelez [**IDirect3DDevice9Video :: CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel).</span><span class="sxs-lookup"><span data-stu-id="89d32-158">Call [**IDirect3DDevice9Video::CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel).</span></span>                                                           |



 

> [!Note]  
> <span data-ttu-id="89d32-159">Pour obtenir un pointeur vers l’interface [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) , appelez [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) sur un appareil D3D9Ex.</span><span class="sxs-lookup"><span data-stu-id="89d32-159">To get a pointer to the [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) interface, call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) on a D3D9Ex device.</span></span>

 

<span data-ttu-id="89d32-160">Le canal authentifié fournit un canal de communication approuvé entre le décodeur logiciel et le pilote.</span><span class="sxs-lookup"><span data-stu-id="89d32-160">The authenticated channel provides a trusted communication channel between the software decoder and the driver.</span></span> <span data-ttu-id="89d32-161">Le canal de communication fonctionne comme suit :</span><span class="sxs-lookup"><span data-stu-id="89d32-161">The communication channel works as follows:</span></span>

-   <span data-ttu-id="89d32-162">Le pilote fournit une chaîne de certificat X. 509 dont le certificat racine est signé par Microsoft.</span><span class="sxs-lookup"><span data-stu-id="89d32-162">The driver provides an X.509 certificate chain whose root certificate is signed by Microsoft.</span></span>
-   <span data-ttu-id="89d32-163">Le certificat contient une clé publique RSA pour le pilote.</span><span class="sxs-lookup"><span data-stu-id="89d32-163">The certificate contains an RSA public key for the driver.</span></span>
-   <span data-ttu-id="89d32-164">Le décodeur logiciel utilise la clé publique pour envoyer au pilote une clé de session AES 128 bits.</span><span class="sxs-lookup"><span data-stu-id="89d32-164">The software decoder uses the public key to send the driver a 128-bit AES session key.</span></span>
-   <span data-ttu-id="89d32-165">Le décodeur logiciel envoie des requêtes et des commandes au canal authentifié.</span><span class="sxs-lookup"><span data-stu-id="89d32-165">The software decoder sends queries and commands to the authenticated channel.</span></span>
-   <span data-ttu-id="89d32-166">La clé de session est utilisée pour calculer les codes d’authentification de message (Mac) pour les requêtes et les commandes.</span><span class="sxs-lookup"><span data-stu-id="89d32-166">The session key is used to compute message authentication codes (MACs) for the queries and commands.</span></span> <span data-ttu-id="89d32-167">Le pilote utilise les Mac pour vérifier l’intégrité des données de requête/commande, et le décodeur logiciel les utilise pour vérifier l’intégrité des données de réponse du pilote.</span><span class="sxs-lookup"><span data-stu-id="89d32-167">The driver uses the MACs to verify the integrity of the query/command data, and the software decoder uses them to verify the integrity of the response data from the driver.</span></span>

## <a name="encrypting-compressed-video-buffers-for-the-decoder"></a><span data-ttu-id="89d32-168">Chiffrement de mémoires tampons vidéo compressées pour le décodeur</span><span class="sxs-lookup"><span data-stu-id="89d32-168">Encrypting Compressed Video Buffers for the Decoder</span></span>

<span data-ttu-id="89d32-169">Voici une vue d’ensemble de haut niveau du processus de chiffrement et de décodage :</span><span class="sxs-lookup"><span data-stu-id="89d32-169">Here is a high-level overview of the encryption and decoding process:</span></span>

1.  <span data-ttu-id="89d32-170">Le décodeur logiciel reçoit un flux de données chiffrées à partir de la source vidéo.</span><span class="sxs-lookup"><span data-stu-id="89d32-170">The software decoder receives a stream of encrypted data from the video source.</span></span> <span data-ttu-id="89d32-171">Le décodeur déchiffre ce flux.</span><span class="sxs-lookup"><span data-stu-id="89d32-171">The decoder decrypts this stream.</span></span>
2.  <span data-ttu-id="89d32-172">Le décodeur logiciel négocie une clé de session avec la session de chiffrement.</span><span class="sxs-lookup"><span data-stu-id="89d32-172">The software decoder negotiates a session key with the cryptographic session.</span></span>
3.  <span data-ttu-id="89d32-173">Le décodeur logiciel utilise le canal authentifié pour associer la session de chiffrement à l’appareil de décodage DXVA.</span><span class="sxs-lookup"><span data-stu-id="89d32-173">The software decoder uses the authenticated channel to associate the cryptographic session with the DXVA decoder device.</span></span>
4.  <span data-ttu-id="89d32-174">Le décodeur logiciel place des données compressées dans des mémoires tampons DXVA qu’il obtient à partir de l’appareil de décodage DXVA (Accélérateur).</span><span class="sxs-lookup"><span data-stu-id="89d32-174">The software decoder puts compressed data in DXVA buffers that it gets from the DXVA decoder device (accelerator).</span></span> <span data-ttu-id="89d32-175">Pour le contenu protégé, l’encodeur logiciel chiffre les données qui sont placées dans les tampons DXVA, à l’aide de la clé de session du chiffrement.</span><span class="sxs-lookup"><span data-stu-id="89d32-175">For protected content, the software encoder encrypts the data that is puts into the DXVA buffers, using the session key for the encryption.</span></span>
    > [!Note]  
    > <span data-ttu-id="89d32-176">Certains pilotes utilisent une clé de contenu, au lieu de la clé de session, pour le chiffrement.</span><span class="sxs-lookup"><span data-stu-id="89d32-176">Some drivers use a content key, instead of the session key, for encryption.</span></span> <span data-ttu-id="89d32-177">La clé de contenu peut passer d’une image à l’autre.</span><span class="sxs-lookup"><span data-stu-id="89d32-177">The content key could change from one frame to the next.</span></span>

     

5.  <span data-ttu-id="89d32-178">Le décodeur envoie les mémoires tampons compressées chiffrées à l’accélérateur.</span><span class="sxs-lookup"><span data-stu-id="89d32-178">The decoder submits the encrypted compressed buffers to the accelerator.</span></span> <span data-ttu-id="89d32-179">Pour AES-CTR, le décodeur passe également le vecteur d’initialisation.</span><span class="sxs-lookup"><span data-stu-id="89d32-179">For AES-CTR, the decoder also passes the initialization vector.</span></span> <span data-ttu-id="89d32-180">Si une clé de contenu est utilisée, le décodeur transmet la clé de contenu, chiffrée à l’aide de la clé de session.</span><span class="sxs-lookup"><span data-stu-id="89d32-180">If a content key is used, the decoder passes content key, encrypted using the session key.</span></span>

<span data-ttu-id="89d32-181">Direct3D offre une prise en charge standard de l’AES-CTR 128 bits, mais est conçu pour s’étendre à des types de chiffrement supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="89d32-181">Direct3D has standard support for 128-bit AES-CTR, but is designed to extend to additional encryption types.</span></span>

<span data-ttu-id="89d32-182">Les cinq sections suivantes fournissent des instructions plus détaillées.</span><span class="sxs-lookup"><span data-stu-id="89d32-182">The next five sections give more detailed steps.</span></span>

-   [<span data-ttu-id="89d32-183">1. interroger les fonctionnalités protection du contenu du pilote</span><span class="sxs-lookup"><span data-stu-id="89d32-183">1. Query the Content Protection Capabilities of the Driver</span></span>](#1-query-the-content-protection-capabilities-of-the-driver)
-   [<span data-ttu-id="89d32-184">2. configurer le canal authentifié</span><span class="sxs-lookup"><span data-stu-id="89d32-184">2. Configure the Authenticated Channel</span></span>](#2-configure-the-authenticated-channel)
-   [<span data-ttu-id="89d32-185">3. configurer la session de chiffrement</span><span class="sxs-lookup"><span data-stu-id="89d32-185">3. Configure the Cryptographic Session</span></span>](#3-configure-the-cryptographic-session)
-   [<span data-ttu-id="89d32-186">4. obtenir un descripteur de l’appareil décodeur DXVA</span><span class="sxs-lookup"><span data-stu-id="89d32-186">4. Get a Handle to the DXVA Decoder Device</span></span>](#4-get-a-handle-to-the-dxva-decoder-device)
-   [<span data-ttu-id="89d32-187">5. associer le décodeur DXVA à la session de chiffrement</span><span class="sxs-lookup"><span data-stu-id="89d32-187">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>](#5-associate-the-dxva-decoder-with-the-cryptographic-session)

### <a name="1-query-the-content-protection-capabilities-of-the-driver"></a><span data-ttu-id="89d32-188">1. interroger les fonctionnalités protection du contenu du pilote</span><span class="sxs-lookup"><span data-stu-id="89d32-188">1. Query the Content Protection Capabilities of the Driver</span></span>

<span data-ttu-id="89d32-189">Avant de tenter d’appliquer le chiffrement, procurez-vous les fonctionnalités de protection du contenu du pilote.</span><span class="sxs-lookup"><span data-stu-id="89d32-189">Before attempting to apply encryption, get the content protection capabilities of the driver.</span></span>

1.  <span data-ttu-id="89d32-190">Obtenir un pointeur vers l’appareil Direct3D 9.</span><span class="sxs-lookup"><span data-stu-id="89d32-190">Get a pointer to the Direct3D 9 device.</span></span>
2.  <span data-ttu-id="89d32-191">Appelez [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) pour l’interface [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) .</span><span class="sxs-lookup"><span data-stu-id="89d32-191">Call [**QueryInterface**](/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)) for the [**IDirect3DDevice9Video**](/windows/desktop/api/d3d9/nn-d3d9-idirect3ddevice9video) interface.</span></span>
3.  <span data-ttu-id="89d32-192">Appelez [**IDirect3DDevice9Video :: GetContentProtectionCaps**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-getcontentprotectioncaps).</span><span class="sxs-lookup"><span data-stu-id="89d32-192">Call [**IDirect3DDevice9Video::GetContentProtectionCaps**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-getcontentprotectioncaps).</span></span> <span data-ttu-id="89d32-193">Cette méthode remplit une structure [**D3DCONTENTPROTECTIONCAPS**](/windows/desktop/api/d3d9caps/ns-d3d9caps-d3dcontentprotectioncaps) avec les fonctionnalités de protection du contenu du pilote.</span><span class="sxs-lookup"><span data-stu-id="89d32-193">This method fills in a [**D3DCONTENTPROTECTIONCAPS**](/windows/desktop/api/d3d9caps/ns-d3d9caps-d3dcontentprotectioncaps) structure with the driver’s content protection capabilities.</span></span>

<span data-ttu-id="89d32-194">En particulier, recherchez les fonctionnalités suivantes :</span><span class="sxs-lookup"><span data-stu-id="89d32-194">In particular, look for the following capabilities:</span></span>

-   <span data-ttu-id="89d32-195">Si le membre **Caps** contient l’indicateur **D3DCPCAPS_SOFTWARE** ou **D3DCPCAPS_HARDWARE** , le pilote peut effectuer le chiffrement.</span><span class="sxs-lookup"><span data-stu-id="89d32-195">If the **Caps** member contains the **D3DCPCAPS_SOFTWARE** or **D3DCPCAPS_HARDWARE** flag, the driver can perform encryption.</span></span>
-   <span data-ttu-id="89d32-196">Le membre **KeyExchangeType** spécifie comment effectuer l’échange de clés pour la clé de session.</span><span class="sxs-lookup"><span data-stu-id="89d32-196">The **KeyExchangeType** member specifies how to perform key exchange for the session key.</span></span>
-   <span data-ttu-id="89d32-197">Si le membre **Caps** contient l’indicateur **D3DCPCAPS_CONTENTKEY** , le pilote utilise une clé de contenu distincte pour le chiffrement.</span><span class="sxs-lookup"><span data-stu-id="89d32-197">If the **Caps** member contains the **D3DCPCAPS_CONTENTKEY** flag, the driver uses a separate content key for encryption.</span></span> <span data-ttu-id="89d32-198">C’est important lorsque vous générez la clé de session.</span><span class="sxs-lookup"><span data-stu-id="89d32-198">This is important when you generate the session key.</span></span>

<span data-ttu-id="89d32-199">Les fonctionnalités supplémentaires sont indiquées dans le membre **Caps** .</span><span class="sxs-lookup"><span data-stu-id="89d32-199">Additional capabilities are indicated in the **Caps** member.</span></span>

### <a name="2-configure-the-authenticated-channel"></a><span data-ttu-id="89d32-200">2. configurer le canal authentifié</span><span class="sxs-lookup"><span data-stu-id="89d32-200">2. Configure the Authenticated Channel</span></span>

<span data-ttu-id="89d32-201">L’étape suivante consiste à configurer le canal authentifié.</span><span class="sxs-lookup"><span data-stu-id="89d32-201">The next step is to configure the authenticated channel.</span></span>

1.  <span data-ttu-id="89d32-202">Appelez [**IDirect3DDevice9Video :: CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) pour créer le canal authentifié.</span><span class="sxs-lookup"><span data-stu-id="89d32-202">Call [**IDirect3DDevice9Video::CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) to create the authenticated channel.</span></span> <span data-ttu-id="89d32-203">Pour le paramètre *ChannelType* , spécifiez un type de canal qui correspond aux fonctionnalités du pilote.</span><span class="sxs-lookup"><span data-stu-id="89d32-203">For the *ChannelType* parameter, specify a channel type that matches the capabilities of the driver.</span></span>
    -   <span data-ttu-id="89d32-204">Le type de canal **D3DAUTHENTICATEDCHANNEL_DRIVER_SOFTWARE** correspond à **D3DCPCAPS_SOFTWARE**.</span><span class="sxs-lookup"><span data-stu-id="89d32-204">The **D3DAUTHENTICATEDCHANNEL_DRIVER_SOFTWARE** channel type corresponds to **D3DCPCAPS_SOFTWARE**.</span></span>
    -   <span data-ttu-id="89d32-205">Le type de canal **D3DAUTHENTICATEDCHANNEL_DRIVER_HARDWARE** correspond à **D3DCPCAPS_HARDWARE**.</span><span class="sxs-lookup"><span data-stu-id="89d32-205">The **D3DAUTHENTICATEDCHANNEL_DRIVER_HARDWARE** channel type corresponds to **D3DCPCAPS_HARDWARE**.</span></span>

    <span data-ttu-id="89d32-206">La méthode **CreateAuthenticatedChannel** retourne un pointeur vers l’interface [**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) , ainsi qu’un handle vers le canal.</span><span class="sxs-lookup"><span data-stu-id="89d32-206">The **CreateAuthenticatedChannel** method returns a pointer to the [**IDirect3DAuthenticatedChannel9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dauthenticatedchannel9) interface along with a handle to the channel.</span></span> <span data-ttu-id="89d32-207">Le descripteur est utilisé ultérieurement pour associer la session de chiffrement au canal authentifié.</span><span class="sxs-lookup"><span data-stu-id="89d32-207">The handle is used later to associate the cryptographic session with the authenticated channel.</span></span>
2.  <span data-ttu-id="89d32-208">Appelez [**IDirect3DAuthenticatedChannel9 :: GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificatesize) pour connaître la taille du certificat X. 509 du pilote.</span><span class="sxs-lookup"><span data-stu-id="89d32-208">Call [**IDirect3DAuthenticatedChannel9::GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificatesize) to get the size of the driver's X.509 certificate.</span></span> <span data-ttu-id="89d32-209">Allouez une mémoire tampon de la taille requise.</span><span class="sxs-lookup"><span data-stu-id="89d32-209">Allocate a buffer of the required size.</span></span>
3.  <span data-ttu-id="89d32-210">Appelez [**IDirect3DAuthenticatedChannel9 :: GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificate) pour récupérer le certificat.</span><span class="sxs-lookup"><span data-stu-id="89d32-210">Call [**IDirect3DAuthenticatedChannel9::GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-getcertificate) to get the certificate.</span></span> <span data-ttu-id="89d32-211">La méthode copie le certificat dans la mémoire tampon qui a été allouée à l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="89d32-211">The method copies the certificate into the buffer that was allocated in the previous step.</span></span>
4.  <span data-ttu-id="89d32-212">Vérifiez que le certificat du pilote a été signé par Microsoft et qu’il n’a pas été révoqué.</span><span class="sxs-lookup"><span data-stu-id="89d32-212">Verify that the driver’s certificate was signed by Microsoft and has not been revoked.</span></span>
5.  <span data-ttu-id="89d32-213">Récupérez la clé publique à partir du certificat.</span><span class="sxs-lookup"><span data-stu-id="89d32-213">Get the public key from the certificate.</span></span>
6.  <span data-ttu-id="89d32-214">Générez une clé de session RSA aléatoire.</span><span class="sxs-lookup"><span data-stu-id="89d32-214">Generate a random RSA session key.</span></span> <span data-ttu-id="89d32-215">Cette clé de session est utilisée pour signer les données envoyées au canal authentifié.</span><span class="sxs-lookup"><span data-stu-id="89d32-215">This session key is used to sign data that is sent to the authenticated channel.</span></span> <span data-ttu-id="89d32-216">Chiffrez la clé de session à l’aide de la clé publique du pilote.</span><span class="sxs-lookup"><span data-stu-id="89d32-216">Encrypt the session key using the driver's public key.</span></span>
7.  <span data-ttu-id="89d32-217">Appelez [**IDirect3DAuthenticatedChannel9 :: NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) pour envoyer la clé de session chiffrée au pilote.</span><span class="sxs-lookup"><span data-stu-id="89d32-217">Call [**IDirect3DAuthenticatedChannel9::NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) to send the encrypted session key to the driver.</span></span>
8.  <span data-ttu-id="89d32-218">Initialisez le canal sécurisé comme suit :</span><span class="sxs-lookup"><span data-stu-id="89d32-218">Initialize the secure channel as follows:</span></span>
    1.  <span data-ttu-id="89d32-219">Remplissez une structure [**D3DAUTHENTICATEDCHANNEL_CONFIGUREINITIALIZE**](d3dauthenticatedchannel-configureinitialize.md) comme décrit dans la documentation.</span><span class="sxs-lookup"><span data-stu-id="89d32-219">Fill in a [**D3DAUTHENTICATEDCHANNEL_CONFIGUREINITIALIZE**](d3dauthenticatedchannel-configureinitialize.md) structure as described in the documentation.</span></span>
    2.  <span data-ttu-id="89d32-220">Envoyez la commande [**D3DAUTHENTICATEDCONFIGURE_INITIALIZE**](d3dauthenticatedconfigure-initialize.md) en appelant [**IDirect3DAuthenticatedChannel9 :: configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) comme décrit dans la section [envoi de commandes de canal authentifié](#sending-authenticated-channel-commands).</span><span class="sxs-lookup"><span data-stu-id="89d32-220">Send the [**D3DAUTHENTICATEDCONFIGURE_INITIALIZE**](d3dauthenticatedconfigure-initialize.md) command by calling [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) as described in the section [Sending Authenticated Channel Commands](#sending-authenticated-channel-commands).</span></span> <span data-ttu-id="89d32-221">Cette commande contient les numéros de séquence de départ pour les commandes et les requêtes qui sont envoyées au canal authentifié.</span><span class="sxs-lookup"><span data-stu-id="89d32-221">This command contains the starting sequence numbers for the commands and queries that are sent to the authenticated channel.</span></span>
9.  <span data-ttu-id="89d32-222">Vérifiez le type de canal en envoyant une requête [**D3DAUTHENTICATEDQUERY_CHANNELTYPE**](d3dauthenticatedquery-channeltype.md) au canal authentifié, comme décrit dans la section [envoi de requêtes de canal authentifié](#sending-authenticated-channel-queries).</span><span class="sxs-lookup"><span data-stu-id="89d32-222">Verify the channel type by sending a [**D3DAUTHENTICATEDQUERY_CHANNELTYPE**](d3dauthenticatedquery-channeltype.md) query to the authenticated channel, as described in the section [Sending Authenticated Channel Queries](#sending-authenticated-channel-queries).</span></span> <span data-ttu-id="89d32-223">Vérifiez que le type de canal correspond à ce que vous avez spécifié dans la méthode [**CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) .</span><span class="sxs-lookup"><span data-stu-id="89d32-223">Check that the channel type matches what you specified in the [**CreateAuthenticatedChannel**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createauthenticatedchannel) method.</span></span>

### <a name="3-configure-the-cryptographic-session"></a><span data-ttu-id="89d32-224">3. configurer la session de chiffrement</span><span class="sxs-lookup"><span data-stu-id="89d32-224">3. Configure the Cryptographic Session</span></span>

<span data-ttu-id="89d32-225">Ensuite, configurez la session de chiffrement et établissez la clé de session.</span><span class="sxs-lookup"><span data-stu-id="89d32-225">Next, configure the cryptographic session and establish the session key.</span></span>

1.  <span data-ttu-id="89d32-226">Appelez [**IDirect3DDevice9Video :: CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) pour créer la session de chiffrement.</span><span class="sxs-lookup"><span data-stu-id="89d32-226">Call [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) to create the cryptographic session.</span></span> <span data-ttu-id="89d32-227">Cette méthode retourne un pointeur vers l’interface [**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9) , ainsi qu’un handle vers la session de chiffrement.</span><span class="sxs-lookup"><span data-stu-id="89d32-227">This method returns a pointer to the [**IDirect3DCryptoSession9**](/windows/desktop/api/d3d9/nn-d3d9-idirect3dcryptosession9) interface and along with a handle to the cryptographic session.</span></span>
2.  <span data-ttu-id="89d32-228">Appelez [**IDirect3DCryptoSession9 :: GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificatesize) pour connaître la taille du certificat X. 509 du pilote.</span><span class="sxs-lookup"><span data-stu-id="89d32-228">Call [**IDirect3DCryptoSession9::GetCertificateSize**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificatesize) to get the size of the driver's X.509 certificate.</span></span> <span data-ttu-id="89d32-229">Allouez une mémoire tampon de la taille requise.</span><span class="sxs-lookup"><span data-stu-id="89d32-229">Allocate a buffer of the required size.</span></span>
3.  <span data-ttu-id="89d32-230">Appelez [**IDirect3DCryptoSession9 :: GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificate) pour récupérer le certificat.</span><span class="sxs-lookup"><span data-stu-id="89d32-230">Call [**IDirect3DCryptoSession9::GetCertificate**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dcryptosession9-getcertificate) to get the certificate.</span></span> <span data-ttu-id="89d32-231">La méthode copie le certificat dans la mémoire tampon qui a été allouée à l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="89d32-231">The method copies the certificate into the buffer that was allocated in the previous step.</span></span>
4.  <span data-ttu-id="89d32-232">Vérifiez que le certificat du pilote a été signé par Microsoft et qu’il n’a pas été révoqué.</span><span class="sxs-lookup"><span data-stu-id="89d32-232">Verify that the driver’s certificate was signed by Microsoft and has not been revoked.</span></span>
5.  <span data-ttu-id="89d32-233">Récupérez la clé publique à partir du certificat.</span><span class="sxs-lookup"><span data-stu-id="89d32-233">Get the public key from the certificate.</span></span>
6.  <span data-ttu-id="89d32-234">Générez une clé de session RSA aléatoire.</span><span class="sxs-lookup"><span data-stu-id="89d32-234">Generate a random RSA session key.</span></span> <span data-ttu-id="89d32-235">Il s’agit d’une clé de session distincte de la clé de session du canal authentifié.</span><span class="sxs-lookup"><span data-stu-id="89d32-235">This is a separate session key from the authenticated channel session key.</span></span> <span data-ttu-id="89d32-236">Chiffrez la clé de session à l’aide de la clé publique du pilote.</span><span class="sxs-lookup"><span data-stu-id="89d32-236">Encrypt the session key using the driver's public key.</span></span>
7.  <span data-ttu-id="89d32-237">Appelez [**IDirect3DCryptoSession9 :: NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) pour envoyer la clé de session chiffrée au pilote.</span><span class="sxs-lookup"><span data-stu-id="89d32-237">Call [**IDirect3DCryptoSession9::NegotiateKeyExchange**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-negotiatekeyexchange) to send the encrypted session key to the driver.</span></span>
8.  <span data-ttu-id="89d32-238">Si les fonctionnalités de protection du contenu incluent **D3DCPCAPS_CONTENTKEY**, créez une clé de contenu RSA aléatoire.</span><span class="sxs-lookup"><span data-stu-id="89d32-238">If the content protection capabilities include **D3DCPCAPS_CONTENTKEY**, create a random RSA content key.</span></span> <span data-ttu-id="89d32-239">Ce sera utilisé ultérieurement dans le processus de décodage.</span><span class="sxs-lookup"><span data-stu-id="89d32-239">This will be used later in the decoding process.</span></span>

### <a name="4-get-a-handle-to-the-dxva-decoder-device"></a><span data-ttu-id="89d32-240">4. obtenir un descripteur de l’appareil décodeur DXVA</span><span class="sxs-lookup"><span data-stu-id="89d32-240">4. Get a Handle to the DXVA Decoder Device</span></span>

<span data-ttu-id="89d32-241">Pour l’étape suivante, vous aurez besoin d’un handle vers l’appareil décodeur DXVA.</span><span class="sxs-lookup"><span data-stu-id="89d32-241">For the next step, you will need a handle to the DXVA decoder device.</span></span> <span data-ttu-id="89d32-242">Pour obtenir ce handle, remplissez une structure DXVA2_DecodeExecuteParams comme suit :</span><span class="sxs-lookup"><span data-stu-id="89d32-242">To get this handle, fill in a DXVA2_DecodeExecuteParams structure as follows:</span></span>


```C++
HANDLE hDecodeDeviceHandle;

DXVA2_DecodeExecuteParams execParams = {0};
DXVA2_DecodeExtensionData ExtensionExecute = {0};
    
execParams.NumCompBuffers = 0;
execParams.pCompressedBuffers = NULL;
execParams.pExtensionData = &ExtensionExecute;

ExtensionExecute.Function = DXVA2_DECODE_GET_DRIVER_HANDLE;
ExtensionExecute.pPrivateInputData = NULL;
ExtensionExecute.PrivateInputDataSize = 0;
ExtensionExecute.pPrivateOutputData = &hDecodeDeviceHandle;
ExtensionExecute.PrivateOutputDataSize = sizeof(HANDLE);
```



<span data-ttu-id="89d32-243">Définissez le membre **pExtensionData** de la structure [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) sur l’adresse d’une structure [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) .</span><span class="sxs-lookup"><span data-stu-id="89d32-243">Set the **pExtensionData** member of the [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) structure to the address of a [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) structure.</span></span>

<span data-ttu-id="89d32-244">Dans la structure [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) , définissez la **fonction** Member sur **DXVA2_DECODE_GET_DRIVER_HANDLE**.</span><span class="sxs-lookup"><span data-stu-id="89d32-244">In the [**DXVA2_DecodeExtensionData**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeextensiondata) structure, set the **Function** member to **DXVA2_DECODE_GET_DRIVER_HANDLE**.</span></span> <span data-ttu-id="89d32-245">Définissez **pPrivateOutputData** sur l’adresse d’une mémoire tampon suffisamment grande pour stocker une valeur de **handle** .</span><span class="sxs-lookup"><span data-stu-id="89d32-245">Set **pPrivateOutputData** to the address of a buffer that is large enough to store a **HANDLE** value.</span></span> <span data-ttu-id="89d32-246">(Dans l’exemple précédent, cette mémoire tampon est la variable *hDecodeDeviceHandle* .)</span><span class="sxs-lookup"><span data-stu-id="89d32-246">(In the previous example, this buffer is the *hDecodeDeviceHandle* variable.)</span></span>

<span data-ttu-id="89d32-247">Appelez ensuite [**IDirectXVideoDecoder :: Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) et transmettez l’adresse de la structure [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) .</span><span class="sxs-lookup"><span data-stu-id="89d32-247">Then call [**IDirectXVideoDecoder::Execute**](/windows/desktop/api/dxva2api/nf-dxva2api-idirectxvideodecoder-execute) and pass in the address of the [**DXVA2_DecodeExecuteParams**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodeexecuteparams) structure.</span></span> <span data-ttu-id="89d32-248">Le handle du décodeur DXVA est retourné dans **pPrivateOutputData**.</span><span class="sxs-lookup"><span data-stu-id="89d32-248">The handle to the DXVA decoder is returned in **pPrivateOutputData**.</span></span>

### <a name="5-associate-the-dxva-decoder-with-the-cryptographic-session"></a><span data-ttu-id="89d32-249">5. associer le décodeur DXVA à la session de chiffrement</span><span class="sxs-lookup"><span data-stu-id="89d32-249">5. Associate the DXVA Decoder with the Cryptographic Session</span></span>

<span data-ttu-id="89d32-250">Ensuite, associez l’appareil de décodage DXVA à l’appareil Direct3D et à la session de chiffrement, comme suit :</span><span class="sxs-lookup"><span data-stu-id="89d32-250">Next, associate the DXVA decoder device with the Direct3D device and the cryptographic session, as follows:</span></span>

1.  <span data-ttu-id="89d32-251">Obtenir un descripteur de l’appareil décodeur DXVA, comme décrit dans la section précédente.</span><span class="sxs-lookup"><span data-stu-id="89d32-251">Get a handle to the DXVA decoder device, as described in the previous section.</span></span>
2.  <span data-ttu-id="89d32-252">Obtenir un handle sur le périphérique Direct3D, en envoyant une requête [**D3DAUTHENTICATEDQUERY_DEVICEHANDLE**](d3dauthenticatedquery-devicehandle.md) au canal authentifié.</span><span class="sxs-lookup"><span data-stu-id="89d32-252">Get a handle to the Direct3D device, by sending a [**D3DAUTHENTICATEDQUERY_DEVICEHANDLE**](d3dauthenticatedquery-devicehandle.md) query to the authenticated channel.</span></span>
3.  <span data-ttu-id="89d32-253">Remplissez une structure [**D3DAUTHENTICATEDCHANNEL_CONFIGURECRYPTOSESSION**](d3dauthenticatedchannel-configurecryptosession.md) avec les informations suivantes :</span><span class="sxs-lookup"><span data-stu-id="89d32-253">Fill in a [**D3DAUTHENTICATEDCHANNEL_CONFIGURECRYPTOSESSION**](d3dauthenticatedchannel-configurecryptosession.md) structure with the following information:</span></span>
    -   <span data-ttu-id="89d32-254">Définissez le membre **DXVA2DecodeHandle** sur le descripteur de l’appareil décodeur DXVA.</span><span class="sxs-lookup"><span data-stu-id="89d32-254">Set the **DXVA2DecodeHandle** member to the handle to the DXVA decoder device.</span></span>
    -   <span data-ttu-id="89d32-255">Définissez le membre **CryptoSessionHandle** sur le descripteur de la session de chiffrement.</span><span class="sxs-lookup"><span data-stu-id="89d32-255">Set the **CryptoSessionHandle** member to the handle to the cryptographic session.</span></span> <span data-ttu-id="89d32-256">Ce handle est retourné par la méthode [**IDirect3DDevice9Video :: CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) .</span><span class="sxs-lookup"><span data-stu-id="89d32-256">This handle is returned by the [**IDirect3DDevice9Video::CreateCryptoSession**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9video-createcryptosession) method.</span></span>
    -   <span data-ttu-id="89d32-257">Définissez le membre **DeviceHandle** sur le descripteur de périphérique Direct3D.</span><span class="sxs-lookup"><span data-stu-id="89d32-257">Set the **DeviceHandle** member to the Direct3D device handle.</span></span>
4.  <span data-ttu-id="89d32-258">Appelez [**IDirect3DAuthenticatedChannel9 :: configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) pour envoyer une commande [**D3DAUTHENTICATEDCONFIGURE_CRYPTOSESSION**](d3dauthenticatedconfigure-cryptosession.md) au canal authentifié.</span><span class="sxs-lookup"><span data-stu-id="89d32-258">Call [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure) to send a [**D3DAUTHENTICATEDCONFIGURE_CRYPTOSESSION**](d3dauthenticatedconfigure-cryptosession.md) command to the authenticated channel.</span></span>

<span data-ttu-id="89d32-259">Le diagramme suivant illustre l’échange de handles :</span><span class="sxs-lookup"><span data-stu-id="89d32-259">The following diagram illustrates the exchange of handles:</span></span>

![diagramme qui montre comment le décodeur DXVA est associé à la session de chiffrement.](images/d3d9video03.png)

<span data-ttu-id="89d32-261">Le décodeur logiciel peut désormais utiliser la clé de session de chiffrement pour chiffrer les mémoires tampons vidéo compressées.</span><span class="sxs-lookup"><span data-stu-id="89d32-261">The software decoder can now use the cryptographic session key to encrypt the compressed video buffers.</span></span> <span data-ttu-id="89d32-262">Chaque mémoire tampon compressée aura son propre vecteur d’initialisation (IV) spécifié dans le membre **pvPVPState** de la structure [**DXVA2_DecodeBufferDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodebufferdesc) .</span><span class="sxs-lookup"><span data-stu-id="89d32-262">Each compressed buffer will have its own initialization vector (IV) specified in the **pvPVPState** member of the [**DXVA2_DecodeBufferDesc**](/windows/desktop/api/dxva2api/ns-dxva2api-dxva2_decodebufferdesc) structure.</span></span>

## <a name="sending-authenticated-channel-commands"></a><span data-ttu-id="89d32-263">Envoi de commandes de canal authentifié</span><span class="sxs-lookup"><span data-stu-id="89d32-263">Sending Authenticated Channel Commands</span></span>

<span data-ttu-id="89d32-264">Un ensemble de commandes est défini pour la configuration du canal authentifié et la définition de diverses protections de contenu.</span><span class="sxs-lookup"><span data-stu-id="89d32-264">A set of commands are defined for configuring the authenticated channel and setting various content protections.</span></span> <span data-ttu-id="89d32-265">Pour obtenir la liste des commandes, consultez [protection du contenu des commandes](content-protection-commands.md).</span><span class="sxs-lookup"><span data-stu-id="89d32-265">For a list of commands, see [Content Protection Commands](content-protection-commands.md).</span></span>

<span data-ttu-id="89d32-266">Pour envoyer une commande au canal authentifié, procédez comme suit.</span><span class="sxs-lookup"><span data-stu-id="89d32-266">To send a command to the authenticated channel, perform the following steps.</span></span>

1.  <span data-ttu-id="89d32-267">Renseignez la structure des données d’entrée.</span><span class="sxs-lookup"><span data-stu-id="89d32-267">Fill in the input data structure.</span></span> <span data-ttu-id="89d32-268">Cette structure de données est toujours une structure [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT**](d3dauthenticatedchannel-configure-input.md) suivie de champs supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="89d32-268">This data structure is always a [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT**](d3dauthenticatedchannel-configure-input.md) structure followed by additional fields.</span></span> <span data-ttu-id="89d32-269">Renseignez la structure **D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT** comme indiqué dans le tableau suivant.</span><span class="sxs-lookup"><span data-stu-id="89d32-269">Fill in the **D3DAUTHENTICATEDCHANNEL_CONFIGURE_INPUT** structure as shown in the following table.</span></span>

    <table>
    <colgroup>
    <col style="width: 50%" />
    <col style="width: 50%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th><span data-ttu-id="89d32-270">Membre</span><span class="sxs-lookup"><span data-stu-id="89d32-270">Member</span></span></th>
    <th><span data-ttu-id="89d32-271">Description</span><span class="sxs-lookup"><span data-stu-id="89d32-271">Description</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><span data-ttu-id="89d32-272"><strong>omac</strong></span><span class="sxs-lookup"><span data-stu-id="89d32-272"><strong>omac</strong></span></span></td>
    <td><span data-ttu-id="89d32-273">Ignorez ce champ pour l’instant.</span><span class="sxs-lookup"><span data-stu-id="89d32-273">Skip this field for now.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="89d32-274"><strong>ConfigureType</strong></span><span class="sxs-lookup"><span data-stu-id="89d32-274"><strong>ConfigureType</strong></span></span></td>
    <td><span data-ttu-id="89d32-275">GUID qui identifie la commande.</span><span class="sxs-lookup"><span data-stu-id="89d32-275">GUID that identifies the command.</span></span> <span data-ttu-id="89d32-276">Pour obtenir la liste des commandes, consultez <a href="content-protection-commands.md">protection du contenu des commandes</a>.</span><span class="sxs-lookup"><span data-stu-id="89d32-276">For a list of commands, see <a href="content-protection-commands.md">Content Protection Commands</a>.</span></span></td>
    </tr>
    <tr class="odd">
    <td><span data-ttu-id="89d32-277"><strong>hChannel</strong></span><span class="sxs-lookup"><span data-stu-id="89d32-277"><strong>hChannel</strong></span></span></td>
    <td><span data-ttu-id="89d32-278">Handle du canal authentifié.</span><span class="sxs-lookup"><span data-stu-id="89d32-278">The handle to the authenticated channel.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="89d32-279"><strong>SequenceNumber</strong></span><span class="sxs-lookup"><span data-stu-id="89d32-279"><strong>SequenceNumber</strong></span></span></td>
    <td><span data-ttu-id="89d32-280">Numéro séquentiel.</span><span class="sxs-lookup"><span data-stu-id="89d32-280">The sequence number.</span></span> <span data-ttu-id="89d32-281">Le premier numéro de séquence est spécifié par l’envoi d’une commande <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="89d32-281">The first sequence number is specified by sending a <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> command.</span></span> <span data-ttu-id="89d32-282">Chaque fois que vous envoyez une autre commande, incrémentez ce nombre de 1.</span><span class="sxs-lookup"><span data-stu-id="89d32-282">Each time you send another command, increment this number by 1.</span></span> <span data-ttu-id="89d32-283">Le numéro de séquence protège contre les attaques par relecture.</span><span class="sxs-lookup"><span data-stu-id="89d32-283">The sequence number guards against replay attacks.</span></span>
    <blockquote>
    [!Note]<br />
<span data-ttu-id="89d32-284">Deux numéros de séquence distincts sont utilisés, un pour les commandes et un pour les requêtes.</span><span class="sxs-lookup"><span data-stu-id="89d32-284">Two separate sequence numbers are used, one for commands and one for queries.</span></span>
    </blockquote>
    <br/> <br/></td>
    </tr>
    </tbody>
    </table>

    

     

2.  <span data-ttu-id="89d32-285">Calculez la balise OMAC pour le bloc de données qui apparaît après le membre **OMAC** de la structure d’entrée.</span><span class="sxs-lookup"><span data-stu-id="89d32-285">Calculate the OMAC tag for the block of data that appears after the **omac** member of the input structure.</span></span> <span data-ttu-id="89d32-286">Copiez ensuite cette valeur de balise dans le membre **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="89d32-286">Then copy this tag value into the **omac** member.</span></span>
3.  <span data-ttu-id="89d32-287">Appelez [**IDirect3DAuthenticatedChannel9 :: configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure).</span><span class="sxs-lookup"><span data-stu-id="89d32-287">Call [**IDirect3DAuthenticatedChannel9::Configure**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-configure).</span></span>
4.  <span data-ttu-id="89d32-288">Le pilote place la sortie de la commande dans la structure [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_OUTPUT**](d3dauthenticatedchannel-configure-output.md) .</span><span class="sxs-lookup"><span data-stu-id="89d32-288">The driver places the output from the command in the [**D3DAUTHENTICATEDCHANNEL_CONFIGURE_OUTPUT**](d3dauthenticatedchannel-configure-output.md) structure.</span></span>
5.  <span data-ttu-id="89d32-289">Calculez la balise OMAC pour le bloc de données qui apparaît après le membre **OMAC** de la structure de sortie.</span><span class="sxs-lookup"><span data-stu-id="89d32-289">Calculate the OMAC tag for the block of data that appears after the **omac** member of the output structure.</span></span> <span data-ttu-id="89d32-290">Comparez ceci avec la valeur du membre **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="89d32-290">Compare this with the value of the **omac** member.</span></span> <span data-ttu-id="89d32-291">Échouent s’ils ne correspondent pas.</span><span class="sxs-lookup"><span data-stu-id="89d32-291">Fail if they do not match.</span></span>
6.  <span data-ttu-id="89d32-292">Comparez les valeurs des membres **ConfigureType**, **hChannel** et de la structure de sortie à vos valeurs pour **ces membres.**</span><span class="sxs-lookup"><span data-stu-id="89d32-292">Compare the values of the **ConfigureType**, **hChannel**, and **SequenceNumber** members in the output structure against your values for those members.</span></span> <span data-ttu-id="89d32-293">Échouent s’ils ne correspondent pas.</span><span class="sxs-lookup"><span data-stu-id="89d32-293">Fail if they do not match.</span></span>
7.  <span data-ttu-id="89d32-294">Incrémentez le numéro de séquence de la commande suivante.</span><span class="sxs-lookup"><span data-stu-id="89d32-294">Increment the sequence number for the next command.</span></span>

## <a name="sending-authenticated-channel-queries"></a><span data-ttu-id="89d32-295">Envoi de requêtes de canal authentifié</span><span class="sxs-lookup"><span data-stu-id="89d32-295">Sending Authenticated Channel Queries</span></span>

<span data-ttu-id="89d32-296">Un ensemble de requêtes est défini pour la récupération d’informations sur le canal authentifié.</span><span class="sxs-lookup"><span data-stu-id="89d32-296">A set of queries are defined for retrieving information about the authenticated channel.</span></span> <span data-ttu-id="89d32-297">Pour obtenir la liste des requêtes, consultez [protection du contenu des requêtes](content-protection-queries.md).</span><span class="sxs-lookup"><span data-stu-id="89d32-297">For a list of queries, see [Content Protection Queries](content-protection-queries.md).</span></span>

<span data-ttu-id="89d32-298">Pour envoyer une commande au canal authentifié, procédez comme suit.</span><span class="sxs-lookup"><span data-stu-id="89d32-298">To send a command to the authenticated channel, perform the following steps.</span></span>

1.  <span data-ttu-id="89d32-299">Renseignez la structure des données d’entrée.</span><span class="sxs-lookup"><span data-stu-id="89d32-299">Fill in the input data structure.</span></span> <span data-ttu-id="89d32-300">Cette structure de données est toujours une structure [**D3DAUTHENTICATEDCHANNEL_QUERY_INPUT**](d3dauthenticatedchannel-query-input.md) , éventuellement suivie de champs supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="89d32-300">This data structure is always a [**D3DAUTHENTICATEDCHANNEL_QUERY_INPUT**](d3dauthenticatedchannel-query-input.md) structure, possibly followed by additional fields.</span></span> <span data-ttu-id="89d32-301">Renseignez la structure **D3DAUTHENTICATEDCHANNEL_QUERY_INPUT** comme indiqué dans le tableau suivant.</span><span class="sxs-lookup"><span data-stu-id="89d32-301">Fill in the **D3DAUTHENTICATEDCHANNEL_QUERY_INPUT** structure as shown in the following table.</span></span>

    <table>
    <colgroup>
    <col style="width: 50%" />
    <col style="width: 50%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th><span data-ttu-id="89d32-302">Membre</span><span class="sxs-lookup"><span data-stu-id="89d32-302">Member</span></span></th>
    <th><span data-ttu-id="89d32-303">Description</span><span class="sxs-lookup"><span data-stu-id="89d32-303">Description</span></span></th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td><span data-ttu-id="89d32-304"><strong>Affectée</strong></span><span class="sxs-lookup"><span data-stu-id="89d32-304"><strong>QueryType</strong></span></span></td>
    <td><span data-ttu-id="89d32-305">GUID qui identifie la requête.</span><span class="sxs-lookup"><span data-stu-id="89d32-305">GUID that identifies the query.</span></span> <span data-ttu-id="89d32-306">Pour obtenir la liste des requêtes, consultez <a href="content-protection-queries.md">protection du contenu des requêtes</a>.</span><span class="sxs-lookup"><span data-stu-id="89d32-306">For a list of queries, see <a href="content-protection-queries.md">Content Protection Queries</a>.</span></span></td>
    </tr>
    <tr class="even">
    <td><span data-ttu-id="89d32-307"><strong>hChannel</strong></span><span class="sxs-lookup"><span data-stu-id="89d32-307"><strong>hChannel</strong></span></span></td>
    <td><span data-ttu-id="89d32-308">Handle du canal authentifié.</span><span class="sxs-lookup"><span data-stu-id="89d32-308">The handle to the authenticated channel.</span></span></td>
    </tr>
    <tr class="odd">
    <td><span data-ttu-id="89d32-309"><strong>SequenceNumber</strong></span><span class="sxs-lookup"><span data-stu-id="89d32-309"><strong>SequenceNumber</strong></span></span></td>
    <td><span data-ttu-id="89d32-310">Numéro séquentiel.</span><span class="sxs-lookup"><span data-stu-id="89d32-310">The sequence number.</span></span> <span data-ttu-id="89d32-311">Le premier numéro de séquence est spécifié par l’envoi d’une commande <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> .</span><span class="sxs-lookup"><span data-stu-id="89d32-311">The first sequence number is specified by sending a <a href="d3dauthenticatedconfigure-initialize.md"><strong>D3DAUTHENTICATEDCONFIGURE_INITIALIZE</strong></a> command.</span></span> <span data-ttu-id="89d32-312">Chaque fois que vous envoyez une autre requête, incrémentez ce nombre de 1.</span><span class="sxs-lookup"><span data-stu-id="89d32-312">Each time you send another query, increment this number by 1.</span></span> <span data-ttu-id="89d32-313">Le numéro de séquence protège contre les attaques par relecture.</span><span class="sxs-lookup"><span data-stu-id="89d32-313">The sequence number guards against replay attacks.</span></span>
    <blockquote>
    [!Note]<br />
<span data-ttu-id="89d32-314">Deux numéros de séquence distincts sont utilisés, un pour les commandes et un pour les requêtes.</span><span class="sxs-lookup"><span data-stu-id="89d32-314">Two separate sequence numbers are used, one for commands and one for queries.</span></span>
    </blockquote>
    <br/> <br/></td>
    </tr>
    </tbody>
    </table>

    

     

2.  <span data-ttu-id="89d32-315">Appelez [**IDirect3DAuthenticatedChannel9 :: Query**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-query).</span><span class="sxs-lookup"><span data-stu-id="89d32-315">Call [**IDirect3DAuthenticatedChannel9::Query**](/windows/desktop/api/d3d9/nf-d3d9-idirect3dauthenticatedchannel9-query).</span></span>
3.  <span data-ttu-id="89d32-316">Le pilote place la sortie de la requête dans une structure [**D3DAUTHENTICATEDCHANNEL_QUERY_OUTPUT**](d3dauthenticatedchannel-query-output.md) .</span><span class="sxs-lookup"><span data-stu-id="89d32-316">The driver places the output from the query in a [**D3DAUTHENTICATEDCHANNEL_QUERY_OUTPUT**](d3dauthenticatedchannel-query-output.md) structure.</span></span> <span data-ttu-id="89d32-317">Cette structure est suivie de champs supplémentaires, selon le type de requête.</span><span class="sxs-lookup"><span data-stu-id="89d32-317">This structure is followed by additional fields, depending on the query type.</span></span>
4.  <span data-ttu-id="89d32-318">Calculez la balise OMAC pour le bloc de données qui apparaît après le membre **OMAC** de la structure de sortie.</span><span class="sxs-lookup"><span data-stu-id="89d32-318">Calculate the OMAC tag for the block of data that appears after the **omac** member of the output structure.</span></span> <span data-ttu-id="89d32-319">Comparez ceci avec la valeur du membre **OMAC** .</span><span class="sxs-lookup"><span data-stu-id="89d32-319">Compare this with the value of the **omac** member.</span></span> <span data-ttu-id="89d32-320">Échouent s’ils ne correspondent pas.</span><span class="sxs-lookup"><span data-stu-id="89d32-320">Fail if they do not match.</span></span>
5.  <span data-ttu-id="89d32-321">Comparez les valeurs des membres **ConfigureType**, **hChannel** et de la structure de sortie à vos valeurs pour **ces membres.**</span><span class="sxs-lookup"><span data-stu-id="89d32-321">Compare the values of the **ConfigureType**, **hChannel**, and **SequenceNumber** members in the output structure against your values for those members.</span></span> <span data-ttu-id="89d32-322">Échouent s’ils ne correspondent pas.</span><span class="sxs-lookup"><span data-stu-id="89d32-322">Fail if they do not match.</span></span>
6.  <span data-ttu-id="89d32-323">Incrémentez le numéro de séquence de la requête suivante.</span><span class="sxs-lookup"><span data-stu-id="89d32-323">Increment the sequence number for the next query.</span></span>

## <a name="related-topics"></a><span data-ttu-id="89d32-324">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="89d32-324">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="89d32-325">API vidéo Direct3D 9</span><span class="sxs-lookup"><span data-stu-id="89d32-325">Direct3D 9 Video APIs</span></span>](direct3d-video-apis.md)
</dt> </dl>

 

 
