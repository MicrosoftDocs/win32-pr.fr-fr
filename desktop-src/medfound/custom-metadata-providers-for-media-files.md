---
description: Cette rubrique explique comment écrire un gestionnaire de propriétés de shell personnalisé pour une source de média Microsoft Media Foundation.
ms.assetid: f8cf70ff-8324-4308-8adf-a145aa351ca9
title: Fournisseurs de métadonnées personnalisés pour les fichiers multimédias
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a2ded77492d03f7b802f6b2f9c25e1009ef97f50
ms.sourcegitcommit: c16214e53680dc71d1c07111b51f72b82a4512d8
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/03/2021
ms.locfileid: "106535744"
---
# <a name="custom-metadata-providers-for-media-files"></a><span data-ttu-id="70815-103">Fournisseurs de métadonnées personnalisés pour les fichiers multimédias</span><span class="sxs-lookup"><span data-stu-id="70815-103">Custom Metadata Providers for Media Files</span></span>

<span data-ttu-id="70815-104">Cette rubrique explique comment écrire un gestionnaire de propriétés de shell personnalisé pour une source de média Microsoft Media Foundation.</span><span class="sxs-lookup"><span data-stu-id="70815-104">This topic describes how to write a custom Shell property handler for a Microsoft Media Foundation media source.</span></span>

> [!Note]  
> <span data-ttu-id="70815-105">Pour obtenir des informations générales sur les fournisseurs de métadonnées dans Media Foundation, consultez [Metadata Media](media-metadata.md).</span><span class="sxs-lookup"><span data-stu-id="70815-105">For background information about metadata providers in Media Foundation, see [Media Metadata](media-metadata.md).</span></span> <span data-ttu-id="70815-106">Cette rubrique décrit les gestionnaires de propriétés de Shell. elle ne décrit pas l’interface de métadonnées de la version 1, [**IMFMetadata**](/windows/desktop/api/mfidl/nn-mfidl-imfmetadata).</span><span class="sxs-lookup"><span data-stu-id="70815-106">This topic discusses Shell property handlers; it does not describe the version 1 metadata interface, [**IMFMetadata**](/windows/desktop/api/mfidl/nn-mfidl-imfmetadata).</span></span>

 

<span data-ttu-id="70815-107">Les métadonnées sont étroitement liées au format du fichier.</span><span class="sxs-lookup"><span data-stu-id="70815-107">Metadata is closely tied to the format of the file.</span></span> <span data-ttu-id="70815-108">Dans Media Foundation, les formats de fichier sont représentés par des sources multimédias.</span><span class="sxs-lookup"><span data-stu-id="70815-108">In Media Foundation, file formats are represented by media sources.</span></span> <span data-ttu-id="70815-109">Si vous souhaitez prendre en charge les métadonnées pour un format qui n’est pas pris en charge en mode natif dans Media Foundation, vous devez implémenter une source de média personnalisée avec un gestionnaire de propriétés.</span><span class="sxs-lookup"><span data-stu-id="70815-109">If you want to support metadata for a format that is not supported natively in Media Foundation, you must implement a custom media source with a property handler.</span></span> <span data-ttu-id="70815-110">Le gestionnaire de propriétés permet au système de propriétés de Shell de lire et d’écrire des métadonnées efficacement.</span><span class="sxs-lookup"><span data-stu-id="70815-110">The property handler enables the Shell property system to read and write metadata efficiently.</span></span>

<span data-ttu-id="70815-111">Un gestionnaire de propriétés est un objet COM qui implémente les interfaces suivantes :</span><span class="sxs-lookup"><span data-stu-id="70815-111">A property handler is a COM object that implements the following interfaces:</span></span>

-   [<span data-ttu-id="70815-112">**IInitializeWithStream**</span><span class="sxs-lookup"><span data-stu-id="70815-112">**IInitializeWithStream**</span></span>](/windows/win32/api/propsys/nn-propsys-iinitializewithstream)
-   [<span data-ttu-id="70815-113">**IPropertyStore**</span><span class="sxs-lookup"><span data-stu-id="70815-113">**IPropertyStore**</span></span>](/windows/win32/api/propsys/nn-propsys-ipropertystore)

<span data-ttu-id="70815-114">Le cas échéant, elle peut également exposer l’interface suivante :</span><span class="sxs-lookup"><span data-stu-id="70815-114">Optionally, it can also expose the following interface:</span></span>

-   [<span data-ttu-id="70815-115">**IPropertyStoreCapabilities**</span><span class="sxs-lookup"><span data-stu-id="70815-115">**IPropertyStoreCapabilities**</span></span>](/windows/win32/api/propsys/nn-propsys-ipropertystorecapabilities)

<span data-ttu-id="70815-116">Si le système de propriétés de l’interpréteur de commandes doit obtenir les métadonnées d’un fichier, il appelle [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) pour créer le gestionnaire de propriétés, puis appelle les méthodes de lecture et d’écriture appropriées sur l’interface [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) .</span><span class="sxs-lookup"><span data-stu-id="70815-116">If the Shell property system needs to get metadata for a file, it calls [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) to create the property handler and then calls the appropriate read and write methods on the [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) interface.</span></span>

<span data-ttu-id="70815-117">Le pipeline Media Foundation utilise un mécanisme légèrement différent, car le pipeline obtient le gestionnaire de propriétés directement à partir de la source du média.</span><span class="sxs-lookup"><span data-stu-id="70815-117">The Media Foundation pipeline uses a slightly different mechanism, because the pipeline gets the property handler directly from the media source.</span></span> <span data-ttu-id="70815-118">Au lieu d’appeler [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) pour créer le gestionnaire de propriétés, le pipeline appelle [**IMFGetService :: GetService**](/windows/desktop/api/mfidl/nf-mfidl-imfgetservice-getservice) sur la source du média, comme décrit dans la rubrique [fournisseurs de métadonnées de l’interpréteur](shell-metadata-providers.md)de commandes.</span><span class="sxs-lookup"><span data-stu-id="70815-118">Instead of calling [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) to create the property handler, the pipeline calls [**IMFGetService::GetService**](/windows/desktop/api/mfidl/nf-mfidl-imfgetservice-getservice) on the media source, as described in the topic [Shell Metadata Providers](shell-metadata-providers.md).</span></span>

<span data-ttu-id="70815-119">Pour créer un gestionnaire de propriétés personnalisées, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="70815-119">To create a custom property handler, do the following:</span></span>

-   <span data-ttu-id="70815-120">Implémentez l’interface [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) pour exposer [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore).</span><span class="sxs-lookup"><span data-stu-id="70815-120">Implement the [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice) interface to expose [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore).</span></span> <span data-ttu-id="70815-121">Le GUID du service est le **\_ service de \_ gestionnaire \_ de propriétés MF**.</span><span class="sxs-lookup"><span data-stu-id="70815-121">The service GUID is **MF\_PROPERTY\_HANDLER\_SERVICE**.</span></span>
-   <span data-ttu-id="70815-122">Si la source du média est utilisée à distance, elle doit également exposer l’interface [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) par le biais de la méthode **QueryInterface** de la source du média, en plus de [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice).</span><span class="sxs-lookup"><span data-stu-id="70815-122">If the media source will be used remotely, it must also expose the [**IPropertyStore**](/windows/win32/api/propsys/nn-propsys-ipropertystore) interface through the media source's **QueryInterface** method, in addition to [**IMFGetService**](/windows/desktop/api/mfidl/nn-mfidl-imfgetservice).</span></span>
-   <span data-ttu-id="70815-123">Pour mettre le gestionnaire de propriétés à la disposition du système de propriétés de l’interpréteur de commandes, inscrivez la DLL du gestionnaire de propriétés comme décrit dans la rubrique [inscription et distribution de gestionnaires de propriétés](../properties/prophand-reg-dist.md).</span><span class="sxs-lookup"><span data-stu-id="70815-123">To make the property handler available to the Shell property system, register the DLL for the property handler as described in [Registering and Distributing Property Handlers](../properties/prophand-reg-dist.md).</span></span>
-   <span data-ttu-id="70815-124">La source du média est inscrite séparément, comme décrit dans [gestionnaires de modèles et gestionnaires de Byte-Stream](scheme-handlers-and-byte-stream-handlers.md).</span><span class="sxs-lookup"><span data-stu-id="70815-124">The media source is registered separately, as described in [Scheme Handlers and Byte-Stream Handlers](scheme-handlers-and-byte-stream-handlers.md).</span></span>

### <a name="implementation-tips"></a><span data-ttu-id="70815-125">Conseils d’implémentation</span><span class="sxs-lookup"><span data-stu-id="70815-125">Implementation Tips</span></span>

<span data-ttu-id="70815-126">Pour obtenir la liste des clés de propriété de métadonnées, consultez [Propriétés de métadonnées pour les fichiers multimédias](metadata-properties-for-media-files.md).</span><span class="sxs-lookup"><span data-stu-id="70815-126">For a list of metadata property keys, see [Metadata Properties for Media Files](metadata-properties-for-media-files.md).</span></span>

<span data-ttu-id="70815-127">Les gestionnaires de propriétés doivent être rapides ; ils doivent fournir un accès efficace en lecture et en écriture aux métadonnées.</span><span class="sxs-lookup"><span data-stu-id="70815-127">Property handlers must be fast; they must provide efficient read and write access to the metadata.</span></span> <span data-ttu-id="70815-128">(Considérez que l’interpréteur de commandes peut récupérer des métadonnées de centaines de fichiers.) Par conséquent, n’appelez pas [**MFStartup**](/windows/desktop/api/mfapi/nf-mfapi-mfstartup) à partir de votre gestionnaire de propriétés.</span><span class="sxs-lookup"><span data-stu-id="70815-128">(Consider that the Shell may retrieve metadata from hundreds of files.) Therefore, do not call [**MFStartup**](/windows/desktop/api/mfapi/nf-mfapi-mfstartup) from your property handler.</span></span> <span data-ttu-id="70815-129">La fonction **MFStartup** introduit la latence de démarrage, car elle crée plusieurs threads de file d’attente de travail et alloue de la mémoire globale.</span><span class="sxs-lookup"><span data-stu-id="70815-129">The **MFStartup** function introduces startup latency, because it creates multiple work-queue threads and allocates global memory.</span></span>

<span data-ttu-id="70815-130">Dans une implémentation classique, le gestionnaire de propriétés et la source du média partagent une partie du même code d’analyse.</span><span class="sxs-lookup"><span data-stu-id="70815-130">In a typical implementation, the property handler and the media source will share some of the same parsing code.</span></span> <span data-ttu-id="70815-131">Toutefois, une source de média utilise des appels [**IMFByteStream**](/windows/desktop/api/mfobjects/nn-mfobjects-imfbytestream) asynchrones pour les e/s, tandis que le gestionnaire de propriétés utilise l’interface [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) .</span><span class="sxs-lookup"><span data-stu-id="70815-131">However, a media source uses asynchronous [**IMFByteStream**](/windows/desktop/api/mfobjects/nn-mfobjects-imfbytestream) calls for I/O, whereas the property handler uses the [**IStream**](/windows/win32/api/objidl/nn-objidl-istream) interface.</span></span> <span data-ttu-id="70815-132">Media Foundation fournit un objet d’assistance qui encapsule un flux basé sur **IStream** et l’expose en tant que flux **IMFByteStream** .</span><span class="sxs-lookup"><span data-stu-id="70815-132">Media Foundation provides a helper object that wraps an **IStream**-based stream and exposes it as an **IMFByteStream** stream.</span></span> <span data-ttu-id="70815-133">Pour créer le wrapper, appelez [**MFCreateMFByteStreamOnStream**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatemfbytestreamonstream).</span><span class="sxs-lookup"><span data-stu-id="70815-133">To create the wrapper, call [**MFCreateMFByteStreamOnStream**](/windows/desktop/api/mfidl/nf-mfidl-mfcreatemfbytestreamonstream).</span></span>

<span data-ttu-id="70815-134">Lors de la mise à jour des métadonnées, il est recommandé d’écrire les données directement dans le flux d’origine.</span><span class="sxs-lookup"><span data-stu-id="70815-134">When updating metadata, it is recommended to write the data directly to the original stream.</span></span> <span data-ttu-id="70815-135">Cette recommandation diffère du comportement de *copie sur écriture* de la plupart des gestionnaires de propriétés, dans lesquels une copie des données est modifiée.</span><span class="sxs-lookup"><span data-stu-id="70815-135">This recommendation differs from the *copy-on-write* behavior of most property handlers, in which a copy of the data is modified.</span></span> <span data-ttu-id="70815-136">Les fichiers multimédias peuvent être très volumineux. par conséquent, la copie sur écriture est généralement trop lente pour une implémentation efficace.</span><span class="sxs-lookup"><span data-stu-id="70815-136">Media files can be very large, so copy-on-write is typically too slow for an efficient implementation.</span></span> <span data-ttu-id="70815-137">Pour désactiver la copie en écriture, définissez le paramètre de Registre **ManualSafeSave** , comme décrit dans la rubrique [inscription et distribution de gestionnaires de propriétés](../properties/prophand-reg-dist.md).</span><span class="sxs-lookup"><span data-stu-id="70815-137">To disable copy-on-write, set the **ManualSafeSave** registry setting, as described in [Registering and Distributing Property Handlers](../properties/prophand-reg-dist.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="70815-138">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="70815-138">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="70815-139">Métadonnées de média</span><span class="sxs-lookup"><span data-stu-id="70815-139">Media Metadata</span></span>](media-metadata.md)
</dt> <dt>

[<span data-ttu-id="70815-140">Sources multimédias</span><span class="sxs-lookup"><span data-stu-id="70815-140">Media Sources</span></span>](media-sources.md)
</dt> <dt>

[<span data-ttu-id="70815-141">Écriture d’une source de média personnalisée</span><span class="sxs-lookup"><span data-stu-id="70815-141">Writing a Custom Media Source</span></span>](writing-a-custom-media-source.md)
</dt> </dl>

 

 
