---
description: Cette rubrique explique comment implémenter une table de Media Foundation pour la vidéo.
ms.assetid: 8ec7e678-8477-41fa-9726-54df5ed187cd
title: Direct3D-Aware MFTs
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ad50438250c0ee1627cc20aebb49262ec8eec9ac
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104524559"
---
# <a name="direct3d-aware-mfts"></a><span data-ttu-id="dfeb7-103">Direct3D-Aware MFTs</span><span class="sxs-lookup"><span data-stu-id="dfeb7-103">Direct3D-Aware MFTs</span></span>

<span data-ttu-id="dfeb7-104">Cette rubrique explique comment implémenter une table de Media Foundation *pour la vidéo* .</span><span class="sxs-lookup"><span data-stu-id="dfeb7-104">This topic describes how to implement a *Direct3D-aware* Media Foundation transform (MFT) for video.</span></span>

<span data-ttu-id="dfeb7-105">Une table MFT vidéo est considérée comme *compatible Direct3D* si elle peut traiter des exemples qui contiennent des surfaces Direct3D.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-105">An video MFT is considered *Direct3D-aware* if it can process samples that contain Direct3D surfaces.</span></span> <span data-ttu-id="dfeb7-106">La prise en charge de Direct3D dans une table MFT vidéo est généralement nécessaire pour activer le décodage accéléré par le matériel, à l’aide de l’accélération vidéo DirectX (DXVA).</span><span class="sxs-lookup"><span data-stu-id="dfeb7-106">The typical reason for supporting Direct3D in a video MFT is to enable hardware-accelerated decoding, using DirectX Video Acceleration (DXVA).</span></span>

<span data-ttu-id="dfeb7-107">Cette rubrique décrit les étapes nécessaires à la prise en charge de Direct3D MFT.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-107">This topic describes the steps that are required to make your MFT Direct3D-aware.</span></span> <span data-ttu-id="dfeb7-108">Cette rubrique ne couvre pas la mécanique du décodage DXVA.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-108">This topic does not cover the mechanics of DXVA decoding.</span></span> <span data-ttu-id="dfeb7-109">Pour plus d’informations sur DXVA, consultez [DirectX Video Acceleration 2,0](directx-video-acceleration-2-0.md).</span><span class="sxs-lookup"><span data-stu-id="dfeb7-109">For information about DXVA, see [DirectX Video Acceleration 2.0](directx-video-acceleration-2-0.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="dfeb7-110">À compter de Windows 8, [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) peut être utilisé à la place de [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9).</span><span class="sxs-lookup"><span data-stu-id="dfeb7-110">Beginning in Windows 8, [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) can be used instead of the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9).</span></span> <span data-ttu-id="dfeb7-111">Pour les applications du Windows Store, vous devez utiliser **IMFDXGIDeviceManager** et Microsoft Direct3D 11.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-111">For Windows Store apps, you must use **IMFDXGIDeviceManager** and Microsoft Direct3D 11.</span></span> <span data-ttu-id="dfeb7-112">Pour plus d’informations, consultez les [API vidéo Direct3D 11](direct3d-11-video-apis.md).</span><span class="sxs-lookup"><span data-stu-id="dfeb7-112">For more info, see the [Direct3D 11 Video APIs](direct3d-11-video-apis.md).</span></span>

 

1.  <span data-ttu-id="dfeb7-113">Implémentez la méthode [**IMFTransform :: GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) .</span><span class="sxs-lookup"><span data-stu-id="dfeb7-113">Implement the [**IMFTransform::GetAttributes**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getattributes) method.</span></span> <span data-ttu-id="dfeb7-114">Cette méthode retourne un pointeur vers un magasin d’attributs.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-114">This method returns a pointer to an attribute store.</span></span>
2.  <span data-ttu-id="dfeb7-115">La table MFT doit définir la valeur de l’attribut [**\_ prenant en \_ \_ charge Direct3D sa**](mf-sa-d3d-aware-attribute.md) sur **true** dans son propre magasin d’attributs.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-115">The MFT must set the value of the [**MF\_SA\_D3D\_AWARE**](mf-sa-d3d-aware-attribute.md) attribute to **TRUE** on its own attribute store.</span></span> <span data-ttu-id="dfeb7-116">À compter de Windows 8, si vous utilisez Direct3D 11, vous [ \_ \_ \_ devez prendre en charge la d3d11 MF](mf-sa-d3d11-aware.md).</span><span class="sxs-lookup"><span data-stu-id="dfeb7-116">Beginning in Windows 8, if using Direct3D 11 use [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md).</span></span>
3.  <span data-ttu-id="dfeb7-117">Au cours de la négociation de format, si l’attribut compatible avec la prise en [**\_ \_ \_ charge Direct3D MF**](mf-sa-d3d-aware-attribute.md) (ou [MF \_ sa \_ d3d11 \_](mf-sa-d3d11-aware.md) avec l’utilisation de Direct3D 11) a la **valeur true**, le client peut envoyer le message du [**\_ \_ \_ \_ Gestionnaire D3D du jeu de messages MFT**](mft-message-set-d3d-manager.md) à la MFT.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-117">During format negotiation, if the [**MF\_SA\_D3D\_AWARE**](mf-sa-d3d-aware-attribute.md) (or [MF\_SA\_D3D11\_AWARE](mf-sa-d3d11-aware.md) if using Direct3D 11) attribute is **TRUE**, the client may send the [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message to the MFT.</span></span> <span data-ttu-id="dfeb7-118">Le paramètre d’événement *ulParam* est un pointeur vers l’interface [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) .</span><span class="sxs-lookup"><span data-stu-id="dfeb7-118">The *ulParam* event parameter is a pointer to the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) interface.</span></span> <span data-ttu-id="dfeb7-119">À compter de Windows 8, vous pouvez utiliser [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) au lieu de **IDirect3DDeviceManager9**.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-119">Beginning in Windows 8, you can use [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) instead of **IDirect3DDeviceManager9**.</span></span> <span data-ttu-id="dfeb7-120">Le client n’est pas obligé d’envoyer ce message.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-120">The client is not required to send this message.</span></span>
4.  <span data-ttu-id="dfeb7-121">La table MFT appelle [**IDirect3DDeviceManager9 :: GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) pour effectuer une requête sur le service DXVA dont elle a besoin.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-121">The MFT calls [**IDirect3DDeviceManager9::GetVideoService**](/windows/desktop/api/dxva2api/nf-dxva2api-idirect3ddevicemanager9-getvideoservice) to query for the DXVA service it needs.</span></span> <span data-ttu-id="dfeb7-122">À compter de Windows 8, si [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) était utilisé, la MFT appelle [**IMFDXGIDeviceManager :: GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span><span class="sxs-lookup"><span data-stu-id="dfeb7-122">Beginning in Windows 8, if [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) was used the MFT calls [**IMFDXGIDeviceManager::GetVideoService**](/windows/desktop/api/mfobjects/nf-mfobjects-imfdxgidevicemanager-getvideoservice).</span></span> <span data-ttu-id="dfeb7-123">En général, un décodeur interroge pour [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice)et un processeur vidéo interroge [**IDirectXVideoProcessorService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice).</span><span class="sxs-lookup"><span data-stu-id="dfeb7-123">Typically a decoder would query for [**IDirectXVideoDecoderService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideodecoderservice), and a video processor would query for [**IDirectXVideoProcessorService**](/windows/desktop/api/dxva2api/nn-dxva2api-idirectxvideoprocessorservice).</span></span>
5.  <span data-ttu-id="dfeb7-124">En supposant que l’étape précédente est réussie, les méthodes [**IMFTransform :: GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) et [**IMFTransform :: GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) doivent retourner des formats compatibles DXVA.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-124">Assuming the previous step is successful, the [**IMFTransform::GetInputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getinputavailabletype) and [**IMFTransform::GetOutputAvailableType**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputavailabletype) methods must return DXVA-compatible formats.</span></span>
6.  <span data-ttu-id="dfeb7-125">Le client configure les types de média sur la table MFT.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-125">The client configures the media types on the MFT.</span></span> <span data-ttu-id="dfeb7-126">Si un type de média n’est pas compatible avec DXVA, le MFT doit retourner le code d’erreur **MF \_ E \_ \_ \_ type D3D non pris en charge**.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-126">If a media type is not compatible with DXVA, the MFT must return the error code **MF\_E\_UNSUPPORTED\_D3D\_TYPE**.</span></span>
7.  <span data-ttu-id="dfeb7-127">À ce stade, il existe deux options, selon que le client trouve un format DXVA approprié.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-127">At this point, there are two options, depending on whether the client finds a suitable DXVA format.</span></span>
    -   <span data-ttu-id="dfeb7-128">Si le client configure correctement un format DXVA, il peut commencer le traitement.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-128">If the client successfully configures a DXVA format, it may begin processing.</span></span> <span data-ttu-id="dfeb7-129">À ce stade, la MFT peut utiliser DXVA pour le traitement ou revenir au traitement logiciel.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-129">At this point, the MFT can use DXVA for processing, or fall back to software processing.</span></span>
    -   <span data-ttu-id="dfeb7-130">Sinon, si le client ne trouve pas de format DXVA acceptable, le client peut envoyer un autre message du [**\_ \_ \_ \_ Gestionnaire D3D de l’ensemble de messages MFT**](mft-message-set-d3d-manager.md) , ce qui affecte la **valeur null** à *ulParam* .</span><span class="sxs-lookup"><span data-stu-id="dfeb7-130">Alternatively, if the client does not find an acceptable DXVA format, the client may send another [**MFT\_MESSAGE\_SET\_D3D\_MANAGER**](mft-message-set-d3d-manager.md) message, this time setting *ulParam* to **NULL**.</span></span> <span data-ttu-id="dfeb7-131">La table MFT doit libérer le pointeur [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) (le pointeur [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) , si **IMFDXGIDeviceManager** a été utilisé) et toutes les autres interfaces DXVA, et revenir au traitement logiciel.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-131">The MFT must release the [**IDirect3DDeviceManager9**](/windows/desktop/api/dxva2api/nn-dxva2api-idirect3ddevicemanager9) pointer (the [**IMFDXGIDeviceManager**](/windows/desktop/api/mfobjects/nn-mfobjects-imfdxgidevicemanager) pointer, if **IMFDXGIDeviceManager** was used) and any other DXVA interfaces, and revert to software processing.</span></span> <span data-ttu-id="dfeb7-132">À ce stade, la MFT ne doit pas utiliser le traitement DXVA.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-132">At this point, the MFT must not use DXVA processing.</span></span>

<span data-ttu-id="dfeb7-133">Une table MFT prenant en charge Direct3D doit être préparée pour gérer les exemples qui contiennent une surface Direct3D.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-133">A Direct3D-aware MFT must be prepared to handle samples that contain a Direct3D surface.</span></span> <span data-ttu-id="dfeb7-134">L’exemple contient exactement un seul tampon de média.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-134">The sample will contain exactly one media buffer.</span></span> <span data-ttu-id="dfeb7-135">Pour récupérer la surface Direct3D à partir de la mémoire tampon, appelez la fonction [**MFGetService**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) et spécifiez le service de **\_ mémoire \_ tampon Mr** .</span><span class="sxs-lookup"><span data-stu-id="dfeb7-135">To get the Direct3D surface from the buffer, call the [**MFGetService**](/windows/desktop/api/mfidl/nf-mfidl-mfgetservice) function and specify the **MR\_BUFFER\_SERVICE** service.</span></span> <span data-ttu-id="dfeb7-136">Pour plus d’informations, consultez [DirectX surface buffer](directx-surface-buffer.md).</span><span class="sxs-lookup"><span data-stu-id="dfeb7-136">For more information, see [DirectX Surface Buffer](directx-surface-buffer.md).</span></span>

<span data-ttu-id="dfeb7-137">Une table MFT qui utilise DXVA doit allouer ses propres exemples de sortie, comme suit :</span><span class="sxs-lookup"><span data-stu-id="dfeb7-137">An MFT that uses DXVA must allocate its own output samples, as follows:</span></span>

1.  <span data-ttu-id="dfeb7-138">Dans la méthode [**IMFTransform :: GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) , le **flux de \_ sortie MFT fournit des \_ \_ \_ exemples** d’indicateurs.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-138">In the [**IMFTransform::GetOutputStreamInfo**](/windows/desktop/api/mftransform/nf-mftransform-imftransform-getoutputstreaminfo) method, set the **MFT\_OUTPUT\_STREAM\_PROVIDES\_SAMPLES** flag.</span></span>
2.  <span data-ttu-id="dfeb7-139">Créez un pool de surfaces DXVA, comme décrit dans la spécification DXVA.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-139">Create a pool of DXVA surfaces, as described in the DXVA specification.</span></span>
3.  <span data-ttu-id="dfeb7-140">Créez des exemples de supports en appelant [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface).</span><span class="sxs-lookup"><span data-stu-id="dfeb7-140">Create media samples by calling [**MFCreateVideoSampleFromSurface**](/windows/desktop/api/evr/nc-evr-mfcreatevideosamplefromsurface).</span></span>

<span data-ttu-id="dfeb7-141">La table MFT doit toujours prendre en charge le traitement logiciel comme secours, car le traitement DXVA peut ne pas être disponible pour plusieurs raisons :</span><span class="sxs-lookup"><span data-stu-id="dfeb7-141">The MFT should always support software processing as a fallback, because DXVA processing might not available, for several reasons:</span></span>

-   <span data-ttu-id="dfeb7-142">Le GPU ne prend peut-être pas en charge DXVA.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-142">The GPU might not support DXVA.</span></span>
-   <span data-ttu-id="dfeb7-143">Le client peut ne pas utiliser Direct3D.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-143">The client might not use Direct3D.</span></span>
-   <span data-ttu-id="dfeb7-144">Les profils DXVA ne sont pas définis pour chaque format vidéo.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-144">DXVA profiles are not defined for every video format.</span></span>

<span data-ttu-id="dfeb7-145">Une table MFT prenant en charge Direct3D doit avoir un seul flux de sortie.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-145">A Direct3D-aware MFT must have a single output stream.</span></span> <span data-ttu-id="dfeb7-146">Il ne peut pas avoir plusieurs sorties.</span><span class="sxs-lookup"><span data-stu-id="dfeb7-146">It cannot have multiple outputs.</span></span>

## <a name="related-topics"></a><span data-ttu-id="dfeb7-147">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="dfeb7-147">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="dfeb7-148">Écriture d’une table MFT personnalisée</span><span class="sxs-lookup"><span data-stu-id="dfeb7-148">Writing a Custom MFT</span></span>](writing-a-custom-mft.md)
</dt> </dl>

 

 



