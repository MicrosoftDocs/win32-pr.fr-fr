---
title: Authentification (BITS)
description: BITS prend en charge l’authentification de base, l’authentification Passport et plusieurs schémas d’authentification stimulation/réponse.
ms.assetid: cfd4aec3-79d0-4971-93f8-df797e5c0f75
ms.topic: article
ms.date: 10/09/2018
ms.openlocfilehash: 5d970956676a3348dd4b8c4b420e044bd4714775
ms.sourcegitcommit: 8fa6614b715bddf14648cce36d2df22e5232801a
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 12/10/2020
ms.locfileid: "103941568"
---
# <a name="authentication-bits"></a><span data-ttu-id="b9a40-103">Authentification (BITS)</span><span class="sxs-lookup"><span data-stu-id="b9a40-103">Authentication (BITS)</span></span>

<span data-ttu-id="b9a40-104">BITS prend en charge l’authentification de base, l’authentification Passport et plusieurs schémas d’authentification stimulation/réponse.</span><span class="sxs-lookup"><span data-stu-id="b9a40-104">BITS supports Basic authentication, Passport authentication, and several challenge/response authentication schemes.</span></span> <span data-ttu-id="b9a40-105">Si le serveur ou le proxy requiert l’authentification de l’utilisateur, utilisez la fonction [**IBackgroundCopyJob2 :: SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) pour spécifier les informations d’identification de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="b9a40-105">If the server or proxy requires user authentication, use the [**IBackgroundCopyJob2::SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) function to specify the user's credentials.</span></span> <span data-ttu-id="b9a40-106">Le service BITS utilise le [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) pour protéger les informations d’identification.</span><span class="sxs-lookup"><span data-stu-id="b9a40-106">BITS uses the [CryptoAPI](/windows/desktop/SecCrypto/cryptography-portal) to protect the credentials.</span></span>

<span data-ttu-id="b9a40-107">Pour définir les informations d’identification pour l’authentification de base, utilisez la fonction [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) pour spécifier le nom d’utilisateur et le mot de passe.</span><span class="sxs-lookup"><span data-stu-id="b9a40-107">To set credentials for Basic authentication use the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) function to specify the user name and password.</span></span> <span data-ttu-id="b9a40-108">Vous devez uniquement utiliser l’authentification de base avec des sites Web sécurisés protégés par https://; dans le cas contraire, le nom d’utilisateur et le mot de passe seront visibles pour les utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="b9a40-108">You should only use Basic authentication with https:// protected secure websites; otherwise the username and password will be visible to users.</span></span> 

<span data-ttu-id="b9a40-109">Il est possible d’incorporer le nom d’utilisateur et le mot de passe dans l’URL.</span><span class="sxs-lookup"><span data-stu-id="b9a40-109">It's possible to embed the user name and password in the URL.</span></span> <span data-ttu-id="b9a40-110">Cela n’est pas considéré comme une bonne pratique de sécurité et est déconseillé dans le document RFC 3986 (section 3.2.1).</span><span class="sxs-lookup"><span data-stu-id="b9a40-110">This is not considered a good security practice, and is deprecated in RFC 3986 (section 3.2.1).</span></span>

<span data-ttu-id="b9a40-111">Pour l’authentification [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) , bits prend en charge uniquement les informations d’identification explicites, pas les informations d’identification implicites liées au compte.</span><span class="sxs-lookup"><span data-stu-id="b9a40-111">For [Passport](/windows/desktop/WinHttp/passport-authentication-in-winhttp) authentication, BITS supports explicit credentials only, not implicit credentials tied to the account.</span></span>

<span data-ttu-id="b9a40-112">Pour l’authentification par stimulation/réponse, le service BITS emprunte l’identité de l’utilisateur et utilise [Snego](../com/snego.md) pour déterminer l’authentification par stimulation/réponse à utiliser, comme NTLM ou le protocole Kerberos.</span><span class="sxs-lookup"><span data-stu-id="b9a40-112">For challenge/response authentication, BITS impersonates the user and uses [Snego](../com/snego.md) to determine which challenge/response authentication to use, such as NTLM or the Kerberos protocol.</span></span> <span data-ttu-id="b9a40-113">Pour obtenir la liste des schémas de stimulation/réponse pris en charge par BITS, consultez [**\_ \_ schéma d’authentification BG**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme).</span><span class="sxs-lookup"><span data-stu-id="b9a40-113">For a list of challenge/response schemes that BITS supports, see [**BG\_AUTH\_SCHEME**](/windows/desktop/api/Bits1_5/ne-bits1_5-bg_auth_scheme).</span></span>

<span data-ttu-id="b9a40-114">Les tâches BITS peuvent échouer si le répertoire virtuel sur le serveur a une authentification anonyme et qu’un autre schéma d’authentification est activé et que les listes de contrôle d’accès protègent le répertoire virtuel ou téléchargent les fichiers.</span><span class="sxs-lookup"><span data-stu-id="b9a40-114">BITS jobs can fail if the virtual directory on the server has anonymous authentication and another authentication scheme enabled and if ACLs protect the virtual directory or download files.</span></span> <span data-ttu-id="b9a40-115">Par exemple, un travail échoue avec « accès refusé » si l’authentification anonyme et l’authentification intégrée du répertoire virtuel sont activées et si le fichier contient une liste de contrôle d’accès qui autorise uniquement Ben à lire le fichier.</span><span class="sxs-lookup"><span data-stu-id="b9a40-115">For example, a job fails with "access denied" if the virtual directory has anonymous and integrated authentication enabled and the file contains an ACL that allows only Ben to read the file.</span></span> <span data-ttu-id="b9a40-116">Cela est dû au fait que le répertoire virtuel autorise l’accès anonyme. par conséquent, IIS n’authentifie pas explicitement Ben (les informations d’identification de l’Olivier ne sont pas utilisées pour accéder au fichier et l’accès est refusé).</span><span class="sxs-lookup"><span data-stu-id="b9a40-116">This occurs because the virtual directory allows anonymous access, so IIS does not explicitly authenticate Ben (Ben's credentials are not used to access the file and access is denied).</span></span>

## <a name="using-implicit-credentials"></a><span data-ttu-id="b9a40-117">Utilisation d’informations d’identification implicites</span><span class="sxs-lookup"><span data-stu-id="b9a40-117">Using implicit credentials</span></span>

<span data-ttu-id="b9a40-118">Pour utiliser les informations d’identification implicites (Logon) de l’utilisateur pour l’authentification NTLM ou Kerberos, appelez la méthode [**IBackgroundCopyJob2 :: SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) et définissez les membres **nom d’utilisateur** et **mot de passe** de la structure des [**\_ \_ informations d’identification de base BG**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials) sur la **valeur null**.</span><span class="sxs-lookup"><span data-stu-id="b9a40-118">To use the user's implicit (logon) credentials for NTLM or Kerberos authentication, call the [**IBackgroundCopyJob2::SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method and set the **UserName** and **Password** members of the [**BG\_BASIC\_CREDENTIALS**](/windows/desktop/api/Bits1_5/ns-bits1_5-bg_basic_credentials) structure to **NULL**.</span></span> <span data-ttu-id="b9a40-119">Si vous spécifiez des informations d’identification implicites pour un proxy, BITS utilise également les informations d’identification implicites pour l’authentification du serveur, sauf si vous spécifiez des informations d’identification de serveur explicites.</span><span class="sxs-lookup"><span data-stu-id="b9a40-119">If you specify implicit credentials for a proxy, BITS will also use the implicit credentials for server authentication unless you specify explicit server credentials.</span></span>

<span data-ttu-id="b9a40-120">Pour plus d’informations sur les services, consultez [comptes de service et bits](service-accounts-and-bits.md).</span><span class="sxs-lookup"><span data-stu-id="b9a40-120">For additional information for services, see [Service Accounts and BITS](service-accounts-and-bits.md).</span></span>

<span data-ttu-id="b9a40-121">Vous pouvez également modifier la valeur de Registre **LmCompatibilityLevel** ou **UseLMCompat** . Toutefois, vous ne devez modifier ces valeurs que si vous disposez d’une application existante qui ne peut pas être modifiée pour appeler la méthode [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="b9a40-121">You could also change the **LMCompatibilityLevel** or **UseLMCompat** registry value; however, you should change these values only if you have an existing application that cannot be changed to call the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span>

<span data-ttu-id="b9a40-122">BITS utilisera des informations d’identification implicites pour l’authentification si la valeur de Registre **LmCompatibilityLevel** est supérieure ou égale à deux, et que vous n’avez pas appelé la méthode [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="b9a40-122">BITS will use implicit credentials for authentication if the **LMCompatibilityLevel** registry value is two or greater, and you have not called the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span> <span data-ttu-id="b9a40-123">Le chemin d’accès complet à la valeur de Registre **LmCompatibilityLevel** est **HKEY \_ local \_ machine** \\ **System** \\ **CurrentControlSet** \\ **Control** \\ **LSA** \\ **LmCompatibilityLevel**.</span><span class="sxs-lookup"><span data-stu-id="b9a40-123">The full path to the **LMCompatibilityLevel** registry value is **HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Control**\\**LSA**\\**LmCompatibilityLevel**.</span></span>

<span data-ttu-id="b9a40-124">Notez que la modification de la valeur de Registre **LmCompatibilityLevel** peut affecter les autres applications et services exécutés sur l’ordinateur.</span><span class="sxs-lookup"><span data-stu-id="b9a40-124">Note that changing the **LMCompatibilityLevel** registry value can affect other applications and services running on the computer.</span></span> <span data-ttu-id="b9a40-125">Pour plus d’informations sur l’utilisation de la valeur de Registre **LmCompatibilityLevel** , consultez [KB147706](https://support.microsoft.com/kb/147706).</span><span class="sxs-lookup"><span data-stu-id="b9a40-125">For more information about using the **LMCompatibilityLevel** registry value, see [KB147706](https://support.microsoft.com/kb/147706).</span></span>

<span data-ttu-id="b9a40-126">Si la définition de la valeur de Registre **LmCompatibilityLevel** est un problème, vous pouvez créer la valeur de Registre **UseLMCompat** sous **HKEY \_ local \_ machine** \\ **Software** \\ **Microsoft** \\ **Windows** \\ **CurrentVersion** \\ **bits**.</span><span class="sxs-lookup"><span data-stu-id="b9a40-126">If setting the **LMCompatibilityLevel** registry value is an issue, you can create the **UseLMCompat** registry value under **HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Windows**\\**CurrentVersion**\\**BITS**.</span></span> <span data-ttu-id="b9a40-127">La valeur de Registre est un DWORD.</span><span class="sxs-lookup"><span data-stu-id="b9a40-127">The registry value is a DWORD.</span></span> <span data-ttu-id="b9a40-128">Le tableau suivant répertorie les valeurs possibles pour **UseLMCompat**:</span><span class="sxs-lookup"><span data-stu-id="b9a40-128">The following table lists the possible values for **UseLMCompat**:</span></span>

|<span data-ttu-id="b9a40-129">Valeur</span><span class="sxs-lookup"><span data-stu-id="b9a40-129">Value</span></span>|<span data-ttu-id="b9a40-130">Description</span><span class="sxs-lookup"><span data-stu-id="b9a40-130">Description</span></span>|
|-|-|
| <span data-ttu-id="b9a40-131">0</span><span class="sxs-lookup"><span data-stu-id="b9a40-131">0</span></span>     | <span data-ttu-id="b9a40-132">BITS enverra des informations d’identification implicites chaque fois que le serveur demande des informations d’identification NTLM ou Kerberos.</span><span class="sxs-lookup"><span data-stu-id="b9a40-132">BITS will send implicit credentials whenever the server prompts for NTLM or Kerberos credentials.</span></span>                                                                                           |
| <span data-ttu-id="b9a40-133">1</span><span class="sxs-lookup"><span data-stu-id="b9a40-133">1</span></span>     | <span data-ttu-id="b9a40-134">BITS enverra des informations d’identification implicites uniquement si la valeur de Registre **LmCompatibilityLevel** de l’ordinateur client est supérieure ou égale à 2.</span><span class="sxs-lookup"><span data-stu-id="b9a40-134">BITS will send implicit credentials only if the client computer's **LMCompatibilityLevel** registry value is greater than or equal to 2.</span></span><br/>     |
| <span data-ttu-id="b9a40-135">2</span><span class="sxs-lookup"><span data-stu-id="b9a40-135">2</span></span>     | <span data-ttu-id="b9a40-136">BITS enverra des informations d’identification implicites uniquement si l’application a appelé la méthode [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) .</span><span class="sxs-lookup"><span data-stu-id="b9a40-136">BITS will send implicit credentials only if the application called the [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method.</span></span><br/> |

<span data-ttu-id="b9a40-137">Le service BITS utilise la valeur par défaut « 2 » pour la valeur de Registre **UseLMCompat** si la valeur de Registre n’existe pas.</span><span class="sxs-lookup"><span data-stu-id="b9a40-137">BITS will use a default value of "2" for the **UseLMCompat** registry value if the registry value does not exist.</span></span>

## <a name="using-certificates-for-clientserver-authentication"></a><span data-ttu-id="b9a40-138">Utilisation de certificats pour l’authentification client/serveur</span><span class="sxs-lookup"><span data-stu-id="b9a40-138">Using certificates for client/server authentication</span></span>

<span data-ttu-id="b9a40-139">Dans une communication sécurisée de client/serveur, les clients et les serveurs peuvent utiliser des certificats numériques pour s’authentifier mutuellement.</span><span class="sxs-lookup"><span data-stu-id="b9a40-139">In secure client/server communication, clients and servers can use digital certificates to mutually authenticate each other.</span></span> <span data-ttu-id="b9a40-140">BITS prend automatiquement en charge l’authentification du serveur basée sur des certificats pour les transports HTTP sécurisés.</span><span class="sxs-lookup"><span data-stu-id="b9a40-140">BITS automatically supports certificate-based server authentication for secure HTTP transports.</span></span> <span data-ttu-id="b9a40-141">Pour fournir à BITS le certificat client nécessaire pour l’authentification mutuelle, appelez la méthode [**IBackgroundCopyJobHttpOptions :: SetClientCertificateByID**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) ou [**IBackgroundCopyJobHttpOptions :: SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) .</span><span class="sxs-lookup"><span data-stu-id="b9a40-141">To provide BITS the client certificate needed for mutual authentication, call either the [**IBackgroundCopyJobHttpOptions::SetClientCertificateByID**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyid) or [**IBackgroundCopyJobHttpOptions::SetClientCertificateByName**](/windows/desktop/api/Bits2_5/nf-bits2_5-ibackgroundcopyjobhttpoptions-setclientcertificatebyname) method.</span></span>

<span data-ttu-id="b9a40-142">Lorsqu’un site Web accepte, mais ne nécessite pas de certificat client SSL, et que le travail BITS ne spécifie pas de certificat client, le travail échoue avec le certificat d' **\_ authentification du \_ client WinHTTP \_ \_ \_ nécessaire** (0x80072f0c).</span><span class="sxs-lookup"><span data-stu-id="b9a40-142">When a website accepts but does not require an SSL client certificate, and the BITS job does not specify a client certificate, the job will fail with **ERROR\_WINHTTP\_CLIENT\_AUTH\_CERT\_NEEDED** (0x80072f0c).</span></span>

## <a name="how-to-handle-authenticated-proxy-scenarios-that-require-user-specific-settings"></a><span data-ttu-id="b9a40-143">Comment gérer les scénarios de proxy authentifiés qui requièrent des paramètres spécifiques à l’utilisateur</span><span class="sxs-lookup"><span data-stu-id="b9a40-143">How to handle authenticated proxy scenarios that require user-specific settings</span></span>

<span data-ttu-id="b9a40-144">Si vous utilisez BITS dans un environnement qui requiert l’authentification du proxy lors de l’exécution en tant que compte sans informations d’identification NTLM ou Kerberos utilisables dans le domaine réseau de l’ordinateur, vous devez effectuer des étapes supplémentaires pour vous authentifier correctement à l’aide des informations d’identification d’un autre compte d’utilisateur qui possède des informations d’identification sur le domaine.</span><span class="sxs-lookup"><span data-stu-id="b9a40-144">If you are using BITS in an environment that requires proxy authentication while running as an account without usable NTLM or Kerberos credentials in the machine's network domain, you must take extra steps to authenticate properly by using the credentials of another user account that does have credentials on the domain.</span></span> <span data-ttu-id="b9a40-145">Il s’agit d’un scénario classique dans lequel votre code BITS s’exécute en tant que service système tel que LocalService, NetworkService ou LocalSystem, car ces comptes n’ont pas d’informations d’identification NTLM ou Kerberos utilisables.</span><span class="sxs-lookup"><span data-stu-id="b9a40-145">This is a typical scenario when your BITS code is running as a system service such as LocalService, NetworkService, or LocalSystem, as those accounts do not have usable NTLM or Kerberos credentials.</span></span>

<span data-ttu-id="b9a40-146">La logique de détection de proxy utilisée dans le service BITS effectue les opérations suivantes lorsqu’un jeton d’assistance réseau ( \_ réseau de jetons BG \_ ) est défini :</span><span class="sxs-lookup"><span data-stu-id="b9a40-146">The proxy detection logic used in BITS does the following when a network helper token (BG\_TOKEN\_NETWORK) is set:</span></span>

-   <span data-ttu-id="b9a40-147">Si [**méthode ibackgroundcopyjob :: setproxysettings n'**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) a été appelé avec la **\_ \_ \_ \_ préconfiguration de l’utilisation du proxy de tâche BG**, lisez les paramètres du proxy IE local à l’aide de l’emprunt d’identité du contexte de jeton de propriétaire de tâche via [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="b9a40-147">If [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) was called with **BG\_JOB\_PROXY\_USAGE\_PRECONFIG**, then read local IE proxy settings using job owner token context impersonation via [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span> <span data-ttu-id="b9a40-148">À partir de Windows 10, version 1809 (10,0 ; Build 17763), l’identité du jeton d’assistance est utilisée pour cette étape.</span><span class="sxs-lookup"><span data-stu-id="b9a40-148">Starting in Windows 10, version 1809 (10.0; Build 17763), the helper token identity is used for this step.</span></span>
-   <span data-ttu-id="b9a40-149">Si [**méthode ibackgroundcopyjob :: setproxysettings n'**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) a été appelé avec la détection automatique de l' **\_ utilisation du proxy \_ \_ BG** ou si les paramètres IE de la **tâche BG configuration de l’utilisation du proxy de la \_ tâche \_ \_ \_ BG** spécifient la détection automatique ou une URL de configuration automatique, effectuent la détection automatique de proxy ou le protocole WPAD (Web proxy AutoDiscovery Protocol) à [**l’aide de**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl)l’emprunt d’identité du jeton d’assistance via</span><span class="sxs-lookup"><span data-stu-id="b9a40-149">If [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) was called with **BG\_PROXY\_USAGE\_AUTODETECT** or if the IE settings from the **BG\_JOB\_PROXY\_USAGE\_PRECONFIG** case specify auto-detect or an auto-config URL, then conduct auto-proxy detection, or Web Proxy Autodiscovery Protocol (WPAD), using helper token impersonation via [**WinHttpGetProxyForUrl**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetproxyforurl).</span></span>

<span data-ttu-id="b9a40-150">Après cela, l’emprunt d’identité du jeton d’assistance est utilisé pour l’authentification du proxy ou du serveur dans.</span><span class="sxs-lookup"><span data-stu-id="b9a40-150">After that, helper token impersonation is used for proxy or server authentication throughout.</span></span>

<span data-ttu-id="b9a40-151">À partir de Windows 10, version 1809 (10,0 ; Build 17763), le scénario de proxy authentifié avec des informations d’identification spécifiques à l’utilisateur est simplifié.</span><span class="sxs-lookup"><span data-stu-id="b9a40-151">Starting in Windows 10, version 1809 (10.0; Build 17763), the authenticated proxy scenario with user-specific credentials is simplified.</span></span>

1.  <span data-ttu-id="b9a40-152">Appelez la méthode [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) de la tâche bits avec le **schéma d' \_ authentification BG \_ \_ Negotiate**, le *nom d’utilisateur* ayant la valeur **null**, le *mot de passe* défini sur **null** et la *cible* sur le **\_ \_ \_ proxy de cible d’authentification BG**.</span><span class="sxs-lookup"><span data-stu-id="b9a40-152">Call the BITS job's [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method with **BG\_AUTH\_SCHEME\_NEGOTIATE**, *UserName* set to **NULL**, *Password* set to **NULL**, and *Target* set to **BG\_AUTH\_TARGET\_PROXY**.</span></span> <span data-ttu-id="b9a40-153">Cela entraîne l’utilisation des informations d’identification implicites du compte d’utilisateur pour l’authentification NTLM et Kerberos avec le proxy et le serveur.</span><span class="sxs-lookup"><span data-stu-id="b9a40-153">This causes the user account's implicit credentials to be used for NTLM and Kerberos authentication with the proxy and server.</span></span>
2.  <span data-ttu-id="b9a40-154">Appelez [**méthode ibackgroundcopyjob :: setproxysettings n'**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) avec **la \_ \_ \_ \_ préconfiguration de l’utilisation du proxy de tâche BG**.</span><span class="sxs-lookup"><span data-stu-id="b9a40-154">Call [**IBackgroundCopyJob::SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with **BG\_JOB\_PROXY\_USAGE\_PRECONFIG**.</span></span>
3.  <span data-ttu-id="b9a40-155">QueryInterface pour [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="b9a40-155">QueryInterface for [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span>
4.  <span data-ttu-id="b9a40-156">Emprunter l’identité du compte d’utilisateur que vous utilisez pour les informations d’identification NTLM/Kerberos.</span><span class="sxs-lookup"><span data-stu-id="b9a40-156">Impersonate the user account you're using for NTLM/Kerberos credentials.</span></span>
5.  <span data-ttu-id="b9a40-157">Appelez [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span><span class="sxs-lookup"><span data-stu-id="b9a40-157">Call [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span></span>
6. <span data-ttu-id="b9a40-158">Appelez [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) avec **le \_ \_ réseau de jetons BG**.</span><span class="sxs-lookup"><span data-stu-id="b9a40-158">Call [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) with **BG\_TOKEN\_NETWORK**.</span></span>
7. <span data-ttu-id="b9a40-159">Rétablissez l’emprunt d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9a40-159">Revert impersonation.</span></span>
8. <span data-ttu-id="b9a40-160">Poursuivez la configuration de la tâche.</span><span class="sxs-lookup"><span data-stu-id="b9a40-160">Continue job setup.</span></span>
9. <span data-ttu-id="b9a40-161">Appelez [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) sur le travail.</span><span class="sxs-lookup"><span data-stu-id="b9a40-161">Call [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) on the job.</span></span>

<span data-ttu-id="b9a40-162">Avant Windows 10, version 1809 (10,0 ; Build 17763), l’identité de l’utilisateur correcte (identité du jeton d’assistance) est utilisée pour la détection du proxy basé sur le réseau (WPAD) et pour l’authentification du proxy, mais la détection réelle des paramètres du proxy local (IE) est toujours effectuée à l’aide du jeton du propriétaire du travail, même lorsqu’un jeton d’assistance est configuré.</span><span class="sxs-lookup"><span data-stu-id="b9a40-162">Before Windows 10, version 1809 (10.0; Build 17763), the correct user identity (the helper token's identity) is used for network-based proxy detection (WPAD) and for proxy authentication, but the actual detection of local (IE) proxy settings is always done using the job owner's token, even when a helper token is configured.</span></span> <span data-ttu-id="b9a40-163">Pour contourner ce manque, vous pouvez suivre ces étapes.</span><span class="sxs-lookup"><span data-stu-id="b9a40-163">To work around this shortcoming, you can follow these steps.</span></span>

1.  <span data-ttu-id="b9a40-164">Emprunter l’identité du compte d’utilisateur que vous utilisez pour les informations d’identification NTLM/Kerberos.</span><span class="sxs-lookup"><span data-stu-id="b9a40-164">Impersonate the user account you're using for NTLM/Kerberos credentials.</span></span>
2.  <span data-ttu-id="b9a40-165">Récupérez les paramètres du proxy IE du compte d’utilisateur en appelant [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span><span class="sxs-lookup"><span data-stu-id="b9a40-165">Retrieve the user account's IE proxy settings by calling [**WinHttpGetIEProxyConfigForCurrentUser**](/windows/desktop/api/winhttp/nf-winhttp-winhttpgetieproxyconfigforcurrentuser).</span></span>
3.  <span data-ttu-id="b9a40-166">Rétablissez l’emprunt d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9a40-166">Revert impersonation.</span></span>
4.  <span data-ttu-id="b9a40-167">Appelez la méthode [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) de la tâche bits avec le **schéma d' \_ authentification BG \_ \_ Negotiate**, le *nom d’utilisateur* ayant la valeur **null**, le *mot de passe* défini sur **null** et la *cible* sur le **\_ \_ \_ proxy de cible d’authentification BG**.</span><span class="sxs-lookup"><span data-stu-id="b9a40-167">Call the BITS job's [**SetCredentials**](/windows/desktop/api/Bits1_5/nf-bits1_5-ibackgroundcopyjob2-setcredentials) method with **BG\_AUTH\_SCHEME\_NEGOTIATE**, *UserName* set to **NULL**, *Password* set to **NULL**, and *Target* set to **BG\_AUTH\_TARGET\_PROXY**.</span></span> <span data-ttu-id="b9a40-168">Cela entraîne l’utilisation des informations d’identification implicites du compte d’utilisateur pour l’authentification NTLM et Kerberos avec le proxy et le serveur.</span><span class="sxs-lookup"><span data-stu-id="b9a40-168">This causes the user account's implicit credentials to be used for NTLM and Kerberos authentication with the proxy and server.</span></span>
5.  <span data-ttu-id="b9a40-169">Si l’étape 2 a généré des paramètres de proxy spécifiques à l’utilisateur (par exemple, *lpszProxy* ou *lpszProxyBypass* n’ont pas la **valeur null**), définissez manuellement les paramètres de travail correspondants à l’aide de [**setproxysettings n'**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) avec le paramètre de **\_ \_ \_ \_ remplacement utilisation du proxy de tâche BG** .</span><span class="sxs-lookup"><span data-stu-id="b9a40-169">If step 2 yielded any user-specific proxy settings (i.e. *lpszProxy* or *lpszProxyBypass* are not **NULL**), set the corresponding job settings manually, using [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with the **BG\_JOB\_PROXY\_USAGE\_OVERRIDE** setting.</span></span>
6.  <span data-ttu-id="b9a40-170">Si l’étape 2 n’a pas produit de paramètres de proxy spécifiques à l’utilisateur, appelez [**setproxysettings n'**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) avec la **\_ \_ \_ préconfiguration de l’utilisation du travail BG**.</span><span class="sxs-lookup"><span data-stu-id="b9a40-170">If step 2 did not yield any user-specific proxy settings, call [**SetProxySettings**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-setproxysettings) with **BG\_JOB\_USAGE\_PRECONFIG**.</span></span>
7.  <span data-ttu-id="b9a40-171">QueryInterface pour [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="b9a40-171">QueryInterface for [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span>
8.  <span data-ttu-id="b9a40-172">Emprunter à nouveau le compte d’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="b9a40-172">Impersonate the user account again.</span></span>
9.  <span data-ttu-id="b9a40-173">Appelez [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span><span class="sxs-lookup"><span data-stu-id="b9a40-173">Call [**SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken).</span></span>
10. <span data-ttu-id="b9a40-174">Appelez [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) avec **le \_ \_ réseau de jetons BG**.</span><span class="sxs-lookup"><span data-stu-id="b9a40-174">Call [**SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) with **BG\_TOKEN\_NETWORK**.</span></span>
11. <span data-ttu-id="b9a40-175">Rétablissez l’emprunt d’identité.</span><span class="sxs-lookup"><span data-stu-id="b9a40-175">Revert impersonation.</span></span>
12. <span data-ttu-id="b9a40-176">Poursuivez la configuration de la tâche.</span><span class="sxs-lookup"><span data-stu-id="b9a40-176">Continue job setup.</span></span>
13. <span data-ttu-id="b9a40-177">Appelez [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) sur le travail.</span><span class="sxs-lookup"><span data-stu-id="b9a40-177">Call [**Resume**](/windows/desktop/api/Bits/nf-bits-ibackgroundcopyjob-resume) on the job.</span></span>
