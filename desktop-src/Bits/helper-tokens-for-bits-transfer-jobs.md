---
title: Jetons d’assistance pour les tâches de transfert BITS
description: Jetons d’assistance pour les tâches de transfert BITS
ms.assetid: f29f9870-e406-472b-9342-203def7453ae
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 52925a6e0d5a9601e21848d514214bfb843f6246
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/20/2020
ms.locfileid: "104463683"
---
# <a name="helper-tokens-for-bits-transfer-jobs"></a><span data-ttu-id="8d327-103">Jetons d’assistance pour les tâches de transfert BITS</span><span class="sxs-lookup"><span data-stu-id="8d327-103">Helper Tokens for BITS Transfer Jobs</span></span>

<span data-ttu-id="8d327-104">Dans Windows Vista, le service Service de transfert intelligent en arrière-plan (BITS) permet à une application d’associer un jeton de sécurité unique à une tâche de transfert BITS.</span><span class="sxs-lookup"><span data-stu-id="8d327-104">In Windows Vista, the Background Intelligent Transfer Service (BITS) service allows an application to associate a single security token to a BITS transfer job.</span></span> <span data-ttu-id="8d327-105">La tâche de transfert BITS utilise ensuite ce jeton pour l’authentification et l’accès aux ressources locales et distantes.</span><span class="sxs-lookup"><span data-stu-id="8d327-105">The BITS transfer job then uses this token for authentication and for access to local and remote resources.</span></span>

<span data-ttu-id="8d327-106">Dans Windows 7, le service BITS associe un jeton supplémentaire à une tâche de transfert BITS.</span><span class="sxs-lookup"><span data-stu-id="8d327-106">In Windows 7, the BITS service associates an additional token to a BITS transfer job.</span></span> <span data-ttu-id="8d327-107">La tâche de transfert BITS peut être configurée avec un jeton de sécurité supplémentaire, qui est un jeton d’emprunt d’identité créé par une application appelant l’API COM BITS.</span><span class="sxs-lookup"><span data-stu-id="8d327-107">The BITS transfer job can be configured with an additional security token, which is an impersonation token created by an application calling the BITS COM API.</span></span> <span data-ttu-id="8d327-108">Ce modèle de jeton d’assistance permet aux applications d’utiliser simultanément deux jetons de sécurité différents pour accéder à des fichiers locaux, à des certificats côté client, à des fichiers distants et à des proxies.</span><span class="sxs-lookup"><span data-stu-id="8d327-108">This helper token model allows applications to simultaneously use two different security tokens to access local files, client-side certificates, remote files, and proxies.</span></span> <span data-ttu-id="8d327-109">Par exemple, une tâche de transfert BITS est créée, qui écrit les données téléchargées dans un répertoire local privilégié, puis présente une identité de domaine à faibles privilèges pour le serveur HTTP et le serveur proxy.</span><span class="sxs-lookup"><span data-stu-id="8d327-109">For example, a BITS transfer job is created that writes the downloaded data to a privileged local directory, and then it presents a low-rights domain identity to the HTTP server and proxy server.</span></span>

<span data-ttu-id="8d327-110">Une application, généralement un service Windows, spécifie un jeton d’assistance à l’aide de la nouvelle interface [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span><span class="sxs-lookup"><span data-stu-id="8d327-110">An application, typically a Windows service, specifies a helper token by using the new interface [**IBitsTokenOptions**](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions).</span></span> <span data-ttu-id="8d327-111">Cette interface est implémentée par l’objet de traitement BITS.</span><span class="sxs-lookup"><span data-stu-id="8d327-111">This interface is implemented by the BITS job object.</span></span> <span data-ttu-id="8d327-112">L’application appelle [**méthode ibackgroundcopyjob :: QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) pour recevoir le pointeur d’interface.</span><span class="sxs-lookup"><span data-stu-id="8d327-112">The application calls [**IBackgroundCopyJob::QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) to get the interface pointer.</span></span> <span data-ttu-id="8d327-113">L’application emprunte l’identité de l’identité de l’assistance et appelle [**IBitsTokenOptions :: SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) pour transmettre le jeton au service bits.</span><span class="sxs-lookup"><span data-stu-id="8d327-113">The application impersonates the helper identity and calls [**IBitsTokenOptions::SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) to pass the token to the BITS service.</span></span> <span data-ttu-id="8d327-114">L’application spécifie ensuite les ressources auxquelles le jeton s’applique en passant un jeu d’indicateurs binaires à l’aide de [**IBitsTokenOptions :: SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags).</span><span class="sxs-lookup"><span data-stu-id="8d327-114">Then the application specifies the resources to which the token applies by passing a set of bit flags using [**IBitsTokenOptions::SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags).</span></span> <span data-ttu-id="8d327-115">L’application efface tous les indicateurs (à l’aide de **SetHelperTokenFlags** ) pour rétablir le comportement.</span><span class="sxs-lookup"><span data-stu-id="8d327-115">The application clears all the flags (using **SetHelperTokenFlags** again) to revert the behavior.</span></span> <span data-ttu-id="8d327-116">Le service BITS stocke les indicateurs de bits et le jeton dans la tâche de transfert BITS.</span><span class="sxs-lookup"><span data-stu-id="8d327-116">The BITS service stores the bit flags and the token in the BITS transfer job.</span></span>

<span data-ttu-id="8d327-117">Lorsque le propriétaire des tâches de transfert BITS se déconnecte, le service BITS ignore les jetons d’assistance associés à la tâche de transfert.</span><span class="sxs-lookup"><span data-stu-id="8d327-117">When the owner of the BITS transfer jobs logs off, the BITS service discards any helper tokens that are associated with the transfer job.</span></span> <span data-ttu-id="8d327-118">Si le transfert n’est pas terminé, le service BITS place le travail dans un état d’erreur avec le code d’erreur **BG \_ E \_ Token \_ requis** et ignore le jeton d’assistance.</span><span class="sxs-lookup"><span data-stu-id="8d327-118">If the transfer is not complete, the BITS service places the job in an error state with the **BG\_E\_TOKEN\_REQUIRED** error code and discards the helper token.</span></span> <span data-ttu-id="8d327-119">L’application cliente peut actualiser le jeton en appelant [**IBitsTokenOptions :: SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) et peut ensuite reprendre la tâche de transfert bits.</span><span class="sxs-lookup"><span data-stu-id="8d327-119">The client application can refresh the token by calling [**IBitsTokenOptions::SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) and can then resume the BITS transfer job.</span></span> <span data-ttu-id="8d327-120">L’application cliente peut également effacer les indicateurs de jeton d’assistance à l’aide de [**IBitsTokenOptions :: SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) , puis reprendre la tâche de transfert sans jeton d’assistance.</span><span class="sxs-lookup"><span data-stu-id="8d327-120">Alternatively, the client application can clear the helper token flags using [**IBitsTokenOptions::SetHelperTokenFlags**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertokenflags) and then resume the transfer job without a helper token.</span></span>

<span data-ttu-id="8d327-121">De même, lorsque le propriétaire d’une session des services Terminal Server se déconnecte, le service BITS doit supprimer tous les jetons d’assistance de cette session et placer les tâches de transfert affectées dans un état d’erreur avec le code d’erreur **BG \_ E \_ Token \_ requis** .</span><span class="sxs-lookup"><span data-stu-id="8d327-121">Similarly, when the owner of a terminal services session logs off, the BITS service must discard any helper tokens from that session and place the affected transfer jobs in an error state with the **BG\_E\_TOKEN\_REQUIRED** error code.</span></span>

<span data-ttu-id="8d327-122">Le modèle de jeton d’assistance nécessite une modification de la stratégie de contrôle d’accès BITS.</span><span class="sxs-lookup"><span data-stu-id="8d327-122">The helper token model requires a change to BITS access control policy.</span></span> <span data-ttu-id="8d327-123">Les versions précédentes de BITS implémentaient des contrôles d’accès à chaque appel de méthode.</span><span class="sxs-lookup"><span data-stu-id="8d327-123">Previous versions of BITS implemented access checks on every method call.</span></span> <span data-ttu-id="8d327-124">À compter de Windows 7, le contrôle d’accès doit être effectué à l’intérieur de l’appel [**méthode ibackgroundcopyjob :: QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) ; dans le cas contraire, le jeton d’assistance peut ne pas avoir accès à la tâche de transfert.</span><span class="sxs-lookup"><span data-stu-id="8d327-124">Starting with Windows 7, the access check must be performed inside the [**IBackgroundCopyJob::QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) call; otherwise, the helper token might not have access to the transfer job.</span></span>

> [!Note]  
> <span data-ttu-id="8d327-125">Les implémentations plus anciennes nécessitaient efficacement que les utilisateurs du service BITS disposent de privilèges d’administrateur pour définir des jetons d’assistance.</span><span class="sxs-lookup"><span data-stu-id="8d327-125">Older implementations effectively required that BITS users have administrator privileges in order to set helper tokens.</span></span> <span data-ttu-id="8d327-126">À compter de Windows 10, version 1607, les BITS non-administrateurs peuvent utiliser [**IBitsTokenOptions :: SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) pour définir des jetons d’assistance non-administrateur sur les travaux bits qu’ils possèdent.</span><span class="sxs-lookup"><span data-stu-id="8d327-126">Starting with Windows 10, version 1607, non-administrator BITS users can use [**IBitsTokenOptions::SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) to set non-administrator helper tokens on BITS jobs they own.</span></span> <span data-ttu-id="8d327-127">Cette modification permet aux utilisateurs non-administrateurs BITS (tels que les services de téléchargeur en arrière-plan s’exécutant sous le [compte NetworkService](/windows/desktop/Services/networkservice-account)) de définir des jetons d’assistance.</span><span class="sxs-lookup"><span data-stu-id="8d327-127">This change enables non-administrator BITS users (such as background downloader services running under the [NetworkService account](/windows/desktop/Services/networkservice-account)) to set helper tokens.</span></span>
>
> <span data-ttu-id="8d327-128">Plus précisément, l’implémentation a été modifiée pour permettre aux utilisateurs dépourvus de privilèges d’administrateur de définir des jetons d’assistance, à condition que les conditions suivantes soient remplies :</span><span class="sxs-lookup"><span data-stu-id="8d327-128">Specifically, the implementation has been changed to allow users without administrator privileges to set helper tokens, as long as the following conditions are met:</span></span>
>
> -   <span data-ttu-id="8d327-129">pendant l’appel de [**méthode ibackgroundcopyjob :: QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) , le SID du jeton thread’s de l’appelant est le même que le SID du compte d’utilisateur du propriétaire du travail, et</span><span class="sxs-lookup"><span data-stu-id="8d327-129">during the [**IBackgroundCopyJob::QueryInterface**](/windows/desktop/api/Bits/nn-bits-ibackgroundcopyjob) call, the SID of the caller's thread's token is the same as the SID of the job owner's user account, and</span></span>
> -   <span data-ttu-id="8d327-130">Lorsque [**IBitsTokenOptions :: SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) est appelé, le jeton d’assistance n’a pas le SID d’administrateur **( \_ \_ \_ administrateurs RID d’alias de domaine**) activé.</span><span class="sxs-lookup"><span data-stu-id="8d327-130">when [**IBitsTokenOptions::SetHelperToken**](/windows/desktop/api/Bits4_0/nf-bits4_0-ibitstokenoptions-sethelpertoken) is called, the helper token does not have the administrator SID (**DOMAIN\_ALIAS\_RID\_ADMINS**) enabled.</span></span>

 

## <a name="related-topics"></a><span data-ttu-id="8d327-131">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="8d327-131">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8d327-132">**IBitsTokenOptions**</span><span class="sxs-lookup"><span data-stu-id="8d327-132">**IBitsTokenOptions**</span></span>](/windows/desktop/api/Bits4_0/nn-bits4_0-ibitstokenoptions)
</dt> </dl>

 

 