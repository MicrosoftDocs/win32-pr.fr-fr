---
description: Le modèle traditionnel pour la prise en charge de multiprocesseur est le multiprocesseur symétrique (SMP). Dans ce modèle, chaque processeur a un accès égal à la mémoire et aux e/s. Au fur et à mesure de l’ajout de processeurs, le bus de processeur devient une limite pour les performances du système.
ms.assetid: a1263968-2b26-45cc-bdd7-6aa354821a5a
title: Prise en charge de NUMA
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 178f53c6b55b6ae291cd5cdcf99386515a441094
ms.sourcegitcommit: f848119a8faa29b27585f4df53f6e50ee9666684
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 05/27/2021
ms.locfileid: "110549804"
---
# <a name="numa-support"></a><span data-ttu-id="91fe2-105">Prise en charge de NUMA</span><span class="sxs-lookup"><span data-stu-id="91fe2-105">NUMA Support</span></span>

<span data-ttu-id="91fe2-106">Le modèle traditionnel pour la prise en charge de multiprocesseur est le multiprocesseur symétrique (SMP).</span><span class="sxs-lookup"><span data-stu-id="91fe2-106">The traditional model for multiprocessor support is symmetric multiprocessor (SMP).</span></span> <span data-ttu-id="91fe2-107">Dans ce modèle, chaque processeur a un accès égal à la mémoire et aux e/s.</span><span class="sxs-lookup"><span data-stu-id="91fe2-107">In this model, each processor has equal access to memory and I/O.</span></span> <span data-ttu-id="91fe2-108">Au fur et à mesure de l’ajout de processeurs, le bus de processeur devient une limite pour les performances du système.</span><span class="sxs-lookup"><span data-stu-id="91fe2-108">As more processors are added, the processor bus becomes a limitation for system performance.</span></span>

<span data-ttu-id="91fe2-109">Les concepteurs de systèmes utilisent l’accès mémoire non uniforme (NUMA) pour augmenter la vitesse du processeur sans augmenter la charge sur le bus du processeur.</span><span class="sxs-lookup"><span data-stu-id="91fe2-109">System designers use non-uniform memory access (NUMA) to increase processor speed without increasing the load on the processor bus.</span></span> <span data-ttu-id="91fe2-110">L’architecture n’est pas uniforme, car chaque processeur est proche de certaines parties de la mémoire et plus éloignées des autres parties de la mémoire.</span><span class="sxs-lookup"><span data-stu-id="91fe2-110">The architecture is non-uniform because each processor is close to some parts of memory and farther from other parts of memory.</span></span> <span data-ttu-id="91fe2-111">Le processeur obtient rapidement l’accès à la mémoire à proximité, alors qu’il peut prendre plus de temps pour accéder à la mémoire qui est plus éloignée.</span><span class="sxs-lookup"><span data-stu-id="91fe2-111">The processor quickly gains access to the memory it is close to, while it can take longer to gain access to memory that is farther away.</span></span>

<span data-ttu-id="91fe2-112">Dans un système NUMA, les processeurs sont disposés dans des systèmes plus petits appelés *nœuds*.</span><span class="sxs-lookup"><span data-stu-id="91fe2-112">In a NUMA system, CPUs are arranged in smaller systems called *nodes*.</span></span> <span data-ttu-id="91fe2-113">Chaque nœud possède ses propres processeurs et sa mémoire, et est connecté au système plus grand via un bus d’interconnexion cohérent du cache.</span><span class="sxs-lookup"><span data-stu-id="91fe2-113">Each node has its own processors and memory, and is connected to the larger system through a cache-coherent interconnect bus.</span></span>

<span data-ttu-id="91fe2-114">Le système tente d’améliorer les performances en planifiant des threads sur les processeurs qui se trouvent dans le même nœud que la mémoire utilisée.</span><span class="sxs-lookup"><span data-stu-id="91fe2-114">The system attempts to improve performance by scheduling threads on processors that are in the same node as the memory being used.</span></span> <span data-ttu-id="91fe2-115">Il tente de satisfaire les demandes d’allocation de mémoire à partir du nœud, mais alloue de la mémoire à partir d’autres nœuds si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="91fe2-115">It attempts to satisfy memory-allocation requests from within the node, but will allocate memory from other nodes if necessary.</span></span> <span data-ttu-id="91fe2-116">Il fournit également une API pour rendre la topologie du système disponible pour les applications.</span><span class="sxs-lookup"><span data-stu-id="91fe2-116">It also provides an API to make the topology of the system available to applications.</span></span> <span data-ttu-id="91fe2-117">Vous pouvez améliorer les performances de vos applications à l’aide des fonctions NUMA pour optimiser la planification et l’utilisation de la mémoire.</span><span class="sxs-lookup"><span data-stu-id="91fe2-117">You can improve the performance of your applications by using the NUMA functions to optimize scheduling and memory usage.</span></span>

<span data-ttu-id="91fe2-118">Tout d’abord, vous devrez déterminer la disposition des nœuds dans le système.</span><span class="sxs-lookup"><span data-stu-id="91fe2-118">First of all, you will need to determine the layout of nodes in the system.</span></span> <span data-ttu-id="91fe2-119">Pour récupérer le nœud portant le numéro le plus élevé dans le système, utilisez la fonction [**GetNumaHighestNodeNumber**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber) .</span><span class="sxs-lookup"><span data-stu-id="91fe2-119">To retrieve the highest numbered node in the system, use the [**GetNumaHighestNodeNumber**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber) function.</span></span> <span data-ttu-id="91fe2-120">Notez qu’il n’est pas garanti que ce nombre soit égal au nombre total de nœuds dans le système.</span><span class="sxs-lookup"><span data-stu-id="91fe2-120">Note that this number is not guaranteed to equal the total number of nodes in the system.</span></span> <span data-ttu-id="91fe2-121">En outre, il n’est pas garanti que les nœuds avec des nombres séquentiels soient proches les uns des autres.</span><span class="sxs-lookup"><span data-stu-id="91fe2-121">Also, nodes with sequential numbers are not guaranteed to be close together.</span></span> <span data-ttu-id="91fe2-122">Pour récupérer la liste des processeurs sur le système, utilisez la fonction [**GetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-getprocessaffinitymask) .</span><span class="sxs-lookup"><span data-stu-id="91fe2-122">To retrieve the list of processors on the system, use the [**GetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-getprocessaffinitymask) function.</span></span> <span data-ttu-id="91fe2-123">Vous pouvez déterminer le nœud pour chaque processeur de la liste à l’aide de la fonction [**GetNumaProcessorNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode) .</span><span class="sxs-lookup"><span data-stu-id="91fe2-123">You can determine the node for each processor in the list by using the [**GetNumaProcessorNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode) function.</span></span> <span data-ttu-id="91fe2-124">Pour récupérer une liste de tous les processeurs dans un nœud, vous pouvez également utiliser la fonction [**GetNumaNodeProcessorMask**](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask) .</span><span class="sxs-lookup"><span data-stu-id="91fe2-124">Alternatively, to retrieve a list of all processors in a node, use the [**GetNumaNodeProcessorMask**](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask) function.</span></span>

<span data-ttu-id="91fe2-125">Une fois que vous avez déterminé quels processeurs appartiennent aux nœuds, vous pouvez optimiser les performances de votre application.</span><span class="sxs-lookup"><span data-stu-id="91fe2-125">After you have determined which processors belong to which nodes, you can optimize your application's performance.</span></span> <span data-ttu-id="91fe2-126">Pour vous assurer que tous les threads de votre processus s’exécutent sur le même nœud, utilisez la fonction [**SetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setprocessaffinitymask) avec un masque d’affinité de processus qui spécifie les processeurs dans le même nœud.</span><span class="sxs-lookup"><span data-stu-id="91fe2-126">To ensure that all threads for your process run on the same node, use the [**SetProcessAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setprocessaffinitymask) function with a process affinity mask that specifies processors in the same node.</span></span> <span data-ttu-id="91fe2-127">Cela augmente l’efficacité des applications dont les threads ont besoin d’accéder à la même mémoire.</span><span class="sxs-lookup"><span data-stu-id="91fe2-127">This increases the efficiency of applications whose threads need to access the same memory.</span></span> <span data-ttu-id="91fe2-128">Pour limiter le nombre de threads sur chaque nœud, vous pouvez également utiliser la fonction [**SetThreadAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setthreadaffinitymask) .</span><span class="sxs-lookup"><span data-stu-id="91fe2-128">Alternatively, to limit the number of threads on each node, use the [**SetThreadAffinityMask**](/windows/desktop/api/WinBase/nf-winbase-setthreadaffinitymask) function.</span></span>

<span data-ttu-id="91fe2-129">Les applications gourmandes en mémoire doivent optimiser leur utilisation de la mémoire.</span><span class="sxs-lookup"><span data-stu-id="91fe2-129">Memory-intensive applications will need to optimize their memory usage.</span></span> <span data-ttu-id="91fe2-130">Pour récupérer la quantité de mémoire disponible pour un nœud, utilisez la fonction [**GetNumaAvailableMemoryNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode) .</span><span class="sxs-lookup"><span data-stu-id="91fe2-130">To retrieve the amount of free memory available to a node, use the [**GetNumaAvailableMemoryNode**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode) function.</span></span> <span data-ttu-id="91fe2-131">La fonction [**VirtualAllocExNuma**](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma) permet à l’application de spécifier un nœud préféré pour l’allocation de mémoire.</span><span class="sxs-lookup"><span data-stu-id="91fe2-131">The [**VirtualAllocExNuma**](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma) function enables the application to specify a preferred node for the memory allocation.</span></span> <span data-ttu-id="91fe2-132">**VirtualAllocExNuma** n’alloue pas de pages physiques, si bien que les pages sont disponibles sur ce nœud ou ailleurs dans le système.</span><span class="sxs-lookup"><span data-stu-id="91fe2-132">**VirtualAllocExNuma** does not allocate any physical pages, so it will succeed whether or not the pages are available on that node or elsewhere in the system.</span></span> <span data-ttu-id="91fe2-133">Les pages physiques sont allouées à la demande.</span><span class="sxs-lookup"><span data-stu-id="91fe2-133">The physical pages are allocated on demand.</span></span> <span data-ttu-id="91fe2-134">Si le nœud préféré ne dispose pas de suffisamment de pages, le gestionnaire de mémoire utilise les pages des autres nœuds.</span><span class="sxs-lookup"><span data-stu-id="91fe2-134">If the preferred node runs out of pages, the memory manager will use pages from other nodes.</span></span> <span data-ttu-id="91fe2-135">Si la mémoire est paginée, le même processus est utilisé lors de son retour.</span><span class="sxs-lookup"><span data-stu-id="91fe2-135">If the memory is paged out, the same process is used when it is brought back in.</span></span>

### <a name="numa-support-on-systems-with-more-than-64-logical-processors"></a><span data-ttu-id="91fe2-136">Prise en charge de NUMA sur les systèmes avec plus de 64 processeurs logiques</span><span class="sxs-lookup"><span data-stu-id="91fe2-136">NUMA Support on Systems With More Than 64 Logical Processors</span></span>

<span data-ttu-id="91fe2-137">Sur les systèmes avec plus de 64 processeurs logiques, les nœuds sont attribués aux [groupes de processeurs](processor-groups.md) en fonction de la capacité des nœuds.</span><span class="sxs-lookup"><span data-stu-id="91fe2-137">On systems with more than 64 logical processors, nodes are assigned to [processor groups](processor-groups.md) according to the capacity of the nodes.</span></span> <span data-ttu-id="91fe2-138">La capacité d’un nœud est le nombre de processeurs présents lorsque le système démarre avec tous les processeurs logiques supplémentaires qui peuvent être ajoutés pendant que le système est en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="91fe2-138">The capacity of a node is the number of processors that are present when the system starts together with any additional logical processors that can be added while the system is running.</span></span>

<span data-ttu-id="91fe2-139">**Windows server 2008, Windows Vista, Windows server 2003 et Windows XP :** Les groupes de processeurs ne sont pas pris en charge.</span><span class="sxs-lookup"><span data-stu-id="91fe2-139">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** Processor groups are not supported.</span></span>

<span data-ttu-id="91fe2-140">Chaque nœud doit être entièrement contenu dans un groupe.</span><span class="sxs-lookup"><span data-stu-id="91fe2-140">Each node must be fully contained within a group.</span></span> <span data-ttu-id="91fe2-141">Si les capacités des nœuds sont relativement faibles, le système affecte plusieurs nœuds au même groupe, en choisissant des nœuds physiquement proches les uns des autres pour obtenir de meilleures performances.</span><span class="sxs-lookup"><span data-stu-id="91fe2-141">If the capacities of the nodes are relatively small, the system assigns more than one node to the same group, choosing nodes that are physically close to one another for better performance.</span></span> <span data-ttu-id="91fe2-142">Si la capacité d’un nœud dépasse le nombre maximal de processeurs dans un groupe, le système fractionne le nœud en plusieurs nœuds plus petits, chacun étant suffisamment petit pour tenir dans un groupe.</span><span class="sxs-lookup"><span data-stu-id="91fe2-142">If a node's capacity exceeds the maximum number of processors in a group, the system splits the node into multiple smaller nodes, each small enough to fit in a group.</span></span>

<span data-ttu-id="91fe2-143">Un nœud NUMA idéal pour un nouveau processus peut être demandé à l’aide de l’attribut étendu de [**\_ \_ \_ \_ nœud préféré de l’attribut proc thread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) lors de la création du processus.</span><span class="sxs-lookup"><span data-stu-id="91fe2-143">An ideal NUMA node for a new process can be requested using the [**PROC\_THREAD\_ATTRIBUTE\_PREFERRED\_NODE**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) extended attribute when the process is created.</span></span> <span data-ttu-id="91fe2-144">À l’instar d’un processeur idéal pour les threads, le nœud idéal est un indicateur du planificateur, qui assigne le nouveau processus au groupe qui contient le nœud demandé, si possible.</span><span class="sxs-lookup"><span data-stu-id="91fe2-144">Like a thread ideal processor, the ideal node is a hint to the scheduler, which assigns the new process to the group that contains the requested node if possible.</span></span>

<span data-ttu-id="91fe2-145">Les fonctions NUMA étendues [**GetNumaAvailableMemoryNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex), [**GetNumaNodeProcessorMaskEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex), [**GetNumaProcessorNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex)et [**GetNumaProximityNodeEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex) diffèrent de leurs équivalents non étendus dans le fait que le numéro de nœud est une valeur **UShort** plutôt qu’un **UCHAR**, pour prendre en charge le nombre potentiellement plus élevé de nœuds sur un système avec plus de 64 processeurs logiques.</span><span class="sxs-lookup"><span data-stu-id="91fe2-145">The extended NUMA functions [**GetNumaAvailableMemoryNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex), [**GetNumaNodeProcessorMaskEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex), [**GetNumaProcessorNodeEx**](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex), and [**GetNumaProximityNodeEx**](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex) differ from their unextended counterparts in that the node number is a **USHORT** value rather than a **UCHAR**, to accommodate the potentially greater number of nodes on a system with more than 64 logical processors.</span></span> <span data-ttu-id="91fe2-146">En outre, le processeur spécifié avec ou récupéré par les fonctions étendues comprend le groupe de processeurs. le processeur spécifié avec ou récupéré par les fonctions non étendues est relatif au groupe.</span><span class="sxs-lookup"><span data-stu-id="91fe2-146">Also, the processor specified with or retrieved by the extended functions includes the processor group; the processor specified with or retrieved by the unextended functions is group-relative.</span></span> <span data-ttu-id="91fe2-147">Pour plus d’informations, consultez les rubriques de référence sur les fonctions individuelles.</span><span class="sxs-lookup"><span data-stu-id="91fe2-147">For details, see the individual function reference topics.</span></span>

<span data-ttu-id="91fe2-148">Une application prenant en charge les groupes peut attribuer tous ses threads à un nœud particulier de la même manière que celle décrite précédemment dans cette rubrique, à l’aide des fonctions NUMA étendues correspondantes.</span><span class="sxs-lookup"><span data-stu-id="91fe2-148">A group-aware application can assign all of its threads to a particular node in a similar fashion to that described earlier in this topic, using the corresponding extended NUMA functions.</span></span> <span data-ttu-id="91fe2-149">L’application utilise [**GetLogicalProcessorInformationEx**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) pour récupérer la liste de tous les processeurs sur le système.</span><span class="sxs-lookup"><span data-stu-id="91fe2-149">The application uses [**GetLogicalProcessorInformationEx**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) to get the list of all processors on the system.</span></span> <span data-ttu-id="91fe2-150">Notez que l’application ne peut pas définir le masque d’affinité du processus à moins que le processus ne soit affecté à un seul groupe et que le nœud prévu se trouve dans ce groupe.</span><span class="sxs-lookup"><span data-stu-id="91fe2-150">Note that the application cannot set the process affinity mask unless the process is assigned to a single group and the intended node is located in that group.</span></span> <span data-ttu-id="91fe2-151">En règle générale, l’application doit appeler [**SetThreadGroupAffinity**](/windows/win32/api/processtopologyapi/nf-processtopologyapi-setthreadgroupaffinity) pour limiter ses threads au nœud prévu.</span><span class="sxs-lookup"><span data-stu-id="91fe2-151">Usually the application must call [**SetThreadGroupAffinity**](/windows/win32/api/processtopologyapi/nf-processtopologyapi-setthreadgroupaffinity) to limit its threads to the intended node.</span></span>


### <a name="behavior-starting-with-windows-10-build-20348"></a><span data-ttu-id="91fe2-152">Comportement à partir de Windows 10 Build 20348</span><span class="sxs-lookup"><span data-stu-id="91fe2-152">Behavior starting with Windows 10 Build 20348</span></span> 

> [!NOTE]
> <span data-ttu-id="91fe2-153">À compter de la version 20348 de Windows 10, le comportement de cette fonction et d’autres fonctions NUMA a été modifié afin de mieux prendre en charge les systèmes avec des nœuds contenant plus de 64 processeurs.</span><span class="sxs-lookup"><span data-stu-id="91fe2-153">Starting with Windows 10 Build 20348, the behavior of this and other NUMA functions has been modified to better support systems with nodes containing more that 64 processors.</span></span>

<span data-ttu-id="91fe2-154">La création de nœuds « factices » pour prendre en charge un mappage de 1:1 entre les groupes et les nœuds a entraîné des comportements confus où des nombres inattendus de nœuds NUMA sont signalés et, par conséquent, à compter de Windows 10 Build 20348, le système d’exploitation a été modifié pour permettre l’Association de plusieurs groupes à un nœud.</span><span class="sxs-lookup"><span data-stu-id="91fe2-154">Creating "fake" nodes to accommodate a 1:1 mapping between groups and nodes has resulted in confusing behaviors where unexpected numbers of NUMA nodes are reported and so, starting with Windows 10 Build 20348, the OS has changed to allow multiple groups to be associated with a node, and so now the true NUMA topology of the system can be reported.</span></span>  

<span data-ttu-id="91fe2-155">Dans le cadre de ces modifications apportées au système d’exploitation, un certain nombre d’API NUMA ont été modifiées pour prendre en charge la création de rapports pour les plusieurs groupes qui peuvent désormais être associés à un seul nœud NUMA.</span><span class="sxs-lookup"><span data-stu-id="91fe2-155">As part of these changes to the OS, a number of NUMA APIs have changed to support reporting the multiple groups which can now be associated with a single NUMA node.</span></span> <span data-ttu-id="91fe2-156">Les API mises à jour et nouvelles sont étiquetées dans le tableau de la section **API NUMA** ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="91fe2-156">Updated and new APIs are labeled in the table in the **NUMA API** section below.</span></span>

<span data-ttu-id="91fe2-157">Étant donné que la suppression du fractionnement des nœuds peut avoir un impact sur les applications existantes, une valeur de Registre est disponible pour vous permettre de revenir au comportement de fractionnement des nœuds hérités.</span><span class="sxs-lookup"><span data-stu-id="91fe2-157">Because the removal of node splitting can potentially impact existing applications, a registry value is available to allow opting back into the legacy node splitting behavior.</span></span> <span data-ttu-id="91fe2-158">Vous pouvez réactiver le fractionnement des nœuds en créant une **REG_DWORD** valeur nommée « SplitLargeNodes » avec la valeur 1 sous HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\NUMA.</span><span class="sxs-lookup"><span data-stu-id="91fe2-158">Node splitting can be re-enabled by creating a **REG_DWORD** value named "SplitLargeNodes" with value 1 underneath HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\NUMA.</span></span> <span data-ttu-id="91fe2-159">Les modifications apportées à ce paramètre requièrent un redémarrage pour prendre effet.</span><span class="sxs-lookup"><span data-stu-id="91fe2-159">Changes to this setting require a reboot to take effect.</span></span>

```powershell
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\NUMA" /v SplitLargeNumaNodes /t REG_DWORD /v 1
```

> [!NOTE]
> <span data-ttu-id="91fe2-160">Les applications mises à jour pour utiliser la nouvelle fonctionnalité de l’API qui signale la véritable topologie NUMA continuent de fonctionner correctement sur les systèmes où le fractionnement de nœuds volumineux a été réactivé avec cette clé de registre.</span><span class="sxs-lookup"><span data-stu-id="91fe2-160">Applications that are updated to use the new API functionality that reports the true NUMA topology will continue to work properly on systems where large node splitting has been reenabled with this registry key.</span></span>

<span data-ttu-id="91fe2-161">L’exemple suivant illustre tout d’abord les problèmes potentiels liés aux tables de builds qui mappent les processeurs à des nœuds NUMA à l’aide des API d’affinité héritée, qui ne fournissent plus de couverture complète de tous les processeurs du système, ce qui peut entraîner une table incomplète.</span><span class="sxs-lookup"><span data-stu-id="91fe2-161">The following example first demonstrates potential issues with builds tables mapping processors to NUMA nodes using the legacy affinity APIs, which no longer provide a full cover of all processors in the system this can result in an incomplete table.</span></span> <span data-ttu-id="91fe2-162">Les implications d’une telle incomplète dépendent du contenu de la table.</span><span class="sxs-lookup"><span data-stu-id="91fe2-162">The implications of such incompleteness depend on the contents of the table.</span></span> <span data-ttu-id="91fe2-163">Si la table stocke simplement le numéro de nœud correspondant, il s’agit probablement d’un problème de performances avec des processeurs non couverts conservés dans le cadre du nœud 0.</span><span class="sxs-lookup"><span data-stu-id="91fe2-163">If the table simply stores the corresponding node number then this is likely only a performance issue with uncovered processors being left as part of node 0.</span></span> <span data-ttu-id="91fe2-164">Toutefois, si la table contient des pointeurs vers une structure de contexte par nœud, cela peut entraîner des déréférencements NULL au moment de l’exécution.</span><span class="sxs-lookup"><span data-stu-id="91fe2-164">However, if the table contains pointers to a per-node context structure this can result in NULL dereferences at runtime.</span></span>

<span data-ttu-id="91fe2-165">L’exemple de code suivant illustre deux solutions de contournement pour le problème.</span><span class="sxs-lookup"><span data-stu-id="91fe2-165">Next, the code example illustrates two workarounds for the issue.</span></span> <span data-ttu-id="91fe2-166">La première consiste à migrer vers les API d’affinité de nœud à plusieurs groupes (en mode utilisateur et en mode noyau).</span><span class="sxs-lookup"><span data-stu-id="91fe2-166">The first is to migrate to the multi-group node affinity APIs (user-mode and kernel-mode).</span></span> <span data-ttu-id="91fe2-167">La seconde consiste à utiliser **KeQueryLogicalProcessorRelationship** pour interroger directement le nœud NUMA associé à un numéro de processeur donné.</span><span class="sxs-lookup"><span data-stu-id="91fe2-167">The second is to use **KeQueryLogicalProcessorRelationship** to directly query the NUMA node associated with a given processor number.</span></span>

```cpp

//
// Problematic implementation using KeQueryNodeActiveAffinity.
//

USHORT CurrentNode;
USHORT HighestNodeNumber;
GROUP_AFFINITY NodeAffinity;
ULONG ProcessorIndex;
PROCESSOR_NUMBER ProcessorNumber;

HighestNodeNumber = KeQueryHighestNodeNumber();
for (CurrentNode = 0; CurrentNode <= HighestNodeNumber; CurrentNode += 1) {

    KeQueryNodeActiveAffinity(CurrentNode, &NodeAffinity, NULL);
    while (NodeAffinity.Mask != 0) {

        ProcessorNumber.Group = NodeAffinity.Group;
        BitScanForward(&ProcessorNumber.Number, NodeAffinity.Mask);

        ProcessorIndex = KeGetProcessorIndexFromNumber(&ProcessorNumber);

        ProcessorNodeContexts[ProcessorIndex] = NodeContexts[CurrentNode;]

        NodeAffinity.Mask &= ~((KAFFINITY)1 << ProcessorNumber.Number);
    }
}

//
// Resolution using KeQueryNodeActiveAffinity2.
//

USHORT CurrentIndex;
USHORT CurrentNode;
USHORT CurrentNodeAffinityCount;
USHORT HighestNodeNumber;
ULONG MaximumGroupCount;
PGROUP_AFFINITY NodeAffinityMasks;
ULONG ProcessorIndex;
PROCESSOR_NUMBER ProcessorNumber;
NTSTATUS Status;

MaximumGroupCount = KeQueryMaximumGroupCount();
NodeAffinityMasks = ExAllocatePool2(POOL_FLAG_PAGED,
                                    sizeof(GROUP_AFFINITY) * MaximumGroupCount,
                                    'tseT');

if (NodeAffinityMasks == NULL) {
    return STATUS_NO_MEMORY;
}

HighestNodeNumber = KeQueryHighestNodeNumber();
for (CurrentNode = 0; CurrentNode <= HighestNodeNumber; CurrentNode += 1) {

    Status = KeQueryNodeActiveAffinity2(CurrentNode,
                                        NodeAffinityMasks,
                                        MaximumGroupCount,
                                        &CurrentNodeAffinityCount);
    NT_ASSERT(NT_SUCCESS(Status));

    for (CurrentIndex = 0; CurrentIndex < CurrentNodeAffinityCount; CurrentIndex += 1) {

        CurrentAffinity = &NodeAffinityMasks[CurrentIndex];

        while (CurrentAffinity->Mask != 0) {

            ProcessorNumber.Group = CurrentAffinity.Group;
            BitScanForward(&ProcessorNumber.Number, CurrentAffinity->Mask);

            ProcessorIndex = KeGetProcessorIndexFromNumber(&ProcessorNumber);

            ProcessorNodeContexts[ProcessorIndex] = NodeContexts[CurrentNode];

            CurrentAffinity->Mask &= ~((KAFFINITY)1 << ProcessorNumber.Number);
        }
    }
}

//
// Resolution using KeQueryLogicalProcessorRelationship.
//

ULONG ProcessorCount;
ULONG ProcessorIndex;
SYSTEM_LOGICAL_PROCESSOR_INFORMATION_EX ProcessorInformation;
ULONG ProcessorInformationSize;
PROCESSOR_NUMBER ProcessorNumber;
NTSTATUS Status;

ProcessorCount = KeQueryActiveProcessorCountEx(ALL_PROCESSOR_GROUPS);

for (ProcessorIndex = 0; ProcessorIndex < ProcessorCount; ProcessorIndex += 1) {

    Status = KeGetProcessorNumberFromIndex(ProcessorIndex, &ProcessorNumber);
    NT_ASSERT(NT_SUCCESS(Status));

    ProcessorInformationSize = sizeof(ProcessorInformation);
    Status = KeQueryLogicalProcessorRelationship(&ProcessorNumber,
                                                    RelationNumaNode,
                                                    &ProcessorInformation,
                                                    &ProcesorInformationSize);
    NT_ASSERT(NT_SUCCESS(Status));

    NodeNumber = ProcessorInformation.NumaNode.NodeNumber;

    ProcessorNodeContexts[ProcessorIndex] = NodeContexts[NodeNumber];
}
```

## <a name="numa-api"></a><span data-ttu-id="91fe2-168">API NUMA</span><span class="sxs-lookup"><span data-stu-id="91fe2-168">NUMA API</span></span>

<span data-ttu-id="91fe2-169">Le tableau suivant décrit l’API NUMA.</span><span class="sxs-lookup"><span data-stu-id="91fe2-169">The following table describes the NUMA API.</span></span>



| <span data-ttu-id="91fe2-170">Fonction</span><span class="sxs-lookup"><span data-stu-id="91fe2-170">Function</span></span>                                                                     | <span data-ttu-id="91fe2-171">Description</span><span class="sxs-lookup"><span data-stu-id="91fe2-171">Description</span></span>                                                                                                                                                                                                                     |
|------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="91fe2-172">**AllocateUserPhysicalPagesNuma**</span><span class="sxs-lookup"><span data-stu-id="91fe2-172">**AllocateUserPhysicalPagesNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-allocateuserphysicalpagesnuma)      | <span data-ttu-id="91fe2-173">Alloue des pages de mémoire physique à mapper et à démapper dans une région AWE ( [Address Windowing Extensions](../memory/address-windowing-extensions.md) ) d’un processus spécifié et spécifie le nœud NUMA pour la mémoire physique.</span><span class="sxs-lookup"><span data-stu-id="91fe2-173">Allocates physical memory pages to be mapped and unmapped within any [Address Windowing Extensions](../memory/address-windowing-extensions.md) (AWE) region of a specified process and specifies the NUMA node for the physical memory.</span></span> |
| [<span data-ttu-id="91fe2-174">**CreateFileMappingNuma**</span><span class="sxs-lookup"><span data-stu-id="91fe2-174">**CreateFileMappingNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-createfilemappingnumaw)                      | <span data-ttu-id="91fe2-175">Crée ou ouvre un objet de mappage de fichier nommé ou sans nom pour un fichier spécifié et spécifie le nœud NUMA pour la mémoire physique.</span><span class="sxs-lookup"><span data-stu-id="91fe2-175">Creates or opens a named or unnamed file mapping object for a specified file, and specifies the NUMA node for the physical memory.</span></span>                                                                                              |
| [<span data-ttu-id="91fe2-176">**GetLogicalProcessorInformation**</span><span class="sxs-lookup"><span data-stu-id="91fe2-176">**GetLogicalProcessorInformation**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformation)     | <span data-ttu-id="91fe2-177">Mise à jour dans Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="91fe2-177">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="91fe2-178">Récupère des informations sur les processeurs logiques et le matériel associé.</span><span class="sxs-lookup"><span data-stu-id="91fe2-178">Retrieves information about logical processors and related hardware.</span></span>                                                                                                                                                            |
| [<span data-ttu-id="91fe2-179">**GetLogicalProcessorInformationEx**</span><span class="sxs-lookup"><span data-stu-id="91fe2-179">**GetLogicalProcessorInformationEx**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getlogicalprocessorinformationex) | <span data-ttu-id="91fe2-180">Mise à jour dans Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="91fe2-180">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="91fe2-181">Récupère des informations sur les relations entre les processeurs logiques et le matériel associé.</span><span class="sxs-lookup"><span data-stu-id="91fe2-181">Retrieves information about the relationships of logical processors and related hardware.</span></span>                                                                                                                                       |
| [<span data-ttu-id="91fe2-182">**GetNumaAvailableMemoryNode**</span><span class="sxs-lookup"><span data-stu-id="91fe2-182">**GetNumaAvailableMemoryNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynode)             | <span data-ttu-id="91fe2-183">Récupère la quantité de mémoire disponible dans le nœud spécifié.</span><span class="sxs-lookup"><span data-stu-id="91fe2-183">Retrieves the amount of memory available in the specified node.</span></span>                                                                                                                                                                 |
| [<span data-ttu-id="91fe2-184">**GetNumaAvailableMemoryNodeEx**</span><span class="sxs-lookup"><span data-stu-id="91fe2-184">**GetNumaAvailableMemoryNodeEx**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaavailablememorynodeex)         | <span data-ttu-id="91fe2-185">Récupère la quantité de mémoire disponible dans un nœud spécifié en tant que valeur **UShort** .</span><span class="sxs-lookup"><span data-stu-id="91fe2-185">Retrieves the amount of memory available in a node specified as a **USHORT** value.</span></span>                                                                                                                                             |
| [<span data-ttu-id="91fe2-186">**GetNumaHighestNodeNumber**</span><span class="sxs-lookup"><span data-stu-id="91fe2-186">**GetNumaHighestNodeNumber**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumahighestnodenumber)                 | <span data-ttu-id="91fe2-187">Récupère le nœud qui a actuellement le nombre le plus élevé.</span><span class="sxs-lookup"><span data-stu-id="91fe2-187">Retrieves the node that currently has the highest number.</span></span>                                                                                                                                                                       |
| [<span data-ttu-id="91fe2-188">**GetNumaNodeProcessorMask**</span><span class="sxs-lookup"><span data-stu-id="91fe2-188">**GetNumaNodeProcessorMask**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumanodeprocessormask)                 | <span data-ttu-id="91fe2-189">Mise à jour dans Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="91fe2-189">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="91fe2-190">Récupère le masque de processeur pour le nœud spécifié.</span><span class="sxs-lookup"><span data-stu-id="91fe2-190">Retrieves the processor mask for the specified node.</span></span>                                                                                                                                                                            |
| [<span data-ttu-id="91fe2-191">**GetNumaNodeProcessorMask2**</span><span class="sxs-lookup"><span data-stu-id="91fe2-191">**GetNumaNodeProcessorMask2**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormask2)                         | <span data-ttu-id="91fe2-192">Nouveauté de Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="91fe2-192">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="91fe2-193">Récupère le masque de processeur à plusieurs groupes du nœud spécifié.</span><span class="sxs-lookup"><span data-stu-id="91fe2-193">Retrieves the multi-group processor mask of the specified node.</span></span>                                                                                                                                                                          |
| [<span data-ttu-id="91fe2-194">**GetNumaNodeProcessorMaskEx**</span><span class="sxs-lookup"><span data-stu-id="91fe2-194">**GetNumaNodeProcessorMaskEx**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumanodeprocessormaskex)             | <span data-ttu-id="91fe2-195">Mise à jour dans Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="91fe2-195">Updated in Windows 10 Build 20348.</span></span> <span data-ttu-id="91fe2-196">Récupère le masque de processeur pour un nœud spécifié sous la forme d’une valeur **UShort** .</span><span class="sxs-lookup"><span data-stu-id="91fe2-196">Retrieves the processor mask for a node specified as a **USHORT** value.</span></span>                                                                                                                                                        |
| [<span data-ttu-id="91fe2-197">**GetNumaProcessorNode**</span><span class="sxs-lookup"><span data-stu-id="91fe2-197">**GetNumaProcessorNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornode)                         | <span data-ttu-id="91fe2-198">Récupère le numéro de nœud pour le processeur spécifié.</span><span class="sxs-lookup"><span data-stu-id="91fe2-198">Retrieves the node number for the specified processor.</span></span>                                                                                                                                                                          |
| [<span data-ttu-id="91fe2-199">**GetNumaProcessorNodeEx**</span><span class="sxs-lookup"><span data-stu-id="91fe2-199">**GetNumaProcessorNodeEx**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaprocessornodeex)                     | <span data-ttu-id="91fe2-200">Récupère le nombre de nœuds sous la forme d’une valeur **UShort** pour le processeur spécifié.</span><span class="sxs-lookup"><span data-stu-id="91fe2-200">Retrieves the node number as a **USHORT** value for the specified processor.</span></span>                                                                                                                                                    |
| [<span data-ttu-id="91fe2-201">**GetNumaProximityNode**</span><span class="sxs-lookup"><span data-stu-id="91fe2-201">**GetNumaProximityNode**</span></span>](/windows/desktop/api/WinBase/nf-winbase-getnumaproximitynode)                         | <span data-ttu-id="91fe2-202">Récupère le numéro de nœud pour l’identificateur de proximité spécifié.</span><span class="sxs-lookup"><span data-stu-id="91fe2-202">Retrieves the node number for the specified proximity identifier.</span></span>                                                                                                                                                               |
| [<span data-ttu-id="91fe2-203">**GetNumaProximityNodeEx**</span><span class="sxs-lookup"><span data-stu-id="91fe2-203">**GetNumaProximityNodeEx**</span></span>](/windows/win32/api/systemtopologyapi/nf-systemtopologyapi-getnumaproximitynodeex)                     | <span data-ttu-id="91fe2-204">Récupère le nombre de nœuds sous la forme d’une valeur **UShort** pour l’identificateur de proximité spécifié.</span><span class="sxs-lookup"><span data-stu-id="91fe2-204">Retrieves the node number as a **USHORT** value for the specified proximity identifier.</span></span>                                                                                                                                         |
| [<span data-ttu-id="91fe2-205">**GetProcessDefaultCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="91fe2-205">**GetProcessDefaultCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getprocessdefaultcpusetmasks)                     | <span data-ttu-id="91fe2-206">Nouveauté de Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="91fe2-206">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="91fe2-207">Récupère la liste des ensembles d’UC dans l’ensemble de processus par défaut qui a été défini par SetProcessDefaultCpuSetMasks ou SetProcessDefaultCpuSets.</span><span class="sxs-lookup"><span data-stu-id="91fe2-207">Retrieves the list of CPU Sets in the process default set that was set by SetProcessDefaultCpuSetMasks or SetProcessDefaultCpuSets.</span></span>                                                                                                                                         |
| [<span data-ttu-id="91fe2-208">**GetThreadSelectedCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="91fe2-208">**GetThreadSelectedCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-getthreadselectedcpusetmasks)                     | <span data-ttu-id="91fe2-209">Nouveauté de Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="91fe2-209">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="91fe2-210">Définit l’affectation de jeux d’UC sélectionnée pour le thread spécifié.</span><span class="sxs-lookup"><span data-stu-id="91fe2-210">Sets the selected CPU Sets assignment for the specified thread.</span></span> <span data-ttu-id="91fe2-211">Cette assignation remplace l’attribution de processus par défaut, si celle-ci est définie.</span><span class="sxs-lookup"><span data-stu-id="91fe2-211">This assignment overrides the process default assignment, if one is set.</span></span>                                                                                                                                          |
| [<span data-ttu-id="91fe2-212">**MapViewOfFileExNuma**</span><span class="sxs-lookup"><span data-stu-id="91fe2-212">**MapViewOfFileExNuma**</span></span>](/windows/win32/api/winbase/nf-winbase-mapviewoffileexnuma)                          | <span data-ttu-id="91fe2-213">Mappe une vue d’un mappage de fichier dans l’espace d’adressage d’un processus appelant et spécifie le nœud NUMA pour la mémoire physique.</span><span class="sxs-lookup"><span data-stu-id="91fe2-213">Maps a view of a file mapping into the address space of a calling process, and specifies the NUMA node for the physical memory.</span></span>                                                                                                 |
| [<span data-ttu-id="91fe2-214">**SetProcessDefaultCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="91fe2-214">**SetProcessDefaultCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessdefaultcpusetmasks)                     | <span data-ttu-id="91fe2-215">Nouveauté de Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="91fe2-215">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="91fe2-216">Définit l’affectation de jeux d’UC par défaut pour les threads dans le processus spécifié.</span><span class="sxs-lookup"><span data-stu-id="91fe2-216">Sets the default CPU Sets assignment for threads in the specified process.</span></span>                                                                                                                                          |
| [<span data-ttu-id="91fe2-217">**SetThreadSelectedCpuSetMasks**</span><span class="sxs-lookup"><span data-stu-id="91fe2-217">**SetThreadSelectedCpuSetMasks**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadselectedcpusetmasks)                     | <span data-ttu-id="91fe2-218">Nouveauté de Windows 10 Build 20348.</span><span class="sxs-lookup"><span data-stu-id="91fe2-218">New in Windows 10 Build 20348.</span></span> <span data-ttu-id="91fe2-219">Définit l’affectation de jeux d’UC sélectionnée pour le thread spécifié.</span><span class="sxs-lookup"><span data-stu-id="91fe2-219">Sets the selected CPU Sets assignment for the specified thread.</span></span> <span data-ttu-id="91fe2-220">Cette assignation remplace l’attribution de processus par défaut, si celle-ci est définie.</span><span class="sxs-lookup"><span data-stu-id="91fe2-220">This assignment overrides the process default assignment, if one is set.</span></span>                                                                                                                                          |
| [<span data-ttu-id="91fe2-221">**VirtualAllocExNuma**</span><span class="sxs-lookup"><span data-stu-id="91fe2-221">**VirtualAllocExNuma**</span></span>](/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma)                            | <span data-ttu-id="91fe2-222">Réserve ou valide une zone de mémoire dans l’espace d’adressage virtuel du processus spécifié et spécifie le nœud NUMA pour la mémoire physique.</span><span class="sxs-lookup"><span data-stu-id="91fe2-222">Reserves or commits a region of memory within the virtual address space of the specified process, and specifies the NUMA node for the physical memory.</span></span>                                                                          |



 

<span data-ttu-id="91fe2-223">La fonction [**QueryWorkingSetEx**](/windows/win32/api/psapi/nf-psapi-queryworkingsetex) peut être utilisée pour récupérer le nœud NUMA sur lequel une page est allouée.</span><span class="sxs-lookup"><span data-stu-id="91fe2-223">The [**QueryWorkingSetEx**](/windows/win32/api/psapi/nf-psapi-queryworkingsetex) function can be used to retrieve the NUMA node on which a page is allocated.</span></span> <span data-ttu-id="91fe2-224">Pour obtenir un exemple, consultez [allocation de mémoire à partir d’un nœud NUMA](../memory/allocating-memory-from-a-numa-node.md).</span><span class="sxs-lookup"><span data-stu-id="91fe2-224">For an example, see [Allocating Memory from a NUMA Node](../memory/allocating-memory-from-a-numa-node.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="91fe2-225">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="91fe2-225">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="91fe2-226">Allocation de mémoire à partir d’un nœud NUMA</span><span class="sxs-lookup"><span data-stu-id="91fe2-226">Allocating Memory from a NUMA Node</span></span>](../memory/allocating-memory-from-a-numa-node.md)
</dt> <dt>

[<span data-ttu-id="91fe2-227">Plusieurs processeurs</span><span class="sxs-lookup"><span data-stu-id="91fe2-227">Multiple Processors</span></span>](multiple-processors.md)
</dt> <dt>

[<span data-ttu-id="91fe2-228">Groupes de processeurs</span><span class="sxs-lookup"><span data-stu-id="91fe2-228">Processor Groups</span></span>](processor-groups.md)
</dt> </dl>

 

 
