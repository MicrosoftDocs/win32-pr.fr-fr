---
description: Une fibre est une unité d’exécution qui doit être planifiée manuellement par l’application.
ms.assetid: 6283f56b-23ae-4840-abd0-2478a50c670c
title: Fibres
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4ea0383e6d207a77c621f00f358c72bb8873ecb5
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103756561"
---
# <a name="fibers"></a><span data-ttu-id="add71-103">Fibres</span><span class="sxs-lookup"><span data-stu-id="add71-103">Fibers</span></span>

<span data-ttu-id="add71-104">Une *fibre* est une unité d’exécution qui doit être planifiée manuellement par l’application.</span><span class="sxs-lookup"><span data-stu-id="add71-104">A *fiber* is a unit of execution that must be manually scheduled by the application.</span></span> <span data-ttu-id="add71-105">Les fibres s’exécutent dans le contexte des threads qui les planifient.</span><span class="sxs-lookup"><span data-stu-id="add71-105">Fibers run in the context of the threads that schedule them.</span></span> <span data-ttu-id="add71-106">Chaque thread peut planifier plusieurs fibres.</span><span class="sxs-lookup"><span data-stu-id="add71-106">Each thread can schedule multiple fibers.</span></span> <span data-ttu-id="add71-107">En général, les fibres ne fournissent pas d’avantages par rapport à une application multithread bien conçue.</span><span class="sxs-lookup"><span data-stu-id="add71-107">In general, fibers do not provide advantages over a well-designed multithreaded application.</span></span> <span data-ttu-id="add71-108">Toutefois, l’utilisation de fibres peut faciliter le portage des applications conçues pour planifier leurs propres threads.</span><span class="sxs-lookup"><span data-stu-id="add71-108">However, using fibers can make it easier to port applications that were designed to schedule their own threads.</span></span>

<span data-ttu-id="add71-109">Du point de vue du système, une fibre utilise l’identité du thread qui l’exécute.</span><span class="sxs-lookup"><span data-stu-id="add71-109">From a system standpoint, a fiber assumes the identity of the thread that runs it.</span></span> <span data-ttu-id="add71-110">Par exemple, si une fibre accède au [stockage local des threads](thread-local-storage.md) (TLS), elle accède au stockage local des threads du thread qui l’exécute.</span><span class="sxs-lookup"><span data-stu-id="add71-110">For example, if a fiber accesses [thread local storage](thread-local-storage.md) (TLS), it is accessing the thread local storage of the thread that is running it.</span></span> <span data-ttu-id="add71-111">En outre, si une fibre appelle la fonction [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) , le thread qui l’exécute s’arrête.</span><span class="sxs-lookup"><span data-stu-id="add71-111">In addition, if a fiber calls the [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) function, the thread that is running it exits.</span></span> <span data-ttu-id="add71-112">Toutefois, les informations d’état associées à une fibre ne sont pas toutes les mêmes que celles associées à un thread.</span><span class="sxs-lookup"><span data-stu-id="add71-112">However, a fiber does not have all the same state information associated with it as that associated with a thread.</span></span> <span data-ttu-id="add71-113">Les seules informations d’État conservées pour une fibre sont sa pile, un sous-ensemble de ses registres et les données de fibre fournies lors de la création de la fibre.</span><span class="sxs-lookup"><span data-stu-id="add71-113">The only state information maintained for a fiber is its stack, a subset of its registers, and the fiber data provided during fiber creation.</span></span> <span data-ttu-id="add71-114">Les registres enregistrés sont l’ensemble des registres généralement conservés dans un appel de fonction.</span><span class="sxs-lookup"><span data-stu-id="add71-114">The saved registers are the set of registers typically preserved across a function call.</span></span>

<span data-ttu-id="add71-115">Les fibres ne sont pas planifiées de manière préventive.</span><span class="sxs-lookup"><span data-stu-id="add71-115">Fibers are not preemptively scheduled.</span></span> <span data-ttu-id="add71-116">Vous planifiez une fibre en la basculant à partir d’une autre fibre.</span><span class="sxs-lookup"><span data-stu-id="add71-116">You schedule a fiber by switching to it from another fiber.</span></span> <span data-ttu-id="add71-117">Le système planifie toujours l’exécution des threads.</span><span class="sxs-lookup"><span data-stu-id="add71-117">The system still schedules threads to run.</span></span> <span data-ttu-id="add71-118">Lorsqu’un thread exécutant des fibres est préempté, sa fibre en cours d’exécution est préemptée, mais reste sélectionnée.</span><span class="sxs-lookup"><span data-stu-id="add71-118">When a thread running fibers is preempted, its currently running fiber is preempted but remains selected.</span></span> <span data-ttu-id="add71-119">La fibre sélectionnée s’exécute lorsque son thread s’exécute.</span><span class="sxs-lookup"><span data-stu-id="add71-119">The selected fiber runs when its thread runs.</span></span>

<span data-ttu-id="add71-120">Avant de planifier la première fibre, appelez la fonction [**ConvertThreadToFiber**](/windows/desktop/api/WinBase/nf-winbase-convertthreadtofiber) pour créer une zone dans laquelle enregistrer les informations d’état de la fibre.</span><span class="sxs-lookup"><span data-stu-id="add71-120">Before scheduling the first fiber, call the [**ConvertThreadToFiber**](/windows/desktop/api/WinBase/nf-winbase-convertthreadtofiber) function to create an area in which to save fiber state information.</span></span> <span data-ttu-id="add71-121">Le thread appelant est maintenant la fibre en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="add71-121">The calling thread is now the currently executing fiber.</span></span> <span data-ttu-id="add71-122">Les informations d’État stockées pour cette fibre incluent les données fibre passées comme argument à **ConvertThreadToFiber**.</span><span class="sxs-lookup"><span data-stu-id="add71-122">The stored state information for this fiber includes the fiber data passed as an argument to **ConvertThreadToFiber**.</span></span>

<span data-ttu-id="add71-123">La fonction [**CreateFiber**](/windows/desktop/api/WinBase/nf-winbase-createfiber) est utilisée pour créer une nouvelle fibre à partir d’une fibre existante ; l’appel requiert la taille de la pile, l’adresse de départ et les données de fibre.</span><span class="sxs-lookup"><span data-stu-id="add71-123">The [**CreateFiber**](/windows/desktop/api/WinBase/nf-winbase-createfiber) function is used to create a new fiber from an existing fiber; the call requires the stack size, the starting address, and the fiber data.</span></span> <span data-ttu-id="add71-124">L’adresse de départ est généralement une fonction fournie par l’utilisateur, appelée fonction Fiber, qui accepte un paramètre (les données Fiber) et ne retourne pas de valeur.</span><span class="sxs-lookup"><span data-stu-id="add71-124">The starting address is typically a user-supplied function, called the fiber function, that takes one parameter (the fiber data) and does not return a value.</span></span> <span data-ttu-id="add71-125">Si votre fonction fibre retourne, le thread qui exécute la fibre s’arrête.</span><span class="sxs-lookup"><span data-stu-id="add71-125">If your fiber function returns, the thread running the fiber exits.</span></span> <span data-ttu-id="add71-126">Pour exécuter une fibre créée avec **CreateFiber**, appelez la fonction [**SwitchToFiber**](/windows/desktop/api/WinBase/nf-winbase-switchtofiber) .</span><span class="sxs-lookup"><span data-stu-id="add71-126">To execute any fiber created with **CreateFiber**, call the [**SwitchToFiber**](/windows/desktop/api/WinBase/nf-winbase-switchtofiber) function.</span></span> <span data-ttu-id="add71-127">Vous pouvez appeler **SwitchToFiber** avec l’adresse d’une fibre créée par un thread différent.</span><span class="sxs-lookup"><span data-stu-id="add71-127">You can call **SwitchToFiber** with the address of a fiber created by a different thread.</span></span> <span data-ttu-id="add71-128">Pour ce faire, l’adresse doit être renvoyée à l’autre thread quand elle est appelée **CreateFiber** et vous devez utiliser une synchronisation appropriée.</span><span class="sxs-lookup"><span data-stu-id="add71-128">To do this, you must have the address returned to the other thread when it called **CreateFiber** and you must use proper synchronization.</span></span>

<span data-ttu-id="add71-129">Une fibre peut récupérer les données de fibre en appelant la macro [**GetFiberData**](/windows/win32/api/winnt/nf-winnt-getfiberdata) .</span><span class="sxs-lookup"><span data-stu-id="add71-129">A fiber can retrieve the fiber data by calling the [**GetFiberData**](/windows/win32/api/winnt/nf-winnt-getfiberdata) macro.</span></span> <span data-ttu-id="add71-130">Une fibre peut récupérer l’adresse de fibre à tout moment en appelant la macro [**GetCurrentFiber**](/windows/win32/api/winnt/nf-winnt-getcurrentfiber) .</span><span class="sxs-lookup"><span data-stu-id="add71-130">A fiber can retrieve the fiber address at any time by calling the [**GetCurrentFiber**](/windows/win32/api/winnt/nf-winnt-getcurrentfiber) macro.</span></span>

## <a name="fiber-local-storage"></a><span data-ttu-id="add71-131">Stockage local Fiber</span><span class="sxs-lookup"><span data-stu-id="add71-131">Fiber Local Storage</span></span>

<span data-ttu-id="add71-132">Une fibre peut utiliser le *stockage local de fibres* (FLS) pour créer une copie unique d’une variable pour chaque fibre.</span><span class="sxs-lookup"><span data-stu-id="add71-132">A fiber can use *fiber local storage* (FLS) to create a unique copy of a variable for each fiber.</span></span> <span data-ttu-id="add71-133">Si aucune commutation de fibre ne se produit, FLS agit exactement comme le [stockage local des threads](thread-local-storage.md).</span><span class="sxs-lookup"><span data-stu-id="add71-133">If no fiber switching occurs, FLS acts exactly the same as [thread local storage](thread-local-storage.md).</span></span> <span data-ttu-id="add71-134">Les fonctions FLS ([**FlsAlloc**](/windows/win32/api/fibersapi/nf-fibersapi-flsalloc), [**FlsFree**](/windows/win32/api/fibersapi/nf-fibersapi-flsfree), [**FlsGetValue**](/windows/win32/api/fibersapi/nf-fibersapi-flsgetvalue)et [**FlsSetValue**](/windows/win32/api/fibersapi/nf-fibersapi-flssetvalue)) manipulent les FLS associées au thread actuel.</span><span class="sxs-lookup"><span data-stu-id="add71-134">The FLS functions ([**FlsAlloc**](/windows/win32/api/fibersapi/nf-fibersapi-flsalloc), [**FlsFree**](/windows/win32/api/fibersapi/nf-fibersapi-flsfree), [**FlsGetValue**](/windows/win32/api/fibersapi/nf-fibersapi-flsgetvalue), and [**FlsSetValue**](/windows/win32/api/fibersapi/nf-fibersapi-flssetvalue)) manipulate the FLS associated with the current thread.</span></span> <span data-ttu-id="add71-135">Si le thread exécute une fibre et que la fibre est basculée, le FLS est également basculé.</span><span class="sxs-lookup"><span data-stu-id="add71-135">If the thread is executing a fiber and the fiber is switched, the FLS is also switched.</span></span>

<span data-ttu-id="add71-136">Pour nettoyer les données associées à une fibre, appelez la fonction [**DeleteFiber**](/windows/desktop/api/WinBase/nf-winbase-deletefiber) .</span><span class="sxs-lookup"><span data-stu-id="add71-136">To clean up the data associated with a fiber, call the [**DeleteFiber**](/windows/desktop/api/WinBase/nf-winbase-deletefiber) function.</span></span> <span data-ttu-id="add71-137">Ces données incluent la pile, un sous-ensemble des registres et les données de fibre.</span><span class="sxs-lookup"><span data-stu-id="add71-137">This data includes the stack, a subset of the registers, and the fiber data.</span></span> <span data-ttu-id="add71-138">Si la fibre en cours d’exécution appelle **DeleteFiber**, son thread appelle [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) et se termine.</span><span class="sxs-lookup"><span data-stu-id="add71-138">If the currently running fiber calls **DeleteFiber**, its thread calls [**ExitThread**](/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitthread) and terminates.</span></span> <span data-ttu-id="add71-139">Toutefois, si la fibre sélectionnée d’un thread est supprimée par une fibre s’exécutant dans un autre thread, le thread avec la fibre supprimée est susceptible de se terminer anormalement, car la pile de fibres a été libérée.</span><span class="sxs-lookup"><span data-stu-id="add71-139">However, if the selected fiber of a thread is deleted by a fiber running in another thread, the thread with the deleted fiber is likely to terminate abnormally because the fiber stack has been freed.</span></span>

## <a name="related-topics"></a><span data-ttu-id="add71-140">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="add71-140">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="add71-141">Utilisation de fibres</span><span class="sxs-lookup"><span data-stu-id="add71-141">Using Fibers</span></span>](using-fibers.md)
</dt> </dl>

 

 
