---
description: Une DLL peut éventuellement spécifier une fonction de point d’entrée.
ms.assetid: ec035fc6-0a6f-4e52-a4cc-8d7a25a94366
title: Entry-Point fonction de la bibliothèque de Dynamic-Link
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b62bff557bfa2aa792b420e8fe1856bbe0726921
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103753773"
---
# <a name="dynamic-link-library-entry-point-function"></a><span data-ttu-id="7c3b2-103">Entry-Point fonction de la bibliothèque de Dynamic-Link</span><span class="sxs-lookup"><span data-stu-id="7c3b2-103">Dynamic-Link Library Entry-Point Function</span></span>

<span data-ttu-id="7c3b2-104">Une DLL peut éventuellement spécifier une fonction de point d’entrée.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-104">A DLL can optionally specify an entry-point function.</span></span> <span data-ttu-id="7c3b2-105">Si elle est présente, le système appelle la fonction de point d’entrée chaque fois qu’un processus ou un thread charge ou décharge la DLL.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-105">If present, the system calls the entry-point function whenever a process or thread loads or unloads the DLL.</span></span> <span data-ttu-id="7c3b2-106">Il peut être utilisé pour effectuer des tâches d’initialisation et de nettoyage simples.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-106">It can be used to perform simple initialization and cleanup tasks.</span></span> <span data-ttu-id="7c3b2-107">Par exemple, il peut configurer le stockage local des threads lorsqu’un nouveau thread est créé, et le nettoyer lorsque le thread est arrêté.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-107">For example, it can set up thread local storage when a new thread is created, and clean it up when the thread is terminated.</span></span>

<span data-ttu-id="7c3b2-108">Si vous liez votre DLL à la bibliothèque Runtime C, elle peut fournir une fonction de point d’entrée pour vous, et vous permettre de fournir une fonction d’initialisation distincte.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-108">If you are linking your DLL with the C run-time library, it may provide an entry-point function for you, and allow you to provide a separate initialization function.</span></span> <span data-ttu-id="7c3b2-109">Pour plus d’informations, consultez la documentation de votre bibliothèque Runtime.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-109">Check the documentation for your run-time library for more information.</span></span>

<span data-ttu-id="7c3b2-110">Si vous fournissez votre propre point d’entrée, consultez la fonction [**DllMain**](dllmain.md) .</span><span class="sxs-lookup"><span data-stu-id="7c3b2-110">If you are providing your own entry-point, see the [**DllMain**](dllmain.md) function.</span></span> <span data-ttu-id="7c3b2-111">Le nom **DllMain** est un espace réservé pour une fonction définie par l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-111">The name **DllMain** is a placeholder for a user-defined function.</span></span> <span data-ttu-id="7c3b2-112">Vous devez spécifier le nom réel que vous utilisez lorsque vous générez votre DLL.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-112">You must specify the actual name you use when you build your DLL.</span></span> <span data-ttu-id="7c3b2-113">Pour plus d’informations, consultez la documentation fournie avec vos outils de développement.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-113">For more information, see the documentation included with your development tools.</span></span>

## <a name="calling-the-entry-point-function"></a><span data-ttu-id="7c3b2-114">Appel de la fonction Entry-Point</span><span class="sxs-lookup"><span data-stu-id="7c3b2-114">Calling the Entry-Point Function</span></span>

<span data-ttu-id="7c3b2-115">Le système appelle la fonction de point d’entrée chaque fois que l’un des événements suivants se produit :</span><span class="sxs-lookup"><span data-stu-id="7c3b2-115">The system calls the entry-point function whenever any one of the following events occurs:</span></span>

-   <span data-ttu-id="7c3b2-116">Un processus charge la DLL.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-116">A process loads the DLL.</span></span> <span data-ttu-id="7c3b2-117">Pour les processus utilisant la liaison dynamique au moment du chargement, la DLL est chargée pendant l’initialisation du processus.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-117">For processes using load-time dynamic linking, the DLL is loaded during process initialization.</span></span> <span data-ttu-id="7c3b2-118">Pour les processus utilisant la liaison au moment de l’exécution, la DLL est chargée avant le retour de [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) ou [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) .</span><span class="sxs-lookup"><span data-stu-id="7c3b2-118">For processes using run-time linking, the DLL is loaded before [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) returns.</span></span>
-   <span data-ttu-id="7c3b2-119">Un processus décharge la DLL.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-119">A process unloads the DLL.</span></span> <span data-ttu-id="7c3b2-120">La DLL est déchargée lorsque le processus se termine ou appelle la fonction [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) et que le nombre de références est égal à zéro.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-120">The DLL is unloaded when the process terminates or calls the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function and the reference count becomes zero.</span></span> <span data-ttu-id="7c3b2-121">Si le processus se termine à la suite de la fonction [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) ou [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) , le système n’appelle pas la fonction de point d’entrée dll.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-121">If the process terminates as a result of the [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) or [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) function, the system does not call the DLL entry-point function.</span></span>
-   <span data-ttu-id="7c3b2-122">Un nouveau thread est créé dans un processus qui a chargé la DLL.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-122">A new thread is created in a process that has loaded the DLL.</span></span> <span data-ttu-id="7c3b2-123">Vous pouvez utiliser la fonction [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) pour désactiver la notification lors de la création de threads.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-123">You can use the [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) function to disable notification when threads are created.</span></span>
-   <span data-ttu-id="7c3b2-124">Un thread d’un processus qui a chargé la DLL s’arrête normalement, sans utiliser [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) ou [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess).</span><span class="sxs-lookup"><span data-stu-id="7c3b2-124">A thread of a process that has loaded the DLL terminates normally, not using [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread) or [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess).</span></span> <span data-ttu-id="7c3b2-125">Lorsqu’un processus décharge la DLL, la fonction de point d’entrée est appelée une seule fois pour l’ensemble du processus, plutôt qu’une fois pour chaque thread existant du processus.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-125">When a process unloads the DLL, the entry-point function is called only once for the entire process, rather than once for each existing thread of the process.</span></span> <span data-ttu-id="7c3b2-126">Vous pouvez utiliser [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) pour désactiver la notification lorsque les threads sont terminés.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-126">You can use [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) to disable notification when threads are terminated.</span></span>

<span data-ttu-id="7c3b2-127">Un seul thread à la fois peut appeler la fonction de point d’entrée.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-127">Only one thread at a time can call the entry-point function.</span></span>

<span data-ttu-id="7c3b2-128">Le système appelle la fonction de point d’entrée dans le contexte du processus ou du thread qui a provoqué l’appel de la fonction.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-128">The system calls the entry-point function in the context of the process or thread that caused the function to be called.</span></span> <span data-ttu-id="7c3b2-129">Cela permet à une DLL d’utiliser sa fonction de point d’entrée pour allouer de la mémoire dans l’espace d’adressage virtuel du processus appelant ou pour ouvrir des handles accessibles au processus.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-129">This allows a DLL to use its entry-point function for allocating memory in the virtual address space of the calling process or to open handles accessible to the process.</span></span> <span data-ttu-id="7c3b2-130">La fonction de point d’entrée peut également allouer de la mémoire qui est privée à un nouveau thread à l’aide du stockage local des threads (TLS).</span><span class="sxs-lookup"><span data-stu-id="7c3b2-130">The entry-point function can also allocate memory that is private to a new thread by using thread local storage (TLS).</span></span> <span data-ttu-id="7c3b2-131">Pour plus d’informations sur le stockage local des threads, consultez [stockage local des threads](/windows/desktop/ProcThread/thread-local-storage).</span><span class="sxs-lookup"><span data-stu-id="7c3b2-131">For more information about thread local storage, see [Thread Local Storage](/windows/desktop/ProcThread/thread-local-storage).</span></span>

## <a name="entry-point-function-definition"></a><span data-ttu-id="7c3b2-132">Définition de la fonction Entry-Point</span><span class="sxs-lookup"><span data-stu-id="7c3b2-132">Entry-Point Function Definition</span></span>

<span data-ttu-id="7c3b2-133">La fonction de point d’entrée de DLL doit être déclarée avec la Convention d’appel d’appel standard.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-133">The DLL entry-point function must be declared with the standard-call calling convention.</span></span> <span data-ttu-id="7c3b2-134">Si le point d’entrée de la DLL n’est pas déclaré correctement, la DLL n’est pas chargée et le système affiche un message indiquant que le point d’entrée de la DLL doit être déclaré avec WINAPI.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-134">If the DLL entry point is not declared correctly, the DLL is not loaded, and the system displays a message indicating that the DLL entry point must be declared with WINAPI.</span></span>

<span data-ttu-id="7c3b2-135">Dans le corps de la fonction, vous pouvez gérer n’importe quelle combinaison des scénarios suivants dans lesquels le point d’entrée de la DLL a été appelé :</span><span class="sxs-lookup"><span data-stu-id="7c3b2-135">In the body of the function, you may handle any combination of the following scenarios in which the DLL entry point has been called:</span></span>

-   <span data-ttu-id="7c3b2-136">Un processus charge la DLL (**\_ \_ attachement du processus dll**).</span><span class="sxs-lookup"><span data-stu-id="7c3b2-136">A process loads the DLL (**DLL\_PROCESS\_ATTACH**).</span></span>
-   <span data-ttu-id="7c3b2-137">Le processus en cours crée un thread (**\_ \_ attachement de thread dll**).</span><span class="sxs-lookup"><span data-stu-id="7c3b2-137">The current process creates a new thread (**DLL\_THREAD\_ATTACH**).</span></span>
-   <span data-ttu-id="7c3b2-138">Un thread s’arrête normalement (**\_ \_ détachement de thread dll**).</span><span class="sxs-lookup"><span data-stu-id="7c3b2-138">A thread exits normally (**DLL\_THREAD\_DETACH**).</span></span>
-   <span data-ttu-id="7c3b2-139">Un processus décharge la DLL (**\_ \_ détachement de processus dll**).</span><span class="sxs-lookup"><span data-stu-id="7c3b2-139">A process unloads the DLL (**DLL\_PROCESS\_DETACH**).</span></span>

<span data-ttu-id="7c3b2-140">La fonction de point d’entrée doit effectuer uniquement des tâches d’initialisation simples.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-140">The entry-point function should perform only simple initialization tasks.</span></span> <span data-ttu-id="7c3b2-141">Elle ne doit pas appeler la fonction [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) ou [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) (ou une fonction qui appelle ces fonctions), car cela peut créer des boucles de dépendance dans l’ordre de chargement de la dll.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-141">It must not call the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function (or a function that calls these functions), because this may create dependency loops in the DLL load order.</span></span> <span data-ttu-id="7c3b2-142">Cela peut entraîner l’utilisation d’une DLL avant l’exécution du code d’initialisation du système.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-142">This can result in a DLL being used before the system has executed its initialization code.</span></span> <span data-ttu-id="7c3b2-143">De même, la fonction de point d’entrée ne doit pas appeler la fonction [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) (ou une fonction qui appelle **FreeLibrary**) pendant l’arrêt du processus, car cela peut entraîner l’utilisation d’une dll après l’exécution du code d’arrêt du système.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-143">Similarly, the entry-point function must not call the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function (or a function that calls **FreeLibrary**) during process termination, because this can result in a DLL being used after the system has executed its termination code.</span></span>

<span data-ttu-id="7c3b2-144">Étant donné que le chargement de Kernel32.dll est garanti dans l’espace d’adressage de processus lorsque la fonction de point d’entrée est appelée, l’appel de fonctions dans Kernel32.dll n’entraîne pas l’utilisation de la DLL avant l’exécution de son code d’initialisation.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-144">Because Kernel32.dll is guaranteed to be loaded in the process address space when the entry-point function is called, calling functions in Kernel32.dll does not result in the DLL being used before its initialization code has been executed.</span></span> <span data-ttu-id="7c3b2-145">Par conséquent, la fonction de point d’entrée peut créer des [objets de synchronisation](/windows/desktop/Sync/synchronization-objects) , tels que des sections critiques et des mutex, et utiliser TLS, car ces fonctions se trouvent dans Kernel32.dll.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-145">Therefore, the entry-point function can create [synchronization objects](/windows/desktop/Sync/synchronization-objects) such as critical sections and mutexes, and use TLS, because these functions are located in Kernel32.dll.</span></span> <span data-ttu-id="7c3b2-146">Il n’est pas recommandé d’appeler les fonctions de Registre, par exemple, car elles se trouvent dans Advapi32.dll.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-146">It is not safe to call the registry functions, for example, because they are located in Advapi32.dll.</span></span>

<span data-ttu-id="7c3b2-147">L’appel d’autres fonctions peut entraîner des problèmes difficiles à diagnostiquer.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-147">Calling other functions may result in problems that are difficult to diagnose.</span></span> <span data-ttu-id="7c3b2-148">Par exemple, l’appel de fonctions utilisateur, Shell et COM peut provoquer des erreurs de violation d’accès, car certaines fonctions dans leurs dll appellent [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) pour charger d’autres composants système.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-148">For example, calling User, Shell, and COM functions can cause access violation errors, because some functions in their DLLs call [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) to load other system components.</span></span> <span data-ttu-id="7c3b2-149">Inversement, l’appel de ces fonctions pendant l’arrêt peut entraîner des erreurs de violation d’accès, car le composant correspondant a peut-être déjà été déchargé ou non initialisé.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-149">Conversely, calling those functions during termination can cause access violation errors because the corresponding component may already have been unloaded or uninitialized.</span></span>

<span data-ttu-id="7c3b2-150">L’exemple suivant montre comment structurer la fonction de point d’entrée DLL.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-150">The following example demonstrates how to structure the DLL entry-point function.</span></span>

``` syntax
BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved )  // reserved
{
    // Perform actions based on the reason for calling.
    switch( fdwReason ) 
    { 
        case DLL_PROCESS_ATTACH:
         // Initialize once for each new process.
         // Return FALSE to fail DLL load.
            break;

        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;

        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;

        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    return TRUE;  // Successful DLL_PROCESS_ATTACH.
}
```

## <a name="entry-point-function-return-value"></a><span data-ttu-id="7c3b2-151">Valeur de retour de la fonction Entry-Point</span><span class="sxs-lookup"><span data-stu-id="7c3b2-151">Entry-Point Function Return Value</span></span>

<span data-ttu-id="7c3b2-152">Quand une fonction de point d’entrée DLL est appelée car un processus est en cours de chargement, la fonction retourne la **valeur true** pour indiquer la réussite.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-152">When a DLL entry-point function is called because a process is loading, the function returns **TRUE** to indicate success.</span></span> <span data-ttu-id="7c3b2-153">Pour les processus utilisant la liaison au moment du chargement, la valeur de retour **false** entraîne l’échec de l’initialisation du processus et le processus se termine.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-153">For processes using load-time linking, a return value of **FALSE** causes the process initialization to fail and the process terminates.</span></span> <span data-ttu-id="7c3b2-154">Pour les processus utilisant la liaison au moment de l’exécution, la valeur de retour FALSe fait que la fonction [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) ou [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) retourne la valeur **null**, ce qui indique un échec.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-154">For processes using run-time linking, a return value of FALSE causes the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function to return **NULL**, indicating failure.</span></span> <span data-ttu-id="7c3b2-155">(Le système appelle immédiatement votre fonction de point d’entrée avec le **\_ \_ détachement de processus dll** et décharge la dll.) La valeur de retour de la fonction de point d’entrée est ignorée lorsque la fonction est appelée pour une autre raison.</span><span class="sxs-lookup"><span data-stu-id="7c3b2-155">(The system immediately calls your entry-point function with **DLL\_PROCESS\_DETACH** and unloads the DLL.) The return value of the entry-point function is disregarded when the function is called for any other reason.</span></span>

 

 
