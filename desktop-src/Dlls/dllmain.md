---
description: Point d’entrée facultatif dans une bibliothèque de liens dynamiques (DLL). Lorsque le système démarre ou termine un processus ou un thread, il appelle la fonction de point d’entrée pour chaque DLL chargée à l’aide du premier thread du processus.
ms.assetid: 0c3e3083-9297-4626-b2a7-0062d1c2cf9e
title: Point d’entrée DllMain (Process. h)
ms.topic: reference
ms.date: 07/22/2020
topic_type:
- APIRef
- kbSyntax
api_name:
- DllMain
api_type:
- UserDefined
api_location:
- process.h
ms.openlocfilehash: ee182fd54f11909e54e98f827904f1da5e46f557
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "106518733"
---
# <a name="dllmain-entry-point"></a><span data-ttu-id="26eed-104">Point d’entrée DllMain</span><span class="sxs-lookup"><span data-stu-id="26eed-104">DllMain entry point</span></span>

<span data-ttu-id="26eed-105">Point d’entrée facultatif dans une bibliothèque de liens dynamiques (DLL).</span><span class="sxs-lookup"><span data-stu-id="26eed-105">An optional entry point into a dynamic-link library (DLL).</span></span> <span data-ttu-id="26eed-106">Lorsque le système démarre ou termine un processus ou un thread, il appelle la fonction de point d’entrée pour chaque DLL chargée à l’aide du premier thread du processus.</span><span class="sxs-lookup"><span data-stu-id="26eed-106">When the system starts or terminates a process or thread, it calls the entry-point function for each loaded DLL using the first thread of the process.</span></span> <span data-ttu-id="26eed-107">Le système appelle également la fonction de point d’entrée pour une DLL lorsqu’elle est chargée ou déchargée à l’aide des fonctions [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) et [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) .</span><span class="sxs-lookup"><span data-stu-id="26eed-107">The system also calls the entry-point function for a DLL when it is loaded or unloaded using the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) and [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) functions.</span></span>

## <a name="example"></a><span data-ttu-id="26eed-108">Exemple</span><span class="sxs-lookup"><span data-stu-id="26eed-108">Example</span></span>

```cpp
BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved )  // reserved
{
    // Perform actions based on the reason for calling.
    switch( fdwReason ) 
    { 
        case DLL_PROCESS_ATTACH:
         // Initialize once for each new process.
         // Return FALSE to fail DLL load.
            break;

        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;

        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;

        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    return TRUE;  // Successful DLL_PROCESS_ATTACH.
}
```

<span data-ttu-id="26eed-109">Il s’agit d’un exemple de la [bibliothèque de liens dynamiques Entry-Point fonction](dynamic-link-library-entry-point-function.md).</span><span class="sxs-lookup"><span data-stu-id="26eed-109">This is an example from the [Dynamic-Link Library Entry-Point Function](dynamic-link-library-entry-point-function.md).</span></span>


> [!WARNING]
> <span data-ttu-id="26eed-110">Il existe des limites significatives sur ce que vous pouvez faire en toute sécurité dans un point d’entrée de DLL.</span><span class="sxs-lookup"><span data-stu-id="26eed-110">There are significant limits on what you can safely do in a DLL entry point.</span></span> <span data-ttu-id="26eed-111">Consultez les [meilleures pratiques générales](dynamic-link-library-best-practices.md) pour des API Windows spécifiques qui ne peuvent pas être appelées dans DllMain.</span><span class="sxs-lookup"><span data-stu-id="26eed-111">See [General Best Practices](dynamic-link-library-best-practices.md) for specific Windows APIs that are unsafe to call in DllMain.</span></span> <span data-ttu-id="26eed-112">Si vous n’avez besoin que de l’initialisation la plus simple, faites-le dans une fonction d’initialisation pour la DLL.</span><span class="sxs-lookup"><span data-stu-id="26eed-112">If you need anything but the simplest initialization then do that in an initialization function for the DLL.</span></span> <span data-ttu-id="26eed-113">Vous pouvez demander aux applications d’appeler la fonction d’initialisation après l’exécution de DllMain et avant d’appeler d’autres fonctions dans la DLL.</span><span class="sxs-lookup"><span data-stu-id="26eed-113">You can require applications to call the initialization function after DllMain has run and before they call any other functions in the DLL.</span></span>

 

## <a name="syntax"></a><span data-ttu-id="26eed-114">Syntaxe</span><span class="sxs-lookup"><span data-stu-id="26eed-114">Syntax</span></span>


```C++
BOOL WINAPI DllMain(
  _In_ HINSTANCE hinstDLL,
  _In_ DWORD     fdwReason,
  _In_ LPVOID    lpvReserved
);
```



## <a name="parameters"></a><span data-ttu-id="26eed-115">Paramètres</span><span class="sxs-lookup"><span data-stu-id="26eed-115">Parameters</span></span>

<dl> <dt>

<span data-ttu-id="26eed-116">*hinstDLL* \[ dans\]</span><span class="sxs-lookup"><span data-stu-id="26eed-116">*hinstDLL* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="26eed-117">Handle du module DLL.</span><span class="sxs-lookup"><span data-stu-id="26eed-117">A handle to the DLL module.</span></span> <span data-ttu-id="26eed-118">La valeur est l’adresse de base de la DLL.</span><span class="sxs-lookup"><span data-stu-id="26eed-118">The value is the base address of the DLL.</span></span> <span data-ttu-id="26eed-119">Le **HINSTANCE** d’une dll est le même que le **HMODULE** de la dll. par conséquent, *hinstDLL* peut être utilisé dans les appels aux fonctions qui requièrent un handle de module.</span><span class="sxs-lookup"><span data-stu-id="26eed-119">The **HINSTANCE** of a DLL is the same as the **HMODULE** of the DLL, so *hinstDLL* can be used in calls to functions that require a module handle.</span></span>

</dd> <dt>

<span data-ttu-id="26eed-120">*fdwReason* \[ dans\]</span><span class="sxs-lookup"><span data-stu-id="26eed-120">*fdwReason* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="26eed-121">Code de raison qui indique la raison pour laquelle la fonction de point d’entrée de la DLL est appelée.</span><span class="sxs-lookup"><span data-stu-id="26eed-121">The reason code that indicates why the DLL entry-point function is being called.</span></span> <span data-ttu-id="26eed-122">Ce paramètre peut prendre les valeurs suivantes.</span><span class="sxs-lookup"><span data-stu-id="26eed-122">This parameter can be one of the following values.</span></span>



| <span data-ttu-id="26eed-123">Valeur</span><span class="sxs-lookup"><span data-stu-id="26eed-123">Value</span></span>                                                                                                                                                                                                                                | <span data-ttu-id="26eed-124">Signification</span><span class="sxs-lookup"><span data-stu-id="26eed-124">Meaning</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span id="DLL_PROCESS_ATTACH"></span><span id="dll_process_attach"></span><dl> <span data-ttu-id="26eed-125"><dt>**Dll \_ \_Attachement de processus**</dt> <dt>1</dt></span><span class="sxs-lookup"><span data-stu-id="26eed-125"><dt>**DLL\_PROCESS\_ATTACH**</dt> <dt>1</dt></span></span> </dl> | <span data-ttu-id="26eed-126">La DLL est chargée dans l’espace d’adressage virtuel du processus en cours suite au démarrage du processus ou à la suite d’un appel à [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya).</span><span class="sxs-lookup"><span data-stu-id="26eed-126">The DLL is being loaded into the virtual address space of the current process as a result of the process starting up or as a result of a call to [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya).</span></span> <span data-ttu-id="26eed-127">Les dll peuvent utiliser cette opportunité pour initialiser toutes les données d’instance ou pour utiliser la fonction [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) pour allouer un index de stockage local des threads (TLS).</span><span class="sxs-lookup"><span data-stu-id="26eed-127">DLLs can use this opportunity to initialize any instance data or to use the [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) function to allocate a thread local storage (TLS) index.</span></span><br/> <span data-ttu-id="26eed-128">Le paramètre *lpReserved* indique si la dll est chargée de manière statique ou dynamique.</span><span class="sxs-lookup"><span data-stu-id="26eed-128">The *lpReserved* parameter indicates whether the DLL is being loaded statically or dynamically.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span id="DLL_PROCESS_DETACH"></span><span id="dll_process_detach"></span><dl> <span data-ttu-id="26eed-129"><dt>**Dll \_ \_Détacher le processus**</dt> <dt>0</dt></span><span class="sxs-lookup"><span data-stu-id="26eed-129"><dt>**DLL\_PROCESS\_DETACH**</dt> <dt>0</dt></span></span> </dl> | <span data-ttu-id="26eed-130">La DLL est déchargée de l’espace d’adressage virtuel du processus appelant, car elle a été chargée sans succès ou le décompte de références a atteint zéro (les processus se sont terminés ou s’ils ont été appelés [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) une seule fois pour chaque fois que ce dernier appelle [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="26eed-130">The DLL is being unloaded from the virtual address space of the calling process because it was loaded unsuccessfully or the reference count has reached zero (the processes has either terminated or called [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) one time for each time it called [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span><br/> <span data-ttu-id="26eed-131">Le paramètre *lpReserved* indique si la dll est déchargée suite à un appel [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) , à un échec de chargement ou à un arrêt de processus.</span><span class="sxs-lookup"><span data-stu-id="26eed-131">The *lpReserved* parameter indicates whether the DLL is being unloaded as a result of a [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) call, a failure to load, or process termination.</span></span><br/> <span data-ttu-id="26eed-132">La DLL peut utiliser cette opportunité pour appeler la fonction [**TlsFree**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree) afin de libérer les index TLS alloués à l’aide de [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) et libérer les données locales du thread.</span><span class="sxs-lookup"><span data-stu-id="26eed-132">The DLL can use this opportunity to call the [**TlsFree**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree) function to free any TLS indices allocated by using [**TlsAlloc**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc) and to free any thread local data.</span></span><br/> <span data-ttu-id="26eed-133">Notez que le thread qui reçoit la notification de **\_ \_ détachement de processus dll** n’est pas nécessairement le même que celui qui a reçu la notification d' **\_ \_ attachement de processus dll** .</span><span class="sxs-lookup"><span data-stu-id="26eed-133">Note that the thread that receives the **DLL\_PROCESS\_DETACH** notification is not necessarily the same thread that received the **DLL\_PROCESS\_ATTACH** notification.</span></span><br/> |
| <span id="DLL_THREAD_ATTACH"></span><span id="dll_thread_attach"></span><dl> <span data-ttu-id="26eed-134"><dt>**Dll \_ \_Attachement de thread**</dt> <dt>2</dt></span><span class="sxs-lookup"><span data-stu-id="26eed-134"><dt>**DLL\_THREAD\_ATTACH**</dt> <dt>2</dt></span></span> </dl>    | <span data-ttu-id="26eed-135">Le processus en cours crée un nouveau thread.</span><span class="sxs-lookup"><span data-stu-id="26eed-135">The current process is creating a new thread.</span></span> <span data-ttu-id="26eed-136">Dans ce cas, le système appelle la fonction de point d’entrée de toutes les dll actuellement attachées au processus.</span><span class="sxs-lookup"><span data-stu-id="26eed-136">When this occurs, the system calls the entry-point function of all DLLs currently attached to the process.</span></span> <span data-ttu-id="26eed-137">L’appel est effectué dans le contexte du nouveau thread.</span><span class="sxs-lookup"><span data-stu-id="26eed-137">The call is made in the context of the new thread.</span></span> <span data-ttu-id="26eed-138">Les dll peuvent utiliser cette opportunité pour initialiser un emplacement TLS pour le thread.</span><span class="sxs-lookup"><span data-stu-id="26eed-138">DLLs can use this opportunity to initialize a TLS slot for the thread.</span></span> <span data-ttu-id="26eed-139">Un thread qui appelle la fonction de point d’entrée DLL avec l' **\_ \_ attachement de processus dll** n’appelle pas la fonction de point d’entrée dll avec l' **attachement de \_ thread \_ de dll**.</span><span class="sxs-lookup"><span data-stu-id="26eed-139">A thread calling the DLL entry-point function with **DLL\_PROCESS\_ATTACH** does not call the DLL entry-point function with **DLL\_THREAD\_ATTACH**.</span></span> <br/> <span data-ttu-id="26eed-140">Notez que la fonction de point d’entrée d’une DLL est appelée avec cette valeur uniquement par les threads créés après le chargement de la DLL par le processus.</span><span class="sxs-lookup"><span data-stu-id="26eed-140">Note that a DLL's entry-point function is called with this value only by threads created after the DLL is loaded by the process.</span></span> <span data-ttu-id="26eed-141">Quand une DLL est chargée à l’aide de [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), les threads existants n’appellent pas la fonction de point d’entrée de la dll nouvellement chargée.</span><span class="sxs-lookup"><span data-stu-id="26eed-141">When a DLL is loaded using [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), existing threads do not call the entry-point function of the newly loaded DLL.</span></span><br/>                                                                                                                                                                       |
| <span id="DLL_THREAD_DETACH"></span><span id="dll_thread_detach"></span><dl> <span data-ttu-id="26eed-142"><dt>**Dll \_ \_Détachement de thread**</dt> <dt>3</dt></span><span class="sxs-lookup"><span data-stu-id="26eed-142"><dt>**DLL\_THREAD\_DETACH**</dt> <dt>3</dt></span></span> </dl>    | <span data-ttu-id="26eed-143">Un thread s’arrête correctement.</span><span class="sxs-lookup"><span data-stu-id="26eed-143">A thread is exiting cleanly.</span></span> <span data-ttu-id="26eed-144">Si la DLL a stocké un pointeur vers la mémoire allouée dans un emplacement TLS, elle doit utiliser cette opportunité pour libérer de la mémoire.</span><span class="sxs-lookup"><span data-stu-id="26eed-144">If the DLL has stored a pointer to allocated memory in a TLS slot, it should use this opportunity to free the memory.</span></span> <span data-ttu-id="26eed-145">Le système appelle la fonction de point d’entrée de toutes les dll actuellement chargées avec cette valeur.</span><span class="sxs-lookup"><span data-stu-id="26eed-145">The system calls the entry-point function of all currently loaded DLLs with this value.</span></span> <span data-ttu-id="26eed-146">L’appel est effectué dans le contexte du thread de sortie.</span><span class="sxs-lookup"><span data-stu-id="26eed-146">The call is made in the context of the exiting thread.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |



 

</dd> <dt>

<span data-ttu-id="26eed-147">*lpvReserved* \[ dans\]</span><span class="sxs-lookup"><span data-stu-id="26eed-147">*lpvReserved* \[in\]</span></span>
</dt> <dd>

<span data-ttu-id="26eed-148">Si *fdwReason* est **un \_ \_ attachement de processus dll**, *lpvReserved* a la **valeur null** pour les charges dynamiques et non null pour les charges statiques.</span><span class="sxs-lookup"><span data-stu-id="26eed-148">If *fdwReason* is **DLL\_PROCESS\_ATTACH**, *lpvReserved* is **NULL** for dynamic loads and non-NULL for static loads.</span></span>

<span data-ttu-id="26eed-149">Si *fdwReason* est **un \_ processus de \_ détachement de dll**, *lpvReserved* a la **valeur null** si [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) a été appelé ou si le chargement de la dll a échoué et n’a pas la **valeur null** si le processus se termine.</span><span class="sxs-lookup"><span data-stu-id="26eed-149">If *fdwReason* is **DLL\_PROCESS\_DETACH**, *lpvReserved* is **NULL** if [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) has been called or the DLL load failed and non-**NULL** if the process is terminating.</span></span>

</dd> </dl>

## <a name="return-value"></a><span data-ttu-id="26eed-150">Valeur retournée</span><span class="sxs-lookup"><span data-stu-id="26eed-150">Return value</span></span>

<span data-ttu-id="26eed-151">Lorsque le système appelle la fonction **DllMain** avec la valeur d' **\_ \_ attachement du processus dll** , la fonction retourne **true** si elle réussit ou **false** si l’initialisation échoue.</span><span class="sxs-lookup"><span data-stu-id="26eed-151">When the system calls the **DllMain** function with the **DLL\_PROCESS\_ATTACH** value, the function returns **TRUE** if it succeeds or **FALSE** if initialization fails.</span></span> <span data-ttu-id="26eed-152">Si la valeur de retour est **false** lorsque **DllMain** est appelé, car le processus utilise la fonction [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) , **LoadLibrary** retourne la valeur null.</span><span class="sxs-lookup"><span data-stu-id="26eed-152">If the return value is **FALSE** when **DllMain** is called because the process uses the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) function, **LoadLibrary** returns NULL.</span></span> <span data-ttu-id="26eed-153">(Le système appelle immédiatement votre fonction de point d’entrée avec le **\_ \_ détachement de processus dll** et décharge la dll.) Si la valeur de retour est **false** lorsque **DllMain** est appelé pendant l’initialisation du processus, le processus se termine avec une erreur.</span><span class="sxs-lookup"><span data-stu-id="26eed-153">(The system immediately calls your entry-point function with **DLL\_PROCESS\_DETACH** and unloads the DLL.) If the return value is **FALSE** when **DllMain** is called during process initialization, the process terminates with an error.</span></span> <span data-ttu-id="26eed-154">Pour obtenir des informations détaillées sur l’erreur, appelez [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror).</span><span class="sxs-lookup"><span data-stu-id="26eed-154">To get extended error information, call [**GetLastError**](/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror).</span></span>

<span data-ttu-id="26eed-155">Lorsque le système appelle la fonction **DllMain** avec une valeur autre que le **processus d' \_ \_ attachement de dll**, la valeur de retour est ignorée.</span><span class="sxs-lookup"><span data-stu-id="26eed-155">When the system calls the **DllMain** function with any value other than **DLL\_PROCESS\_ATTACH**, the return value is ignored.</span></span>

## <a name="remarks"></a><span data-ttu-id="26eed-156">Notes</span><span class="sxs-lookup"><span data-stu-id="26eed-156">Remarks</span></span>

<span data-ttu-id="26eed-157">**DllMain** est un espace réservé pour le nom de la fonction définie par la bibliothèque.</span><span class="sxs-lookup"><span data-stu-id="26eed-157">**DllMain** is a placeholder for the library-defined function name.</span></span> <span data-ttu-id="26eed-158">Vous devez spécifier le nom réel que vous utilisez lorsque vous générez votre DLL.</span><span class="sxs-lookup"><span data-stu-id="26eed-158">You must specify the actual name you use when you build your DLL.</span></span> <span data-ttu-id="26eed-159">Pour plus d’informations, consultez la documentation fournie avec vos outils de développement.</span><span class="sxs-lookup"><span data-stu-id="26eed-159">For more information, see the documentation included with your development tools.</span></span>

<span data-ttu-id="26eed-160">Lors du démarrage initial du processus ou après un appel à [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), le système analyse la liste des DLL chargées pour le processus.</span><span class="sxs-lookup"><span data-stu-id="26eed-160">During initial process startup or after a call to [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya), the system scans the list of loaded DLLs for the process.</span></span> <span data-ttu-id="26eed-161">Pour chaque DLL qui n’a pas encore été appelée avec la valeur d' **\_ \_ attachement du processus dll** , le système appelle la fonction de point d’entrée de la dll.</span><span class="sxs-lookup"><span data-stu-id="26eed-161">For each DLL that has not already been called with the **DLL\_PROCESS\_ATTACH** value, the system calls the DLL's entry-point function.</span></span> <span data-ttu-id="26eed-162">Cet appel est effectué dans le contexte du thread qui a provoqué la modification de l’espace d’adressage du processus, par exemple le thread principal du processus ou le thread qui a appelé **LoadLibrary**.</span><span class="sxs-lookup"><span data-stu-id="26eed-162">This call is made in the context of the thread that caused the process address space to change, such as the primary thread of the process or the thread that called **LoadLibrary**.</span></span> <span data-ttu-id="26eed-163">L’accès au point d’entrée est sérialisé par le système à l’échelle du processus.</span><span class="sxs-lookup"><span data-stu-id="26eed-163">Access to the entry point is serialized by the system on a process-wide basis.</span></span> <span data-ttu-id="26eed-164">Les threads dans *DllMain* maintiennent le verrou du chargeur, de sorte qu’aucune dll supplémentaire ne peut être chargée ou initialisée dynamiquement.</span><span class="sxs-lookup"><span data-stu-id="26eed-164">Threads in *DllMain* hold the loader lock so no additional DLLs can be dynamically loaded or initialized.</span></span>

<span data-ttu-id="26eed-165">Si la fonction de point d’entrée de la DLL retourne la valeur FALSe après une notification d' **\_ \_ attachement de processus dll** , elle reçoit une notification de **\_ \_ détachement de processus dll** et la dll est déchargée immédiatement.</span><span class="sxs-lookup"><span data-stu-id="26eed-165">If the DLL's entry-point function returns FALSE following a **DLL\_PROCESS\_ATTACH** notification, it receives a **DLL\_PROCESS\_DETACH** notification and the DLL is unloaded immediately.</span></span> <span data-ttu-id="26eed-166">Toutefois, si le code d' **\_ \_ attachement du processus dll** lève une exception, la fonction de point d’entrée ne recevra pas la notification de **\_ \_ détachement de processus dll** .</span><span class="sxs-lookup"><span data-stu-id="26eed-166">However, if the **DLL\_PROCESS\_ATTACH** code throws an exception, the entry-point function will not receive the **DLL\_PROCESS\_DETACH** notification.</span></span>

<span data-ttu-id="26eed-167">Dans certains cas, la fonction de point d’entrée est appelée pour un thread de fin même si la fonction de point d’entrée n’a jamais été appelée avec l' **\_ \_ attachement de thread de dll** pour le thread :</span><span class="sxs-lookup"><span data-stu-id="26eed-167">There are cases in which the entry-point function is called for a terminating thread even if the entry-point function was never called with **DLL\_THREAD\_ATTACH** for the thread:</span></span>

-   <span data-ttu-id="26eed-168">Le thread était le thread initial dans le processus, donc le système a appelé la fonction de point d’entrée avec la valeur d' **\_ \_ attachement du processus dll** .</span><span class="sxs-lookup"><span data-stu-id="26eed-168">The thread was the initial thread in the process, so the system called the entry-point function with the **DLL\_PROCESS\_ATTACH** value.</span></span>
-   <span data-ttu-id="26eed-169">Le thread était déjà en cours d’exécution lorsqu’un appel à la fonction [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) a été effectué, de sorte que le système n’a jamais appelé la fonction de point d’entrée pour celui-ci.</span><span class="sxs-lookup"><span data-stu-id="26eed-169">The thread was already running when a call to the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) function was made, so the system never called the entry-point function for it.</span></span>

<span data-ttu-id="26eed-170">Lorsqu’une DLL est déchargée d’un processus suite à un échec de chargement de la DLL, à l’arrêt du processus ou à un appel à [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), le système n’appelle pas la fonction de point d’entrée de la dll avec la valeur de **\_ \_ détachement de thread dll** pour les threads individuels du processus.</span><span class="sxs-lookup"><span data-stu-id="26eed-170">When a DLL is unloaded from a process as a result of an unsuccessful load of the DLL, termination of the process, or a call to [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary), the system does not call the DLL's entry-point function with the **DLL\_THREAD\_DETACH** value for the individual threads of the process.</span></span> <span data-ttu-id="26eed-171">La DLL n’est envoyée qu’à une notification de **\_ \_ détachement de processus dll** .</span><span class="sxs-lookup"><span data-stu-id="26eed-171">The DLL is only sent a **DLL\_PROCESS\_DETACH** notification.</span></span> <span data-ttu-id="26eed-172">Les dll peuvent profiter de cette opportunité pour nettoyer toutes les ressources de tous les threads connus de la DLL.</span><span class="sxs-lookup"><span data-stu-id="26eed-172">DLLs can take this opportunity to clean up all resources for all threads known to the DLL.</span></span>

<span data-ttu-id="26eed-173">Lors du traitement du **\_ \_ détachement du processus DLL**, une dll ne doit libérer des ressources telles que la mémoire du tas que si la dll est déchargée dynamiquement (le paramètre *lpReserved* a la **valeur null**).</span><span class="sxs-lookup"><span data-stu-id="26eed-173">When handling **DLL\_PROCESS\_DETACH**, a DLL should free resources such as heap memory only if the DLL is being unloaded dynamically (the *lpReserved* parameter is **NULL**).</span></span> <span data-ttu-id="26eed-174">Si le processus se termine (le paramètre *lpvReserved* n’a pas la **valeur null**), tous les threads du processus, à l’exception du thread actuel, se sont déjà fermés ou ont été arrêtés explicitement par un appel à la fonction [**ExitProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-exitprocess) , ce qui peut entraîner des ressources de processus telles que des segments de mémoire dans un état incohérent.</span><span class="sxs-lookup"><span data-stu-id="26eed-174">If the process is terminating (the *lpvReserved* parameter is non-**NULL**), all threads in the process except the current thread either have exited already or have been explicitly terminated by a call to the [**ExitProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-exitprocess) function, which might leave some process resources such as heaps in an inconsistent state.</span></span> <span data-ttu-id="26eed-175">Dans ce cas, il n’est pas sûr que la DLL nettoie les ressources.</span><span class="sxs-lookup"><span data-stu-id="26eed-175">In this case, it is not safe for the DLL to clean up the resources.</span></span> <span data-ttu-id="26eed-176">Au lieu de cela, la DLL doit permettre au système d’exploitation de libérer de la mémoire.</span><span class="sxs-lookup"><span data-stu-id="26eed-176">Instead, the DLL should allow the operating system to reclaim the memory.</span></span>

<span data-ttu-id="26eed-177">Si vous arrêtez un processus en appelant [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) ou [**TerminateJobObject**](/windows/desktop/api/jobapi2/nf-jobapi2-terminatejobobject), les dll de ce processus ne reçoivent pas de notifications de **\_ \_ détachement de processus dll** .</span><span class="sxs-lookup"><span data-stu-id="26eed-177">If you terminate a process by calling [**TerminateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminateprocess) or [**TerminateJobObject**](/windows/desktop/api/jobapi2/nf-jobapi2-terminatejobobject), the DLLs of that process do not receive **DLL\_PROCESS\_DETACH** notifications.</span></span> <span data-ttu-id="26eed-178">Si vous arrêtez un thread en appelant [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread), les dll de ce thread ne reçoivent pas de notifications de **\_ \_ détachement de thread dll** .</span><span class="sxs-lookup"><span data-stu-id="26eed-178">If you terminate a thread by calling [**TerminateThread**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-terminatethread), the DLLs of that thread do not receive **DLL\_THREAD\_DETACH** notifications.</span></span>

<span data-ttu-id="26eed-179">La fonction de point d’entrée doit effectuer uniquement des tâches d’initialisation ou d’arrêt simples.</span><span class="sxs-lookup"><span data-stu-id="26eed-179">The entry-point function should perform only simple initialization or termination tasks.</span></span> <span data-ttu-id="26eed-180">Elle ne doit pas appeler la fonction [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) ou [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) (ou une fonction qui appelle ces fonctions), car cela peut créer des boucles de dépendance dans l’ordre de chargement de la dll.</span><span class="sxs-lookup"><span data-stu-id="26eed-180">It must not call the [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) or [**LoadLibraryEx**](/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) function (or a function that calls these functions), because this may create dependency loops in the DLL load order.</span></span> <span data-ttu-id="26eed-181">Cela peut entraîner l’utilisation d’une DLL avant l’exécution du code d’initialisation du système.</span><span class="sxs-lookup"><span data-stu-id="26eed-181">This can result in a DLL being used before the system has executed its initialization code.</span></span> <span data-ttu-id="26eed-182">De même, la fonction de point d’entrée ne doit pas appeler la fonction [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) (ou une fonction qui appelle **FreeLibrary**) pendant l’arrêt du processus, car cela peut entraîner l’utilisation d’une dll après l’exécution du code d’arrêt du système.</span><span class="sxs-lookup"><span data-stu-id="26eed-182">Similarly, the entry-point function must not call the [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary) function (or a function that calls **FreeLibrary**) during process termination, because this can result in a DLL being used after the system has executed its termination code.</span></span>

<span data-ttu-id="26eed-183">Étant donné que le chargement de Kernel32.dll est garanti dans l’espace d’adressage de processus lorsque la fonction de point d’entrée est appelée, l’appel de fonctions dans Kernel32.dll n’entraîne pas l’utilisation de la DLL avant l’exécution de son code d’initialisation.</span><span class="sxs-lookup"><span data-stu-id="26eed-183">Because Kernel32.dll is guaranteed to be loaded in the process address space when the entry-point function is called, calling functions in Kernel32.dll does not result in the DLL being used before its initialization code has been executed.</span></span> <span data-ttu-id="26eed-184">Par conséquent, la fonction de point d’entrée peut appeler des fonctions dans Kernel32.dll qui ne chargent pas d’autres dll.</span><span class="sxs-lookup"><span data-stu-id="26eed-184">Therefore, the entry-point function can call functions in Kernel32.dll that do not load other DLLs.</span></span> <span data-ttu-id="26eed-185">Par exemple, *DllMain* peut créer des [objets de synchronisation](/windows/desktop/Sync/synchronization-objects) , tels que des sections critiques et des MUTEX, et utiliser TLS.</span><span class="sxs-lookup"><span data-stu-id="26eed-185">For example, *DllMain* can create [synchronization objects](/windows/desktop/Sync/synchronization-objects) such as critical sections and mutexes, and use TLS.</span></span> <span data-ttu-id="26eed-186">Malheureusement, il n’existe pas de liste exhaustive des fonctions sécurisées dans Kernel32.dll.</span><span class="sxs-lookup"><span data-stu-id="26eed-186">Unfortunately, there is not a comprehensive list of safe functions in Kernel32.dll.</span></span>

<span data-ttu-id="26eed-187">L’appel de fonctions qui requièrent des dll autres que Kernel32.dll peut entraîner des problèmes difficiles à diagnostiquer.</span><span class="sxs-lookup"><span data-stu-id="26eed-187">Calling functions that require DLLs other than Kernel32.dll may result in problems that are difficult to diagnose.</span></span> <span data-ttu-id="26eed-188">Par exemple, l’appel de fonctions d’utilisateur, de Shell et COM peut entraîner des erreurs de violation d’accès, car certaines fonctions chargent d’autres composants système.</span><span class="sxs-lookup"><span data-stu-id="26eed-188">For example, calling User, Shell, and COM functions can cause access violation errors, because some functions load other system components.</span></span> <span data-ttu-id="26eed-189">Inversement, l’appel de fonctions telles que celles-ci pendant l’arrêt peut entraîner des erreurs de violation d’accès, car le composant correspondant a peut-être déjà été déchargé ou non initialisé.</span><span class="sxs-lookup"><span data-stu-id="26eed-189">Conversely, calling functions such as these during termination can cause access violation errors because the corresponding component may already have been unloaded or uninitialized.</span></span>

<span data-ttu-id="26eed-190">Étant donné que les notifications de DLL sont sérialisées, les fonctions de point d’entrée ne doivent pas tenter de communiquer avec d’autres threads ou processus.</span><span class="sxs-lookup"><span data-stu-id="26eed-190">Because DLL notifications are serialized, entry-point functions should not attempt to communicate with other threads or processes.</span></span> <span data-ttu-id="26eed-191">Des blocages peuvent se produire en conséquence.</span><span class="sxs-lookup"><span data-stu-id="26eed-191">Deadlocks may occur as a result.</span></span>

<span data-ttu-id="26eed-192">Pour plus d’informations sur les meilleures pratiques lors de l’écriture d’une DLL, consultez https://docs.microsoft.com/windows/win32/dlls/dynamic-link-library-best-practices .</span><span class="sxs-lookup"><span data-stu-id="26eed-192">For information on best practices when writing a DLL, see https://docs.microsoft.com/windows/win32/dlls/dynamic-link-library-best-practices.</span></span>

<span data-ttu-id="26eed-193">Si votre DLL est liée à la bibliothèque Runtime C (CRT), le point d’entrée fourni par le CRT appelle les constructeurs et les destructeurs pour les objets C++ globaux et statiques.</span><span class="sxs-lookup"><span data-stu-id="26eed-193">If your DLL is linked with the C run-time library (CRT), the entry point provided by the CRT calls the constructors and destructors for global and static C++ objects.</span></span> <span data-ttu-id="26eed-194">Par conséquent, ces restrictions pour *DllMain* s’appliquent également aux constructeurs et aux destructeurs et tout code qui est appelé à partir de ceux-ci.</span><span class="sxs-lookup"><span data-stu-id="26eed-194">Therefore, these restrictions for *DllMain* also apply to constructors and destructors and any code that is called from them.</span></span>

<span data-ttu-id="26eed-195">Envisagez d’appeler [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) lors de la réception d’un **\_ \_ attachement de processus dll**, à moins que votre dll soit liée à la bibliothèque Runtime C statique (CRT).</span><span class="sxs-lookup"><span data-stu-id="26eed-195">Consider calling [**DisableThreadLibraryCalls**](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls) when receiving **DLL\_PROCESS\_ATTACH**, unless your DLL is linked with static C run-time library (CRT).</span></span>


## <a name="requirements"></a><span data-ttu-id="26eed-196">Configuration requise</span><span class="sxs-lookup"><span data-stu-id="26eed-196">Requirements</span></span>



| <span data-ttu-id="26eed-197">Condition requise</span><span class="sxs-lookup"><span data-stu-id="26eed-197">Requirement</span></span> | <span data-ttu-id="26eed-198">Valeur</span><span class="sxs-lookup"><span data-stu-id="26eed-198">Value</span></span> |
|-------------------------------------|--------------------------------------------------------------------------------------|
| <span data-ttu-id="26eed-199">Client minimal pris en charge</span><span class="sxs-lookup"><span data-stu-id="26eed-199">Minimum supported client</span></span><br/> | <span data-ttu-id="26eed-200">Applications de \[ Bureau Windows XP uniquement\]</span><span class="sxs-lookup"><span data-stu-id="26eed-200">Windows XP \[desktop apps only\]</span></span><br/>                                          |
| <span data-ttu-id="26eed-201">Serveur minimal pris en charge</span><span class="sxs-lookup"><span data-stu-id="26eed-201">Minimum supported server</span></span><br/> | <span data-ttu-id="26eed-202">Applications de bureau Windows Server 2003 \[ uniquement\]</span><span class="sxs-lookup"><span data-stu-id="26eed-202">Windows Server 2003 \[desktop apps only\]</span></span><br/>                                 |
| <span data-ttu-id="26eed-203">En-tête</span><span class="sxs-lookup"><span data-stu-id="26eed-203">Header</span></span><br/>                   | <dl> <span data-ttu-id="26eed-204"><dt>Process. h</dt></span><span class="sxs-lookup"><span data-stu-id="26eed-204"><dt>Process.h</dt></span></span> </dl> |



## <a name="see-also"></a><span data-ttu-id="26eed-205">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="26eed-205">See also</span></span>

<dl> <dt>

[<span data-ttu-id="26eed-206">Fonction de Entry-Point de bibliothèque de liens dynamiques</span><span class="sxs-lookup"><span data-stu-id="26eed-206">Dynamic-Link Library Entry-Point Function</span></span>](dynamic-link-library-entry-point-function.md)
</dt> <dt>

[<span data-ttu-id="26eed-207">Fonctions de bibliothèque de liens dynamiques</span><span class="sxs-lookup"><span data-stu-id="26eed-207">Dynamic-Link Library Functions</span></span>](dynamic-link-library-functions.md)
</dt> <dt>

[<span data-ttu-id="26eed-208">**FreeLibrary**</span><span class="sxs-lookup"><span data-stu-id="26eed-208">**FreeLibrary**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary)
</dt> <dt>

[<span data-ttu-id="26eed-209">**GetModuleFileName**</span><span class="sxs-lookup"><span data-stu-id="26eed-209">**GetModuleFileName**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamea)
</dt> <dt>

[<span data-ttu-id="26eed-210">**LoadLibrary**</span><span class="sxs-lookup"><span data-stu-id="26eed-210">**LoadLibrary**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)
</dt> <dt>

[<span data-ttu-id="26eed-211">**TlsAlloc**</span><span class="sxs-lookup"><span data-stu-id="26eed-211">**TlsAlloc**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsalloc)
</dt> <dt>

[<span data-ttu-id="26eed-212">**TlsFree**</span><span class="sxs-lookup"><span data-stu-id="26eed-212">**TlsFree**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-tlsfree)
</dt> <dt>

[<span data-ttu-id="26eed-213">**DisableThreadLibraryCalls**</span><span class="sxs-lookup"><span data-stu-id="26eed-213">**DisableThreadLibraryCalls**</span></span>](/windows/win32/api/libloaderapi/nf-libloaderapi-disablethreadlibrarycalls)





</dt> </dl>
