---
description: Pour créer une requête qui collecte des données de performances à partir d’une source ou d’un fichier journal en temps réel, appelez la fonction PdhOpenQuery. La fonction retourne un handle vers la requête que vous utilisez dans les appels de fonction PDH ultérieurs.
ms.assetid: 6fd4716e-b163-47a3-b0cb-5f9599f8681f
title: Création d'une requête
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5a9d50ec52966529a3476a6d375606ba3d0b538b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104115566"
---
# <a name="creating-a-query"></a><span data-ttu-id="88d6b-104">Création d'une requête</span><span class="sxs-lookup"><span data-stu-id="88d6b-104">Creating a Query</span></span>

<span data-ttu-id="88d6b-105">Pour créer une requête qui collecte des données de performances à partir d’une source ou d’un fichier journal en temps réel, appelez la fonction [**PdhOpenQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhopenquerya) .</span><span class="sxs-lookup"><span data-stu-id="88d6b-105">To create a new query that collects performance data from a real-time source or log file, call the [**PdhOpenQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhopenquerya) function.</span></span> <span data-ttu-id="88d6b-106">La fonction retourne un handle vers la requête que vous utilisez dans les appels de fonction PDH ultérieurs.</span><span class="sxs-lookup"><span data-stu-id="88d6b-106">The function returns a handle to the query that you use in subsequent PDH function calls.</span></span>

<span data-ttu-id="88d6b-107">Après avoir créé la requête, appelez la fonction [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) pour chaque compteur que vous souhaitez ajouter à la requête.</span><span class="sxs-lookup"><span data-stu-id="88d6b-107">After creating the query, call the [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) function for each counter that you want to add to the query.</span></span> <span data-ttu-id="88d6b-108">Vous pouvez utiliser l’une des méthodes suivantes pour fournir le chemin d’accès complet au compteur.</span><span class="sxs-lookup"><span data-stu-id="88d6b-108">You can use one of the following methods to provide the fully qualified counter path.</span></span>

-   <span data-ttu-id="88d6b-109">Définissez le chemin d’accès du compteur comme une chaîne statique.</span><span class="sxs-lookup"><span data-stu-id="88d6b-109">Define the counter path as a static string.</span></span> <span data-ttu-id="88d6b-110">Utilisez cette méthode si vous surveillez toujours le même compteur et si vous êtes familiarisé avec la syntaxe correcte d’un chemin d’accès de compteur.</span><span class="sxs-lookup"><span data-stu-id="88d6b-110">Use this method if you always monitor the same counter, and if you are familiar with the correct syntax of a counter path.</span></span> <span data-ttu-id="88d6b-111">Pour plus d’informations sur la syntaxe correcte utilisée pour spécifier un compteur, consultez [spécification d’un chemin d’accès de compteur](specifying-a-counter-path.md).</span><span class="sxs-lookup"><span data-stu-id="88d6b-111">For information on the correct syntax used to specify a counter, see [Specifying a Counter Path](specifying-a-counter-path.md).</span></span>
-   <span data-ttu-id="88d6b-112">Initialisez une [**structure \_ \_ d' \_ éléments de chemin d’accès de compteur PDH**](/windows/desktop/api/Pdh/ns-pdh-pdh_counter_path_elements_a) avec les noms de l’ordinateur, de l’objet, du compteur et de l’instance.</span><span class="sxs-lookup"><span data-stu-id="88d6b-112">Initialize a [**PDH\_COUNTER\_PATH\_ELEMENTS**](/windows/desktop/api/Pdh/ns-pdh-pdh_counter_path_elements_a) structure with the names of the computer, object, counter, and instance.</span></span> <span data-ttu-id="88d6b-113">Transmettez cette structure à [**PdhMakeCounterPath**](/windows/desktop/api/Pdh/nf-pdh-pdhmakecounterpatha) , qui retournera un chemin de compteur pour les éléments spécifiés.</span><span class="sxs-lookup"><span data-stu-id="88d6b-113">Pass this structure to [**PdhMakeCounterPath**](/windows/desktop/api/Pdh/nf-pdh-pdhmakecounterpatha) which will return a counter path for the specified elements.</span></span>
-   <span data-ttu-id="88d6b-114">Spécifiez un chemin d’accès de compteur qui contient des caractères génériques et appelez [**PdhExpandWildCardPath**](/windows/desktop/api/Pdh/nf-pdh-pdhexpandwildcardpatha) pour obtenir une liste de noms de compteurs qui correspondent aux caractères génériques du chemin d’accès.</span><span class="sxs-lookup"><span data-stu-id="88d6b-114">Specify a counter path that contains wildcard characters and call [**PdhExpandWildCardPath**](/windows/desktop/api/Pdh/nf-pdh-pdhexpandwildcardpatha) to get a list of counter names that match the wildcard characters in the path.</span></span> <span data-ttu-id="88d6b-115">Parcourez la liste des noms de compteurs et ajoutez à la requête les compteurs que vous souhaitez dans cette liste.</span><span class="sxs-lookup"><span data-stu-id="88d6b-115">Scan through the list of counter names and add to the query the counters that you want from this list.</span></span>
-   <span data-ttu-id="88d6b-116">Appelez la fonction [**PdhBrowseCounters**](/windows/desktop/api/Pdh/nf-pdh-pdhbrowsecountersa) pour afficher une boîte de dialogue qui permet à l’utilisateur de parcourir et de sélectionner les compteurs de performances.</span><span class="sxs-lookup"><span data-stu-id="88d6b-116">Call the [**PdhBrowseCounters**](/windows/desktop/api/Pdh/nf-pdh-pdhbrowsecountersa) function to display a dialog box that lets the user browse and select performance counters.</span></span> <span data-ttu-id="88d6b-117">Pour plus d’informations, consultez [exploration des compteurs](browsing-counters.md).</span><span class="sxs-lookup"><span data-stu-id="88d6b-117">For more information, see [Browsing Counters](browsing-counters.md).</span></span>

<span data-ttu-id="88d6b-118">Notez que si une instance de compteur spécifiée n’existe pas, [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) ne signale pas de condition d’erreur.</span><span class="sxs-lookup"><span data-stu-id="88d6b-118">Note that if a counter instance is specified that does not exist, [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) does not report an error condition.</span></span> <span data-ttu-id="88d6b-119">Au lieu de cela, elle retourne la réussite de l’erreur \_ .</span><span class="sxs-lookup"><span data-stu-id="88d6b-119">Instead, it returns ERROR\_SUCCESS.</span></span> <span data-ttu-id="88d6b-120">Ce comportement est dû au fait qu’il n’est pas connu si une instance de compteur inexistante a été spécifiée ou si elle existe, mais n’a pas encore été créée.</span><span class="sxs-lookup"><span data-stu-id="88d6b-120">The reason for this behavior is that it is not known if a nonexistent counter instance has been specified or one that will exist but has not yet been created.</span></span>

<span data-ttu-id="88d6b-121">L’instance de compteur manquante sera signalée par [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata), [**PdhGetRawCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetrawcountervalue)ou [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue).</span><span class="sxs-lookup"><span data-stu-id="88d6b-121">The missing counter instance will be reported by either [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata), [**PdhGetRawCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetrawcountervalue), or [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue).</span></span> <span data-ttu-id="88d6b-122">Lors de l’appel de **PdhCollectQueryData** pour une seule instance de compteur, et que l’instance de compteur n’existe toujours pas, il est supposé que l’instance de compteur n’existe pas et que la fonction retourne PDH \_ aucune \_ donnée.</span><span class="sxs-lookup"><span data-stu-id="88d6b-122">When calling **PdhCollectQueryData** for one counter instance only, and the counter instance still does not exist, it is assumed that the counter instance will not exist and the function returns PDH\_NO\_DATA.</span></span> <span data-ttu-id="88d6b-123">Toutefois, si plusieurs compteurs sont interrogés, **PdhCollectQueryData** peut toujours retourner une erreur \_ de réussite même si l’une des instances de compteur n’existe pas encore.</span><span class="sxs-lookup"><span data-stu-id="88d6b-123">However, if more than one counter is queried, **PdhCollectQueryData** may still return ERROR\_SUCCESS even if one of the counter instances does not yet exist.</span></span> <span data-ttu-id="88d6b-124">Dans ce cas, appelez **PdhGetRawCounterValue** ou **PdhGetFormattedCounterValue** pour chacune des instances de compteur intéressantes.</span><span class="sxs-lookup"><span data-stu-id="88d6b-124">In this case, call **PdhGetRawCounterValue** or **PdhGetFormattedCounterValue** for each of the counter instances of interest.</span></span> <span data-ttu-id="88d6b-125">Si l’instance n’existe pas lors de l’appel de **PdhGetRawCounterValue**, la fonction retourne la \_ réussite de l’erreur et définit le membre **CStatus** du [**\_ \_ compteur brut PDH**](/windows/desktop/api/Pdh/ns-pdh-pdh_raw_counter) sur l' \_ État PDH \_ aucune \_ instance.</span><span class="sxs-lookup"><span data-stu-id="88d6b-125">If the instance does not exist when calling **PdhGetRawCounterValue**, the function returns ERROR\_SUCCESS and sets the **CStatus** member of [**PDH\_RAW\_COUNTER**](/windows/desktop/api/Pdh/ns-pdh-pdh_raw_counter) to PDH\_STATUS\_NO\_INSTANCE.</span></span> <span data-ttu-id="88d6b-126">Si l’instance n’existe pas lors de l’appel de **PdhGetFormattedCounterValue**, la fonction retourne des \_ données non valides PDH \_ et définit le membre **CStatus** du [**\_ fmt PDH \_ COUNTERVALUE**](/windows/desktop/api/Pdh/ns-pdh-pdh_fmt_countervalue) sur PDH \_ CStatus \_ aucune \_ instance.</span><span class="sxs-lookup"><span data-stu-id="88d6b-126">If the instance does not exist when calling **PdhGetFormattedCounterValue**, the function returns PDH\_INVALID\_DATA and sets the **CStatus** member of the [**PDH\_FMT\_COUNTERVALUE**](/windows/desktop/api/Pdh/ns-pdh-pdh_fmt_countervalue) to PDH\_CSTATUS\_NO\_INSTANCE.</span></span>

<span data-ttu-id="88d6b-127">Notez que le chemin d’accès au compteur spécifié dans la fonction [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) doit être localisé.</span><span class="sxs-lookup"><span data-stu-id="88d6b-127">Note that the counter path specified in the [**PdhAddCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddcountera) function must be localized.</span></span> <span data-ttu-id="88d6b-128">La fonction [**PdhAddEnglishCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddenglishcountera) fournit un moyen indépendant des paramètres régionaux pour ajouter des compteurs de performances à la requête.</span><span class="sxs-lookup"><span data-stu-id="88d6b-128">The [**PdhAddEnglishCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhaddenglishcountera) function provides a locale-neutral way to add performance counters to the query.</span></span> <span data-ttu-id="88d6b-129">Cette fonction est la méthode recommandée pour ajouter des compteurs de paramètres régionaux neutres à une requête.</span><span class="sxs-lookup"><span data-stu-id="88d6b-129">This function is the recommended way to add locale-neutral counters to a query.</span></span>

<span data-ttu-id="88d6b-130">Pour supprimer un compteur d’une requête, appelez la fonction [**PdhRemoveCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhremovecounter) .</span><span class="sxs-lookup"><span data-stu-id="88d6b-130">To remove a counter from a query, call the [**PdhRemoveCounter**](/windows/desktop/api/Pdh/nf-pdh-pdhremovecounter) function.</span></span>

<span data-ttu-id="88d6b-131">Une fois que vous avez terminé la collecte des données pour une requête, appelez la fonction [**PdhCloseQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhclosequery) pour fermer la requête et libérer toutes les ressources système allouées.</span><span class="sxs-lookup"><span data-stu-id="88d6b-131">After you finish collecting data for a query, call the [**PdhCloseQuery**](/windows/desktop/api/Pdh/nf-pdh-pdhclosequery) function to close the query and release all allocated system resources.</span></span> <span data-ttu-id="88d6b-132">**PdhCloseQuery** ferme tous les descripteurs de compteur associés à la requête.</span><span class="sxs-lookup"><span data-stu-id="88d6b-132">**PdhCloseQuery** closes all counter handles associated with the query.</span></span>

 

 



