---
description: Après avoir créé une requête et y avoir ajouté des compteurs, appelez la fonction PdhCollectQueryData pour récupérer les données brutes actuelles de tous les compteurs de la requête.
ms.assetid: 2534d387-a280-4716-9a9d-3e42f40e2f92
title: Collecte des données de performances
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e99bd2c0e22553245e87d3844694051c88c57895
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104319185"
---
# <a name="collecting-performance-data"></a><span data-ttu-id="cc415-103">Collecte des données de performances</span><span class="sxs-lookup"><span data-stu-id="cc415-103">Collecting Performance Data</span></span>

<span data-ttu-id="cc415-104">Après avoir [créé une requête](creating-a-query.md) et y avoir ajouté des compteurs, appelez la fonction [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) pour récupérer les données brutes actuelles de tous les compteurs de la requête.</span><span class="sxs-lookup"><span data-stu-id="cc415-104">After [creating a query](creating-a-query.md) and adding counters to it, call the [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) function to retrieve the current raw data for all counters in the query.</span></span>

<span data-ttu-id="cc415-105">De nombreux compteurs, tels que les compteurs de taux, requièrent deux échantillons de données pour calculer une valeur de données mise en forme.</span><span class="sxs-lookup"><span data-stu-id="cc415-105">Many counters, such as rate counters, require two data samples to calculate a formatted data value.</span></span> <span data-ttu-id="cc415-106">PDH gère les données de l’exemple actuel et de l’exemple collecté précédemment.</span><span class="sxs-lookup"><span data-stu-id="cc415-106">PDH maintains data for the current sample and the previously collected sample.</span></span> <span data-ttu-id="cc415-107">La procédure suivante décrit comment collecter des valeurs de compteur qui requièrent deux exemples pour calculer une valeur affichable.</span><span class="sxs-lookup"><span data-stu-id="cc415-107">The following procedure describes how to collect counter values that require two samples to calculate a displayable value.</span></span>

<span data-ttu-id="cc415-108">**Pour collecter des valeurs de compteur qui requièrent deux exemples pour calculer une valeur affichable**</span><span class="sxs-lookup"><span data-stu-id="cc415-108">**To collect counter values that require two samples to calculate a displayable value**</span></span>

1.  <span data-ttu-id="cc415-109">Appelez [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) pour collecter le premier exemple.</span><span class="sxs-lookup"><span data-stu-id="cc415-109">Call [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) to collect the first sample.</span></span>
2.  <span data-ttu-id="cc415-110">Appelez la fonction [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) pour attendre au moins une seconde entre les collections.</span><span class="sxs-lookup"><span data-stu-id="cc415-110">Call the [**Sleep**](/windows/desktop/api/synchapi/nf-synchapi-sleep) function to wait a minimum of one second between collections.</span></span>
3.  <span data-ttu-id="cc415-111">Appelez à nouveau [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) pour collecter le deuxième exemple.</span><span class="sxs-lookup"><span data-stu-id="cc415-111">Call [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata) again to collect the second sample.</span></span>
4.  <span data-ttu-id="cc415-112">Appelez la fonction [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) pour calculer une valeur affichable.</span><span class="sxs-lookup"><span data-stu-id="cc415-112">Call the [**PdhGetFormattedCounterValue**](/windows/desktop/api/Pdh/nf-pdh-pdhgetformattedcountervalue) function to calculate a displayable value.</span></span>
5.  <span data-ttu-id="cc415-113">Répétez les étapes 2 à 4.</span><span class="sxs-lookup"><span data-stu-id="cc415-113">Repeat steps 2 through 4.</span></span>

<span data-ttu-id="cc415-114">Au lieu d’implémenter vous-même une période d’attente, vous pouvez appeler la fonction [**PdhCollectQueryDataEx**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) , qui crée un thread de minutage qui attend un laps de temps spécifié, collecte l’exemple, puis déclenche un événement défini par l’application.</span><span class="sxs-lookup"><span data-stu-id="cc415-114">As an alternative to implementing a wait period yourself, you can call the [**PdhCollectQueryDataEx**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydataex) function, which creates a timing thread that waits a specified amount of time, collects the sample, and then triggers an application-defined event.</span></span>

<span data-ttu-id="cc415-115">Si vous souhaitez interroger des données de performances à partir d’un fichier journal, vous pouvez également définir une plage de temps.</span><span class="sxs-lookup"><span data-stu-id="cc415-115">If you want to query performance data from a log file, you can also define a time range.</span></span> <span data-ttu-id="cc415-116">L’intervalle de temps limite la requête aux échantillons collectés dans l’intervalle de temps (chaque échantillon contient un horodatage pour le moment où il a été collecté).</span><span class="sxs-lookup"><span data-stu-id="cc415-116">The time range limits the query to those samples that were collected within the time range (each sample contains a time stamp for when it was collected).</span></span> <span data-ttu-id="cc415-117">Pour plus d’informations sur la façon de définir et de récupérer des plages de temps, consultez [définition d’une plage de temps pour une requête](setting-a-time-range-for-a-query.md).</span><span class="sxs-lookup"><span data-stu-id="cc415-117">For more information on how to set and retrieve time ranges, see [Setting a Time Range for a Query](setting-a-time-range-for-a-query.md).</span></span>

<span data-ttu-id="cc415-118">Si vous souhaitez collecter des données de performances et les écrire dans un fichier journal, vous devez appeler la fonction [**PdhUpdateLog**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) au lieu d’appeler [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata).</span><span class="sxs-lookup"><span data-stu-id="cc415-118">If you want to collect performance data and write it to a log file, you would call the [**PdhUpdateLog**](/windows/desktop/api/Pdh/nf-pdh-pdhupdateloga) function instead of calling [**PdhCollectQueryData**](/windows/desktop/api/Pdh/nf-pdh-pdhcollectquerydata).</span></span> <span data-ttu-id="cc415-119">Pour plus d’informations, consultez [utilisation des fichiers journaux](working-with-log-files.md) et [écriture de données de performances dans un fichier journal](writing-performance-data-to-a-log-file.md).</span><span class="sxs-lookup"><span data-stu-id="cc415-119">For details, see [Working with Log Files](working-with-log-files.md) and [Writing Performance Data to a Log File](writing-performance-data-to-a-log-file.md).</span></span>

<span data-ttu-id="cc415-120">Pour plus d’informations sur le calcul d’une valeur d’échantillon affichable, consultez [affichage des données de performances](displaying-performance-data.md).</span><span class="sxs-lookup"><span data-stu-id="cc415-120">For details on calculating a displayable sample value, see [Displaying Performance Data](displaying-performance-data.md).</span></span>

## <a name="understanding-multiple-processor-counters"></a><span data-ttu-id="cc415-121">Fonctionnement des compteurs à plusieurs processeurs</span><span class="sxs-lookup"><span data-stu-id="cc415-121">Understanding Multiple Processor Counters</span></span>

<span data-ttu-id="cc415-122">Certains compteurs de performances ont été conçus pour les systèmes à un seul processeur et peuvent ne pas être précis pour les ordinateurs multiprocesseurs.</span><span class="sxs-lookup"><span data-stu-id="cc415-122">Some performance counters were designed for single processor systems and might not be accurate for multiprocessor computers.</span></span> <span data-ttu-id="cc415-123">Par exemple, un processus est limité à 100% d’un processeur unique. Toutefois, ses threads peuvent utiliser plusieurs processeurs, en totalisant plus de 100%.</span><span class="sxs-lookup"><span data-stu-id="cc415-123">For example, a process is limited to 100 percent of a single processor; however, its threads can use several processors, totaling more than 100 percent.</span></span>

<span data-ttu-id="cc415-124">La \\ valeur du compteur « processeur ( \_ total) \\ % temps processeur » correspond à l’utilisation moyenne de tous les processeurs.</span><span class="sxs-lookup"><span data-stu-id="cc415-124">The "\\Processor(\_Total)\\% Processor Time" counter value is the average usage of all processors.</span></span> <span data-ttu-id="cc415-125">Par exemple, si vous avez deux processeurs, un à 100% et un autre à 0 pour cent, ce compteur indique 50%.</span><span class="sxs-lookup"><span data-stu-id="cc415-125">For example, if you have two processors, one at 100 percent and another at 0 percent, this counter will report 50 percent.</span></span> <span data-ttu-id="cc415-126">La plage est comprise entre 0 et 100.</span><span class="sxs-lookup"><span data-stu-id="cc415-126">So the range is from 0 through 100.</span></span>

<span data-ttu-id="cc415-127">La \\ valeur du compteur « process (X) \\ % Process Time » est la somme de l’utilisation du processeur par tous les threads du processus X. Par exemple, sur un ordinateur doté de deux processeurs, si un processus a deux threads, l’un occupant 75% de l’UC et l’autre qui prend 80% d’un autre processeur, ce compteur indique 155 pour cent.</span><span class="sxs-lookup"><span data-stu-id="cc415-127">The "\\Process(X)\\% Process Time" counter value is the sum of the processor usage by all threads of process X. For example, in a computer with two processors, if a process has two threads, one taking up 75 percent of a CPU and the other taking 80 percent of another CPU, this counter will report 155 percent.</span></span> <span data-ttu-id="cc415-128">La plage de ce compteur est comprise entre 0 et 100 \* ProcessorCount.</span><span class="sxs-lookup"><span data-stu-id="cc415-128">The range for this counter is from 0 through 100 \* ProcessorCount.</span></span>

<span data-ttu-id="cc415-129">\* \* Windows Server 2003 et Windows XP : \* \*</span><span class="sxs-lookup"><span data-stu-id="cc415-129">\*\*Windows Server 2003 and Windows XP:  \*\*</span></span>

<span data-ttu-id="cc415-130">Vous pouvez recevoir des valeurs en dehors de la plage de valeurs attendue pour l’utilisation de l’UC.</span><span class="sxs-lookup"><span data-stu-id="cc415-130">You can receive values outside the expected range of values for CPU usage.</span></span> <span data-ttu-id="cc415-131">Pour calculer le pourcentage d’utilisation de l’UC, PDH a besoin de deux exemples (chacun avec une valeur brute et un horodatage).</span><span class="sxs-lookup"><span data-stu-id="cc415-131">To calculate the percentage of CPU usage, PDH needs two samples (each with a raw value and a time stamp).</span></span> <span data-ttu-id="cc415-132">Comme PDH utilise uniquement le nom de l’instance pour correspondre aux processus, il peut parfois utiliser deux exemples de processus différents.</span><span class="sxs-lookup"><span data-stu-id="cc415-132">Because PDH uses only the instance name to match the processes, it can sometimes use two samples from different processes.</span></span> <span data-ttu-id="cc415-133">Par exemple, si trois processus sont échantillonnés et qu’un processus se termine après le troisième exemple, un autre processus est déplacé vers l’emplacement libéré par ce processus terminé.</span><span class="sxs-lookup"><span data-stu-id="cc415-133">For example, if three processes are being sampled and one process is terminated after the third sample, another process will move to the slot vacated by that terminated process.</span></span> <span data-ttu-id="cc415-134">Par conséquent, un compteur mis en forme fournit une valeur incorrecte quand vous mettez en forme le quatrième exemple, car il utilise le troisième exemple du processus terminé et le quatrième exemple du processus qui a été déplacé dans l’emplacement du processus terminé.</span><span class="sxs-lookup"><span data-stu-id="cc415-134">As a result, a formatted counter will provide an incorrect value when you format the fourth sample, because it’s using the third sample from the terminated process and the fourth sample from the process that moved into the terminated process's slot.</span></span>

<span data-ttu-id="cc415-135">Le tableau suivant montre comment cela peut se produire si un processus est arrêté pendant la collecte des données.</span><span class="sxs-lookup"><span data-stu-id="cc415-135">The following table shows how this can occur if a process is terminated while data is being collected.</span></span> <span data-ttu-id="cc415-136">Le tableau affiche cinq exemples de valeur de compteur pour trois instances du processus X. Les échantillons sont collectés dans un intervalle d’une seconde.</span><span class="sxs-lookup"><span data-stu-id="cc415-136">The table shows five counter value samples for three instances of process X. The samples are collected in one second intervals.</span></span> <span data-ttu-id="cc415-137">Une fois le troisième échantillon collecté, le processus X de l’emplacement 1 est terminé.</span><span class="sxs-lookup"><span data-stu-id="cc415-137">After the third sample is collected, process X in slot 1 is terminated.</span></span> <span data-ttu-id="cc415-138">Lorsque le processus X de l’emplacement 1 est terminé, le processus X dans l’emplacement 2 se déplace vers l’emplacement 1.</span><span class="sxs-lookup"><span data-stu-id="cc415-138">When process X in slot 1 is terminated, process X in slot 2 moves to slot 1.</span></span> <span data-ttu-id="cc415-139">Lorsque vous collectez le quatrième exemple pour le processus X dans l’emplacement 2, la première valeur est maintenant 20 au lieu de 1 000, et la deuxième valeur est 1 500.</span><span class="sxs-lookup"><span data-stu-id="cc415-139">When you collect the fourth sample for process X in slot 2, the first value is now 20 instead of 1,000, and the second value is 1,500.</span></span> <span data-ttu-id="cc415-140">Lorsque vous mettez en forme la valeur de compteur, vous recevez 1 480 millisecondes au lieu des 500 millisecondes attendues.</span><span class="sxs-lookup"><span data-stu-id="cc415-140">When you format the counter value, you get 1,480 milliseconds instead of the expected 500 milliseconds.</span></span> <span data-ttu-id="cc415-141">Lorsque vous mettez en forme le cinquième exemple de valeur, vous devez récupérer la valeur attendue.</span><span class="sxs-lookup"><span data-stu-id="cc415-141">When you format the fifth sample value, you should get the expected value.</span></span>

| <span data-ttu-id="cc415-142">Exemple</span><span class="sxs-lookup"><span data-stu-id="cc415-142">Sample</span></span>   | <span data-ttu-id="cc415-143">Emplacement 0 pour le processus X</span><span class="sxs-lookup"><span data-stu-id="cc415-143">Slot 0 for process X</span></span> | <span data-ttu-id="cc415-144">Emplacement 1 pour le processus X</span><span class="sxs-lookup"><span data-stu-id="cc415-144">Slot 1 for process X</span></span>           | <span data-ttu-id="cc415-145">Emplacement 2 pour le processus X</span><span class="sxs-lookup"><span data-stu-id="cc415-145">Slot 2 for process X</span></span>                     |
|----------|----------------------|--------------------------------|------------------------------------------|
| <span data-ttu-id="cc415-146">Exemple 1</span><span class="sxs-lookup"><span data-stu-id="cc415-146">Sample 1</span></span> | <span data-ttu-id="cc415-147">0</span><span class="sxs-lookup"><span data-stu-id="cc415-147">0</span></span>                    | <span data-ttu-id="cc415-148">0</span><span class="sxs-lookup"><span data-stu-id="cc415-148">0</span></span>                              | <span data-ttu-id="cc415-149">0</span><span class="sxs-lookup"><span data-stu-id="cc415-149">0</span></span>                                        |
| <span data-ttu-id="cc415-150">Exemple 2</span><span class="sxs-lookup"><span data-stu-id="cc415-150">Sample 2</span></span> | <span data-ttu-id="cc415-151">20</span><span class="sxs-lookup"><span data-stu-id="cc415-151">20</span></span>                   | <span data-ttu-id="cc415-152">10</span><span class="sxs-lookup"><span data-stu-id="cc415-152">10</span></span>                             | <span data-ttu-id="cc415-153">500</span><span class="sxs-lookup"><span data-stu-id="cc415-153">500</span></span>                                      |
| <span data-ttu-id="cc415-154">Exemple 3</span><span class="sxs-lookup"><span data-stu-id="cc415-154">Sample 3</span></span> | <span data-ttu-id="cc415-155">40</span><span class="sxs-lookup"><span data-stu-id="cc415-155">40</span></span>                   | <span data-ttu-id="cc415-156">20</span><span class="sxs-lookup"><span data-stu-id="cc415-156">20</span></span>                             | <span data-ttu-id="cc415-157">1 000</span><span class="sxs-lookup"><span data-stu-id="cc415-157">1,000</span></span>                                    |
| <span data-ttu-id="cc415-158">Exemple 4</span><span class="sxs-lookup"><span data-stu-id="cc415-158">Sample 4</span></span> | <span data-ttu-id="cc415-159">60</span><span class="sxs-lookup"><span data-stu-id="cc415-159">60</span></span>                   | <span data-ttu-id="cc415-160">1 500 (à partir de l’emplacement 2 précédent)</span><span class="sxs-lookup"><span data-stu-id="cc415-160">1,500 (from the former slot 2)</span></span> | <span data-ttu-id="cc415-161">Non applicable.</span><span class="sxs-lookup"><span data-stu-id="cc415-161">Not applicable.</span></span> <span data-ttu-id="cc415-162">Désormais collectées dans l’emplacement 1.</span><span class="sxs-lookup"><span data-stu-id="cc415-162">Now collected in slot 1.</span></span> |
| <span data-ttu-id="cc415-163">Exemple 5</span><span class="sxs-lookup"><span data-stu-id="cc415-163">Sample 5</span></span> | <span data-ttu-id="cc415-164">80</span><span class="sxs-lookup"><span data-stu-id="cc415-164">80</span></span>                   | <span data-ttu-id="cc415-165">2 000</span><span class="sxs-lookup"><span data-stu-id="cc415-165">2,000</span></span>                          | <span data-ttu-id="cc415-166">Non applicable.</span><span class="sxs-lookup"><span data-stu-id="cc415-166">Not applicable.</span></span> <span data-ttu-id="cc415-167">Désormais collectées dans l’emplacement 1.</span><span class="sxs-lookup"><span data-stu-id="cc415-167">Now collected in slot 1.</span></span> |



 

 

 
