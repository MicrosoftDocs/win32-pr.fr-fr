---
description: Un fournisseur est une DLL de performance qui fournit des données de compteur aux consommateurs.
ms.assetid: bbb777fe-b97e-4777-b797-ec8525065610
title: Création d’une DLL d’extension de performance
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d397f1581454aca1b25c447b35f250eefd215f57
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103865125"
---
# <a name="creating-a-performance-extension-dll"></a><span data-ttu-id="af4dd-103">Création d’une DLL d’extension de performance</span><span class="sxs-lookup"><span data-stu-id="af4dd-103">Creating a Performance Extension DLL</span></span>

> [!IMPORTANT]
> <span data-ttu-id="af4dd-104">En raison des limitations de performances et de fiabilité significatives, la méthode permettant de fournir des données de compteurs de performances que cette rubrique décrit peut être modifiée ou non disponible à l’avenir.</span><span class="sxs-lookup"><span data-stu-id="af4dd-104">Due to significant performance and reliability limitations, the method for providing performance counter data that this topic describes may be altered or unavailable in the future.</span></span> <span data-ttu-id="af4dd-105">Au lieu de cela, Microsoft vous recommande d’utiliser la méthode décrite dans la rubrique [fourniture de données de compteur à l’aide de la Version 2,0](providing-counter-data-using-version-2-0.md) pour la création de nouveaux compteurs de performances et la migration des compteurs de performances existants afin d’utiliser également cette méthode.</span><span class="sxs-lookup"><span data-stu-id="af4dd-105">Instead, Microsoft recommends that you use the method described in [Providing Counter Data Using Version 2.0](providing-counter-data-using-version-2-0.md) for creating new performance counters and that you migrate existing performance counters to use that method as well.</span></span>

<span data-ttu-id="af4dd-106">Un [fournisseur v1](providing-counter-data.md) utilise une dll de performance qui fournit des données de compteur aux consommateurs.</span><span class="sxs-lookup"><span data-stu-id="af4dd-106">A [V1 provider](providing-counter-data.md) uses a performance DLL that provides counter data to consumers.</span></span> <span data-ttu-id="af4dd-107">La DLL de performance doit exporter les fonctions [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)), [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc)et [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) .</span><span class="sxs-lookup"><span data-stu-id="af4dd-107">The performance DLL must export the [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)), [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc), and [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) functions.</span></span> <span data-ttu-id="af4dd-108">En général, vous utilisez un fichier de définition de module (. def) pour exporter les fonctions à partir de la DLL.</span><span class="sxs-lookup"><span data-stu-id="af4dd-108">Typically, you use a module definition (.def) file to export the functions from the DLL.</span></span> <span data-ttu-id="af4dd-109">Le système appelle ces fonctions lorsqu’un consommateur interroge des données de performances.</span><span class="sxs-lookup"><span data-stu-id="af4dd-109">The system calls these functions when a consumer queries performance data.</span></span>

<span data-ttu-id="af4dd-110">La première fois qu’un consommateur appelle [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa), ou si le consommateur utilise la fonction [**RegOpenKey**](/windows/desktop/api/winreg/nf-winreg-regopenkeya) ou [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistrya) pour ouvrir `HKEY_PERFORMANCE_DATA` , le système appelle la fonction [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) pour chaque fournisseur [inscrit](adding-performance-counters.md) sur l’ordinateur.</span><span class="sxs-lookup"><span data-stu-id="af4dd-110">The first time a consumer calls [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa), or if the consumer uses the [**RegOpenKey**](/windows/desktop/api/winreg/nf-winreg-regopenkeya) or [**RegConnectRegistry**](/windows/desktop/api/winreg/nf-winreg-regconnectregistrya) function to open `HKEY_PERFORMANCE_DATA`, the system calls the [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) function for each provider that is [registered](adding-performance-counters.md) on the computer.</span></span> <span data-ttu-id="af4dd-111">L’exception est si le fournisseur spécifie la liste d’objets qu’il prend en charge dans la `[objects]` section de. Fichier INI.</span><span class="sxs-lookup"><span data-stu-id="af4dd-111">The exception is if the provider specifies the list of objects that it supports in the `[objects]` section of the .INI file.</span></span> <span data-ttu-id="af4dd-112">Dans ce cas, le système appelle le fournisseur uniquement si l’un des objets interrogés correspond à un objet de la liste.</span><span class="sxs-lookup"><span data-stu-id="af4dd-112">In this case, the system calls the provider only if one of the queried objects matches an object from the list.</span></span>

<span data-ttu-id="af4dd-113">La fonction [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) donne à chaque fournisseur la possibilité d’initialiser ses structures de données de performances.</span><span class="sxs-lookup"><span data-stu-id="af4dd-113">The [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) function gives each provider an opportunity to initialize its performance data structures.</span></span> <span data-ttu-id="af4dd-114">Ensuite, si la fonction **OpenPerformanceData** retourne avec succès, le système appelle la fonction [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc) du fournisseur.</span><span class="sxs-lookup"><span data-stu-id="af4dd-114">Then, if the **OpenPerformanceData** function returns successfully, the system calls the provider's [**CollectPerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_collect_proc) function.</span></span> <span data-ttu-id="af4dd-115">Les appels suivants à [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) provoquent l’appel de la fonction **CollectPerformanceData** par le système.</span><span class="sxs-lookup"><span data-stu-id="af4dd-115">Subsequent calls to [**RegQueryValueEx**](/windows/desktop/api/winreg/nf-winreg-regqueryvalueexa) cause the system to call the **CollectPerformanceData** function.</span></span>

<span data-ttu-id="af4dd-116">Lorsque le consommateur termine la collecte des données de performances, il spécifie `HKEY_PERFORMANCE_DATA` dans un appel à la fonction [**échec RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) .</span><span class="sxs-lookup"><span data-stu-id="af4dd-116">When the consumer finishes collecting performance data, it specifies `HKEY_PERFORMANCE_DATA` in a call to the [**RegCloseKey**](/windows/desktop/api/winreg/nf-winreg-regclosekey) function.</span></span> <span data-ttu-id="af4dd-117">Cela amène le système à appeler la fonction [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) pour chaque fournisseur.</span><span class="sxs-lookup"><span data-stu-id="af4dd-117">This causes the system to call the [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) function for each provider.</span></span> <span data-ttu-id="af4dd-118">Les fournisseurs sont ensuite déchargés.</span><span class="sxs-lookup"><span data-stu-id="af4dd-118">The providers are then unloaded.</span></span>

<span data-ttu-id="af4dd-119">Plusieurs consommateurs peuvent collecter des données de performances en même temps.</span><span class="sxs-lookup"><span data-stu-id="af4dd-119">It is possible for multiple consumers to collect performance data at the same time.</span></span> <span data-ttu-id="af4dd-120">Le système appelle les fonctions [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) et [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) une seule fois chaque fois que la dll est chargée ou déchargée.</span><span class="sxs-lookup"><span data-stu-id="af4dd-120">The system calls [**OpenPerformanceData**](/previous-versions/windows/desktop/legacy/aa372200(v=vs.85)) and [**ClosePerformanceData**](/windows/win32/api/winperf/nc-winperf-pm_close_proc) functions only once each time the DLL is loaded or unloaded.</span></span>

> [!Note]
> <span data-ttu-id="af4dd-121">Veillez à inclure extern "C" dans votre code C++ pour empêcher le compilateur d’ajouter des décorations à vos noms de fonction. dans le cas contraire, le système risque de ne pas trouver vos fonctions.</span><span class="sxs-lookup"><span data-stu-id="af4dd-121">Be sure to include extern "C" in your C++ code to prevent the compiler from adding decorations to your function names; otherwise, the system may fail to find your functions.</span></span>

> [!Note]
> <span data-ttu-id="af4dd-122">Si une erreur se produit lors du chargement de votre DLL de performance, de la recherche de vos fonctions ou de l’appel de vos fonctions, le système désactive le fournisseur pour les collections suivantes au sein du même processus.</span><span class="sxs-lookup"><span data-stu-id="af4dd-122">If an error occurs while loading your performance DLL, finding your functions, or calling your functions, the system will disable the provider for subsequent collections within the same process.</span></span> <span data-ttu-id="af4dd-123">En outre, si cela se produit lors de l’exécution dans un processus privilégié, le système ajoute une valeur de **désactivation des compteurs de performances** à votre clé de **performance** pour empêcher le fournisseur d’être chargé à l’avenir.</span><span class="sxs-lookup"><span data-stu-id="af4dd-123">In addition, if this occurs while running in a privileged process, the system adds a **Disable Performance Counters** value to your **Performance** key to prevent the provider from being loaded in the future.</span></span>

<span data-ttu-id="af4dd-124">Pour plus d’informations sur l’écriture d’une DLL de performance, consultez les rubriques suivantes :</span><span class="sxs-lookup"><span data-stu-id="af4dd-124">For more information on writing a performance DLL, see the following topics:</span></span>

- [<span data-ttu-id="af4dd-125">Implémentation de la fonction OpenPerformanceData</span><span class="sxs-lookup"><span data-stu-id="af4dd-125">Implementing the OpenPerformanceData function</span></span>](implementing-openperformancedata.md)
- [<span data-ttu-id="af4dd-126">Implémentation de la fonction CollectPerformanceData</span><span class="sxs-lookup"><span data-stu-id="af4dd-126">Implementing the CollectPerformanceData function</span></span>](implementing-collectperformancedata.md)
- [<span data-ttu-id="af4dd-127">Gestion des erreurs dans la DLL</span><span class="sxs-lookup"><span data-stu-id="af4dd-127">Error Handling in the DLL</span></span>](error-handling-in-the-dll.md)
- [<span data-ttu-id="af4dd-128">Restriction de l’accès aux DLL d’extension de performance</span><span class="sxs-lookup"><span data-stu-id="af4dd-128">Restricting Access to Performance Extension DLLs</span></span>](restricting-access-to-performance-extension--dlls.md)
- [<span data-ttu-id="af4dd-129">Exemples de DLL de performance</span><span class="sxs-lookup"><span data-stu-id="af4dd-129">Performance DLL Samples</span></span>](performance-dll-samples.md)
