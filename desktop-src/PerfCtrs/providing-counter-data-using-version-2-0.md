---
description: Avec la version 2,0, les compteurs de performances ont modifié l’architecture pour simplifier le processus de fourniture des données de compteur aux consommateurs.
ms.assetid: 37f75b15-3f52-4259-a6d9-5a1a14f88379
title: Fourniture de données de compteurs à l’aide de la version 2,0
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: 67976c8a0b6c77582ed8c50c2e5cf753c77fcf6b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "106527891"
---
# <a name="providing-counter-data-using-version-20"></a><span data-ttu-id="db57a-103">Fourniture de données de compteurs à l’aide de la version 2,0</span><span class="sxs-lookup"><span data-stu-id="db57a-103">Providing Counter Data Using Version 2.0</span></span>

<span data-ttu-id="db57a-104">Les fournisseurs de données de performances modernes utilisent un manifeste pour définir les données de compteur et utiliser les API du fournisseur de compteurs de performance pour gérer les données dans le contexte du fournisseur.</span><span class="sxs-lookup"><span data-stu-id="db57a-104">Modern performance data providers use a manifest to define the counter data and use performance counter provider APIs to manage data within the context of the provider.</span></span> <span data-ttu-id="db57a-105">Les fournisseurs implémentés à l’aide d’un manifeste et des API du fournisseur de compteurs de performances sont souvent appelés **fournisseurs v2**.</span><span class="sxs-lookup"><span data-stu-id="db57a-105">Providers implemented using a manifest and performance counter provider APIs are often called **V2 providers**.</span></span> <span data-ttu-id="db57a-106">Windows prend en charge les fournisseurs V2 en mode utilisateur sur Windows Vista ou version ultérieure et les fournisseurs V2 en mode noyau sur Windows 7 ou version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="db57a-106">Windows supports user-mode V2 providers on Windows Vista or later and kernel-mode V2 providers on Windows 7 or later.</span></span>

<span data-ttu-id="db57a-107">Cette page décrit les fournisseurs V2 en mode utilisateur.</span><span class="sxs-lookup"><span data-stu-id="db57a-107">This page describes user-mode V2 providers.</span></span> <span data-ttu-id="db57a-108">Pour plus d’informations sur les fournisseurs V2 en mode noyau, consultez [surveillance des performances en mode noyau](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span><span class="sxs-lookup"><span data-stu-id="db57a-108">For information about kernel-mode V2 providers, see [Kernel Mode Performance Monitoring](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span></span>

<span data-ttu-id="db57a-109">Au moment de l’exécution, les fournisseurs v2 fonctionnent comme suit :</span><span class="sxs-lookup"><span data-stu-id="db57a-109">At runtime, V2 providers work as follows:</span></span>

- <span data-ttu-id="db57a-110">Le processus du fournisseur s’inscrit auprès du système de compteur de performances Windows en appelant PerfStartProvider et PerfSetCounterSetInfo.</span><span class="sxs-lookup"><span data-stu-id="db57a-110">The provider process registers itself with the Windows Performance Counter system by calling PerfStartProvider and PerfSetCounterSetInfo.</span></span> <span data-ttu-id="db57a-111">Le fournisseur fournit éventuellement une fonction de rappel qui est avertie des demandes des consommateurs.</span><span class="sxs-lookup"><span data-stu-id="db57a-111">The provider optionally provides a callback function that will be notified about consumer requests.</span></span>
- <span data-ttu-id="db57a-112">Le processus du fournisseur ajoute ou supprime des instances en fonction des besoins à l’aide de PerfCreateInstance et PerfDeleteInstance.</span><span class="sxs-lookup"><span data-stu-id="db57a-112">The provider process adds or removes instances as appropriate using PerfCreateInstance and PerfDeleteInstance.</span></span> <span data-ttu-id="db57a-113">Le fournisseur met à jour les valeurs de compteur quand elles changent à l’aide des API PerfSet \* \* _.</span><span class="sxs-lookup"><span data-stu-id="db57a-113">The provider updates counter values when they change using PerfSet\*\*_ APIs.</span></span>
- <span data-ttu-id="db57a-114">Un consommateur effectue une demande de données à partir d’un CounterSet.</span><span class="sxs-lookup"><span data-stu-id="db57a-114">A consumer makes a request for data from a counterset.</span></span> <span data-ttu-id="db57a-115">Le système vérifie que l’appelant dispose des autorisations nécessaires pour collecter les données.</span><span class="sxs-lookup"><span data-stu-id="db57a-115">The system verifies that the caller has permissions to collect the data.</span></span> <span data-ttu-id="db57a-116">Le système utilise ensuite un thread de travail en cours d’exécution dans le processus du fournisseur pour gérer la demande, en appelant la fonction de rappel du fournisseur, le cas échéant.</span><span class="sxs-lookup"><span data-stu-id="db57a-116">The system then uses a worker thread running in the provider process to handle the request, invoking the provider's callback function if appropriate.</span></span> <span data-ttu-id="db57a-117">Le thread de travail copie les données collectées dans une mémoire tampon gérée par le système et le système retourne ensuite les données au consommateur.</span><span class="sxs-lookup"><span data-stu-id="db57a-117">The worker thread copies the collected data into a system-managed buffer, and the system then returns the data to the consumer.</span></span>

## <a name="steps-to-creating-a-provider"></a><span data-ttu-id="db57a-118">Étapes de création d’un fournisseur</span><span class="sxs-lookup"><span data-stu-id="db57a-118">Steps to creating a provider</span></span>

1. <span data-ttu-id="db57a-119">Écrivez un manifeste qui définit les données de compteur que votre fournisseur fournira.</span><span class="sxs-lookup"><span data-stu-id="db57a-119">Write a manifest that defines the counter data that your provider will provide.</span></span> <span data-ttu-id="db57a-120">Pour plus d’informations sur l’écriture du manifeste, consultez [schéma des compteurs de performances](performance-counters-schema.md).</span><span class="sxs-lookup"><span data-stu-id="db57a-120">For details on writing the manifest, see [Performance Counters Schema](performance-counters-schema.md).</span></span>
2. <span data-ttu-id="db57a-121">Utilisez [CTRPP](ctrpp.md) pour générer le code de modèle que vous incluez dans votre fournisseur.</span><span class="sxs-lookup"><span data-stu-id="db57a-121">Use [CTRPP](ctrpp.md) to generate the template code that you include in your provider.</span></span> <span data-ttu-id="db57a-122">Le code du modèle comprend les structures qui définissent les ensembles de compteurs, les fonctions [_ *CounterInitialize* \*](counterinitialize.md) et [**CounterCleanup**](countercleanup.md) , ainsi que les chaînes de ressources.</span><span class="sxs-lookup"><span data-stu-id="db57a-122">The template code includes the structures that define the counter sets, the [_ *CounterInitialize*\*](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions, and the resource strings.</span></span>

   <span data-ttu-id="db57a-123">Votre fournisseur doit appeler les fonctions [**CounterInitialize**](counterinitialize.md) et [**CounterCleanup**](countercleanup.md) .</span><span class="sxs-lookup"><span data-stu-id="db57a-123">Your provider must call the [**CounterInitialize**](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions.</span></span> <span data-ttu-id="db57a-124">**CounterInitialize** appelle la fonction [**PerfStartProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) pour inscrire le fournisseur et appelle également la fonction [**PerfSetCounterSetInfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) pour initialiser l’ensemble de compteurs.</span><span class="sxs-lookup"><span data-stu-id="db57a-124">The **CounterInitialize** calls the [**PerfStartProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) function to register the provider and also calls the [**PerfSetCounterSetInfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) function to initialize the counter set.</span></span> <span data-ttu-id="db57a-125">**CounterCleanup** appelle la fonction [**PerfStopProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) pour supprimer l’inscription du fournisseur.</span><span class="sxs-lookup"><span data-stu-id="db57a-125">The **CounterCleanup** calls the [**PerfStopProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) function to remove the provider's registration.</span></span>

3. <span data-ttu-id="db57a-126">Incluez le code de modèle de l’étape précédente de votre projet et complétez votre fournisseur.</span><span class="sxs-lookup"><span data-stu-id="db57a-126">Include the template code from the previous step in your project and complete your provider.</span></span>

   <span data-ttu-id="db57a-127">Pour terminer le fournisseur, vous devez appeler la fonction [**PerfCreateInstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) pour chaque instance de l’ensemble de compteurs que vous fournissez.</span><span class="sxs-lookup"><span data-stu-id="db57a-127">To complete the provider, you need to call the [**PerfCreateInstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) function for each instance of the counter set that you provide.</span></span>

   <span data-ttu-id="db57a-128">Pour définir les valeurs de compteur, appelez l’une des fonctions suivantes :</span><span class="sxs-lookup"><span data-stu-id="db57a-128">To set the counter values, call one of the following functions:</span></span>

   - [<span data-ttu-id="db57a-129">**PerfSetULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="db57a-129">**PerfSetULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulongcountervalue)
   - [<span data-ttu-id="db57a-130">**PerfSetULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="db57a-130">**PerfSetULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulonglongcountervalue)
   - [<span data-ttu-id="db57a-131">**PerfSetCounterRefValue**</span><span class="sxs-lookup"><span data-stu-id="db57a-131">**PerfSetCounterRefValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue)

   <span data-ttu-id="db57a-132">L’avantage de l’utilisation de [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) est que vous n’avez pas à effectuer d’appel de fonction pour définir ou mettre à jour la valeur de compteur, mais simplement mettre à jour votre variable de compteur locale (la variable vers laquelle les points de référence) et les compteurs de performance utilisent le pointeur pour accéder à la valeur de compteur.</span><span class="sxs-lookup"><span data-stu-id="db57a-132">The benefit of using [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) is that you do not have to make a function call to set or update the counter value, you simply update your local counter variable (the variable to which the reference points) and Performance Counters uses the pointer to access the counter value.</span></span>

   <span data-ttu-id="db57a-133">Si vous n’utilisez pas [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), vous pouvez utiliser les fonctions suivantes pour incrémenter ou décrémenter la valeur du compteur :</span><span class="sxs-lookup"><span data-stu-id="db57a-133">If you do not use [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), you can use the following functions to increment or decrement the counter value:</span></span>

   - [<span data-ttu-id="db57a-134">**PerfDecrementULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="db57a-134">**PerfDecrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulongcountervalue)
   - [<span data-ttu-id="db57a-135">**PerfDecrementULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="db57a-135">**PerfDecrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulonglongcountervalue)
   - [<span data-ttu-id="db57a-136">**PerfIncrementULongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="db57a-136">**PerfIncrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulongcountervalue)
   - [<span data-ttu-id="db57a-137">**PerfIncrementULongLongCounterValue**</span><span class="sxs-lookup"><span data-stu-id="db57a-137">**PerfIncrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulonglongcountervalue)

   <span data-ttu-id="db57a-138">Avant que le fournisseur ne s’arrête, il doit appeler [**PerfDeleteInstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) pour chaque instance d’ensemble de compteurs qu’il a créée.</span><span class="sxs-lookup"><span data-stu-id="db57a-138">Before the provider exits, it must call the [**PerfDeleteInstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) for each counter set instance that it created.</span></span>

   <span data-ttu-id="db57a-139">Si vous avez spécifié l’attribut de **rappel** dans l’élément de [**fournisseur**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) de votre manifeste ou si vous avez utilisé l’argument **-NotificationCallback** lors de l’appel de [CTRPP](ctrpp.md), vous devez implémenter la fonction de rappel [*ControlCallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) .</span><span class="sxs-lookup"><span data-stu-id="db57a-139">If you specified the **callback** attribute in the [**provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) element in your manifest or used the **-NotificationCallback** argument when calling [CTRPP](ctrpp.md), you must implement the [*ControlCallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) callback function.</span></span> <span data-ttu-id="db57a-140">Vous transmettez la fonction de rappel à [**CounterInitialize**](counterinitialize.md).</span><span class="sxs-lookup"><span data-stu-id="db57a-140">You pass the callback function to [**CounterInitialize**](counterinitialize.md).</span></span>

   <span data-ttu-id="db57a-141">Si vous avez utilisé le **-MemoryRoutines** lors de l’appel de [CTRPP](ctrpp.md), vous devez implémenter les fonctions de rappel [*AllocateMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) et [*FreeMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) .</span><span class="sxs-lookup"><span data-stu-id="db57a-141">If you used the **-MemoryRoutines** when calling [CTRPP](ctrpp.md), you must implement the [*AllocateMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) and [*FreeMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) callback functions.</span></span> <span data-ttu-id="db57a-142">Vous transmettez les fonctions de rappel à [**CounterInitialize**](counterinitialize.md).</span><span class="sxs-lookup"><span data-stu-id="db57a-142">You pass the callback functions to [**CounterInitialize**](counterinitialize.md).</span></span>

4. <span data-ttu-id="db57a-143">Lors de l’installation de votre fournisseur, utilisez l’outil LodCtr pour écrire le nom du fichier binaire qui contient les chaînes de ressources localisées et les ID de ressource dans le registre.</span><span class="sxs-lookup"><span data-stu-id="db57a-143">When installing your provider, use the LodCtr tool to write the name of the binary file that contains the localized resource strings and resource IDs to the registry.</span></span> <span data-ttu-id="db57a-144">Pour plus d’informations sur l’utilisation de LodCtr, consultez [schéma des compteurs de performances](performance-counters-schema.md).</span><span class="sxs-lookup"><span data-stu-id="db57a-144">For details on using LodCtr, see [Performance Counters Schema](performance-counters-schema.md).</span></span>

5. <span data-ttu-id="db57a-145">Lors de la désinstallation de votre fournisseur, utilisez l’outil UnlodCtr pour supprimer les informations de votre fournisseur du Registre.</span><span class="sxs-lookup"><span data-stu-id="db57a-145">When uninstalling your provider, use the UnlodCtr tool to remove your provider's information from the registry.</span></span>
