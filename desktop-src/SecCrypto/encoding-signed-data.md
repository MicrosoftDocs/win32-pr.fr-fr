---
description: Décrit la procédure d’encodage d’un message signé.
ms.assetid: 40d1c417-6d88-4421-920f-8b40d88d28ce
title: Encodage de données signées
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: be4a542fe0890a6ee9d51ebc1a5ee6b98bab4242
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "104209681"
---
# <a name="encoding-signed-data"></a><span data-ttu-id="5afe5-103">Encodage de données signées</span><span class="sxs-lookup"><span data-stu-id="5afe5-103">Encoding Signed Data</span></span>

<span data-ttu-id="5afe5-104">Les [*données signées*](../secgloss/s-gly.md) se composent du contenu de tout type et de tous les [*hachages*](../secgloss/h-gly.md) de messages chiffrés du contenu par zéro ou plusieurs signataires.</span><span class="sxs-lookup"><span data-stu-id="5afe5-104">[*Signed data*](../secgloss/s-gly.md) consists of content of any type and encrypted message [*hashes*](../secgloss/h-gly.md) of the content by zero or more signers.</span></span> <span data-ttu-id="5afe5-105">Le hachage résultant peut confirmer que le message d’origine n’a pas été modifié depuis la signature et que certaines personnes ou entités ont signé les données.</span><span class="sxs-lookup"><span data-stu-id="5afe5-105">The resulting hash can confirm that the original message has not been modified since signing and that particular persons or entities signed the data.</span></span>

<span data-ttu-id="5afe5-106">L’illustration suivante représente la procédure d’encodage d’un message signé.</span><span class="sxs-lookup"><span data-stu-id="5afe5-106">The following illustration depicts the procedure for encoding a signed message.</span></span> <span data-ttu-id="5afe5-107">La liste qui suit l’illustration décrit les étapes.</span><span class="sxs-lookup"><span data-stu-id="5afe5-107">The list following the illustration describes the steps.</span></span>

<span data-ttu-id="5afe5-108">Un message peut avoir plusieurs signataires, des algorithmes de hachage et des certificats.</span><span class="sxs-lookup"><span data-stu-id="5afe5-108">A message may have multiple signers, hashing algorithms, and certificates.</span></span> <span data-ttu-id="5afe5-109">Bien que l’illustration affiche uniquement les certificats, les [*listes de révocation*](../secgloss/c-gly.md)de certificats et les listes de certificats de [*confiance*](../secgloss/c-gly.md) peuvent utiliser le même processus.</span><span class="sxs-lookup"><span data-stu-id="5afe5-109">While the illustration shows only certificates, [*CRLs*](../secgloss/c-gly.md), and [*CTLs*](../secgloss/c-gly.md) can use the same process.</span></span> <span data-ttu-id="5afe5-110">Ils rentrent dans l’illustration partout où les certificats sont affichés.</span><span class="sxs-lookup"><span data-stu-id="5afe5-110">They would fit into the illustration wherever certificates are shown.</span></span>

![encodage d’un message signé](images/signmsg2.png)

<span data-ttu-id="5afe5-112">Le processus général d’encodage des [*données signées*](../secgloss/s-gly.md) est le suivant.</span><span class="sxs-lookup"><span data-stu-id="5afe5-112">The general process for encoding [*Signed data*](../secgloss/s-gly.md) is as follows.</span></span>

<span data-ttu-id="5afe5-113">**Pour encoder des données signées**</span><span class="sxs-lookup"><span data-stu-id="5afe5-113">**To encode signed data**</span></span>

1.  <span data-ttu-id="5afe5-114">Les données sont créées (si nécessaire) et un pointeur vers cette dernière est récupéré.</span><span class="sxs-lookup"><span data-stu-id="5afe5-114">The data is created (if necessary), and a pointer to it is retrieved.</span></span>
2.  <span data-ttu-id="5afe5-115">Un [*magasin de certificats*](../secgloss/c-gly.md) s’ouvre et contient le certificat du signataire.</span><span class="sxs-lookup"><span data-stu-id="5afe5-115">A [*certificate store*](../secgloss/c-gly.md) is opened that contains the signer's certificate.</span></span>
3.  <span data-ttu-id="5afe5-116">La clé privée du certificat est récupérée.</span><span class="sxs-lookup"><span data-stu-id="5afe5-116">The private key for the certificate is retrieved.</span></span> <span data-ttu-id="5afe5-117">Il existe deux propriétés qui doivent être définies sur le certificat avant de l’utiliser.</span><span class="sxs-lookup"><span data-stu-id="5afe5-117">There are two properties that must be set on the certificate before using it.</span></span> <span data-ttu-id="5afe5-118">L’un est utilisé pour lier un certificat à un CSP particulier et, dans ce CSP, à un [*conteneur de clé*](../secgloss/k-gly.md)privée particulier.</span><span class="sxs-lookup"><span data-stu-id="5afe5-118">One is used to tie a certificate to a particular CSP and, within that CSP, to a particular private [*key container*](../secgloss/k-gly.md).</span></span> <span data-ttu-id="5afe5-119">L’autre est utilisée pour indiquer l’algorithme de hachage à utiliser lors de l’appel d’une opération de [*hachage*](../secgloss/h-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="5afe5-119">The other is used to indicate which hashing algorithm is to be used when a [*hash*](../secgloss/h-gly.md) operation is called.</span></span> <span data-ttu-id="5afe5-120">Ces derniers ne doivent être définis qu’une seule fois.</span><span class="sxs-lookup"><span data-stu-id="5afe5-120">These need only be set once.</span></span>
4.  <span data-ttu-id="5afe5-121">La propriété d’un certificat détermine l’algorithme de hachage.</span><span class="sxs-lookup"><span data-stu-id="5afe5-121">A certificate's property determines the hash algorithm.</span></span>
5.  <span data-ttu-id="5afe5-122">Un hachage des données est créé en envoyant les données via la fonction de hachage.</span><span class="sxs-lookup"><span data-stu-id="5afe5-122">A hash of the data is created by sending the data through the hashing function.</span></span>
6.  <span data-ttu-id="5afe5-123">La signature est créée en chiffrant le hachage à l’aide de la clé privée, obtenue par le biais d’une propriété sur le certificat.</span><span class="sxs-lookup"><span data-stu-id="5afe5-123">The signature is created by encrypting the hash using the private key, obtained through a property on the certificate.</span></span>
7.  <span data-ttu-id="5afe5-124">Les données suivantes sont incluses dans le message terminé, signé :</span><span class="sxs-lookup"><span data-stu-id="5afe5-124">The following data is included in the finished, signed message:</span></span>
    -   <span data-ttu-id="5afe5-125">Données d’origine à signer</span><span class="sxs-lookup"><span data-stu-id="5afe5-125">The original data to be signed</span></span>
    -   <span data-ttu-id="5afe5-126">Algorithmes de hachage</span><span class="sxs-lookup"><span data-stu-id="5afe5-126">The hash algorithms</span></span>
    -   <span data-ttu-id="5afe5-127">Les signatures</span><span class="sxs-lookup"><span data-stu-id="5afe5-127">The signatures</span></span>
    -   <span data-ttu-id="5afe5-128">Structures d’informations sur le signataire, qui incluent l’identificateur du signataire (émetteur et numéro de série du certificat)</span><span class="sxs-lookup"><span data-stu-id="5afe5-128">The signer info structures, which includes the signer identifier (certificate issuer and serial number)</span></span>
    -   <span data-ttu-id="5afe5-129">Certificats du signataire (facultatif)</span><span class="sxs-lookup"><span data-stu-id="5afe5-129">The signer's certificates (optional)</span></span>

<span data-ttu-id="5afe5-130">Cette procédure illustre un cas simple.</span><span class="sxs-lookup"><span data-stu-id="5afe5-130">This procedure illustrates a simple case.</span></span> <span data-ttu-id="5afe5-131">Les cas plus complexes impliquent des attributs authentifiés inclus dans le message.</span><span class="sxs-lookup"><span data-stu-id="5afe5-131">More complex cases involve authenticated attributes included in the message.</span></span> <span data-ttu-id="5afe5-132">Lorsque le type de contenu est, à l’exception d’une chaîne d' **octets** , ou qu’il existe au moins un attribut authentifié avec un type de données, deux attributs authentifiés standard sont requis : le type de contenu (données) et le hachage du contenu.</span><span class="sxs-lookup"><span data-stu-id="5afe5-132">When the content type is anything but a **BYTE** string, or there is at least one authenticated attribute along with any data type, there are two standard authenticated attributes required: the content (data) type, and the hash of the content.</span></span> <span data-ttu-id="5afe5-133">Dans ces circonstances, l' [*CryptoAPI*](../secgloss/c-gly.md) fournit automatiquement ces deux attributs requis.</span><span class="sxs-lookup"><span data-stu-id="5afe5-133">Under these circumstances, the [*CryptoAPI*](../secgloss/c-gly.md) automatically provides these two required attributes.</span></span> <span data-ttu-id="5afe5-134">Les fonctions de message de bas niveau hachent les attributs authentifiés, chiffrent le hachage avec la clé privée et fournissent ce code comme signature.</span><span class="sxs-lookup"><span data-stu-id="5afe5-134">The low-level message functions hash the authenticated attributes, encrypt the hash with the private key, and provide this as the signature.</span></span>

<span data-ttu-id="5afe5-135">Utilisez les fonctions de message de bas niveau pour accomplir les tâches que vous venez de répertorier, à l’aide de la procédure suivante.</span><span class="sxs-lookup"><span data-stu-id="5afe5-135">Use the low-level message functions to accomplish the tasks just listed, by using the following procedure.</span></span>

<span data-ttu-id="5afe5-136">**Pour encoder un message signé**</span><span class="sxs-lookup"><span data-stu-id="5afe5-136">**To encode a signed message**</span></span>

1.  <span data-ttu-id="5afe5-137">Créez ou récupérez le contenu.</span><span class="sxs-lookup"><span data-stu-id="5afe5-137">Create or retrieve the content.</span></span>
2.  <span data-ttu-id="5afe5-138">Obtenir un fournisseur de services de chiffrement.</span><span class="sxs-lookup"><span data-stu-id="5afe5-138">Get a cryptographic provider.</span></span>
3.  <span data-ttu-id="5afe5-139">Obtient les certificats de signataire.</span><span class="sxs-lookup"><span data-stu-id="5afe5-139">Get the signer certificates.</span></span>
4.  <span data-ttu-id="5afe5-140">Initialisez la structure d' [**\_ informations de \_ codage \_ du signataire CMSG**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signer_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="5afe5-140">Initialize the [**CMSG\_SIGNER\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signer_encode_info) structure.</span></span>
5.  <span data-ttu-id="5afe5-141">Initialisez la structure d' [**\_ \_ \_ informations de codage signé CMSG**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="5afe5-141">Initialize the [**CMSG\_SIGNED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) structure.</span></span>
6.  <span data-ttu-id="5afe5-142">Appelez [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) pour connaître la taille de l’objet blob de message encodé.</span><span class="sxs-lookup"><span data-stu-id="5afe5-142">Call [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) to get the size of the encoded message BLOB.</span></span> <span data-ttu-id="5afe5-143">Allouez de la mémoire pour celui-ci.</span><span class="sxs-lookup"><span data-stu-id="5afe5-143">Allocate memory for it.</span></span>
7.  <span data-ttu-id="5afe5-144">Appelez [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), en passant CMSG \_ signed *pour dwMsgType* et un pointeur vers les [**\_ \_ \_ informations de codage signées CMSG**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) pour *pvMsgEncodeInfo* afin d’obtenir un handle pour le message ouvert.</span><span class="sxs-lookup"><span data-stu-id="5afe5-144">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing in CMSG\_SIGNED for *dwMsgType* and a pointer to [**CMSG\_SIGNED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_signed_encode_info) for *pvMsgEncodeInfo* to get a handle to the opened message.</span></span>
8.  <span data-ttu-id="5afe5-145">Appelez [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), en passant le handle récupéré à l’étape 7 et un pointeur vers les données qui doivent être signées et encodées.</span><span class="sxs-lookup"><span data-stu-id="5afe5-145">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passing in the handle retrieved in step 7, and a pointer to the data that is to be signed and encoded.</span></span> <span data-ttu-id="5afe5-146">Cette fonction peut être appelée autant de fois que nécessaire pour terminer le processus d’encodage.</span><span class="sxs-lookup"><span data-stu-id="5afe5-146">This function can be called as many times as necessary to complete the encoding process.</span></span>
9.  <span data-ttu-id="5afe5-147">Appelez [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), en passant le handle récupéré à l’étape 7 et les types de paramètres appropriés pour accéder aux données encodées souhaitées.</span><span class="sxs-lookup"><span data-stu-id="5afe5-147">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 7 and the appropriate parameter types to access the desired, encoded data.</span></span> <span data-ttu-id="5afe5-148">Par exemple, transmettez \_ le paramètre de contenu CMSG \_ pour obtenir un pointeur vers l’intégralité du message [*PKCS \# 7*](../secgloss/p-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="5afe5-148">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the entire [*PKCS \#7*](../secgloss/p-gly.md) message.</span></span>

    <span data-ttu-id="5afe5-149">Si le résultat de cet encodage doit être utilisé en tant que [*données internes*](../secgloss/i-gly.md) pour un autre message encodé, tel qu’un message enveloppé, le \_ \_ paramètre param CMSG Bare Content \_ doit être passé.</span><span class="sxs-lookup"><span data-stu-id="5afe5-149">If the result of this encoding is to be used as the [*inner data*](../secgloss/i-gly.md) for another encoded message, such as an enveloped message, the CMSG\_BARE\_CONTENT\_PARAM parameter must be passed.</span></span> <span data-ttu-id="5afe5-150">Pour obtenir un exemple qui illustre cela, consultez [autre code pour l’encodage d’un message enveloppé](alternate-code-for-encoding-an-enveloped-message.md).</span><span class="sxs-lookup"><span data-stu-id="5afe5-150">For an example showing this, see [Alternate Code for Encoding an Enveloped Message](alternate-code-for-encoding-an-enveloped-message.md).</span></span>

10. <span data-ttu-id="5afe5-151">Fermez le message en appelant [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span><span class="sxs-lookup"><span data-stu-id="5afe5-151">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="5afe5-152">Le résultat de cette procédure est un message encodé qui contient les données d’origine, le hachage chiffré de ces données (signature) et les informations sur le signataire.</span><span class="sxs-lookup"><span data-stu-id="5afe5-152">The result of this procedure is an encoded message that contains the original data, the encrypted hash of that data (signature), and the signer information.</span></span> <span data-ttu-id="5afe5-153">Il y a également un pointeur vers l’objet BLOB encodé souhaité.</span><span class="sxs-lookup"><span data-stu-id="5afe5-153">There is also a pointer to the desired, encoded BLOB.</span></span>

<span data-ttu-id="5afe5-154">Pour plus d’informations sur le codage C, consultez [exemple de programme c : signature, encodage, décodage et vérification d’un message](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span><span class="sxs-lookup"><span data-stu-id="5afe5-154">For C coding details, see [Example C Program: Signing, Encoding, Decoding, and Verifying a Message](example-c-program-signing-encoding-decoding-and-verifying-a-message.md).</span></span>

 

 
