---
description: Comment vous pouvez utiliser les fonctions de sauvegarde des services de certificats pour sauvegarder une base de données de services de certificats et ses fichiers associés.
ms.assetid: f5c9c9f9-5211-4151-b8e0-3351d462c71b
title: Sauvegarde des services de certificats
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d1be929fcf3bd9b8b9655b48758a97d19af7abc7
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "103868806"
---
# <a name="backing-up-certificate-services"></a><span data-ttu-id="066f5-103">Sauvegarde des services de certificats</span><span class="sxs-lookup"><span data-stu-id="066f5-103">Backing Up Certificate Services</span></span>

<span data-ttu-id="066f5-104">Vous trouverez ci-dessous un scénario illustrant l’utilisation des fonctions de sauvegarde des services de certificats pour sauvegarder une base de données de services de certificats et ses fichiers associés.</span><span class="sxs-lookup"><span data-stu-id="066f5-104">The following is a scenario showing how you can use the Certificate Services backup functions to back up a Certificate Services database and its associated files.</span></span>

1.  <span data-ttu-id="066f5-105">Chargez la bibliothèque Certadm.dll en mémoire (en appelant [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="066f5-105">Load the Certadm.dll library into memory (by calling [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span>
2.  <span data-ttu-id="066f5-106">Récupérez l’adresse de chacune des fonctions nécessaires dans Certadm.dll (par le biais de [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span><span class="sxs-lookup"><span data-stu-id="066f5-106">Retrieve the address of each of the necessary functions in Certadm.dll (by means of [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span></span> <span data-ttu-id="066f5-107">Utilisez ces adresses lors de l’appel des fonctions dans les étapes restantes.</span><span class="sxs-lookup"><span data-stu-id="066f5-107">Use these addresses when calling the functions in the remaining steps.</span></span>
3.  <span data-ttu-id="066f5-108">Appelez [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) pour déterminer si les services de certificats sont en ligne.</span><span class="sxs-lookup"><span data-stu-id="066f5-108">Call [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) to determine whether Certificate Services is online.</span></span> <span data-ttu-id="066f5-109">Les services de certificats doivent être en ligne pour que les opérations de sauvegarde soient réussies.</span><span class="sxs-lookup"><span data-stu-id="066f5-109">Certificate Services must be online for the backup operations to be successful.</span></span>
4.  <span data-ttu-id="066f5-110">Appelez [**CertSrvBackupPrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuppreparew) pour démarrer une session de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="066f5-110">Call [**CertSrvBackupPrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuppreparew) to start a backup session.</span></span> <span data-ttu-id="066f5-111">Le descripteur de contexte de sauvegarde des services de certificats qui en résulte sera utilisé par la plupart des autres fonctions de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="066f5-111">The resulting Certificate Services backup context handle will be used by many of the other backup functions.</span></span>
5.  <span data-ttu-id="066f5-112">Appelez [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw) pour déterminer le mappage de restauration.</span><span class="sxs-lookup"><span data-stu-id="066f5-112">Call [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw) to determine the restore map.</span></span> <span data-ttu-id="066f5-113">La table de restauration contient les chemins d’accès à utiliser lors de la restauration de la sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="066f5-113">The restore map contains the paths to be used when restoring the backup.</span></span> <span data-ttu-id="066f5-114">Enregistrez les informations récupérées par **CertSrvRestoreGetDatabaseLocations** dans un emplacement spécifique à l’application.</span><span class="sxs-lookup"><span data-stu-id="066f5-114">Save the information retrieved by **CertSrvRestoreGetDatabaseLocations** to an application-specific location.</span></span>
6.  <span data-ttu-id="066f5-115">Appelez [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) pour déterminer les noms des fichiers de base de données à sauvegarder.</span><span class="sxs-lookup"><span data-stu-id="066f5-115">Call [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) to determine the names of the database files to backup.</span></span> <span data-ttu-id="066f5-116">Pour chacun de ces fichiers, exécutez les étapes 7 à 9.</span><span class="sxs-lookup"><span data-stu-id="066f5-116">For each of these files, execute steps 7 through 9.</span></span>
7.  <span data-ttu-id="066f5-117">Appelez [**CertSrvBackupOpenFile**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupopenfilew) pour ouvrir le fichier à sauvegarder.</span><span class="sxs-lookup"><span data-stu-id="066f5-117">Call [**CertSrvBackupOpenFile**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupopenfilew) to open the file for backup.</span></span>
8.  <span data-ttu-id="066f5-118">Appelez [**CertSrvBackupRead**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupread) pour lire une partie des octets du fichier, puis appelez une routine propre à l’application pour stocker les octets sur un support de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="066f5-118">Call [**CertSrvBackupRead**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupread) to read a portion of bytes from the file, then call an application-specific routine to store the bytes on a backup medium.</span></span> <span data-ttu-id="066f5-119">Répétez cette étape jusqu’à ce que tous les octets du fichier soient sauvegardés.</span><span class="sxs-lookup"><span data-stu-id="066f5-119">Repeat this step until all of the bytes in the file are backed up.</span></span>
9.  <span data-ttu-id="066f5-120">Appelez [**CertSrvBackupClose**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupclose) pour fermer le fichier.</span><span class="sxs-lookup"><span data-stu-id="066f5-120">Call [**CertSrvBackupClose**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupclose) to close the file.</span></span>
10. <span data-ttu-id="066f5-121">Appelez [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) pour déterminer les noms des fichiers journaux à sauvegarder.</span><span class="sxs-lookup"><span data-stu-id="066f5-121">Call [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) to determine the names of the log files to backup.</span></span> <span data-ttu-id="066f5-122">Pour chacun de ces fichiers, exécutez les étapes 7 à 9.</span><span class="sxs-lookup"><span data-stu-id="066f5-122">For each of these files, execute steps 7 through 9.</span></span>
11. <span data-ttu-id="066f5-123">Appelez [**CertSrvBackupTruncateLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuptruncatelogs) pour tronquer les fichiers journaux qui ont été sauvegardés aux étapes 6 et 10.</span><span class="sxs-lookup"><span data-stu-id="066f5-123">Call [**CertSrvBackupTruncateLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackuptruncatelogs) to truncate the log files which were backed up in steps 6 and 10.</span></span> <span data-ttu-id="066f5-124">Cette étape est facultative. Toutefois, appelez **CertSrvBackupTruncateLogs** uniquement si tous les fichiers retournés par [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) et [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) ont été sauvegardés (sinon, l’opération de restauration échoue).</span><span class="sxs-lookup"><span data-stu-id="066f5-124">This step is optional; however, call **CertSrvBackupTruncateLogs** only if all files returned by [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw) and [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw) have been backed up (otherwise, the restore operation will fail).</span></span> <span data-ttu-id="066f5-125">Pour plus d’informations, consultez la page de référence de **CertSrvBackupTruncateLogs** .</span><span class="sxs-lookup"><span data-stu-id="066f5-125">Consult the **CertSrvBackupTruncateLogs** reference page for details.</span></span>
12. <span data-ttu-id="066f5-126">Appelez [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) pour déterminer les noms des fichiers non-de base de données à sauvegarder.</span><span class="sxs-lookup"><span data-stu-id="066f5-126">Call [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) to determine the names of the non-database files to backup.</span></span> <span data-ttu-id="066f5-127">Ces fichiers sont identifiés uniquement par la fonction et doivent être sauvegardés par d’autres moyens.</span><span class="sxs-lookup"><span data-stu-id="066f5-127">These files are only identified by the function, and must be backed up by some other means.</span></span>
13. <span data-ttu-id="066f5-128">Sauvegardez les fichiers dynamiques identifiés à l’étape 12, à l’aide de routines distinctes de Certadm.dll.</span><span class="sxs-lookup"><span data-stu-id="066f5-128">Backup the dynamic files identified in step 12, using routines separate from Certadm.dll.</span></span>
14. <span data-ttu-id="066f5-129">Appelez [**CertSrvBackupEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupend) pour mettre fin à la session de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="066f5-129">Call [**CertSrvBackupEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupend) to end the backup session.</span></span>
15. <span data-ttu-id="066f5-130">Appelez [**CertSrvBackupFree**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupfree) en fonction des besoins pour libérer les tampons alloués par certaines fonctions de sauvegarde des services de certificats.</span><span class="sxs-lookup"><span data-stu-id="066f5-130">Call [**CertSrvBackupFree**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupfree) as needed to release buffers allocated by certain Certificate Services backup functions.</span></span> <span data-ttu-id="066f5-131">Les appels à [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw), [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw)et [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) allouez des tampons qui peuvent être libérés par un appel à **CertSrvBackupFree**.</span><span class="sxs-lookup"><span data-stu-id="066f5-131">Calls to [**CertSrvBackupGetBackupLogs**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetbackuplogsw), [**CertSrvBackupGetDatabaseNames**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdatabasenamesw), and [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) will allocate buffers that can be freed by a call to **CertSrvBackupFree**.</span></span>
16. <span data-ttu-id="066f5-132">Libérez les ressources Certadm.dll en appelant [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary).</span><span class="sxs-lookup"><span data-stu-id="066f5-132">Release the Certadm.dll resources by calling [**FreeLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-freelibrary).</span></span>

<span data-ttu-id="066f5-133">Pour plus d’informations sur les privilèges requis pour sauvegarder la base de données des services de certificats et les fichiers associés, consultez [définition des privilèges de sauvegarde et de restauration](setting-the-backup-and-restore-privileges.md).</span><span class="sxs-lookup"><span data-stu-id="066f5-133">For information about the privileges required to back up the Certificate Services database and associated files, see [Setting the Backup and Restore Privileges](setting-the-backup-and-restore-privileges.md).</span></span>

 

 
