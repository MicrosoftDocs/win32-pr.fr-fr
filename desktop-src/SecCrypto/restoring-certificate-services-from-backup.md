---
description: Montre comment les fonctions de sauvegarde des services de certificats peuvent être utilisées pour restaurer et récupérer une base de données de services de certificats et ses fichiers associés.
ms.assetid: f4914f45-629d-4f24-8328-d7f27e8a0062
title: Restauration des services de certificats à partir d’une sauvegarde
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8f5adf46d802194909397a3b70483b3cf43bb409
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "106518897"
---
# <a name="restoring-certificate-services-from-backup"></a><span data-ttu-id="5090e-103">Restauration des services de certificats à partir d’une sauvegarde</span><span class="sxs-lookup"><span data-stu-id="5090e-103">Restoring Certificate Services from Backup</span></span>

<span data-ttu-id="5090e-104">Le scénario suivant montre comment les fonctions de sauvegarde des services de certificats peuvent être utilisées pour restaurer et récupérer une base de données de services de certificats et ses fichiers associés.</span><span class="sxs-lookup"><span data-stu-id="5090e-104">The following scenario shows how the Certificate Services backup functions can be used to restore and recover a Certificate Services database and its associated files.</span></span> <span data-ttu-id="5090e-105">Le processus de restauration implique l’écriture des fichiers contenus dans un jeu de sauvegarde sur disque.</span><span class="sxs-lookup"><span data-stu-id="5090e-105">The restoration process involves writing the files contained in a backup set to disk.</span></span> <span data-ttu-id="5090e-106">Vous pouvez restaurer plusieurs jeux de sauvegarde (une sauvegarde complète plus zéro, une ou plusieurs sauvegardes incrémentielles), mais toutes les restaurations doivent être terminées avant de commencer le processus de récupération.</span><span class="sxs-lookup"><span data-stu-id="5090e-106">You may restore multiple backup sets (one full backup plus zero or more incremental backups), but all restores must be complete prior to beginning the recovery process.</span></span> <span data-ttu-id="5090e-107">Le processus de récupération implique la relecture des fichiers journaux par les services de certificats pour garantir la cohérence des fichiers journaux et de base de données, garantissant ainsi l’intégrité de la base de données.</span><span class="sxs-lookup"><span data-stu-id="5090e-107">The recovery process involves Certificate Services replaying log files to ensure database and log file consistency, thereby ensuring database integrity.</span></span> <span data-ttu-id="5090e-108">Le scénario illustre les appels de fonction permettant de restaurer les jeux de sauvegarde et d’informer les services de certificats des paramètres de récupération.</span><span class="sxs-lookup"><span data-stu-id="5090e-108">The scenario illustrates the function calls to restore the backup sets and inform Certificate Services of the recovery parameters.</span></span>

<span data-ttu-id="5090e-109">Une sauvegarde complète existante de la base de données des services de certificats doit exister avant d’implémenter ce scénario.</span><span class="sxs-lookup"><span data-stu-id="5090e-109">An existing full backup of the Certificate Services database must exist before implementing this scenario.</span></span>

1.  <span data-ttu-id="5090e-110">Chargez la bibliothèque Certadm.dll en mémoire (en appelant [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="5090e-110">Load the Certadm.dll library into memory (by calling [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span>
2.  <span data-ttu-id="5090e-111">Récupérez l’adresse de chacune des fonctions nécessaires dans Certadm.dll (par le biais de [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span><span class="sxs-lookup"><span data-stu-id="5090e-111">Retrieve the address of each of the necessary functions in Certadm.dll (by means of [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span></span> <span data-ttu-id="5090e-112">Utilisez ces adresses lors de l’appel des fonctions dans les étapes restantes.</span><span class="sxs-lookup"><span data-stu-id="5090e-112">Use these addresses when calling the functions in the remaining steps.</span></span>
3.  <span data-ttu-id="5090e-113">Appelez [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) pour déterminer si les services de certificats sont en ligne.</span><span class="sxs-lookup"><span data-stu-id="5090e-113">Call [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) to determine whether Certificate Services is online.</span></span> <span data-ttu-id="5090e-114">Si les services de certificats sont en cours d’exécution, arrêtez-le avant de continuer.</span><span class="sxs-lookup"><span data-stu-id="5090e-114">If Certificate Services is running, shut it down before proceeding.</span></span> <span data-ttu-id="5090e-115">Les services de certificats ne doivent pas être en ligne pour que les opérations de restauration aboutissent.</span><span class="sxs-lookup"><span data-stu-id="5090e-115">Certificate Services must not be online for the restore operations to be successful.</span></span>
4.  <span data-ttu-id="5090e-116">Appelez [**CertSrvRestorePrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) pour démarrer une session de restauration.</span><span class="sxs-lookup"><span data-stu-id="5090e-116">Call [**CertSrvRestorePrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) to begin a restore session.</span></span> <span data-ttu-id="5090e-117">Le descripteur de contexte de sauvegarde des services de certificats qui en résulte sera utilisé par plusieurs autres fonctions.</span><span class="sxs-lookup"><span data-stu-id="5090e-117">The resulting Certificate Services backup context handle will be used by several of the other functions.</span></span>
5.  <span data-ttu-id="5090e-118">Déterminez le chemin d’accès à l’emplacement de la base de données.</span><span class="sxs-lookup"><span data-stu-id="5090e-118">Determine the path for the database location.</span></span> <span data-ttu-id="5090e-119">Pendant un scénario de sauvegarde, cette valeur aurait été disponible à partir d’un appel à [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); Cette valeur doit avoir été stockée dans le cadre de la sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="5090e-119">During a backup scenario, this value would have been available from a call to [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); this value should have been stored as part of the backup.</span></span>
6.  <span data-ttu-id="5090e-120">Créez un mappage de restauration spécifiant le nom de la base de données restaurée.</span><span class="sxs-lookup"><span data-stu-id="5090e-120">Create a restore map specifying the name of the restored database.</span></span> <span data-ttu-id="5090e-121">Une structure de table de restauration de base de données de services de certificats (CSEDB \_ RSTMAPW) est utilisée pour spécifier un mappage de restauration.</span><span class="sxs-lookup"><span data-stu-id="5090e-121">A Certificate Services database restore map structure (CSEDB\_RSTMAPW) is used to specify a restore map.</span></span> <span data-ttu-id="5090e-122">Définissez le \_ membre **pwszDatabaseName** du RSTMAPW CSEDB et le \_ membre **RSTMAPW** CSEDB pwszNewDatabaseName sur l’emplacement de la base de données déterminé à l’étape 5.</span><span class="sxs-lookup"><span data-stu-id="5090e-122">Set the CSEDB\_RSTMAPW's **pwszDatabaseName** member and the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the database location determined in step 5.</span></span> <span data-ttu-id="5090e-123">Si, éventuellement, la base de données restaurée doit avoir un nom différent de celui de la base de données de sauvegarde, définissez le \_ membre **pwszNewDatabaseName** du RSTMAPW CSEDB sur le nouveau nom de la base de données.</span><span class="sxs-lookup"><span data-stu-id="5090e-123">Optionally, if the restored database is to have a different name than the backup database, set the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the new database name.</span></span>
7.  <span data-ttu-id="5090e-124">Si vous souhaitez vous assurer que les modifications apportées à la base de données après la sauvegarde ne sont pas réappliquées à la fin de la restauration de la base de données (dans le cadre de la récupération de la base de données lors du prochain démarrage des services de certificats), supprimez les fichiers de la base de données active et des répertoires des journaux du serveur cible</span><span class="sxs-lookup"><span data-stu-id="5090e-124">If you want to ensure that modifications made to the database after the backup was performed are not reapplied after database restore is complete (as part of database recovery performed during the next Certificate Services startup), delete files from the target server's active database and log directories.</span></span>
8.  <span data-ttu-id="5090e-125">Copiez les fichiers contenus dans la sauvegarde complète dans les répertoires de la base de données active et du journal du serveur cible.</span><span class="sxs-lookup"><span data-stu-id="5090e-125">Copy the files contained in the full backup to the target server's active database and log directories.</span></span>
9.  <span data-ttu-id="5090e-126">Appelez [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) pour inscrire une opération de restauration pour la sauvegarde complète.</span><span class="sxs-lookup"><span data-stu-id="5090e-126">Call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) to register a restore operation for the full backup.</span></span> <span data-ttu-id="5090e-127">**CertSrvRestoreRegister** utilise le mappage de restauration spécifié à l’étape 6.</span><span class="sxs-lookup"><span data-stu-id="5090e-127">**CertSrvRestoreRegister** uses the restore map specified in step 6.</span></span> <span data-ttu-id="5090e-128">**CertSrvRestoreRegister** spécifie également l’emplacement de la base de données de sauvegarde et des journaux.</span><span class="sxs-lookup"><span data-stu-id="5090e-128">**CertSrvRestoreRegister** also specifies the location of the backup database and logs.</span></span> <span data-ttu-id="5090e-129">L’appel de **CertSrvRestoreRegister** force les services de certificats à tenter d’effectuer une opération de restauration lors du prochain démarrage.</span><span class="sxs-lookup"><span data-stu-id="5090e-129">Calling **CertSrvRestoreRegister** will force Certificate Services to attempt a restore operation the next time it is started.</span></span> <span data-ttu-id="5090e-130">Il empêche également les services de certificats de traiter les demandes de certificats jusqu’à ce que la restauration soit terminée.</span><span class="sxs-lookup"><span data-stu-id="5090e-130">It also prevents Certificate Services from processing Certificate Requests until the restoration is complete.</span></span>
10. <span data-ttu-id="5090e-131">Appelez [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), ce qui a pour effet de terminer l’activité d’inscription démarrée à l’étape 8.</span><span class="sxs-lookup"><span data-stu-id="5090e-131">Call [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), thereby finishing the registration activity that started in step 8.</span></span> <span data-ttu-id="5090e-132">Notez que l’inscription d’une opération de restauration est une instruction qui doit être suivie par les services de certificats lorsqu’elle est démarrée. la récupération réelle aura lieu uniquement après le démarrage des services de certificats.</span><span class="sxs-lookup"><span data-stu-id="5090e-132">Note that the registration of a restore operation is an instruction for Certificate Services to follow when it is started; the actual recovery will take place only after Certificate Services is started.</span></span>
11. <span data-ttu-id="5090e-133">Pour chaque sauvegarde incrémentielle à restaurer, copiez les fichiers contenus dans la sauvegarde incrémentielle dans le répertoire des journaux actifs du serveur cible, puis appelez [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), suivi d’un appel à [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete).</span><span class="sxs-lookup"><span data-stu-id="5090e-133">For each incremental backup to be restored, copy the files contained in the incremental backup to the target server's active log directory, then call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), followed by a call to [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete).</span></span> <span data-ttu-id="5090e-134">L’inscription des sauvegardes incrémentielles pour la restauration peut se produire dans n’importe quel ordre, mais seul l’ensemble des fichiers pour une sauvegarde incrémentielle doit être copié sur le serveur avant chaque appel à **CertSrvRestoreRegister**.</span><span class="sxs-lookup"><span data-stu-id="5090e-134">The registration of the incremental backups for restoration can occur in any order, but only the set of files for one incremental backup should be copied to the server before each call to **CertSrvRestoreRegister**.</span></span>
12. <span data-ttu-id="5090e-135">Copiez les fichiers dynamiques des services de certificats sur le serveur cible.</span><span class="sxs-lookup"><span data-stu-id="5090e-135">Copy the Certificate Services dynamic files to the target server.</span></span> <span data-ttu-id="5090e-136">Les fichiers dynamiques auraient été identifiés lors de la sauvegarde lors de l’appel de [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) .</span><span class="sxs-lookup"><span data-stu-id="5090e-136">The dynamic files would have been identified during the backup when [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) was called.</span></span> <span data-ttu-id="5090e-137">Il peut être nécessaire d’arrêter le service de publication World Wide Web pour autoriser le remplacement des fichiers dynamiques.</span><span class="sxs-lookup"><span data-stu-id="5090e-137">It may be necessary to stop the World Wide Web Publishing Service to allow overwriting the dynamic files.</span></span>
13. <span data-ttu-id="5090e-138">Appelez [**CertSrvRestoreEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) pour mettre fin à la session de restauration.</span><span class="sxs-lookup"><span data-stu-id="5090e-138">Call [**CertSrvRestoreEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) to end the restore session.</span></span>
14. <span data-ttu-id="5090e-139">Démarrez l’application des services de certificats manuellement (ou attendez le prochain redémarrage pour qu’elle démarre automatiquement).</span><span class="sxs-lookup"><span data-stu-id="5090e-139">Start the Certificate Services application manually (or wait until the next restart for it to start automatically).</span></span> <span data-ttu-id="5090e-140">Lorsque les services de certificats démarrent, il détermine si une opération de restauration a été inscrite ; Si une opération de restauration a été enregistrée, les services de certificats commencent la récupération.</span><span class="sxs-lookup"><span data-stu-id="5090e-140">When Certificate Services starts, it will determine whether a restore operation has been registered; if a restore operation has been registered, Certificate Services will begin the recovery.</span></span> <span data-ttu-id="5090e-141">Les services de certificats ne traitent pas les demandes de certificat tant que l’opération de récupération n’est pas terminée.</span><span class="sxs-lookup"><span data-stu-id="5090e-141">Certificate Services will not process any certificate requests until the recovery operation is completed.</span></span>

> [!Note]  
> <span data-ttu-id="5090e-142">Une fois la récupération terminée, il est important d’effectuer une nouvelle sauvegarde complète de la base de données des services de certificats.</span><span class="sxs-lookup"><span data-stu-id="5090e-142">When a recovery is complete, it is important that you make a new full backup of the Certificate Services database.</span></span> <span data-ttu-id="5090e-143">Cela est nécessaire pour tronquer les fichiers journaux restaurés et établir un jeu de sauvegarde de base pour les restaurations ultérieures.</span><span class="sxs-lookup"><span data-stu-id="5090e-143">This is necessary to truncate the restored log files and to establish a base backup set for future restores.</span></span> <span data-ttu-id="5090e-144">Les sauvegardes effectuées après une restauration ne peuvent pas être mélangées à des sauvegardes (complètes ou incrémentielles) effectuées avant la restauration. autrement dit, après la restauration d’une base de données de services de certificats et l’avancement de l’état suivant, vous ne pouvez pas utiliser les sauvegardes de prérestauration pour restaurer la base de données à l’état suivant.</span><span class="sxs-lookup"><span data-stu-id="5090e-144">Backups performed after a restore cannot be mixed with backups (full or incremental) taken before the restore; that is, after a certificate services database is restored and has progressed to a subsequent state, you cannot use the pre-restoration backups to restore the database to that subsequent state.</span></span>

 

 

 
