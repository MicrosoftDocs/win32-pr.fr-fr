---
description: Plusieurs fonctions fournissent des services pour la gestion de l’état d’un magasin de certificats.
ms.assetid: bae3d693-31b3-4c1d-9a8f-0dafa8bb6897
title: Gestion de l’état d’un magasin de certificats
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 53d66e40817f0f92f48e8841455998eff4dbffd6
ms.sourcegitcommit: de72a1294df274b0a71dc0fdc42d757e5f6df0f3
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/05/2021
ms.locfileid: "103953488"
---
# <a name="managing-a-certificate-store-state"></a><span data-ttu-id="c141a-103">Gestion de l’état d’un magasin de certificats</span><span class="sxs-lookup"><span data-stu-id="c141a-103">Managing a Certificate Store State</span></span>

<span data-ttu-id="c141a-104">Plusieurs fonctions fournissent des services pour la gestion de l' [*État*](../secgloss/s-gly.md)d’un [*magasin de certificats*](../secgloss/c-gly.md) .</span><span class="sxs-lookup"><span data-stu-id="c141a-104">Several functions provide services for managing a [*certificate store*](../secgloss/c-gly.md) [*state*](../secgloss/s-gly.md).</span></span>

<span data-ttu-id="c141a-105">Pour accéder aux certificats, le magasin de certificats dans lequel ils sont stockés doit être ouvert par un appel à [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) ou [**CertOpenSystemStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopensystemstorea).</span><span class="sxs-lookup"><span data-stu-id="c141a-105">To gain access to certificates, the certificate store in which they are stored must be opened through a call to [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) or [**CertOpenSystemStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopensystemstorea).</span></span>

<span data-ttu-id="c141a-106">En général, un magasin de certificats est ouvert dans la mémoire mise en cache.</span><span class="sxs-lookup"><span data-stu-id="c141a-106">Usually a certificate store is opened in cached memory.</span></span> <span data-ttu-id="c141a-107">Il peut s’agir d’un nouveau magasin ou son contenu peut être chargé à partir du registre local, du Registre sur un ordinateur distant, d’un fichier disque, d’un \# message PKCS 7 ou d’une autre source.</span><span class="sxs-lookup"><span data-stu-id="c141a-107">It can be a new store or its contents can be loaded from the local registry, the registry on a remote computer, a disk file, a PKCS \#7 message, or some other source.</span></span>

<span data-ttu-id="c141a-108">Les fonctions de magasin de certificats CryptoAPI permettent également à un magasin de conserver des certificats en dehors de la mémoire mise en cache dans, par exemple, une base de données externe de certificats, telle que celle fournie par la base de données du serveur de certificats Microsoft.</span><span class="sxs-lookup"><span data-stu-id="c141a-108">CryptoAPI certificate store functions also allow a store to maintain certificates outside cached memory in, for example, an external database of certificates such as the one provided by the Microsoft Certificate Server Database.</span></span>

<span data-ttu-id="c141a-109">L’un des paramètres de la fonction [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) , *lpszStoreProvider,* détermine le type de magasin ouvert et le fournisseur utilisé pour ouvrir ce magasin.</span><span class="sxs-lookup"><span data-stu-id="c141a-109">One of the parameters of the [**CertOpenStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certopenstore) function, *lpszStoreProvider,* determines the type of store opened and the provider used to open that store.</span></span> <span data-ttu-id="c141a-110">Pour obtenir des exemples d’ouverture de magasins de certificats à l’aide de différents fournisseurs, consultez l' [exemple de code C pour l’ouverture de magasins de certificats](example-c-code-for-opening-certificate-stores.md).</span><span class="sxs-lookup"><span data-stu-id="c141a-110">For examples of opening certificate stores using various providers, see [Example C Code for Opening Certificate Stores](example-c-code-for-opening-certificate-stores.md).</span></span>

<span data-ttu-id="c141a-111">[**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) ferme un magasin de certificats.</span><span class="sxs-lookup"><span data-stu-id="c141a-111">[**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) closes a certificate store.</span></span> <span data-ttu-id="c141a-112">Lors de la fermeture d’un magasin de certificats, le [*nombre de références*](../secgloss/r-gly.md) de chacun des contextes de certificat de ce magasin est réduit d’une unité.</span><span class="sxs-lookup"><span data-stu-id="c141a-112">When a certificate store is closed, each of the certificate contexts in that store has its [*reference count*](../secgloss/r-gly.md) reduced by one.</span></span> <span data-ttu-id="c141a-113">La mémoire est libérée pour les certificats dont le décompte de références atteint zéro.</span><span class="sxs-lookup"><span data-stu-id="c141a-113">Memory is freed for certificates whose reference count goes to zero.</span></span>

<span data-ttu-id="c141a-114">La définition \_ de \_ \_ \_ l’indicateur de force du magasin de fermeture de certificat avec [**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) ferme le magasin de certificats et libère de la mémoire pour tous ses contextes de certificats, quel que soit le nombre de références.</span><span class="sxs-lookup"><span data-stu-id="c141a-114">Setting CERT\_CLOSE\_STORE\_FORCE\_FLAG with [**CertCloseStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certclosestore) closes the certificate store and frees memory for all of its certificate contexts regardless of their reference count.</span></span> <span data-ttu-id="c141a-115">Dans certains cas, comme dans les programmes multithread, cela ne peut pas être souhaitable.</span><span class="sxs-lookup"><span data-stu-id="c141a-115">In some cases, such as in multithreaded programs, this cannot be desirable.</span></span> <span data-ttu-id="c141a-116">Si \_ \_ \_ l’indicateur de validation du magasin de fermeture du certificat \_ est défini, le magasin est fermé, mais une valeur d’avertissement est retournée par la fonction si la mémoire est toujours allouée pour les certificats dont le nombre de références n’a pas été réduit à zéro.</span><span class="sxs-lookup"><span data-stu-id="c141a-116">If CERT\_CLOSE\_STORE\_CHECK\_FLAG is set, the store is closed, but a warning value is returned by the function if memory is still allocated for certificates whose reference counts have not been reduced to zero.</span></span> <span data-ttu-id="c141a-117">Si le nombre de références d’un certificat est supérieur à zéro, un doublon de ce contexte de certificat n’a pas été libéré.</span><span class="sxs-lookup"><span data-stu-id="c141a-117">If a certificate's reference count is greater than zero, a duplicate of that certificate context has not been freed.</span></span> <span data-ttu-id="c141a-118">Utilisez [**CertFreeCertificateContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecertificatecontext), [**CertFreeCRLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecrlcontext)et [**CertFreeCTLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreectlcontext) pour libérer tous les certificats laissés ouverts.</span><span class="sxs-lookup"><span data-stu-id="c141a-118">Use [**CertFreeCertificateContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecertificatecontext), [**CertFreeCRLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreecrlcontext), and [**CertFreeCTLContext**](/windows/desktop/api/Wincrypt/nf-wincrypt-certfreectlcontext) to free any certificates left open.</span></span>

> [!Note]
> <span data-ttu-id="c141a-119">Un [*contexte de certificat*](../secgloss/c-gly.md) est une structure de [**type CERT \_ Context**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_context) qui a, entre autres membres, un pointeur vers l' [*objet blob de certificat*](../secgloss/c-gly.md) encodé et un pointeur vers une structure d' [**\_ informations**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_info) de certificat.</span><span class="sxs-lookup"><span data-stu-id="c141a-119">A [*certificate context*](../secgloss/c-gly.md) is a structure of type [**CERT\_CONTEXT**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_context) that has, among other members, a pointer to the encoded [*certificate BLOB*](../secgloss/c-gly.md) and a pointer to a [**CERT\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cert_info) structure.</span></span> <span data-ttu-id="c141a-120">La structure des **\_ informations** de certificat contient les données de certificat les plus significatives.</span><span class="sxs-lookup"><span data-stu-id="c141a-120">The **CERT\_INFO** structure contains the most significant certificate data.</span></span> <span data-ttu-id="c141a-121">Pour plus d’informations sur les structures de contexte [*Certificate*](../secgloss/c-gly.md), [*liste de révocation de certificats*](../secgloss/c-gly.md) et liste de certificats de [*confiance*](../secgloss/c-gly.md) (CTL), consultez [encodage et décodage d’un contexte de certificat](encoding-and-decoding-a-certificate-context.md).</span><span class="sxs-lookup"><span data-stu-id="c141a-121">For more information about [*certificate*](../secgloss/c-gly.md), [*certificate revocation list*](../secgloss/c-gly.md) (CRL), and [*certificate trust list*](../secgloss/c-gly.md) (CTL) context structures, see [Encoding and Decoding a Certificate Context](encoding-and-decoding-a-certificate-context.md).</span></span>
> 
> <span data-ttu-id="c141a-122">Chaque contexte de certificat contient également un nombre de [*références*](../secgloss/r-gly.md) indiquant le nombre de copies de l’adresse du contexte qui ont été affectées.</span><span class="sxs-lookup"><span data-stu-id="c141a-122">Each certificate context also contains a [*reference count*](../secgloss/r-gly.md) indicating the number of copies of the context's address that have been assigned.</span></span> <span data-ttu-id="c141a-123">Chaque fois qu’un contexte de certificat est dupliqué, son décompte de références est incrémenté d’une unité.</span><span class="sxs-lookup"><span data-stu-id="c141a-123">Each time a certificate context is duplicated in any way, its reference count is incremented by one.</span></span> <span data-ttu-id="c141a-124">Chaque fois qu’un pointeur vers un contexte de certificat est libéré, le nombre de références dans le contexte de certificat est décrémenté d’une unité.</span><span class="sxs-lookup"><span data-stu-id="c141a-124">Each time a pointer to a certificate context is freed, the reference count in the certificate context is decremented by one.</span></span> <span data-ttu-id="c141a-125">Lorsque le nombre de références sur un contexte de certificat atteint zéro, la mémoire contenant le contexte est désallouée.</span><span class="sxs-lookup"><span data-stu-id="c141a-125">When the reference count on a certificate context reaches zero, the memory holding the context is de-allocated.</span></span> <span data-ttu-id="c141a-126">La mémoire allouée pour un contexte de certificat est également désallouée lorsque ce contexte se trouve dans un magasin et que le magasin est fermé à l’aide de l’indicateur de force du magasin de fermeture de certificat \_ \_ \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="c141a-126">Memory allocated for a certificate context is also de-allocated when that context is in a store and the store is closed using CERT\_CLOSE\_STORE\_FORCE\_FLAG.</span></span> <span data-ttu-id="c141a-127">Si la mémoire d’un contexte est désallouée et que les pointeurs vers ce contexte sont toujours en cours d’utilisation, ces pointeurs ne sont plus valides.</span><span class="sxs-lookup"><span data-stu-id="c141a-127">If the memory for a context is de-allocated and pointers to that context are still in use, those pointers are no longer valid.</span></span>

 

<span data-ttu-id="c141a-128">[**CertDuplicateStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certduplicatestore) augmente le [*nombre de références*](../secgloss/r-gly.md) sur le magasin.</span><span class="sxs-lookup"><span data-stu-id="c141a-128">[**CertDuplicateStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certduplicatestore) increases the [*reference count*](../secgloss/r-gly.md) on the store.</span></span>

<span data-ttu-id="c141a-129">[**CertSaveStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsavestore) enregistre le contenu d’un magasin dans un fichier disque ou dans un emplacement de mémoire, et</span><span class="sxs-lookup"><span data-stu-id="c141a-129">[**CertSaveStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsavestore) saves the contents of a store to a disk file or a memory location, and</span></span>

<span data-ttu-id="c141a-130">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) gère un magasin pendant qu’il est ouvert.</span><span class="sxs-lookup"><span data-stu-id="c141a-130">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) manages a store while it is open.</span></span> <span data-ttu-id="c141a-131">Une application avec un magasin ouvert peut être avertie lorsque l’état persistant de cette banque a été modifié par un autre processus.</span><span class="sxs-lookup"><span data-stu-id="c141a-131">An application with an open store can be notified when the persisted state of that store has changed by some other process.</span></span> <span data-ttu-id="c141a-132">Cela peut se produire si de nouveaux certificats ont été copiés dans le magasin de l’ordinateur local à partir d’un ordinateur de contrôle de domaine.</span><span class="sxs-lookup"><span data-stu-id="c141a-132">This could happen if new certificates were copied to the local computer store from a domain control computer.</span></span>

<span data-ttu-id="c141a-133">Lorsque des modifications sont découvertes, le magasin mis en cache peut resynchroniser son magasin mis en cache pour qu’il corresponde à l’état persistant du magasin.</span><span class="sxs-lookup"><span data-stu-id="c141a-133">When changes are discovered, the cached store can re-synchronize its cached store to match the persisted state of the store.</span></span> <span data-ttu-id="c141a-134">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) prend également en charge un processus qui copie les modifications apportées aux magasins mis en cache dans un stockage permanent lorsque ces modifications dans le magasin mis en cache ne sont pas enregistrées automatiquement.</span><span class="sxs-lookup"><span data-stu-id="c141a-134">[**CertControlStore**](/windows/desktop/api/Wincrypt/nf-wincrypt-certcontrolstore) also supports a process that copies cached store changes to permanent storage when these changes in the cached store are not automatically saved.</span></span>

<span data-ttu-id="c141a-135">Les contextes de certificat de type magasin de certificats peuvent avoir des propriétés étendues.</span><span class="sxs-lookup"><span data-stu-id="c141a-135">Certificate store-like certificate contexts can have extended properties.</span></span> <span data-ttu-id="c141a-136">[**CertSetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsetstoreproperty) ajoute des propriétés étendues à un magasin de certificats.</span><span class="sxs-lookup"><span data-stu-id="c141a-136">[**CertSetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certsetstoreproperty) adds extended properties to a certificate store.</span></span> <span data-ttu-id="c141a-137">[**CertGetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certgetstoreproperty) récupère toutes les propriétés définies sur un magasin de certificats.</span><span class="sxs-lookup"><span data-stu-id="c141a-137">[**CertGetStoreProperty**](/windows/desktop/api/Wincrypt/nf-wincrypt-certgetstoreproperty) retrieves any properties set on a certificate store.</span></span> <span data-ttu-id="c141a-138">Actuellement, la seule propriété de magasin de certificats prédéfinie est le nom localisé d’un magasin.</span><span class="sxs-lookup"><span data-stu-id="c141a-138">Currently, the only predefined certificate store property is a store's localized name.</span></span>

 

 
