---
description: La syntaxe de message de chiffrement peut être utilisée pour encoder des messages enveloppés.
ms.assetid: f35aacda-6827-42e9-b7ac-58dc007fc697
title: Encodage de données enveloppées
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 53dc20fc7483ba1ef364d8b59824d26bd14d458d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104563106"
---
# <a name="encoding-enveloped-data"></a><span data-ttu-id="9ac36-103">Encodage de données enveloppées</span><span class="sxs-lookup"><span data-stu-id="9ac36-103">Encoding Enveloped Data</span></span>

<span data-ttu-id="9ac36-104">Les données enveloppées se composent d’un contenu chiffré de tout type et de clés de session de chiffrement de contenu chiffrées pour un ou plusieurs destinataires.</span><span class="sxs-lookup"><span data-stu-id="9ac36-104">Enveloped data consists of encrypted content of any type and encrypted content-encryption session keys for one or more recipients.</span></span> <span data-ttu-id="9ac36-105">Les messages enveloppés conservent le contenu du message secret et autorisent uniquement les personnes ou les entités spécifiées à récupérer le contenu.</span><span class="sxs-lookup"><span data-stu-id="9ac36-105">Enveloped messages keep the contents of the message secret and allow only specified persons or entities to retrieve the contents.</span></span>

<span data-ttu-id="9ac36-106">La syntaxe de message de chiffrement (CMS) peut être utilisée pour encoder des messages enveloppés.</span><span class="sxs-lookup"><span data-stu-id="9ac36-106">Cryptographic message syntax (CMS) can be used to encode enveloped messages.</span></span> <span data-ttu-id="9ac36-107">CMS prend en charge trois techniques de gestion de clés : le transport de clé, l’accord de clé et les clés de chiffrement de clé symétrique (KEK) précédemment distribuées.</span><span class="sxs-lookup"><span data-stu-id="9ac36-107">CMS supports three key management techniques: key transport, key agreement, and previously distributed symmetric key-encryption keys (KEK).</span></span> <span data-ttu-id="9ac36-108">Les KEK symétriques précédemment distribués sont également appelées distribution de clé de liste de diffusion.</span><span class="sxs-lookup"><span data-stu-id="9ac36-108">Previously distributed symmetric KEK are also known as mailing list key distribution.</span></span>

<span data-ttu-id="9ac36-109">Dans chacune de ces trois techniques, une clé de session unique est générée pour chiffrer le message enveloppé.</span><span class="sxs-lookup"><span data-stu-id="9ac36-109">In each of these three techniques, a single session key is generated to encrypt the enveloped message.</span></span> <span data-ttu-id="9ac36-110">Les problèmes de gestion de clés concernent la façon dont la clé de session est chiffrée par l’expéditeur et déchiffrée par un destinataire.</span><span class="sxs-lookup"><span data-stu-id="9ac36-110">Key management issues deal with the way that session key is encrypted by the sender and decrypted by a receiver.</span></span> <span data-ttu-id="9ac36-111">Un seul message chiffré peut être distribué à de nombreux destinataires à l’aide d’une combinaison des techniques de gestion de clés.</span><span class="sxs-lookup"><span data-stu-id="9ac36-111">A single encrypted message can be distributed to many recipients using a mixture of the key management techniques.</span></span>

<span data-ttu-id="9ac36-112">La gestion des clés de transport de clé utilise la clé publique du récepteur prévu pour chiffrer la clé de session.</span><span class="sxs-lookup"><span data-stu-id="9ac36-112">Key transport key management uses an intended receiver's public key to encrypt the session key.</span></span> <span data-ttu-id="9ac36-113">Le récepteur déchiffre la clé de session à l’aide de la clé privée associée à la clé publique qui a été utilisée pour chiffrer.</span><span class="sxs-lookup"><span data-stu-id="9ac36-113">The receiver decrypts the session key using the private key associated with the public key that was used to encrypt.</span></span> <span data-ttu-id="9ac36-114">Le récepteur utilise ensuite la clé de session déchiffrée pour déchiffrer les données enveloppées.</span><span class="sxs-lookup"><span data-stu-id="9ac36-114">The receiver then uses the decrypted session key to decrypt the enveloped data.</span></span> <span data-ttu-id="9ac36-115">Lorsque le transport de clé est utilisé, le destinataire n’a pas confirmé les informations sur l’identité de l’expéditeur.</span><span class="sxs-lookup"><span data-stu-id="9ac36-115">When key transport is used, the receiver has not confirmed information on the identity of the sender.</span></span>

<span data-ttu-id="9ac36-116">Dans la gestion d’un accord de clé, une clé privée temporaire Diffie-Hellman éphémère est générée et utilisée pour chiffrer la clé de session.</span><span class="sxs-lookup"><span data-stu-id="9ac36-116">In key agreement management, a temporary, ephemeral Diffie-Hellman private key is generated and used to encrypt the session key.</span></span> <span data-ttu-id="9ac36-117">La clé publique correspondant à la clé privée éphémère est incluse dans le cadre des informations de destinataire du message.</span><span class="sxs-lookup"><span data-stu-id="9ac36-117">The public key corresponding to the ephemeral private key is included as part of the message's recipient information.</span></span> <span data-ttu-id="9ac36-118">Le destinataire déchiffre la clé de session à l’aide de la clé éphémère reçue et utilise cette clé de session déchiffrée pour déchiffrer le message enveloppé.</span><span class="sxs-lookup"><span data-stu-id="9ac36-118">The recipient decrypts the session key using the received ephemeral key and uses this decrypted session key to decrypt the enveloped message.</span></span> <span data-ttu-id="9ac36-119">À l’aide de l’accord de clé éphémère conjointement avec la clé privée du destinataire, le destinataire du message a confirmé des informations sur l’identité de l’expéditeur.</span><span class="sxs-lookup"><span data-stu-id="9ac36-119">Using ephemeral key agreement in conjunction with the receiver's private key, the message receiver does have confirmed information on the identity of the sender.</span></span>

<span data-ttu-id="9ac36-120">Pour la gestion des clés à l’aide de [*clés symétriques*](../secgloss/s-gly.md)précédemment distribuées, chaque message inclut la clé de chiffrement de contenu qui a été chiffrée avec une clé de chiffrement de clé précédemment distribuée.</span><span class="sxs-lookup"><span data-stu-id="9ac36-120">For key management using previously distributed [*symmetric keys*](../secgloss/s-gly.md), each message includes the content-encryption key that has been encrypted with a previously distributed key-encryption key.</span></span> <span data-ttu-id="9ac36-121">Les destinataires utilisent la clé de chiffrement de clé précédemment distribuée pour déchiffrer la clé de chiffrement de contenu, puis utiliser la clé de chiffrement de contenu déchiffrée pour déchiffrer le message enveloppé.</span><span class="sxs-lookup"><span data-stu-id="9ac36-121">Receivers use the previously distributed key-encryption key to decrypt the content encryption key, then use the decrypted content-encryption key to decrypt the enveloped message.</span></span>

<span data-ttu-id="9ac36-122">L’illustration suivante montre une séquence CMS d’événements type pour l’encodage des données enveloppées.</span><span class="sxs-lookup"><span data-stu-id="9ac36-122">A typical CMS sequence of events for encoding enveloped data, is shown in the following illustration.</span></span>

![encodage de données enveloppées](images/envelmsg.png)

-   <span data-ttu-id="9ac36-124">Un pointeur vers le message de [*texte en clair*](../secgloss/p-gly.md) est récupéré.</span><span class="sxs-lookup"><span data-stu-id="9ac36-124">A pointer to the [*plaintext*](../secgloss/p-gly.md) message is retrieved.</span></span>
-   <span data-ttu-id="9ac36-125">Une clé symétrique ([*session*](../secgloss/s-gly.md)) est générée.</span><span class="sxs-lookup"><span data-stu-id="9ac36-125">A symmetric ([*session*](../secgloss/s-gly.md)) key is generated.</span></span>
-   <span data-ttu-id="9ac36-126">La [*clé symétrique*](../secgloss/s-gly.md) et l’algorithme de chiffrement spécifié sont utilisés pour chiffrer les données du message.</span><span class="sxs-lookup"><span data-stu-id="9ac36-126">The [*symmetric key*](../secgloss/s-gly.md) and specified encryption algorithm are used to encrypt the message data.</span></span>
-   <span data-ttu-id="9ac36-127">Un [*magasin de certificats*](../secgloss/c-gly.md) est ouvert.</span><span class="sxs-lookup"><span data-stu-id="9ac36-127">A [*certificate store*](../secgloss/c-gly.md) is opened.</span></span>
-   <span data-ttu-id="9ac36-128">Le certificat du destinataire est récupéré à partir du magasin.</span><span class="sxs-lookup"><span data-stu-id="9ac36-128">The recipient's certificate is retrieved from the store.</span></span>
-   <span data-ttu-id="9ac36-129">La [*clé publique*](../secgloss/p-gly.md) est récupérée à partir du certificat du destinataire.</span><span class="sxs-lookup"><span data-stu-id="9ac36-129">The [*public key*](../secgloss/p-gly.md) is retrieved from the recipient's certificate.</span></span>
-   <span data-ttu-id="9ac36-130">À l’aide de la clé publique du destinataire, la clé symétrique est chiffrée.</span><span class="sxs-lookup"><span data-stu-id="9ac36-130">Using the recipient's public key, the symmetric key is encrypted.</span></span>
-   <span data-ttu-id="9ac36-131">À partir du certificat du destinataire, l’ID du destinataire est récupéré.</span><span class="sxs-lookup"><span data-stu-id="9ac36-131">From the recipient's certificate, the recipient's ID is retrieved.</span></span>
-   <span data-ttu-id="9ac36-132">Les informations suivantes sont incluses dans le message enveloppé numériquement : l’algorithme de chiffrement des données, les données chiffrées, la clé symétrique chiffrée et la structure d’informations du destinataire.</span><span class="sxs-lookup"><span data-stu-id="9ac36-132">The following information is included in the digitally enveloped message: the data encryption algorithm, the encrypted data, the encrypted symmetric key, and the recipient information structure.</span></span>

<span data-ttu-id="9ac36-133">Pour utiliser les fonctions de message de bas niveau pour accomplir les tâches courantes qui viennent d’être listées, utilisez la procédure suivante.</span><span class="sxs-lookup"><span data-stu-id="9ac36-133">To use low-level message functions to accomplish the typical tasks just listed, use the following procedure.</span></span>

<span data-ttu-id="9ac36-134">**Pour encoder un message enveloppé**</span><span class="sxs-lookup"><span data-stu-id="9ac36-134">**To encode an enveloped message**</span></span>

1.  <span data-ttu-id="9ac36-135">Créez ou récupérez le contenu.</span><span class="sxs-lookup"><span data-stu-id="9ac36-135">Create or retrieve the content.</span></span>
2.  <span data-ttu-id="9ac36-136">Obtenir un fournisseur de services de chiffrement.</span><span class="sxs-lookup"><span data-stu-id="9ac36-136">Get a cryptographic provider.</span></span>
3.  <span data-ttu-id="9ac36-137">Obtenir un certificat de destinataire.</span><span class="sxs-lookup"><span data-stu-id="9ac36-137">Get a recipient certificate.</span></span>
4.  <span data-ttu-id="9ac36-138">Initialisez la structure d' [**\_ \_ \_ informations d’encodage enveloppée CMSG**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="9ac36-138">Initialize the [**CMSG\_ENVELOPED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) structure.</span></span>
5.  <span data-ttu-id="9ac36-139">Appelez [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) pour connaître la taille de l’objet blob de message encodé.</span><span class="sxs-lookup"><span data-stu-id="9ac36-139">Call [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) to get the size of the encoded message BLOB.</span></span> <span data-ttu-id="9ac36-140">Allouez de la mémoire pour celui-ci.</span><span class="sxs-lookup"><span data-stu-id="9ac36-140">Allocate memory for it.</span></span>
6.  <span data-ttu-id="9ac36-141">Appelez [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), en passant CMSG \_ envelopped pour *dwMsgType* et un pointeur vers [**CMSG \_ informations de \_ codage \_ enveloppé**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) pour *pvMsgEncodeInfo*.</span><span class="sxs-lookup"><span data-stu-id="9ac36-141">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing in CMSG\_ENVELOPED for *dwMsgType* and a pointer to [**CMSG\_ENVELOPED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) for *pvMsgEncodeInfo*.</span></span> <span data-ttu-id="9ac36-142">À la suite de cet appel, vous obtiendrez un handle pour le message ouvert.</span><span class="sxs-lookup"><span data-stu-id="9ac36-142">As a result of this call, you will get a handle to the opened message.</span></span>
7.  <span data-ttu-id="9ac36-143">Appelez [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), en passant le handle récupéré à l’étape 6 et un pointeur vers les données qui doivent être chiffrées, enveloppées et encodées.</span><span class="sxs-lookup"><span data-stu-id="9ac36-143">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passing in the handle retrieved in step 6 and a pointer to the data that is to be encrypted, enveloped, and encoded.</span></span> <span data-ttu-id="9ac36-144">Cette fonction peut être appelée autant de fois que nécessaire pour terminer le processus d’encodage.</span><span class="sxs-lookup"><span data-stu-id="9ac36-144">This function can be called as many times as necessary to complete the encoding process.</span></span>
8.  <span data-ttu-id="9ac36-145">Appelez [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), en passant le handle récupéré à l’étape 6 et les types de paramètres appropriés pour accéder aux données encodées souhaitées.</span><span class="sxs-lookup"><span data-stu-id="9ac36-145">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 6 and the appropriate parameter types to access the desired, encoded data.</span></span> <span data-ttu-id="9ac36-146">Par exemple, transmettez \_ le paramètre de contenu CMSG \_ pour obtenir un pointeur vers l’intégralité du \# message PKCS 7.</span><span class="sxs-lookup"><span data-stu-id="9ac36-146">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the entire PKCS \#7 message.</span></span>

    <span data-ttu-id="9ac36-147">Si le résultat de cet encodage doit être utilisé en tant que [*données internes*](../secgloss/i-gly.md) pour un autre message encodé, tel qu’un message enveloppé, le \_ \_ paramètre param CMSG Bare Content \_ doit être passé.</span><span class="sxs-lookup"><span data-stu-id="9ac36-147">If the result of this encoding is to be used as the [*inner data*](../secgloss/i-gly.md) for another encoded message, such as an enveloped message, the CMSG\_BARE\_CONTENT\_PARAM parameter must be passed.</span></span> <span data-ttu-id="9ac36-148">Pour obtenir un exemple, consultez [autre code pour l’encodage d’un message enveloppé](alternate-code-for-encoding-an-enveloped-message.md).</span><span class="sxs-lookup"><span data-stu-id="9ac36-148">For an example, see [Alternate Code for Encoding an Enveloped Message](alternate-code-for-encoding-an-enveloped-message.md).</span></span>

9.  <span data-ttu-id="9ac36-149">Fermez le message en appelant [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span><span class="sxs-lookup"><span data-stu-id="9ac36-149">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="9ac36-150">Le résultat de cette procédure est un message encodé qui contient les données chiffrées, la [*clé symétrique*](../secgloss/s-gly.md) qui est chiffrée avec les clés publiques du destinataire et les structures de données d’informations de destinataire.</span><span class="sxs-lookup"><span data-stu-id="9ac36-150">The result of this procedure is an encoded message that contains the encrypted data, the [*symmetric key*](../secgloss/s-gly.md) that is encrypted with the recipient's public keys, and the recipient information data structures.</span></span> <span data-ttu-id="9ac36-151">La combinaison du contenu chiffré et d’une clé symétrique chiffrée pour un destinataire est une [*enveloppe numérique*](../secgloss/d-gly.md) pour ce destinataire.</span><span class="sxs-lookup"><span data-stu-id="9ac36-151">The combination of encrypted content and an encrypted symmetric key for a recipient is a [*digital envelope*](../secgloss/d-gly.md) for that recipient.</span></span> <span data-ttu-id="9ac36-152">N’importe quel type de contenu peut être enveloppé pour plusieurs destinataires.</span><span class="sxs-lookup"><span data-stu-id="9ac36-152">Any type of content can be enveloped for multiple recipients.</span></span>

## <a name="related-topics"></a><span data-ttu-id="9ac36-153">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="9ac36-153">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="9ac36-154">Exemple de programme C : encodage d’un message signé et enveloppé</span><span class="sxs-lookup"><span data-stu-id="9ac36-154">Example C Program: Encoding an Enveloped, Signed Message</span></span>](example-c-program-encoding-an-enveloped-signed-message.md)
</dt> </dl>

 

 
