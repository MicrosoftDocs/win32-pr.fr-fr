---
title: Licences et IClassFactory2
description: Licences et IClassFactory2
ms.assetid: 2bead555-8c62-4f48-a4c6-6f0942ec75f8
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9376d5187588ba14da434161309409bf1d189a8f
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/21/2020
ms.locfileid: "104382971"
---
# <a name="licensing-and-iclassfactory2"></a><span data-ttu-id="a819b-103">Licences et IClassFactory2</span><span class="sxs-lookup"><span data-stu-id="a819b-103">Licensing and IClassFactory2</span></span>

<span data-ttu-id="a819b-104">L’interface [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory) sur un objet de classe fournit le mécanisme de création d’objet de base de com.</span><span class="sxs-lookup"><span data-stu-id="a819b-104">The [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory) interface on a class object provides the basic object creation mechanism of COM.</span></span> <span data-ttu-id="a819b-105">À l’aide d' **IClassFactory**, un serveur peut contrôler la création d’objets sur une base de machines.</span><span class="sxs-lookup"><span data-stu-id="a819b-105">Using **IClassFactory**, a server can control object creation on a machine basis.</span></span> <span data-ttu-id="a819b-106">L’implémentation de la méthode [**IClassFactory :: CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance) peut autoriser ou interdire la création d’objets en fonction de l’existence d’une licence d’ordinateur.</span><span class="sxs-lookup"><span data-stu-id="a819b-106">The implementation of the [**IClassFactory::CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance) method can allow or disallow object creation based on the existence of a machine license.</span></span> <span data-ttu-id="a819b-107">Une licence d’ordinateur est une information distincte de l’application qui existe sur un ordinateur pour indiquer que le logiciel a été installé à partir d’une source valide, telle que les disques d’installation du fournisseur.</span><span class="sxs-lookup"><span data-stu-id="a819b-107">A machine license is a piece of information separate from the application that exists on a machine to indicate that the software was installed from a valid source, such as the vendor's installation disks.</span></span> <span data-ttu-id="a819b-108">Si la licence de l’ordinateur n’existe pas, le serveur peut autoriser la création de l’objet.</span><span class="sxs-lookup"><span data-stu-id="a819b-108">If the machine license does not exist, the server can disallow object creation.</span></span> <span data-ttu-id="a819b-109">La licence d’ordinateur empêche le piratage dans les cas où un utilisateur tente de copier le logiciel d’un ordinateur vers un autre, car les informations de licence ne sont pas copiées avec le logiciel et l’ordinateur qui reçoit la copie n’est pas concédé sous licence.</span><span class="sxs-lookup"><span data-stu-id="a819b-109">Machine licensing prevents piracy in cases where a user attempts to copy the software from one machine to another, because the license information is not copied with the software and the machine that receives the copy is not licensed.</span></span>

<span data-ttu-id="a819b-110">Toutefois, dans un logiciel de composants, les fournisseurs ont besoin d’un niveau de contrôle plus fin sur les licences.</span><span class="sxs-lookup"><span data-stu-id="a819b-110">However, in a component software industry, vendors need a finer level of control over licensing.</span></span> <span data-ttu-id="a819b-111">En plus du contrôle de licence d’ordinateur, un fournisseur doit autoriser certains clients à créer un objet composant tout en refusant la même fonctionnalité aux autres clients.</span><span class="sxs-lookup"><span data-stu-id="a819b-111">In addition to machine license control, a vendor needs to allow some clients to create a component object while denying other clients the same capability.</span></span> <span data-ttu-id="a819b-112">Cela nécessite que l’application cliente obtienne une clé de licence du composant pendant que l’application cliente est toujours en cours de développement.</span><span class="sxs-lookup"><span data-stu-id="a819b-112">This requires that the client application obtain a license key from the component while the client application is still under development.</span></span> <span data-ttu-id="a819b-113">L’application cliente utilise la clé de licence au moment de l’exécution pour créer des objets sur un ordinateur sans licence.</span><span class="sxs-lookup"><span data-stu-id="a819b-113">The client application uses the license key at run time to create objects on an unlicensed machine.</span></span>

<span data-ttu-id="a819b-114">Par exemple, si un fournisseur fournit une bibliothèque de contrôles aux développeurs, le développeur qui achète la bibliothèque aura une licence d’ordinateur complète, ce qui permettra de créer les objets sur l’ordinateur de développement.</span><span class="sxs-lookup"><span data-stu-id="a819b-114">For example, if a vendor provides a library of controls to developers, the developer who purchases the library will have a full machine license, allowing the objects to be created on the development machine.</span></span> <span data-ttu-id="a819b-115">Le développeur peut ensuite créer une application cliente sur l’ordinateur sous licence, en incorporant un ou plusieurs contrôles.</span><span class="sxs-lookup"><span data-stu-id="a819b-115">The developer can then build a client application on the licensed machine incorporating one or more of the controls.</span></span> <span data-ttu-id="a819b-116">Lorsque l’application cliente résultante est exécutée sur un autre ordinateur, les contrôles utilisés dans l’application cliente doivent être créés sur l’autre ordinateur, même si cet ordinateur ne possède pas de licence d’ordinateur pour les contrôles du fournisseur d’origine.</span><span class="sxs-lookup"><span data-stu-id="a819b-116">When the resulting client application is run on another machine, the controls used in the client application must be created on the other machine even if that machine does not possess a machine license for the controls from the original vendor.</span></span>

<span data-ttu-id="a819b-117">L’interface [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) fournit ce niveau de contrôle.</span><span class="sxs-lookup"><span data-stu-id="a819b-117">The [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) interface provides this level of control.</span></span> <span data-ttu-id="a819b-118">Pour autoriser la gestion des licences basées sur les clés pour un composant donné, vous devez implémenter **IClassFactory2** sur l’objet de fabrique de classes pour ce composant.</span><span class="sxs-lookup"><span data-stu-id="a819b-118">To allow key-based licensing for any given component, you implement **IClassFactory2** on the class factory object for that component.</span></span> <span data-ttu-id="a819b-119">**IClassFactory2** est dérivée de [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory), donc en implémentant **IClassFactory2**, l’objet de fabrique de classes répond aux exigences de base de com.</span><span class="sxs-lookup"><span data-stu-id="a819b-119">**IClassFactory2** is derived from [**IClassFactory**](/windows/win32/api/unknwn/nn-unknwn-iclassfactory), so by implementing **IClassFactory2**, the class factory object fulfills the basic COM requirements.</span></span>

<span data-ttu-id="a819b-120">Pour incorporer un composant sous licence dans votre application cliente, utilisez les méthodes suivantes dans [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2):</span><span class="sxs-lookup"><span data-stu-id="a819b-120">To incorporate a licensed component into your client application, use the following methods in [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2):</span></span>

-   <span data-ttu-id="a819b-121">La méthode [**GetLicInfo**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) remplit une structure [**LICINFO**](/windows/win32/api/ocidl/ns-ocidl-licinfo) avec des informations décrivant le comportement de la licence de la fabrique de classes.</span><span class="sxs-lookup"><span data-stu-id="a819b-121">The [**GetLicInfo**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) method fills a [**LICINFO**](/windows/win32/api/ocidl/ns-ocidl-licinfo) structure with information describing the licensing behavior of the class factory.</span></span> <span data-ttu-id="a819b-122">Par exemple, la fabrique de classe peut fournir des clés de licence pour la licence au moment de l’exécution si le membre **fRunTimeKeyAvail** a la **valeur true**.</span><span class="sxs-lookup"><span data-stu-id="a819b-122">For example, the class factory can provide license keys for run-time licensing if the **fRunTimeKeyAvail** member is **TRUE**.</span></span>
-   <span data-ttu-id="a819b-123">La méthode [**RequestLicKey**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) fournit une clé de licence pour le composant.</span><span class="sxs-lookup"><span data-stu-id="a819b-123">The [**RequestLicKey**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) method provides a license key for the component.</span></span> <span data-ttu-id="a819b-124">Une licence d’ordinateur doit être disponible lorsque le client appelle cette méthode.</span><span class="sxs-lookup"><span data-stu-id="a819b-124">A machine license must be available when the client calls this method.</span></span>
-   <span data-ttu-id="a819b-125">La méthode [**CreateInstanceLic**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) crée une instance du composant sous licence si le paramètre de clé de licence (BSTRÂ bstrKey) est valide.</span><span class="sxs-lookup"><span data-stu-id="a819b-125">The [**CreateInstanceLic**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) method creates an instance of the licensed component if the license key parameter (BSTRÂ bstrKey) is valid.</span></span>

> [!Note]  
> <span data-ttu-id="a819b-126">Dans ses informations de type, un composant utilise l’attribut sous licence pour marquer la coclasse qui prend en charge la gestion des licences par le biais de [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2).</span><span class="sxs-lookup"><span data-stu-id="a819b-126">In its type information, a component uses the attribute licensed to mark the coclass that supports licensing through [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2).</span></span>

 

<span data-ttu-id="a819b-127">Tout d’abord, vous avez besoin d’un outil de développement distinct qui est également un client du composant sous licence.</span><span class="sxs-lookup"><span data-stu-id="a819b-127">First, you need a separate development tool that is also a client of the licensed component.</span></span> <span data-ttu-id="a819b-128">L’objectif de cet outil est d’obtenir la clé de licence d’exécution et de l’enregistrer dans votre application cliente.</span><span class="sxs-lookup"><span data-stu-id="a819b-128">The purpose of this tool is to obtain the run-time license key and save it in your client application.</span></span> <span data-ttu-id="a819b-129">Cet outil s’exécute uniquement sur un ordinateur qui possède une licence d’ordinateur pour le composant.</span><span class="sxs-lookup"><span data-stu-id="a819b-129">This tool runs only on a machine that possesses a machine license for the component.</span></span> <span data-ttu-id="a819b-130">L’outil appelle les méthodes [**GetLicInfo**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) et [**RequestLicKey**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) pour obtenir la clé de licence d’exécution, puis enregistre la clé de licence dans votre application cliente.</span><span class="sxs-lookup"><span data-stu-id="a819b-130">The tool calls the [**GetLicInfo**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-getlicinfo) and [**RequestLicKey**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-requestlickey) methods to obtain the run-time license key and then saves the license key in your client application.</span></span> <span data-ttu-id="a819b-131">Par exemple, l’outil de développement peut créer un fichier d’en-tête (. h) contenant la clé de licence BSTR, puis inclure ce fichier. h dans votre application cliente.</span><span class="sxs-lookup"><span data-stu-id="a819b-131">For example, the development tool could create a header (.h) file containing the BSTR license key, and then you would include that .h file in your client application.</span></span>

<span data-ttu-id="a819b-132">Pour instancier le composant dans votre application cliente, essayez d’abord d’instancier l’objet directement avec [**IClassFactory :: CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance).</span><span class="sxs-lookup"><span data-stu-id="a819b-132">To instantiate the component within your client application, first try to instantiate the object directly with [**IClassFactory::CreateInstance**](/windows/desktop/api/Unknwn/nf-unknwn-iclassfactory-createinstance).</span></span> <span data-ttu-id="a819b-133">Si **CreateInstance** parvient à fonctionner, le deuxième ordinateur est concédé sous licence pour le composant et les objets peuvent être créés à l’adresse.</span><span class="sxs-lookup"><span data-stu-id="a819b-133">If **CreateInstance** succeeds, the second machine is licensed for the component and objects can be created at will.</span></span> <span data-ttu-id="a819b-134">Si **CreateInstance** échoue avec la classe de code de retour \_ E \_ NOTLICENSED, la seule façon de créer l’objet consiste à passer la clé d’exécution à la méthode [**CreateInstanceLic**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) .</span><span class="sxs-lookup"><span data-stu-id="a819b-134">If **CreateInstance** fails with the return code CLASS\_E\_NOTLICENSED, the only way to create the object is to pass the run-time key to the [**CreateInstanceLic**](/windows/desktop/api/OCIdl/nf-ocidl-iclassfactory2-createinstancelic) method.</span></span> <span data-ttu-id="a819b-135">**CreateInstanceLic** vérifie la clé et crée l’objet si la clé est valide.</span><span class="sxs-lookup"><span data-stu-id="a819b-135">**CreateInstanceLic** verifies the key and creates the object if the key is valid.</span></span>

<span data-ttu-id="a819b-136">De cette façon, une application générée avec des composants (tels que des contrôles) peut s’exécuter sur un ordinateur qui n’a pas d’autre licence ; seule l’application cliente contenant la licence d’exécution est autorisée à créer les objets de composant en question.</span><span class="sxs-lookup"><span data-stu-id="a819b-136">In this way, an application built with components (such as controls) can run on a machine that has no other license—only the client application containing the run-time license is allowed to create the component objects in question.</span></span>

<span data-ttu-id="a819b-137">L’interface [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) prend en charge la flexibilité des modèles de licence.</span><span class="sxs-lookup"><span data-stu-id="a819b-137">The [**IClassFactory2**](/windows/desktop/api/OCIdl/nn-ocidl-iclassfactory2) interface supports flexibility in licensing schemes.</span></span> <span data-ttu-id="a819b-138">Par exemple, l’implémenteur de serveur peut chiffrer les clés de licence dans le composant pour renforcer la sécurité.</span><span class="sxs-lookup"><span data-stu-id="a819b-138">For example, the server implementor can encrypt license keys in the component for added security.</span></span> <span data-ttu-id="a819b-139">Les implémenteurs de serveur peuvent également activer ou désactiver des niveaux de fonctionnalités dans leurs objets en fournissant différentes clés de licence pour différentes fonctions.</span><span class="sxs-lookup"><span data-stu-id="a819b-139">Server implementers can also enable or disable levels of functionality in their objects by providing different license keys for different functions.</span></span> <span data-ttu-id="a819b-140">Par exemple, une clé peut autoriser un niveau de base de fonctionnalité, tandis qu’une autre offre des fonctionnalités de base et avancées, et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="a819b-140">For example, one key might allow a base level of functionality while another allows basic and advanced functionality, and so on.</span></span>

## <a name="related-topics"></a><span data-ttu-id="a819b-141">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="a819b-141">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="a819b-142">Responsabilités du serveur COM</span><span class="sxs-lookup"><span data-stu-id="a819b-142">COM Server Responsibilities</span></span>](com-server-responsibilities.md)
</dt> </dl>

 

 