---
title: Processus, threads et Apartments
description: Un processus est une collection d’espaces de mémoire virtuelle, de code, de données et de ressources système.
ms.assetid: cb62412a-d079-40f9-89dc-cce0bf3889af
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d598fc9d7dd39ab070b58aa7ba45a6e2fcae90db
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/21/2020
ms.locfileid: "104382931"
---
# <a name="processes-threads-and-apartments"></a><span data-ttu-id="a1ad2-103">Processus, threads et Apartments</span><span class="sxs-lookup"><span data-stu-id="a1ad2-103">Processes, Threads, and Apartments</span></span>

<span data-ttu-id="a1ad2-104">Un *processus* est une collection d’espaces de mémoire virtuelle, de code, de données et de ressources système.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-104">A *process* is a collection of virtual memory space, code, data, and system resources.</span></span> <span data-ttu-id="a1ad2-105">Un *thread* est du code qui doit être exécuté en série au sein d’un processus.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-105">A *thread* is code that is to be serially executed within a process.</span></span> <span data-ttu-id="a1ad2-106">Un processeur exécute les threads, pas les processus, de sorte que chaque application a au moins un processus, et un processus a toujours au moins un thread d’exécution, appelé thread principal.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-106">A processor executes threads, not processes, so each application has at least one process, and a process always has at least one thread of execution, known as the primary thread.</span></span> <span data-ttu-id="a1ad2-107">Un processus peut avoir plusieurs threads en plus du thread principal.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-107">A process can have multiple threads in addition to the primary thread.</span></span>

<span data-ttu-id="a1ad2-108">Les processus communiquent entre eux par le biais de messages, en utilisant la technologie d’appel de procédure distante (RPC) de Microsoft pour transmettre les informations les unes aux autres.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-108">Processes communicate with one another through messages, using Microsoft's Remote Procedure Call (RPC) technology to pass information to one another.</span></span> <span data-ttu-id="a1ad2-109">Il n’existe aucune différence de l’appelant entre un appel provenant d’un processus sur un ordinateur distant et un appel provenant d’un autre processus sur le même ordinateur.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-109">There is no difference to the caller between a call coming from a process on a remote machine and a call coming from another process on the same machine.</span></span>

<span data-ttu-id="a1ad2-110">Quand un thread commence à s’exécuter, il continue jusqu’à ce qu’il soit supprimé ou jusqu’à ce qu’il soit interrompu par un thread avec une priorité plus élevée (par une action de l’utilisateur ou le planificateur de threads du noyau).</span><span class="sxs-lookup"><span data-stu-id="a1ad2-110">When a thread begins to execute, it continues until it is killed or until it is interrupted by a thread with higher priority (by a user action or the kernel's thread scheduler).</span></span> <span data-ttu-id="a1ad2-111">Chaque thread peut exécuter des sections de code distinctes, ou plusieurs threads peuvent exécuter la même section de code.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-111">Each thread can run separate sections of code, or multiple threads can execute the same section of code.</span></span> <span data-ttu-id="a1ad2-112">Les threads qui exécutent le même bloc de code maintiennent des piles distinctes.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-112">Threads executing the same block of code maintain separate stacks.</span></span> <span data-ttu-id="a1ad2-113">Chaque thread dans un processus partage les ressources et les variables globales de ce processus.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-113">Each thread in a process shares that process's global variables and resources.</span></span>

<span data-ttu-id="a1ad2-114">Le planificateur de threads détermine quand et à quelle fréquence exécuter un thread, en fonction d’une combinaison de l’attribut de classe de priorité du processus et de la priorité de base du thread.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-114">The thread scheduler determines when and how often to execute a thread, according to a combination of the process's priority class attribute and the thread's base priority.</span></span> <span data-ttu-id="a1ad2-115">Vous définissez l’attribut de classe de priorité d’un processus en appelant la fonction [**SetPriorityClass**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setpriorityclass) , et vous définissez la priorité de base d’un thread à l’aide d’un appel à [**SetThreadPriority**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setthreadpriority).</span><span class="sxs-lookup"><span data-stu-id="a1ad2-115">You set a process's priority class attribute by calling the [**SetPriorityClass**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setpriorityclass) function , and you set a thread's base priority with a call to [**SetThreadPriority**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setthreadpriority).</span></span>

<span data-ttu-id="a1ad2-116">Les applications multithread doivent éviter deux problèmes de thread : les *interblocages* et les *concurrences*.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-116">Multithreaded applications must avoid two threading problems: *deadlocks* and *races*.</span></span> <span data-ttu-id="a1ad2-117">Un blocage se produit lorsque chaque thread attend que l’autre effectue une opération.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-117">A deadlock occurs when each thread is waiting for the other to do something.</span></span> <span data-ttu-id="a1ad2-118">Le contrôle d’appel COM permet d’éviter les interblocages dans les appels entre les objets.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-118">The COM call control helps prevent deadlocks in calls between objects.</span></span> <span data-ttu-id="a1ad2-119">Une condition de concurrence se produit lorsqu’un thread se termine avant un autre dont il dépend, ce qui provoque l’utilisation d’une valeur non initialisée par la première, car cette dernière n’a pas encore fourni de valeur valide.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-119">A race condition occurs when one thread finishes before another on which it depends, causing the former to use an uninitialized value because the latter has not yet supplied a valid one.</span></span> <span data-ttu-id="a1ad2-120">COM fournit certaines fonctions spécifiquement conçues pour éviter les conditions de concurrence dans les serveurs hors processus.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-120">COM supplies some functions specifically designed to help avoid race conditions in out-of-process servers.</span></span> <span data-ttu-id="a1ad2-121">(Voir [assistances pour l’implémentation de serveur hors processus](out-of-process-server-implementation-helpers.md).)</span><span class="sxs-lookup"><span data-stu-id="a1ad2-121">(See [Out-of-Process Server Implementation Helpers](out-of-process-server-implementation-helpers.md).)</span></span>

## <a name="the-apartment-and-the-com-threading-architecture"></a><span data-ttu-id="a1ad2-122">Architecture de cloisonnement et de thread COM</span><span class="sxs-lookup"><span data-stu-id="a1ad2-122">The Apartment and the COM Threading Architecture</span></span>

<span data-ttu-id="a1ad2-123">Bien que COM prenne en charge le modèle à un seul thread par processus avant l’introduction de plusieurs threads d’exécution, vous pouvez écrire du code pour tirer parti de plusieurs threads, ce qui permet d’obtenir des applications plus efficaces, en autorisant l’exécution d’un thread pendant qu’un autre thread attend la fin d’une opération de longue durée.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-123">While COM supports the single-thread-per-process model prevalent before the introduction of multiple threads of execution, you can write code to take advantage of multiple threads, resulting in more efficient applications, by allowing one thread to be executed while another thread waits for some time-consuming operation to complete.</span></span>

> [!Note]  
> <span data-ttu-id="a1ad2-124">L’utilisation de plusieurs threads n’est pas une garantie de meilleures performances.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-124">Using multiple threads is not a guarantee of better performance.</span></span> <span data-ttu-id="a1ad2-125">En fait, étant donné que la factorisation des threads est un problème difficile, l’utilisation de plusieurs threads entraîne souvent des problèmes de performances.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-125">In fact, because thread factoring is a difficult problem, using multiple threads often causes performance problems.</span></span> <span data-ttu-id="a1ad2-126">La clé consiste à utiliser plusieurs threads uniquement si vous êtes très sûr de ce que vous faites.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-126">The key is to use multiple threads only if you are very sure of what you are doing.</span></span>

 

<span data-ttu-id="a1ad2-127">En général, le moyen le plus simple d’afficher l’architecture du thread COM consiste à considérer tous les objets COM du processus comme divisés en groupes appelés *Apartments*.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-127">In general, the simplest way to view the COM threading architecture is to think of all the COM objects in the process as divided into groups called *apartments*.</span></span> <span data-ttu-id="a1ad2-128">Un objet COM se trouve dans un seul cloisonnement, dans le sens où ses méthodes peuvent légalement être appelées directement uniquement par un thread qui appartient à ce cloisonnement.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-128">A COM object lives in exactly one apartment, in the sense that its methods can legally be directly called only by a thread that belongs to that apartment.</span></span> <span data-ttu-id="a1ad2-129">Tout autre thread qui souhaite appeler l’objet doit passer par un proxy.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-129">Any other thread that wants to call the object must go through a proxy.</span></span>

<span data-ttu-id="a1ad2-130">Il existe deux types de cloisonnements : les cloisonnements [à thread unique](single-threaded-apartments.md)et les [cloisonnements](multithreaded-apartments.md)multithread.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-130">There are two types of apartments: [single-threaded apartments](single-threaded-apartments.md), and [multithreaded apartments](multithreaded-apartments.md).</span></span>

-   <span data-ttu-id="a1ad2-131">Les Apartments à thread unique sont constitués d’un seul thread, donc tous les objets COM qui résident dans un cloisonnement à thread unique peuvent recevoir des appels de méthode uniquement à partir du thread qui appartient à ce cloisonnement.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-131">Single-threaded apartments consist of exactly one thread, so all COM objects that live in a single-threaded apartment can receive method calls only from the one thread that belongs to that apartment.</span></span> <span data-ttu-id="a1ad2-132">Tous les appels de méthode à un objet COM dans un cloisonnement à thread unique sont synchronisés avec la file d’attente de messages Windows pour le thread du cloisonnement à thread unique.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-132">All method calls to a COM object in a single-threaded apartment are synchronized with the windows message queue for the single-threaded apartment's thread.</span></span> <span data-ttu-id="a1ad2-133">Un processus avec un seul thread d’exécution est simplement un cas particulier de ce modèle.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-133">A process with a single thread of execution is simply a special case of this model.</span></span>
-   <span data-ttu-id="a1ad2-134">Les cloisonnements multithread se composent d’un ou plusieurs threads, donc tous les objets COM qui résident dans un cloisonnement multithread peuvent recevoir des appels de méthode directement à partir de l’un des threads qui appartiennent au cloisonnement multithread.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-134">Multithreaded apartments consist of one or more threads, so all COM objects that live in an multithreaded apartment can receive method calls directly from any of the threads that belong to the multithreaded apartment.</span></span> <span data-ttu-id="a1ad2-135">Les threads d’un cloisonnement multithread utilisent un modèle appelé *libre-Threading*.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-135">Threads in a multithreaded apartment use a model called *free-threading*.</span></span> <span data-ttu-id="a1ad2-136">Les appels aux objets COM dans un cloisonnement multithread sont synchronisés par les objets eux-mêmes.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-136">Calls to COM objects in a multithreaded apartment are synchronized by the objects themselves.</span></span>

> [!Note]  
> <span data-ttu-id="a1ad2-137">Pour obtenir une description de la communication entre les cloisonnements à thread unique et les cloisonnements multithread dans le même processus, consultez [communication monothread et](single-threaded-and-multithreaded-communication.md)multithread.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-137">For a description of communication between single-threaded apartments and multithreaded apartments within the same process, see [Single-Threaded and Multithreaded Communication](single-threaded-and-multithreaded-communication.md).</span></span>

 

<span data-ttu-id="a1ad2-138">Un processus peut avoir zéro ou plusieurs cloisonnements à thread unique et zéro ou un cloisonnement multithread.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-138">A process can have zero or more single-threaded apartments and zero or one multithreaded apartment.</span></span>

<span data-ttu-id="a1ad2-139">Dans un processus, le cloisonnement principal est le premier à être initialisé.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-139">In a process, the main apartment is the first to be initialized.</span></span> <span data-ttu-id="a1ad2-140">Dans un processus à thread unique, il s’agit du seul cloisonnement.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-140">In a single-threaded process, this is the only apartment.</span></span> <span data-ttu-id="a1ad2-141">Les paramètres d’appel sont marshalés entre des Apartments et COM gère la synchronisation par le biais de la messagerie.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-141">Call parameters are marshaled between apartments, and COM handles the synchronization through messaging.</span></span> <span data-ttu-id="a1ad2-142">Si vous désignez plusieurs threads dans un processus pour qu’ils soient libres de threads, tous les threads libres résident dans un seul cloisonnement, les paramètres sont transmis directement à n’importe quel thread du cloisonnement, et vous devez gérer toute la synchronisation.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-142">If you designate multiple threads in a process to be free-threaded, all free threads reside in a single apartment, parameters are passed directly to any thread in the apartment, and you must handle all synchronization.</span></span> <span data-ttu-id="a1ad2-143">Dans un processus avec des threads libres et de threads cloisonnés, tous les threads libres résident dans un seul cloisonnement et tous les autres cloisonnements sont des cloisonnements à thread unique.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-143">In a process with both free-threading and apartment threading, all free threads reside in a single apartment and all other apartments are single-threaded apartments.</span></span> <span data-ttu-id="a1ad2-144">Un processus qui effectue un travail COM est une collection de cloisonnements avec, au plus, un cloisonnement multithread, mais un nombre quelconque de Apartments (STA) à thread unique.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-144">A process that does COM work is a collection of apartments with, at most, one multithreaded apartment but any number of single-threaded apartments.</span></span>

<span data-ttu-id="a1ad2-145">Les modèles de thread dans COM fournissent le mécanisme pour les clients et les serveurs qui utilisent différentes architectures de thread pour travailler ensemble.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-145">The threading models in COM provide the mechanism for clients and servers that use different threading architectures to work together.</span></span> <span data-ttu-id="a1ad2-146">Les appels entre objets avec différents modèles de thread dans des processus différents sont naturellement pris en charge.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-146">Calls among objects with different threading models in different processes are naturally supported.</span></span> <span data-ttu-id="a1ad2-147">Du point de vue de l’objet appelant, tous les appels aux objets en dehors d’un processus se comportent de la même façon, quelle que soit la façon dont l’objet appelé est thread.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-147">From the perspective of the calling object, all calls to objects outside a process behave identically, no matter how the object being called is threaded.</span></span> <span data-ttu-id="a1ad2-148">De même, du point de vue de l’objet appelé, les appels entrants se comportent de la même façon, quel que soit le modèle de thread de l’appelant.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-148">Likewise, from the perspective of the object being called, arriving calls behave identically, regardless of the threading model of the caller.</span></span>

<span data-ttu-id="a1ad2-149">L’interaction entre un client et un objet hors processus est simple, même lorsqu’ils utilisent des modèles de thread différents, car le client et l’objet se trouvent dans des processus différents.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-149">Interaction between a client and an out-of-process object is straightforward, even when they use different threading models because the client and object are in different processes.</span></span> <span data-ttu-id="a1ad2-150">COM, entre le client et le serveur, peut fournir le code pour que les modèles de threads interopèrent à l’aide du marshaling standard et de RPC.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-150">COM, interposed between the client and the server, can provide the code for the threading models to interoperate, using standard marshaling and RPC.</span></span> <span data-ttu-id="a1ad2-151">Par exemple, si un objet à thread unique est appelé simultanément par plusieurs clients à thread libre, les appels sont synchronisés par COM en plaçant les messages de fenêtre correspondants dans la file d’attente de messages du serveur.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-151">For example, if a single-threaded object is called simultaneously by multiple free-threaded clients, the calls will be synchronized by COM by placing corresponding window messages in the server's message queue.</span></span> <span data-ttu-id="a1ad2-152">Le cloisonnement de l’objet reçoit un appel chaque fois qu’il récupère et distribue des messages.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-152">The object's apartment will receive one call each time it retrieves and dispatches messages.</span></span> <span data-ttu-id="a1ad2-153">Toutefois, il est nécessaire de veiller à ce que les serveurs in-process interagissent correctement avec leurs clients.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-153">However, some care must be taken to ensure that in-process servers interact properly with their clients.</span></span> <span data-ttu-id="a1ad2-154">(Voir [problèmes de Threading de serveur in-process](in-process-server-threading-issues.md).)</span><span class="sxs-lookup"><span data-stu-id="a1ad2-154">(See [In-Process Server Threading Issues](in-process-server-threading-issues.md).)</span></span>

<span data-ttu-id="a1ad2-155">Le problème le plus important en matière de programmation avec un modèle multithread consiste à rendre votre code sécurisé au niveau du thread afin que les messages destinés à un thread particulier passent uniquement à ce thread et que l’accès aux threads soit protégé.</span><span class="sxs-lookup"><span data-stu-id="a1ad2-155">The most important issue in programming with a multithreaded model is to make your code thread-safe so that messages intended for a particular thread go only to that thread and access to threads is protected.</span></span>

<span data-ttu-id="a1ad2-156">Pour plus d'informations, voir les rubriques suivantes :</span><span class="sxs-lookup"><span data-stu-id="a1ad2-156">For more information, see the following topics:</span></span>

-   [<span data-ttu-id="a1ad2-157">Choix du modèle de thread</span><span class="sxs-lookup"><span data-stu-id="a1ad2-157">Choosing the Threading Model</span></span>](choosing-the-threading-model.md)
-   [<span data-ttu-id="a1ad2-158">Apartments (cloisonnés) à thread unique</span><span class="sxs-lookup"><span data-stu-id="a1ad2-158">Single-Threaded Apartments</span></span>](single-threaded-apartments.md)
-   [<span data-ttu-id="a1ad2-159">Apartments (cloisonnés) multithread</span><span class="sxs-lookup"><span data-stu-id="a1ad2-159">Multithreaded Apartments</span></span>](multithreaded-apartments.md)
-   [<span data-ttu-id="a1ad2-160">Communication monothread et multithread</span><span class="sxs-lookup"><span data-stu-id="a1ad2-160">Single-Threaded and Multithreaded Communication</span></span>](single-threaded-and-multithreaded-communication.md)
-   [<span data-ttu-id="a1ad2-161">Problèmes liés aux threads du serveur in-process</span><span class="sxs-lookup"><span data-stu-id="a1ad2-161">In-Process Server Threading Issues</span></span>](in-process-server-threading-issues.md)
-   [<span data-ttu-id="a1ad2-162">Accès aux interfaces à travers les Apartments</span><span class="sxs-lookup"><span data-stu-id="a1ad2-162">Accessing Interfaces Across Apartments</span></span>](accessing-interfaces-across-apartments.md)

 

 