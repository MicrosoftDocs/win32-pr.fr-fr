---
title: Problèmes liés aux threads In-Process Server
description: Problèmes liés aux threads In-Process Server
ms.assetid: 7bd6f62f-8c91-44bd-9a7f-d47988180eed
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8a9d02af739eac11a6adae62de76be9078ee8e32
ms.sourcegitcommit: 89f99926f946dc6c5ea600fb7c41f6b19ceac516
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/21/2020
ms.locfileid: "104383252"
---
# <a name="in-process-server-threading-issues"></a><span data-ttu-id="dba7c-103">Problèmes liés aux threads In-Process Server</span><span class="sxs-lookup"><span data-stu-id="dba7c-103">In-Process Server Threading Issues</span></span>

<span data-ttu-id="dba7c-104">Un serveur in-process n’appelle pas [**CoInitialize**](/windows/desktop/api/Objbase/nf-objbase-coinitialize), [**CoInitializeEx**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializeex)ou [**OleInitialize**](/windows/desktop/api/Ole2/nf-ole2-oleinitialize) pour marquer son modèle de thread.</span><span class="sxs-lookup"><span data-stu-id="dba7c-104">An in-process server does not call [**CoInitialize**](/windows/desktop/api/Objbase/nf-objbase-coinitialize), [**CoInitializeEx**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializeex), or [**OleInitialize**](/windows/desktop/api/Ole2/nf-ole2-oleinitialize) to mark its threading model.</span></span> <span data-ttu-id="dba7c-105">Pour les objets DLL ou in-process prenant en compte les threads, vous devez définir le modèle de thread dans le registre.</span><span class="sxs-lookup"><span data-stu-id="dba7c-105">For thread-aware DLL-based or in-process objects, you need to set the threading model in the registry.</span></span> <span data-ttu-id="dba7c-106">Le modèle par défaut quand vous ne spécifiez pas de modèle de thread est un thread unique par processus.</span><span class="sxs-lookup"><span data-stu-id="dba7c-106">The default model when you do not specify a threading model is single-thread-per-process.</span></span> <span data-ttu-id="dba7c-107">Pour spécifier un modèle, vous ajoutez la valeur **ThreadingModel** à la clé [InprocServer32](inprocserver32.md) dans le registre.</span><span class="sxs-lookup"><span data-stu-id="dba7c-107">To specify a model, you add the **ThreadingModel** value to the [InprocServer32](inprocserver32.md) key in the registry.</span></span>

<span data-ttu-id="dba7c-108">Les dll qui prennent en charge l’instanciation d’un objet de classe doivent implémenter et exporter les fonctions [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) et [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow).</span><span class="sxs-lookup"><span data-stu-id="dba7c-108">DLLs that support instantiation of a class object must implement and export the functions [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) and [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow).</span></span> <span data-ttu-id="dba7c-109">Lorsqu’un client souhaite une instance de la classe prise en charge par la DLL, un appel à [**CoGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetclassobject) (directement ou via un appel à [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance)) appelle **DllGetClassObject** pour obtenir un pointeur vers son objet de classe lorsque l’objet est implémenté dans une dll.</span><span class="sxs-lookup"><span data-stu-id="dba7c-109">When a client wants an instance of the class the DLL supports, a call to [**CoGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-cogetclassobject) (either directly or through a call to [**CoCreateInstance**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreateinstance)) calls **DllGetClassObject** to get a pointer to its class object when the object is implemented in a DLL.</span></span> <span data-ttu-id="dba7c-110">**DllGetClassObject** devrait donc pouvoir attribuer plusieurs objets de classe ou un seul objet thread-safe (essentiellement en utilisant [**InterlockedIncrement**](/windows/win32/api/winnt/nf-winnt-interlockedincrement) / [**InterlockedDecrement**](/windows/desktop/api/winbase/nf-winbase-interlockeddecrement) sur leurs décomptes de références internes).</span><span class="sxs-lookup"><span data-stu-id="dba7c-110">**DllGetClassObject** should therefore be able to give away multiple class objects or a single thread-safe object (essentially just using [**InterlockedIncrement**](/windows/win32/api/winnt/nf-winnt-interlockedincrement)/[**InterlockedDecrement**](/windows/desktop/api/winbase/nf-winbase-interlockeddecrement) on their internal reference counts).</span></span>

<span data-ttu-id="dba7c-111">Comme son nom l’indique, [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow) est appelé pour déterminer si la dll qui l’implémente est en cours d’utilisation, ce qui permet à l’appelant de le décharger en toute sécurité si ce n’est pas le cas.</span><span class="sxs-lookup"><span data-stu-id="dba7c-111">As its name implies, [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow) is called to determine whether the DLL that implements it is in use, enabling the caller to safely unload it if it is not.</span></span> <span data-ttu-id="dba7c-112">Les appels à [**coFreeUnusedLibraries**](/windows/desktop/api/combaseapi/nf-combaseapi-cofreeunusedlibraries) à partir de n’importe quel thread sont toujours acheminés via le thread du cloisonnement principal pour appeler **DllCanUnloadNow**.</span><span class="sxs-lookup"><span data-stu-id="dba7c-112">Calls to [**CoFreeUnusedLibraries**](/windows/desktop/api/combaseapi/nf-combaseapi-cofreeunusedlibraries) from any thread always route through the main apartment's thread to call **DllCanUnloadNow**.</span></span>

<span data-ttu-id="dba7c-113">Comme les autres serveurs, les serveurs in-process peuvent être à thread unique, à thread cloisonné ou à thread libre.</span><span class="sxs-lookup"><span data-stu-id="dba7c-113">Like other servers, in-process servers can be single-threaded, apartment-threaded, or free-threaded.</span></span> <span data-ttu-id="dba7c-114">Ces serveurs peuvent être utilisés par n’importe quel client OLE, quel que soit le modèle de thread utilisé par ce client.</span><span class="sxs-lookup"><span data-stu-id="dba7c-114">These servers can be used by any OLE client, regardless of the threading model used by that client.</span></span>

<span data-ttu-id="dba7c-115">Toutes les combinaisons d’interopérabilité de modèle de thread sont autorisées entre les clients et les objets in-process.</span><span class="sxs-lookup"><span data-stu-id="dba7c-115">All combinations of threading model interoperability are allowed between clients and in-process objects.</span></span> <span data-ttu-id="dba7c-116">L’interaction entre un client et un objet in-process qui utilise différents modèles de threads est identique à l’interaction entre les clients et les serveurs hors processus.</span><span class="sxs-lookup"><span data-stu-id="dba7c-116">Interaction between a client and an in-process object that use different threading models is exactly like the interaction between clients and out-of-process servers.</span></span> <span data-ttu-id="dba7c-117">Pour un serveur in-process, lorsque le modèle de thread du client et du serveur in-process diffère, COM doit s’interposer entre le client et l’objet.</span><span class="sxs-lookup"><span data-stu-id="dba7c-117">For an in-process server, when the threading model of the client and in-process server differ, COM must interpose itself between the client and the object.</span></span>

<span data-ttu-id="dba7c-118">Lorsqu’un objet in-process qui prend en charge le modèle à thread unique est appelé simultanément par plusieurs threads d’un client, COM ne peut pas autoriser les threads clients à accéder directement à l’interface de l’objet. l’objet n’a pas été conçu pour ce type d’accès.</span><span class="sxs-lookup"><span data-stu-id="dba7c-118">When an in-process object that supports the single-threaded model is called simultaneously by multiple threads of a client, COM cannot allow the client threads to directly access the object's interfaceâ€”the object was not designed for such access.</span></span> <span data-ttu-id="dba7c-119">Au lieu de cela, COM doit s’assurer que les appels sont synchronisés et sont effectués uniquement par le thread client qui a créé l’objet.</span><span class="sxs-lookup"><span data-stu-id="dba7c-119">Instead, COM must ensure that calls are synchronized and are made only by the client thread that created the object.</span></span> <span data-ttu-id="dba7c-120">Par conséquent, COM crée l’objet dans le cloisonnement principal du client et nécessite que tous les autres Apartments (cloisonnés) clients accèdent à l’objet à l’aide de proxys.</span><span class="sxs-lookup"><span data-stu-id="dba7c-120">Therefore, COM creates the object in the client's main apartment and requires all the other client apartments to access the object by using proxies.</span></span>

<span data-ttu-id="dba7c-121">Lorsqu’un cloisonnement à threads libres (modèle multithread cloisonné) dans un client crée un serveur in-process thread cloisonné, COM lance un thread « hôte » de modèle de cloisonnement monothread dans le client.</span><span class="sxs-lookup"><span data-stu-id="dba7c-121">When a free-threaded apartment (multithreaded apartment model) in a client creates an apartment-threaded in-process server, COM spins up a single-threaded apartment model "host" thread in the client.</span></span> <span data-ttu-id="dba7c-122">Ce thread hôte crée l’objet et le pointeur d’interface est remarshalé vers le cloisonnement libre de thread du client.</span><span class="sxs-lookup"><span data-stu-id="dba7c-122">This host thread will create the object, and the interface pointer will be marshaled back to the client's free-threaded apartment.</span></span> <span data-ttu-id="dba7c-123">De même, lorsqu’un cloisonnement monothread dans un client de modèle cloisonné crée un serveur in-process libre de threads, COM lance un thread hôte libre de threads (cloisonnement multithread sur lequel l’objet sera créé, puis remarshalé vers le cloisonnement du client à thread unique cloisonné).</span><span class="sxs-lookup"><span data-stu-id="dba7c-123">Similarly, when a single-threaded apartment in an apartment-model client creates a free-threaded in-process server, COM spins up a free-threaded host thread (multithreaded apartment on which the object will be created and then marshaled back to the client single-threaded apartment).</span></span>

> [!Note]  
> <span data-ttu-id="dba7c-124">En général, si vous concevez une interface personnalisée sur un serveur in-process, vous devez également fournir le code de marshaling pour celle-ci afin que COM puisse marshaler l’interface entre les cloisonnements client.</span><span class="sxs-lookup"><span data-stu-id="dba7c-124">In general, if you design a custom interface on an in-process server, you should also provide the marshaling code for it so that COM can marshal the interface between client apartments.</span></span>

 

<span data-ttu-id="dba7c-125">COM vous aide à protéger l’accès aux objets fournis par une DLL à thread unique en exigeant l’accès à partir du cloisonnement du client dans lequel ils ont été créés.</span><span class="sxs-lookup"><span data-stu-id="dba7c-125">COM helps protect access to objects provided by a single-threaded DLL by requiring access from the same client apartment in which they were created.</span></span> <span data-ttu-id="dba7c-126">En outre, tous les points d’entrée de DLL (tels que [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) et [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow)) et les données globales doivent toujours être accessibles par le même cloisonnement.</span><span class="sxs-lookup"><span data-stu-id="dba7c-126">In addition, all of the DLL entry points (like [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) and [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow)) and global data should always be accessed by the same apartment.</span></span> <span data-ttu-id="dba7c-127">COM crée de tels objets dans le cloisonnement principal du client, ce qui donne au principal un accès direct aux pointeurs de l’objet.</span><span class="sxs-lookup"><span data-stu-id="dba7c-127">COM creates such objects in the main apartment of the client, giving the main apartment direct access to the object's pointers.</span></span> <span data-ttu-id="dba7c-128">Les appels des autres cloisonnements utilisent le marshaling entre threads pour passer du proxy au stub dans le cloisonnement principal, puis à l’objet.</span><span class="sxs-lookup"><span data-stu-id="dba7c-128">Calls from the other apartments use interthread marshaling to go from the proxy to the stub in the main apartment and then to the object.</span></span> <span data-ttu-id="dba7c-129">Cela permet à COM de synchroniser les appels à l’objet.</span><span class="sxs-lookup"><span data-stu-id="dba7c-129">This allows COM to synchronize calls to the object.</span></span> <span data-ttu-id="dba7c-130">Les appels entre les threads étant lents, il est recommandé de réécrire ces serveurs pour prendre en charge plusieurs cloisonnements.</span><span class="sxs-lookup"><span data-stu-id="dba7c-130">Interthread calls are slow, so it is recommended that these servers be rewritten to support multiple apartments.</span></span>

<span data-ttu-id="dba7c-131">Comme un serveur in-process à thread unique, un objet fourni par une DLL de modèle cloisonné doit être accessible par le même cloisonnement client à partir duquel il a été créé.</span><span class="sxs-lookup"><span data-stu-id="dba7c-131">Like a single-threaded in-process server, an object provided by an apartment model DLL must be accessed by the same client apartment from which it was created.</span></span> <span data-ttu-id="dba7c-132">Toutefois, les objets fournis par ce serveur peuvent être créés dans plusieurs Apartments du client, de sorte que le serveur doit implémenter ses points d’entrée (tels que [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) et [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow)) pour une utilisation multithread.</span><span class="sxs-lookup"><span data-stu-id="dba7c-132">However, objects provided by this server can be created in multiple apartments of the client, so the server must implement its entry points (like [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) and [**DllCanUnloadNow**](/windows/desktop/api/combaseapi/nf-combaseapi-dllcanunloadnow)) for multithreaded use.</span></span> <span data-ttu-id="dba7c-133">Par exemple, si deux cloisonnements d’un client essaient de créer simultanément deux instances de l’objet in-process, **DllGetClassObject** peut être appelé simultanément par les deux cloisonnements.</span><span class="sxs-lookup"><span data-stu-id="dba7c-133">For example, if two apartments of a client try to create two instances of the in-process object simultaneously, **DllGetClassObject** can be called simultaneously by both apartments.</span></span> <span data-ttu-id="dba7c-134">**DllCanUnloadNow** doit être écrit de sorte que la dll ne se décharge pas pendant que le code est toujours en cours d’exécution dans la dll.</span><span class="sxs-lookup"><span data-stu-id="dba7c-134">**DllCanUnloadNow** must be written so that the DLL does not unload while code is still executing in the DLL.</span></span>

<span data-ttu-id="dba7c-135">Si la DLL fournit une seule instance de la fabrique de classe pour créer tous les objets, l’implémentation de la fabrique de classe doit également être conçue pour une utilisation multithread, car elle est accessible par plusieurs Apartments (cloisonnés) clients.</span><span class="sxs-lookup"><span data-stu-id="dba7c-135">If the DLL provides only one instance of the class factory to create all the objects, the class factory implementation must also be designed for multithreaded use, because it will be accessed by multiple client apartments.</span></span> <span data-ttu-id="dba7c-136">Si la DLL crée une nouvelle instance de la fabrique de classes à chaque fois que [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) est appelé, la fabrique de classe n’a pas besoin d’être thread-safe.</span><span class="sxs-lookup"><span data-stu-id="dba7c-136">If the DLL creates a new instance of the class factory each time [**DllGetClassObject**](/windows/desktop/api/combaseapi/nf-combaseapi-dllgetclassobject) is called, the class factory need not be thread-safe.</span></span>

<span data-ttu-id="dba7c-137">Les objets créés par la fabrique de classe n’ont pas besoin d’être thread-safe.</span><span class="sxs-lookup"><span data-stu-id="dba7c-137">Objects created by the class factory need not be thread-safe.</span></span> <span data-ttu-id="dba7c-138">Une fois créé par un thread, l’objet est toujours accessible par le biais de ce thread et tous les appels à l’objet sont synchronisés par COM.</span><span class="sxs-lookup"><span data-stu-id="dba7c-138">Once created by a thread, the object is always accessed through that thread and all calls to the object are synchronized by COM.</span></span> <span data-ttu-id="dba7c-139">Le cloisonnement de modèle Apartment d’un client qui crée cet objet obtiendra un pointeur direct vers l’objet.</span><span class="sxs-lookup"><span data-stu-id="dba7c-139">The apartment model apartment of a client that creates this object will get a direct pointer to the object.</span></span> <span data-ttu-id="dba7c-140">Les Apartments client qui diffèrent du cloisonnement dans lequel l’objet a été créé doivent accéder à l’objet par le biais de proxies.</span><span class="sxs-lookup"><span data-stu-id="dba7c-140">Client apartments that are different from the apartment in which the object was created must access the object through proxies.</span></span> <span data-ttu-id="dba7c-141">Ces proxies sont créés lorsque le client marshale l’interface entre ses Apartments.</span><span class="sxs-lookup"><span data-stu-id="dba7c-141">These proxies are created when the client marshals the interface between its apartments.</span></span>

<span data-ttu-id="dba7c-142">Quand une valeur **ThreadingModel** de dll in-process est définie sur « both », un objet fourni par cette dll peut être créé et utilisé directement (sans proxy) dans des cloisonnements de clients monothread ou multithread.</span><span class="sxs-lookup"><span data-stu-id="dba7c-142">When an in-process DLL **ThreadingModel** value is set to "Both", an object provided by this DLL can be created and used directly (without a proxy) in single-threaded or multithreaded client apartments.</span></span> <span data-ttu-id="dba7c-143">Toutefois, il ne peut être utilisé directement que dans le cloisonnement dans lequel il a été créé.</span><span class="sxs-lookup"><span data-stu-id="dba7c-143">However, it can be used directly only within the apartment in which it was created.</span></span> <span data-ttu-id="dba7c-144">Pour attribuer l’objet à un autre cloisonnement, l’objet doit être marshalé.</span><span class="sxs-lookup"><span data-stu-id="dba7c-144">To give the object to any other apartment, the object must be marshaled.</span></span> <span data-ttu-id="dba7c-145">L’objet DLL doit implémenter sa propre synchronisation et il est accessible par plusieurs cloisonnements client en même temps.</span><span class="sxs-lookup"><span data-stu-id="dba7c-145">The DLL object must implement its own synchronization and can be accessed by multiple client apartments at the same time.</span></span>

<span data-ttu-id="dba7c-146">Pour accélérer les performances de l’accès en thread libre aux objets DLL in-process, COM fournit la fonction [**CoCreateFreeThreadedMarshaler**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreatefreethreadedmarshaler) .</span><span class="sxs-lookup"><span data-stu-id="dba7c-146">To speed performance for free-threaded access to in-process DLL objects, COM provides the [**CoCreateFreeThreadedMarshaler**](/windows/desktop/api/combaseapi/nf-combaseapi-cocreatefreethreadedmarshaler) function.</span></span> <span data-ttu-id="dba7c-147">Cette fonction crée un objet de marshaling libre de threads qui peut être agrégé avec un objet serveur in-process.</span><span class="sxs-lookup"><span data-stu-id="dba7c-147">This function creates a free-threaded marshaling object that can be aggregated with an in-process server object.</span></span> <span data-ttu-id="dba7c-148">Lorsqu’un cloisonnement client dans le même processus a besoin d’accéder à un objet dans un autre cloisonnement, l’agrégation du marshaleur libre-thread fournit au client un pointeur direct vers l’objet serveur, plutôt que vers un proxy, lorsque le client marshale l’interface de l’objet vers un autre cloisonnement.</span><span class="sxs-lookup"><span data-stu-id="dba7c-148">When a client apartment in the same process needs access to an object in another apartment, aggregating the free-threaded marshaler provides the client with a direct pointer to the server object, rather than to a proxy, when the client marshals the object's interface to a different apartment.</span></span> <span data-ttu-id="dba7c-149">Le client n’a pas besoin d’effectuer de synchronisation.</span><span class="sxs-lookup"><span data-stu-id="dba7c-149">The client does not need to do any synchronization.</span></span> <span data-ttu-id="dba7c-150">Cela fonctionne uniquement dans le même processus. le marshaling standard est utilisé pour une référence à l’objet qui est envoyé à un autre processus.</span><span class="sxs-lookup"><span data-stu-id="dba7c-150">This works only within the same process; standard marshaling is used for a reference to the object that is sent to another process.</span></span>

<span data-ttu-id="dba7c-151">Un objet fourni par une DLL in-process qui prend uniquement en charge le Threading libre est un objet à thread libre.</span><span class="sxs-lookup"><span data-stu-id="dba7c-151">An object provided by an in-process DLL that supports only free threading is a free-threaded object.</span></span> <span data-ttu-id="dba7c-152">Il implémente sa propre synchronisation et est accessible par plusieurs threads clients en même temps.</span><span class="sxs-lookup"><span data-stu-id="dba7c-152">It implements its own synchronization and can be accessed by multiple client threads at the same time.</span></span> <span data-ttu-id="dba7c-153">Ce serveur ne marshale pas les interfaces entre les threads. ce serveur peut donc être créé et utilisé directement (sans proxy) uniquement par des Apartments multithread dans un client.</span><span class="sxs-lookup"><span data-stu-id="dba7c-153">This server does not marshal interfaces between threads, so this server can be created and used directly (without a proxy) only by multithreaded apartments in a client.</span></span> <span data-ttu-id="dba7c-154">Les Apartments à thread unique qui le créent y accèdent via un proxy.</span><span class="sxs-lookup"><span data-stu-id="dba7c-154">Single-threaded apartments that create it will access it through a proxy.</span></span>

## <a name="related-topics"></a><span data-ttu-id="dba7c-155">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="dba7c-155">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="dba7c-156">Accès aux interfaces à travers les Apartments</span><span class="sxs-lookup"><span data-stu-id="dba7c-156">Accessing Interfaces Across Apartments</span></span>](accessing-interfaces-across-apartments.md)
</dt> <dt>

[<span data-ttu-id="dba7c-157">Choix du modèle de thread</span><span class="sxs-lookup"><span data-stu-id="dba7c-157">Choosing the Threading Model</span></span>](choosing-the-threading-model.md)
</dt> <dt>

[<span data-ttu-id="dba7c-158">Apartments (cloisonnés) multithread</span><span class="sxs-lookup"><span data-stu-id="dba7c-158">Multithreaded Apartments</span></span>](multithreaded-apartments.md)
</dt> <dt>

[<span data-ttu-id="dba7c-159">Processus, threads et Apartments</span><span class="sxs-lookup"><span data-stu-id="dba7c-159">Processes, Threads, and Apartments</span></span>](processes--threads--and-apartments.md)
</dt> <dt>

[<span data-ttu-id="dba7c-160">Communication monothread et multithread</span><span class="sxs-lookup"><span data-stu-id="dba7c-160">Single-Threaded and Multithreaded Communication</span></span>](single-threaded-and-multithreaded-communication.md)
</dt> <dt>

[<span data-ttu-id="dba7c-161">Apartments (cloisonnés) à thread unique</span><span class="sxs-lookup"><span data-stu-id="dba7c-161">Single-Threaded Apartments</span></span>](single-threaded-apartments.md)
</dt> </dl>

 

 