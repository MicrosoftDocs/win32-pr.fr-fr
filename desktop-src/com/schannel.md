---
title: Schannel
description: Le package de sécurité Secure Channel (SChannel), dont l’identificateur de service d’authentification est RPC \_ C \_ Authn \_ GSS \_ Schannel, prend en charge les protocoles basés sur une clé publique SSL (SSL (Secure Sockets Layer)) versions 2,0 et 3,0, le protocole TLS (Transport Layer Security) 1,0 et la technologie de communication privée (PCT) 1,0. TLS 1,0 est une version normalisée, légèrement modifiée, de SSL 3,0, qui a été publiée par l’IETF (Internet Engineering Task Force) en janvier 1999, dans le document RFC 2246. Dans la mesure où TLS a été standardisé, les développeurs sont encouragés à utiliser TLS plutôt que SSL. PCT est inclus uniquement à des fins de compatibilité descendante et ne doit pas être utilisé pour un nouveau développement. Lorsque le package de sécurité Schannel est utilisé, DCOM négocie automatiquement le meilleur protocole, en fonction des capacités du client et du serveur.
ms.assetid: 03a5f987-f668-4f19-9b58-d62711f58734
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: eccc9f82a05d1542e7585426128f10cdf452d31d
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/21/2020
ms.locfileid: "104316571"
---
# <a name="schannel"></a><span data-ttu-id="e0791-107">Schannel</span><span class="sxs-lookup"><span data-stu-id="e0791-107">Schannel</span></span>

<span data-ttu-id="e0791-108">Le package de sécurité Secure Channel (SChannel), dont l’identificateur de service d’authentification est RPC \_ C \_ Authn \_ GSS \_ Schannel, prend en charge les protocoles basés sur une clé publique suivants : SSL (SSL (Secure Sockets Layer)) versions 2,0 et 3,0, TLS (Transport Layer Security) 1,0 et PCT (Private Communication Technology) 1,0.</span><span class="sxs-lookup"><span data-stu-id="e0791-108">The Secure Channel (Schannel) security package, whose authentication service identifier is RPC\_C\_AUTHN\_GSS\_SCHANNEL, supports the following public-key based protocols: SSL (Secure Sockets Layer) versions 2.0 and 3.0, Transport Layer Security (TLS) 1.0, and Private Communication Technology (PCT) 1.0.</span></span> <span data-ttu-id="e0791-109">TLS 1,0 est une version normalisée, légèrement modifiée, de SSL 3,0, qui a été publiée par l’IETF (Internet Engineering Task Force) en janvier 1999, dans le document [RFC 2246](https://www.ietf.org/rfc/rfc2246.txt).</span><span class="sxs-lookup"><span data-stu-id="e0791-109">TLS 1.0 is a standardized, slightly modified version of SSL 3.0 that was issued by the Internet Engineering Task Force (IETF) in January 1999, in document [RFC 2246](https://www.ietf.org/rfc/rfc2246.txt).</span></span> <span data-ttu-id="e0791-110">Dans la mesure où TLS a été standardisé, les développeurs sont encouragés à utiliser TLS plutôt que SSL.</span><span class="sxs-lookup"><span data-stu-id="e0791-110">Because TLS has been standardized, developers are encouraged to use TLS rather than SSL.</span></span> <span data-ttu-id="e0791-111">PCT est inclus uniquement à des fins de compatibilité descendante et ne doit pas être utilisé pour un nouveau développement.</span><span class="sxs-lookup"><span data-stu-id="e0791-111">PCT is included for backward compatibility only and should not be used for new development.</span></span> <span data-ttu-id="e0791-112">Lorsque le package de sécurité Schannel est utilisé, DCOM négocie automatiquement le meilleur protocole, en fonction des capacités du client et du serveur.</span><span class="sxs-lookup"><span data-stu-id="e0791-112">When the Schannel security package is used, DCOM automatically negotiates the best protocol, depending on the client and server capabilities.</span></span>

<span data-ttu-id="e0791-113">Les rubriques suivantes décrivent brièvement le protocole TLS et son fonctionnement avec DCOM.</span><span class="sxs-lookup"><span data-stu-id="e0791-113">The following topics briefly describe the TLS protocol and how it works with DCOM.</span></span>

-   [<span data-ttu-id="e0791-114">Quand utiliser TLS</span><span class="sxs-lookup"><span data-stu-id="e0791-114">When to Use TLS</span></span>](#when-to-use-tls)
-   [<span data-ttu-id="e0791-115">Bref aperçu du fonctionnement du protocole TLS</span><span class="sxs-lookup"><span data-stu-id="e0791-115">Brief Overview of How TLS Works</span></span>](#brief-overview-of-how-tls-works)
-   [<span data-ttu-id="e0791-116">Certificats X. 509</span><span class="sxs-lookup"><span data-stu-id="e0791-116">X.509 Certificates</span></span>](#x509-certificates)
    -   [<span data-ttu-id="e0791-117">Certificats clients</span><span class="sxs-lookup"><span data-stu-id="e0791-117">Client Certificates</span></span>](#client-certificates)
-   [<span data-ttu-id="e0791-118">Utilisation de TLS dans COM</span><span class="sxs-lookup"><span data-stu-id="e0791-118">Using TLS in COM</span></span>](#using-tls-in-com)
    -   [<span data-ttu-id="e0791-119">Comment un serveur définit la couverture de sécurité</span><span class="sxs-lookup"><span data-stu-id="e0791-119">How a Server Sets the Security Blanket</span></span>](#how-a-server-sets-the-security-blanket)
    -   [<span data-ttu-id="e0791-120">Comment un client définit la couverture de sécurité</span><span class="sxs-lookup"><span data-stu-id="e0791-120">How a Client Sets the Security Blanket</span></span>](#how-a-client-sets-the-security-blanket)
    -   [<span data-ttu-id="e0791-121">Modification de la couverture de sécurité par un client</span><span class="sxs-lookup"><span data-stu-id="e0791-121">How a Client Changes the Security Blanket</span></span>](#how-a-client-changes-the-security-blanket)
    -   [<span data-ttu-id="e0791-122">Exemple : le client modifie la couverture de sécurité</span><span class="sxs-lookup"><span data-stu-id="e0791-122">Example: Client Changes the Security Blanket</span></span>](#example-client-changes-the-security-blanket)
-   [<span data-ttu-id="e0791-123">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="e0791-123">Related topics</span></span>](#related-topics)

> [!Note]  
> <span data-ttu-id="e0791-124">Toutes les informations sur le protocole TLS dans ces sections s’appliquent également aux protocoles SSL et PCT.</span><span class="sxs-lookup"><span data-stu-id="e0791-124">All the information about the TLS protocol in these sections also applies to the SSL and PCT protocols.</span></span>

 

## <a name="when-to-use-tls"></a><span data-ttu-id="e0791-125">Quand utiliser TLS</span><span class="sxs-lookup"><span data-stu-id="e0791-125">When to Use TLS</span></span>

<span data-ttu-id="e0791-126">TLS est la seule option de sécurité disponible lorsque les serveurs doivent prouver leur identité aux clients anonymes.</span><span class="sxs-lookup"><span data-stu-id="e0791-126">TLS is the only security option available when servers need to prove their identity to anonymous clients.</span></span> <span data-ttu-id="e0791-127">Ceci est particulièrement important pour les sites Web qui souhaitent participer au commerce électronique, car il permet de protéger la transmission d’informations sensibles, telles que des numéros de carte de crédit.</span><span class="sxs-lookup"><span data-stu-id="e0791-127">This is particularly important for websites that want to participate in e-commerce because it helps protect the transmission of sensitive information such as credit card numbers.</span></span> <span data-ttu-id="e0791-128">Le protocole TLS garantit que les clients de commerce électronique peuvent être certains de ceux avec qui ils travaillent, car ils reçoivent une preuve de l’identité du serveur.</span><span class="sxs-lookup"><span data-stu-id="e0791-128">TLS assures that the e-commerce customers can be certain of whom they are doing business with because they are given proof of the server's identity.</span></span> <span data-ttu-id="e0791-129">Il permet également au serveur de commerce électronique d’éviter d’avoir à se préoccuper de l’authentification de l’identité de chacun de ses clients.</span><span class="sxs-lookup"><span data-stu-id="e0791-129">It also gives the e-commerce server the efficiency of not having to concern itself with authenticating the identity of each of its customers.</span></span>

<span data-ttu-id="e0791-130">TLS exige que tous les serveurs prouvent leur identité aux clients.</span><span class="sxs-lookup"><span data-stu-id="e0791-130">TLS requires that all servers prove their identity to clients.</span></span> <span data-ttu-id="e0791-131">En outre, TLS permet aux clients de prouver leur identité aux serveurs.</span><span class="sxs-lookup"><span data-stu-id="e0791-131">Additionally, TLS provides the option of having clients prove their identity to servers.</span></span> <span data-ttu-id="e0791-132">Cette authentification mutuelle peut être utile pour limiter l’accès de certaines pages Web dans un intranet d’entreprise de grande taille.</span><span class="sxs-lookup"><span data-stu-id="e0791-132">This mutual authentication can be useful in restricting the access of certain webpages in a large corporate intranet.</span></span>

<span data-ttu-id="e0791-133">Le protocole TLS prend en charge les niveaux d’authentification les plus élevés et offre une architecture ouverte qui permet d’augmenter la puissance de chiffrement au fil du temps pour suivre l’innovation technologique.</span><span class="sxs-lookup"><span data-stu-id="e0791-133">TLS supports the strongest authentication levels and offers an open architecture that permits encryption strength to increase over time to keep up with technological innovation.</span></span> <span data-ttu-id="e0791-134">TLS est le meilleur choix pour les environnements où le niveau de sécurité le plus élevé est souhaité pour les données en transit.</span><span class="sxs-lookup"><span data-stu-id="e0791-134">TLS is the best choice for environments where the highest level of security is desired for the data in transit.</span></span>

## <a name="brief-overview-of-how-tls-works"></a><span data-ttu-id="e0791-135">Bref aperçu du fonctionnement du protocole TLS</span><span class="sxs-lookup"><span data-stu-id="e0791-135">Brief Overview of How TLS Works</span></span>

<span data-ttu-id="e0791-136">Le protocole TLS repose sur une infrastructure à clé publique (PKI), qui utilise des paires de clés publiques/privées pour activer le chiffrement des données et établir l’intégrité des données, et utilise des certificats X. 509 pour l’authentification.</span><span class="sxs-lookup"><span data-stu-id="e0791-136">TLS is built upon a public key infrastructure (PKI), which uses public/private key pairs for enabling data encryption and establishing data integrity, and uses X.509 certificates for authentication.</span></span>

<span data-ttu-id="e0791-137">De nombreux protocoles de sécurité, tels que le protocole Kerberos V5, dépendent d’une clé unique pour chiffrer et déchiffrer les données.</span><span class="sxs-lookup"><span data-stu-id="e0791-137">Many security protocols, such as the Kerberos v5 protocol, depend on a single key to both encrypt and decrypt data.</span></span> <span data-ttu-id="e0791-138">Ces protocoles dépendent donc de l’échange sécurisé des clés de chiffrement. dans le protocole Kerberos, cette opération s’effectue par le biais de tickets obtenus à partir du centre de distribution de clés (KDC).</span><span class="sxs-lookup"><span data-stu-id="e0791-138">Such protocols therefore depend on the secure exchange of encryption keys; in the Kerberos protocol, this is done through tickets obtained from the Key Distribution Center (KDC).</span></span> <span data-ttu-id="e0791-139">Cela exige que tout le monde qui utilise le protocole Kerberos soit inscrit auprès du KDC, ce qui constituerait une limitation impraticable pour un serveur Web de commerce électronique destiné à attirer des millions de clients dans le monde entier.</span><span class="sxs-lookup"><span data-stu-id="e0791-139">This requires that everyone using the Kerberos protocol be registered with the KDC, which would be an impractical limitation for an e-commerce web server that is intended to attract millions of customers from around the world.</span></span> <span data-ttu-id="e0791-140">Par conséquent, le protocole TLS repose sur une infrastructure à clé publique, qui utilise deux clés pour le encryptionâ de données» lorsqu’une clé de la paire chiffre les données, seule l’autre clé de la paire peut la déchiffrer.</span><span class="sxs-lookup"><span data-stu-id="e0791-140">TLS therefore relies upon a PKI, which uses two keys for data encryptionâ€”when one key of the pair encrypts the data, only the other key of the pair can decrypt it.</span></span> <span data-ttu-id="e0791-141">Le principal avantage de cette conception est que le chiffrement peut être effectué sans nécessiter l’échange sécurisé de clés de chiffrement.</span><span class="sxs-lookup"><span data-stu-id="e0791-141">The principle benefit of this design is that encryption can be performed without requiring the secure exchange of encryption keys.</span></span>

<span data-ttu-id="e0791-142">Une infrastructure à clé publique utilise une technique dans laquelle l’une des clés est gardée privée et n’est disponible que pour le principal auquel elle est inscrite, tandis que l’autre clé est rendue publique pour quiconque peut y accéder.</span><span class="sxs-lookup"><span data-stu-id="e0791-142">A PKI uses a technique where one of the keys is kept private and is available only to the principal to whom it is registered, while the other key is made public for anyone to access.</span></span> <span data-ttu-id="e0791-143">Si quelqu’un souhaite envoyer un message privé au propriétaire d’une paire de clés, le message peut être chiffré avec la clé publique et seule la clé privée peut être utilisée pour déchiffrer le message.</span><span class="sxs-lookup"><span data-stu-id="e0791-143">If someone wants to send a private message to the owner of a key pair, the message can be encrypted with the public key and only the private key can be used to decrypt the message.</span></span>

<span data-ttu-id="e0791-144">Les paires de clés sont également utilisées pour vérifier l’intégrité des données envoyées.</span><span class="sxs-lookup"><span data-stu-id="e0791-144">Key pairs are also used to verify the integrity of the data being sent.</span></span> <span data-ttu-id="e0791-145">Pour ce faire, le propriétaire de la paire de clés peut attacher une signature numérique aux données avant de les envoyer.</span><span class="sxs-lookup"><span data-stu-id="e0791-145">To do this, the owner of the key pair can attach a digital signature to the data before sending it.</span></span> <span data-ttu-id="e0791-146">La création d’une signature numérique implique le calcul d’un hachage des données et le chiffrement du hachage avec la clé privée.</span><span class="sxs-lookup"><span data-stu-id="e0791-146">Creating a digital signature involves calculating a hash of the data and encrypting the hash with the private key.</span></span> <span data-ttu-id="e0791-147">Toute personne qui utilise la clé publique pour déchiffrer la signature numérique est assurée que la signature numérique ne doit être fournie qu’à partir de la personne propriétaire de la clé privée.</span><span class="sxs-lookup"><span data-stu-id="e0791-147">Anyone who uses the public key to decrypt the digital signature is assured that the digital signature must have come only from the person who owns the private key.</span></span> <span data-ttu-id="e0791-148">En outre, le destinataire peut calculer un hachage des données à l’aide du même algorithme que l’expéditeur, et si le hachage calculé correspond à celui envoyé dans la signature numérique, le destinataire peut être certain que les données n’ont pas été modifiées une fois qu’elles ont été signées numériquement.</span><span class="sxs-lookup"><span data-stu-id="e0791-148">Additionally, the recipient can calculate a hash of the data using the same algorithm as the sender, and if the calculated hash matches the one sent in the digital signature, the recipient can be certain that the data was not modified after it was digitally signed.</span></span>

<span data-ttu-id="e0791-149">L’un des inconvénients de l’utilisation d’une infrastructure à clé publique pour le chiffrement de données volumineux est que ses performances sont relativement lentes.</span><span class="sxs-lookup"><span data-stu-id="e0791-149">One disadvantage of using a PKI for high-volume data encryption is its relatively slow performance.</span></span> <span data-ttu-id="e0791-150">En raison de l’activité mathématique intensive impliquée, le chiffrement et le déchiffrement des données à l’aide d’un chiffrement asymétrique qui dépend d’une paire de clés peuvent être jusqu’à 1 000 fois plus lents que le chiffrement et le déchiffrement à l’aide d’un chiffrement symétrique qui dépend uniquement d’une clé unique.</span><span class="sxs-lookup"><span data-stu-id="e0791-150">Because of the intensive mathematics involved, encryption and decryption of data using an asymmetric cipher that depends on a key pair can be up to 1,000 times slower than encryption and decryption using a symmetric cipher that depends only on a single key.</span></span> <span data-ttu-id="e0791-151">Par conséquent, TLS utilise une infrastructure à clé publique uniquement pour générer des signatures numériques et pour négocier la clé unique spécifique à la session qui sera utilisée par le client et le serveur pour le chiffrement et le déchiffrement des données en bloc.</span><span class="sxs-lookup"><span data-stu-id="e0791-151">TLS therefore uses a PKI only for generating digital signatures and for negotiating the session-specific single key that will be used by both the client and the server for bulk data encryption and decryption.</span></span> <span data-ttu-id="e0791-152">Le protocole TLS prend en charge une grande variété de chiffrements symétriques à une seule clé, et des chiffrements supplémentaires peuvent être ajoutés à l’avenir.</span><span class="sxs-lookup"><span data-stu-id="e0791-152">TLS supports a wide variety of single-key symmetric ciphers, and additional ciphers may be added in the future.</span></span>

<span data-ttu-id="e0791-153">Pour plus d’informations sur le protocole de négociation TLS, consultez [protocole de négociation TLS](/windows/desktop/SecAuthN/tls-handshake-protocol).</span><span class="sxs-lookup"><span data-stu-id="e0791-153">For more information about the TLS handshake protocol, see [TLS Handshake Protocol](/windows/desktop/SecAuthN/tls-handshake-protocol).</span></span>

<span data-ttu-id="e0791-154">Pour plus d’informations sur le chiffrement derrière le protocole TLS, consultez la page sur la [cryptographie Essentials](/windows/desktop/SecCrypto/cryptography-essentials).</span><span class="sxs-lookup"><span data-stu-id="e0791-154">For more details regarding the cryptography behind the TLS protocol, see [Cryptography Essentials](/windows/desktop/SecCrypto/cryptography-essentials).</span></span>

## <a name="x509-certificates"></a><span data-ttu-id="e0791-155">Certificats X.509</span><span class="sxs-lookup"><span data-stu-id="e0791-155">X.509 Certificates</span></span>

<span data-ttu-id="e0791-156">Un problème critique qui doit être traité par une infrastructure à clé publique est la possibilité d’approuver l’authenticité de la clé publique utilisée.</span><span class="sxs-lookup"><span data-stu-id="e0791-156">A critical issue that must be handled by a PKI is the ability to trust the authenticity of the public key that is being used.</span></span> <span data-ttu-id="e0791-157">Lorsque vous utilisez une clé publique émise pour une société avec laquelle vous souhaitez faire des affaires, vous devez être certain que la clé appartient réellement à la société plutôt qu’à un voleur qui souhaite découvrir le numéro de votre carte de crédit.</span><span class="sxs-lookup"><span data-stu-id="e0791-157">When you use a public key issued to a company that you want to do business with, you want to be certain that the key actually belongs to the company rather than to a thief who wants to discover your credit card number.</span></span>

<span data-ttu-id="e0791-158">Pour garantir l’identité d’un principal contenant une paire de clés, un certificat X. 509 est émis par une autorité de certification (CA).</span><span class="sxs-lookup"><span data-stu-id="e0791-158">To guarantee the identity of a principal holding a key pair, the principal is issued an X.509 certificate by a certification authority (CA).</span></span> <span data-ttu-id="e0791-159">Ce certificat contient des informations qui identifient le principal, contient la clé publique du principal et est signée numériquement par l’autorité de certification.</span><span class="sxs-lookup"><span data-stu-id="e0791-159">This certificate contains information that identifies the principal, contains the principal's public key, and is digitally signed by the CA.</span></span> <span data-ttu-id="e0791-160">Cette signature numérique indique que l’autorité de certification pense que la clé publique contenue dans le certificat appartient véritablement au principal identifié par le certificat.</span><span class="sxs-lookup"><span data-stu-id="e0791-160">This digital signature indicates that the CA believes that the public key contained in the certificate truly belongs to the principal identified by the certificate.</span></span>

<span data-ttu-id="e0791-161">Et comment faire confiance à l’autorité de certification ?</span><span class="sxs-lookup"><span data-stu-id="e0791-161">And how do you trust the CA?</span></span> <span data-ttu-id="e0791-162">Étant donné que l’autorité de certification contient un certificat X. 509 qui a été signé par une autorité de certification de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="e0791-162">Because the CA itself holds an X.509 certificate that has been signed by a higher-level CA.</span></span> <span data-ttu-id="e0791-163">Cette chaîne de signatures de certificat se poursuit jusqu’à ce qu’elle atteigne une autorité de certification racine, qui est une autorité de certification qui signe ses propres certificats.</span><span class="sxs-lookup"><span data-stu-id="e0791-163">This chain of certificate signatures continues until it reaches a root CA, which is a CA that signs its own certificates.</span></span> <span data-ttu-id="e0791-164">Si vous faites confiance à l’intégrité de l’autorité de certification racine d’un certificat, vous devez être en mesure de faire confiance à l’authenticité du certificat.</span><span class="sxs-lookup"><span data-stu-id="e0791-164">If you trust the integrity of the root CA of a certificate, you should be able to trust the authenticity of the certificate itself.</span></span> <span data-ttu-id="e0791-165">Par conséquent, le choix des autorités de certification racine que vous êtes prêt à approuver est un droit important pour un administrateur système.</span><span class="sxs-lookup"><span data-stu-id="e0791-165">Therefore, picking root CAs that you are willing to trust is an important duty for a system administrator.</span></span>

### <a name="client-certificates"></a><span data-ttu-id="e0791-166">Certificats clients</span><span class="sxs-lookup"><span data-stu-id="e0791-166">Client Certificates</span></span>

<span data-ttu-id="e0791-167">Lors de la première apparition des protocoles de couche de transport de sécurité, leur objectif principal était de garantir qu’un client se connectait à un serveur authentique et contribue à protéger la confidentialité des données pendant leur transit.</span><span class="sxs-lookup"><span data-stu-id="e0791-167">When security transport-layer protocols first emerged, their primary purpose was to guarantee that a client was connecting to an authentic server and help protect the privacy of data while in transit.</span></span> <span data-ttu-id="e0791-168">Toutefois, SSL 3,0 et TLS 1,0 incluent également la prise en charge de la transmission du certificat d’un client pendant la négociation du protocole.</span><span class="sxs-lookup"><span data-stu-id="e0791-168">However, SSL 3.0 and TLS 1.0 also include support for the transmission of a client's certificate during the protocol's handshake.</span></span> <span data-ttu-id="e0791-169">Cette fonctionnalité facultative permet l’authentification mutuelle du client et du serveur.</span><span class="sxs-lookup"><span data-stu-id="e0791-169">This optional feature enables the mutual authentication of the client and server.</span></span>

<span data-ttu-id="e0791-170">La décision d’utiliser un certificat client doit être prise dans le contexte de l’application.</span><span class="sxs-lookup"><span data-stu-id="e0791-170">The decision of whether to use a client certificate should be made in the context of the application.</span></span> <span data-ttu-id="e0791-171">Les certificats clients ne sont pas nécessaires si la condition principale consiste à authentifier le serveur.</span><span class="sxs-lookup"><span data-stu-id="e0791-171">Client certificates are unnecessary if the primary requirement is authenticating the server.</span></span> <span data-ttu-id="e0791-172">Toutefois, si l’authentification du client est essentielle, le certificat d’un client peut être utilisé au lieu de s’appuyer sur l’authentification personnalisée au sein de l’application.</span><span class="sxs-lookup"><span data-stu-id="e0791-172">However, if client authentication is essential, a client's certificate can be used rather than relying on custom authentication within the application.</span></span> <span data-ttu-id="e0791-173">L’utilisation de certificats clients est préférable à l’authentification personnalisée, car elle fournit aux utilisateurs un scénario d’authentification unique.</span><span class="sxs-lookup"><span data-stu-id="e0791-173">Using client certificates is preferable over custom authentication because it gives users a single sign-on scenario.</span></span>

## <a name="using-tls-in-com"></a><span data-ttu-id="e0791-174">Utilisation de TLS dans COM</span><span class="sxs-lookup"><span data-stu-id="e0791-174">Using TLS in COM</span></span>

<span data-ttu-id="e0791-175">TLS prend en charge uniquement le niveau d’emprunt d’identité emprunter l’identité (emprunt d’identité du \_ \_ \_ niveau d’IMP RPC \_ ).</span><span class="sxs-lookup"><span data-stu-id="e0791-175">TLS supports only the impersonate (RPC\_C\_IMP\_LEVEL\_IMPERSONATE) level of impersonation.</span></span> <span data-ttu-id="e0791-176">Si COM négocie TLS en tant que service d’authentification sur un proxy, COM définit le niveau d’emprunt d’identité sur emprunter l’identité, quelle que soit la valeur par défaut du processus.</span><span class="sxs-lookup"><span data-stu-id="e0791-176">If COM negotiates TLS as the authentication service on a proxy, COM will set the impersonation level to impersonate regardless of the process default.</span></span> <span data-ttu-id="e0791-177">Pour que l’emprunt d’identité fonctionne correctement dans TLS, le client doit fournir un certificat X. 509 au serveur et le serveur doit avoir ce certificat mappé à un compte d’utilisateur particulier sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="e0791-177">For impersonation to work properly in TLS, the client must provide an X.509 certificate to the server and the server must have that certificate mapped to a particular user account on the server.</span></span> <span data-ttu-id="e0791-178">Pour plus d’informations, consultez le [Guide pas à pas de mappage des certificats aux comptes d’utilisateur](https://www.microsoft.com/isapi/redir.dll?prd=windows2000&sbp=technicallibrary&ar=security&sba=mappingcertificates).</span><span class="sxs-lookup"><span data-stu-id="e0791-178">For more information, see the [Step-by-Step Guide to Mapping Certificates to User Accounts](https://www.microsoft.com/isapi/redir.dll?prd=windows2000&sbp=technicallibrary&ar=security&sba=mappingcertificates).</span></span>

<span data-ttu-id="e0791-179">TLS ne prend pas en charge le [masquage](cloaking.md).</span><span class="sxs-lookup"><span data-stu-id="e0791-179">TLS does not support [cloaking](cloaking.md).</span></span> <span data-ttu-id="e0791-180">Si un indicateur de masquage et un TLS sont spécifiés dans un appel [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) ou [**IClientSecurity :: SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) , E \_ INVALIDARG est retourné.</span><span class="sxs-lookup"><span data-stu-id="e0791-180">If a cloaking flag and TLS are specified in a [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) or a [**IClientSecurity::SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) call, E\_INVALIDARG will be returned.</span></span>

<span data-ttu-id="e0791-181">TLS ne fonctionne pas avec le niveau d’authentification défini sur aucun.</span><span class="sxs-lookup"><span data-stu-id="e0791-181">TLS does not work with the authentication level set to None.</span></span> <span data-ttu-id="e0791-182">Le protocole de transfert entre le client et le serveur examine le niveau d’authentification défini par chaque et choisit le paramètre de sécurité plus élevé pour la connexion.</span><span class="sxs-lookup"><span data-stu-id="e0791-182">The handshake between the client and server examines the authentication level set by each and chooses the higher security setting for the connection.</span></span>

<span data-ttu-id="e0791-183">Les paramètres de sécurité pour TLS peuvent être définis en appelant [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) et [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket).</span><span class="sxs-lookup"><span data-stu-id="e0791-183">The security parameters for TLS can be set by calling [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) and [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket).</span></span> <span data-ttu-id="e0791-184">Les sections suivantes décrivent les nuances impliquées dans l’exécution de ces appels.</span><span class="sxs-lookup"><span data-stu-id="e0791-184">The following sections describe the nuances involved in making those calls.</span></span>

### <a name="how-a-server-sets-the-security-blanket"></a><span data-ttu-id="e0791-185">Comment un serveur définit la couverture de sécurité</span><span class="sxs-lookup"><span data-stu-id="e0791-185">How a Server Sets the Security Blanket</span></span>

<span data-ttu-id="e0791-186">Si un serveur souhaite utiliser TLS, il doit spécifier Schannel (RPC \_ C \_ Authn \_ GSS \_ Schannel) comme service d’authentification dans le paramètre *asAuthSvc* de [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span><span class="sxs-lookup"><span data-stu-id="e0791-186">If a server wants to use TLS, it must specify Schannel (RPC\_C\_AUTHN\_GSS\_SCHANNEL) as an authentication service in the *asAuthSvc* parameter of [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span></span> <span data-ttu-id="e0791-187">Pour empêcher les clients de se connecter au serveur à l’aide d’un service d’authentification moins sécurisé, le serveur doit spécifier uniquement Schannel comme service d’authentification lorsqu’il appelle **CoInitializeSecurity**.</span><span class="sxs-lookup"><span data-stu-id="e0791-187">To prevent clients from connecting to the server by using a less secure authentication service, the server should specify only Schannel as an authentication service when it calls **CoInitializeSecurity**.</span></span> <span data-ttu-id="e0791-188">Le serveur ne peut pas modifier la couverture de sécurité après avoir appelé **CoInitializeSecurity**.</span><span class="sxs-lookup"><span data-stu-id="e0791-188">The server cannot change the security blanket after it has called **CoInitializeSecurity**.</span></span>

<span data-ttu-id="e0791-189">Pour utiliser TLS, les paramètres suivants doivent être spécifiés lorsqu’un serveur appelle [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity):</span><span class="sxs-lookup"><span data-stu-id="e0791-189">To use TLS, the following parameters should be specified when a server calls [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity):</span></span>

-   <span data-ttu-id="e0791-190">*pVoid* doit être un pointeur vers un objet [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) ou un pointeur vers un [**\_ descripteur de sécurité**](/windows/desktop/api/winnt/ns-winnt-security_descriptor).</span><span class="sxs-lookup"><span data-stu-id="e0791-190">*pVoid* should be either a pointer to an [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) object or a pointer to a [**SECURITY\_DESCRIPTOR**](/windows/desktop/api/winnt/ns-winnt-security_descriptor).</span></span> <span data-ttu-id="e0791-191">Elle ne doit pas être **null** ou un pointeur vers une AppID.</span><span class="sxs-lookup"><span data-stu-id="e0791-191">It should not be **NULL** or a pointer to an AppID.</span></span>
-   <span data-ttu-id="e0791-192">*cAuthSvc* ne peut pas avoir la valeur 0 ou-1.</span><span class="sxs-lookup"><span data-stu-id="e0791-192">*cAuthSvc* cannot be 0 or -1.</span></span> <span data-ttu-id="e0791-193">Les serveurs COM ne sélectionnent jamais Schannel quand *cAuthSvc* est-1.</span><span class="sxs-lookup"><span data-stu-id="e0791-193">COM servers never chooses Schannel when *cAuthSvc* is -1.</span></span>
-   <span data-ttu-id="e0791-194">*asAuthSvc* doit spécifier Schannel comme service d’authentification possible.</span><span class="sxs-lookup"><span data-stu-id="e0791-194">*asAuthSvc* must specify Schannel as a possible authentication service.</span></span> <span data-ttu-id="e0791-195">Pour ce faire, définissez les paramètres [**de \_ \_ service d’authentification unique**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_service) suivants pour le membre Schannel de la [**seule \_ \_ liste d’authentification**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_list):</span><span class="sxs-lookup"><span data-stu-id="e0791-195">This is done by setting the following [**SOLE\_AUTHENTICATION\_SERVICE**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_service) parameters for the Schannel member of the [**SOLE\_AUTHENTICATION\_LIST**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_list):</span></span>
    -   <span data-ttu-id="e0791-196">*dwAuthnSvc* doit être RPC \_ C \_ Authn \_ GSS \_ Schannel.</span><span class="sxs-lookup"><span data-stu-id="e0791-196">*dwAuthnSvc* must be RPC\_C\_AUTHN\_GSS\_SCHANNEL.</span></span>
    -   <span data-ttu-id="e0791-197">*dwAuthzSvc* doit avoir la valeur RPC \_ C \_ auth \_ aucun.</span><span class="sxs-lookup"><span data-stu-id="e0791-197">*dwAuthzSvc* should be RPC\_C\_AUTHZ\_NONE.</span></span> <span data-ttu-id="e0791-198">Actuellement, il est ignoré.</span><span class="sxs-lookup"><span data-stu-id="e0791-198">Currently, it is ignored.</span></span>
    -   <span data-ttu-id="e0791-199">*pPrincipalName* doit être un pointeur vers un [**\_ contexte de certificat**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), casté en un pointeur vers OLECHAR, qui représente le certificat X. 509 du serveur.</span><span class="sxs-lookup"><span data-stu-id="e0791-199">*pPrincipalName* must be a pointer to a [**CERT\_CONTEXT**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), cast as a pointer to OLECHAR, which represents the server's X.509 certificate.</span></span>
-   <span data-ttu-id="e0791-200">*dwAuthnLevel* indique le niveau d’authentification minimal qui sera accepté par les clients pour une connexion réussie.</span><span class="sxs-lookup"><span data-stu-id="e0791-200">*dwAuthnLevel* indicates the minimum authentication level that will be accepted from clients for a successful connection.</span></span> <span data-ttu-id="e0791-201">Il ne peut pas s’agir du \_ niveau d’authentification RPC C \_ \_ \_ None.</span><span class="sxs-lookup"><span data-stu-id="e0791-201">It cannot be RPC\_C\_AUTHN\_LEVEL\_NONE.</span></span>
-   <span data-ttu-id="e0791-202">*dwCapabilities* ne doit pas avoir l' \_ indicateur EOAC AppID défini.</span><span class="sxs-lookup"><span data-stu-id="e0791-202">*dwCapabilities* should not have the EOAC\_APPID flag set.</span></span> <span data-ttu-id="e0791-203">L' \_ \_ indicateur de contrôle d’accès EOAC doit être défini si *pVoid* pointe vers un objet [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) ; il ne doit pas être défini si *pVoid* pointe vers un \_ descripteur de sécurité.</span><span class="sxs-lookup"><span data-stu-id="e0791-203">The EOAC\_ACCESS\_CONTROL flag should be set if *pVoid* points to an [**IAccessControl**](/windows/desktop/api/IAccess/nn-iaccess-iaccesscontrol) object; it should not be set if *pVoid* points to a SECURITY\_DESCRIPTOR.</span></span> <span data-ttu-id="e0791-204">Pour les autres indicateurs qui peuvent être définis, consultez [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span><span class="sxs-lookup"><span data-stu-id="e0791-204">For other flags that may be set, see [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span></span>

<span data-ttu-id="e0791-205">Pour plus d’informations sur l’utilisation de [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), consultez Définition de la [sécurité échelle avec CoInitializeSecurity](setting-processwide-security-with-coinitializesecurity.md).</span><span class="sxs-lookup"><span data-stu-id="e0791-205">For more information about using [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), see [Setting Processwide Security with CoInitializeSecurity](setting-processwide-security-with-coinitializesecurity.md).</span></span>

### <a name="how-a-client-sets-the-security-blanket"></a><span data-ttu-id="e0791-206">Comment un client définit la couverture de sécurité</span><span class="sxs-lookup"><span data-stu-id="e0791-206">How a Client Sets the Security Blanket</span></span>

<span data-ttu-id="e0791-207">Si un client souhaite utiliser TLS, il doit spécifier Schannel (RPC \_ C \_ Authn \_ GSS \_ Schannel) dans sa liste de services d’authentification dans le paramètre *pAuthList* de [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span><span class="sxs-lookup"><span data-stu-id="e0791-207">If a client wants to use TLS, it must specify Schannel (RPC\_C\_AUTHN\_GSS\_SCHANNEL) in its list of authentication services in the *pAuthList* parameter of [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity).</span></span> <span data-ttu-id="e0791-208">Si Schannel n’est pas spécifié comme un service d’authentification possible lorsque la fonction **CoInitializeSecurity** est appelée, un appel ultérieur à [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket) (ou [**IClientSecurity :: SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket)) échouera s’il tente de spécifier Schannel comme service d’authentification.</span><span class="sxs-lookup"><span data-stu-id="e0791-208">If Schannel is not specified as a possible authentication service when **CoInitializeSecurity** is called, a later call to [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket) (or [**IClientSecurity::SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket)) will fail if it tries to specify Schannel as the authentication service.</span></span>

<span data-ttu-id="e0791-209">Les paramètres suivants doivent être spécifiés lorsqu’un client appelle [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity):</span><span class="sxs-lookup"><span data-stu-id="e0791-209">The following parameters should be specified when a client calls [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity):</span></span>

-   <span data-ttu-id="e0791-210">*dwAuthnLevel* spécifie le niveau d’authentification par défaut que le client souhaite utiliser.</span><span class="sxs-lookup"><span data-stu-id="e0791-210">*dwAuthnLevel* specifies the default authentication level that the client wants to use.</span></span> <span data-ttu-id="e0791-211">Il ne peut pas s’agir du \_ niveau d’authentification RPC C \_ \_ \_ None.</span><span class="sxs-lookup"><span data-stu-id="e0791-211">It cannot be RPC\_C\_AUTHN\_LEVEL\_NONE.</span></span>
-   <span data-ttu-id="e0791-212">*dwImpLevel* doit être l' \_ emprunt d’identité RPC C \_ IMP \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="e0791-212">*dwImpLevel* must be RPC\_C\_IMP\_LEVEL\_IMPERSONATE.</span></span>
-   <span data-ttu-id="e0791-213">*pAuthList* doit avoir les [**seuls paramètres \_ d' \_ informations d’authentification**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_info) suivants en tant que membre de la liste :</span><span class="sxs-lookup"><span data-stu-id="e0791-213">*pAuthList* must have the following [**SOLE\_AUTHENTICATION\_INFO**](/windows/win32/api/objidlbase/ns-objidlbase-sole_authentication_info) parameters as a member of the list:</span></span>
    -   <span data-ttu-id="e0791-214">*dwAuthnSvc* doit être RPC \_ C \_ Authn \_ GSS \_ Schannel.</span><span class="sxs-lookup"><span data-stu-id="e0791-214">*dwAuthnSvc* must be RPC\_C\_AUTHN\_GSS\_SCHANNEL.</span></span>
    -   <span data-ttu-id="e0791-215">*dwAuthzSvc* doit avoir la valeur RPC \_ C \_ auth \_ aucun.</span><span class="sxs-lookup"><span data-stu-id="e0791-215">*dwAuthzSvc* must be RPC\_C\_AUTHZ\_NONE.</span></span>
    -   <span data-ttu-id="e0791-216">*pAuthInfo* est un pointeur vers un [**\_ contexte de certificat**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), casté en un pointeur vers void, qui représente le certificat X. 509 du client.</span><span class="sxs-lookup"><span data-stu-id="e0791-216">*pAuthInfo* is a pointer to a [**CERT\_CONTEXT**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), cast as a pointer to void, which represents the client's X.509 certificate.</span></span> <span data-ttu-id="e0791-217">Si le client n’a pas de certificat ou s’il ne souhaite pas présenter son certificat au serveur, *pAuthInfo* doit avoir la **valeur null** et une connexion anonyme sera tentée avec le serveur.</span><span class="sxs-lookup"><span data-stu-id="e0791-217">If the client does not have a certificate or does not wish to present its certificate to the server, *pAuthInfo* must be **NULL** and an anonymous connection will be attempted with the server.</span></span>
-   <span data-ttu-id="e0791-218">*dwCapabilities* est un ensemble d’indicateurs qui indiquent des fonctionnalités supplémentaires du client.</span><span class="sxs-lookup"><span data-stu-id="e0791-218">*dwCapabilities* is a set of flags that indicate additional client capabilities.</span></span> <span data-ttu-id="e0791-219">Consultez [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) pour plus d’informations sur les indicateurs à définir.</span><span class="sxs-lookup"><span data-stu-id="e0791-219">See [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity) for information about which flags should be set.</span></span>

<span data-ttu-id="e0791-220">Pour plus d’informations sur l’utilisation de [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), consultez Définition de la [sécurité échelle avec CoInitializeSecurity](setting-processwide-security-with-coinitializesecurity.md).</span><span class="sxs-lookup"><span data-stu-id="e0791-220">For more information about using [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), see [Setting Processwide Security with CoInitializeSecurity](setting-processwide-security-with-coinitializesecurity.md).</span></span>

### <a name="how-a-client-changes-the-security-blanket"></a><span data-ttu-id="e0791-221">Modification de la couverture de sécurité par un client</span><span class="sxs-lookup"><span data-stu-id="e0791-221">How a Client Changes the Security Blanket</span></span>

<span data-ttu-id="e0791-222">Si un client souhaite utiliser TLS mais modifier la couverture de sécurité après avoir appelé [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), il doit appeler [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket) ou [**IClientSecurity :: SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) avec des paramètres similaires à ceux utilisés dans l’appel à **CoInitializeSecurity**, avec les différences suivantes :</span><span class="sxs-lookup"><span data-stu-id="e0791-222">If a client wants to use TLS but change the security blanket after calling [**CoInitializeSecurity**](/windows/desktop/api/combaseapi/nf-combaseapi-coinitializesecurity), it must call either [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket) or [**IClientSecurity::SetBlanket**](/windows/win32/api/objidl/nf-objidl-iclientsecurity-setblanket) with parameters similar to those used in the call to **CoInitializeSecurity**, with the following differences:</span></span>

-   <span data-ttu-id="e0791-223">*pServerPrincName* indique le nom principal du serveur, au format msstd ou fullsic.</span><span class="sxs-lookup"><span data-stu-id="e0791-223">*pServerPrincName* indicates the principal name of the server, in either msstd or fullsic format.</span></span> <span data-ttu-id="e0791-224">Pour plus d’informations sur ces formats, consultez [noms principaux](/windows/desktop/Rpc/principal-names).</span><span class="sxs-lookup"><span data-stu-id="e0791-224">For information on these formats, see [Principal Names](/windows/desktop/Rpc/principal-names).</span></span> <span data-ttu-id="e0791-225">Si le client possède le certificat X. 509 du serveur, il peut trouver le nom principal en appelant [**RpcCertGeneratePrincipalName**](/windows/desktop/api/rpcssl/nf-rpcssl-rpccertgenerateprincipalname).</span><span class="sxs-lookup"><span data-stu-id="e0791-225">If the client has the server's X.509 certificate, it can find the principal name by calling [**RpcCertGeneratePrincipalName**](/windows/desktop/api/rpcssl/nf-rpcssl-rpccertgenerateprincipalname).</span></span>
-   <span data-ttu-id="e0791-226">*pAuthInfo* est un pointeur vers un [**\_ contexte de certificat**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), casté en un pointeur vers un \_ handle d’identité d’authentification RPC \_ \_ , qui représente le certificat X. 509 du client.</span><span class="sxs-lookup"><span data-stu-id="e0791-226">*pAuthInfo* is a pointer to a [**CERT\_CONTEXT**](/windows/desktop/api/wincrypt/ns-wincrypt-cert_context), cast as a pointer to RPC\_AUTH\_IDENTITY\_HANDLE, which represents the client's X.509 certificate.</span></span> <span data-ttu-id="e0791-227">Si le client n’a pas de certificat ou s’il ne souhaite pas présenter son certificat au serveur, *pAuthInfo* doit avoir la **valeur null** et une connexion anonyme sera tentée avec le serveur.</span><span class="sxs-lookup"><span data-stu-id="e0791-227">If the client does not have a certificate or does not wish to present its certificate to the server, *pAuthInfo* must be **NULL** and an anonymous connection will be attempted with the server.</span></span>
-   <span data-ttu-id="e0791-228">*dwCapabilities* se compose d’indicateurs qui indiquent des fonctionnalités supplémentaires du client.</span><span class="sxs-lookup"><span data-stu-id="e0791-228">*dwCapabilities* consists of flags that indicate additional client capabilities.</span></span> <span data-ttu-id="e0791-229">Seuls quatre indicateurs peuvent être utilisés pour modifier les paramètres de couverture de sécurité : EOAC \_ par défaut, EOAC \_ \_ l’authentification mutuelle, EOAC \_ n’importe quelle \_ autorité (cet indicateur est déconseillé) et EOAC \_ rendre \_ FULLSIC.</span><span class="sxs-lookup"><span data-stu-id="e0791-229">Only four flags can be used to change security blanket settings: EOAC\_DEFAULT, EOAC\_MUTUAL\_AUTH, EOAC\_ANY\_AUTHORITY (this flag is deprecated), and EOAC\_MAKE\_FULLSIC.</span></span> <span data-ttu-id="e0791-230">Pour plus d’informations, consultez [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket).</span><span class="sxs-lookup"><span data-stu-id="e0791-230">For more information, see [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket).</span></span>

<span data-ttu-id="e0791-231">Pour plus d’informations sur l’utilisation de [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket), consultez [définition de la sécurité au niveau du proxy de l’interface](setting-security-at-the-interface-proxy-level.md).</span><span class="sxs-lookup"><span data-stu-id="e0791-231">For more information about using [**CoSetProxyBlanket**](/windows/desktop/api/combaseapi/nf-combaseapi-cosetproxyblanket), see [Setting Security at the Interface Proxy Level](setting-security-at-the-interface-proxy-level.md).</span></span>

### <a name="example-client-changes-the-security-blanket"></a><span data-ttu-id="e0791-232">Exemple : le client modifie la couverture de sécurité</span><span class="sxs-lookup"><span data-stu-id="e0791-232">Example: Client Changes the Security Blanket</span></span>

<span data-ttu-id="e0791-233">L’exemple suivant montre comment un client peut modifier la couverture de sécurité pour s’adapter à une demande du serveur pour que le client fournisse son certificat X. 509.</span><span class="sxs-lookup"><span data-stu-id="e0791-233">The following example demonstrates how a client can change the security blanket to accommodate a request from the server for the client to provide its X.509 certificate.</span></span> <span data-ttu-id="e0791-234">Le code de gestion des erreurs est omis par souci de concision.</span><span class="sxs-lookup"><span data-stu-id="e0791-234">Error handling code is omitted for brevity.</span></span>


```C++
void ClientChangesSecurity ()
{
  HCRYPTPROV                   provider           = 0;
  HCERTSTORE                   cert_store         = NULL;
  PCCERT_CONTEXT               client_cert        = NULL;
  PCCERT_CONTEXT               server_cert        = NULL;
  WCHAR                        *server_princ_name = NULL;
  ISecret                      *pSecret           = NULL;
  MULTI_QI                     server_instance;
  COSERVERINFO                 server_machine;
  SOLE_AUTHENTICATION_LIST     auth_list;
  SOLE_AUTHENTICATION_INFO     auth_info[1];



  // Specify all the authentication info. 
  // The client is willing to connect using SChannel,
  //   with no client certificate.
  auth_list.cAuthInfo     = 1;
  auth_list.aAuthInfo     = auth_info;
  auth_info[0].dwAuthnSvc = RPC_C_AUTHN_GSS_SCHANNEL;
  auth_info[0].dwAuthzSvc = RPC_C_AUTHZ_NONE;
  auth_info[0].pAuthInfo  = NULL;  // No certificate

  // Initialize client security with no client certificate.
  CoInitializeSecurity( NULL, -1, NULL, NULL,
                        RPC_C_AUTHN_LEVEL_PKT,
                        RPC_C_IMP_LEVEL_IMPERSONATE, &auth_list,
                        EOAC_NONE, NULL );
  
  // Specify info for the proxy.
  server_instance = {&IID_ISecret, NULL, S_OK};
  server_machine  = {0, L"ServerMachineName", NULL, 0};
  
  // Create a proxy.
  CoCreateInstanceEx( CLSID_Secret, NULL, CLSCTX_REMOTE_SERVER, 
                      &server_machine, 1, &server_instance);
  pSecret = (ISecret *) server_instance.pItf;

  //** The client obtained the server's certificate during the handshake.
  //** The server requests a certificate from the client.

  // Get the default certificate provider.
  CryptAcquireContext( &provider, NULL, NULL, PROV_RSA_SCHANNEL, 0 );

  // Open the certificate store.
  cert_store = CertOpenSystemStore( provider, L"my" );

  // Find the client's certificate.
  client_cert = 
    CertFindCertificateInStore( cert_store,
                                X509_ASN_ENCODING | PKCS_7_ASN_ENCODING,
                                0,
                                CERT_FIND_SUBJECT_STR,
                                L"ClientName",  // Use the principal name
                                NULL );

  // Find the fullsic principal name of the server.
  RpcCertGeneratePrincipalName( server_cert, RPC_C_FULL_CERT_CHAIN, 
                                &server_princ_name );

  // Change the client's security: 
  // Increase the authentication level and attach a certificate.
  CoSetProxyBlanket( pSecret, RPC_C_AUTHN_GSS_SCHANNEL,
                     RPC_C_AUTHZ_NONE,
                     server_princ_name, RPC_C_AUTHN_LEVEL_PKT_PRIVACY,
                     RPC_C_IMP_LEVEL_IMPERSONATE, 
                     (RPC_AUTH_IDENTITY_HANDLE *) client_cert,
                     EOAC_NONE );

  cleanup:
  if (server_princ_name != NULL)
    RpcStringFree( &server_princ_name );
  if (client_cert != NULL)
    CertFreeCertificateContext(client_cert);
  if (server_cert != NULL)
    CertFreeCertificateContext(server_cert);
  if (cert_store != NULL)
    CertCloseStore( cert_store, CERT_CLOSE_STORE_CHECK_FLAG );
  if (provider != 0 )
    CryptReleaseContext( provider, 0 );
  if (pSecret != NULL)
    pSecret->Release();
  CoUninitialize();
}
```



## <a name="related-topics"></a><span data-ttu-id="e0791-235">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="e0791-235">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="e0791-236">Packages COM et de sécurité</span><span class="sxs-lookup"><span data-stu-id="e0791-236">COM and Security Packages</span></span>](com-and-security-packages.md)
</dt> </dl>

 

 