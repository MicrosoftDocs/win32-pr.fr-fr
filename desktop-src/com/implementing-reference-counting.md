---
title: Implémentation du décompte de références
description: Implémentation du décompte de références
ms.assetid: d4fd98c9-afa4-4c5c-a3c9-44d34881cbdb
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a0d4dfe2b0faf2fc6557d1b089e33ae6ce4b98cb
ms.sourcegitcommit: 5f33645661bf8c825a7a2e73950b1f4ea0f1cd82
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/21/2020
ms.locfileid: "106509685"
---
# <a name="implementing-reference-counting"></a><span data-ttu-id="5adc7-103">Implémentation du décompte de références</span><span class="sxs-lookup"><span data-stu-id="5adc7-103">Implementing Reference Counting</span></span>

<span data-ttu-id="5adc7-104">Le décompte de références requiert un travail sur la partie de l’implémenteur d’une classe et des clients qui utilisent des objets de cette classe.</span><span class="sxs-lookup"><span data-stu-id="5adc7-104">Reference counting requires work on the part of both the implementor of a class and the clients who use objects of that class.</span></span> <span data-ttu-id="5adc7-105">Lorsque vous implémentez une classe, vous devez implémenter les méthodes [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) et [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) dans le cadre de l’interface [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown) .</span><span class="sxs-lookup"><span data-stu-id="5adc7-105">When you implement a class, you must implement the [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) and [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) methods as part of the [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown) interface.</span></span> <span data-ttu-id="5adc7-106">Ces deux méthodes ont les implémentations simples suivantes :</span><span class="sxs-lookup"><span data-stu-id="5adc7-106">These two methods have the following simple implementations:</span></span>

-   <span data-ttu-id="5adc7-107">[**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) incrémente le décompte de références internes de l’objet.</span><span class="sxs-lookup"><span data-stu-id="5adc7-107">[**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) increments the object's internal reference count.</span></span>
-   <span data-ttu-id="5adc7-108">[**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) First décrémente le décompte de références internes de l’objet, puis vérifie si le nombre de références est tombé à zéro.</span><span class="sxs-lookup"><span data-stu-id="5adc7-108">[**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) first decrements the object's internal reference count, and then it checks whether the reference count has fallen to zero.</span></span> <span data-ttu-id="5adc7-109">Si c’est le cas, cela signifie que personne n’utilise plus l’objet, donc la fonction **Release** libère l’objet.</span><span class="sxs-lookup"><span data-stu-id="5adc7-109">If it has, that means no one is using the object any longer, so the **Release** function deallocates the object.</span></span>

<span data-ttu-id="5adc7-110">Une approche d’implémentation courante pour la plupart des objets consiste à avoir une seule implémentation de ces méthodes (avec [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q))), qui est partagée entre toutes les interfaces et, par conséquent, un nombre de références qui s’applique à l’ensemble de l’objet.</span><span class="sxs-lookup"><span data-stu-id="5adc7-110">A common implementation approach for most objects is to have only one implementation of these methods (along with [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q))), which is shared between all interfaces, and therefore a reference count that applies to the entire object.</span></span> <span data-ttu-id="5adc7-111">Toutefois, du point de vue du client, le décompte de références est strictement et clairement une notion par pointeur d’interface. par conséquent, les objets qui tirent parti de cette fonctionnalité en construisant, détruisant, chargent ou déchargent de façon dynamique des parties de leur fonctionnalité en fonction des pointeurs d’interface actuellement existants peuvent être implémentés.</span><span class="sxs-lookup"><span data-stu-id="5adc7-111">However, from a client's perspective, reference counting is strictly and clearly a per-interface-pointer notion, and therefore objects that take advantage of this capability by dynamically constructing, destroying, loading, or unloading portions of their functionality based on the currently extant interface pointers may be implemented.</span></span> <span data-ttu-id="5adc7-112">Il s’agit d' *interfaces de destruction*.</span><span class="sxs-lookup"><span data-stu-id="5adc7-112">These are colloquially called *tear-off interfaces*.</span></span>

<span data-ttu-id="5adc7-113">Chaque fois qu’un client appelle une méthode (ou une fonction API), telle que [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)), qui retourne un nouveau pointeur d’interface, la méthode appelée est chargée d’incrémenter le décompte de références via le pointeur retourné.</span><span class="sxs-lookup"><span data-stu-id="5adc7-113">Whenever a client calls a method (or API function), such as [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)), that returns a new interface pointer, the method being called is responsible for incrementing the reference count through the returned pointer.</span></span> <span data-ttu-id="5adc7-114">Par exemple, lorsqu’un client crée d’abord un objet, il reçoit un pointeur d’interface vers un objet qui, du point de vue du client, a un décompte de références d’un.</span><span class="sxs-lookup"><span data-stu-id="5adc7-114">For example, when a client first creates an object, it receives an interface pointer to an object that, from the client's point of view, has a reference count of one.</span></span> <span data-ttu-id="5adc7-115">Si le client appelle ensuite [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) sur le pointeur d’interface, le nombre de références devient deux.</span><span class="sxs-lookup"><span data-stu-id="5adc7-115">If the client then calls [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) on the interface pointer, the reference count becomes two.</span></span> <span data-ttu-id="5adc7-116">Le client doit appeler [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) deux fois sur le pointeur d’interface pour supprimer toutes ses références à l’objet.</span><span class="sxs-lookup"><span data-stu-id="5adc7-116">The client must call [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) twice on the interface pointer to drop all of its references to the object.</span></span>

<span data-ttu-id="5adc7-117">Un exemple de la façon dont les décomptes de références sont strictement par pointeur d’interface se produit lorsqu’un client appelle [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)) sur le premier pointeur pour une nouvelle interface ou la même interface.</span><span class="sxs-lookup"><span data-stu-id="5adc7-117">An example of how reference counts are strictly per-interface-pointer occurs when a client calls [**QueryInterface**](/windows/desktop/api/Unknwn/nf-unknwn-iunknown-queryinterface(q)) on the first pointer for either a new interface or the same interface.</span></span> <span data-ttu-id="5adc7-118">Dans l’un ou l’autre de ces cas, le client doit appeler une fois la [**mise en sortie**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) pour chaque pointeur.</span><span class="sxs-lookup"><span data-stu-id="5adc7-118">In either of these cases, the client is required to call [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) once for each pointer.</span></span> <span data-ttu-id="5adc7-119">COM ne requiert pas qu’un objet retourne le même pointeur lorsqu’il demande plusieurs fois la même interface.</span><span class="sxs-lookup"><span data-stu-id="5adc7-119">COM does not require that an object return the same pointer when asked for the same interface multiple times.</span></span> <span data-ttu-id="5adc7-120">(La seule exception est une requête vers [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown), qui identifie un objet à com.) Cela permet à l’implémentation d’objet de gérer efficacement les ressources.</span><span class="sxs-lookup"><span data-stu-id="5adc7-120">(The only exception to this is a query to [**IUnknown**](/windows/desktop/api/Unknwn/nn-unknwn-iunknown), which identifies an object to COM.) This allows the object implementation to manage resources efficiently.</span></span>

<span data-ttu-id="5adc7-121">La sécurité des threads est également un problème important dans l’implémentation de [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) et [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span><span class="sxs-lookup"><span data-stu-id="5adc7-121">Thread-safety is also an important issue in implementing [**AddRef**](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref) and [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span></span> <span data-ttu-id="5adc7-122">Pour plus d’informations, consultez [processus, threads et Apartments](processes--threads--and-apartments.md).</span><span class="sxs-lookup"><span data-stu-id="5adc7-122">For more information, see [Processes, Threads, and Apartments](processes--threads--and-apartments.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="5adc7-123">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="5adc7-123">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5adc7-124">Gestion des durées de vie des objets via le décompte de références</span><span class="sxs-lookup"><span data-stu-id="5adc7-124">Managing Object Lifetimes Through Reference Counting</span></span>](managing-object-lifetimes-through-reference-counting.md)
</dt> </dl>

 

 