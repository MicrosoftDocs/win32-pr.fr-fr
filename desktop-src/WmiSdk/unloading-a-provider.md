---
description: Une fois WMI terminé avec un fournisseur, le fournisseur est déchargé de la mémoire.
ms.assetid: 6116769f-3402-42b3-835d-9bdb0fc27ce0
ms.tgt_platform: multiple
title: Déchargement d’un fournisseur
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 123d8c4f6b9d9155cdc22dc435635466956bdb0a
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104528467"
---
# <a name="unloading-a-provider"></a><span data-ttu-id="7a101-103">Déchargement d’un fournisseur</span><span class="sxs-lookup"><span data-stu-id="7a101-103">Unloading a Provider</span></span>

<span data-ttu-id="7a101-104">Une fois WMI terminé avec un fournisseur, le fournisseur est déchargé de la mémoire.</span><span class="sxs-lookup"><span data-stu-id="7a101-104">After WMI is finished with a provider, it unloads the provider from memory.</span></span> <span data-ttu-id="7a101-105">La raison principale pour laquelle WMI décharge un fournisseur est de préserver les ressources système.</span><span class="sxs-lookup"><span data-stu-id="7a101-105">The primary reason WMI unloads a provider is to conserve system resources.</span></span> <span data-ttu-id="7a101-106">Par conséquent, vous devez ajouter du code qui permet à WMI de décharger votre fournisseur de manière efficace.</span><span class="sxs-lookup"><span data-stu-id="7a101-106">Therefore, you must add code that allows WMI to unload your provider in an efficient manner.</span></span> <span data-ttu-id="7a101-107">Le déchargement d’un fournisseur se fait depuis l’intervalle spécifié dans le contrôle du cache jusqu’à deux fois l’intervalle nécessaire pour WMI.</span><span class="sxs-lookup"><span data-stu-id="7a101-107">It takes anywhere from the interval specified in the cache control to twice that interval for WMI to unload a provider.</span></span>

<span data-ttu-id="7a101-108">WMI décharge un fournisseur de l’une des manières suivantes :</span><span class="sxs-lookup"><span data-stu-id="7a101-108">WMI unloads a provider in one of the following ways:</span></span>

-   <span data-ttu-id="7a101-109">Décharger un fournisseur une fois que le fournisseur a terminé les tâches qui lui sont affectées.</span><span class="sxs-lookup"><span data-stu-id="7a101-109">Unload a provider after the provider finishes the tasks given to it.</span></span>
-   <span data-ttu-id="7a101-110">Déchargez rapidement tous les fournisseurs lorsque l’utilisateur arrête le système.</span><span class="sxs-lookup"><span data-stu-id="7a101-110">Quickly unload all providers when the user shuts down the system.</span></span> <span data-ttu-id="7a101-111">Notez que WMI décharge les fournisseurs in-process lorsque le service WMI est arrêté à partir de la ligne de commande.</span><span class="sxs-lookup"><span data-stu-id="7a101-111">Note that WMI unloads in-process providers when the WMI service is shut down from the command line.</span></span>

<span data-ttu-id="7a101-112">Tandis que le premier scénario est plus courant, vous devez écrire votre fournisseur pour les deux possibilités.</span><span class="sxs-lookup"><span data-stu-id="7a101-112">While the first scenario is more common, you must write your provider for both possibilities.</span></span>

<span data-ttu-id="7a101-113">Les sections suivantes sont présentées dans cette rubrique :</span><span class="sxs-lookup"><span data-stu-id="7a101-113">The following sections are discussed in this topic:</span></span>

-   [<span data-ttu-id="7a101-114">Déchargement d’un fournisseur inactif</span><span class="sxs-lookup"><span data-stu-id="7a101-114">Unloading an Idle Provider</span></span>](#unloading-an-idle-provider)
-   [<span data-ttu-id="7a101-115">Accès à la durée d’inactivité d’un fournisseur</span><span class="sxs-lookup"><span data-stu-id="7a101-115">Accessing the Idle Time for a Provider</span></span>](#accessing-the-idle-time-for-a-provider)
-   [<span data-ttu-id="7a101-116">Déchargement d’un fournisseur qui est également un client WMI</span><span class="sxs-lookup"><span data-stu-id="7a101-116">Unloading a Provider That Is Also a WMI Client</span></span>](#unloading-a-provider-that-is-also-a-wmi-client)
-   [<span data-ttu-id="7a101-117">Déchargement d’un fournisseur pendant l’arrêt</span><span class="sxs-lookup"><span data-stu-id="7a101-117">Unloading a Provider During Shutdown</span></span>](#unloading-a-provider-during-shutdown)
-   [<span data-ttu-id="7a101-118">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="7a101-118">Related topics</span></span>](#related-topics)

## <a name="unloading-an-idle-provider"></a><span data-ttu-id="7a101-119">Déchargement d’un fournisseur inactif</span><span class="sxs-lookup"><span data-stu-id="7a101-119">Unloading an Idle Provider</span></span>

<span data-ttu-id="7a101-120">WMI effectue les actions suivantes lorsqu’il décharge un fournisseur inactif :</span><span class="sxs-lookup"><span data-stu-id="7a101-120">WMI performs the following actions when it unloads an idle provider:</span></span>

-   <span data-ttu-id="7a101-121">Détermine si le fournisseur est inactif.</span><span class="sxs-lookup"><span data-stu-id="7a101-121">Determines if the provider is idle.</span></span>

    <span data-ttu-id="7a101-122">WMI utilise la propriété **ClearAfter** pour déterminer la durée pendant laquelle un fournisseur peut rester inactif avant de décharger ce fournisseur.</span><span class="sxs-lookup"><span data-stu-id="7a101-122">WMI uses the **ClearAfter** property to determine how long a provider may stay idle before unloading that provider.</span></span> <span data-ttu-id="7a101-123">Pour plus d’informations, consultez [accès à la durée d’inactivité d’un fournisseur](#accessing-the-idle-time-for-a-provider).</span><span class="sxs-lookup"><span data-stu-id="7a101-123">For more information, see [Accessing the Idle Time for a Provider](#accessing-the-idle-time-for-a-provider).</span></span>

-   <span data-ttu-id="7a101-124">Appelle la méthode [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) du fournisseur.</span><span class="sxs-lookup"><span data-stu-id="7a101-124">Calls the [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) method of the provider.</span></span>

    <span data-ttu-id="7a101-125">Si le fournisseur était un fournisseur pur, alors [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) supprime complètement le fournisseur de la mémoire active.</span><span class="sxs-lookup"><span data-stu-id="7a101-125">If the provider was a pure provider, then [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) completely removes the provider from active memory.</span></span> <span data-ttu-id="7a101-126">Toutefois, un fournisseur qui n’est pas pur peut continuer à s’exécuter après l’appel de la **version** WMI.</span><span class="sxs-lookup"><span data-stu-id="7a101-126">However, a nonpure provider may continue to run after WMI calls **Release**.</span></span>

## <a name="accessing-the-idle-time-for-a-provider"></a><span data-ttu-id="7a101-127">Accès à la durée d’inactivité d’un fournisseur</span><span class="sxs-lookup"><span data-stu-id="7a101-127">Accessing the Idle Time for a Provider</span></span>

<span data-ttu-id="7a101-128">La durée minimale pendant laquelle un fournisseur reste actif est déterminée par la propriété **ClearAfter** .</span><span class="sxs-lookup"><span data-stu-id="7a101-128">The minimum amount of time a provider remains active is determined by the **ClearAfter** property.</span></span> <span data-ttu-id="7a101-129">Vous pouvez trouver des **ClearAfter** dans des instances de classes dérivées de la classe système WMI [**\_ \_ CacheControl**](--cachecontrol.md) dans l' \\ espace de noms racine.</span><span class="sxs-lookup"><span data-stu-id="7a101-129">You can find **ClearAfter** in instances of classes derived from the WMI system class [**\_\_CacheControl**](--cachecontrol.md) in the \\root namespace.</span></span>

<span data-ttu-id="7a101-130">La liste suivante décrit les classes qui sont dérivées de [**\_ \_ CacheControl**](--cachecontrol.md), qui contrôle le déchargement du fournisseur :</span><span class="sxs-lookup"><span data-stu-id="7a101-130">The following list describes the classes that are derived from [**\_\_CacheControl**](--cachecontrol.md), which controls provider unloading:</span></span>

-   [<span data-ttu-id="7a101-131">**\_\_EventConsumerProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="7a101-131">**\_\_EventConsumerProviderCacheControl**</span></span>](--eventconsumerprovidercachecontrol.md)
-   [<span data-ttu-id="7a101-132">**\_\_EventProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="7a101-132">**\_\_EventProviderCacheControl**</span></span>](--eventprovidercachecontrol.md)
-   [<span data-ttu-id="7a101-133">**\_\_EventSinkCacheControl**</span><span class="sxs-lookup"><span data-stu-id="7a101-133">**\_\_EventSinkCacheControl**</span></span>](--eventsinkcachecontrol.md)
-   [<span data-ttu-id="7a101-134">**\_\_ObjectProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="7a101-134">**\_\_ObjectProviderCacheControl**</span></span>](--objectprovidercachecontrol.md)
-   [<span data-ttu-id="7a101-135">**\_\_PropertyProviderCacheControl**</span><span class="sxs-lookup"><span data-stu-id="7a101-135">**\_\_PropertyProviderCacheControl**</span></span>](--propertyprovidercachecontrol.md)

<span data-ttu-id="7a101-136">Vous pouvez modifier la durée minimale pendant laquelle WMI autorise un fournisseur à rester inactif en modifiant la propriété **ClearAfter** dans l’instance de contrôle du cache pour un type de fournisseur spécifique.</span><span class="sxs-lookup"><span data-stu-id="7a101-136">You can change the minimum amount of time that WMI allows a provider to remain inactive by editing the **ClearAfter** property in the cache control instance for a specific type of provider.</span></span> <span data-ttu-id="7a101-137">Par exemple, pour limiter la durée pendant laquelle un fournisseur de propriétés peut rester inactif, vous devez modifier la propriété **ClearAfter** d’une instance [**\_ \_ PropertyProviderCacheControl**](--propertyprovidercachecontrol.md) dans l' \\ espace de noms racine.</span><span class="sxs-lookup"><span data-stu-id="7a101-137">For example, to limit the amount of time a property provider can remain idle, you would edit the **ClearAfter** property of a [**\_\_PropertyProviderCacheControl**](--propertyprovidercachecontrol.md) instance in the \\root namespace.</span></span>

## <a name="unloading-a-provider-that-is-also-a-wmi-client"></a><span data-ttu-id="7a101-138">Déchargement d’un fournisseur qui est également un client WMI</span><span class="sxs-lookup"><span data-stu-id="7a101-138">Unloading a Provider That Is Also a WMI Client</span></span>

<span data-ttu-id="7a101-139">Il se peut que votre fournisseur doive rester un client de WMI une fois qu’il a terminé les fonctions du fournisseur, il a été appelé pour fonctionner.</span><span class="sxs-lookup"><span data-stu-id="7a101-139">Your provider may need to remain a client of WMI after it has completed the provider functions it was called to perform.</span></span> <span data-ttu-id="7a101-140">Par exemple, un fournisseur Push peut avoir besoin d’émettre des requêtes vers WMI.</span><span class="sxs-lookup"><span data-stu-id="7a101-140">For example, a push provider may need to issue queries to WMI.</span></span> <span data-ttu-id="7a101-141">Pour plus d’informations, consultez Détermination de l' [État d’envoi ou d’extraction](determining-push-or-pull-status.md).</span><span class="sxs-lookup"><span data-stu-id="7a101-141">For more information, see [Determining Push or Pull Status](determining-push-or-pull-status.md).</span></span> <span data-ttu-id="7a101-142">Dans ce cas, la propriété **pure** de l’instance [**\_ \_ Win32Provider**](--win32provider.md) qui représente le fournisseur doit avoir la valeur **true**.</span><span class="sxs-lookup"><span data-stu-id="7a101-142">In this case, the **Pure** property of the [**\_\_Win32Provider**](--win32provider.md) instance that represents the provider should be set to **TRUE**.</span></span> <span data-ttu-id="7a101-143">Si la propriété **pure** a la valeur **false**, le fournisseur prépare le déchargement en appelant [**IUnknown :: Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) sur tous les points d’interface en attente lorsque WMI appelle la méthode Release de son interface principale.</span><span class="sxs-lookup"><span data-stu-id="7a101-143">If the **Pure** property is set to **FALSE**, the provider prepares to unload by calling [**IUnknown::Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) on all outstanding interface points when WMI calls the Release method of its primary interface.</span></span> <span data-ttu-id="7a101-144">Pour plus d’informations, consultez la section Notes dans [**\_ \_ Win32Provider**](--win32provider.md).</span><span class="sxs-lookup"><span data-stu-id="7a101-144">For more information, see the Remarks section in [**\_\_Win32Provider**](--win32provider.md).</span></span>

<span data-ttu-id="7a101-145">La procédure suivante décrit comment implémenter une méthode Release pour l’interface principale de votre fournisseur.</span><span class="sxs-lookup"><span data-stu-id="7a101-145">The following procedure describes how to implement a release method for the primary interface of your provider.</span></span>

<span data-ttu-id="7a101-146">**Pour décharger un fournisseur**</span><span class="sxs-lookup"><span data-stu-id="7a101-146">**To unload a provider**</span></span>

1.  <span data-ttu-id="7a101-147">Libère tous les pointeurs d’interface détenues par WMI lorsque WMI appelle la méthode de [**mise**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) en service de l’interface principale de votre fournisseur.</span><span class="sxs-lookup"><span data-stu-id="7a101-147">Release all interface pointers held against WMI when WMI calls the [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) method of the primary interface of your provider.</span></span>

    <span data-ttu-id="7a101-148">En général, un fournisseur contient des pointeurs vers les interfaces [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) et [**IWbemContext**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemcontext) fournies dans [**IWbemProviderInit :: Initialize**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemproviderinit-initialize).</span><span class="sxs-lookup"><span data-stu-id="7a101-148">Typically, a provider holds pointers to the [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) and [**IWbemContext**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemcontext) interfaces supplied in [**IWbemProviderInit::Initialize**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemproviderinit-initialize).</span></span>

2.  <span data-ttu-id="7a101-149">Si la propriété **pure** de l’instance [**\_ \_ Win32Provider**](--win32provider.md) associée est définie sur **false**, le fournisseur peut passer au rôle de l’application cliente après l’appel de la [**version**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release)de WMI.</span><span class="sxs-lookup"><span data-stu-id="7a101-149">If the **Pure** property in the associated [**\_\_Win32Provider**](--win32provider.md) instance is set to **FALSE**, the provider can transition to the role of client application after WMI calls [**Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release).</span></span> <span data-ttu-id="7a101-150">Toutefois, WMI ne peut pas décharger un fournisseur qui fonctionne en tant que système client, ce qui augmente la surcharge du système.</span><span class="sxs-lookup"><span data-stu-id="7a101-150">However, WMI cannot unload a provider that is operating as a client system, which increases the system overhead.</span></span>

    <span data-ttu-id="7a101-151">Un fournisseur dont la propriété **pure** a la **valeur true** existe uniquement pour les demandes de service.</span><span class="sxs-lookup"><span data-stu-id="7a101-151">A provider with **Pure** set to **TRUE** exists only to service requests.</span></span> <span data-ttu-id="7a101-152">Par conséquent, ce type de fournisseur ne peut pas assumer le rôle d’une application cliente et WMI peut le décharger.</span><span class="sxs-lookup"><span data-stu-id="7a101-152">Therefore, this type of provider cannot take on the role of a client application and WMI can unload it.</span></span>

## <a name="unloading-a-provider-during-shutdown"></a><span data-ttu-id="7a101-153">Déchargement d’un fournisseur pendant l’arrêt</span><span class="sxs-lookup"><span data-stu-id="7a101-153">Unloading a Provider During Shutdown</span></span>

<span data-ttu-id="7a101-154">Dans des circonstances normales, l’utilisation des instructions du [déchargement d’un fournisseur qui est également un client WMI](#unloading-a-provider-that-is-also-a-wmi-client) permet à WMI de décharger correctement votre fournisseur.</span><span class="sxs-lookup"><span data-stu-id="7a101-154">Under normal circumstances, using the guidelines in [Unloading a Provider That is Also a WMI Client](#unloading-a-provider-that-is-also-a-wmi-client) allows WMI to unload your provider properly.</span></span> <span data-ttu-id="7a101-155">Toutefois, vous pouvez rencontrer des situations où WMI ne peut pas effectuer les procédures de déchargement normales, par exemple lorsque l’utilisateur choisit d’arrêter le système.</span><span class="sxs-lookup"><span data-stu-id="7a101-155">However, you may run into situations where WMI is unable to instigate the normal unloading procedures, such as when the user chooses to shut the system down.</span></span> <span data-ttu-id="7a101-156">En utilisant un modèle de transaction de stockage des données, en plus d’implémenter une bonne stratégie de nettoyage, vous pouvez vous assurer que votre fournisseur est correctement déchargé.</span><span class="sxs-lookup"><span data-stu-id="7a101-156">By using a transaction model of data storage, in addition to implementing a good cleanup strategy, you can ensure that your provider is properly unloaded.</span></span>

<span data-ttu-id="7a101-157">L’utilisateur peut arrêter WMI à tout moment.</span><span class="sxs-lookup"><span data-stu-id="7a101-157">The user may stop WMI at any time.</span></span> <span data-ttu-id="7a101-158">Dans ce cas, WMI ne décharge aucun fournisseur ou n’appelle le point d’entrée [**DllCanUnloadNow**](/windows/win32/api/combaseapi/nf-combaseapi-dllcanunloadnow) sur aucun fournisseur in-process.</span><span class="sxs-lookup"><span data-stu-id="7a101-158">In such a situation, WMI does not unload any providers or call the [**DllCanUnloadNow**](/windows/win32/api/combaseapi/nf-combaseapi-dllcanunloadnow) entry point on any in-process provider.</span></span> <span data-ttu-id="7a101-159">En outre, si un fournisseur in-process est au milieu d’un appel de méthode au moment de l’arrêt, WMI peut éventuellement terminer le thread d’exécution au milieu de l’appel.</span><span class="sxs-lookup"><span data-stu-id="7a101-159">Moreover, if an in-process provider is in the middle of a method call at the time of the shutdown, WMI can possibly terminate the executing thread in the middle of the call.</span></span> <span data-ttu-id="7a101-160">Dans ce cas, WMI n’appelle pas les routines qui gèrent normalement le nettoyage, telles qu’un destructeur d’objet.</span><span class="sxs-lookup"><span data-stu-id="7a101-160">In this circumstance, WMI does not call routines that normally handle cleanup, such as an object destructor.</span></span> <span data-ttu-id="7a101-161">Au maximum, WMI appellera [**DllMain**](/windows/desktop/Dlls/dllmain) uniquement.</span><span class="sxs-lookup"><span data-stu-id="7a101-161">At most, WMI will call [**DllMain**](/windows/desktop/Dlls/dllmain) only.</span></span>

<span data-ttu-id="7a101-162">Lorsque le système d’exploitation arrête WMI, le système libère automatiquement toute la mémoire allouée à un fournisseur in-process.</span><span class="sxs-lookup"><span data-stu-id="7a101-162">When the operating system shuts down WMI, the system automatically releases all memory allocated to an in-process provider.</span></span> <span data-ttu-id="7a101-163">Le système d’exploitation ferme également la plupart des ressources détenues par le fournisseur, telles que les descripteurs de fichiers, les handles de fenêtre, etc.</span><span class="sxs-lookup"><span data-stu-id="7a101-163">The operating system also closes most resources held by the provider, such as file handles, window handles, and so on.</span></span> <span data-ttu-id="7a101-164">Le fournisseur n’a pas besoin d’effectuer une action spécifique pour que cela se produise.</span><span class="sxs-lookup"><span data-stu-id="7a101-164">The provider does not need to take any specific action to make this happen.</span></span>

<span data-ttu-id="7a101-165">Étant donné que WMI peut s’arrêter au milieu d’un appel, un fournisseur ne doit pas quitter les sources de données dans un état incohérent.</span><span class="sxs-lookup"><span data-stu-id="7a101-165">Because WMI may shut down in the middle of a call, a provider should not leave data sources in an inconsistent state.</span></span> <span data-ttu-id="7a101-166">Le fait de laisser vos données dans un état incohérent n’est pas un problème pour les fournisseurs en lecture seule.</span><span class="sxs-lookup"><span data-stu-id="7a101-166">Leaving your data in an inconsistent state is not a problem for read-only providers.</span></span> <span data-ttu-id="7a101-167">Toutefois, les fournisseurs avec des capacités d’écriture peuvent souhaiter implémenter un certain type de modèle de transaction pour permettre une restauration sécurisée après une fin brutale.</span><span class="sxs-lookup"><span data-stu-id="7a101-167">However, providers with write capabilities may want to implement some sort of transaction model to allow a safe rollback after an abrupt termination.</span></span>

<span data-ttu-id="7a101-168">Alors que le système d’exploitation peut libérer des ressources système générales, le système ne libère pas automatiquement toutes les ressources.</span><span class="sxs-lookup"><span data-stu-id="7a101-168">While the operating system may release some general system resources, the system does not automatically release all resources.</span></span> <span data-ttu-id="7a101-169">Par exemple, le système d’exploitation peut ne pas libérer un socket ou une connexion de base de données.</span><span class="sxs-lookup"><span data-stu-id="7a101-169">For example, the operating system may not release a socket or a database connection.</span></span> <span data-ttu-id="7a101-170">Au lieu de cela, le fournisseur devra peut-être nettoyer manuellement ces ressources.</span><span class="sxs-lookup"><span data-stu-id="7a101-170">Instead, the provider may need to manually clean up such resources.</span></span> <span data-ttu-id="7a101-171">Pour éviter ces problèmes, vous pouvez implémenter votre fournisseur hors processus ou vous pouvez ajouter un code de nettoyage.</span><span class="sxs-lookup"><span data-stu-id="7a101-171">To avoid these problems, you can either implement your provider out-of-process, or you can add cleanup code.</span></span>

<span data-ttu-id="7a101-172">La solution la plus simple consiste à implémenter votre fournisseur hors processus.</span><span class="sxs-lookup"><span data-stu-id="7a101-172">The simplest solution is to implement your provider out-of-process.</span></span> <span data-ttu-id="7a101-173">Un fournisseur hors processus n’est pas supprimé lorsque WMI s’arrête, bien que WMI libère le fournisseur après un délai d’attente COM.</span><span class="sxs-lookup"><span data-stu-id="7a101-173">An out-of-process provider is not killed when WMI shuts down, although WMI will release the provider after a COM timeout.</span></span> <span data-ttu-id="7a101-174">Les fournisseurs pour lesquels les problèmes de robustesse de nettoyage et de terminaison sont plus importants que les performances peuvent être hors processus.</span><span class="sxs-lookup"><span data-stu-id="7a101-174">Providers for whom cleanup and termination robustness issues are more important than performance may be out-of-process.</span></span>

<span data-ttu-id="7a101-175">Si vous devez placer le code de nettoyage dans votre fournisseur, vous avez deux options.</span><span class="sxs-lookup"><span data-stu-id="7a101-175">If you must place cleanup code in your provider, you have two options.</span></span> <span data-ttu-id="7a101-176">Un emplacement pour effectuer ce type de nettoyage est [**DllMain**](/windows/desktop/Dlls/dllmain), la fonction de point d’entrée de dll qui est appelée par le système d’exploitation lors du déchargement de la dll.</span><span class="sxs-lookup"><span data-stu-id="7a101-176">One place to perform this sort of cleanup is [**DllMain**](/windows/desktop/Dlls/dllmain), the DLL entry point function the operating system calls when unloading the DLL.</span></span> <span data-ttu-id="7a101-177">Le code de nettoyage peut être ajouté directement à **DllMain**, en l’exécutant en réponse au **\_ \_ détachement du processus dll**.</span><span class="sxs-lookup"><span data-stu-id="7a101-177">Cleanup code can be added directly into **DllMain**, executing it in response to **DLL\_PROCESS\_DETACH**.</span></span> <span data-ttu-id="7a101-178">L’implémentation d’un code de nettoyage dans **DllMain** peut être un peu difficile à organiser, en particulier dans les environnements de programmation tels que MFC ou ATL.</span><span class="sxs-lookup"><span data-stu-id="7a101-178">Implementing cleanup code in **DllMain** can be somewhat difficult to arrange, especially in programming environments such as MFC or ATL.</span></span> <span data-ttu-id="7a101-179">Pour plus d’informations, consultez l’article Q148791 de la base de connaissances Microsoft, «*comment fournir votre propre DllMain dans une DLL régulière MFC ».*</span><span class="sxs-lookup"><span data-stu-id="7a101-179">For more information, see the Microsoft Knowledge Base article Q148791, "*How to Provide Your Own DllMain in an MFC Regular DLL.*"</span></span> <span data-ttu-id="7a101-180">(Cette ressource n’est peut-être pas disponible dans certaines langues et pays ou régions.)</span><span class="sxs-lookup"><span data-stu-id="7a101-180">(This resource may not be available in some languages and countries or regions.)</span></span>

<span data-ttu-id="7a101-181">Vous pouvez également placer le code de nettoyage dans le destructeur d’une classe globale.</span><span class="sxs-lookup"><span data-stu-id="7a101-181">Alternately, you could also place the cleanup code in the destructor of a global class.</span></span> <span data-ttu-id="7a101-182">Pour plus d’informations, consultez déchargement d’un fournisseur.</span><span class="sxs-lookup"><span data-stu-id="7a101-182">For more information, see Unloading a Provider.</span></span> <span data-ttu-id="7a101-183">Le système d’exploitation Windows n’alloue pas d’objets globaux sur le segment de mémoire.</span><span class="sxs-lookup"><span data-stu-id="7a101-183">The Windows operating system does not allocate global objects on the heap.</span></span> <span data-ttu-id="7a101-184">Au lieu de cela, le système d’exploitation appelle les destructeurs pendant le déchargement de la DLL.</span><span class="sxs-lookup"><span data-stu-id="7a101-184">Instead, the operating system calls the destructors during DLL unload.</span></span>

<span data-ttu-id="7a101-185">Voici une procédure de nettoyage simple qui peut tenir dans un objet global pour WMI.</span><span class="sxs-lookup"><span data-stu-id="7a101-185">The following is a simple cleanup procedure that could fit inside a global object for WMI.</span></span>


```C++
class CMyCleanup
{
    ~CMyCleanup()
    {
        CloseHandle(m_hOpenFile);
        CloseDatabaseConnection(g_hDatabase);
    }
} g_Cleanup;
```



<span data-ttu-id="7a101-186">Il existe de nombreuses restrictions quant à ce qui peut être fait dans le code de nettoyage avec l’une ou l’autre approche.</span><span class="sxs-lookup"><span data-stu-id="7a101-186">There are many restrictions as to what can be done in the cleanup code with either approach.</span></span> <span data-ttu-id="7a101-187">Par exemple, ni les threads, ni les dll qui ne sont pas implicitement liés ne sont accessibles de quelque manière que ce soit.</span><span class="sxs-lookup"><span data-stu-id="7a101-187">For example, neither threads nor any DLLs that are not implicitly linked may be accessed in any way.</span></span> <span data-ttu-id="7a101-188">En outre, vous ne pouvez pas effectuer d’appels COM dans toutes les circonstances.</span><span class="sxs-lookup"><span data-stu-id="7a101-188">Further, you cannot make COM calls under any circumstances.</span></span>

## <a name="related-topics"></a><span data-ttu-id="7a101-189">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="7a101-189">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="7a101-190">Définition des descripteurs de sécurité espace</span><span class="sxs-lookup"><span data-stu-id="7a101-190">Setting Namepace Security Descriptors</span></span>](setting-namespace-security-descriptors.md)
</dt> <dt>

[<span data-ttu-id="7a101-191">Sécurisation de votre fournisseur</span><span class="sxs-lookup"><span data-stu-id="7a101-191">Securing Your Provider</span></span>](securing-your-provider.md)
</dt> <dt>

[<span data-ttu-id="7a101-192">Développement d’un fournisseur WMI</span><span class="sxs-lookup"><span data-stu-id="7a101-192">Developing a WMI Provider</span></span>](developing-a-wmi-provider.md)
</dt> </dl>

 

 
