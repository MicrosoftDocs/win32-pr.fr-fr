---
description: 'En C++, vous pouvez définir la sécurité sur l’ensemble du processus en appelant CoInitializeSecurity avant de vous connecter à WMI via IWbemLocator :: ConnectServer.'
ms.assetid: 83c04a96-3829-4c07-91a7-06e5b75b2c12
ms.tgt_platform: multiple
title: Définition de la sécurité sur IWbemServices et d’autres proxies
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d593c52091182b1f0580908624e0b4068ed3f8d3
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "106522425"
---
# <a name="setting-the-security-on-iwbemservices-and-other-proxies"></a><span data-ttu-id="47f12-103">Définition de la sécurité sur IWbemServices et d’autres proxies</span><span class="sxs-lookup"><span data-stu-id="47f12-103">Setting the Security on IWbemServices and Other Proxies</span></span>

<span data-ttu-id="47f12-104">En C++, vous pouvez définir la sécurité sur l’ensemble du processus en appelant [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity) avant de vous connecter à WMI via [**IWbemLocator :: ConnectServer**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemlocator-connectserver).</span><span class="sxs-lookup"><span data-stu-id="47f12-104">While in C++ you can set the security on the entire process by calling [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity) before connecting to WMI through [**IWbemLocator::ConnectServer**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemlocator-connectserver).</span></span> <span data-ttu-id="47f12-105">Vous pouvez également modifier le niveau d’authentification, le niveau d’emprunt d’identité ou le service d’authentification dans un appel qui obtient un pointeur vers un proxy WMI, tel que [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) ou [**IWbemCallResult**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemcallresult).</span><span class="sxs-lookup"><span data-stu-id="47f12-105">You can also change the authentication level, impersonation level, or the authentication service in a call that obtains a pointer to a WMI proxy, such as [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) or [**IWbemCallResult**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemcallresult).</span></span> <span data-ttu-id="47f12-106">L’appel de [**CoSetProxyBlanket**](/windows/win32/api/combaseapi/nf-combaseapi-cosetproxyblanket) vous permet également de modifier le service d’authentification (Kerberos, NTLM ou Negotiate).</span><span class="sxs-lookup"><span data-stu-id="47f12-106">Calling [**CoSetProxyBlanket**](/windows/win32/api/combaseapi/nf-combaseapi-cosetproxyblanket) also allows you to change the authentication service (Kerberos, NTLM, or negotiate).</span></span>

<span data-ttu-id="47f12-107">Les scripts et les applications de Visual Basic définissent la sécurité des proxies indirectement par le biais d’appels à [**SWbemServices**](swbemservices.md) et d’autres objets Automation.</span><span class="sxs-lookup"><span data-stu-id="47f12-107">Scripts and Visual Basic applications only set security on proxies indirectly through calls to [**SWbemServices**](swbemservices.md) and other automation objects.</span></span> <span data-ttu-id="47f12-108">Pour plus d’informations sur la définition et la modification de l’authentification et de l’emprunt d’identité dans le script, consultez [définition du niveau de sécurité de processus par défaut à l’aide de VBScript](setting-the-default-process-security-level-using-vbscript.md).</span><span class="sxs-lookup"><span data-stu-id="47f12-108">For more information about setting and changing authentication and impersonation in script, see [Setting the Default Process Security Level Using VBScript](setting-the-default-process-security-level-using-vbscript.md).</span></span>

<span data-ttu-id="47f12-109">La modification des niveaux de sécurité ou des services est principalement un problème lors de la connexion à WMI sur un ordinateur distant qui exécute un système d’exploitation différent.</span><span class="sxs-lookup"><span data-stu-id="47f12-109">Changing security levels or services is primarily a concern when connecting to WMI on a remote computer that is running a different operating system.</span></span> <span data-ttu-id="47f12-110">Pour plus d’informations, consultez [connexion entre différents systèmes d’exploitation](/windows/desktop/WmiSdk/troubleshooting-a-remote-wmi-connection).</span><span class="sxs-lookup"><span data-stu-id="47f12-110">For more information, see [Connecting Between Different Operating Systems](/windows/desktop/WmiSdk/troubleshooting-a-remote-wmi-connection).</span></span>

<span data-ttu-id="47f12-111">Une application cliente se connecte à un proxy WMI à l’aide d’une identité.</span><span class="sxs-lookup"><span data-stu-id="47f12-111">A client application connects to a WMI proxy using an identity.</span></span> <span data-ttu-id="47f12-112">Une identité est un objet de données qui se compose d’un nom d’utilisateur, d’un mot de passe et de paramètres d’autorité.</span><span class="sxs-lookup"><span data-stu-id="47f12-112">An identity is a data object that consists of a user name, password, and authority settings.</span></span> <span data-ttu-id="47f12-113">Pour une application cliente WMI, l’appel à l’interface [**IWbemLocator :: ConnectServer**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemlocator-connectserver) crée l’identité initiale.</span><span class="sxs-lookup"><span data-stu-id="47f12-113">For a WMI client application, the call to the [**IWbemLocator::ConnectServer**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemlocator-connectserver) interface creates the initial identity.</span></span> <span data-ttu-id="47f12-114">La méthode [**ConnectServer**](swbemlocator-connectserver.md) prend l’identité dans un ensemble de trois paramètres, que vous pouvez définir sur **null** pour indiquer l’utilisateur actuel.</span><span class="sxs-lookup"><span data-stu-id="47f12-114">The [**ConnectServer**](swbemlocator-connectserver.md) method takes the identity in a set of three parameters, which you can set to **NULL** to indicate the current user.</span></span> <span data-ttu-id="47f12-115">Vous pouvez également spécifier un paramètre non **null** pour indiquer un utilisateur et un domaine spécifiques.</span><span class="sxs-lookup"><span data-stu-id="47f12-115">You can also specify a non-**NULL** parameter to indicate a specific user and domain.</span></span> <span data-ttu-id="47f12-116">Si l’appel réussit, **ConnectServer** retourne un pointeur via lequel vous pouvez accéder à un large éventail de processus distants, tels qu’un service WMI ou le système d’exploitation Windows directement.</span><span class="sxs-lookup"><span data-stu-id="47f12-116">If the call is successful, **ConnectServer** returns a pointer through which you can access a variety of remote processes, such as a WMI service or the Windows operating system directly.</span></span>

<span data-ttu-id="47f12-117">Comme de nombreuses interfaces COM, [**ConnectServer**](swbemlocator-connectserver.md) retourne un pointeur vers un proxy.</span><span class="sxs-lookup"><span data-stu-id="47f12-117">Like many COM interfaces, [**ConnectServer**](swbemlocator-connectserver.md) returns a pointer to a proxy.</span></span> <span data-ttu-id="47f12-118">Un proxy est un objet de données qui représente un processus distant, tel que WMI ou un fournisseur distant.</span><span class="sxs-lookup"><span data-stu-id="47f12-118">A proxy is a data object that represents a remote process, such as WMI or a remote provider.</span></span> <span data-ttu-id="47f12-119">COM utilise un proxy pour permettre aux développeurs d’accéder aux données distantes comme si les données étaient locales.</span><span class="sxs-lookup"><span data-stu-id="47f12-119">COM uses a proxy to allow developers access to remote data as though the data were local.</span></span>

<span data-ttu-id="47f12-120">Les interfaces WMI suivantes utilisent des proxys :</span><span class="sxs-lookup"><span data-stu-id="47f12-120">The following WMI interfaces use proxies:</span></span>

-   <span data-ttu-id="47f12-121">[**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) (objet de script [**SWbemServices**](swbemservices.md) )</span><span class="sxs-lookup"><span data-stu-id="47f12-121">[**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) ([**SWbemServices**](swbemservices.md) scripting object)</span></span>
-   [<span data-ttu-id="47f12-122">**IEnumWbemClassObject**</span><span class="sxs-lookup"><span data-stu-id="47f12-122">**IEnumWbemClassObject**</span></span>](/windows/desktop/api/Wbemcli/nn-wbemcli-ienumwbemclassobject)
-   [<span data-ttu-id="47f12-123">**IWbemCallResult**</span><span class="sxs-lookup"><span data-stu-id="47f12-123">**IWbemCallResult**</span></span>](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemcallresult)
-   <span data-ttu-id="47f12-124">[**IWbemRefresher**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemrefresher) (objet de script [**SWbemRefresher**](swbemrefresher.md) )</span><span class="sxs-lookup"><span data-stu-id="47f12-124">[**IWbemRefresher**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemrefresher) ([**SWbemRefresher**](swbemrefresher.md) scripting object)</span></span>

    <span data-ttu-id="47f12-125">L’actualisateur WMI est un cas particulier, car il reçoit un pointeur [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) , dont les paramètres de sécurité doivent être définis correctement.</span><span class="sxs-lookup"><span data-stu-id="47f12-125">The WMI Refresher is a special case because it is passed an [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) pointer, whose security settings must be properly set.</span></span> <span data-ttu-id="47f12-126">Pour plus d’informations sur l’utilisation des objets actualisateurs, consultez [accès aux données de performances en C++](accessing-performance-data-in-c--.md).</span><span class="sxs-lookup"><span data-stu-id="47f12-126">For more information about using refresher objects, see [Accessing Performance Data in C++](accessing-performance-data-in-c--.md).</span></span>

<span data-ttu-id="47f12-127">Une fois que vous avez reçu un pointeur vers un processus distant, vous pouvez effectuer l’une des deux opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="47f12-127">After you receive a pointer to a remote process, you can do one of two things.</span></span> <span data-ttu-id="47f12-128">Si vous savez ce que fait le processus, vous pouvez choisir de définir la sécurité sur le pointeur et d’accéder au processus normalement.</span><span class="sxs-lookup"><span data-stu-id="47f12-128">If you know what the process does, you can choose to set the security on the pointer and access the process normally.</span></span> <span data-ttu-id="47f12-129">C’est le cas avec la plupart des pointeurs vers un service WMI.</span><span class="sxs-lookup"><span data-stu-id="47f12-129">This is the case with most pointers to a WMI service.</span></span> <span data-ttu-id="47f12-130">Pour plus d’informations, consultez [définition des niveaux de sécurité sur une connexion WMI](setting-the-security-levels-on-a-wmi-connection.md).</span><span class="sxs-lookup"><span data-stu-id="47f12-130">For more information, see [Setting the Security Levels on a WMI Connection](setting-the-security-levels-on-a-wmi-connection.md).</span></span> <span data-ttu-id="47f12-131">Vous avez également besoin d’accéder à une interface COM différente sur le proxy, telle que [**IUnknown :: Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release), via un appel à l’interface [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) sur le proxy.</span><span class="sxs-lookup"><span data-stu-id="47f12-131">Alternately, you need to access a different COM interface on the proxy, such as [**IUnknown::Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release), through a call to the [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) interface on the proxy.</span></span>

## <a name="defaults-and-recommendations"></a><span data-ttu-id="47f12-132">Valeurs par défaut et recommandations</span><span class="sxs-lookup"><span data-stu-id="47f12-132">Defaults and Recommendations</span></span>

<span data-ttu-id="47f12-133">La version distribuée du modèle COM (Component Object Model) négocie le service d’authentification par défaut (Kerberos, NTLM ou Negotiate) et vous ne pouvez pas spécifier le service d’authentification par défaut à l’aide de [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity).</span><span class="sxs-lookup"><span data-stu-id="47f12-133">The distributed version of the Component Object Model (DCOM) negotiates the default authentication service (Kerberos, NTLM, or Negotiate), and you cannot specify the default authentication service using [**CoInitializeSecurity**](/windows/win32/api/combaseapi/nf-combaseapi-coinitializesecurity).</span></span> <span data-ttu-id="47f12-134">La spécification de la **\_ \_ \_ valeur par défaut de RPC C Authn** dans le paramètre Authentication Service de [**CoSetProxyBlanket**](/windows/win32/api/combaseapi/nf-combaseapi-cosetproxyblanket) permet à DCOM de sélectionner le service approprié.</span><span class="sxs-lookup"><span data-stu-id="47f12-134">Specifying **RPC\_C\_AUTHN\_DEFAULT** in the authentication service parameter of [**CoSetProxyBlanket**](/windows/win32/api/combaseapi/nf-combaseapi-cosetproxyblanket) allows DCOM to select the appropriate service.</span></span> <span data-ttu-id="47f12-135">Pour les connexions distantes, le service par défaut est Negotiate, qui est le service recommandé pour les applications qui fonctionnent dans les domaines Kerberos et non-Kerberos.</span><span class="sxs-lookup"><span data-stu-id="47f12-135">For remote connections the default service is Negotiate, which is the recommended service for applications functioning in both Kerberos and non-Kerberos domains.</span></span> <span data-ttu-id="47f12-136">Pour les connexions locales, le service d’authentification par défaut est NT LAN Manager (NTLM).</span><span class="sxs-lookup"><span data-stu-id="47f12-136">For local connections, the default authentication service is NT LAN Manager (NTLM).</span></span>

<span data-ttu-id="47f12-137">L’exemple de code suivant illustre l’utilisation du service d’authentification par défaut.</span><span class="sxs-lookup"><span data-stu-id="47f12-137">The following code example shows the default authentication service being used.</span></span>


```C++
// The pWbemServices variable is of type IWbemServices*

HRESULT hr = CoSetProxyBlanket(
     pWbemServices,                //Proxy
     RPC_C_AUTHN_DEFAULT,          //Authentication service 
     RPC_C_AUTHZ_DEFAULT,          //Authorization service 
     COLE_DEFAULT_PRINCIPAL,       //Server principal name used 
                                       // by authentication service
     RPC_C_AUTHN_LEVEL_DEFAULT,    //Authentication level
     RPC_C_IMP_LEVEL_IMPERSONATE,  //Impersonation level
     COLE_DEFAULT_AUTHINFO,       //Client identity
     EOAC_DEFAULT                  //Capability flags
     );
```



<span data-ttu-id="47f12-138">L’exemple de code de cette rubrique requiert la référence et les \# instructions include suivantes.</span><span class="sxs-lookup"><span data-stu-id="47f12-138">The code example in this topic requires the following reference and \#include statements.</span></span>


```C++
#define _WIN32_DCOM
#include <wbemidl.h>
#include <comdef.h>

#pragma comment(lib, "wbemuuid.lib")
```



<span data-ttu-id="47f12-139">Pour les scripts, il est recommandé d’utiliser les valeurs par défaut que DCOM sélectionne pour les appels distants.</span><span class="sxs-lookup"><span data-stu-id="47f12-139">For scripting, it is recommended that you use the defaults that DCOM selects for remote calls.</span></span> <span data-ttu-id="47f12-140">Sur l’ordinateur local, vous ne pouvez pas spécifier un service d’authentification pour les appels à WMI.</span><span class="sxs-lookup"><span data-stu-id="47f12-140">On the local machine you cannot specify an authentication service for calls to WMI.</span></span> <span data-ttu-id="47f12-141">Pour plus d’informations, consultez [définition du service d’authentification à l’aide de VBScript](setting-the-authentication-service-using-vbscript.md) et [construction d’une chaîne de moniker](constructing-a-moniker-string.md).</span><span class="sxs-lookup"><span data-stu-id="47f12-141">For more information, see [Setting the Authentication Service Using VBScript](setting-the-authentication-service-using-vbscript.md) and [Constructing a Moniker String](constructing-a-moniker-string.md).</span></span>

 

 
