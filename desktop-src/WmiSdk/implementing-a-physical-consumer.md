---
description: Un consommateur physique est un objet COM qui implémente l’interface IWbemUnboundObjectSink.
ms.assetid: 497457dc-61ca-4527-89fd-2af0383de5e9
ms.tgt_platform: multiple
title: Implémentation d’un consommateur physique
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: af0a9530ed7a98ce19b3b39f2f5a1fe52f3b0631
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "106521851"
---
# <a name="implementing-a-physical-consumer"></a><span data-ttu-id="074be-103">Implémentation d’un consommateur physique</span><span class="sxs-lookup"><span data-stu-id="074be-103">Implementing a Physical Consumer</span></span>

<span data-ttu-id="074be-104">Un consommateur physique est un objet COM qui implémente l’interface [**IWbemUnboundObjectSink**](/windows/desktop/api/Wbemprov/nn-wbemprov-iwbemunboundobjectsink) .</span><span class="sxs-lookup"><span data-stu-id="074be-104">A physical consumer is a COM object that implements the [**IWbemUnboundObjectSink**](/windows/desktop/api/Wbemprov/nn-wbemprov-iwbemunboundobjectsink) interface.</span></span> <span data-ttu-id="074be-105">WMI charge votre consommateur physique et passe des événements via **IWbemUnboundObjectSink** en réponse à un ou plusieurs événements, comme défini par le consommateur logique associé.</span><span class="sxs-lookup"><span data-stu-id="074be-105">WMI loads your physical consumer and passes events through **IWbemUnboundObjectSink** in response to one or more events, as defined by the associated logical consumer.</span></span> <span data-ttu-id="074be-106">Les consommateurs permanents ont des exigences particulières en matière de sécurité.</span><span class="sxs-lookup"><span data-stu-id="074be-106">Permanent consumers have special security requirements.</span></span> <span data-ttu-id="074be-107">Pour plus d’informations, consultez [sécurisation des événements WMI](securing-wmi-events.md).</span><span class="sxs-lookup"><span data-stu-id="074be-107">For more information, see [Securing WMI Events](securing-wmi-events.md).</span></span>

<span data-ttu-id="074be-108">La procédure suivante décrit comment implémenter un consommateur physique pour un consommateur d’événements permanent.</span><span class="sxs-lookup"><span data-stu-id="074be-108">The following procedure describes how to implement a physical consumer for a permanent event consumer.</span></span>

<span data-ttu-id="074be-109">**Pour implémenter un consommateur physique pour un consommateur d’événements permanent**</span><span class="sxs-lookup"><span data-stu-id="074be-109">**To implement a physical consumer for a permanent event consumer**</span></span>

1.  <span data-ttu-id="074be-110">Créez un objet COM.</span><span class="sxs-lookup"><span data-stu-id="074be-110">Create a COM object.</span></span>

    <span data-ttu-id="074be-111">Vous devez implémenter un consommateur physique en tant que serveur local ou distant à l’aide du protocole COM.</span><span class="sxs-lookup"><span data-stu-id="074be-111">You must implement a physical consumer as a local or remote server using the COM protocol.</span></span>

2.  <span data-ttu-id="074be-112">Déterminez si vous souhaitez prendre en charge la notification d’événements synchrones ou asynchrones.</span><span class="sxs-lookup"><span data-stu-id="074be-112">Determine if you want to support synchronous or asynchronous event notification.</span></span>

    <span data-ttu-id="074be-113">Avec la notification d’événement asynchrone, le thread d’envoi n’est pas lié au thread de réception.</span><span class="sxs-lookup"><span data-stu-id="074be-113">With asynchronous event notification, the sending thread is unrelated to the receiving thread.</span></span> <span data-ttu-id="074be-114">Par conséquent, ni WMI ni le fournisseur d’événements ne sont bloqués alors que WMI envoie une notification à tout consommateur inscrit pour recevoir l’événement.</span><span class="sxs-lookup"><span data-stu-id="074be-114">Therefore, neither WMI nor the event provider gets blocked while WMI delivers a notification to any consumer registered to receive the event.</span></span> <span data-ttu-id="074be-115">L’inconvénient de la remise asynchrone est qu’un changement de contexte se produit entre le moment où le fournisseur produit l’événement et le moment où le consommateur reçoit l’événement.</span><span class="sxs-lookup"><span data-stu-id="074be-115">The disadvantage to asynchronous delivery is that a context switch occurs between the time the provider produces the event and the time the consumer receives the event.</span></span> <span data-ttu-id="074be-116">Pour plus d’informations sur le travail de façon asynchrone, consultez la rubrique [notions de base de com](../com/guide.md) dans la section com du kit de développement logiciel (SDK) Microsoft Windows.</span><span class="sxs-lookup"><span data-stu-id="074be-116">For more information about working asynchronously, see the [COM Fundamentals](../com/guide.md) topic in the COM section of the Microsoft Windows Software Development Kit (SDK).</span></span> <span data-ttu-id="074be-117">Pour plus d’informations sur les changements de contexte, consultez la rubrique [changements de contexte](../procthread/context-switches.md) dans la section dll, processus et threads de la SDK Windows.</span><span class="sxs-lookup"><span data-stu-id="074be-117">For more information about context switches, see the [Context Switches](../procthread/context-switches.md) topic in the DLLs, Processes, and Threads section of the Windows SDK.</span></span>

    > [!Note]  
    > <span data-ttu-id="074be-118">Étant donné que le rappel au récepteur peut ne pas être retourné au même niveau d’authentification que celui requis par le client, il est recommandé d’utiliser le mode semi-synchrone au lieu de la communication asynchrone.</span><span class="sxs-lookup"><span data-stu-id="074be-118">Because the callback to the sink might not be returned at the same authentication level as the client requires, it is recommended that you use semisynchronous instead of asynchronous communication.</span></span> <span data-ttu-id="074be-119">Pour plus d’informations, consultez [appel d’une méthode](calling-a-method.md).</span><span class="sxs-lookup"><span data-stu-id="074be-119">For more information, see [Calling a Method](calling-a-method.md).</span></span>

     

    <span data-ttu-id="074be-120">Avec la notification synchrone, WMI remet la notification sur le même thread que celui utilisé par le fournisseur d’événements pour remettre l’événement à WMI.</span><span class="sxs-lookup"><span data-stu-id="074be-120">With synchronous notification, WMI delivers the notification on the same thread that the event provider used to deliver the event to WMI.</span></span> <span data-ttu-id="074be-121">Dans ce cas, lorsqu’un fournisseur d’événements envoie une notification, le fournisseur d’événements est bloqué par WMI jusqu’à ce que WMI remette la notification.</span><span class="sxs-lookup"><span data-stu-id="074be-121">In this case, when an event provider sends a notification, the event provider is blocked by WMI until WMI delivers the notification.</span></span> <span data-ttu-id="074be-122">Uniquement si votre consommateur est extrêmement rapide et peut traiter un événement en microsecondes de 100 ou moins, si vous envisagez de prendre en charge la notification synchrone.</span><span class="sxs-lookup"><span data-stu-id="074be-122">Only if your consumer is extremely fast and can process an event in 100 microseconds or less should you consider supporting synchronous notification.</span></span> <span data-ttu-id="074be-123">Les consommateurs synchrones qui prennent trop de temps pour traiter les événements peuvent gravement ralentir la remise des événements à tous les autres consommateurs.</span><span class="sxs-lookup"><span data-stu-id="074be-123">Synchronous consumers that take too long to process events can seriously slow the delivery of events to all other consumers.</span></span> <span data-ttu-id="074be-124">En outre, ils peuvent bloquer le fournisseur par inadvertance.</span><span class="sxs-lookup"><span data-stu-id="074be-124">Furthermore, they can inadvertently block the provider.</span></span> <span data-ttu-id="074be-125">Pour plus d’informations, consultez [liaison d’un filtre d’événements à un consommateur logique](binding-an-event-filter-with-a-logical-consumer.md).</span><span class="sxs-lookup"><span data-stu-id="074be-125">For more information, see [Binding an Event Filter with a Logical Consumer](binding-an-event-filter-with-a-logical-consumer.md).</span></span>

3.  <span data-ttu-id="074be-126">Implémentez la fonction [**IWbemUnboundObjectSink :: IndicateToConsumer**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemunboundobjectsink-indicatetoconsumer) .</span><span class="sxs-lookup"><span data-stu-id="074be-126">Implement the [**IWbemUnboundObjectSink::IndicateToConsumer**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemunboundobjectsink-indicatetoconsumer) function.</span></span>

    <span data-ttu-id="074be-127">WMI utilise la fonction [**IndicateToConsumer**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemunboundobjectsink-indicatetoconsumer) pour passer les pointeurs et les événements nécessaires à votre consommateur physique pour les communications synchrones et asynchrones.</span><span class="sxs-lookup"><span data-stu-id="074be-127">WMI uses the [**IndicateToConsumer**](/windows/desktop/api/Wbemprov/nf-wbemprov-iwbemunboundobjectsink-indicatetoconsumer) function to pass the necessary pointers and events to your physical consumer for both synchronous and asynchronous communications.</span></span> <span data-ttu-id="074be-128">Votre implémentation de **IndicateToConsumer** doit contenir l’ensemble du code nécessaire pour répondre à un événement.</span><span class="sxs-lookup"><span data-stu-id="074be-128">Your implementation of **IndicateToConsumer** should contain all of the necessary code to respond to an event.</span></span>

    <span data-ttu-id="074be-129">Contrairement à un consommateur d’événements temporaire, vous n’avez pas besoin d’appeler l’interface [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) pour contacter WMI.</span><span class="sxs-lookup"><span data-stu-id="074be-129">Unlike a temporary event consumer, you do not need to call the [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) interface to contact WMI.</span></span> <span data-ttu-id="074be-130">Au lieu de cela, WMI localise un pointeur vers votre consommateur par le biais du fournisseur de consommateur d’événements.</span><span class="sxs-lookup"><span data-stu-id="074be-130">Instead, WMI locates a pointer to your consumer through the event consumer provider.</span></span> <span data-ttu-id="074be-131">Pour plus d’informations, consultez [écriture d’un fournisseur de consommateur d’événements](writing-an-event-consumer-provider.md).</span><span class="sxs-lookup"><span data-stu-id="074be-131">For more information, see [Writing an Event Consumer Provider](writing-an-event-consumer-provider.md).</span></span>

    <span data-ttu-id="074be-132">Toutefois, si vous souhaitez rappeler WMI, utilisez les interfaces [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) et [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) .</span><span class="sxs-lookup"><span data-stu-id="074be-132">However, if you wish to call back into WMI, use the [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) and [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) interfaces.</span></span> <span data-ttu-id="074be-133">La méthode traditionnelle pour la connexion à WMI est pendant le processus d’initialisation de votre objet COM.</span><span class="sxs-lookup"><span data-stu-id="074be-133">The traditional method for connecting to WMI is during the initialization process of your COM object.</span></span> <span data-ttu-id="074be-134">Pour plus d’informations, consultez [création d’une application ou d’un script WMI](creating-a-wmi-application-or-script.md).</span><span class="sxs-lookup"><span data-stu-id="074be-134">For more information, see [Creating a WMI Application or Script](creating-a-wmi-application-or-script.md).</span></span>

    <span data-ttu-id="074be-135">Si vous implémentez votre consommateur physique en tant que serveur COM in-process et que vous vous connectez à WMI séparément du processus d’initialisation, vous devez utiliser l’identificateur de classe **CLSID \_ WbemAdministrativeLocator** pour accéder à l’interface [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) dans l’appel à [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance).</span><span class="sxs-lookup"><span data-stu-id="074be-135">If you implement your physical consumer as an in-process COM server and connect to WMI separately from the initialization process, you must use the **CLSID\_WbemAdministrativeLocator** class identifier to access the [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) interface in the call to [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance).</span></span>

    <span data-ttu-id="074be-136">L’exemple suivant montre comment utiliser l’identificateur de classe **\_ WbemAdministrativeLocator CLSID** pour accéder à l’interface [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) .</span><span class="sxs-lookup"><span data-stu-id="074be-136">The following example shows how to use the **CLSID\_WbemAdministrativeLocator** class identifier to access the [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) interface.</span></span>

    ```C++
    IWbemLocator *pLoc = 0;

    DWORD dwRes = CoCreateInstance(CLSID_WbemAdministrativeLocator, 0, 
        CLSCTX_INPROC_SERVER, IID_IWbemLocator, (LPVOID *) &pLoc);
    ```

    

    <span data-ttu-id="074be-137">L’interface [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) obtient le pointeur d’espace de noms initial vers WMI sur un ordinateur hôte particulier.</span><span class="sxs-lookup"><span data-stu-id="074be-137">The [**IWbemLocator**](/windows/desktop/api/Wbemcli/nn-wbemcli-iwbemlocator) interface obtains the initial namespace pointer to WMI on a particular host computer.</span></span> <span data-ttu-id="074be-138">Si vous n’utilisez pas l’identificateur **\_ WbemAdministrativeLocator CLSID** dans l’appel [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) , une erreur « Accès refusé » est générée.</span><span class="sxs-lookup"><span data-stu-id="074be-138">Failure to use the **CLSID\_WbemAdministrativeLocator** identifier in the [**CoCreateInstance**](/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance) call results in an "access denied" error.</span></span>

    <span data-ttu-id="074be-139">Dans des circonstances habituelles, WMI fournit des événements asynchrones au client, l’un après l’autre.</span><span class="sxs-lookup"><span data-stu-id="074be-139">Under usual circumstances, WMI delivers asynchronous events to the client one at a time.</span></span> <span data-ttu-id="074be-140">Toutefois, si un client ne peut pas recevoir de notifications d’événements asynchrones aussi rapidement que les événements arrivent, WMI commence à traiter automatiquement les événements en un seul appel.</span><span class="sxs-lookup"><span data-stu-id="074be-140">However, if a client cannot receive asynchronous event notifications as fast as the events arrive, WMI starts to automatically batch events into a single call.</span></span> <span data-ttu-id="074be-141">Le traitement automatique vous aide si les temps d’aller-retour sont un problème, comme c’est souvent le cas dans les scénarios à débit élevé.</span><span class="sxs-lookup"><span data-stu-id="074be-141">Automatic batching helps if the round-trip times are a problem, as is often the case in high-throughput scenarios.</span></span> <span data-ttu-id="074be-142">Toutefois, le traitement par lot n’améliore pas les performances du système si le client ou la bande passante réseau est défaillant.</span><span class="sxs-lookup"><span data-stu-id="074be-142">However, batching does not improve system performance if the client or the network bandwidth are at fault.</span></span>

 

 
