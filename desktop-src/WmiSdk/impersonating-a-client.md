---
description: Lorsqu’une application utilisateur demande des données à partir d’objets sur le système via un fournisseur WMI, l’emprunt d’identité signifie que le fournisseur présente des informations d’identification qui représentent le niveau de sécurité des clients plutôt que les fournisseurs.
ms.assetid: 6d54f234-45aa-445b-ad50-7d5a9946c134
ms.tgt_platform: multiple
title: Emprunt de l’identité d’un client
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 162857d90c8bddb70d90eb2e10efbc08537299d9
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "103866889"
---
# <a name="impersonating-a-client"></a><span data-ttu-id="07714-103">Emprunt de l’identité d’un client</span><span class="sxs-lookup"><span data-stu-id="07714-103">Impersonating a Client</span></span>

<span data-ttu-id="07714-104">Lorsqu’une application utilisateur demande des données à partir d’objets sur le système par le biais d’un fournisseur WMI, l’emprunt d’identité signifie que le fournisseur présente des informations d’identification qui représentent le niveau de sécurité du client plutôt que le du fournisseur.</span><span class="sxs-lookup"><span data-stu-id="07714-104">When a user application requests data from objects on the system through a WMI provider, impersonation means the provider presents credentials that represent the client's security level rather than the provider's.</span></span> <span data-ttu-id="07714-105">L’emprunt d’identité empêche un client d’obtenir un accès non autorisé aux informations sur le système.</span><span class="sxs-lookup"><span data-stu-id="07714-105">Impersonation prevents a client from obtaining unauthorized access to information on the system.</span></span>

<span data-ttu-id="07714-106">Les sections suivantes sont présentées dans cette rubrique :</span><span class="sxs-lookup"><span data-stu-id="07714-106">The following sections are discussed in this topic:</span></span>

-   [<span data-ttu-id="07714-107">Inscription d’un fournisseur pour l’emprunt d’identité</span><span class="sxs-lookup"><span data-stu-id="07714-107">Registering a Provider for Impersonation</span></span>](#registering-a-provider-for-impersonation)
-   [<span data-ttu-id="07714-108">Définition des niveaux d’emprunt d’identité dans un fournisseur</span><span class="sxs-lookup"><span data-stu-id="07714-108">Setting Impersonation Levels Within a Provider</span></span>](#setting-impersonation-levels-within-a-provider)
-   [<span data-ttu-id="07714-109">Maintenance des niveaux de sécurité dans un fournisseur</span><span class="sxs-lookup"><span data-stu-id="07714-109">Maintaining Security Levels in a Provider</span></span>](#maintaining-security-levels-in-a-provider)
-   [<span data-ttu-id="07714-110">Gestion des messages d’accès refusé dans un fournisseur</span><span class="sxs-lookup"><span data-stu-id="07714-110">Handling Access Denied Messages in a Provider</span></span>](#handling-access-denied-messages-in-a-provider)
-   [<span data-ttu-id="07714-111">Création de rapports sur des instances partielles</span><span class="sxs-lookup"><span data-stu-id="07714-111">Reporting Partial Instances</span></span>](#reporting-partial-instances)
-   [<span data-ttu-id="07714-112">Création de rapports d’énumérations partielles</span><span class="sxs-lookup"><span data-stu-id="07714-112">Reporting Partial Enumerations</span></span>](#reporting-partial-enumerations)
-   [<span data-ttu-id="07714-113">Débogage de votre code d’accès refusé</span><span class="sxs-lookup"><span data-stu-id="07714-113">Debugging Your Access Denied Code</span></span>](#debugging-your-access-denied-code)
-   [<span data-ttu-id="07714-114">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="07714-114">Related topics</span></span>](#related-topics)

<span data-ttu-id="07714-115">WMI s’exécute généralement en tant que service administratif à un niveau de sécurité élevé, à l’aide du contexte de sécurité LocalServer.</span><span class="sxs-lookup"><span data-stu-id="07714-115">WMI typically runs as an administrative service at a high security level, using the LocalServer security context.</span></span> <span data-ttu-id="07714-116">L’utilisation d’un service administratif permet à WMI d’accéder aux informations privilégiées.</span><span class="sxs-lookup"><span data-stu-id="07714-116">Using an administrative service gives WMI the means to access privileged information.</span></span> <span data-ttu-id="07714-117">Lors de l’appel d’un fournisseur pour plus d’informations, WMI transmet son identificateur de sécurité (SID) au fournisseur, ce qui permet au fournisseur d’accéder aux informations au même niveau de sécurité élevé.</span><span class="sxs-lookup"><span data-stu-id="07714-117">When calling a provider for information, WMI passes its security identifier (SID) to the provider, enabling the provider to access information at the same high security level.</span></span>

<span data-ttu-id="07714-118">Durant le processus de lancement de l’application WMI, le système d’exploitation Windows donne à l’application WMI le contexte de sécurité de l’utilisateur qui a commencé le processus.</span><span class="sxs-lookup"><span data-stu-id="07714-118">During the WMI application launch process, the Windows operating system gives the WMI application the security context of the user who began the process.</span></span> <span data-ttu-id="07714-119">Le contexte de sécurité de l’utilisateur est généralement un niveau de sécurité inférieur à LocalServer. il est donc possible que l’utilisateur n’ait pas l’autorisation d’accéder à toutes les informations disponibles pour WMI.</span><span class="sxs-lookup"><span data-stu-id="07714-119">The security context of the user is typically a lower security level than LocalServer, so the user may not have permission to access all of the information available to WMI.</span></span> <span data-ttu-id="07714-120">Lorsque l’application utilisateur demande des informations dynamiques, WMI transmet le SID de l’utilisateur au fournisseur correspondant.</span><span class="sxs-lookup"><span data-stu-id="07714-120">When the user application asks for dynamic information, WMI passes the SID of the user to the corresponding provider.</span></span> <span data-ttu-id="07714-121">En cas d’écriture appropriée, le fournisseur tente d’accéder aux informations avec le SID de l’utilisateur, plutôt que le SID du fournisseur.</span><span class="sxs-lookup"><span data-stu-id="07714-121">If written appropriately, the provider attempts to access information with the user SID, rather than the provider SID.</span></span>

<span data-ttu-id="07714-122">Pour que le fournisseur emprunte correctement l’identité de l’application cliente, l’application cliente et le fournisseur doivent répondre aux critères suivants :</span><span class="sxs-lookup"><span data-stu-id="07714-122">For the provider to successfully impersonate the client application, the client application and provider must meet the following criteria:</span></span>

-   <span data-ttu-id="07714-123">L’application cliente doit appeler WMI avec un niveau de sécurité de connexion COM de la connexion **RPC \_ c \_ IMP \_ Level \_ Impersonate** ou **RPC \_ c \_ IMP \_ Level \_ Delegate**.</span><span class="sxs-lookup"><span data-stu-id="07714-123">The client application must call WMI with a COM connection security level of **RPC\_C\_IMP\_LEVEL\_IMPERSONATE** or **RPC\_C\_IMP\_LEVEL\_DELEGATE**.</span></span> <span data-ttu-id="07714-124">Pour plus d’informations, consultez [maintenance de la sécurité WMI](maintaining-wmi-security.md).</span><span class="sxs-lookup"><span data-stu-id="07714-124">For more information, see [Maintaining WMI Security](maintaining-wmi-security.md).</span></span>
-   <span data-ttu-id="07714-125">Le fournisseur doit s’inscrire auprès de WMI en tant que fournisseur d’emprunt d’identité.</span><span class="sxs-lookup"><span data-stu-id="07714-125">The provider must register with WMI as an impersonation provider.</span></span> <span data-ttu-id="07714-126">Pour plus d’informations, consultez [inscription d’un fournisseur pour l’emprunt d’identité](#registering-a-provider-for-impersonation).</span><span class="sxs-lookup"><span data-stu-id="07714-126">For more information, see [Registering a Provider for Impersonation](#registering-a-provider-for-impersonation).</span></span>
-   <span data-ttu-id="07714-127">Le fournisseur doit basculer vers le niveau de sécurité de l’application cliente avant d’accéder aux informations privilégiées.</span><span class="sxs-lookup"><span data-stu-id="07714-127">The provider must switch to the security level of the client application before accessing privileged information.</span></span> <span data-ttu-id="07714-128">Pour plus d’informations, consultez [définition de niveaux d’emprunt d’identité au sein d’un fournisseur](#setting-impersonation-levels-within-a-provider).</span><span class="sxs-lookup"><span data-stu-id="07714-128">For more information, see [Setting Impersonation Levels Within a Provider](#setting-impersonation-levels-within-a-provider).</span></span>
-   <span data-ttu-id="07714-129">Le fournisseur doit gérer correctement les conditions d’erreur si l’accès à ces informations est refusé.</span><span class="sxs-lookup"><span data-stu-id="07714-129">The provider must correctly handle error conditions if access to this information is denied.</span></span> <span data-ttu-id="07714-130">Pour plus d’informations, consultez [gestion des messages d’accès refusé dans un fournisseur](#handling-access-denied-messages-in-a-provider).</span><span class="sxs-lookup"><span data-stu-id="07714-130">For more information, see [Handling Access Denied Messages in a Provider](#handling-access-denied-messages-in-a-provider).</span></span>

## <a name="registering-a-provider-for-impersonation"></a><span data-ttu-id="07714-131">Inscription d’un fournisseur pour l’emprunt d’identité</span><span class="sxs-lookup"><span data-stu-id="07714-131">Registering a Provider for Impersonation</span></span>

<span data-ttu-id="07714-132">WMI ne transmet le SID d’une application cliente qu’aux fournisseurs qui se sont inscrits en tant que fournisseurs d’emprunt d’identité.</span><span class="sxs-lookup"><span data-stu-id="07714-132">WMI only passes the SID of a client application to providers who have registered as impersonation providers.</span></span> <span data-ttu-id="07714-133">Pour permettre à un fournisseur d’effectuer l’emprunt d’identité, vous devez modifier le processus d’inscription du fournisseur.</span><span class="sxs-lookup"><span data-stu-id="07714-133">Enabling a provider to perform impersonation requires that you modify the provider registration process.</span></span>

<span data-ttu-id="07714-134">La procédure suivante décrit comment inscrire un fournisseur pour l’emprunt d’identité.</span><span class="sxs-lookup"><span data-stu-id="07714-134">The following procedure describes how to register a provider for impersonation.</span></span> <span data-ttu-id="07714-135">La procédure suppose que vous comprenez déjà le processus d’inscription.</span><span class="sxs-lookup"><span data-stu-id="07714-135">The procedure assumes that you already understand the registration process.</span></span> <span data-ttu-id="07714-136">Pour plus d’informations sur le processus d’inscription, consultez [inscription d’un fournisseur](registering-a-provider.md).</span><span class="sxs-lookup"><span data-stu-id="07714-136">For more information about the registration process, see [Registering a Provider](registering-a-provider.md).</span></span>

<span data-ttu-id="07714-137">**Pour inscrire un fournisseur pour l’emprunt d’identité**</span><span class="sxs-lookup"><span data-stu-id="07714-137">**To register a provider for impersonation**</span></span>

1.  <span data-ttu-id="07714-138">Affectez la valeur 1 à la propriété [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) de la classe [**\_ \_ Win32Provider**](--win32provider.md) qui représente votre fournisseur.</span><span class="sxs-lookup"><span data-stu-id="07714-138">Set the [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) property of the [**\_\_Win32Provider**](--win32provider.md) class that represents your provider to 1.</span></span>

    <span data-ttu-id="07714-139">La propriété [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) indique si le fournisseur prend en charge l’emprunt d’identité ou non.</span><span class="sxs-lookup"><span data-stu-id="07714-139">The [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) property documents whether the provider supports impersonation or not.</span></span> <span data-ttu-id="07714-140">L’affectation de la valeur 0 à **ImpersonationLevel** indique que le fournisseur n’emprunte pas l’identité du client et effectue toutes les opérations demandées dans le même contexte utilisateur que WMI.</span><span class="sxs-lookup"><span data-stu-id="07714-140">Setting **ImpersonationLevel** to 0 indicates that the provider does not impersonate the client and performs all requested operations in the same user context as WMI.</span></span> <span data-ttu-id="07714-141">L’affectation de la valeur 1 à **ImpersonationLevel** indique que le fournisseur utilise des appels d’emprunt d’identité pour vérifier les opérations effectuées pour le compte du client.</span><span class="sxs-lookup"><span data-stu-id="07714-141">Setting **ImpersonationLevel** to 1 indicates that the provider uses impersonation calls to check operations performed on behalf of the client.</span></span>

2.  <span data-ttu-id="07714-142">Affectez la valeur **true** à la propriété **PerUserInitialization** de la même classe [**\_ \_ Win32Provider**](--win32provider.md) .</span><span class="sxs-lookup"><span data-stu-id="07714-142">Set the **PerUserInitialization** property of the same [**\_\_Win32Provider**](--win32provider.md) class to **TRUE**.</span></span>

> [!Note]  
> <span data-ttu-id="07714-143">Si vous inscrivez un fournisseur avec la propriété [**\_ \_ Win32Provider**](--win32provider.md) **InitializeAsAdminFirst** définie sur **true**, le fournisseur utilise le jeton de sécurité de thread de niveau administration uniquement pendant la phase d’initialisation.</span><span class="sxs-lookup"><span data-stu-id="07714-143">If you register a provider with the [**\_\_Win32Provider**](--win32provider.md) property **InitializeAsAdminFirst** set to **TRUE**, then the provider uses the administration-level thread security token only during the initialization phase.</span></span> <span data-ttu-id="07714-144">Lorsqu’un appel à [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) n’échoue pas, le fournisseur utilise le contexte de sécurité de WMI et non du client.</span><span class="sxs-lookup"><span data-stu-id="07714-144">While a call to [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) does not fail, the provider uses the security context of WMI and not of the client.</span></span>

 

<span data-ttu-id="07714-145">L’exemple de code suivant montre comment inscrire un fournisseur pour l’emprunt d’identité.</span><span class="sxs-lookup"><span data-stu-id="07714-145">The following code example shows how to register a provider for impersonation.</span></span>

``` syntax
instance of __Win32Provider
{
    CLSID = "{FD4F53E0-65DC-11d1-AB64-00C04FD9159E}";
    ImpersonationLevel = 1;
    Name = "MS_NT_EVENTLOG_PROVIDER";
    PerUserInitialization = TRUE;
};
```

## <a name="setting-impersonation-levels-within-a-provider"></a><span data-ttu-id="07714-146">Définition des niveaux d’emprunt d’identité dans un fournisseur</span><span class="sxs-lookup"><span data-stu-id="07714-146">Setting Impersonation Levels Within a Provider</span></span>

<span data-ttu-id="07714-147">Si vous inscrivez un fournisseur avec la propriété de classe [**\_ \_ Win32Provider**](--win32provider.md) [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) définie sur 1, WMI appelle votre fournisseur pour emprunter l’identité de différents clients.</span><span class="sxs-lookup"><span data-stu-id="07714-147">If you register a provider with the [**\_\_Win32Provider**](--win32provider.md) class property [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) set to 1, then WMI calls your provider to impersonate various clients.</span></span> <span data-ttu-id="07714-148">Pour gérer ces appels, utilisez les fonctions com [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) et [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) dans votre implémentation de l’interface [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) .</span><span class="sxs-lookup"><span data-stu-id="07714-148">To handle these calls, use the [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) and [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) COM functions in your implementation of the [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) interface.</span></span>

<span data-ttu-id="07714-149">La fonction [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) permet à un serveur d’emprunter l’identité du client qui a effectué l’appel.</span><span class="sxs-lookup"><span data-stu-id="07714-149">The [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) function allows a server to impersonate the client that made the call.</span></span> <span data-ttu-id="07714-150">En plaçant un appel à **CoImpersonateClient** dans votre implémentation de [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices), vous autorisez votre fournisseur à définir le jeton de thread du fournisseur pour qu’il corresponde au jeton de thread du client, et donc emprunter l’identité du client.</span><span class="sxs-lookup"><span data-stu-id="07714-150">By placing a call to **CoImpersonateClient** into your implementation of [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices), you allow your provider to set the thread token of the provider to match the thread token of the client, and thus impersonate the client.</span></span> <span data-ttu-id="07714-151">Si vous n’appelez pas **CoImpersonateClient**, votre fournisseur exécute le code à un niveau de sécurité administrateur, ce qui crée une faille de sécurité potentielle.</span><span class="sxs-lookup"><span data-stu-id="07714-151">If you do not call **CoImpersonateClient**, your provider executes code at an administrator level of security, thereby creating a potential security vulnerability.</span></span> <span data-ttu-id="07714-152">Si votre fournisseur doit temporairement agir en tant qu’administrateur ou effectuer la vérification d’accès manuellement, appelez [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span><span class="sxs-lookup"><span data-stu-id="07714-152">If your provider temporarily needs to act as an administrator or perform the access check manually, then call [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span></span>

<span data-ttu-id="07714-153">Contrairement à [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient), [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) est une fonction com qui gère les niveaux d’emprunt d’identité de thread.</span><span class="sxs-lookup"><span data-stu-id="07714-153">In contrast to [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient), [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) is a COM function that handles thread impersonation levels.</span></span> <span data-ttu-id="07714-154">Dans ce cas, **CoRevertToSelf** remplace le niveau d’emprunt d’identité par le paramètre d’emprunt d’identité d’origine.</span><span class="sxs-lookup"><span data-stu-id="07714-154">In this case, **CoRevertToSelf** changes the impersonation level back to the original impersonation setting.</span></span> <span data-ttu-id="07714-155">En général, le fournisseur est initialement un administrateur et alterne entre **CoImpersonateClient** et **CoRevertToSelf** , selon qu’il s’agit d’un appel qui représente l’appelant ou ses propres appels.</span><span class="sxs-lookup"><span data-stu-id="07714-155">In general, the provider is initially an administrator and alternates between **CoImpersonateClient** and **CoRevertToSelf** depending on whether it is making a call that represents the caller or its own calls.</span></span> <span data-ttu-id="07714-156">Il incombe au fournisseur de placer correctement ces appels afin de ne pas exposer de faille de sécurité à l’utilisateur final.</span><span class="sxs-lookup"><span data-stu-id="07714-156">It is the responsibility of the provider to place these calls correctly so as not to expose a security hole to the end user.</span></span> <span data-ttu-id="07714-157">Par exemple, le fournisseur doit uniquement appeler des fonctions Windows natives dans la séquence de code empruntée.</span><span class="sxs-lookup"><span data-stu-id="07714-157">For example, the provider should only call native Windows functions within the impersonated code sequence.</span></span>

> [!Note]  
> <span data-ttu-id="07714-158">L’objectif de [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) et [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) est de définir la sécurité d’un fournisseur.</span><span class="sxs-lookup"><span data-stu-id="07714-158">The purpose of [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) and [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) is to set security for a provider.</span></span> <span data-ttu-id="07714-159">Si vous déterminez que l’emprunt d’identité a échoué, vous devez retourner un code d’achèvement approprié à WMI via [**IWbemObjectSink :: SetStatus**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemobjectsink-setstatus).</span><span class="sxs-lookup"><span data-stu-id="07714-159">If you determine that your impersonation has failed, you should return an appropriate completion code to WMI through [**IWbemObjectSink::SetStatus**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemobjectsink-setstatus).</span></span> <span data-ttu-id="07714-160">Pour plus d’informations, consultez [gestion des messages d’accès refusé dans un fournisseur](#handling-access-denied-messages-in-a-provider).</span><span class="sxs-lookup"><span data-stu-id="07714-160">For more information, see [Handling Access Denied Messages in a Provider](#handling-access-denied-messages-in-a-provider).</span></span>

 

## <a name="maintaining-security-levels-in-a-provider"></a><span data-ttu-id="07714-161">Maintenance des niveaux de sécurité dans un fournisseur</span><span class="sxs-lookup"><span data-stu-id="07714-161">Maintaining Security Levels in a Provider</span></span>

<span data-ttu-id="07714-162">Les fournisseurs ne peuvent pas appeler [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) une fois dans une implémentation de [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) et supposent que les informations d’identification d’emprunt d’identité restent en place pendant la durée du fournisseur.</span><span class="sxs-lookup"><span data-stu-id="07714-162">Providers cannot call [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) one time in an implementation of [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) and assume that the impersonation credentials remain in place for the duration of the provider.</span></span> <span data-ttu-id="07714-163">Au lieu de cela, appelez **CoImpersonateClient** plusieurs fois au cours d’une implémentation pour empêcher WMI de modifier les informations d’identification.</span><span class="sxs-lookup"><span data-stu-id="07714-163">Instead, call **CoImpersonateClient** multiple times during the course of an implementation to keep WMI from changing the credentials.</span></span>

<span data-ttu-id="07714-164">La principale préoccupation pour la définition de l’emprunt d’identité pour un fournisseur est la réentrance.</span><span class="sxs-lookup"><span data-stu-id="07714-164">The main concern for setting impersonation for a provider is reentrancy.</span></span> <span data-ttu-id="07714-165">Dans ce contexte, la réentrance est lorsqu’un fournisseur effectue un appel à WMI pour obtenir des informations et attend jusqu’à ce que WMI rappelle le fournisseur.</span><span class="sxs-lookup"><span data-stu-id="07714-165">In this context, reentrancy is when a provider makes a call to WMI for information and waits until WMI calls back into the provider.</span></span> <span data-ttu-id="07714-166">En résumé, le thread d’exécution quitte le code du fournisseur, uniquement pour entrer à nouveau le code à une date ultérieure.</span><span class="sxs-lookup"><span data-stu-id="07714-166">In essence, the thread of execution leaves the provider code, only to reenter the code at a later date.</span></span> <span data-ttu-id="07714-167">La réentrance fait partie de la conception de COM et n’est généralement pas un problème.</span><span class="sxs-lookup"><span data-stu-id="07714-167">Reentry is a part of the design of COM, and is generally not a concern.</span></span> <span data-ttu-id="07714-168">Toutefois, lorsque le thread d’exécution entre dans WMI, le thread prend les niveaux d’emprunt d’identité de WMI.</span><span class="sxs-lookup"><span data-stu-id="07714-168">However, when the thread of execution enters WMI, the thread takes on the impersonation levels of WMI.</span></span> <span data-ttu-id="07714-169">Lorsque le thread revient au fournisseur, vous devez réinitialiser les niveaux d’emprunt d’identité avec un autre appel à [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient).</span><span class="sxs-lookup"><span data-stu-id="07714-169">When the thread returns to the provider, you must reset the impersonation levels with another call to [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient).</span></span>

<span data-ttu-id="07714-170">Pour vous protéger contre les failles de sécurité de votre fournisseur, vous devez faire en sorte que les appels réentrants dans WMI s’effectuent uniquement lors de l’emprunt d’identité du client.</span><span class="sxs-lookup"><span data-stu-id="07714-170">To protect yourself from security holes in your provider, you should make reentrant calls into WMI only while impersonating the client.</span></span> <span data-ttu-id="07714-171">Autrement dit, les appels à WMI doivent être effectués après l’appel de [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) et avant l’appel de [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span><span class="sxs-lookup"><span data-stu-id="07714-171">That is, calls to WMI should be made after you call [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) and before you call [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span></span> <span data-ttu-id="07714-172">Étant donné que **CoRevertToSelf** provoque l’utilisation de l’emprunt d’identité au niveau de l’utilisateur, le WMI est en cours d’exécution, généralement LocalSystem, les appels réentrants à WMI après l’appel de **CoRevertToSelf** peuvent permettre à l’utilisateur et à tous les fournisseurs appelés de bénéficier d’un plus grand nombre de fonctionnalités.</span><span class="sxs-lookup"><span data-stu-id="07714-172">Because **CoRevertToSelf** causes the impersonation to be set to the user level WMI is running, generally LocalSystem, reentrant calls to WMI after calling **CoRevertToSelf** could give the user, and any providers called, a lot more capabilities than they should have.</span></span>

> [!Note]  
> <span data-ttu-id="07714-173">Si vous appelez une fonction système ou une autre méthode d’interface, le maintien du contexte d’appel n’est pas garanti.</span><span class="sxs-lookup"><span data-stu-id="07714-173">If you call a system function or another interface method, the call context is not guaranteed to be maintained.</span></span>

 

## <a name="handling-access-denied-messages-in-a-provider"></a><span data-ttu-id="07714-174">Gestion des messages d’accès refusé dans un fournisseur</span><span class="sxs-lookup"><span data-stu-id="07714-174">Handling Access Denied Messages in a Provider</span></span>

<span data-ttu-id="07714-175">La plupart des messages d’erreur d’accès refusé s’affichent lorsqu’un client demande une classe ou des informations auxquelles ils n’ont pas accès.</span><span class="sxs-lookup"><span data-stu-id="07714-175">Most Access Denied error messages appear when a client requests a class or information to which they do not have access.</span></span> <span data-ttu-id="07714-176">Si le fournisseur renvoie un message d’erreur Accès refusé à WMI et que WMI le transmet au client, le client peut déduire que les informations existent.</span><span class="sxs-lookup"><span data-stu-id="07714-176">If the provider returns an Access Denied error message to WMI and WMI passes this on to the client, the client can infer that the information exists.</span></span> <span data-ttu-id="07714-177">Dans certains cas, il peut s’agir d’une violation de la sécurité.</span><span class="sxs-lookup"><span data-stu-id="07714-177">In some situations, this can be a breach of security.</span></span> <span data-ttu-id="07714-178">Par conséquent, votre fournisseur ne doit pas propager le message au client.</span><span class="sxs-lookup"><span data-stu-id="07714-178">Therefore, your provider should not propagate the message to the client.</span></span> <span data-ttu-id="07714-179">Au lieu de cela, l’ensemble de classes que le fournisseur aurait fourni ne doit pas être exposé.</span><span class="sxs-lookup"><span data-stu-id="07714-179">Instead, the set of classes that the provider would have supplied should not be exposed.</span></span> <span data-ttu-id="07714-180">De même, un fournisseur d’instances dynamiques doit appeler la source de données sous-jacente pour déterminer comment traiter les messages d’accès refusé.</span><span class="sxs-lookup"><span data-stu-id="07714-180">Similarly, a dynamic instance provider should call to the underlying data source to determine how to deal with Access Denied messages.</span></span> <span data-ttu-id="07714-181">Il incombe au fournisseur de répliquer cette philosophie dans l’environnement WMI.</span><span class="sxs-lookup"><span data-stu-id="07714-181">It is the responsibility of the provider to replicate that philosophy into the WMI environment.</span></span> <span data-ttu-id="07714-182">Pour plus d’informations, consultez Création de rapports sur des [instances partielles](#reporting-partial-instances) et [création de rapports d’énumérations partielles](#reporting-partial-enumerations).</span><span class="sxs-lookup"><span data-stu-id="07714-182">For more information, see [Reporting Partial Instances](#reporting-partial-instances) and [Reporting Partial Enumerations](#reporting-partial-enumerations).</span></span>

<span data-ttu-id="07714-183">Lorsque vous déterminez comment votre fournisseur doit gérer les messages d’accès refusé, vous devez écrire et déboguer votre code.</span><span class="sxs-lookup"><span data-stu-id="07714-183">When you determine how your provider should handle Access Denied messages, you must write and debug your code.</span></span> <span data-ttu-id="07714-184">Lors du débogage, il est souvent pratique de faire la distinction entre un refus en raison d’un faible emprunt d’identité et un refus en raison d’une erreur dans votre code.</span><span class="sxs-lookup"><span data-stu-id="07714-184">While debugging, it is often convenient to distinguish between a denial due to low impersonation, and a denial due to an error in your code.</span></span> <span data-ttu-id="07714-185">Vous pouvez utiliser un test simple dans votre code pour déterminer la différence.</span><span class="sxs-lookup"><span data-stu-id="07714-185">You can use a simple test in your code to determine the difference.</span></span> <span data-ttu-id="07714-186">Pour plus d’informations, consultez [débogage de votre code d’accès refusé](#debugging-your-access-denied-code).</span><span class="sxs-lookup"><span data-stu-id="07714-186">For more information, see [Debugging your Access Denied Code](#debugging-your-access-denied-code).</span></span>

## <a name="reporting-partial-instances"></a><span data-ttu-id="07714-187">Création de rapports sur des instances partielles</span><span class="sxs-lookup"><span data-stu-id="07714-187">Reporting Partial Instances</span></span>

<span data-ttu-id="07714-188">Une occurrence courante d’un message de refus d’accès se produit lorsque WMI ne peut pas fournir toutes les informations pour remplir une instance.</span><span class="sxs-lookup"><span data-stu-id="07714-188">One common occurrence of an Access Denied message is when WMI cannot provide all the information to fill an instance.</span></span> <span data-ttu-id="07714-189">Par exemple, un client peut disposer de l’autorité nécessaire pour afficher un objet lecteur de disque dur, mais il n’a peut-être pas l’autorisation de voir la quantité d’espace disponible sur le disque dur.</span><span class="sxs-lookup"><span data-stu-id="07714-189">For example, a client may have the authority to view a hard disk drive object, but may not have authority to see how much space is available on the hard disk drive itself.</span></span> <span data-ttu-id="07714-190">Votre fournisseur doit déterminer comment gérer toute situation dans laquelle le fournisseur ne peut pas remplir complètement une instance avec des propriétés en raison d’une violation d’accès.</span><span class="sxs-lookup"><span data-stu-id="07714-190">Your provider must determine how to handle any situation when the provider cannot completely fill an instance with properties due to an access violation.</span></span>

<span data-ttu-id="07714-191">WMI ne nécessite pas de réponse unique aux clients qui ont un accès partiel à une instance.</span><span class="sxs-lookup"><span data-stu-id="07714-191">WMI does not require a single response to clients that have partial access to an instance.</span></span> <span data-ttu-id="07714-192">Au lieu de cela, la version 1. x de WMI autorise le fournisseur à l’une des options suivantes :</span><span class="sxs-lookup"><span data-stu-id="07714-192">Instead, WMI version 1.x allows the provider one of the following options:</span></span>

-   <span data-ttu-id="07714-193">Échec de la totalité de l’opération avec l' **\_ accès WBEM E \_ \_ refusé** et ne renvoyant aucune instance.</span><span class="sxs-lookup"><span data-stu-id="07714-193">Fail the entire operation with **WBEM\_E\_ACCESS\_DENIED** and return no instances.</span></span>

    <span data-ttu-id="07714-194">Retourne un objet d’erreur avec **l' \_ accès WBEM E \_ \_ refusé** pour décrire la raison du refus.</span><span class="sxs-lookup"><span data-stu-id="07714-194">Return an error object along with **WBEM\_E\_ACCESS\_DENIED**, to describe the reason for the denial.</span></span>

-   <span data-ttu-id="07714-195">Retourne toutes les propriétés disponibles et remplit les propriétés non disponibles avec la **valeur null**.</span><span class="sxs-lookup"><span data-stu-id="07714-195">Return all available properties, and fill unavailable properties with **NULL**.</span></span>

> [!Note]  
> <span data-ttu-id="07714-196">Assurez-vous que le renvoi de l' **\_ accès WBEM E \_ \_ refusé** ne crée pas de faille de sécurité dans votre entreprise.</span><span class="sxs-lookup"><span data-stu-id="07714-196">Make sure that returning **WBEM\_E\_ACCESS\_DENIED** does not create a security hole in your enterprise.</span></span>

 

## <a name="reporting-partial-enumerations"></a><span data-ttu-id="07714-197">Création de rapports d’énumérations partielles</span><span class="sxs-lookup"><span data-stu-id="07714-197">Reporting Partial Enumerations</span></span>

<span data-ttu-id="07714-198">Une autre occurrence courante d’une violation d’accès se produit lorsque WMI ne peut pas retourner toute une énumération.</span><span class="sxs-lookup"><span data-stu-id="07714-198">Another common occurrence of an access violation is when WMI cannot return all of an enumeration.</span></span> <span data-ttu-id="07714-199">Par exemple, un client peut avoir accès à l’affichage de tous les objets ordinateur du réseau local, mais il n’a peut-être pas l’accès pour afficher les objets ordinateur en dehors de son domaine.</span><span class="sxs-lookup"><span data-stu-id="07714-199">For example, a client may have access to view all of the local network computer objects, but may not have access to view computer objects outside of his domain.</span></span> <span data-ttu-id="07714-200">Votre fournisseur doit déterminer comment gérer toute situation dans laquelle une énumération ne peut pas être effectuée en raison d’une violation d’accès.</span><span class="sxs-lookup"><span data-stu-id="07714-200">Your provider must determine how to handle any situation when an enumeration cannot be completed due to an access violation.</span></span>

<span data-ttu-id="07714-201">Comme avec un fournisseur d’instances, WMI ne requiert pas une seule réponse à une énumération partielle.</span><span class="sxs-lookup"><span data-stu-id="07714-201">As with an instance provider, WMI does not require a single response to a partial enumeration.</span></span> <span data-ttu-id="07714-202">Au lieu de cela, la version 1. x de WMI permet à un fournisseur d’obtenir l’une des options suivantes :</span><span class="sxs-lookup"><span data-stu-id="07714-202">Instead, WMI version 1.x allows a provider one of the following options:</span></span>

-   <span data-ttu-id="07714-203">Retourne **WBEM \_ S \_ aucune \_ erreur** pour toutes les instances auxquelles le fournisseur peut accéder.</span><span class="sxs-lookup"><span data-stu-id="07714-203">Return **WBEM\_S\_NO\_ERROR** for all instances that the provider can access.</span></span>

    <span data-ttu-id="07714-204">Si vous utilisez cette option, l’utilisateur n’a pas conscience que certaines instances n’étaient pas disponibles.</span><span class="sxs-lookup"><span data-stu-id="07714-204">If you use this option, the user is not aware that some instances were not available.</span></span> <span data-ttu-id="07714-205">Un certain nombre de fournisseurs, tels que ceux qui utilisent des langage SQL (SQL) avec la sécurité au niveau des lignes, retournent des résultats partiels réussis en utilisant le niveau de sécurité de l’appelant pour définir le jeu de résultats.</span><span class="sxs-lookup"><span data-stu-id="07714-205">A number of providers, such as those using Structured Query Language (SQL) with row-level security, return successful partial results using the security level of the caller to define the result set.</span></span>

-   <span data-ttu-id="07714-206">Échec de la totalité de l’opération avec l' **\_ accès WBEM E \_ \_ refusé** et ne renvoyant aucune instance.</span><span class="sxs-lookup"><span data-stu-id="07714-206">Fail the entire operation with **WBEM\_E\_ACCESS\_DENIED** and return no instances.</span></span>

    <span data-ttu-id="07714-207">Le fournisseur peut éventuellement inclure un objet d’erreur qui décrit la situation au client.</span><span class="sxs-lookup"><span data-stu-id="07714-207">The provider may optionally include an error object that describes the situation to the client.</span></span> <span data-ttu-id="07714-208">Notez que certains fournisseurs peuvent accéder aux sources de données en série et peuvent ne pas rencontrer de refus jusqu’à la partie de l’énumération.</span><span class="sxs-lookup"><span data-stu-id="07714-208">Note that some providers may access data sources serially and may not encounter denials until partway through the enumeration.</span></span>

-   <span data-ttu-id="07714-209">Retourne toutes les instances accessibles, mais retourne également le code d’État non erreur **\_ accès WBEM S \_ \_ refusé**.</span><span class="sxs-lookup"><span data-stu-id="07714-209">Return all of the instances that can be accessed but also return the nonerror status code **WBEM\_S\_ACCESS\_DENIED**.</span></span>

    <span data-ttu-id="07714-210">Le fournisseur doit noter le refus au cours de l’énumération et peut continuer à fournir des instances, en se terminant par le code d’état des erreurs.</span><span class="sxs-lookup"><span data-stu-id="07714-210">The provider should note the denial during enumeration and may continue providing instances, finishing up with the nonerror status code.</span></span> <span data-ttu-id="07714-211">Le fournisseur peut également choisir de terminer l’énumération au premier refus.</span><span class="sxs-lookup"><span data-stu-id="07714-211">The provider may also elect to terminate the enumeration at the first denial.</span></span> <span data-ttu-id="07714-212">La justification de cette option est que les différents fournisseurs ont des paradigmes de récupération différents.</span><span class="sxs-lookup"><span data-stu-id="07714-212">The justification for this option is that different providers have different retrieval paradigms.</span></span> <span data-ttu-id="07714-213">Un fournisseur a peut-être déjà fourni des instances avant de découvrir une violation d’accès.</span><span class="sxs-lookup"><span data-stu-id="07714-213">A provider may have already delivered instances before discovering an access violation.</span></span> <span data-ttu-id="07714-214">Certains fournisseurs peuvent choisir de continuer à fournir d’autres instances et d’autres peuvent souhaiter se terminer.</span><span class="sxs-lookup"><span data-stu-id="07714-214">Some providers may elect to continue providing other instances and others may wish to terminate.</span></span>

<span data-ttu-id="07714-215">En raison de la structure de COM, vous ne pouvez pas marshaler les informations pendant une erreur à l’exception d’un objet d’erreur.</span><span class="sxs-lookup"><span data-stu-id="07714-215">Due to the structure of COM, you cannot marshal back any information during an error except for an error object.</span></span> <span data-ttu-id="07714-216">Par conséquent, vous ne pouvez pas retourner à la fois les informations et un code d’erreur.</span><span class="sxs-lookup"><span data-stu-id="07714-216">Therefore, you cannot return both information and an error code.</span></span> <span data-ttu-id="07714-217">Si vous choisissez de retourner des informations, vous devez utiliser un code d’état de non-erreur.</span><span class="sxs-lookup"><span data-stu-id="07714-217">If you choose to return information, you must use a nonerror status code instead.</span></span>

## <a name="debugging-your-access-denied-code"></a><span data-ttu-id="07714-218">Débogage de votre code d’accès refusé</span><span class="sxs-lookup"><span data-stu-id="07714-218">Debugging Your Access Denied Code</span></span>

<span data-ttu-id="07714-219">Certaines applications peuvent utiliser des niveaux d’emprunt d’identité inférieurs à l' **\_ emprunt d' \_ \_ \_ identité RPC C IMP**.</span><span class="sxs-lookup"><span data-stu-id="07714-219">Some applications may use impersonation levels lower than **RPC\_C\_IMP\_LEVEL\_IMPERSONATE**.</span></span> <span data-ttu-id="07714-220">Dans ce cas, la plupart des appels d’emprunt d’identité effectués par le fournisseur pour l’application cliente échouent.</span><span class="sxs-lookup"><span data-stu-id="07714-220">In this case, most impersonation calls made by the provider for the client application will fail.</span></span> <span data-ttu-id="07714-221">Pour concevoir et implémenter un fournisseur avec succès, vous devez garder cette idée à l’esprit.</span><span class="sxs-lookup"><span data-stu-id="07714-221">To successfully design and implement a provider, you must keep this idea in mind.</span></span>

<span data-ttu-id="07714-222">Par défaut, le seul autre niveau d’emprunt d’identité qui peut accéder à un fournisseur est **RPC \_ C \_ IMP \_ Level \_ identifier**.</span><span class="sxs-lookup"><span data-stu-id="07714-222">By default, the only other level of impersonation that can access a provider is **RPC\_C\_IMP\_LEVEL\_IDENTIFY**.</span></span> <span data-ttu-id="07714-223">Dans les cas où une application cliente utilise l' **\_ \_ \_ \_ identifiant RPC C IMP Level**, [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) ne retourne pas de code d’erreur.</span><span class="sxs-lookup"><span data-stu-id="07714-223">In cases where a client application uses **RPC\_C\_IMP\_LEVEL\_IDENTIFY**, [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) does not return an error code.</span></span> <span data-ttu-id="07714-224">Au lieu de cela, le fournisseur emprunte l’identité du client à des fins d’identification uniquement.</span><span class="sxs-lookup"><span data-stu-id="07714-224">Instead, the provider impersonates the client for identification purposes only.</span></span> <span data-ttu-id="07714-225">Par conséquent, la plupart des méthodes Windows appelées par le fournisseur renverront un message d’accès refusé.</span><span class="sxs-lookup"><span data-stu-id="07714-225">Therefore, most Windows methods called by the provider will return an access denied message.</span></span> <span data-ttu-id="07714-226">Cela n’est pas sans conséquence dans la pratique, car les utilisateurs ne sont pas autorisés à faire quelque chose d’inapproprié.</span><span class="sxs-lookup"><span data-stu-id="07714-226">This is harmless in practice, as users will not be permitted to do anything inappropriate.</span></span> <span data-ttu-id="07714-227">Toutefois, il peut être utile pendant le développement du fournisseur de savoir si le client a fait l’emprunt d’identité ou non.</span><span class="sxs-lookup"><span data-stu-id="07714-227">However, it may be useful during provider development to know whether the client was truly impersonated or not.</span></span>

<span data-ttu-id="07714-228">Le code requiert les références suivantes et les \# instructions include pour être compilées correctement.</span><span class="sxs-lookup"><span data-stu-id="07714-228">The code requires the following references and \#include statements to compile correctly.</span></span>


```C++
#define _WIN32_DCOM
#include <iostream>
using namespace std;
#include <wbemidl.h>
```



<span data-ttu-id="07714-229">L’exemple de code suivant montre comment déterminer si un fournisseur a correctement emprunté une application cliente.</span><span class="sxs-lookup"><span data-stu-id="07714-229">The following code example shows how to determine whether a provider has successfully impersonated a client application.</span></span>


```C++
DWORD dwImp = 0;
HANDLE hThreadTok;
DWORD dwBytesReturned;
BOOL bRes;

// You must call this before trying to open a thread token!
CoImpersonateClient();

bRes = OpenThreadToken(
    GetCurrentThread(),
    TOKEN_QUERY,
    TRUE,
    &hThreadTok
);

if (bRes == FALSE)
{
    printf("Unable to read thread token (%d)\n", GetLastError());
    return 0;
}

bRes = GetTokenInformation(
    hThreadTok,
    TokenImpersonationLevel, 
    &dwImp,
    sizeof(DWORD),
    &dwBytesReturned
);

if (!bRes)
{
    printf("Unable to read impersonation level\n");
    CloseHandle(hThreadTok);
    return 0;
}

switch (dwImp)
{
case SecurityAnonymous:
    printf("SecurityAnonymous\n");
    break;

case SecurityIdentification:
    printf("SecurityIdentification\n");
    break;

case SecurityImpersonation:
    printf("SecurityImpersonation\n");
    break;

case SecurityDelegation:
    printf("SecurityDelegation\n");
    break;

default:
    printf("Error. Unable to determine impersonation level\n");
    break;
}

CloseHandle(hThreadTok);
```



## <a name="related-topics"></a><span data-ttu-id="07714-230">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="07714-230">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="07714-231">Développement d’un fournisseur WMI</span><span class="sxs-lookup"><span data-stu-id="07714-231">Developing a WMI Provider</span></span>](developing-a-wmi-provider.md)
</dt> <dt>

[<span data-ttu-id="07714-232">Définition des descripteurs de sécurité espace</span><span class="sxs-lookup"><span data-stu-id="07714-232">Setting Namepace Security Descriptors</span></span>](setting-namespace-security-descriptors.md)
</dt> <dt>

[<span data-ttu-id="07714-233">Sécurisation de votre fournisseur</span><span class="sxs-lookup"><span data-stu-id="07714-233">Securing Your Provider</span></span>](securing-your-provider.md)
</dt> </dl>

 

 
