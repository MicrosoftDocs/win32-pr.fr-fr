---
description: Dans Windows 7, les API de plateforme de haut niveau qui utilisent des API audio de base, telles que Media Foundation, DirectSound et les API Wave, implémentent la fonctionnalité de routage de flux en gérant le basculement de flux d’un appareil existant vers un nouveau point de terminaison audio par défaut.
ms.assetid: ecda0b5b-6583-43b4-a9b4-f12a95f09452
title: Considérations relatives à l’implémentation du routage de flux
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 27dc1f7e3fe56d6b421ca59f528ab1a65d2261a9
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103950671"
---
# <a name="stream-routing-implementation-considerations"></a><span data-ttu-id="4847c-103">Considérations relatives à l’implémentation du routage de flux</span><span class="sxs-lookup"><span data-stu-id="4847c-103">Stream Routing Implementation Considerations</span></span>

<span data-ttu-id="4847c-104">Dans Windows 7, les API de plateforme de haut niveau qui utilisent des API audio de base, telles que Media Foundation, DirectSound et les API Wave, implémentent la fonctionnalité de routage de flux en gérant le basculement de flux d’un appareil existant vers un nouveau point de terminaison audio par défaut.</span><span class="sxs-lookup"><span data-stu-id="4847c-104">In Windows 7, high-level platform APIs that use Core Audio APIs, such as Media Foundation, DirectSound, and Wave APIs, implement the stream routing feature by handling stream switching from an existing device to a new default audio endpoint.</span></span> <span data-ttu-id="4847c-105">Les applications multimédias qui utilisent ces API utilisent le comportement de routage de flux sans aucune modification de la source.</span><span class="sxs-lookup"><span data-stu-id="4847c-105">Media applications that use these APIs use the stream routing behavior without any modifications to the source.</span></span> <span data-ttu-id="4847c-106">Les clients WASAPI directs peuvent utiliser les notifications envoyées par les composants audio principaux et implémenter la fonctionnalité de routage de flux.</span><span class="sxs-lookup"><span data-stu-id="4847c-106">Direct WASAPI clients can use the notifications sent by Core Audio components and implement the stream routing feature.</span></span>

<span data-ttu-id="4847c-107">Les clients WASAPI directs (applications multimédias qui utilisent WASAPI directement) reçoivent de nouvelles notifications de session audio et de périphérique envoyées par les principaux composants audio.</span><span class="sxs-lookup"><span data-stu-id="4847c-107">Direct WASAPI clients (media applications that use WASAPI directly) receive new device and audio session notifications sent by Core Audio components.</span></span> <span data-ttu-id="4847c-108">Le comportement de la fonctionnalité de routage de flux est défini par la manière dont l’application gère ces notifications.</span><span class="sxs-lookup"><span data-stu-id="4847c-108">The behavior of the stream routing feature is defined by how the application handles these notifications.</span></span>

<span data-ttu-id="4847c-109">L’API MMDevice et la session audio envoient des notifications sur les modifications de l’état des appareils et les modifications de session des clients WASAPI sous la forme de rappels.</span><span class="sxs-lookup"><span data-stu-id="4847c-109">MMDevice API and the audio session send notifications about device state changes and session changes to WASAPI clients in the form of callbacks.</span></span> <span data-ttu-id="4847c-110">Pour recevoir ces notifications, le client doit inscrire son implémentation de [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) et [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span><span class="sxs-lookup"><span data-stu-id="4847c-110">To get these notifications, the client must register its implementation of [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span></span> <span data-ttu-id="4847c-111">Pour plus d’informations, consultez [notifications pertinentes pour le routage de flux](relevant-device-notifications-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="4847c-111">For more information, see [Relevant Notifications for Stream Routing](relevant-device-notifications-for-stream-routing.md).</span></span>

<span data-ttu-id="4847c-112">Dans le scénario de casque USB décrit dans [routage de flux](stream-routing.md), une application lit un flux audio et utilise MMDEVICEAPI et WASAPI pour afficher le flux sur le périphérique de rendu par défaut, l' **intervenant**.</span><span class="sxs-lookup"><span data-stu-id="4847c-112">In the USB headset scenario described in [Stream Routing](stream-routing.md), an application is playing an audio stream and uses MMDeviceAPI and WASAPI to render the stream on the default rendering device, **Speaker**.</span></span> <span data-ttu-id="4847c-113">Lorsque l’appareil par défaut est modifié, l’application reçoit une notification [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) .</span><span class="sxs-lookup"><span data-stu-id="4847c-113">When the default device is changed, the application receives an [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="4847c-114">L’application reçoit également des notifications [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) indiquant que l’utilisateur a supprimé l’appareil de point de terminaison audio ou que le format de flux de données a changé pour l’appareil auquel la session audio est connectée.</span><span class="sxs-lookup"><span data-stu-id="4847c-114">The application also receives [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications indicating that the user removed the audio endpoint device or that the stream format changed for the device that the audio session is connected to.</span></span> <span data-ttu-id="4847c-115">Lors de la réception des notifications, l’application arrête la diffusion en continu vers le point de terminaison de l’orateur et ouvre à nouveau le flux de rendu sur le point de terminaison par défaut actuel, le casque.</span><span class="sxs-lookup"><span data-stu-id="4847c-115">Upon receiving the notifications, the application stops streaming to the speaker endpoint and reopens the stream for rendering on the current default endpoint, the headset.</span></span>

![diagramme de workflow pour les notifications d’appareil.](images/stream-routing.gif)

<span data-ttu-id="4847c-117">En réponse à ces notifications, le client peut rouvrir le flux sur le nouvel appareil par défaut dans le nouveau format sélectionné par l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="4847c-117">In response to such notifications, the client might reopen the stream on the new default device in the new format selected by the user.</span></span>

## <a name="stream-managment"></a><span data-ttu-id="4847c-118">Gestion de flux</span><span class="sxs-lookup"><span data-stu-id="4847c-118">Stream Managment</span></span>

<span data-ttu-id="4847c-119">La liste suivante résume les étapes qu’un client WASAPI doit effectuer pour fournir la fonctionnalité de basculement de flux.</span><span class="sxs-lookup"><span data-stu-id="4847c-119">The following list summarizes the steps that a WASAPI client must perform to provide the stream switching functionality.</span></span>

1.  <span data-ttu-id="4847c-120">Attendez la notification [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) appropriée.</span><span class="sxs-lookup"><span data-stu-id="4847c-120">Wait for the relevant [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="4847c-121">Si l’appareil est l’appareil par défaut, la notification [**IMMNotificationClient :: OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) est reçue.</span><span class="sxs-lookup"><span data-stu-id="4847c-121">If the device is the default device, the [**IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) notification is received.</span></span>
2.  <span data-ttu-id="4847c-122">Si un nouvel appareil est disponible, obtenir une référence au point de terminaison du nouvel appareil.</span><span class="sxs-lookup"><span data-stu-id="4847c-122">If a new device is available, get a reference to the endpoint of the new device.</span></span> <span data-ttu-id="4847c-123">Appelez [**IMMDeviceEnumerator :: GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) pour le nouvel appareil par défaut.</span><span class="sxs-lookup"><span data-stu-id="4847c-123">Call [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) for the new default device.</span></span> <span data-ttu-id="4847c-124">Si le nouvel appareil n’est pas le périphérique par défaut, vous pouvez récupérer l’appareil en appelant [**IMMDeviceEnumerator :: GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span><span class="sxs-lookup"><span data-stu-id="4847c-124">If the new device is not the default device, you can retrieve the device by calling [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span></span> <span data-ttu-id="4847c-125">Pour plus d’informations, consultez [obtention du point de terminaison de l’appareil pour le routage de flux](getting-the-default-device-endpoint-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="4847c-125">For more information, see [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span></span>
3.  <span data-ttu-id="4847c-126">Attendez que [**IAudioSessionEvents :: OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) avec la valeur Reason.</span><span class="sxs-lookup"><span data-stu-id="4847c-126">Wait for the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) with the reason value.</span></span>
    > [!Note]  
    > <span data-ttu-id="4847c-127">Étant donné que toutes ces opérations sont asynchrone, l’ordre dans lequel l’application reçoit les notifications de modification d’appareil et de déconnexion de session ne peut pas être prédit.</span><span class="sxs-lookup"><span data-stu-id="4847c-127">Because all of these operations are asychronous, the order in which the application receives device-change and session-disconnect notifications cannnot be predicted.</span></span> <span data-ttu-id="4847c-128">L’application doit implémenter la gestion des notifications pour recevoir ces notifications dans n’importe quel ordre.</span><span class="sxs-lookup"><span data-stu-id="4847c-128">The application must implement notification handling to receive these notifications in any order.</span></span> <span data-ttu-id="4847c-129">Toutefois, en général, l’application reçoit la valeur **AudioSessionDisconnect** avant la notification de modification d’appareil par défaut.</span><span class="sxs-lookup"><span data-stu-id="4847c-129">However, typically, the application receives **AudioSessionDisconnect** value before the default device change notification.</span></span>

     

4.  <span data-ttu-id="4847c-130">Évaluez la valeur de raison et déterminez si le flux doit être transféré vers un autre point de terminaison audio ou si le flux doit être réinitialisé avec un nouveau format.</span><span class="sxs-lookup"><span data-stu-id="4847c-130">Evaluate the reason value and determine whether the stream needs to be transferred to another audio endpoint or the stream needs to be reinitialized with a new format.</span></span>
5.  <span data-ttu-id="4847c-131">Arrêter la diffusion en continu vers l’ancien appareil par défaut si la raison indique que le flux doit être redirigé vers le nouvel appareil par défaut.</span><span class="sxs-lookup"><span data-stu-id="4847c-131">Stop streaming to the old default device if the reason indicates that the stream should be re-routed to the new default device.</span></span>
6.  <span data-ttu-id="4847c-132">Effectuez des calculs de mappage de position.</span><span class="sxs-lookup"><span data-stu-id="4847c-132">Perform position mapping calculations.</span></span>
7.  <span data-ttu-id="4847c-133">Ouvrez le flux sur le nouvel appareil et transférez toutes les informations d’État.</span><span class="sxs-lookup"><span data-stu-id="4847c-133">Open the stream on the new device and transfer all state information.</span></span>
8.  <span data-ttu-id="4847c-134">Reprendre la diffusion sur le nouvel appareil par défaut.</span><span class="sxs-lookup"><span data-stu-id="4847c-134">Resume streaming on the new default device.</span></span>
9.  <span data-ttu-id="4847c-135">Gérer le départ de l’ancien appareil par défaut.</span><span class="sxs-lookup"><span data-stu-id="4847c-135">Handle the departure of the old default device.</span></span>

<span data-ttu-id="4847c-136">Pour que l’opération de basculement de flux apparaisse transparente, elle doit être effectuée aussi rapidement que possible.</span><span class="sxs-lookup"><span data-stu-id="4847c-136">To make the stream switching operation appear seamless, it must be done as quickly as possible.</span></span> <span data-ttu-id="4847c-137">Cela dépend des performances des composants impliqués dans la réinitialisation du flux sur le nouvel appareil.</span><span class="sxs-lookup"><span data-stu-id="4847c-137">This depends on the performance of the components involved in re-initiation of the stream on the new device.</span></span>

## <a name="position-mapping-considerations"></a><span data-ttu-id="4847c-138">Considérations relatives au mappage de position</span><span class="sxs-lookup"><span data-stu-id="4847c-138">Position Mapping Considerations</span></span>

<span data-ttu-id="4847c-139">Lorsque l’application obtient des notifications [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) et [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) , elle peut acheminer les flux existants vers le nouvel appareil par défaut.</span><span class="sxs-lookup"><span data-stu-id="4847c-139">When the application gets [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications, it can route the existing streams to the new default device.</span></span> <span data-ttu-id="4847c-140">Lorsqu’un flux audio existant est interrompu et ouvert sur le nouvel appareil, le rendu sur le nouvel appareil doit commencer à la position à laquelle le flux a été arrêté sur l’ancien appareil.</span><span class="sxs-lookup"><span data-stu-id="4847c-140">When an existing audio stream is interrupted and opened on the new device, rendering on the new device must start at the position at which the stream was stopped on the old device.</span></span> <span data-ttu-id="4847c-141">Pour ce faire, l’application doit disposer de la dernière position de l’appareil connu, afin de calculer la position de départ sur le nouvel appareil.</span><span class="sxs-lookup"><span data-stu-id="4847c-141">To do this, the application must have the last known device position, to calculate the start position on the new device.</span></span> <span data-ttu-id="4847c-142">Par exemple, cette position peut être utilisée comme décalage Delta pour le mappage de position suivant.</span><span class="sxs-lookup"><span data-stu-id="4847c-142">For example, this position can be used as the delta offset for subsequent position mapping.</span></span> <span data-ttu-id="4847c-143">Lorsque le flux démarre le rendu, la nouvelle position de l’appareil peut être remappée à la position de l’appareil mis en cache.</span><span class="sxs-lookup"><span data-stu-id="4847c-143">When the stream starts rendering, the new device position can be remapped to the cached device position.</span></span>

<span data-ttu-id="4847c-144">Les étapes suivantes résument le processus de transition de flux continu.</span><span class="sxs-lookup"><span data-stu-id="4847c-144">The following steps summarize the process of making a seamless stream transition.</span></span>

1.  <span data-ttu-id="4847c-145">Met en cache la dernière position d’appareil du flux sur l’ancien appareil.</span><span class="sxs-lookup"><span data-stu-id="4847c-145">Cache the last device position of the stream on the old device.</span></span>
2.  <span data-ttu-id="4847c-146">Arrêtez le flux sur l’ancien appareil.</span><span class="sxs-lookup"><span data-stu-id="4847c-146">Stop the stream on the old device.</span></span>
3.  <span data-ttu-id="4847c-147">Effectuez des calculs de remappage pour accéder à la nouvelle position.</span><span class="sxs-lookup"><span data-stu-id="4847c-147">Perform remapping calculations to get the new position.</span></span>
4.  <span data-ttu-id="4847c-148">Commencez le rendu du flux sur le nouvel appareil.</span><span class="sxs-lookup"><span data-stu-id="4847c-148">Start rendering the stream on the new device.</span></span>
5.  <span data-ttu-id="4847c-149">Libérer l’ancien flux.</span><span class="sxs-lookup"><span data-stu-id="4847c-149">Release the old stream.</span></span>

<span data-ttu-id="4847c-150">Pendant la transition, l’application doit s’assurer que l’horloge n’est pas désynchronisée, ce qui provoque des flux audio et vidéo hors synchronisation.</span><span class="sxs-lookup"><span data-stu-id="4847c-150">During the transition, the application must ensure that the clock does not get out of synchronization, resulting in out-of-sync audio and video streams.</span></span> <span data-ttu-id="4847c-151">Cela peut se produire si les exemples de vidéos continuent de s’afficher pendant que le flux audio est routé vers le nouvel appareil.</span><span class="sxs-lookup"><span data-stu-id="4847c-151">This can occur if the video samples continue to render while the audio stream is routed to the new device.</span></span> <span data-ttu-id="4847c-152">L’application doit mettre en cache la position de l’horloge pour le calcul de remappage et vérifier que les exemples de vidéos ne sont pas rendus tant que le flux audio n’est pas rouvert sur le nouvel appareil, de sorte que lorsque le clip reprend le rendu, les flux audio et vidéo sont synchronisés.</span><span class="sxs-lookup"><span data-stu-id="4847c-152">The application must cache the clock position for the remapping calculation and make sure that the video samples are not rendered until the audio stream is reopened on the new device, so that when the clip resumes rendering, the audio and the video streams are synchronized.</span></span> <span data-ttu-id="4847c-153">Dans certains cas, lorsque l’heure de présentation du rendu des images vidéo est basée sur l’horloge audio, il suffit d’arrêter le flux audio jusqu’à ce que le basculement de flux soit terminé et qu’aucune autre implémentation de mappage de position pour le flux vidéo ne soit nécessaire pour la synchronisation vidéo audio.</span><span class="sxs-lookup"><span data-stu-id="4847c-153">In some cases, where the presentation time for rendering the video frames is based on the audio clock, it is sufficient to stop the audio stream until stream switching is complete and no other position mapping implementation for the video stream is necessary for audio video synchronization.</span></span>

<span data-ttu-id="4847c-154">Si le rendu est en cours, [**IAudioRenderClient :: GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) retourne une erreur, car l’ancien appareil est perdu, l’application n’a pas besoin d’arrêter l’ancien flux, car l’opération de diffusion en continu est déjà terminée.</span><span class="sxs-lookup"><span data-stu-id="4847c-154">If while rendering, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) returns an error because the old device is lost, the application need not stop the old stream because the streaming operation has already terminated.</span></span> <span data-ttu-id="4847c-155">Pour plus d’informations sur la gestion de cette erreur, consultez [récupération à partir d’une erreur de Invalid-Device](recovering-from-an-invalid-device-error.md).</span><span class="sxs-lookup"><span data-stu-id="4847c-155">For information about handling this error, see [Recovering from an Invalid-Device Error](recovering-from-an-invalid-device-error.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="4847c-156">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="4847c-156">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="4847c-157">À propos de l’API MMDevice</span><span class="sxs-lookup"><span data-stu-id="4847c-157">About MMDevice API</span></span>](mmdevice-api.md)
</dt> <dt>

[<span data-ttu-id="4847c-158">À propos de WASAPI</span><span class="sxs-lookup"><span data-stu-id="4847c-158">About WASAPI</span></span>](wasapi.md)
</dt> <dt>

[<span data-ttu-id="4847c-159">Routage de flux</span><span class="sxs-lookup"><span data-stu-id="4847c-159">Stream Routing</span></span>](stream-routing.md)
</dt> </dl>

 

 



