---
description: Enregistrement de bouclage
ms.assetid: 71c567f7-fffa-4b75-897a-63ed30c4c9b0
title: Enregistrement de bouclage
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 374da7497096118905f5e4c79bbacda832a42a7b
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103950752"
---
# <a name="loopback-recording"></a><span data-ttu-id="10d1d-103">Enregistrement de bouclage</span><span class="sxs-lookup"><span data-stu-id="10d1d-103">Loopback Recording</span></span>

<span data-ttu-id="10d1d-104">En mode de bouclage, un client de WASAPI peut capturer le flux audio qui est lu par un périphérique de point de terminaison de rendu.</span><span class="sxs-lookup"><span data-stu-id="10d1d-104">In loopback mode, a client of WASAPI can capture the audio stream that is being played by a rendering endpoint device.</span></span> <span data-ttu-id="10d1d-105">Pour ouvrir un flux en mode de bouclage, le client doit :</span><span class="sxs-lookup"><span data-stu-id="10d1d-105">To open a stream in loopback mode, the client must:</span></span>

-   <span data-ttu-id="10d1d-106">Obtenez une interface [**IMMDevice**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immdevice) pour l’appareil de point de terminaison de rendu.</span><span class="sxs-lookup"><span data-stu-id="10d1d-106">Obtain an [**IMMDevice**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immdevice) interface for the rendering endpoint device.</span></span>
-   <span data-ttu-id="10d1d-107">Initialisez un flux de capture en mode de bouclage sur le périphérique de point de terminaison de rendu.</span><span class="sxs-lookup"><span data-stu-id="10d1d-107">Initialize a capture stream in loopback mode on the rendering endpoint device.</span></span>

<span data-ttu-id="10d1d-108">Après avoir effectué ces étapes, le client peut appeler la méthode [**IAudioClient :: GetService**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-getservice) pour obtenir une interface [**IAudioCaptureClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudiocaptureclient) sur l’appareil de point de terminaison de rendu.</span><span class="sxs-lookup"><span data-stu-id="10d1d-108">After following these steps, the client can call the [**IAudioClient::GetService**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-getservice) method to obtain an [**IAudioCaptureClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudiocaptureclient) interface on the rendering endpoint device.</span></span>

<span data-ttu-id="10d1d-109">WASAPI fournit le mode de bouclage principalement pour prendre en charge l’annulation de l’écho acoustique (AEC).</span><span class="sxs-lookup"><span data-stu-id="10d1d-109">WASAPI provides loopback mode primarily to support acoustic echo cancellation (AEC).</span></span> <span data-ttu-id="10d1d-110">Toutefois, d’autres types d’applications audio peuvent être utiles en mode de bouclage pour capturer la combinaison de systèmes jouée par le moteur audio.</span><span class="sxs-lookup"><span data-stu-id="10d1d-110">However, other types of audio applications might find loopback mode useful for capturing the system mix that is being played by the audio engine.</span></span>

<span data-ttu-id="10d1d-111">Dans l’exemple de code de [capture d’un flux](capturing-a-stream.md), la fonction RecordAudioStream peut être facilement modifiée pour configurer un flux de capture en mode de bouclage.</span><span class="sxs-lookup"><span data-stu-id="10d1d-111">In the code example in [Capturing a Stream](capturing-a-stream.md), the RecordAudioStream function can be easily modified to configure a loopback-mode capture stream.</span></span> <span data-ttu-id="10d1d-112">Les modifications requises sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="10d1d-112">The required modifications are:</span></span>

-   <span data-ttu-id="10d1d-113">Dans l’appel à la méthode [**IMMDeviceEnumerator :: GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) , modifiez le premier paramètre (*flux* de données) de eCapture en eRender.</span><span class="sxs-lookup"><span data-stu-id="10d1d-113">In the call to the [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) method, change the first parameter (*dataFlow*) from eCapture to eRender.</span></span>
-   <span data-ttu-id="10d1d-114">Dans l’appel à la méthode [**IAudioClient :: Initialize**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-initialize) , modifiez la valeur du deuxième paramètre (*StreamFlags*) de 0 à AUDCLNT \_ StreamFlags \_ Loopback.</span><span class="sxs-lookup"><span data-stu-id="10d1d-114">In the call to the [**IAudioClient::Initialize**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-initialize) method, change the value of the second parameter (*StreamFlags*) from 0 to AUDCLNT\_STREAMFLAGS\_LOOPBACK.</span></span>

<span data-ttu-id="10d1d-115">Dans les versions de Windows antérieures à Windows 10 1703, le client de capture en mode Pull ne reçoit aucun événement lorsqu’un flux est initialisé avec une mise en mémoire tampon pilotée par les événements et qu’il est activé pour la boucle.</span><span class="sxs-lookup"><span data-stu-id="10d1d-115">In versions of Windows prior to Windows 10 1703, pull-mode capture client does not receive any events when a stream is initialized with event-driven buffering and is loopback-enabled.</span></span> <span data-ttu-id="10d1d-116">Pour contourner ce contournement, initialisez un flux de rendu en mode piloté par les événements.</span><span class="sxs-lookup"><span data-stu-id="10d1d-116">To work around this, initialize a render stream in event-driven mode.</span></span> <span data-ttu-id="10d1d-117">Chaque fois que le client reçoit un événement pour le flux de rendu, il doit signaler au client de capture d’exécuter le thread de capture qui lit le jeu d’exemples suivant dans la mémoire tampon du point de terminaison de capture.</span><span class="sxs-lookup"><span data-stu-id="10d1d-117">Each time the client receives an event for the render stream, it must signal the capture client to run the capture thread that reads the next set of samples from the capture endpoint buffer.</span></span> <span data-ttu-id="10d1d-118">Dans les versions 1703 et ultérieures de Windows 10, les clients de bouclage piloté par les événements sont pris en charge et n’ont plus besoin de la solution de contournement impliquant le flux de rendu.</span><span class="sxs-lookup"><span data-stu-id="10d1d-118">In Windows 10 versions 1703 and higher, event-driven loopback clients are supported, and no longer need the workaround involving the render stream.</span></span>  

<span data-ttu-id="10d1d-119">Un client peut activer le mode de bouclage uniquement pour un flux en mode partagé (AUDCLNT \_ SHAREMODE \_ partagé).</span><span class="sxs-lookup"><span data-stu-id="10d1d-119">A client can enable loopback mode only for a shared-mode stream (AUDCLNT\_SHAREMODE\_SHARED).</span></span> <span data-ttu-id="10d1d-120">Les flux en mode exclusif ne peuvent pas fonctionner en mode de bouclage.</span><span class="sxs-lookup"><span data-stu-id="10d1d-120">Exclusive-mode streams cannot operate in loopback mode.</span></span>

<span data-ttu-id="10d1d-121">L’implémentation du bouclage par WASAPI dépend des fonctionnalités du matériel.</span><span class="sxs-lookup"><span data-stu-id="10d1d-121">The implementation of loopback by WASAPI depend on the capabilities of the hardware.</span></span> <span data-ttu-id="10d1d-122">Si le matériel prend en charge un code confidentiel de bouclage sur le point de terminaison de rendu, WASAPI utilise le son fourni sur ce code PIN pour le flux de bouclage.</span><span class="sxs-lookup"><span data-stu-id="10d1d-122">If the hardware supports a loopback pin on the render endpoint, WASAPI uses the audio provided on this pin for the loopback stream.</span></span> <span data-ttu-id="10d1d-123">Lorsque le matériel ne prend pas en charge un code confidentiel de bouclage, WASAPI copie le flux de sortie du moteur audio dans la mémoire tampon de capture de l’application de bouclage, en plus de copier les données audio sur la broche de rendu du matériel.</span><span class="sxs-lookup"><span data-stu-id="10d1d-123">When the hardware does not support a loopback pin, WASAPI copies the output stream from the audio engine into the loopback application's capture buffer, in addition to copying the audio data to the hardware's render pin.</span></span>

<span data-ttu-id="10d1d-124">Certains fournisseurs de matériel implémentent des périphériques de bouclage (par opposition à épingler des instances sur des appareils de rendu) dans leurs adaptateurs audio.</span><span class="sxs-lookup"><span data-stu-id="10d1d-124">Some hardware vendors implement loopback devices (as opposed to pin instances on render devices) in their audio adapters.</span></span> <span data-ttu-id="10d1d-125">Bien que les périphériques de bouclage matériel soient similaires en fonctionnement au mode de bouclage WASAPI, ils peuvent être plus difficiles à utiliser.</span><span class="sxs-lookup"><span data-stu-id="10d1d-125">Although hardware loopback devices are similar in operation to the WASAPI loopback mode, they can be more difficult to use.</span></span>

<span data-ttu-id="10d1d-126">Les périphériques de bouclage matériel présentent les inconvénients suivants pour les applications audio :</span><span class="sxs-lookup"><span data-stu-id="10d1d-126">Hardware loopback devices have the following disadvantages for audio applications:</span></span>

-   <span data-ttu-id="10d1d-127">Les cartes audio n’ont pas toutes des périphériques de bouclage.</span><span class="sxs-lookup"><span data-stu-id="10d1d-127">Not all audio adapters have loopback devices.</span></span> <span data-ttu-id="10d1d-128">Ainsi, les applications qui en dépendent ne fonctionneront pas sur tous les systèmes.</span><span class="sxs-lookup"><span data-stu-id="10d1d-128">Thus, applications that depend on them will not work on all systems.</span></span>
-   <span data-ttu-id="10d1d-129">Avant qu’une application puisse enregistrer à partir d’un périphérique de bouclage, l’utilisateur doit identifier le périphérique de bouclage et l’activer pour l’utiliser.</span><span class="sxs-lookup"><span data-stu-id="10d1d-129">Before an application can record from a loopback device, the user must identify the loopback device and enable it for use.</span></span>

<span data-ttu-id="10d1d-130">Différents fournisseurs attribuent des noms différents à leurs périphériques de bouclage matériels.</span><span class="sxs-lookup"><span data-stu-id="10d1d-130">Different vendors assign different names to their hardware loopback devices.</span></span> <span data-ttu-id="10d1d-131">Les noms suivants sont des exemples :</span><span class="sxs-lookup"><span data-stu-id="10d1d-131">The following names are examples:</span></span>

-   <span data-ttu-id="10d1d-132">Combinaison stéréo</span><span class="sxs-lookup"><span data-stu-id="10d1d-132">Stereo Mix</span></span>
-   <span data-ttu-id="10d1d-133">WaveOut Mix</span><span class="sxs-lookup"><span data-stu-id="10d1d-133">Waveout Mix</span></span>
-   <span data-ttu-id="10d1d-134">Sortie mixte</span><span class="sxs-lookup"><span data-stu-id="10d1d-134">Mixed Output</span></span>
-   <span data-ttu-id="10d1d-135">Ce que vous entendez</span><span class="sxs-lookup"><span data-stu-id="10d1d-135">What You Hear</span></span>

<span data-ttu-id="10d1d-136">L’absence de noms standardisés peut amener les utilisateurs à avoir des difficultés à identifier un périphérique de bouclage dans une liste de noms d’appareils.</span><span class="sxs-lookup"><span data-stu-id="10d1d-136">The lack of standardized names might cause users to have difficulty identifying a loopback device in a list of device names.</span></span>

<span data-ttu-id="10d1d-137">Un périphérique de bouclage matériel est un périphérique de capture.</span><span class="sxs-lookup"><span data-stu-id="10d1d-137">A hardware loopback device is a capture device.</span></span> <span data-ttu-id="10d1d-138">Ainsi, si un adaptateur prend en charge un périphérique de bouclage, une application audio peut enregistrer à partir de l’appareil de la même manière qu’il enregistre depuis n’importe quel autre périphérique de capture.</span><span class="sxs-lookup"><span data-stu-id="10d1d-138">Thus, if an adapter supports a loopback device, an audio application can record from the device in the same way that it records from any other capture device.</span></span>

<span data-ttu-id="10d1d-139">Par exemple, si vous sélectionnez un périphérique de bouclage matériel comme périphérique de capture par défaut, vous pouvez utiliser la fonction RecordAudioStream (sans modification) dans l’exemple de code de [capture d’un flux](capturing-a-stream.md) pour capturer le flux de l’appareil.</span><span class="sxs-lookup"><span data-stu-id="10d1d-139">For example, if you select a hardware loopback device to be the default capture device, you can use the RecordAudioStream function (without modification) in the code example in [Capturing a Stream](capturing-a-stream.md) to capture the stream from the device.</span></span> <span data-ttu-id="10d1d-140">(Vous pouvez également utiliser une API audio héritée, telle que les fonctions **WaveInXxx** Windows Multimedia, pour capturer le flux de données à partir de l’appareil.)</span><span class="sxs-lookup"><span data-stu-id="10d1d-140">(You can also use a legacy audio API, such as the Windows multimedia **waveInXxx** functions, to capture the stream from the device.)</span></span>

<span data-ttu-id="10d1d-141">Si votre carte audio contient un périphérique de bouclage matériel, vous pouvez utiliser le panneau de configuration multimédia de Windows, Mmsys.cpl, pour désigner l’appareil comme périphérique de capture par défaut.</span><span class="sxs-lookup"><span data-stu-id="10d1d-141">If your audio adapter contains a hardware loopback device, you can use the Windows multimedia control panel, Mmsys.cpl, to designate the device as the default capture device.</span></span> <span data-ttu-id="10d1d-142">La procédure comporte trois étapes :</span><span class="sxs-lookup"><span data-stu-id="10d1d-142">The steps are as follows:</span></span>

1.  <span data-ttu-id="10d1d-143">Pour exécuter Mmsys.cpl, ouvrez une fenêtre d’invite de commandes et entrez la commande suivante :</span><span class="sxs-lookup"><span data-stu-id="10d1d-143">To run Mmsys.cpl, open a Command Prompt window and enter the following command:</span></span>

    ```C++
    control mmsys.cpl,,1
    ```

    

    <span data-ttu-id="10d1d-144">Vous pouvez également exécuter Mmsys.cpl en cliquant avec le bouton droit sur l’icône de haut-parleur dans la zone de notification, située sur le côté droit de la barre des tâches, puis en sélectionnant **périphériques d’enregistrement**.</span><span class="sxs-lookup"><span data-stu-id="10d1d-144">Alternatively, you can run Mmsys.cpl by right-clicking the speaker icon in the notification area, which is located on the right side of the taskbar, and selecting **Recording Devices**.</span></span>

2.  <span data-ttu-id="10d1d-145">Une fois la fenêtre de Mmsys.cpl ouverte, cliquez avec le bouton droit n’importe où dans la liste des périphériques d’enregistrement et vérifiez que l’option **afficher les périphériques désactivés** est cochée.</span><span class="sxs-lookup"><span data-stu-id="10d1d-145">After the Mmsys.cpl window opens, right-click anywhere in the list of recording devices and verify that the **Show Disabled Devices** option is checked.</span></span> <span data-ttu-id="10d1d-146">(Dans le cas contraire, si le périphérique de bouclage est désactivé, il n’apparaîtra pas dans la liste.)</span><span class="sxs-lookup"><span data-stu-id="10d1d-146">(Otherwise, if the loopback device is disabled, it will not appear in the list.)</span></span>
3.  <span data-ttu-id="10d1d-147">Parcourez la liste des périphériques d’enregistrement pour localiser le périphérique de bouclage (s’il existe).</span><span class="sxs-lookup"><span data-stu-id="10d1d-147">Browse the list of recording devices to locate the loopback device (if it exists).</span></span> <span data-ttu-id="10d1d-148">Si le périphérique de bouclage est désactivé, activez-le en cliquant avec le bouton droit sur l’appareil et en cliquant sur **activer**.</span><span class="sxs-lookup"><span data-stu-id="10d1d-148">If the loopback device is disabled, enable it by right-clicking the device and clicking **Enable**.</span></span>
4.  <span data-ttu-id="10d1d-149">Enfin, pour sélectionner le périphérique de bouclage comme périphérique de capture par défaut, cliquez avec le bouton droit sur l’appareil, puis cliquez sur **définir en tant qu’appareil par défaut**.</span><span class="sxs-lookup"><span data-stu-id="10d1d-149">Finally, to select the loopback device to be the default capture device, right-click the device and click **Set as Default Device**.</span></span>

<span data-ttu-id="10d1d-150">WASAPI prend en charge l’enregistrement de bouclage, que le matériel audio contienne ou non un périphérique de bouclage, ou que l’utilisateur ait activé l’appareil.</span><span class="sxs-lookup"><span data-stu-id="10d1d-150">WASAPI supports loopback recording regardless of whether the audio hardware contains a loopback device, or whether the user has enabled the device.</span></span>

<span data-ttu-id="10d1d-151">Windows Vista fournit la gestion des droits numériques (DRM).</span><span class="sxs-lookup"><span data-stu-id="10d1d-151">Windows Vista provides digital rights management (DRM).</span></span> <span data-ttu-id="10d1d-152">Les fournisseurs de contenu s’appuient sur DRM pour protéger leur musique propriétaire ou tout autre contenu contre toute copie non autorisée et toute autre utilisation illégale.</span><span class="sxs-lookup"><span data-stu-id="10d1d-152">Content providers rely on DRM to protect their proprietary music or other content from unauthorized copying and other illegal uses.</span></span> <span data-ttu-id="10d1d-153">De même, un pilote audio approuvé n’autorise pas un périphérique de bouclage à capturer des flux numériques contenant du contenu protégé.</span><span class="sxs-lookup"><span data-stu-id="10d1d-153">Similarly, a trusted audio driver does not permit a loopback device to capture digital streams that contain protected content.</span></span> <span data-ttu-id="10d1d-154">Windows Vista permet uniquement aux pilotes approuvés de lire du contenu protégé.</span><span class="sxs-lookup"><span data-stu-id="10d1d-154">Windows Vista allows only trusted drivers to play protected content.</span></span> <span data-ttu-id="10d1d-155">Pour plus d’informations sur les pilotes approuvés et la DRM, consultez la documentation de Windows DDK.</span><span class="sxs-lookup"><span data-stu-id="10d1d-155">For more information about trusted drivers and DRM, see the Windows DDK documentation.</span></span>

<span data-ttu-id="10d1d-156">Le bouclage WASAPI contient la combinaison de tout le son en cours de lecture, quelle que soit la session des services Terminal Server à partir de laquelle le son provient.</span><span class="sxs-lookup"><span data-stu-id="10d1d-156">WASAPI loopback contains the mix of all audio being played, regardless of the Terminal Services session the audio originated from.</span></span> <span data-ttu-id="10d1d-157">Par exemple, vous pouvez exécuter un client de bouclage dans un service s’exécutant dans la session 0 et capturer l’audio de toutes les sessions utilisateur, ainsi que le son lu à partir de la session 0.</span><span class="sxs-lookup"><span data-stu-id="10d1d-157">For example, you can run a loopback client in a service running in session 0 and capture audio from all user sessions, as well as audio being played from session 0.</span></span>

<span data-ttu-id="10d1d-158">Bureau à distance permet de rediriger l’audio vers le client.</span><span class="sxs-lookup"><span data-stu-id="10d1d-158">Remote Desktop allows redirecting audio to the client.</span></span> <span data-ttu-id="10d1d-159">Cela est implémenté par la création de nouveaux périphériques audio qui apparaissent uniquement pour cette session.</span><span class="sxs-lookup"><span data-stu-id="10d1d-159">This is implemented by creating new audio devices that only appear for that session.</span></span>

## <a name="related-topics"></a><span data-ttu-id="10d1d-160">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="10d1d-160">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="10d1d-161">Gestion de flux</span><span class="sxs-lookup"><span data-stu-id="10d1d-161">Stream Management</span></span>](stream-management.md)
</dt> </dl>

 

 



