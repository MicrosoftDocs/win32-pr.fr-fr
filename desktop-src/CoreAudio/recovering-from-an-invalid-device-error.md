---
description: Récupération à partir d’une erreur Invalid-Device
ms.assetid: 1f5c3458-70ca-45ba-ac33-5c7b9f092320
title: Récupération à partir d’une erreur Invalid-Device
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ca20c32be46367f53a14ce26c39f980e3649b652
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104111306"
---
# <a name="recovering-from-an-invalid-device-error"></a><span data-ttu-id="cdb9d-103">Récupération à partir d’une erreur Invalid-Device</span><span class="sxs-lookup"><span data-stu-id="cdb9d-103">Recovering from an Invalid-Device Error</span></span>

<span data-ttu-id="cdb9d-104">La plupart des méthodes de WASAPI renvoient le code d’erreur AUDCLNT \_ E \_ Device \_ invalidé si l’appareil de point de terminaison audio utilisé par l’application cliente n’est pas valide.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-104">Many of the methods in WASAPI return error code AUDCLNT\_E\_DEVICE\_INVALIDATED if the audio endpoint device that the client application is using becomes invalid.</span></span> <span data-ttu-id="cdb9d-105">Ce code d’erreur indique que l’appareil de point de terminaison a été débranché, ou que le matériel audio ou les ressources matérielles associées ont été reconfigurés, désactivés, supprimés ou rendus indisponibles pour utilisation.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-105">This error code indicates that the endpoint device has been unplugged, or that the audio hardware or associated hardware resources have been reconfigured, disabled, removed, or otherwise made unavailable for use.</span></span> <span data-ttu-id="cdb9d-106">Souvent, l’application peut récupérer à partir de cette erreur.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-106">Frequently, the application can recover from this error.</span></span>

>[!NOTE]
> <span data-ttu-id="cdb9d-107">Pour plus d’informations sur la récupération à partir d’erreurs d’appareil non valides lors de l’utilisation d’API audio spatiales (ISAC), consultez [récupération d’une erreur de Invalid-Device (son spatial)](recovering-from-an-invalid-device-error-spatial-sound.md)</span><span class="sxs-lookup"><span data-stu-id="cdb9d-107">For information on recovering from invalid device errors when using spatial audio APIs (ISAC), see [Recovering from an Invalid-Device Error (Spatial Sound)](recovering-from-an-invalid-device-error-spatial-sound.md)</span></span>

<span data-ttu-id="cdb9d-108">La stratégie qu’une application doit utiliser pour récupérer à partir d’une \_ erreur d’invalidation de l’appareil AUDCLNT E dépend de \_ \_ laquelle des techniques suivantes sont utilisées par l’application pour sélectionner un périphérique de point de terminaison audio :</span><span class="sxs-lookup"><span data-stu-id="cdb9d-108">The strategy that an application should use to recover from an AUDCLNT\_E\_DEVICE\_INVALIDATED error depends on which of the following techniques the application uses to select an audio endpoint device:</span></span>

-   <span data-ttu-id="cdb9d-109">Sélectionnez toujours l’appareil de rendu ou de capture audio par défaut.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-109">Always select the default audio rendering or capture device.</span></span>
-   <span data-ttu-id="cdb9d-110">Sélectionnez un périphérique de point de terminaison audio spécifique.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-110">Select a specific audio endpoint device.</span></span>

<span data-ttu-id="cdb9d-111">Dans ce dernier cas, soit l’application sélectionne automatiquement un appareil spécifique en fonction des exigences internes, soit elle permet à l’utilisateur de sélectionner explicitement un appareil dans une liste d’appareils disponibles.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-111">In the latter case, either the application automatically selects a specific device based on internal requirements or it allows the user to explicitly select a device from a list of available devices.</span></span>

<span data-ttu-id="cdb9d-112">Une application qui utilise l’appareil par défaut peut tenter de récupérer à partir d’une \_ erreur d’invalidation de l’appareil AUDCLNT E \_ \_ , comme suit :</span><span class="sxs-lookup"><span data-stu-id="cdb9d-112">An application that uses the default device can attempt to recover from an AUDCLNT\_E\_DEVICE\_INVALIDATED error as follows:</span></span>

1.  <span data-ttu-id="cdb9d-113">Libérez l’interface [**IAudioClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) et toutes les autres interfaces WASAPI acquises sur l’appareil.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-113">Release the [**IAudioClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) interface and any other WASAPI interfaces that it has acquired on the device.</span></span>
2.  <span data-ttu-id="cdb9d-114">Appelez la méthode [**IMMDeviceEnumerator :: GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) pour récupérer le périphérique audio par défaut actuel.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-114">Call the [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) method to get the current default audio device.</span></span>
3.  <span data-ttu-id="cdb9d-115">Essayez d’activer [**IAudioClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) sur le périphérique audio par défaut.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-115">Attempt to activate [**IAudioClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) on the default audio device.</span></span>

<span data-ttu-id="cdb9d-116">En suivant les étapes précédentes, l’application a tendance à répondre de manière appropriée, quelle que soit la cause de l' \_ \_ erreur d’invalidation de l’appareil AUDCLNT E \_ .</span><span class="sxs-lookup"><span data-stu-id="cdb9d-116">By following the preceding steps, the application tends to respond appropriately regardless of the cause of the AUDCLNT\_E\_DEVICE\_INVALIDATED error.</span></span> <span data-ttu-id="cdb9d-117">Si la reconfiguration de l’appareil par défaut a provoqué l’erreur (par exemple, si l’utilisateur a modifié le format de flux utilisé par l’appareil), ces étapes, si elles ont échoué, permettent à l’application de continuer à utiliser le même appareil.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-117">If reconfiguration of the default device caused the error (for example, if the user changed the stream format used by the device), then these steps, if they succeed, enable the application to continue to use the same device.</span></span> <span data-ttu-id="cdb9d-118">Si l’utilisateur a désactivé ou supprimé l’appareil que l’application utilisait et qu’un autre périphérique est disponible pour assumer le rôle de périphérique par défaut, l’application peut continuer à utiliser le nouvel appareil par défaut.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-118">If the user disabled or removed the device that the application was using and another device is available to assume the role of default device, then the application can continue by using the new default device.</span></span> <span data-ttu-id="cdb9d-119">Dans les deux cas, l’application s’adapte automatiquement sans nécessiter l’intervention de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-119">In either case, the application adapts automatically without requiring intervention by the user.</span></span>

<span data-ttu-id="cdb9d-120">Une application qui sélectionne un appareil spécifique peut tenter de récupérer à partir de l' \_ erreur d’invalidation de l’appareil AUDCLNT E \_ \_ comme suit :</span><span class="sxs-lookup"><span data-stu-id="cdb9d-120">An application that selects a specific device can attempt to recover from the AUDCLNT\_E\_DEVICE\_INVALIDATED error as follows:</span></span>

1.  <span data-ttu-id="cdb9d-121">Libérez l’interface [**IAudioClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) et toutes les autres interfaces WASAPI acquises sur l’appareil.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-121">Release the [**IAudioClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) interface and any other WASAPI interfaces that it has acquired on the device.</span></span>
2.  <span data-ttu-id="cdb9d-122">Tentative d’activation d’une interface [**IAudioClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) sur le même appareil.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-122">Attempt to activate an [**IAudioClient**](/windows/desktop/api/Audioclient/nn-audioclient-iaudioclient) interface on the same device.</span></span>
3.  <span data-ttu-id="cdb9d-123">Si l’étape 2 échoue, l’application peut, en option, inviter l’utilisateur à sélectionner un autre appareil.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-123">If step 2 fails, then the application can, as an option, prompt the user to select another device.</span></span>

<span data-ttu-id="cdb9d-124">L’étape 2 peut être effectuée si l’appareil utilisé par l’application a été reconfiguré mais qu’il n’a pas été désactivé ou supprimé.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-124">Step 2 can succeed if the device being used by the application was reconfigured but not disabled or removed.</span></span> <span data-ttu-id="cdb9d-125">En cas de réussite, l’étape 2 permet à l’application de continuer à utiliser automatiquement le même appareil sans nécessiter l’intervention de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-125">If successful, step 2 enables the application to automatically continue to use the same device without requiring intervention by the user.</span></span> <span data-ttu-id="cdb9d-126">L’étape 3 est appropriée si l’application permet à l’utilisateur de sélectionner explicitement un autre périphérique une fois que l’utilisateur a désactivé ou supprimé l’appareil précédemment utilisé.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-126">Step 3 is appropriate if the application allows the user to explicitly select another device after the user has disabled or removed the previously used device.</span></span>

<span data-ttu-id="cdb9d-127">Une application peut déterminer plus précisément la cause d’une erreur d’appareil non valide en s’inscrivant pour recevoir une notification lorsqu’une session perd sa connexion à un appareil.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-127">An application can determine more precisely the cause of an invalid-device error by registering to receive a notification when a session loses its connection to a device.</span></span> <span data-ttu-id="cdb9d-128">Pour activer cette notification, l’application implémente une interface [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) et appelle la méthode [**IAudioSessionControl :: RegisterAudioSessionNotification**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessioncontrol-registeraudiosessionnotification) pour inscrire l’interface.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-128">To enable this notification, the application implements an [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) interface and calls the [**IAudioSessionControl::RegisterAudioSessionNotification**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessioncontrol-registeraudiosessionnotification) method to register the interface.</span></span> <span data-ttu-id="cdb9d-129">Quand une erreur d’appareil non valide provoque la déconnexion de la session, WASAPI appelle la méthode [**IAudioSessionEvents :: OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) dans l’interface inscrite.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-129">When an invalid-device error causes the session to be disconnected, WASAPI calls the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) method in the registered interface.</span></span> <span data-ttu-id="cdb9d-130">À l’aide de cette méthode, WASAPI informe l’application de la raison de la déconnexion.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-130">Through this method, WASAPI informs the application of the reason for the disconnection.</span></span> <span data-ttu-id="cdb9d-131">Dans Windows Vista, l’appel **OnSessionDisconnected** identifie les raisons suivantes :</span><span class="sxs-lookup"><span data-stu-id="cdb9d-131">In Windows Vista, the **OnSessionDisconnected** call identifies the following reasons:</span></span>

-   <span data-ttu-id="cdb9d-132">L’utilisateur a supprimé l’appareil de point de terminaison audio.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-132">The user removed the audio endpoint device.</span></span>
-   <span data-ttu-id="cdb9d-133">Le service audio Windows s’est arrêté.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-133">The Windows audio service has shut down.</span></span>
-   <span data-ttu-id="cdb9d-134">Le format de flux préféré a changé pour l’appareil auquel la session audio est connectée.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-134">The preferred stream format changed for the device that the audio session is connected to.</span></span>
-   <span data-ttu-id="cdb9d-135">L’utilisateur a fermé la session Windows Terminal Services (WTS) dans laquelle la session audio s’exécutait.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-135">The user logged off the Windows Terminal Services (WTS) session that the audio session was running in.</span></span> <span data-ttu-id="cdb9d-136">Pour plus d’informations sur les sessions WTS, consultez la documentation SDK Windows.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-136">For more information about WTS sessions, see the Windows SDK documentation.</span></span>
-   <span data-ttu-id="cdb9d-137">La session WTS dans laquelle la session audio s’exécutait a été déconnectée.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-137">The WTS session that the audio session was running in was disconnected.</span></span>
-   <span data-ttu-id="cdb9d-138">La session audio (en mode partagé) a été déconnectée pour rendre l’appareil de point de terminaison audio disponible pour une connexion en mode exclusif.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-138">The (shared-mode) audio session was disconnected to make the audio endpoint device available for an exclusive-mode connection.</span></span>

<span data-ttu-id="cdb9d-139">En réponse à l’événement de déconnexion, WASAPI ferme tous les flux qui appartiennent à la session.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-139">In response to the disconnection event, WASAPI closes all of the streams that belong to the session.</span></span> <span data-ttu-id="cdb9d-140">Si une application tente par la suite d’accéder à un flux fermé par le biais d’une méthode WASAPI comme [**IAudioClient :: GetCurrentPadding**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-getcurrentpadding), la méthode échoue et retourne le code d’erreur AUDCLNT E l’appareil n’est pas \_ \_ \_ valide.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-140">If an application subsequently attempts to access a closed stream through a WASAPI method such as [**IAudioClient::GetCurrentPadding**](/windows/desktop/api/Audioclient/nf-audioclient-iaudioclient-getcurrentpadding), then the method fails and returns error code AUDCLNT\_E\_DEVICE\_INVALIDATED.</span></span>

<span data-ttu-id="cdb9d-141">La réception de notifications par l’intermédiaire de l’interface [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) présente un avantage supplémentaire : les notifications arrivent de manière asynchrone.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-141">An additional benefit to receiving notifications through the [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) interface is that the notifications arrive asynchronously.</span></span> <span data-ttu-id="cdb9d-142">Ainsi, même lorsque le flux de communication n’est pas en cours d’exécution, l’application recevra quand même des notifications en temps utile des erreurs de périphérique non valides qui peuvent empêcher l’exécution du flux.</span><span class="sxs-lookup"><span data-stu-id="cdb9d-142">Thus, even when the stream is not running, the application will still receive timely notification of invalid-device errors that can prevent the stream from running.</span></span>

## <a name="related-topics"></a><span data-ttu-id="cdb9d-143">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="cdb9d-143">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="cdb9d-144">Gestion de flux</span><span class="sxs-lookup"><span data-stu-id="cdb9d-144">Stream Management</span></span>](stream-management.md)
</dt> </dl>

 

 



