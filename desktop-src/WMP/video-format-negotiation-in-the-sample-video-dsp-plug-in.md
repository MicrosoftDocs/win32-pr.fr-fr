---
title: Négociation du format vidéo dans l’exemple de plug-in de la vidéo DSP
description: Négociation du format vidéo dans l’exemple de plug-in de la vidéo DSP
ms.assetid: 3e92ce10-2b9b-4689-a181-f56c33472fea
keywords:
- Plug-ins du lecteur Windows Media, DSP vidéo
- plug-ins, DSP vidéo
- plug-ins de traitement de signal numérique, négociation de format vidéo
- Plug-ins DSP, négociation de format vidéo
- plug-ins vidéo DSP, négociation de format
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: c287a38fbfcf11f1b9d74087a91c5825b22f1243
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/16/2019
ms.locfileid: "104310165"
---
# <a name="video-format-negotiation-in-the-sample-video-dsp-plug-in"></a><span data-ttu-id="061de-108">Négociation du format vidéo dans l’exemple de plug-in de la vidéo DSP</span><span class="sxs-lookup"><span data-stu-id="061de-108">Video Format Negotiation in the Sample Video DSP Plug-in</span></span>

<span data-ttu-id="061de-109">Avant que le lecteur Windows Media insère un plug-in de DSP vidéo dans la chaîne de signal, le joueur doit déterminer si le plug-in peut traiter la vidéo en cours de lecture.</span><span class="sxs-lookup"><span data-stu-id="061de-109">Before Windows Media Player inserts a video DSP plug-in into the signal chain, the Player must determine whether the plug-in can process the video being played.</span></span> <span data-ttu-id="061de-110">Le processus par lequel le plug-in et le lecteur communiquent à propos des formats vidéo pris en charge est appelé négociation de format.</span><span class="sxs-lookup"><span data-stu-id="061de-110">The process by which the plug-in and the Player communicate about supported video formats is called format negotiation.</span></span>

## <a name="providing-the-supported-input-and-output-types"></a><span data-ttu-id="061de-111">Fournir les types d’entrée et de sortie pris en charge</span><span class="sxs-lookup"><span data-stu-id="061de-111">Providing the Supported Input and Output Types</span></span>

<span data-ttu-id="061de-112">Si le plug-in DSP agit comme un objet multimédia DirectX (DMO), le lecteur interroge le plug-in sur ses formats pris en charge en effectuant une séquence d’appels à **IMediaObject :: GetInputType** et **IMediaObject :: GetOutputType**.</span><span class="sxs-lookup"><span data-stu-id="061de-112">If the DSP plug-in is acting as a DirectX Media Object (DMO), the Player queries the plug-in about its supported formats by making a sequence of calls to **IMediaObject::GetInputType** and **IMediaObject::GetOutputType**.</span></span>

<span data-ttu-id="061de-113">Si le plug-in DSP agit en tant que Media Foundation Transform (MFT), le lecteur interroge le plug-in sur ses formats pris en charge en effectuant une séquence d’appels à **IMFTransform :: GetInputAvailableType** et **IMFTransform :: GetOutputAvailableType**.</span><span class="sxs-lookup"><span data-stu-id="061de-113">If the DSP plug-in is acting as a Media Foundation Transform (MFT), the Player queries the plug-in about its supported formats by making a sequence of calls to **IMFTransform::GetInputAvailableType** and **IMFTransform::GetOutputAvailableType**.</span></span>

<span data-ttu-id="061de-114">L’exemple de plug-in vidéo généré par l’Assistant de plug-in du lecteur Windows Media stocke la liste des formats vidéo pris en charge sous la forme d’un tableau de GUID.</span><span class="sxs-lookup"><span data-stu-id="061de-114">The sample video plug-in generated by the Windows Media Player Plug-in Wizard stores the list of supported video formats as an array of GUIDs.</span></span> <span data-ttu-id="061de-115">Le code suivant provient du fichier main. cpp :</span><span class="sxs-lookup"><span data-stu-id="061de-115">The following code is from the main .cpp file:</span></span>


```C++
static const GUID*    k_guidValidSubtypes[] = {
    &MEDIASUBTYPE_NV12,
    &MEDIASUBTYPE_YV12,
    &MEDIASUBTYPE_YUY2,
    &MEDIASUBTYPE_UYVY,
    &MEDIASUBTYPE_RGB32,
    &MEDIASUBTYPE_RGB24,
    &MEDIASUBTYPE RGB555,
    &MEDIASUBTYPE RGB565
};

```



<span data-ttu-id="061de-116">Le lecteur peut appeler **IMediaObject :: GetInputType** et **IMediaObject :: GetOutputType** dans n’importe quel ordre, de sorte que le code de plug-in doit anticiper cela.</span><span class="sxs-lookup"><span data-stu-id="061de-116">The Player can call **IMediaObject::GetInputType** and **IMediaObject::GetOutputType** in any order, so the plug-in code must anticipate this.</span></span> <span data-ttu-id="061de-117">De même, le lecteur peut appeler **IMFTransform :: GetInputAvailableType** et **IMFTransform :: GetOutputAvailableType** dans n’importe quel ordre.</span><span class="sxs-lookup"><span data-stu-id="061de-117">Similary, the Player can call **IMFTransform::GetInputAvailableType** and **IMFTransform::GetOutputAvailableType** in any order.</span></span> <span data-ttu-id="061de-118">Les exemples d’implémentation de **GetOutputType** et **GetOutputAvailableType** testent si le type d’entrée a déjà été défini.</span><span class="sxs-lookup"><span data-stu-id="061de-118">The sample implementations of **GetOutputType** and **GetOutputAvailableType** test whether the input type has already been defined.</span></span> <span data-ttu-id="061de-119">Si c’est le cas, le plug-in répond qu’il ne prend en charge que ce type.</span><span class="sxs-lookup"><span data-stu-id="061de-119">If it has, the plug-in responds that it supports only that type.</span></span> <span data-ttu-id="061de-120">Dans le cas contraire, le plug-in retourne le type qui correspond à l’index fourni, comme le montre le code suivant :</span><span class="sxs-lookup"><span data-stu-id="061de-120">Otherwise, the plug-in returns the type that corresponds to the supplied index, as the following code demonstrates:</span></span>


```C++
// If input type has been defined, then use that as output type.
if (GUID_NULL != m_mtInput.majortype)
{
    hr = ::MoCopyMediaType( pmt, &m_mtInput );
}
else // Otherwise use default for this plug-in.
{
    ::ZeroMemory( pmt, sizeof( DMO_MEDIA_TYPE ) );
    pmt->majortype = MEDIATYPE_Video;
    pmt->subtype = *k_guidValidSubtypes[dwTypeIndex];     
}

```



## <a name="setting-the-input-and-output-types"></a><span data-ttu-id="061de-121">Définition des types d’entrée et de sortie</span><span class="sxs-lookup"><span data-stu-id="061de-121">Setting the Input and Output Types</span></span>

<span data-ttu-id="061de-122">Si le plug-in DSP agit comme DMO, le lecteur Windows Media définit le type de média en appelant **IMediaObject :: SetInputType** et **IMediaObject :: SetOutputType**, en transmettant à chaque fonction un pointeur vers une structure de **\_ \_ type de média DMO** qui représente le type de média demandé.</span><span class="sxs-lookup"><span data-stu-id="061de-122">If the DSP plug-in is acting as a DMO, Windows Media Player sets the media type by calling **IMediaObject::SetInputType** and **IMediaObject::SetOutputType**, passing to each function a pointer to a **DMO\_MEDIA\_TYPE** structure that represents the requested media type.</span></span>

<span data-ttu-id="061de-123">Si le plug-in DSP agit en tant que MFT, le lecteur Windows Media définit le type de média en appelant **IMFTransform :: SetInputType** et **IMFTransform :: SetOutputType**, en passant à chaque fonction un pointeur vers une interface **IMFMediaType** qui représente le type de média demandé.</span><span class="sxs-lookup"><span data-stu-id="061de-123">If the DSP plug-in is acting as an MFT, Windows Media Player sets the media type by calling **IMFTransform::SetInputType** and **IMFTransform::SetOutputType**, passing to each function a pointer to an **IMFMediaType** interface that represents the requested media type.</span></span>

<span data-ttu-id="061de-124">Il n’y a aucune garantie que le lecteur appellera les méthodes de négociation de format dans un ordre particulier, de sorte que le code de plug-in doit gérer tous les cas.</span><span class="sxs-lookup"><span data-stu-id="061de-124">There is no guarantee that the Player will call format negotiation methods in any particular order, so plug-in code must handle any case.</span></span> <span data-ttu-id="061de-125">Par exemple, si le lecteur appelle **SetOutputType** avant d’appeler **SetInputType**, il s’agit d’un cours d’action valide pour que le plug-in rejette le type de média de sortie proposé.</span><span class="sxs-lookup"><span data-stu-id="061de-125">For instance, if the Player calls **SetOutputType** before calling **SetInputType**, it is a valid course of action for the plug-in to reject the proposed output media type.</span></span> <span data-ttu-id="061de-126">Le code suivant de l’exemple d’implémentation de **IMediaObject :: SetOutputType** illustre ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="061de-126">The following code from the sample implementation of **IMediaObject::SetOutputType** demonstrates this:</span></span>


```C++
if( GUID_NULL != m_mtInput.majortype )
{
    // Validate that the output media type matches our requirements 
    // and matches our input type (if set).
    hr = ValidateMediaType(pmt, &m_mtInput);
}
else
{
    hr = DMO_E_TYPE_NOT_ACCEPTED;
}

```



<span data-ttu-id="061de-127">Les exemples d’implémentations de plug-in de **SetInputType** et **SetOutputType** appellent la fonction personnalisée nommée **ValidateMediaType**.</span><span class="sxs-lookup"><span data-stu-id="061de-127">The sample plug-in implementations of **SetInputType** and **SetOutputType** call the custom function named **ValidateMediaType**.</span></span> <span data-ttu-id="061de-128">Cette fonction de plug-in effectue une série de tests sur le type de média proposé, conçu pour garantir que le type de média est correctement construit et pris en charge par le plug-in.</span><span class="sxs-lookup"><span data-stu-id="061de-128">This plug-in function performs a series of tests on the proposed media type designed to ensure that the media type is well-formed and supported by the plug-in.</span></span> <span data-ttu-id="061de-129">**ValidateMediaType** effectue les tests suivants :</span><span class="sxs-lookup"><span data-stu-id="061de-129">**ValidateMediaType** performs the following tests:</span></span>

-   <span data-ttu-id="061de-130">Vérifie que les membres **MajorType** et **formatType** contiennent les valeurs correctes.</span><span class="sxs-lookup"><span data-stu-id="061de-130">Verifies that the **majortype** and **formattype** members contain the correct values.</span></span>
-   <span data-ttu-id="061de-131">Vérifie que le membre de **sous-type** correspond à l’un des formats pris en charge.</span><span class="sxs-lookup"><span data-stu-id="061de-131">Verifies that the **subtype** member matches one of the supported formats.</span></span>
-   <span data-ttu-id="061de-132">Vérifie que les informations contenues dans les structures **BITMAPINFOHEADER** et **VIDEOINFOHEADER** ou **VIDEOINFOHEADER2** contiennent des valeurs valides.</span><span class="sxs-lookup"><span data-stu-id="061de-132">Verifies that the information in the **BITMAPINFOHEADER** and **VIDEOINFOHEADER** or **VIDEOINFOHEADER2** structures contain valid values.</span></span>
-   <span data-ttu-id="061de-133">Teste si les types de média d’entrée et de sortie correspondent parce que le plug-in ne convertit pas les formats de l’entrée en sortie.</span><span class="sxs-lookup"><span data-stu-id="061de-133">Tests whether the input and output media types match because the plug-in does not convert formats from input to output.</span></span>

<span data-ttu-id="061de-134">Si le type de média proposé passe les tests de validation, il est stocké dans une variable membre : **m \_ mtInput** pour le type de média d’entrée, **m \_ mtOutput** pour le type de média de sortie.</span><span class="sxs-lookup"><span data-stu-id="061de-134">If the proposed media type passes the validation tests, it is stored in a member variable: **m\_mtInput** for the input media type, **m\_mtOutput** for the output media type.</span></span>

## <a name="related-topics"></a><span data-ttu-id="061de-135">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="061de-135">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="061de-136">**Implémentation d’un plug-in de DSP vidéo**</span><span class="sxs-lookup"><span data-stu-id="061de-136">**Implementing a Video DSP Plug-in**</span></span>](implementing-a-video-dsp-plug-in.md)
</dt> </dl>

 

 




