---
description: Un service est chargé de signaler les modifications de son état au gestionnaire de contrôle des services (SCM).
ms.assetid: 74a85730-6667-46fe-ae12-26561ccedb73
title: Transitions d’état de service
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8df7684b1ebc04aa1116b09a3ae4321f2552d7b6
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "104564247"
---
# <a name="service-state-transitions"></a><span data-ttu-id="5d704-103">Transitions d’état de service</span><span class="sxs-lookup"><span data-stu-id="5d704-103">Service State Transitions</span></span>

<span data-ttu-id="5d704-104">Un service est chargé de signaler les modifications de son état au gestionnaire de contrôle des services (SCM).</span><span class="sxs-lookup"><span data-stu-id="5d704-104">A service is responsible for reporting changes in its state to the service control manager (SCM).</span></span> <span data-ttu-id="5d704-105">Les programmes de contrôle de service et le système peuvent déterminer l’état d’un service uniquement à partir du SCM. il est donc important qu’un service signale son état correctement.</span><span class="sxs-lookup"><span data-stu-id="5d704-105">Service control programs and the system can find out the state of a service only from the SCM, so it is important that a service report its state correctly.</span></span> <span data-ttu-id="5d704-106">Un service signale son état en appelant la fonction [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) avec un pointeur vers une structure d' [**\_ État de service**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) entièrement initialisée.</span><span class="sxs-lookup"><span data-stu-id="5d704-106">A service reports its state by calling the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function with a pointer to a fully initialized [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="5d704-107">Le membre **dwCurrentState** de la structure contient l’état du service à signaler.</span><span class="sxs-lookup"><span data-stu-id="5d704-107">The **dwCurrentState** member of the structure contains the service state to be reported.</span></span>

<span data-ttu-id="5d704-108">L’état initial d’un service est \_ arrêté.</span><span class="sxs-lookup"><span data-stu-id="5d704-108">The initial state of a service is SERVICE\_STOPPED.</span></span> <span data-ttu-id="5d704-109">Lorsque le SCM démarre le service, il définit l’état du service sur \_ attente du démarrage du service \_ et appelle la fonction [*ServiceMain*](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) du service.</span><span class="sxs-lookup"><span data-stu-id="5d704-109">When the SCM starts the service, it sets the service state to SERVICE\_START\_PENDING and calls the service's [*ServiceMain*](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function.</span></span> <span data-ttu-id="5d704-110">Le service termine ensuite son initialisation à l’aide de l’une des techniques décrites dans la [fonction service ServiceMain](service-servicemain-function.md).</span><span class="sxs-lookup"><span data-stu-id="5d704-110">The service then completes its initialization using one of the techniques described in [Service ServiceMain Function](service-servicemain-function.md).</span></span> <span data-ttu-id="5d704-111">Une fois que le service a terminé son initialisation et est prêt à commencer à recevoir des demandes de contrôle, le service appelle [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) pour signaler le service d' \_ exécution et spécifie les demandes de contrôle que le service est prêt à accepter.</span><span class="sxs-lookup"><span data-stu-id="5d704-111">After the service completes its initialization and is ready to start receiving control requests, the service calls [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to report SERVICE\_RUNNING and specify the control requests the service is prepared to accept.</span></span> <span data-ttu-id="5d704-112">La transition du démarrage du SERVICE \_ \_ en attente au service \_ en cours d’exécution indique aux outils SCM et de surveillance des services que le service a démarré avec succès.</span><span class="sxs-lookup"><span data-stu-id="5d704-112">The transition from SERVICE\_START\_PENDING to SERVICE\_RUNNING indicates to the SCM and service-monitoring tools that the service has started successfully.</span></span> <span data-ttu-id="5d704-113">Si le service signale un État autre que SERVICE \_ en cours d’exécution, les outils SCM ou d’analyse de service peuvent signaler que le service n’a pas pu démarrer.</span><span class="sxs-lookup"><span data-stu-id="5d704-113">If the service reports a state other than SERVICE\_RUNNING, the SCM or service-monitoring tools might mark the service as having failed to start.</span></span>

<span data-ttu-id="5d704-114">Le SCM envoie uniquement les demandes de contrôle spécifiées au service (à l’exception de la \_ demande d’interrogation de contrôle de service \_ , qui est toujours envoyée).</span><span class="sxs-lookup"><span data-stu-id="5d704-114">The SCM sends only the specified control requests to the service (except for the SERVICE\_CONTROL\_INTERROGATE request, which is always sent).</span></span> <span data-ttu-id="5d704-115">Pour obtenir la liste des demandes de contrôle qu’un service peut accepter, consultez le membre **dwControlsAccepted** de la structure d' [**\_ État du service**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="5d704-115">For a list of the control requests that a service can accept, see the **dwControlsAccepted** member of the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="5d704-116">Pour plus d’informations sur l’inscription pour recevoir des événements d’appareil, consultez la fonction [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) .</span><span class="sxs-lookup"><span data-stu-id="5d704-116">For information about registering to receive device events, see the [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) function.</span></span>

<span data-ttu-id="5d704-117">L’état du service change généralement suite à la gestion d’une demande de contrôle.</span><span class="sxs-lookup"><span data-stu-id="5d704-117">The service state typically changes as a result of handling a control request.</span></span> <span data-ttu-id="5d704-118">Les demandes de contrôle qui provoquent le changement de l’état du service incluent l’arrêt du contrôle de SERVICE \_ , la suspension du contrôle du \_ service et la poursuite du contrôle du \_ \_ service \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="5d704-118">Control requests that cause the service state to change include SERVICE\_CONTROL\_STOP, SERVICE\_CONTROL\_PAUSE, and SERVICE\_CONTROL\_CONTINUE.</span></span> <span data-ttu-id="5d704-119">Si le service doit effectuer un traitement de longue durée pour gérer l’une de ces demandes, il doit créer un thread secondaire pour effectuer le traitement long et signaler l’état d’attente correspondant au SCM.</span><span class="sxs-lookup"><span data-stu-id="5d704-119">If the service must do lengthy processing to handle any of these requests, it should create a secondary thread to perform the lengthy processing and report the corresponding pending state to the SCM.</span></span> <span data-ttu-id="5d704-120">(Pour des performances optimales sur Windows Vista et les versions ultérieures de Windows, le service doit utiliser un thread de travail à partir d’un [pool de threads](/windows/desktop/ProcThread/thread-pools) à cet effet.) Le service doit ensuite signaler la transition de l’état terminé lorsque le traitement long est terminé.</span><span class="sxs-lookup"><span data-stu-id="5d704-120">(For best performance on Windows Vista and later versions of Windows, the service should use a worker thread from a [thread pool](/windows/desktop/ProcThread/thread-pools) for this purpose.) The service should then report the completed state transition when the lengthy processing is finished.</span></span> <span data-ttu-id="5d704-121">Pour plus d’informations sur la gestion des demandes de contrôle, consultez [fonction du gestionnaire de contrôle des services](service-control-handler-function.md).</span><span class="sxs-lookup"><span data-stu-id="5d704-121">For more information about handling control requests, see [Service Control Handler Function](service-control-handler-function.md).</span></span>

<span data-ttu-id="5d704-122">Seules certaines transitions d’état de service sont valides.</span><span class="sxs-lookup"><span data-stu-id="5d704-122">Only certain service state transitions are valid.</span></span> <span data-ttu-id="5d704-123">Le diagramme suivant montre les transitions valides.</span><span class="sxs-lookup"><span data-stu-id="5d704-123">The following diagram shows the valid transitions.</span></span>

![transitions d’état de service valides](images/service-status-transitions.png)

<span data-ttu-id="5d704-125">L’état du service signalé au SCM détermine la façon dont le SCM interagit avec le service.</span><span class="sxs-lookup"><span data-stu-id="5d704-125">The service state reported to the SCM determines how the SCM interacts with the service.</span></span> <span data-ttu-id="5d704-126">Par exemple, si un SERVICE des rapports de service s' \_ arrête \_ en attente, le SCM ne transmet pas d’autres demandes de contrôle au service, car cet État indique que le service est en cours d’arrêt.</span><span class="sxs-lookup"><span data-stu-id="5d704-126">For example, if a service reports SERVICE\_STOP\_PENDING, the SCM does not transmit further control requests to the service because this state indicates that the service is shutting down.</span></span> <span data-ttu-id="5d704-127">L’état suivant signalé par le service doit être \_ arrêté, car il s’agit du seul État valide après l’arrêt du service \_ \_ en attente.</span><span class="sxs-lookup"><span data-stu-id="5d704-127">The next state reported by the service should be SERVICE\_STOPPED because that is the only valid state after SERVICE\_STOP\_PENDING.</span></span> <span data-ttu-id="5d704-128">Toutefois, si un service signale une transition qui n’est pas valide, le SCM n’échoue pas à l’appel.</span><span class="sxs-lookup"><span data-stu-id="5d704-128">However, if a service reports a transition that is not valid, the SCM does not fail the call.</span></span>

<span data-ttu-id="5d704-129">Le diagramme suivant montre les transitions d’état de service plus en détail, y compris les demandes de contrôle initiées par un programme de contrôle de service (le client de service) et les appels [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) qu’un service effectue pour signaler les modifications d’État au SCM.</span><span class="sxs-lookup"><span data-stu-id="5d704-129">The following diagram shows service state transitions in more detail, including the control requests initiated by a service control program (the service client) and the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) calls that a service makes to report state changes to the SCM.</span></span> <span data-ttu-id="5d704-130">Comme mentionné précédemment, le SCM envoie uniquement les demandes de contrôle que le service a spécifié qu’il acceptera, donc un service risque de ne pas recevoir toutes les demandes présentées dans le diagramme.</span><span class="sxs-lookup"><span data-stu-id="5d704-130">As mentioned earlier, the SCM sends only control requests that the service has specified it will accept, so a service might not receive all of the requests shown in the diagram.</span></span>

![<span data-ttu-id="5d704-131">transitions d’état de service en détail</span><span class="sxs-lookup"><span data-stu-id="5d704-131">service status transitions in detail</span></span> ](images/service-status-flow-diagram.png)

## <a name="related-topics"></a><span data-ttu-id="5d704-132">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="5d704-132">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="5d704-133">**ControlService**</span><span class="sxs-lookup"><span data-stu-id="5d704-133">**ControlService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-controlservice)
</dt> <dt>

[<span data-ttu-id="5d704-134">**ControlServiceEx**</span><span class="sxs-lookup"><span data-stu-id="5d704-134">**ControlServiceEx**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-controlserviceexa)
</dt> <dt>

[<span data-ttu-id="5d704-135">**SetServiceStatus**</span><span class="sxs-lookup"><span data-stu-id="5d704-135">**SetServiceStatus**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus)
</dt> </dl>

 

 
