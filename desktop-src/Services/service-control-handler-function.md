---
description: Chaque service a un gestionnaire de contrôle, la fonction de gestionnaire, qui est appelé par le répartiteur de contrôle lorsque le processus de service reçoit une demande de contrôle d’un programme de contrôle de service.
ms.assetid: 437334ed-05fa-4ab6-aab3-dc2739113e19
title: Fonction du gestionnaire de contrôle des services
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1303bff45421ee7206d02be9ee30066324648823
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "106514168"
---
# <a name="service-control-handler-function"></a><span data-ttu-id="8b7a1-103">Fonction du gestionnaire de contrôle des services</span><span class="sxs-lookup"><span data-stu-id="8b7a1-103">Service Control Handler Function</span></span>

<span data-ttu-id="8b7a1-104">Chaque service a un gestionnaire de contrôle, la fonction de [**Gestionnaire**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) , qui est appelé par le répartiteur de contrôle lorsque le processus de service reçoit une demande de contrôle d’un programme de contrôle de service.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-104">Each service has a control handler, the [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function, that is invoked by the control dispatcher when the service process receives a control request from a service control program.</span></span> <span data-ttu-id="8b7a1-105">Par conséquent, cette fonction s’exécute dans le contexte du répartiteur de contrôle.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-105">Therefore, this function executes in the context of the control dispatcher.</span></span> <span data-ttu-id="8b7a1-106">Pour obtenir un exemple, consultez [écriture d’une fonction de gestionnaire de contrôle](writing-a-control-handler-function.md).</span><span class="sxs-lookup"><span data-stu-id="8b7a1-106">For an example, see [Writing a Control Handler Function](writing-a-control-handler-function.md).</span></span>

<span data-ttu-id="8b7a1-107">Un service appelle la fonction [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) ou [**RegisterServiceCtrlHandlerEx**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) pour enregistrer sa fonction de gestionnaire de contrôle des services.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-107">A service calls the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) or [**RegisterServiceCtrlHandlerEx**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) function to register its service control handler function.</span></span>

<span data-ttu-id="8b7a1-108">Quand le gestionnaire de contrôle des services est appelé, le service doit appeler la fonction [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) pour signaler son état au SCM uniquement si la gestion du code de contrôle entraîne la modification de l’état du service.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-108">When the service control handler is invoked, the service must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report its status to the SCM only if handling the control code causes the service status to change.</span></span> <span data-ttu-id="8b7a1-109">Si la gestion du code de contrôle n’entraîne pas la modification de l’état du service, il n’est pas nécessaire d’appeler **SetServiceStatus**.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-109">If handling the control code does not cause the service status to change, it is not necessary to call **SetServiceStatus**.</span></span>

<span data-ttu-id="8b7a1-110">Un programme de contrôle de service peut envoyer des demandes de contrôle à l’aide de la fonction [**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) .</span><span class="sxs-lookup"><span data-stu-id="8b7a1-110">A service control program can send control requests using the [**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) function.</span></span> <span data-ttu-id="8b7a1-111">Tous les services doivent accepter et traiter le code de contrôle d' **\_ \_ interrogation du contrôle des services** .</span><span class="sxs-lookup"><span data-stu-id="8b7a1-111">All services must accept and process the **SERVICE\_CONTROL\_INTERROGATE** control code.</span></span> <span data-ttu-id="8b7a1-112">Vous pouvez activer ou désactiver l’acceptation des autres codes de contrôle en appelant [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span><span class="sxs-lookup"><span data-stu-id="8b7a1-112">You can enable or disable acceptance of the other control codes by calling [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span></span> <span data-ttu-id="8b7a1-113">Pour recevoir le code de contrôle **\_ \_ DEVICEEVENT du contrôle de service** , vous devez appeler la fonction [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) .</span><span class="sxs-lookup"><span data-stu-id="8b7a1-113">To receive the **SERVICE\_CONTROL\_DEVICEEVENT** control code, you must call the [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) function.</span></span> <span data-ttu-id="8b7a1-114">Les services peuvent également gérer des codes de contrôle supplémentaires définis par l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-114">Services can also handle additional user-defined control codes.</span></span>

<span data-ttu-id="8b7a1-115">Si un service accepte le code de contrôle d' **\_ \_ arrêt du contrôle de service** , il doit s’arrêter lors de la réception, en accédant à l’état d’arrêt du **service \_ \_ en attente** ou d' **\_ arrêt du service** .</span><span class="sxs-lookup"><span data-stu-id="8b7a1-115">If a service accepts the **SERVICE\_CONTROL\_STOP** control code, it must stop upon receipt, going to either the **SERVICE\_STOP\_PENDING** or **SERVICE\_STOPPED** state.</span></span> <span data-ttu-id="8b7a1-116">Une fois que le SCM a envoyé ce code de contrôle, il n’envoie pas d’autres codes de contrôle.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-116">After the SCM sends this control code, it will not send other control codes.</span></span>

<span data-ttu-id="8b7a1-117">**Windows XP :** Si le service **ne retourne aucune \_ erreur** et continue à s’exécuter, il continue à recevoir les codes de contrôle.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-117">**Windows XP:** If the service returns **NO\_ERROR** and continues to run, it continues to receive control codes.</span></span> <span data-ttu-id="8b7a1-118">Ce comportement a été modifié à partir de Windows Server 2003 et Windows XP avec Service Pack 2 (SP2).</span><span class="sxs-lookup"><span data-stu-id="8b7a1-118">This behavior changed starting with Windows Server 2003 and Windows XP with Service Pack 2 (SP2).</span></span>

<span data-ttu-id="8b7a1-119">Le gestionnaire de contrôle doit retourner dans un délai de 30 secondes, sinon le SCM renvoie une erreur.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-119">The control handler must return within 30 seconds, or the SCM returns an error.</span></span> <span data-ttu-id="8b7a1-120">Si un service doit effectuer un traitement long lorsque le service exécute le gestionnaire de contrôle, il doit créer un thread secondaire pour effectuer le traitement long, puis retourner à partir du gestionnaire de contrôle.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-120">If a service must do lengthy processing when the service is executing the control handler, it should create a secondary thread to perform the lengthy processing, and then return from the control handler.</span></span> <span data-ttu-id="8b7a1-121">Cela empêche le service de relier le répartiteur de contrôle.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-121">This prevents the service from tying up the control dispatcher.</span></span> <span data-ttu-id="8b7a1-122">Par exemple, lors de la gestion de la demande d’arrêt pour un service qui prend beaucoup de temps, créez un autre thread pour gérer le processus d’arrêt.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-122">For example, when handling the stop request for a service that takes a long time, create another thread to handle the stop process.</span></span> <span data-ttu-id="8b7a1-123">Le gestionnaire de contrôle doit simplement appeler [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) avec le service qui arrête le message **\_ \_ en attente** et retourne.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-123">The control handler should simply call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_STOP\_PENDING** message and return.</span></span>

<span data-ttu-id="8b7a1-124">Lorsque l’utilisateur ferme le système, tous les gestionnaires de contrôle qui ont appelé [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) avec le service acceptent le code de contrôle de **\_ \_ préarrêt** reçoivent le code de contrôle de **\_ \_ préarrêt du contrôle de service** .</span><span class="sxs-lookup"><span data-stu-id="8b7a1-124">When the user shuts down the system, all control handlers that have called [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_ACCEPT\_PRESHUTDOWN** control code receive the **SERVICE\_CONTROL\_PRESHUTDOWN** control code.</span></span> <span data-ttu-id="8b7a1-125">Le gestionnaire de contrôle des services attend que le service s’arrête ou que la valeur du délai d’attente de préarrêt spécifié expire (cette valeur peut être définie avec la fonction [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) ).</span><span class="sxs-lookup"><span data-stu-id="8b7a1-125">The service control manager waits until the service stops or the specified preshutdown time-out value expires (this value can be set with the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) function).</span></span> <span data-ttu-id="8b7a1-126">Ce code de contrôle doit être utilisé uniquement dans des circonstances particulières, car un service qui gère cette notification bloque l’arrêt du système jusqu’à ce que le service s’arrête ou que l’intervalle de délai d’attente avant l’arrêt expire.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-126">This control code should be used only in special circumstances, because a service that handles this notification blocks system shutdown until the service stops or the preshutdown time-out interval expires.</span></span>

<span data-ttu-id="8b7a1-127">Une fois les notifications de préarrêt terminées, tous les gestionnaires de contrôle qui ont appelé [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) avec le **service \_ acceptent \_** le code de contrôle d’arrêt reçoivent le code de contrôle d' **\_ \_ arrêt du contrôle de service** .</span><span class="sxs-lookup"><span data-stu-id="8b7a1-127">After the preshutdown notifications have been completed, all control handlers that have called [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_ACCEPT\_SHUTDOWN** control code receive the **SERVICE\_CONTROL\_SHUTDOWN** control code.</span></span> <span data-ttu-id="8b7a1-128">Ils sont notifiés dans l’ordre dans lequel ils apparaissent dans la base de données des services installés.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-128">They are notified in the order that they appear in the database of installed services.</span></span> <span data-ttu-id="8b7a1-129">Par défaut, un service dispose d’environ 20 secondes pour effectuer des tâches de nettoyage avant que le système ne s’arrête.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-129">By default, a service has approximately 20 seconds to perform cleanup tasks before the system shuts down.</span></span> <span data-ttu-id="8b7a1-130">À l’expiration de ce délai, l’arrêt du système se poursuit, que l’arrêt du service soit terminé ou non.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-130">After this time expires, system shutdown proceeds regardless of whether service shutdown is complete.</span></span> <span data-ttu-id="8b7a1-131">Notez que si le système est laissé à l’état d’arrêt (pas redémarré ou mis hors tension), le service continue à s’exécuter.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-131">Note that if the system is left in the shutdown state (not restarted or powered down), the service continues to run.</span></span>

<span data-ttu-id="8b7a1-132">Si le service nécessite plus de temps pour le nettoyage, il envoie des messages d’état d' **arrêt \_ en attente** , ainsi qu’un indicateur d’attente, afin que le contrôleur de service sache combien de temps attendre avant de signaler au système que l’arrêt du service est terminé.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-132">If the service requires more time to cleanup, it sends **STOP\_PENDING** status messages, along with a wait hint, so the service controller knows how long to wait before reporting to the system that service shutdown is complete.</span></span> <span data-ttu-id="8b7a1-133">Toutefois, pour empêcher un service d’arrêter l’arrêt, la durée d’attente du contrôleur de service est limitée.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-133">However, to prevent a service from stopping shutdown, there is a limit to how long the service controller waits.</span></span> <span data-ttu-id="8b7a1-134">Si le service est arrêté par le biais du composant logiciel enfichable Services, la limite est de 125 secondes, soit 125 000 millisecondes.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-134">If the service is being shut down through the Services snap-in, the limit is 125 seconds, or 125,000 milliseconds.</span></span> <span data-ttu-id="8b7a1-135">Si le système d’exploitation est en cours de redémarrage, la limite de temps est spécifiée dans la valeur **WaitToKillServiceTimeout** (en millisecondes) de la clé de Registre suivante :</span><span class="sxs-lookup"><span data-stu-id="8b7a1-135">If the operating system is rebooting, the time limit is specified in the **WaitToKillServiceTimeout** value (in milliseconds) of the following registry key:</span></span>

<span data-ttu-id="8b7a1-136">**HKEY \_ local \_ machine \\ System \\ CurrentControlSet \\ Control**</span><span class="sxs-lookup"><span data-stu-id="8b7a1-136">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control**</span></span>

> [!IMPORTANT]
> <span data-ttu-id="8b7a1-137">Un service ne doit pas tenter d’augmenter la limite de temps en modifiant cette valeur.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-137">A service should not attempt to increase the time limit by modifying this value.</span></span> <span data-ttu-id="8b7a1-138">Si vous n’avez pas besoin de définir **WaitToKillServiceTimeout** à la main, la valeur doit être exprimée en millisecondes.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-138">If you do need to set **WaitToKillServiceTimeout** by hand, the value should be in milliseconds.</span></span>

<span data-ttu-id="8b7a1-139">Les clients doivent arrêter rapidement le système d’exploitation.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-139">Customers require fast shutdown of the operating system.</span></span> <span data-ttu-id="8b7a1-140">Par exemple, si un ordinateur exécutant une alimentation UPS ne peut pas se terminer avant que l’onduleur ne soit hors tension, les données peuvent être perdues.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-140">For example, if a computer running on UPS power cannot complete shutdown before the UPS runs out of power, data can be lost.</span></span> <span data-ttu-id="8b7a1-141">Par conséquent, les services doivent effectuer leurs tâches de nettoyage aussi rapidement que possible.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-141">Therefore, services should complete their cleanup tasks as quickly as possible.</span></span> <span data-ttu-id="8b7a1-142">Il est conseillé de réduire les données non enregistrées en enregistrant régulièrement les données, en conservant le suivi des données enregistrées sur le disque et en enregistrant uniquement les données non enregistrées à l’arrêt.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-142">It is a good practice to minimize unsaved data by saving data on a regular basis, keeping track of the data that is saved to disk, and only saving your unsaved data on shutdown.</span></span> <span data-ttu-id="8b7a1-143">Étant donné que l’ordinateur est en cours d’arrêt, ne perdez pas de temps à libérer de la mémoire ou d’autres ressources système.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-143">Because the computer is being shut down, do not spend time releasing allocated memory or other system resources.</span></span> <span data-ttu-id="8b7a1-144">Si vous avez besoin de notifier un serveur que vous quittez, réduisez le temps passé à attendre une réponse, car des problèmes réseau pourraient retarder l’arrêt de votre service.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-144">If you need to notify a server that you are exiting, minimize the time spent waiting for a reply, because network problems could delay the shutdown of your service.</span></span>

<span data-ttu-id="8b7a1-145">Notez que pendant l’arrêt du service, par défaut, le SCM ne prend pas en compte les dépendances.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-145">Note that during service shutdown, by default, the SCM does not take dependencies into consideration.</span></span> <span data-ttu-id="8b7a1-146">Le SCM énumère la liste des services en cours d’exécution et envoie la commande d' **\_ \_ arrêt du contrôle de service** .</span><span class="sxs-lookup"><span data-stu-id="8b7a1-146">The SCM enumerates the list of running services and sends the **SERVICE\_CONTROL\_SHUTDOWN** command.</span></span> <span data-ttu-id="8b7a1-147">Par conséquent, un service peut échouer parce qu’un autre service dont il dépend a déjà été arrêté.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-147">Therefore, a service may fail because another service it depends on has already stopped.</span></span>

<span data-ttu-id="8b7a1-148">Pour définir manuellement l’ordre d’arrêt des services, créez une valeur de Registre multichaîne qui contient les noms de service dans l’ordre dans lequel ils doivent être arrêtés et affectez-les à la valeur **PreshutdownOrder** de la clé de contrôle, comme suit :</span><span class="sxs-lookup"><span data-stu-id="8b7a1-148">To set the shutdown order of services manually, create a multistring registry value that contains the service names in the order in which they should be shut down and assign it to the Control key's **PreshutdownOrder** value, as follows:</span></span>

<span data-ttu-id="8b7a1-149">**HKEY \_ local \_ machine \\ System \\ CurrentControlSet \\ Control \\ PreshutdownOrder = "ordre d’arrêt"**</span><span class="sxs-lookup"><span data-stu-id="8b7a1-149">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\PreshutdownOrder="Shutdown Order"**</span></span>

<span data-ttu-id="8b7a1-150">Pour définir l’ordre d’arrêt des services dépendants à partir de votre application, utilisez la fonction [**SetProcessShutdownParameters**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) .</span><span class="sxs-lookup"><span data-stu-id="8b7a1-150">To set the shutdown order of dependent services from your application, use the [**SetProcessShutdownParameters**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) function.</span></span> <span data-ttu-id="8b7a1-151">Le SCM utilise cette fonction pour attribuer à son gestionnaire la priorité 0x1E0.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-151">The SCM uses this function to give its handler 0x1E0 priority.</span></span> <span data-ttu-id="8b7a1-152">Le SCM envoie des notifications d' **\_ \_ arrêt du contrôle de service** lorsque son gestionnaire de contrôle est appelé et attend que les services se ferment avant de retourner à partir de son gestionnaire de contrôle.</span><span class="sxs-lookup"><span data-stu-id="8b7a1-152">The SCM sends **SERVICE\_CONTROL\_SHUTDOWN** notifications when its control handler is called and waits for the services to exit before returning from its control handler.</span></span>

## <a name="related-topics"></a><span data-ttu-id="8b7a1-153">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="8b7a1-153">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8b7a1-154">Écriture d’une fonction de gestionnaire de contrôle</span><span class="sxs-lookup"><span data-stu-id="8b7a1-154">Writing a Control Handler Function</span></span>](writing-a-control-handler-function.md)
</dt> </dl>

 

 
