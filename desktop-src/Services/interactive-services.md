---
description: En règle générale, les services sont des applications console conçues pour s’exécuter sans assistance sans interface utilisateur graphique (GUI).
ms.assetid: 3d6e090a-00b1-47d8-a4fb-620f3db8ba9c
title: Services interactifs
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 57dda3018b4b37e8c5ee56d67cd1db2c56da9b67
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "103867610"
---
# <a name="interactive-services"></a><span data-ttu-id="76ef2-103">Services interactifs</span><span class="sxs-lookup"><span data-stu-id="76ef2-103">Interactive Services</span></span>

<span data-ttu-id="76ef2-104">En règle générale, les services sont des applications console conçues pour s’exécuter sans assistance sans interface utilisateur graphique (GUI).</span><span class="sxs-lookup"><span data-stu-id="76ef2-104">Typically, services are console applications that are designed to run unattended without a graphical user interface (GUI).</span></span> <span data-ttu-id="76ef2-105">Toutefois, certains services peuvent nécessiter une interaction occasionnelle avec un utilisateur.</span><span class="sxs-lookup"><span data-stu-id="76ef2-105">However, some services may require occasional interaction with a user.</span></span> <span data-ttu-id="76ef2-106">Cette page présente les meilleures façons d’interagir avec l’utilisateur à partir d’un service.</span><span class="sxs-lookup"><span data-stu-id="76ef2-106">This page discusses the best ways to interact with the user from a service.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="76ef2-107">Les services ne peuvent pas interagir directement avec un utilisateur à partir de Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="76ef2-107">Services cannot directly interact with a user as of Windows Vista.</span></span> <span data-ttu-id="76ef2-108">Par conséquent, les techniques mentionnées dans la section intitulée utilisation d’un service interactif ne doivent pas être utilisées dans le nouveau code.</span><span class="sxs-lookup"><span data-stu-id="76ef2-108">Therefore, the techniques mentioned in the section titled Using an Interactive Service should not be used in new code.</span></span>

 

## <a name="interacting-with-a-user-from-a-service-indirectly"></a><span data-ttu-id="76ef2-109">Interaction indirecte avec un utilisateur à partir d’un service</span><span class="sxs-lookup"><span data-stu-id="76ef2-109">Interacting with a User from a Service Indirectly</span></span>

<span data-ttu-id="76ef2-110">Vous pouvez utiliser les techniques suivantes pour interagir avec l’utilisateur à partir d’un service sur toutes les versions de Windows prises en charge :</span><span class="sxs-lookup"><span data-stu-id="76ef2-110">You can use the following techniques to interact with the user from a service on all supported versions of Windows:</span></span>

-   <span data-ttu-id="76ef2-111">Affiche une boîte de dialogue dans la session de l’utilisateur à l’aide de la fonction [**WTSSendMessage**](/windows/desktop/api/wtsapi32/nf-wtsapi32-wtssendmessagea) .</span><span class="sxs-lookup"><span data-stu-id="76ef2-111">Display a dialog box in the user's session using the [**WTSSendMessage**](/windows/desktop/api/wtsapi32/nf-wtsapi32-wtssendmessagea) function.</span></span>
-   <span data-ttu-id="76ef2-112">Créez une application GUI cachée distincte et utilisez la fonction [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) pour exécuter l’application dans le contexte de l’utilisateur interactif.</span><span class="sxs-lookup"><span data-stu-id="76ef2-112">Create a separate hidden GUI application and use the [**CreateProcessAsUser**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessasusera) function to run the application within the context of the interactive user.</span></span> <span data-ttu-id="76ef2-113">Concevez l’application GUI pour communiquer avec le service par le biais d’une méthode de communication interprocessus (IPC), par exemple, canaux nommés.</span><span class="sxs-lookup"><span data-stu-id="76ef2-113">Design the GUI application to communicate with the service through some method of interprocess communication (IPC), for example, named pipes.</span></span> <span data-ttu-id="76ef2-114">Le service communique avec l’application GUI pour lui indiquer quand afficher l’interface utilisateur graphique.</span><span class="sxs-lookup"><span data-stu-id="76ef2-114">The service communicates with the GUI application to tell it when to display the GUI.</span></span> <span data-ttu-id="76ef2-115">L’application communique les résultats de l’interaction de l’utilisateur au service afin que le service puisse prendre les mesures appropriées.</span><span class="sxs-lookup"><span data-stu-id="76ef2-115">The application communicates the results of the user interaction back to the service so that the service can take the appropriate action.</span></span> <span data-ttu-id="76ef2-116">Notez que IPC peut exposer vos interfaces de service sur le réseau, sauf si vous utilisez une liste de contrôle d’accès (ACL) appropriée.</span><span class="sxs-lookup"><span data-stu-id="76ef2-116">Note that IPC can expose your service interfaces over the network unless you use an appropriate access control list (ACL).</span></span>

    <span data-ttu-id="76ef2-117">Si ce service s’exécute sur un système multi-utilisateur, ajoutez l’application à la clé suivante pour qu’elle soit exécutée dans chaque session : **HKEY \_ local \_ machine \\ Software \\ Microsoft \\ Windows \\ CurrentVersion \\ Run**.</span><span class="sxs-lookup"><span data-stu-id="76ef2-117">If this service runs on a multiuser system, add the application to the following key so that it is run in each session: **HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run**.</span></span> <span data-ttu-id="76ef2-118">Si l’application utilise des canaux nommés pour IPC, le serveur peut faire la distinction entre plusieurs processus utilisateur en attribuant à chaque canal un nom unique basé sur l’ID de session.</span><span class="sxs-lookup"><span data-stu-id="76ef2-118">If the application uses named pipes for IPC, the server can distinguish between multiple user processes by giving each pipe a unique name based on the session ID.</span></span>

<span data-ttu-id="76ef2-119">La technique suivante est également disponible pour Windows Server 2003 et Windows XP :</span><span class="sxs-lookup"><span data-stu-id="76ef2-119">The following technique is also available for Windows Server 2003 and Windows XP:</span></span>

-   <span data-ttu-id="76ef2-120">Affichez une boîte de message en appelant la fonction [**MessageBox**](/windows/win32/api/winuser/nf-winuser-messagebox) avec la **\_ \_ notification de service MB**.</span><span class="sxs-lookup"><span data-stu-id="76ef2-120">Display a message box by calling the [**MessageBox**](/windows/win32/api/winuser/nf-winuser-messagebox) function with **MB\_SERVICE\_NOTIFICATION**.</span></span> <span data-ttu-id="76ef2-121">Cela est recommandé pour afficher des messages d’État simples.</span><span class="sxs-lookup"><span data-stu-id="76ef2-121">This is recommended for displaying simple status messages.</span></span> <span data-ttu-id="76ef2-122">N’appelez pas **MessageBox** pendant l’initialisation du service ou à partir de la routine [**HandlerEx**](/windows/desktop/api/WinSvc/nc-winsvc-lphandler_function_ex) , sauf si vous l’appelez à partir d’un thread distinct, afin de revenir en temps voulu au SCM.</span><span class="sxs-lookup"><span data-stu-id="76ef2-122">Do not call **MessageBox** during service initialization or from the [**HandlerEx**](/windows/desktop/api/WinSvc/nc-winsvc-lphandler_function_ex) routine, unless you call it from a separate thread, so that you return to the SCM in a timely manner.</span></span>

## <a name="using-an-interactive-service"></a><span data-ttu-id="76ef2-123">Utilisation d’un service interactif</span><span class="sxs-lookup"><span data-stu-id="76ef2-123">Using an Interactive Service</span></span>

<span data-ttu-id="76ef2-124">Par défaut, les services utilisent une [station Windows](/windows/desktop/winstation/window-stations) non interactive et ne peuvent pas interagir avec l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="76ef2-124">By default, services use a noninteractive [window station](/windows/desktop/winstation/window-stations) and cannot interact with the user.</span></span> <span data-ttu-id="76ef2-125">Toutefois, un *service interactif* peut afficher une interface utilisateur et recevoir une entrée d’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="76ef2-125">However, an *interactive service* can display a user interface and receive user input.</span></span>

> [!Caution]  
> <span data-ttu-id="76ef2-126">Les services qui s’exécutent dans un contexte de sécurité élevé, tel que le compte LocalSystem, ne doivent pas créer de fenêtre sur le bureau interactif, car toute autre application qui s’exécute sur le bureau interactif peut interagir avec cette fenêtre.</span><span class="sxs-lookup"><span data-stu-id="76ef2-126">Services running in an elevated security context, such as the LocalSystem account, should not create a window on the interactive desktop because any other application that is running on the interactive desktop can interact with this window.</span></span> <span data-ttu-id="76ef2-127">Cela expose le service à toute application exécutée par un utilisateur connecté.</span><span class="sxs-lookup"><span data-stu-id="76ef2-127">This exposes the service to any application that a logged-on user executes.</span></span> <span data-ttu-id="76ef2-128">En outre, les services qui s’exécutent en tant que LocalSystem ne doivent pas accéder au bureau interactif en appelant la fonction [**OpenWindowStation**](/windows/desktop/api/winuser/nf-winuser-openwindowstationa) ou [**GetThreadDesktop**](/windows/desktop/api/winuser/nf-winuser-getthreaddesktop) .</span><span class="sxs-lookup"><span data-stu-id="76ef2-128">Also, services that are running as LocalSystem should not access the interactive desktop by calling the [**OpenWindowStation**](/windows/desktop/api/winuser/nf-winuser-openwindowstationa) or [**GetThreadDesktop**](/windows/desktop/api/winuser/nf-winuser-getthreaddesktop) function.</span></span>

 

<span data-ttu-id="76ef2-129">Pour créer un service interactif, procédez comme suit lors de l’appel de la fonction [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) :</span><span class="sxs-lookup"><span data-stu-id="76ef2-129">To create an interactive service, do the following when calling the [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) function:</span></span>

1.  <span data-ttu-id="76ef2-130">Spécifiez NULL pour le paramètre *lpServiceStartName* pour exécuter le service dans le contexte du [compte LocalSystem](localsystem-account.md).</span><span class="sxs-lookup"><span data-stu-id="76ef2-130">Specify NULL for the *lpServiceStartName* parameter to run the service in the context of the [LocalSystem account](localsystem-account.md).</span></span>
2.  <span data-ttu-id="76ef2-131">Spécifiez l’indicateur de **\_ \_ processus interactif du service** .</span><span class="sxs-lookup"><span data-stu-id="76ef2-131">Specify the **SERVICE\_INTERACTIVE\_PROCESS** flag.</span></span>

<span data-ttu-id="76ef2-132">Pour déterminer si un service s’exécute en tant que service interactif, appelez la fonction [**GetProcessWindowStation**](/windows/desktop/api/winuser/nf-winuser-getprocesswindowstation) pour récupérer un handle vers la station Windows et la fonction [**GetUserObjectInformation**](/windows/desktop/api/winuser/nf-winuser-getuserobjectinformationa) pour tester si la station Windows possède l' **attribut \_ visible wsf** .</span><span class="sxs-lookup"><span data-stu-id="76ef2-132">To determine whether a service is running as an interactive service, call the [**GetProcessWindowStation**](/windows/desktop/api/winuser/nf-winuser-getprocesswindowstation) function to retrieve a handle to the window station, and the [**GetUserObjectInformation**](/windows/desktop/api/winuser/nf-winuser-getuserobjectinformationa) function to test whether the window station has the **WSF\_VISIBLE** attribute.</span></span>

<span data-ttu-id="76ef2-133">Toutefois, Notez que la clé de Registre suivante contient une valeur, **NoInteractiveServices**, qui contrôle l’effet du \_ processus interactif de service \_ :</span><span class="sxs-lookup"><span data-stu-id="76ef2-133">However, note that the following registry key contains a value, **NoInteractiveServices**, that controls the effect of SERVICE\_INTERACTIVE\_PROCESS:</span></span>

<span data-ttu-id="76ef2-134">**HKEY \_ local \_ machine \\ System \\ CurrentControlSet \\ Control \\ Windows**</span><span class="sxs-lookup"><span data-stu-id="76ef2-134">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Windows**</span></span>

<span data-ttu-id="76ef2-135">La valeur de **NoInteractiveServices** par défaut est 1, ce qui signifie qu’aucun service n’est autorisé à s’exécuter de manière interactive, qu’il dispose ou non d’un **\_ \_ processus interactif de service**.</span><span class="sxs-lookup"><span data-stu-id="76ef2-135">The **NoInteractiveServices** value defaults to 1, which means that no service is allowed to run interactively, regardless of whether it has **SERVICE\_INTERACTIVE\_PROCESS**.</span></span> <span data-ttu-id="76ef2-136">Quand **NoInteractiveServices** a la valeur 0, les services avec **le \_ \_ processus interactif service** sont autorisés à s’exécuter de manière interactive.</span><span class="sxs-lookup"><span data-stu-id="76ef2-136">When **NoInteractiveServices** is set to a 0, services with **SERVICE\_INTERACTIVE\_PROCESS** are allowed to run interactively.</span></span>

<span data-ttu-id="76ef2-137">**Windows 7, Windows server 2008 R2, Windows XP et Windows server 2003 :** La valeur de **NoInteractiveServices** est définie par défaut sur 0, ce qui signifie que les services avec **\_ \_ processus interactif de service** sont autorisés à s’exécuter de manière interactive.</span><span class="sxs-lookup"><span data-stu-id="76ef2-137">**Windows 7, Windows Server 2008 R2, Windows XP and Windows Server 2003:** The **NoInteractiveServices** value defaults to 0, which means that services with **SERVICE\_INTERACTIVE\_PROCESS** are allowed to run interactively.</span></span> <span data-ttu-id="76ef2-138">Quand **NoInteractiveServices** est défini sur une valeur différente de zéro, aucun service démarré par la suite n’est autorisé à s’exécuter de manière interactive, qu’il dispose ou non d’un **\_ \_ processus interactif de service**.</span><span class="sxs-lookup"><span data-stu-id="76ef2-138">When **NoInteractiveServices** is set to a nonzero value, no service started thereafter is allowed to run interactively, regardless of whether it has **SERVICE\_INTERACTIVE\_PROCESS**.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="76ef2-139">Tous les services s’exécutent dans la session des services Terminal Server 0.</span><span class="sxs-lookup"><span data-stu-id="76ef2-139">All services run in Terminal Services session 0.</span></span> <span data-ttu-id="76ef2-140">Par conséquent, si un service interactif affiche une interface utilisateur, il n’est visible que par l’utilisateur qui s’est connecté à la session 0.</span><span class="sxs-lookup"><span data-stu-id="76ef2-140">Therefore, if an interactive service displays a user interface, it is visible only to the user who connected to session 0.</span></span> <span data-ttu-id="76ef2-141">Étant donné qu’il n’existe aucun moyen de garantir que l’utilisateur interactif est connecté à la session 0, ne configurez pas un service pour qu’il s’exécute en tant que service interactif sous Terminal Services ou sur un système qui prend en charge le changement rapide d’utilisateur (le changement rapide d’utilisateur est implémenté à l’aide des services Terminal Server).</span><span class="sxs-lookup"><span data-stu-id="76ef2-141">Because there is no way to guarantee that the interactive user is connected to session 0, do not configure a service to run as an interactive service under Terminal Services or on a system that supports fast user switching (fast user switching is implemented using Terminal Services).</span></span>

 

 

 
