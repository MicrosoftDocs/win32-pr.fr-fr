---
description: Découvrez comment protéger les services en mode utilisateur anti-malware (AM) et comment vous pouvez choisir d’inclure cette fonctionnalité dans votre service anti-programme malveillant.
ms.assetid: 88875a0d-9027-43f2-8411-34f9ff428fe5
title: Protection des services anti-programme malveillant
ms.topic: article
ms.date: 08/02/2018
ms.openlocfilehash: 5e7783eb307381d368900332b5e761ad62785913
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "104035203"
---
# <a name="protecting-anti-malware-services"></a><span data-ttu-id="87c91-103">Protection des services anti-programme malveillant</span><span class="sxs-lookup"><span data-stu-id="87c91-103">Protecting Anti-Malware Services</span></span>

<span data-ttu-id="87c91-104">Windows 8.1 a introduit un nouveau concept de services protégés pour protéger les services anti-programmes malveillants, qui sont une cible fréquente de l’attaque par un programme malveillant.</span><span class="sxs-lookup"><span data-stu-id="87c91-104">Windows 8.1 introduced a new concept of protected services to protect anti-malware services, which are a frequent target of attack by malware.</span></span>

<span data-ttu-id="87c91-105">Découvrez comment protéger les services en mode utilisateur anti-malware (AM) et comment vous pouvez choisir d’inclure cette fonctionnalité dans votre service anti-programme malveillant.</span><span class="sxs-lookup"><span data-stu-id="87c91-105">Learn about protecting anti-malware (AM) user mode services and how you can opt to include this feature in your anti-malware service.</span></span>

<span data-ttu-id="87c91-106">Ces informations s’appliquent aux systèmes d’exploitation et aux successeurs suivants :</span><span class="sxs-lookup"><span data-stu-id="87c91-106">This information applies to the following operating systems and their successors:</span></span>

-   <span data-ttu-id="87c91-107">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="87c91-107">Windows 8.1</span></span>
-   <span data-ttu-id="87c91-108">Windows Server 2012 R2</span><span class="sxs-lookup"><span data-stu-id="87c91-108">Windows Server 2012 R2</span></span>

<span data-ttu-id="87c91-109">Les références et les ressources présentées ici sont répertoriées à la fin de cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="87c91-109">References and resources discussed here are listed at the end of this topic.</span></span>

## <a name="introduction"></a><span data-ttu-id="87c91-110">Introduction</span><span class="sxs-lookup"><span data-stu-id="87c91-110">Introduction</span></span>

<span data-ttu-id="87c91-111">La plupart des solutions anti-programmes malveillants incluent un service en mode utilisateur qui effectue des opérations spécialisées pour détecter et supprimer les logiciels malveillants du système.</span><span class="sxs-lookup"><span data-stu-id="87c91-111">Most anti-malware solutions include a user-mode service that performs specialized operations to detect and remove malware from the system.</span></span> <span data-ttu-id="87c91-112">Ce service en mode utilisateur est également souvent chargé de télécharger les dernières définitions de virus et signatures.</span><span class="sxs-lookup"><span data-stu-id="87c91-112">This user-mode service is also frequently responsible for downloading the latest virus definitions and signatures.</span></span> <span data-ttu-id="87c91-113">Ce service en mode utilisateur devient une cible fréquente de programmes malveillants, car il s’agit du point de défaillance unique de la désactivation de la protection sur un système.</span><span class="sxs-lookup"><span data-stu-id="87c91-113">This user-mode service becomes a frequent target of malware because it’s the single point of failure to disable protection on a system.</span></span> <span data-ttu-id="87c91-114">Pour se défendre contre les attaques sur le service en mode utilisateur, les fournisseurs de logiciels anti-programme malveillant doivent ajouter de nombreuses fonctionnalités et heuristiques à leurs logiciels.</span><span class="sxs-lookup"><span data-stu-id="87c91-114">To defend against attacks on the user-mode service, anti-malware vendors have to add a lot of functionality and heuristics to their software.</span></span> <span data-ttu-id="87c91-115">Toutefois, ces techniques ne sont pas complètement infaillibles et ont tendance à être sujettes aux erreurs, car elles doivent identifier les fonctionnalités que Windows exécute sur leur service et activer de manière sélective cette fonctionnalité.</span><span class="sxs-lookup"><span data-stu-id="87c91-115">However, such techniques are not completely foolproof and tend to be error prone because they have to identify functionality that Windows performs on their service and selectively enable that functionality.</span></span>

<span data-ttu-id="87c91-116">Dans Windows 8.1, un nouveau concept de service protégé a été introduit pour permettre le lancement des services en mode utilisateur anti-programme malveillant en tant que service protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-116">In Windows 8.1, a new concept of protected service has been introduced to allow anti-malware user-mode services to be launched as a protected service.</span></span> <span data-ttu-id="87c91-117">Une fois que le service est lancé comme protégé, Windows utilise l’intégrité du code pour autoriser le chargement du code de confiance uniquement dans le service protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-117">After the service is launched as protected, Windows uses code integrity to only allow trusted code to load into the protected service.</span></span> <span data-ttu-id="87c91-118">Windows protège également ces processus contre l’injection de code et d’autres attaques de processus d’administration.</span><span class="sxs-lookup"><span data-stu-id="87c91-118">Windows also protects these processes from code injection and other attacks from admin processes.</span></span>

<span data-ttu-id="87c91-119">Ce document décrit comment un fournisseur de logiciels anti-programme malveillant avec un pilote anti-programme malveillant à lancement anticipé (ELAM) peut s’abonner à cette fonctionnalité et lancer son service anti-programme malveillant en tant que service protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-119">This document describes how an anti-malware vendor with an Early Launch Anti-Malware (ELAM) driver can opt-in to this feature and launch their anti-malware service as a protected service.</span></span>

## <a name="system-protected-process"></a><span data-ttu-id="87c91-120">Processus protégé par le système</span><span class="sxs-lookup"><span data-stu-id="87c91-120">System protected process</span></span>

<span data-ttu-id="87c91-121">À partir de Windows 8.1, un nouveau modèle de sécurité a été mis en place dans le noyau pour mieux se défendre contre les attaques malveillantes sur les composants critiques du système.</span><span class="sxs-lookup"><span data-stu-id="87c91-121">Starting with Windows 8.1, a new security model has been put in place in the kernel to better defend against malicious attacks on system-critical components.</span></span> <span data-ttu-id="87c91-122">Ce nouveau modèle de sécurité étend l’infrastructure de processus protégée versions précédentes de Windows utilisée pour des scénarios spécifiques, tels que la diffusion de contenu DRM, dans un modèle à usage général qui peut être utilisé par des fournisseurs de logiciels anti-programme malveillant tiers.</span><span class="sxs-lookup"><span data-stu-id="87c91-122">This new security model extends the protected process infrastructure previous versions of Windows used for specific scenarios, such as playing DRM content, into a general-purpose model that can be used by 3rd party anti-malware vendors.</span></span> <span data-ttu-id="87c91-123">L’infrastructure de processus protégée autorise uniquement le chargement de code signé et approuvé et dispose d’une protection intégrée contre les attaques par injection de code.</span><span class="sxs-lookup"><span data-stu-id="87c91-123">The protected process infrastructure only allows trusted, signed code to load and has built-in defense against code injection attacks.</span></span>

<span data-ttu-id="87c91-124">Pour plus d’informations sur les processus protégés [, consultez processus protégés dans Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) .</span><span class="sxs-lookup"><span data-stu-id="87c91-124">See [Protected Processes in Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) for more information on protected processes.</span></span>

<span data-ttu-id="87c91-125">Le nouveau modèle de sécurité utilise une variante légèrement différente de l’infrastructure du processus de protection, appelée processus protégé par le système, qui est plus appropriée pour cette fonctionnalité, car cela permet de séparer le contenu DRM.</span><span class="sxs-lookup"><span data-stu-id="87c91-125">The new security model uses a slightly different variant of the protection process infrastructure called system protected process, which is more suitable for this feature as this keeps the DRM content separate.</span></span> <span data-ttu-id="87c91-126">Chaque processus protégé par le système possède un niveau ou un attribut associé, qui indique la stratégie de signature du code signé autorisé à être chargé au sein du processus.</span><span class="sxs-lookup"><span data-stu-id="87c91-126">Each system protected process has an associated level or attribute, which indicates the signature policy of the signed code allowed to load within the process.</span></span> <span data-ttu-id="87c91-127">Une fois que les services anti-programme malveillant ont choisi le mode de service protégé, seul le code signé Windows ou le code signé avec les certificats du fournisseur de logiciels anti-programmes malveillants est autorisé à se charger dans ce processus.</span><span class="sxs-lookup"><span data-stu-id="87c91-127">After the anti-malware services have opted into the protected service mode, only Windows signed code or code signed with the anti-malware vendor’s certificates are allowed to load in that process.</span></span> <span data-ttu-id="87c91-128">De même, d’autres niveaux de processus protégés ont des stratégies de code différentes appliquées par Windows.</span><span class="sxs-lookup"><span data-stu-id="87c91-128">Similarly, other protected process levels have different code policies enforced by Windows.</span></span>

## <a name="requirements"></a><span data-ttu-id="87c91-129">Configuration requise</span><span class="sxs-lookup"><span data-stu-id="87c91-129">Requirements</span></span>

<span data-ttu-id="87c91-130">Pour qu’un service en mode utilisateur anti-programme malveillant s’exécute en tant que service protégé, le fournisseur du logiciel anti-programme malveillant doit avoir un pilote ELAM installé sur l’ordinateur Windows.</span><span class="sxs-lookup"><span data-stu-id="87c91-130">For an anti-malware user-mode service to run as a protected service, the anti-malware vendor must have an ELAM driver installed on the Windows machine.</span></span> <span data-ttu-id="87c91-131">Outre les exigences existantes en matière de certification du pilote ELAM, le pilote doit disposer d’une section de ressource incorporée contenant les informations des certificats utilisés pour signer les fichiers binaires du service en mode utilisateur.</span><span class="sxs-lookup"><span data-stu-id="87c91-131">In addition to the existing ELAM driver certification requirements, the driver must have an embedded resource section containing the information of the certificates used to sign the user mode service binaries.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="87c91-132">Dans Windows 8.1, la chaîne de certification doit être une racine connue telle qu’elle est déterminée par la vérification du pilote, ou le certificat racine doit être inclus.</span><span class="sxs-lookup"><span data-stu-id="87c91-132">In Windows 8.1, the certification chain either has to be a known root as determined by driver verification, or the root certificate must be included.</span></span>

 

<span data-ttu-id="87c91-133">Au cours du processus de démarrage, cette section de ressource sera extraite du pilote ELAM pour valider les informations de certificat et inscrire le service anti-programme malveillant.</span><span class="sxs-lookup"><span data-stu-id="87c91-133">During the boot process, this resource section will be extracted from the ELAM driver to validate the certificate information and register the anti-malware service.</span></span> <span data-ttu-id="87c91-134">Le service anti-programme malveillant peut également être enregistré lors du processus d’installation du logiciel anti-programme malveillant en appelant une API spéciale, comme décrit plus loin dans ce document.</span><span class="sxs-lookup"><span data-stu-id="87c91-134">The anti-malware service can also be registered during the anti-malware software installation process by calling a special API, as described later in this document.</span></span>

<span data-ttu-id="87c91-135">Une fois que la section de la ressource a été extraite avec succès du pilote ELAM et que le service en mode utilisateur est inscrit, le service est autorisé à se lancer en tant que service protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-135">After the resource section is successfully extracted from the ELAM driver and the user-mode service is registered, the service is allowed to launch as protected service.</span></span> <span data-ttu-id="87c91-136">Une fois que le service est lancé comme protégé, les autres processus non protégés sur le système ne seront pas en mesure d’injecter des threads, et ils ne seront pas autorisés à écrire dans la mémoire virtuelle du processus protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-136">After the service is launched as protected, other non-protected processes on the system won't be able to inject threads, and they wont' be allowed to write into the virtual memory of the protected process.</span></span>

<span data-ttu-id="87c91-137">En outre, toutes les dll non-Windows qui sont chargées dans le processus protégé doivent être signées avec un certificat approprié.</span><span class="sxs-lookup"><span data-stu-id="87c91-137">In addition, any non-Windows DLLs that get loaded into the protected process must be signed with an appropriate certificate.</span></span>

<span data-ttu-id="87c91-138">Pour plus d’informations sur les pilotes ELAM, consultez [logiciel anti-programme malveillant à lancement anticipé](/windows/desktop/w8cookbook/secured-boot) .</span><span class="sxs-lookup"><span data-stu-id="87c91-138">See [Early launch antimalware](/windows/desktop/w8cookbook/secured-boot) for more information on ELAM drivers.</span></span>

### <a name="anti-malware-service-signing-requirements"></a><span data-ttu-id="87c91-139">Conditions requises pour la signature du service anti-programme malveillant</span><span class="sxs-lookup"><span data-stu-id="87c91-139">Anti-malware service signing requirements</span></span>

<span data-ttu-id="87c91-140">Le service en mode utilisateur qui doit être lancé comme protégé doit être signé avec des certificats valides.</span><span class="sxs-lookup"><span data-stu-id="87c91-140">The user-mode service that needs to be launched as protected must be signed with valid certificates.</span></span> <span data-ttu-id="87c91-141">L’exécutable du service doit être signé par hachage de page et toutes les dll non-Windows qui sont chargées dans le service doivent également être signées avec les mêmes certificats.</span><span class="sxs-lookup"><span data-stu-id="87c91-141">The service EXE must be page hash signed, and any non-Windows DLLs that get loaded into the service must be also signed with the same certificates.</span></span> <span data-ttu-id="87c91-142">Le hachage de ces certificats doit être ajouté au fichier de ressources, qui sera lié au pilote ELAM.</span><span class="sxs-lookup"><span data-stu-id="87c91-142">The hash of these certificates must be added into the resource file, which will be linked into the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="87c91-143">SHA256 les hachages de fichier/page doivent être utilisés, bien que les certificats puissent continuer à être SHA1.</span><span class="sxs-lookup"><span data-stu-id="87c91-143">SHA256 file/page hashes must be used, though certificates may continue to be SHA1.</span></span>

 

### <a name="primary-signature-recommended"></a><span data-ttu-id="87c91-144">Signature principale (recommandé)</span><span class="sxs-lookup"><span data-stu-id="87c91-144">Primary signature (recommended)</span></span>

<span data-ttu-id="87c91-145">Nous recommandons que les fournisseurs de logiciels anti-programmes malveillants utilisent leur certificat Authenticode existant pour signer leurs binaires de service anti-programme malveillant, et que le hachage de ce certificat Authenticode soit inclus dans la section des ressources pour indiquer le certificat utilisé pour signer les fichiers binaires du service.</span><span class="sxs-lookup"><span data-stu-id="87c91-145">We recommend that anti-malware vendors use their existing Authenticode certificate to sign their anti-malware service binaries, and that the hash of this Authenticode certificate be included in the resource section to indicate the certificate that's used to sign the service binaries.</span></span> <span data-ttu-id="87c91-146">Si vous mettez à jour ce certificat, une version plus récente du pilote ELAM doit être publiée avec les hachages de certificat mis à jour.</span><span class="sxs-lookup"><span data-stu-id="87c91-146">If you update this certificate, a newer version of the ELAM driver must be released with the updated certificate hashes.</span></span>

### <a name="secondary-signature-optional"></a><span data-ttu-id="87c91-147">Signature secondaire (facultatif)</span><span class="sxs-lookup"><span data-stu-id="87c91-147">Secondary signature (optional)</span></span>

<span data-ttu-id="87c91-148">Les fournisseurs de logiciels anti-programmes malveillants ont la possibilité de configurer une autorité de certification privée et d’utiliser les certificats de cette autorité de certification pour signer le code des fichiers binaires du service anti-programme malveillant comme signature secondaire.</span><span class="sxs-lookup"><span data-stu-id="87c91-148">Anti-malware vendors have the option to set up a private CA and use certificates from this CA to code sign the anti-malware service binaries as a secondary signature.</span></span> <span data-ttu-id="87c91-149">Le principal avantage de l’utilisation de l’autorité de certification privée est qu’elle permet aux fournisseurs de créer des certificats avec une propriété EKU spécialisée, qui peut être utilisée pour différencier plusieurs produits du même fournisseur.</span><span class="sxs-lookup"><span data-stu-id="87c91-149">The main advantage of using the private CA is that it enables vendors to create certificates with a specialized EKU property, which can be used to differentiate between multiple products from the same vendor.</span></span> <span data-ttu-id="87c91-150">Cela réduit également la nécessité de mettre à jour votre pilote ELAM en raison de l’expiration du certificat, car les certificats de l’autorité de certification privée ont généralement des dates d’expiration plus longues.</span><span class="sxs-lookup"><span data-stu-id="87c91-150">It also reduces the need to update your ELAM driver due to certificate expiry, as the private CA certs typically have longer expiry dates.</span></span>

<span data-ttu-id="87c91-151">Notez que si les fichiers binaires du service sont signés avec les certificats de l’autorité de certification privée, les binaires doivent également être signés en double avec les certificats Authenticode existants.</span><span class="sxs-lookup"><span data-stu-id="87c91-151">Note that if the service binaries are signed with the private CA certs, the binaries must also be dual signed with the existing Authenticode certificates.</span></span> <span data-ttu-id="87c91-152">Si les fichiers binaires ne sont pas signés par une autorité de certification approuvée bien connue (par exemple, VeriSign), l’utilisateur de l’ordinateur n’a aucune confiance dans les fichiers binaires, car ils ne peuvent pas faire confiance à l’autorité de certification privée.</span><span class="sxs-lookup"><span data-stu-id="87c91-152">If the binaries are not signed by a well-known trusted CA (for example VeriSign), the user of the machine has no confidence in the binaries because they cannot trust the private CA.</span></span> <span data-ttu-id="87c91-153">La double signature des binaires avec le certificat Authenticode existant permet également aux fichiers binaires de s’exécuter sur les systèmes d’exploitation de niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="87c91-153">Dual signing the binaries with the existing Authenticode certificate also allows the binaries to run on down-level operating systems.</span></span>

<span data-ttu-id="87c91-154">Pour plus d’informations sur la façon de configurer et d’installer l’autorité de certification, consultez [configuration d’une autorité de](/previous-versions/windows/desktop/ms755466(v=vs.85)) certification et [installation de l’autorité de certification](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11)).</span><span class="sxs-lookup"><span data-stu-id="87c91-154">For more info about how to set up and install the Certificate Authority, see [Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85)) and [Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11)).</span></span>

> [!Note]  
> <span data-ttu-id="87c91-155">Pour la compatibilité avec Windows Vista ou Windows XP (ou Windows 7 sans le correctif SHA2), vous pouvez utiliser le commutateur « /As » lors de la signature de vos fichiers binaires avec [SignTool.exe](/windows/desktop/SecCrypto/signtool) avec les hachages de fichier/page SHA256.</span><span class="sxs-lookup"><span data-stu-id="87c91-155">For compatibility with Windows Vista or Windows XP (or Windows 7 without the SHA2 patch), you can use the "/as" switch when signing your binaries with [SignTool.exe](/windows/desktop/SecCrypto/signtool) with the SHA256 file/page hashes.</span></span> <span data-ttu-id="87c91-156">Cette opération ajoute la signature comme signature secondaire au fichier.</span><span class="sxs-lookup"><span data-stu-id="87c91-156">This will add the signature as a secondary signature to the file.</span></span> <span data-ttu-id="87c91-157">SHA1 signale d’abord le fichier, car Windows XP, Windows Vista et Windows 7 ne voient que la première signature.</span><span class="sxs-lookup"><span data-stu-id="87c91-157">SHA1 sign the file first, since Windows XP, Windows Vista, and Windows 7 will only see the first signature.</span></span>

 

### <a name="dll-signing-requirements"></a><span data-ttu-id="87c91-158">Conditions requises pour la signature des DLL</span><span class="sxs-lookup"><span data-stu-id="87c91-158">DLL signing requirements</span></span>

<span data-ttu-id="87c91-159">Comme mentionné précédemment, toutes les dll non-Windows qui sont chargées dans le service protégé doivent être signées avec le même certificat que celui utilisé pour signer le service anti-programme malveillant.</span><span class="sxs-lookup"><span data-stu-id="87c91-159">As mentioned earlier, any non-Windows DLLs that get loaded into the protected service must be signed with the same certificate that was used to sign the anti-malware service.</span></span>

### <a name="catalog-signing"></a><span data-ttu-id="87c91-160">Signature du catalogue</span><span class="sxs-lookup"><span data-stu-id="87c91-160">Catalog Signing</span></span>

<span data-ttu-id="87c91-161">Les fournisseurs de logiciels anti-programmes malveillants peuvent inclure des packages développés par d’autres entreprises sans mettre à jour les signatures binaires.</span><span class="sxs-lookup"><span data-stu-id="87c91-161">Anti-malware vendors can include packages developed by other companies without updating the binary signatures.</span></span> <span data-ttu-id="87c91-162">Pour ce faire, vous pouvez inclure les fichiers binaires dans un catalogue signé avec leur certificat Authenticode, en procédant comme suit :</span><span class="sxs-lookup"><span data-stu-id="87c91-162">This can be achieved by including the binaries in a catalog which is signed with their Authenticode certificate, accomplished by following these steps:</span></span>

1. <span data-ttu-id="87c91-163">Générer un catalogue à l’aide de [MakeCat](/windows/desktop/SecCrypto/makecat)</span><span class="sxs-lookup"><span data-stu-id="87c91-163">Generate a catalog using [MakeCat](/windows/desktop/SecCrypto/makecat)</span></span>
2. <span data-ttu-id="87c91-164">Ajouter tous les fichiers binaires sans signature appropriée au catalogue</span><span class="sxs-lookup"><span data-stu-id="87c91-164">Add all of the binaries without an appropriate signature to the catalog</span></span>
3. <span data-ttu-id="87c91-165">Signez le catalogue avec le certificat Authenticode, comme vous le feriez pour tout autre fichier binaire</span><span class="sxs-lookup"><span data-stu-id="87c91-165">Sign the catalog with the Authenticode certificate, as you would any other binary</span></span>
4. <span data-ttu-id="87c91-166">Utilisez la fonction [Ajouter un catalogue](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) pour inclure le catalogue avec l’application.</span><span class="sxs-lookup"><span data-stu-id="87c91-166">Use the [add catalog](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) function to include the catalog with the application.</span></span>

<span data-ttu-id="87c91-167">Lorsque l’intégrité du code intervient dans les packages sans signature appropriée, il recherche un catalogue avec une signature approuvée.</span><span class="sxs-lookup"><span data-stu-id="87c91-167">When code integrity comes across the packages without an appropriate signature, it will search for a catalog with an approved signature.</span></span> <span data-ttu-id="87c91-168">Ce catalogue est trouvé tant que ces étapes sont suivies et installées avec l’application.</span><span class="sxs-lookup"><span data-stu-id="87c91-168">It will find this catalog as long as these steps are followed and it is installed with the application.</span></span>


## <a name="resource-file-info"></a><span data-ttu-id="87c91-169">Informations sur le fichier de ressources</span><span class="sxs-lookup"><span data-stu-id="87c91-169">Resource file info</span></span>

<span data-ttu-id="87c91-170">Un fichier de ressources doit être créé et lié au pilote ELAM.</span><span class="sxs-lookup"><span data-stu-id="87c91-170">A resource file must be created and linked into the ELAM driver.</span></span> <span data-ttu-id="87c91-171">Le hachage du certificat, ainsi que d’autres informations sur le certificat, doivent être ajoutés au fichier de ressources.</span><span class="sxs-lookup"><span data-stu-id="87c91-171">The hash of the certificate, along with other certificate information, must be added in the resource file.</span></span>

<span data-ttu-id="87c91-172">La section des ressources doit être dans la disposition suivante pour que le système extraie correctement les ressources de l’image binaire et valide les informations de certificat incorporées.</span><span class="sxs-lookup"><span data-stu-id="87c91-172">The resource section must be in the following layout for the system to successfully extract the resources from the binary image and validate the embedded certificate information.</span></span>

``` syntax
MicrosoftElamCertificateInfo  MSElamCertInfoID
{
      3, // count of entries
      L”CertHash1\0”,
      Algorithm,
      L”EKU1\0”,
      L”CertHash2\0”,
      Algorithm,
      L”\0”, //No EKU for cert hash 2
      L”CertHash3\0”,
      Algorithm,
      L”EKU3a;EKU3b;EKU3c\0”,  //multiple EKU entries supported (max: 3)
}
```

<span data-ttu-id="87c91-173">Pour plus d’informations sur le fichier de ressources défini par l’utilisateur, consultez [ressource définie par l’utilisateur](/windows/desktop/menurc/user-defined-resource).</span><span class="sxs-lookup"><span data-stu-id="87c91-173">For more info about user-defined resource file, see [User-Defined Resource](/windows/desktop/menurc/user-defined-resource).</span></span>

### <a name="certhash"></a><span data-ttu-id="87c91-174">CertHash</span><span class="sxs-lookup"><span data-stu-id="87c91-174">CertHash</span></span>

<span data-ttu-id="87c91-175">Hachage du certificat utilisé pour signer le service anti-programme malveillant.</span><span class="sxs-lookup"><span data-stu-id="87c91-175">The hash of the certificate that's used to sign the anti-malware service.</span></span> <span data-ttu-id="87c91-176">L’outil CertMgr.exe, fourni dans le SDK Windows, peut être utilisé pour obtenir le hachage.</span><span class="sxs-lookup"><span data-stu-id="87c91-176">The CertMgr.exe tool, which ships in the Windows SDK, can be used to obtain the hash.</span></span>

``` syntax
certmgr.exe –v <path to the signed file>
```

<span data-ttu-id="87c91-177">Par exemple :</span><span class="sxs-lookup"><span data-stu-id="87c91-177">For example:</span></span>

![hachage du certificat de service protégé contre les programmes malveillants (certhash)](images/cert-hash-example.png)

### <a name="algorithm"></a><span data-ttu-id="87c91-179">Algorithm</span><span class="sxs-lookup"><span data-stu-id="87c91-179">Algorithm</span></span>

<span data-ttu-id="87c91-180">La valeur de l’algorithme représente l’algorithme du certificat.</span><span class="sxs-lookup"><span data-stu-id="87c91-180">The algorithm value represents the algorithm of the certificate.</span></span> <span data-ttu-id="87c91-181">Ces valeurs d’algorithme sont prises en charge :</span><span class="sxs-lookup"><span data-stu-id="87c91-181">These algorithm values are supported:</span></span>

<dl> <span data-ttu-id="87c91-182">0x8004 – SHA1</span><span class="sxs-lookup"><span data-stu-id="87c91-182">0x8004 – SHA1</span></span>  
<span data-ttu-id="87c91-183">0x800c – SHA256</span><span class="sxs-lookup"><span data-stu-id="87c91-183">0x800c – SHA256</span></span>  
<span data-ttu-id="87c91-184">0X800d – SHA384</span><span class="sxs-lookup"><span data-stu-id="87c91-184">0X800d – SHA384</span></span>  
<span data-ttu-id="87c91-185">0x800e – SHA512</span><span class="sxs-lookup"><span data-stu-id="87c91-185">0x800e – SHA512</span></span>  
</dl>

<span data-ttu-id="87c91-186">N’oubliez pas d’inclure la valeur de l’algorithme (comme indiqué ci-dessus) et non pas le nom réel de l’algorithme.</span><span class="sxs-lookup"><span data-stu-id="87c91-186">Remember to include the value of the algorithm (as shown above) and not the actual name of the algorithm.</span></span> <span data-ttu-id="87c91-187">Par exemple, si le certificat est basé sur l’algorithme SHA256, incluez 0x800c dans la section des ressources.</span><span class="sxs-lookup"><span data-stu-id="87c91-187">For example, if the cert is based on the SHA256 algorithm, include 0x800c in the resource section.</span></span>

### <a name="eku"></a><span data-ttu-id="87c91-188">EKU</span><span class="sxs-lookup"><span data-stu-id="87c91-188">EKU</span></span>

<span data-ttu-id="87c91-189">L’objet EKU représente une propriété unique de l’utilisation de la clé étendue (EKU) d’un certificat.</span><span class="sxs-lookup"><span data-stu-id="87c91-189">The EKU object represents a single extended key usage (EKU) property of a certificate.</span></span> <span data-ttu-id="87c91-190">Cette valeur est facultative et « \\ 0 » doit être spécifié si aucune EKU n’est associée au certificat. Dans le cas où plusieurs produits et services d’un même fournisseur de logiciels anti-programme malveillant s’exécutent sur le même système, le fournisseur de logiciels malveillants peut utiliser la propriété EKU du certificat d’autorité de certification privé pour différencier un service d’un autre.</span><span class="sxs-lookup"><span data-stu-id="87c91-190">This is optional and “\\0” should be specified if no EKUs are associated with the cert. In a case where there are multiple products and services from a single anti-malware vendor running on the same system, the anti-malware vendor can use the EKU property of the private CA certificate to differentiate one service from another.</span></span> <span data-ttu-id="87c91-191">Par exemple, si deux services s’exécutent sur le système à partir du même fournisseur de logiciels anti-programme malveillant et sont signés par la même autorité de certification, le service qui doit être lancé comme protégé peut être signé avec un certificat émis par l’autorité de certification qui contient une EKU spéciale.</span><span class="sxs-lookup"><span data-stu-id="87c91-191">For example, if there are two services running on the system from the same anti-malware vendor and signed by the same CA, the service that needs to be launched as protected can be signed with a cert issued by CA that contains a special EKU.</span></span> <span data-ttu-id="87c91-192">Cette EKU doit être ajoutée à la section des ressources.</span><span class="sxs-lookup"><span data-stu-id="87c91-192">This EKU must be added to the resource section.</span></span> <span data-ttu-id="87c91-193">L’utilisation améliorée de la EKU est ensuite enregistrée par le système et associée au hachage de certificat pour la validation et le lancement du service comme protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-193">The EKU is then registered by the system and paired with the certificate hash for validating and launching the service as protected.</span></span>

<span data-ttu-id="87c91-194">Notez que la chaîne de certificats doit inclure l’utilisation améliorée de la signature de code (1.3.6.1.5.5.7.3.3), mais cette EKU ne doit pas être incluse dans la section de la ressource du pilote ELAM.</span><span class="sxs-lookup"><span data-stu-id="87c91-194">Note that the certificate chain must include the Code Signing EKU (1.3.6.1.5.5.7.3.3), but this EKU must not be included in the resource section of the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="87c91-195">Si les informations de l’EKU sont incluses dans les informations de certificat pour le pilote ELAM, la même EKU doit être utilisée lors de la signature de vos fichiers binaires.</span><span class="sxs-lookup"><span data-stu-id="87c91-195">If EKU information is included in certificate information for the ELAM driver, then the same EKU must be used when signing your binaries.</span></span>

 

### <a name="count"></a><span data-ttu-id="87c91-196">Count</span><span class="sxs-lookup"><span data-stu-id="87c91-196">Count</span></span>

<span data-ttu-id="87c91-197">Si le fichier binaire du service anti-programme malveillant est signé avec le certificat Authenticode et le certificat d’autorité de certification privé, seules les informations de certificat de l’autorité de certification privée doivent être ajoutées à la section des ressources.</span><span class="sxs-lookup"><span data-stu-id="87c91-197">If the anti-malware service binary is signed with the Authenticode certificate as well as the private CA certificate, only the private CA certificate information must be added in the resource section.</span></span>

## <a name="launching-anti-malware-services-as-protected"></a><span data-ttu-id="87c91-198">Lancement des services anti-programmes malveillants comme protégés</span><span class="sxs-lookup"><span data-stu-id="87c91-198">Launching anti-malware services as protected</span></span>

### <a name="registering-the-service"></a><span data-ttu-id="87c91-199">Inscription du service</span><span class="sxs-lookup"><span data-stu-id="87c91-199">Registering the service</span></span>

<span data-ttu-id="87c91-200">Le service anti-programme malveillant doit être inscrit auprès du système avant de pouvoir être démarré comme protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-200">The anti-malware service must be registered with the system before it can be started as protected.</span></span> <span data-ttu-id="87c91-201">Pendant l’installation du logiciel anti-programme malveillant, le programme d’installation peut installer le pilote ELAM et redémarrer le système pour inscrire automatiquement le service.</span><span class="sxs-lookup"><span data-stu-id="87c91-201">During the installation of the anti-malware software, the installer can install the ELAM driver and reboot the system to automatically register the service.</span></span> <span data-ttu-id="87c91-202">Le système inscrira le service au moment du démarrage en extrayant les informations de certificat à partir du fichier de ressources susmentionné qui est lié au pilote ELAM.</span><span class="sxs-lookup"><span data-stu-id="87c91-202">The system will register the service at boot time by extracting the certificate information from the aforementioned resource file that is linked into the ELAM driver.</span></span>

<span data-ttu-id="87c91-203">Pendant la phase d’installation, il est vivement recommandé de redémarrer le système pour que le pilote ELAM puisse être chargé et valider l’état du système.</span><span class="sxs-lookup"><span data-stu-id="87c91-203">During the installation phase, it is highly recommended that the system is restarted in order for the ELAM driver to get loaded and validate the state of the system.</span></span> <span data-ttu-id="87c91-204">Toutefois, dans les cas où un redémarrage doit être évité, Windows expose également un mécanisme pour que le programme d’installation anti-programme malveillant enregistre le service comme protégé à l’aide d’une API.</span><span class="sxs-lookup"><span data-stu-id="87c91-204">However, for cases where a reboot must be avoided, Windows also exposes a mechanism for the anti-malware installer to register the service as protected using an API.</span></span>

### <a name="registering-the-service-without-rebooting-the-system"></a><span data-ttu-id="87c91-205">Inscription du service sans redémarrage du système</span><span class="sxs-lookup"><span data-stu-id="87c91-205">Registering the service without rebooting the system</span></span>

<span data-ttu-id="87c91-206">Pendant l’installation, un programme d’installation de logiciel anti-programme malveillant peut appeler l’API [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) et fournir un handle au fichier de pilote Elam.</span><span class="sxs-lookup"><span data-stu-id="87c91-206">During the installation, an anti-malware software installer can call the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API and provide a handle to the ELAM driver file.</span></span> <span data-ttu-id="87c91-207">Le système ouvre le pilote ELAM, appelle des routines internes pour s’assurer que le pilote ELAM est correctement signé et extrait les informations de certificat de la section de la ressource associée au pilote ELAM.</span><span class="sxs-lookup"><span data-stu-id="87c91-207">The system opens the ELAM driver, calls internal routines to make sure the ELAM driver is signed properly, and extracts the certificate information from the resource section associated with the ELAM driver.</span></span> <span data-ttu-id="87c91-208">Pour la syntaxe de fonction, consultez [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span><span class="sxs-lookup"><span data-stu-id="87c91-208">For function syntax see [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span></span>

<span data-ttu-id="87c91-209">Exemple de code :</span><span class="sxs-lookup"><span data-stu-id="87c91-209">Code example:</span></span>


```C++
HANDLE FileHandle = NULL;

FileHandle = CreateFile(<Insert Elam driver file name>,
                        FILE_READ_DATA,
                        FILE_SHARE_READ,
                        NULL,
                        OPEN_EXISTING,
                        FILE_ATTRIBUTE_NORMAL,
                        NULL
                        );

if (InstallElamCertificateInfo(FileHandle) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



### <a name="starting-the-service-as-protected"></a><span data-ttu-id="87c91-210">Démarrage du service comme protégé</span><span class="sxs-lookup"><span data-stu-id="87c91-210">Starting the service as protected</span></span>

<span data-ttu-id="87c91-211">Le programme d’installation peut effectuer les étapes suivantes pour créer, configurer et démarrer le service comme protégé :</span><span class="sxs-lookup"><span data-stu-id="87c91-211">The installer can follow these steps to create, configure, and start the service as protected:</span></span>

1.  <span data-ttu-id="87c91-212">Appelez l’API [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) pour créer un objet de service et l’ajouter à la base de données du gestionnaire de contrôle des services (SCM).</span><span class="sxs-lookup"><span data-stu-id="87c91-212">Call the [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) API to create a service object and add it to the service control manager (SCM) database.</span></span>
2.  <span data-ttu-id="87c91-213">Appelez l’API [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) pour définir le descripteur de sécurité de l’objet de service créé à l’étape 1.</span><span class="sxs-lookup"><span data-stu-id="87c91-213">Call the [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) API to set the security descriptor of the service object created in step 1.</span></span>
3.  <span data-ttu-id="87c91-214">Appelez l’API [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) pour marquer le service comme protégé, en spécifiant la nouvelle valeur d’énumération protégée du lancement de la **configuration de service \_ \_ \_** , qui a été ajoutée à Winsvc. h (à partir de Windows 8.1).</span><span class="sxs-lookup"><span data-stu-id="87c91-214">Call the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API to mark the service as protected, specifying the new **SERVICE\_CONFIG\_LAUNCH\_PROTECTED** enumeration value, which has been added in Winsvc.h (as of Windows 8.1).</span></span>

    <span data-ttu-id="87c91-215">Exemple de code :</span><span class="sxs-lookup"><span data-stu-id="87c91-215">Code example:</span></span>

    ```C++
    SERVICE_LAUNCH_PROTECTED_INFO Info;
    SC_HANDLE hService;

    Info.dwLaunchProtected = SERVICE_LAUNCH_PROTECTED_ANTIMALWARE_LIGHT;

    hService = CreateService (/* ... */);

    if (ChangeServiceConfig2(hService,
                             SERVICE_CONFIG_LAUNCH_PROTECTED,
                             &Info) == FALSE)
    {
        Result = GetLastError();
    }
    ```

    

4.  <span data-ttu-id="87c91-216">Appelez l’API [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) pour démarrer le service.</span><span class="sxs-lookup"><span data-stu-id="87c91-216">Call the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) API to start the service.</span></span> <span data-ttu-id="87c91-217">Lors du démarrage du service comme protégé, SCM vérifie le sous-système d’intégrité du code pour valider les informations du certificat.</span><span class="sxs-lookup"><span data-stu-id="87c91-217">When starting the service as protected, SCM checks with Code Integrity (CI) subsystem to validate the certificate information.</span></span> <span data-ttu-id="87c91-218">Une fois les informations de certificat validées par l’élément de configuration, le SCM lance le service comme étant protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-218">After the certificate information is validated by CI, SCM launches the service as protected.</span></span>
    1.  <span data-ttu-id="87c91-219">Notez que cette étape échoue si vous n’avez pas inscrit le service en appelant l’API [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) .</span><span class="sxs-lookup"><span data-stu-id="87c91-219">Note that this step fails if you haven’t registered the service by calling the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API.</span></span>
    2.  <span data-ttu-id="87c91-220">Si le service a été configuré pour démarrer automatiquement au cours de la phase de démarrage du système, vous pouvez éviter cette étape et simplement redémarrer le système.</span><span class="sxs-lookup"><span data-stu-id="87c91-220">If the service has been configured to start automatically during the system startup phase, you can avoid this step and simply reboot the system.</span></span> <span data-ttu-id="87c91-221">Au cours d’un redémarrage, le système inscrit automatiquement le service (si le pilote ELAM démarre correctement) et démarre le service en mode protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-221">During a reboot, the system automatically registers the service (if the ELAM driver starts successfully) and starts the service in protected mode.</span></span>

### <a name="launching-a-child-process-as-protected"></a><span data-ttu-id="87c91-222">Lancement d’un processus enfant protégé</span><span class="sxs-lookup"><span data-stu-id="87c91-222">Launching a child process as protected</span></span>

<span data-ttu-id="87c91-223">Le nouveau modèle de sécurité permet également aux services protégés contre les programmes malveillants de lancer des processus enfants comme étant protégés.</span><span class="sxs-lookup"><span data-stu-id="87c91-223">The new security model also allows the anti-malware protected services to launch child processes as protected.</span></span> <span data-ttu-id="87c91-224">Ces processus enfants seront exécutés au même niveau de protection que le service parent et leurs fichiers binaires doivent être signés avec le même certificat que celui qui a été inscrit via la section de ressource ELAM.</span><span class="sxs-lookup"><span data-stu-id="87c91-224">These child processes will run at the same protection level as the parent service and their binaries must be signed with the same certificate that has been registered via ELAM resource section.</span></span>

<span data-ttu-id="87c91-225">Afin d’autoriser le service protégé contre les programmes malveillants à lancer le processus enfant comme protégé, une nouvelle clé d’attribut étendu, **niveau de protection d' \_ \_ attribut Proc \_ \_ thread**, a été exposée et doit être utilisée avec l’API [**UpdateProcThreadAttribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) .</span><span class="sxs-lookup"><span data-stu-id="87c91-225">In order to allow anti-malware protected service to launch child process as protected, a new extended attribute key, **PROC\_THREAD\_ATTRIBUTE\_PROTECTION\_LEVEL**, has been exposed and must be used with the [**UpdateProcThreadAttribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) API.</span></span> <span data-ttu-id="87c91-226">Un pointeur vers la valeur d’attribut **de \_ niveau \_ de protection** doit être passé à l’API **UpdateProcThreadAttribute** .</span><span class="sxs-lookup"><span data-stu-id="87c91-226">A pointer to the attribute value of **PROTECTION\_LEVEL\_SAME** must be passed into the **UpdateProcThreadAttribute** API.</span></span>

<span data-ttu-id="87c91-227">Remarques :</span><span class="sxs-lookup"><span data-stu-id="87c91-227">Notes:</span></span>

-   <span data-ttu-id="87c91-228">Pour pouvoir utiliser ce nouvel attribut, le service doit également spécifier l' **opération créer un \_ \_ processus protégé** dans le paramètre indicateurs de création de processus de l’appel [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) .</span><span class="sxs-lookup"><span data-stu-id="87c91-228">In order to use this new attribute, the service must also specify **CREATE\_PROTECTED\_PROCESS** in the process creation flags parameter of the [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) call.</span></span>
-   <span data-ttu-id="87c91-229">Vous devez avoir vos fichiers binaires de service signés à l’aide du commutateur/AC pour inclure le certificat croisé pour le lier à une autorité de certification connue.</span><span class="sxs-lookup"><span data-stu-id="87c91-229">You need to have your service binaries signed using the /ac switch to include the cross-certificate to chain it up to a known CA.</span></span> <span data-ttu-id="87c91-230">Le certificat auto-signé sans chaînage correct à une autorité de certification racine connue ne fonctionnera pas.</span><span class="sxs-lookup"><span data-stu-id="87c91-230">Self-signed cert without proper chaining to a known root CA will not work.</span></span>

<span data-ttu-id="87c91-231">Exemple de code :</span><span class="sxs-lookup"><span data-stu-id="87c91-231">Code example:</span></span>


```C++
DWORD ProtectionLevel = PROTECTION_LEVEL_SAME;
SIZE_T AttributeListSize;

STARTUPINFOEXW StartupInfoEx = { 0 };

StartupInfoEx.StartupInfo.cb = sizeof(StartupInfoEx);

if (InitializeProcThreadAttributeList(NULL,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

StartupInfoEx.lpAttributeList = (LPPROC_THREAD_ATTRIBUTE_LIST) HeapAlloc(
    GetProcessHeap(),
    0,
    AttributeListSize
    );

if (InitializeProcThreadAttributeList(StartupInfoEx.lpAttributeList,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

if (UpdateProcThreadAttribute(StartupInfoEx.lpAttributeList,
                              0,
                              PROC_THREAD_ATTRIBUTE_PROTECTION_LEVEL,
                              &ProtectionLevel,
                              sizeof(ProtectionLevel),
                              NULL,
                              NULL) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

PROCESS_INFORMATION ProcessInformation = { 0 };

if (CreateProcessW(ApplicationName,
                   CommandLine,
                   ProcessAttributes,
                   ThreadAttributes,
                   InheritHandles,
                   EXTENDED_STARTUPINFO_PRESENT | CREATE_PROTECTED_PROCESS,
                   Environment,
                   CurrentDirectory,
                   (LPSTARTUPINFOW)&StartupInfoEx,
                   &ProcessInformation) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



## <a name="updates-and-servicing"></a><span data-ttu-id="87c91-232">Mises à jour et maintenance</span><span class="sxs-lookup"><span data-stu-id="87c91-232">Updates and servicing</span></span>

<span data-ttu-id="87c91-233">Une fois que le service anti-programme malveillant est lancé comme protégé, les autres processus non protégés (et même les administrateurs) ne peuvent pas arrêter le service.</span><span class="sxs-lookup"><span data-stu-id="87c91-233">After the anti-malware service is launched as protected, other non-protected processes (and even admins) aren't able to stop the service.</span></span> <span data-ttu-id="87c91-234">Dans le cas des mises à jour des binaires de service, le service anti-programme malveillant doit recevoir un rappel du programme d’installation pour s’arrêter afin de pouvoir être pris en compte.</span><span class="sxs-lookup"><span data-stu-id="87c91-234">In the case of updates to the service binaries, the anti-malware service needs to receive a callback from the installer to stop itself so that it can be serviced.</span></span> <span data-ttu-id="87c91-235">Une fois le service arrêté, le programme d’installation du logiciel anti-programme malveillant peut effectuer des mises à niveau, puis suivre les étapes décrites ci-dessus dans les sections [inscription du service](https://www.bing.com/search?q=Registering+the+service) et [démarrage du service en tant que protégé](#starting-the-service-as-protected) pour inscrire le certificat et démarrer le service comme protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-235">After the service is stopped, the anti-malware installer can perform upgrades and then follow the steps described above in the [Registering the service](https://www.bing.com/search?q=Registering+the+service) and [Starting the service as protected](#starting-the-service-as-protected) sections to register the certificate and start the service as protected.</span></span>

<span data-ttu-id="87c91-236">Notez que le service doit s’assurer que seuls les appelants approuvés peuvent arrêter le service.</span><span class="sxs-lookup"><span data-stu-id="87c91-236">Note that the service should ensure that only trusted callers can stop the service.</span></span> <span data-ttu-id="87c91-237">Autoriser des appelants non fiables à le faire permet de s’adapter à la protection du service.</span><span class="sxs-lookup"><span data-stu-id="87c91-237">Allowing untrusted callers to do so defeats the purpose of protecting the service.</span></span>

### <a name="unregistering-the-service"></a><span data-ttu-id="87c91-238">Annulation de l’inscription du service</span><span class="sxs-lookup"><span data-stu-id="87c91-238">Unregistering the service</span></span>

<span data-ttu-id="87c91-239">Lorsque vous désinstallez un service protégé, le service doit se marquer comme non protégé en appelant l’API [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) .</span><span class="sxs-lookup"><span data-stu-id="87c91-239">When you uninstall a protected service, the service must mark itself as unprotected by calling the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API.</span></span> <span data-ttu-id="87c91-240">Notez que, étant donné que le système ne permet pas à un processus non protégé de modifier la configuration d’un service protégé, l’appel à [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) doit être effectué par le service protégé lui-même.</span><span class="sxs-lookup"><span data-stu-id="87c91-240">Note that because the system doesn't allow any non-protected process to alter the configuration of a protected service, the call to [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) must be made by the protected service itself.</span></span> <span data-ttu-id="87c91-241">Une fois que le service a été reconfiguré pour s’exécuter en tant que non protégé, le programme de désinstallation peut simplement prendre les mesures appropriées pour supprimer le logiciel anti-programme malveillant du système.</span><span class="sxs-lookup"><span data-stu-id="87c91-241">After the service has been reconfigured to run as unprotected, the uninstaller can simply take appropriate steps to remove the anti-malware software from the system.</span></span>

## <a name="debugging-an-anti-malware-protected-service"></a><span data-ttu-id="87c91-242">Débogage d’un service protégé contre les programmes malveillants</span><span class="sxs-lookup"><span data-stu-id="87c91-242">Debugging an anti-malware protected service</span></span>

<span data-ttu-id="87c91-243">Dans le cadre du modèle de sécurité de processus protégé, les autres processus non protégés ne sont pas en mesure d’injecter des threads ou d’écrire dans la mémoire virtuelle du processus protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-243">As part of the protected process security model, other non-protected processes aren't able to inject threads or write into the virtual memory of the protected process.</span></span> <span data-ttu-id="87c91-244">Toutefois, un débogueur de noyau (KD) est autorisé pour déboguer les processus protégés contre les programmes malveillants.</span><span class="sxs-lookup"><span data-stu-id="87c91-244">However a kernel debugger (KD) is allowed for debugging any anti-malware protected processes.</span></span> <span data-ttu-id="87c91-245">Le KD peut également être utilisé pour vérifier si le service anti-programme malveillant s’exécute comme protégé ou non :</span><span class="sxs-lookup"><span data-stu-id="87c91-245">The KD can also be used to check if the anti-malware service is running as protected or not:</span></span>

``` syntax
dt –r1 nt!_EPROCESS <Process Address>
+0x67a Protection       : _PS_PROTECTION
      +0x000 Level            : 0x31 '1'
      +0x000 Type             : 0y0001
      +0x000 Signer           : 0y0011
```

<span data-ttu-id="87c91-246">Si la valeur du membre de *type* est 0y0001, le service s’exécute comme protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-246">If the value of the *Type* member is 0y0001, the service is running as protected.</span></span>

<span data-ttu-id="87c91-247">En outre, seules les commandes SC suivantes sont autorisées sur le service protégé contre les programmes malveillants :</span><span class="sxs-lookup"><span data-stu-id="87c91-247">In addition, only the following SC commands are allowed on anti-malware protected service:</span></span>

-   `sc config start=Auto`
-   `sc qc`
-   `sc start`
-   `sc interrogate`
-   `sc sdshow`

<span data-ttu-id="87c91-248">Si le débogueur est attaché, utilisez l’indicateur suivant dans le registre pour s’arrêter dans le débogueur lorsque des fichiers binaires non signés (ou signés de manière inappropriée) sont chargés dans le service protégé contre les programmes malveillants.</span><span class="sxs-lookup"><span data-stu-id="87c91-248">If the debugger is attached, use the following flag in the registry to break in the debugger when unsigned (or inappropriately signed) binaries are loaded into the anti-malware protected service.</span></span>

``` syntax
Key:   HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CI
Value: DebugFlags      REG_DWORD
```

<span data-ttu-id="87c91-249">Définissez la valeur sur **00000400** pour arrêter le débogueur en cas d’échec de la validation de la signature.</span><span class="sxs-lookup"><span data-stu-id="87c91-249">Set the value to **00000400** to break in the debugger when the signature validation fails.</span></span>

> [!Note]  
> <span data-ttu-id="87c91-250">Limitations des processus protégés :</span><span class="sxs-lookup"><span data-stu-id="87c91-250">Protected Process limitations:</span></span>
>
> 1.  <span data-ttu-id="87c91-251">Les processus qui ont une interface utilisateur ou une interface utilisateur graphique ne peuvent pas être protégés en raison de la façon dont le noyau verrouille un processus en mémoire et ne permet pas d’y écrire des écritures.</span><span class="sxs-lookup"><span data-stu-id="87c91-251">Processes that have UI or a GUI cannot be protected because of the way the kernel locks a process in memory and does not allow writes to it.</span></span>
> 2.  <span data-ttu-id="87c91-252">Avant Windows 10, version 1703 (créateurs Update), les processus protégés ne peuvent pas utiliser les protocoles de communication TLS ou SSL en raison des limitations du partage de certificats entre l’autorité de sécurité locale (LSA) et un processus protégé.</span><span class="sxs-lookup"><span data-stu-id="87c91-252">Prior to Windows 10, version 1703 (the Creators update), protected processes cannot use the TLS or SSL communication protocols due to limitations of certificate sharing between the Local Security Authority (LSA) and a protected process.</span></span>

 

## <a name="resources"></a><span data-ttu-id="87c91-253">Ressources</span><span class="sxs-lookup"><span data-stu-id="87c91-253">Resources</span></span>

<span data-ttu-id="87c91-254">Pour plus d’informations, voir :</span><span class="sxs-lookup"><span data-stu-id="87c91-254">For more info, see:</span></span>

-   [<span data-ttu-id="87c91-255">Logiciel anti-programme malveillant à lancement anticipé (ELAM)</span><span class="sxs-lookup"><span data-stu-id="87c91-255">Early launch antimalware</span></span>](/windows/desktop/w8cookbook/secured-boot)
-   <span data-ttu-id="87c91-256">[Processus protégés dans Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="87c91-256">[Protected Processes in Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span></span>
-   <span data-ttu-id="87c91-257">[Configuration d’une autorité de certification](/previous-versions/windows/desktop/ms755466(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="87c91-257">[Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85))</span></span>
-   <span data-ttu-id="87c91-258">[Installer l’autorité de certification](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span><span class="sxs-lookup"><span data-stu-id="87c91-258">[Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span></span>
-   [<span data-ttu-id="87c91-259">Ressource définie par l’utilisateur</span><span class="sxs-lookup"><span data-stu-id="87c91-259">User-Defined Resource</span></span>](/windows/desktop/menurc/user-defined-resource)

<span data-ttu-id="87c91-260">Ces fonctions de l’API Windows sont référencées dans cet article :</span><span class="sxs-lookup"><span data-stu-id="87c91-260">These Windows API functions are referenced in this article:</span></span>

-   [<span data-ttu-id="87c91-261">**ChangeServiceConfig2**</span><span class="sxs-lookup"><span data-stu-id="87c91-261">**ChangeServiceConfig2**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a)
-   [<span data-ttu-id="87c91-262">**CreateProcess**</span><span class="sxs-lookup"><span data-stu-id="87c91-262">**CreateProcess**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa)
-   [<span data-ttu-id="87c91-263">**CreateService**</span><span class="sxs-lookup"><span data-stu-id="87c91-263">**CreateService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-createservicea)
-   [<span data-ttu-id="87c91-264">**InitializeProcThreadAttributeList**</span><span class="sxs-lookup"><span data-stu-id="87c91-264">**InitializeProcThreadAttributeList**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-initializeprocthreadattributelist)
-   [<span data-ttu-id="87c91-265">**InstallELAMCertificateInfo**</span><span class="sxs-lookup"><span data-stu-id="87c91-265">**InstallELAMCertificateInfo**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo)
-   [<span data-ttu-id="87c91-266">**SetServiceObjectSecurity**</span><span class="sxs-lookup"><span data-stu-id="87c91-266">**SetServiceObjectSecurity**</span></span>](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity)
-   [<span data-ttu-id="87c91-267">**StartService**</span><span class="sxs-lookup"><span data-stu-id="87c91-267">**StartService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-startservicea)
-   [<span data-ttu-id="87c91-268">**UpdateProcThreadAttribute**</span><span class="sxs-lookup"><span data-stu-id="87c91-268">**UpdateProcThreadAttribute**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute)

 

 
