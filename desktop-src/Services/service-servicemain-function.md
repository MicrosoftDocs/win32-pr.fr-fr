---
description: Lorsqu’un programme de contrôle de service demande l’exécution d’un nouveau service, le gestionnaire de contrôle des services (SCM) démarre le service et envoie une demande de démarrage au répartiteur de contrôle.
ms.assetid: e55e056f-7628-4e3d-9aea-b55c371b4287
title: Fonction de service ServiceMain
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ed50f0f378f348415e56827a09fcf17eea7fc330
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "103952879"
---
# <a name="service-servicemain-function"></a><span data-ttu-id="75790-103">Fonction de service ServiceMain</span><span class="sxs-lookup"><span data-stu-id="75790-103">Service ServiceMain Function</span></span>

<span data-ttu-id="75790-104">Lorsqu’un programme de contrôle de service demande l’exécution d’un nouveau service, le gestionnaire de contrôle des services (SCM) démarre le service et envoie une demande de démarrage au répartiteur de contrôle.</span><span class="sxs-lookup"><span data-stu-id="75790-104">When a service control program requests that a new service run, the Service Control Manager (SCM) starts the service and sends a start request to the control dispatcher.</span></span> <span data-ttu-id="75790-105">Le répartiteur de contrôle crée un nouveau thread pour exécuter la fonction [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) pour le service.</span><span class="sxs-lookup"><span data-stu-id="75790-105">The control dispatcher creates a new thread to execute the [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function for the service.</span></span> <span data-ttu-id="75790-106">Pour obtenir un exemple, consultez [écriture d’une fonction ServiceMain](writing-a-servicemain-function.md).</span><span class="sxs-lookup"><span data-stu-id="75790-106">For an example, see [Writing a ServiceMain Function](writing-a-servicemain-function.md).</span></span>

<span data-ttu-id="75790-107">La fonction [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) doit effectuer les tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="75790-107">The [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function should perform the following tasks:</span></span>

1.  <span data-ttu-id="75790-108">Initialiser toutes les variables globales.</span><span class="sxs-lookup"><span data-stu-id="75790-108">Initialize all global variables.</span></span>
2.  <span data-ttu-id="75790-109">Appelez la fonction [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) immédiatement pour inscrire une fonction de [**Gestionnaire**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) afin de gérer les demandes de contrôle pour le service.</span><span class="sxs-lookup"><span data-stu-id="75790-109">Call the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) function immediately to register a [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function to handle control requests for the service.</span></span> <span data-ttu-id="75790-110">La valeur de retour de **RegisterServiceCtrlHandler** est un *handle d’état de service* qui sera utilisé dans les appels pour notifier le SCM de l’état du service.</span><span class="sxs-lookup"><span data-stu-id="75790-110">The return value of **RegisterServiceCtrlHandler** is a *service status handle* that will be used in calls to notify the SCM of the service status.</span></span>
3.  <span data-ttu-id="75790-111">Effectuez l’initialisation.</span><span class="sxs-lookup"><span data-stu-id="75790-111">Perform initialization.</span></span> <span data-ttu-id="75790-112">Si la durée d’exécution du code d’initialisation est supposée être très brève (moins d’une seconde), l’initialisation peut être effectuée directement dans [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).</span><span class="sxs-lookup"><span data-stu-id="75790-112">If the execution time of the initialization code is expected to be very short (less than one second), initialization can be performed directly in [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).</span></span>

    <span data-ttu-id="75790-113">Si la durée d’initialisation est supposée être supérieure à une seconde, le service doit utiliser l’une des techniques d’initialisation suivantes :</span><span class="sxs-lookup"><span data-stu-id="75790-113">If the initialization time is expected to be longer than one second, the service should use one of the following initialization techniques:</span></span>

    -   <span data-ttu-id="75790-114">Appelez la fonction [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) pour signaler l' \_ exécution du service, mais n’acceptez aucun contrôle tant que l’initialisation n’est pas terminée.</span><span class="sxs-lookup"><span data-stu-id="75790-114">Call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report SERVICE\_RUNNING but accept no controls until initialization is finished.</span></span> <span data-ttu-id="75790-115">Pour ce faire, le service appelle **SetServiceStatus** avec **DWCURRENTSTATE** défini sur service \_ Running et **dwControlsAccepted** défini sur 0 dans la structure d' [**\_ État du service**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="75790-115">The service does this by calling **SetServiceStatus** with **dwCurrentState** set to SERVICE\_RUNNING and **dwControlsAccepted** set to 0 in the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="75790-116">Cela garantit que le SCM n’enverra pas de demandes de contrôle au service avant qu’il ne soit prêt et libère le SCM pour gérer d’autres services.</span><span class="sxs-lookup"><span data-stu-id="75790-116">This ensures that the SCM will not send any control requests to the service before it is ready and frees the SCM to manage other services.</span></span> <span data-ttu-id="75790-117">Cette approche de l’initialisation est recommandée pour les performances, en particulier pour les services de démarrage automatique.</span><span class="sxs-lookup"><span data-stu-id="75790-117">This approach to initialization is recommended for performance, especially for autostart services.</span></span>
    -   <span data-ttu-id="75790-118">Démarrage du \_ service \_ de rapport en attente, aucun contrôle n’est accepté et spécifiez un indicateur d’attente.</span><span class="sxs-lookup"><span data-stu-id="75790-118">Report SERVICE\_START\_PENDING, accept no controls, and specify a wait hint.</span></span> <span data-ttu-id="75790-119">Si le code d’initialisation de votre service exécute des tâches qui sont censées durer plus longtemps que la valeur de l’indicateur d’attente initial, votre code doit appeler la fonction [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) régulièrement (éventuellement avec un indicateur d’attente révisé) pour indiquer que la progression est en cours.</span><span class="sxs-lookup"><span data-stu-id="75790-119">If your service's initialization code performs tasks that are expected to take longer than the initial wait hint value, your code must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function periodically (possibly with a revised wait hint) to indicate that progress is being made.</span></span> <span data-ttu-id="75790-120">Veillez à appeler **SetServiceStatus** uniquement si l’initialisation progresse.</span><span class="sxs-lookup"><span data-stu-id="75790-120">Be sure to call **SetServiceStatus** only if the initialization is making progress.</span></span> <span data-ttu-id="75790-121">Dans le cas contraire, le SCM peut attendre que votre service passe à l’état d’exécution du SERVICE en \_ supposant que votre service progresse et bloque le démarrage d’autres services.</span><span class="sxs-lookup"><span data-stu-id="75790-121">Otherwise the SCM can wait for your service to enter the SERVICE\_RUNNING state assuming that your service is making progress and block other services from starting.</span></span> <span data-ttu-id="75790-122">N’appelez pas **SetServiceStatus** à partir d’un thread séparé, sauf si vous êtes sûr que le thread effectuant l’initialisation est réellement en cours de réalisation.</span><span class="sxs-lookup"><span data-stu-id="75790-122">Do not call **SetServiceStatus** from a separate thread unless you are sure the thread performing the initialization is truly making progress.</span></span>

        <span data-ttu-id="75790-123">Un service qui utilise cette approche peut également spécifier une valeur de point d’enregistrement et incrémenter la valeur périodiquement au cours d’une initialisation longue.</span><span class="sxs-lookup"><span data-stu-id="75790-123">A service that uses this approach can also specify a check-point value and increment the value periodically during a lengthy initialization.</span></span> <span data-ttu-id="75790-124">Le programme qui a démarré le service peut appeler [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) ou [**QueryServiceStatusEx**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) pour obtenir la dernière valeur de point d’enregistrement auprès du SCM et utiliser la valeur pour signaler la progression incrémentielle à l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="75790-124">The program that started the service can call [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) or [**QueryServiceStatusEx**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) to obtain the latest check-point value from the SCM and use the value to report incremental progress to the user.</span></span>

4.  <span data-ttu-id="75790-125">Une fois l’initialisation terminée, appelez [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) pour définir l’état du SERVICE sur service \_ Running et spécifiez les contrôles que le service est prêt à accepter.</span><span class="sxs-lookup"><span data-stu-id="75790-125">When initialization is complete, call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_RUNNING and specify the controls that the service is prepared to accept.</span></span> <span data-ttu-id="75790-126">Pour obtenir la liste des contrôles, consultez la structure de l' [**\_ État du service**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) .</span><span class="sxs-lookup"><span data-stu-id="75790-126">For a list of controls, see the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span>
5.  <span data-ttu-id="75790-127">Effectuez les tâches du service ou, si aucune tâche n’est en attente, retournez le contrôle à l’appelant.</span><span class="sxs-lookup"><span data-stu-id="75790-127">Perform the service tasks, or, if there are no pending tasks, return control to the caller.</span></span> <span data-ttu-id="75790-128">Toute modification de l’état du service justifie un appel à [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) pour signaler de nouvelles informations d’État.</span><span class="sxs-lookup"><span data-stu-id="75790-128">Any change in the service state warrants a call to [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to report new status information.</span></span>
6.  <span data-ttu-id="75790-129">Si une erreur se produit pendant que le service est en cours d’initialisation ou en cours d’exécution, le service doit appeler [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) pour définir l’état du service sur l’arrêt du service \_ \_ en attente si le nettoyage est long.</span><span class="sxs-lookup"><span data-stu-id="75790-129">If an error occurs while the service is initializing or running, the service should call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_STOP\_PENDING if cleanup will be lengthy.</span></span> <span data-ttu-id="75790-130">Une fois le nettoyage terminé, appelez **SetServiceStatus** pour définir l’état du SERVICE sur service \_ arrêté à partir du dernier thread à terminer.</span><span class="sxs-lookup"><span data-stu-id="75790-130">After cleanup is complete, call **SetServiceStatus** to set the service state to SERVICE\_STOPPED from the last thread to terminate.</span></span> <span data-ttu-id="75790-131">Veillez à définir les membres **dwServiceSpecificExitCode** et **dwWin32ExitCode** de la structure d' [**\_ État du service**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) pour identifier l’erreur.</span><span class="sxs-lookup"><span data-stu-id="75790-131">Be sure to set the **dwServiceSpecificExitCode** and **dwWin32ExitCode** members of the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure to identify the error.</span></span>

## <a name="related-topics"></a><span data-ttu-id="75790-132">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="75790-132">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="75790-133">Écriture d’une fonction ServiceMain</span><span class="sxs-lookup"><span data-stu-id="75790-133">Writing a ServiceMain Function</span></span>](writing-a-servicemain-function.md)
</dt> </dl>

 

 
