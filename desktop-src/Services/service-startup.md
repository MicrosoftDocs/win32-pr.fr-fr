---
description: Pour démarrer un service ou un service de pilote, le programme de contrôle des services utilise la fonction StartService.
ms.assetid: 7d2ee779-1554-436a-a65c-f0322745f46a
title: Démarrage du service
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 0f5fcd9ee820357e75bf07649da8e6c5445d3f42
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "106519528"
---
# <a name="service-startup"></a><span data-ttu-id="9ab6f-103">Démarrage du service</span><span class="sxs-lookup"><span data-stu-id="9ab6f-103">Service Startup</span></span>

<span data-ttu-id="9ab6f-104">Pour démarrer un service ou un service de pilote, le programme de contrôle des services utilise la fonction [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) .</span><span class="sxs-lookup"><span data-stu-id="9ab6f-104">To start a service or driver service, the service control program uses the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) function.</span></span> <span data-ttu-id="9ab6f-105">La fonction **StartService** échoue si la base de données est verrouillée.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-105">The **StartService** function fails if the database is locked.</span></span> <span data-ttu-id="9ab6f-106">Dans ce cas, le programme de contrôle des services doit attendre quelques secondes et appeler à nouveau **StartService** .</span><span class="sxs-lookup"><span data-stu-id="9ab6f-106">If this occurs, the service control program should wait a few seconds and call **StartService** again.</span></span> <span data-ttu-id="9ab6f-107">Il peut vérifier l’état de verrouillage actuel de la base de données en appelant la fonction [**QueryServiceLockStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicelockstatusa) .</span><span class="sxs-lookup"><span data-stu-id="9ab6f-107">It can check the current lock status of the database by calling the [**QueryServiceLockStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicelockstatusa) function.</span></span>

<span data-ttu-id="9ab6f-108">Si le programme de contrôle des services démarre un service, il peut utiliser la fonction [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) pour spécifier un tableau d’arguments à passer à la fonction [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) du service.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-108">If the service control program is starting a service, it can use the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) function to specify an array of arguments to be passed to the service's [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function.</span></span> <span data-ttu-id="9ab6f-109">La fonction **StartService** retourne une valeur après qu’un nouveau thread a été créé pour exécuter la fonction **ServiceMain** .</span><span class="sxs-lookup"><span data-stu-id="9ab6f-109">The **StartService** function returns after a new thread is created to execute the **ServiceMain** function.</span></span> <span data-ttu-id="9ab6f-110">Le programme de contrôle de service peut récupérer l’état du service qui vient d’être démarré dans une structure d' [**\_ État de service**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) en appelant la fonction [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) .</span><span class="sxs-lookup"><span data-stu-id="9ab6f-110">The service control program can retrieve the status of the newly started service in a [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure by calling the [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) function.</span></span> <span data-ttu-id="9ab6f-111">Pendant l’initialisation, le membre **dwCurrentState** doit être \_ en attente de démarrage de service \_ .</span><span class="sxs-lookup"><span data-stu-id="9ab6f-111">During initialization, the **dwCurrentState** member should be SERVICE\_START\_PENDING.</span></span> <span data-ttu-id="9ab6f-112">Le membre **dwWaitHint** est un intervalle de temps, en millisecondes, qui indique la durée d’attente du programme de contrôle des services avant d’appeler à nouveau **QueryServiceStatus** .</span><span class="sxs-lookup"><span data-stu-id="9ab6f-112">The **dwWaitHint** member is a time interval, in milliseconds, that indicates how long the service control program should wait before calling **QueryServiceStatus** again.</span></span> <span data-ttu-id="9ab6f-113">Une fois l’initialisation terminée, le service change **dwCurrentState** en service \_ Running.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-113">When the initialization is complete, the service changes **dwCurrentState** to SERVICE\_RUNNING.</span></span>

<span data-ttu-id="9ab6f-114">Le gestionnaire de contrôle des services ne prend pas en charge la transmission de variables d’environnement personnalisées à un service au démarrage.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-114">The service control manager does not support passing custom environment variables to a service at startup.</span></span> <span data-ttu-id="9ab6f-115">En outre, le gestionnaire de contrôle des services ne détecte pas les modifications apportées aux variables d’environnement lorsque le service est en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-115">Also, the service control manager does not detect and pass on changes to environment variables as the service is running.</span></span> <span data-ttu-id="9ab6f-116">Au lieu de rendre un service dépendant d’une variable d’environnement, utilisez des valeurs de registre ou des arguments de [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) .</span><span class="sxs-lookup"><span data-stu-id="9ab6f-116">Instead of making a service dependent on an environment variable, use registry values or [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) arguments.</span></span>

<span data-ttu-id="9ab6f-117">Voici une vue d’ensemble simplifiée de ce qui se passe quand un service standard est démarré par le gestionnaire de contrôle des services :</span><span class="sxs-lookup"><span data-stu-id="9ab6f-117">The following is a simplified overview of what happens when a typical service is started by the service control manager:</span></span>

-   <span data-ttu-id="9ab6f-118">Le SCM lit le chemin d’accès du service à partir du Registre et prépare le démarrage du service.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-118">The SCM reads the service path from the registry and prepares to start the service.</span></span> <span data-ttu-id="9ab6f-119">Cela comprend l’acquisition du verrou de service.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-119">This includes acquiring the service lock.</span></span> <span data-ttu-id="9ab6f-120">Toute tentative de démarrage d’un autre service alors que le verrou de service est maintenu est bloquée jusqu’à ce que le verrou de service soit libéré.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-120">Any attempt to start another service while the service lock is held will block until the service lock is released.</span></span>
-   <span data-ttu-id="9ab6f-121">Le SCM démarre le processus et attend que le processus enfant se termine (indiquant un échec) ou signale l’état d’exécution du SERVICE \_ .</span><span class="sxs-lookup"><span data-stu-id="9ab6f-121">The SCM starts the process and waits until either the child process exits (indicating a failure) or reports the SERVICE\_RUNNING status.</span></span>
-   <span data-ttu-id="9ab6f-122">L’application effectue son initialisation très simple et appelle la fonction [**StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) .</span><span class="sxs-lookup"><span data-stu-id="9ab6f-122">The application performs its very simple initialization and calls the [**StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) function.</span></span>
-   <span data-ttu-id="9ab6f-123">[**StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) se connecte au gestionnaire de contrôle des services et démarre un deuxième thread qui appelle la fonction [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) pour le service.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-123">[**StartServiceCtrlDispatcher**](/windows/desktop/api/Winsvc/nf-winsvc-startservicectrldispatchera) connects to the service control manager and starts a second thread that calls the [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function for the service.</span></span> <span data-ttu-id="9ab6f-124">La fonction **ServiceMain** doit signaler le service \_ s’exécuter dès que possible.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-124">**ServiceMain** should report SERVICE\_RUNNING as soon as possible.</span></span>
-   <span data-ttu-id="9ab6f-125">Quand le gestionnaire de contrôle des services est informé que le service est en cours d’exécution, il libère le verrou de service.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-125">When the service control manager is notified that the service is running, it releases the service lock.</span></span>

<span data-ttu-id="9ab6f-126">Si le service ne met pas à jour son état dans un délai de 80 secondes, plus le dernier indicateur Wait, le gestionnaire de contrôle des services détermine que le service a cessé de répondre.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-126">If service does not update its status within 80 seconds, plus the last wait hint, the service control manager determines that the service has stopped responding.</span></span> <span data-ttu-id="9ab6f-127">Le gestionnaire de contrôle des services consigne un événement et arrête le service.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-127">The service control manager will log an event and stop the service.</span></span>

<span data-ttu-id="9ab6f-128">Si le programme démarre un service de pilote, [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) retourne une valeur une fois que le pilote de périphérique a terminé son initialisation.</span><span class="sxs-lookup"><span data-stu-id="9ab6f-128">If the program is starting a driver service, [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) returns after the device driver has completed its initialization.</span></span>

<span data-ttu-id="9ab6f-129">Pour plus d’informations, consultez [démarrage d’un service](starting-a-service.md).</span><span class="sxs-lookup"><span data-stu-id="9ab6f-129">For more information, see [Starting a Service](starting-a-service.md).</span></span>

 

 
