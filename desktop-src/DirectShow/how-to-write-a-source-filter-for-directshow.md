---
description: Cette rubrique explique comment écrire un filtre source personnalisé pour DirectShow.
ms.assetid: 032f7624-2237-41cd-844a-18ed4a2e420d
title: Comment écrire un filtre source pour DirectShow
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 87af99595a43c86be0e2f4ecaa51768a211e9674
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/06/2021
ms.locfileid: "104522519"
---
# <a name="how-to-write-a-source-filter-for-directshow"></a><span data-ttu-id="8ecf4-103">Comment écrire un filtre source pour DirectShow</span><span class="sxs-lookup"><span data-stu-id="8ecf4-103">How to Write a Source Filter for DirectShow</span></span>

<span data-ttu-id="8ecf4-104">Cette rubrique explique comment écrire un filtre source personnalisé pour DirectShow.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-104">This topic describes how to write a custom source filter for DirectShow.</span></span>

> [!Note]  
> <span data-ttu-id="8ecf4-105">Cette rubrique décrit les sources Push uniquement. il ne décrit pas les sources de tirage, telles que le filtre de lecteur Async, ou les filtres de séparateur qui se connectent aux sources d’extraction.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-105">This topic describes push sources only; it does not describe pull sources, such as the Async Reader Filter, or splitter filters that connect to pull sources.</span></span> <span data-ttu-id="8ecf4-106">Pour la distinction entre les sources *Push* et *pull* , consultez [flux de données pour les développeurs de filtres](data-flow-for-filter-developers.md).</span><span class="sxs-lookup"><span data-stu-id="8ecf4-106">For the distinction between *push* and *pull* sources, see [Data Flow for Filter Developers](data-flow-for-filter-developers.md).</span></span>

 

## <a name="the-directshow-streaming-model"></a><span data-ttu-id="8ecf4-107">Modèle de diffusion en continu DirectShow</span><span class="sxs-lookup"><span data-stu-id="8ecf4-107">The DirectShow Streaming Model</span></span>

<span data-ttu-id="8ecf4-108">Lorsque vous écrivez un filtre source, il est important de comprendre qu’une source Push n’est pas la même chose qu’une source active.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-108">When you write a source filter, it is important to understand that a push source is not the same thing as a live source.</span></span> <span data-ttu-id="8ecf4-109">Une source active obtient des données à partir d’une source externe, telle qu’une caméra ou un flux réseau.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-109">A live source gets data from some external source, such as a camera or a network stream.</span></span> <span data-ttu-id="8ecf4-110">En règle générale, une source dynamique ne peut pas contrôler le taux de données entrant.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-110">Generally, a live source cannot control the incoming rate of data.</span></span> <span data-ttu-id="8ecf4-111">Si les filtres en aval ne consomment pas suffisamment de données, la source devra supprimer des échantillons.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-111">If the downstream filters do not consume the data fast enough, the source will need to drop samples.</span></span>

<span data-ttu-id="8ecf4-112">Mais il n’est pas nécessaire qu’une source Push soit une source dynamique.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-112">But a push source does not have to be a live source.</span></span> <span data-ttu-id="8ecf4-113">Par exemple, une source Push peut lire des données à partir d’un fichier local.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-113">For example, a push source can read data from a local file.</span></span> <span data-ttu-id="8ecf4-114">Dans ce cas, les filtres de convertisseur en aval déterminent la vitesse à laquelle ils consomment les données de la source, en fonction de l’horloge de référence et des horodatages de l’exemple.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-114">In that case, the downstream renderer filters determine how fast they consume the data from the source, based on the reference clock and the sample time stamps.</span></span> <span data-ttu-id="8ecf4-115">Le filtre source fournit des échantillons aussi rapidement que possible, mais le workflow réel est limité par les convertisseurs.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-115">The source filter delivers samples as quickly as possible, but the actual data flow is gated limited by the renderers.</span></span> <span data-ttu-id="8ecf4-116">Les mécanismes de déclenchement du workflow sont décrits dans la rubrique [Data Flow pour les développeurs de filtres](data-flow-for-filter-developers.md).</span><span class="sxs-lookup"><span data-stu-id="8ecf4-116">The mechanisms for gating the data flow are described in [Data Flow for Filter Developers](data-flow-for-filter-developers.md).</span></span>

<span data-ttu-id="8ecf4-117">Chaque broche de sortie sur le filtre source crée un thread appelé *thread de streaming*.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-117">Each output pin on the source filter creates a thread called a *streaming thread*.</span></span> <span data-ttu-id="8ecf4-118">Le code PIN fournit des exemples sur le thread de streaming.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-118">The pin delivers samples on the streaming thread.</span></span> <span data-ttu-id="8ecf4-119">En général, tout le décodage, le traitement et le rendu se produisent sur ce thread, bien que certains filtres en aval puissent créer des threads supplémentaires pour la mise en file d’attente de leurs exemples de sortie.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-119">Typically, all of the decoding, processing, and rendering happens on this thread, although some downstream filters might create additional threads to queue their output samples.</span></span>

<span data-ttu-id="8ecf4-120">Le thread de streaming exécute une boucle avec la structure suivante :</span><span class="sxs-lookup"><span data-stu-id="8ecf4-120">The streaming thread runs a loop with the following structure:</span></span>

``` syntax
until (stopped)
  1. Get a media sample from the allocator.
  2. Fill the sample with data.
  3. Time stamp the sample. 
  4. Deliver the sample downstream.
```

<span data-ttu-id="8ecf4-121">Si aucun échantillon n’est disponible, l’étape 1 se bloque jusqu’à ce qu’un exemple soit disponible.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-121">If no samples are available, step 1 blocks until a sample becomes available.</span></span> <span data-ttu-id="8ecf4-122">L’étape 4 peut également se bloquer ; par exemple, il peut se bloquer pendant que le graphique est suspendu.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-122">Step 4 can also block; for example, it can block while the graph is paused.</span></span>

<span data-ttu-id="8ecf4-123">La boucle s’exécute aussi rapidement que possible, mais elle est limitée par la vitesse à laquelle le filtre de convertisseur effectue le rendu de chaque échantillon.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-123">The loop runs as quickly as possible, but is limited by how quickly the renderer filter renders each sample.</span></span> <span data-ttu-id="8ecf4-124">En supposant que le graphique de filtre a une horloge de référence, le taux est déterminé par les durées de présentation des échantillons.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-124">Assuming the filter graph has a reference clock, the rate is determined by the presentation times on the samples.</span></span> <span data-ttu-id="8ecf4-125">S’il n’y a pas d’horloge de référence, le convertisseur consomme les échantillons le plus rapidement possible.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-125">If there is no reference clock, the renderer consumes samples as quickly as possible.</span></span>

## <a name="using-csource-and-csourcestream"></a><span data-ttu-id="8ecf4-126">Utilisation de CSource et CSourceStream</span><span class="sxs-lookup"><span data-stu-id="8ecf4-126">Using CSource and CSourceStream</span></span>

<span data-ttu-id="8ecf4-127">Les classes de base DirectShow incluent deux classes qui prennent en charge les sources Push : [**CSource**](csource.md) et [**CSourceStream**](csourcestream.md).</span><span class="sxs-lookup"><span data-stu-id="8ecf4-127">The DirectShow base classes include two classes that support push sources: [**CSource**](csource.md) and [**CSourceStream**](csourcestream.md).</span></span>

-   <span data-ttu-id="8ecf4-128">[**CSource**](csource.md) est la classe de base pour le filtre et implémente l’interface [**IBaseFilter**](/windows/desktop/api/Strmif/nn-strmif-ibasefilter) .</span><span class="sxs-lookup"><span data-stu-id="8ecf4-128">[**CSource**](csource.md) is the base class for the filter and implements the [**IBaseFilter**](/windows/desktop/api/Strmif/nn-strmif-ibasefilter) interface.</span></span>
-   <span data-ttu-id="8ecf4-129">[**CSourceStream**](csourcestream.md) est la classe de base pour les broches de sortie et implémente l’interface [**IPIN**](/windows/desktop/api/Strmif/nn-strmif-ipin) .</span><span class="sxs-lookup"><span data-stu-id="8ecf4-129">[**CSourceStream**](csourcestream.md) is the base class for the output pins, and implements the [**IPin**](/windows/desktop/api/Strmif/nn-strmif-ipin) interface.</span></span>

### <a name="output-pins"></a><span data-ttu-id="8ecf4-130">Broches de sortie</span><span class="sxs-lookup"><span data-stu-id="8ecf4-130">Output Pins</span></span>

<span data-ttu-id="8ecf4-131">Un filtre source peut avoir plusieurs broches de sortie.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-131">A source filter can have more than one output pin.</span></span> <span data-ttu-id="8ecf4-132">Dans la méthode du constructeur de votre filtre, créez un ou plusieurs codes confidentiels dérivés de [**CSourceStream**](csourcestream.md) (un code confidentiel par flux de sortie).</span><span class="sxs-lookup"><span data-stu-id="8ecf4-132">In your filter's constructor method, create one or more pins derived from [**CSourceStream**](csourcestream.md) (one pin per output stream).</span></span> <span data-ttu-id="8ecf4-133">Vous n’avez pas besoin de stocker des pointeurs vers les broches. les codes confidentiels s’ajoutent automatiquement au filtre lorsqu’ils sont créés.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-133">You don't need to store pointers to the pins; the pins automatically add themselves to the filter when they are created.</span></span>

### <a name="output-formats"></a><span data-ttu-id="8ecf4-134">Formats de sortie</span><span class="sxs-lookup"><span data-stu-id="8ecf4-134">Output Formats</span></span>

<span data-ttu-id="8ecf4-135">La broche de sortie gère la négociation de format avec les méthodes [**CSourceStream**](csourcestream.md) suivantes :</span><span class="sxs-lookup"><span data-stu-id="8ecf4-135">The output pin handles format negotiation with the following [**CSourceStream**](csourcestream.md) methods:</span></span>



| <span data-ttu-id="8ecf4-136">Méthode</span><span class="sxs-lookup"><span data-stu-id="8ecf4-136">Method</span></span>                                                 | <span data-ttu-id="8ecf4-137">Description</span><span class="sxs-lookup"><span data-stu-id="8ecf4-137">Description</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|--------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [<span data-ttu-id="8ecf4-138">**GetMediaType**</span><span class="sxs-lookup"><span data-stu-id="8ecf4-138">**GetMediaType**</span></span>](csourcestream-getmediatype.md)     | <span data-ttu-id="8ecf4-139">Obtient un type de média à partir de la broche de sortie.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-139">Gets a media type from the output pin.</span></span> <br/> <span data-ttu-id="8ecf4-140">Le code confidentiel doit proposer au moins un type de média, car le filtre en aval peut ne pas proposer de types.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-140">The pin must propose at least one media type, because the downstream filter might not propose any types.</span></span> <span data-ttu-id="8ecf4-141">Dans la plupart des cas, le filtre en aval est un décodeur ou un convertisseur, selon que le filtre source fournit des données compressées ou non compressées.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-141">In most cases, the downstream filter will be a decoder or a renderer, depending on whether the source filter delivers compressed or uncompressed data.</span></span> <span data-ttu-id="8ecf4-142">Un filtre de convertisseur requiert généralement un type de média complet, contenant toutes les informations de format nécessaires pour restituer le flux.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-142">A renderer filter usually requires a complete media type, containing all of the format information needed to render the stream.</span></span> <span data-ttu-id="8ecf4-143">Pour un décodeur, la quantité d’informations requises dans le type de média dépend beaucoup du format d’encodage.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-143">For a decoder, the amount of information that is required in the media type depends very much on the encoding format.</span></span><br/> |
| [<span data-ttu-id="8ecf4-144">**CheckMediaType**</span><span class="sxs-lookup"><span data-stu-id="8ecf4-144">**CheckMediaType**</span></span>](csourcestream-checkmediatype.md) | <span data-ttu-id="8ecf4-145">Vérifie si la broche de sortie accepte un type de média donné.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-145">Checks if the output pin accepts a given media type.</span></span> <span data-ttu-id="8ecf4-146">La substitution de cette méthode est facultative, selon la manière dont vous implémentez [**GetMediaType**](csourcestream-getmediatype.md).</span><span class="sxs-lookup"><span data-stu-id="8ecf4-146">Overriding this method is optional, depending on how you implement [**GetMediaType**](csourcestream-getmediatype.md).</span></span>                                                                                                                                                                                                                                                                                                                                                                                                         |



 

<span data-ttu-id="8ecf4-147">La méthode [**GetMediaType**](csourcestream-getmediatype.md) est surchargée :</span><span class="sxs-lookup"><span data-stu-id="8ecf4-147">The [**GetMediaType**](csourcestream-getmediatype.md) method is overloaded:</span></span>

-   <span data-ttu-id="8ecf4-148">[**GetMediaType**](csourcestream-getmediatype.md) (1) accepte un seul paramètre, un pointeur vers un objet [**CMediaType**](cmediatype.md) .</span><span class="sxs-lookup"><span data-stu-id="8ecf4-148">[**GetMediaType**](csourcestream-getmediatype.md) (1) takes a single parameter, a pointer to a [**CMediaType**](cmediatype.md) object.</span></span>
-   <span data-ttu-id="8ecf4-149">[**GetMediaType**](csourcestream-getmediatype2.md) (2) prend une variable d’index et un pointeur vers un objet [**CMediaType**](cmediatype.md) .</span><span class="sxs-lookup"><span data-stu-id="8ecf4-149">[**GetMediaType**](csourcestream-getmediatype2.md) (2) takes an index variable and a pointer to a [**CMediaType**](cmediatype.md) object.</span></span>

<span data-ttu-id="8ecf4-150">Si la broche de sortie du filtre source ne prend en charge qu’un seul format de média, vous devez remplacer (1) pour initialiser l’objet [**CMediaType**](cmediatype.md) avec ce format.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-150">If the source filter's output pin supports exactly one media format, you should override (1) to initialize the [**CMediaType**](cmediatype.md) object with that format.</span></span> <span data-ttu-id="8ecf4-151">Laissez l’implémentation par défaut de (2) et laissez également l’implémentation par défaut de [**CheckMediaType**](csourcestream-checkmediatype.md).</span><span class="sxs-lookup"><span data-stu-id="8ecf4-151">Leave the default implementation of (2) and also leave the default implementation of [**CheckMediaType**](csourcestream-checkmediatype.md).</span></span>

<span data-ttu-id="8ecf4-152">Si le code PIN prend en charge plusieurs formats, remplacez (2).</span><span class="sxs-lookup"><span data-stu-id="8ecf4-152">If the pin supports more than one format, override (2).</span></span> <span data-ttu-id="8ecf4-153">Initialisez l’objet [**CMediaType**](cmediatype.md) en fonction de la valeur de la variable d’index.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-153">Initialize the [**CMediaType**](cmediatype.md) object according to the value of the index variable.</span></span> <span data-ttu-id="8ecf4-154">Le code confidentiel doit renvoyer les formats sous la forme d’une liste ordonnée.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-154">The pin should return the formats as an ordered list.</span></span> <span data-ttu-id="8ecf4-155">Dans ce cas, vous devez également remplacer [**CheckMediaType**](csourcestream-checkmediatype.md) pour vérifier le type de support par rapport à votre liste de formats.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-155">In this case, you must also override the [**CheckMediaType**](csourcestream-checkmediatype.md) to check the media type against your list of formats.</span></span>

<span data-ttu-id="8ecf4-156">Pour les formats vidéo non compressés, n’oubliez pas que le filtre en aval peut proposer des formats avec différentes valeurs Stride.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-156">For uncompressed video formats, remember that the downstream filter can propose formats with various stride values.</span></span> <span data-ttu-id="8ecf4-157">Votre filtre doit accepter toute valeur Stride valide.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-157">Your filter should accept any valid stride value.</span></span> <span data-ttu-id="8ecf4-158">Pour plus d’informations, consultez [**BITMAPINFOHEADER**](/windows/win32/api/wingdi/ns-wingdi-bitmapinfoheader).</span><span class="sxs-lookup"><span data-stu-id="8ecf4-158">For more information, see [**BITMAPINFOHEADER**](/windows/win32/api/wingdi/ns-wingdi-bitmapinfoheader).</span></span>

<span data-ttu-id="8ecf4-159">Vous devez également substituer la méthode [**CBaseOutputPin ecidebuffersize ::D**](cbaseoutputpin-decidebuffersize.md) pure.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-159">You must also override the pure-virtual [**CBaseOutputPin::DecideBufferSize**](cbaseoutputpin-decidebuffersize.md) method.</span></span> <span data-ttu-id="8ecf4-160">Utilisez cette méthode pour définir la taille des exemples de mémoires tampons.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-160">Use this method to set the size of the sample buffers.</span></span>

### <a name="streaming"></a><span data-ttu-id="8ecf4-161">Diffusion en continu</span><span class="sxs-lookup"><span data-stu-id="8ecf4-161">Streaming</span></span>

<span data-ttu-id="8ecf4-162">La classe [**CSourceStream**](csourcestream.md) crée le thread de streaming pour le code confidentiel.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-162">The [**CSourceStream**](csourcestream.md) class creates the streaming thread for the pin.</span></span> <span data-ttu-id="8ecf4-163">La procédure de thread est implémentée dans la méthode [**CSourceStream ::D obufferprocessingloop**](csourcestream-dobufferprocessingloop.md) .</span><span class="sxs-lookup"><span data-stu-id="8ecf4-163">The thread procedure is implemented in the [**CSourceStream::DoBufferProcessingLoop**](csourcestream-dobufferprocessingloop.md) method.</span></span> <span data-ttu-id="8ecf4-164">Cette méthode appelle la méthode pure-virtual [**CSourceStream :: FillBuffer**](csourcestream-fillbuffer.md) , que la classe dérivée doit substituer.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-164">This method calls the pure-virtual [**CSourceStream::FillBuffer**](csourcestream-fillbuffer.md) method, which the derived class must override.</span></span> <span data-ttu-id="8ecf4-165">Cette méthode est l’endroit où le code confidentiel remplit la mémoire tampon avec des données.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-165">This method is where the pin fills the buffer with data.</span></span> <span data-ttu-id="8ecf4-166">Par exemple, si votre filtre fournit une vidéo non compressée, c’est là que vous dessinez les images vidéo.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-166">For example, if your filter delivers uncompressed video, this is where you would draw the video frames.</span></span>

<span data-ttu-id="8ecf4-167">La classe de base démarre et arrête automatiquement la boucle de thread au moment approprié, lorsque le filtre est suspendu ou s’arrête.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-167">The base class automatically starts and stops the thread loop at the right times, when the filter pauses or stops.</span></span> <span data-ttu-id="8ecf4-168">Dans ce cas, la classe [**CSourceStream**](csourcestream.md) appelle des méthodes pour notifier votre classe dérivée :</span><span class="sxs-lookup"><span data-stu-id="8ecf4-168">When this happens, the [**CSourceStream**](csourcestream.md) class calls some methods to notify your derived class:</span></span>

-   [<span data-ttu-id="8ecf4-169">**CSourceStream::OnThreadCreate**</span><span class="sxs-lookup"><span data-stu-id="8ecf4-169">**CSourceStream::OnThreadCreate**</span></span>](csourcestream-onthreadcreate.md)
-   [<span data-ttu-id="8ecf4-170">**CSourceStream::OnThreadDestroy**</span><span class="sxs-lookup"><span data-stu-id="8ecf4-170">**CSourceStream::OnThreadDestroy**</span></span>](csourcestream-onthreaddestroy.md)
-   [<span data-ttu-id="8ecf4-171">**CSourceStream::OnThreadStartPlay**</span><span class="sxs-lookup"><span data-stu-id="8ecf4-171">**CSourceStream::OnThreadStartPlay**</span></span>](csourcestream-onthreadstartplay.md)

<span data-ttu-id="8ecf4-172">Vous pouvez substituer ces méthodes si vous devez ajouter une gestion spéciale.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-172">You can override these methods if you need to add any special handling.</span></span> <span data-ttu-id="8ecf4-173">Dans le cas contraire, les implémentations par défaut retournent simplement **S \_ OK**.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-173">Otherwise, the default implementations simply return **S\_OK**.</span></span>

## <a name="seeking"></a><span data-ttu-id="8ecf4-174">Cherche</span><span class="sxs-lookup"><span data-stu-id="8ecf4-174">Seeking</span></span>

<span data-ttu-id="8ecf4-175">Si vous avez un filtre source avec une broche de sortie, vous pouvez utiliser la classe [**CSourceSeeking**](csourceseeking.md) comme point de départ pour l’implémentation de la recherche.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-175">If you have a source filter with one output pin, you can use the [**CSourceSeeking**](csourceseeking.md) class as a starting point for implementing seeking.</span></span> <span data-ttu-id="8ecf4-176">Hériter de votre classe pin de [**CSourceStream**](csourcestream.md) et **CSourceSeeking**.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-176">Inherit your pin class from both [**CSourceStream**](csourcestream.md) and **CSourceSeeking**.</span></span>

> [!Note]  
> <span data-ttu-id="8ecf4-177">[**CSourceSeeking**](csourceseeking.md) n’est pas recommandé pour un filtre avec plus d’une broche de sortie.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-177">[**CSourceSeeking**](csourceseeking.md) is not recommended for a filter with more than one output pin.</span></span> <span data-ttu-id="8ecf4-178">Le principal problème est que seul un code PIN doit répondre aux demandes de recherche.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-178">The main issue is that only one pin should respond to seeking requests.</span></span> <span data-ttu-id="8ecf4-179">En général, cela nécessite une communication entre les codes confidentiels et le filtre.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-179">Typically this requires communication among the pins and the filter.</span></span>

 

<span data-ttu-id="8ecf4-180">La classe [**CSourceSeeking**](csourceseeking.md) gère la vitesse de lecture, l’heure de début, l’heure d’arrêt et la durée.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-180">The [**CSourceSeeking**](csourceseeking.md) class manages the playback rate, start time, stop time, and duration.</span></span> <span data-ttu-id="8ecf4-181">Votre classe dérivée doit définir l’heure et la durée de l’arrêt initiales.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-181">Your derived class should set the initial stop time and duration.</span></span> <span data-ttu-id="8ecf4-182">Chaque fois que l’une de ces valeurs change, la méthode [**CSourceSeeking :: ChangeRate**](csourceseeking-changerate.md), [**CSourceSeeking :: modifiez l'**](csourceseeking-changestart.md)ou [**CSourceSeeking :: ChangeStop**](csourceseeking-changestop.md) est appelée, le cas échéant.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-182">Whenever one of these values changes, the [**CSourceSeeking::ChangeRate**](csourceseeking-changerate.md), [**CSourceSeeking::ChangeStart**](csourceseeking-changestart.md), or [**CSourceSeeking::ChangeStop**](csourceseeking-changestop.md) method is called, as appropriate.</span></span> <span data-ttu-id="8ecf4-183">Les méthodes sont toutes des méthodes virtuelles pures.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-183">The methods are all pure virtual methods.</span></span> <span data-ttu-id="8ecf4-184">La classe de code confidentiel dérivée remplace ces méthodes pour effectuer les opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="8ecf4-184">The derived pin class overrides these methods to do the following:</span></span>

1.  <span data-ttu-id="8ecf4-185">Appelez [**IPIN :: BeginFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush) sur le code confidentiel en aval.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-185">Call [**IPin::BeginFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush) on the downstream pin.</span></span> <span data-ttu-id="8ecf4-186">Cela amène les filtres en aval à libérer des exemples qu’ils détiennent et rejettent de nouveaux exemples.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-186">This causes downstream filters to release samples they are holding and reject new samples.</span></span>
2.  <span data-ttu-id="8ecf4-187">Appelez [**CSourceStream :: Stop**](csourcestream-stop.md) pour arrêter le thread de diffusion en continu.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-187">Call [**CSourceStream::Stop**](csourcestream-stop.md) to stop the streaming thread.</span></span> <span data-ttu-id="8ecf4-188">Le filtre source interrompt la production de nouvelles données.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-188">The source filter suspends producing new data.</span></span>
3.  <span data-ttu-id="8ecf4-189">Appelez [**IPIN :: EndFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-endflush) sur le code confidentiel en aval.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-189">Call [**IPin::EndFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-endflush) on the downstream pin.</span></span> <span data-ttu-id="8ecf4-190">Cela indique aux filtres en aval d’accepter de nouvelles données.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-190">This signals the downstream filters to accept new data.</span></span>
4.  <span data-ttu-id="8ecf4-191">Appelez [**IPIN :: NewSegment**](/windows/desktop/api/Strmif/nf-strmif-ipin-newsegment) avec les nouvelles dates et heures de début et de fin.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-191">Call [**IPin::NewSegment**](/windows/desktop/api/Strmif/nf-strmif-ipin-newsegment) with the new start and stop times and rate.</span></span>
5.  <span data-ttu-id="8ecf4-192">Définissez la propriété discontinu sur l’exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-192">Set the discontinuity property on the next sample.</span></span>

<span data-ttu-id="8ecf4-193">Pour plus d’informations, consultez [prise en charge de la recherche dans un filtre source](supporting-seeking-in-a-source-filter.md).</span><span class="sxs-lookup"><span data-stu-id="8ecf4-193">For more information, see [Supporting Seeking in a Source Filter](supporting-seeking-in-a-source-filter.md).</span></span>

<span data-ttu-id="8ecf4-194">Si votre filtre prend en charge la recherche, la position du flux est maintenant indépendante de l’heure de la présentation.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-194">If your filter supports seeking, the stream position is now independent of the presentation time.</span></span> <span data-ttu-id="8ecf4-195">Après une recherche, les horodatages sont remis à zéro.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-195">After a seek, time stamps reset to zero.</span></span> <span data-ttu-id="8ecf4-196">La formule générale pour les horodatages est la suivante :</span><span class="sxs-lookup"><span data-stu-id="8ecf4-196">The general formula for time stamps is:</span></span>

-   <span data-ttu-id="8ecf4-197">heure de début de l’exemple = durée écoulée/vitesse de lecture</span><span class="sxs-lookup"><span data-stu-id="8ecf4-197">sample start time = time elapsed / playback rate</span></span>
-   <span data-ttu-id="8ecf4-198">heure de fin de l’exemple = heure de début de l’exemple + (temps par cadre/vitesse de lecture)</span><span class="sxs-lookup"><span data-stu-id="8ecf4-198">sample end time = sample start time + (time per frame / playback rate)</span></span>

<span data-ttu-id="8ecf4-199">le *temps écoulé* est le temps écoulé depuis le début de l’exécution du filtre ou depuis la dernière commande Seek.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-199">where *time elapsed* is the time that has elapsed since the filter started running or since the last seek command.</span></span>

### <a name="time-formats-for-seeking"></a><span data-ttu-id="8ecf4-200">Formats d’heure pour la recherche</span><span class="sxs-lookup"><span data-stu-id="8ecf4-200">Time Formats for Seeking</span></span>

<span data-ttu-id="8ecf4-201">Par défaut, les commandes de recherche sont en unités de 100 nanosecondes.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-201">By default, seek commands are in units of 100-nanoseconds.</span></span> <span data-ttu-id="8ecf4-202">Votre filtre source peut prendre en charge des formats d’heure supplémentaires, tels que la recherche par numéro de trame.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-202">Your source filter can support additional time formats, such as seeking by frame number.</span></span> <span data-ttu-id="8ecf4-203">Chaque format d’heure est identifié par un GUID. consultez [**GUID de format d’heure**](time-format-guids.md).</span><span class="sxs-lookup"><span data-stu-id="8ecf4-203">Each time format is identified by a GUID; see [**Time Format GUIDs**](time-format-guids.md).</span></span>

<span data-ttu-id="8ecf4-204">Pour prendre en charge des formats d’heure supplémentaires, vous devez implémenter les méthodes suivantes sur votre code confidentiel de sortie :</span><span class="sxs-lookup"><span data-stu-id="8ecf4-204">To support additional time formats, you must implement the following methods on your output pin:</span></span>

-   [<span data-ttu-id="8ecf4-205">**IMediaSeeking::ConvertTimeFormat**</span><span class="sxs-lookup"><span data-stu-id="8ecf4-205">**IMediaSeeking::ConvertTimeFormat**</span></span>](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-converttimeformat)
-   [<span data-ttu-id="8ecf4-206">**IMediaSeeking::GetTimeFormat**</span><span class="sxs-lookup"><span data-stu-id="8ecf4-206">**IMediaSeeking::GetTimeFormat**</span></span>](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-gettimeformat)
-   [<span data-ttu-id="8ecf4-207">**IMediaSeeking::IsFormatSupported**</span><span class="sxs-lookup"><span data-stu-id="8ecf4-207">**IMediaSeeking::IsFormatSupported**</span></span>](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-isformatsupported)
-   [<span data-ttu-id="8ecf4-208">**IMediaSeeking::IsUsingTimeFormat**</span><span class="sxs-lookup"><span data-stu-id="8ecf4-208">**IMediaSeeking::IsUsingTimeFormat**</span></span>](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-isusingtimeformat)
-   [<span data-ttu-id="8ecf4-209">**IMediaSeeking::QueryPreferredFormat**</span><span class="sxs-lookup"><span data-stu-id="8ecf4-209">**IMediaSeeking::QueryPreferredFormat**</span></span>](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-querypreferredformat)
-   [<span data-ttu-id="8ecf4-210">**IMediaSeeking::SetTimeFormat**</span><span class="sxs-lookup"><span data-stu-id="8ecf4-210">**IMediaSeeking::SetTimeFormat**</span></span>](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-settimeformat)

<span data-ttu-id="8ecf4-211">Si l’application définit un nouveau format d’heure, tous les paramètres de position dans les méthodes [**IMediaSeeking**](/windows/desktop/api/Strmif/nn-strmif-imediaseeking) sont interprétés en fonction du nouveau format d’heure.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-211">If the application sets a new time format, all of the position parameters in the [**IMediaSeeking**](/windows/desktop/api/Strmif/nn-strmif-imediaseeking) methods are interpreted in terms of the new time format.</span></span> <span data-ttu-id="8ecf4-212">Par exemple, si le format d’heure est frames, la méthode [**IMediaSeeking :: GetDuration**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-getduration) doit retourner la durée dans les frames.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-212">For example, if the time format is frames, the [**IMediaSeeking::GetDuration**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-getduration) method must return the duration in frames.</span></span>

<span data-ttu-id="8ecf4-213">En pratique, peu de filtres DirectShow prennent en charge des formats d’heure supplémentaires et, par conséquent, peu d’applications DirectShow utilisent cette fonctionnalité.</span><span class="sxs-lookup"><span data-stu-id="8ecf4-213">In practice, few DirectShow filters support additional time formats, and as a result, few DirectShow applications make use of this capability.</span></span>

## <a name="related-topics"></a><span data-ttu-id="8ecf4-214">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="8ecf4-214">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8ecf4-215">Écriture de filtres source</span><span class="sxs-lookup"><span data-stu-id="8ecf4-215">Writing Source Filters</span></span>](writing-source-filters.md)
</dt> </dl>

 

 




