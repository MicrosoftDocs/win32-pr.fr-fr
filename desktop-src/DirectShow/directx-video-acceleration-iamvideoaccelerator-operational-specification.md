---
description: Spécification opérationnelle DirectX Video Acceleration IAMVideoAccelerator
ms.assetid: 25ee05d5-8554-4739-9122-e3c0255bf965
title: Spécification opérationnelle DirectX Video Acceleration IAMVideoAccelerator
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3360e18e91197f2a15a36fb112f0419b6382e915
ms.sourcegitcommit: a47bd86f517de76374e4fff33cfeb613eb259a7e
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/06/2021
ms.locfileid: "103949977"
---
# <a name="directx-video-acceleration-iamvideoaccelerator-operational-specification"></a>Spécification opérationnelle DirectX Video Acceleration IAMVideoAccelerator

Le mécanisme de fonctionnement précis est le suivant :

1.  Chaque profil de mode restreint défini dans le présentateur est associé à un GUID DirectX VA qui peut être pris en charge par les [**IPIN :: QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) et [**IPIN :: ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) d’une broche d’entrée en aval et est listé dans [**IAMVideoAccelerator :: GetVideoAcceleratorGUIDs**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getvideoacceleratorguids).
2.  De même, chaque type de protocole de chiffrement à utiliser avec DirectX VA doit avoir un GUID de type de protocole de chiffrement associé qui peut être pris en charge par les [**IPIN :: QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) et [**IPIN :: ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) d’une broche d’entrée en aval, et est listé dans **IAMVideoAccelerator :: GetVideoAcceleratorGUIDs**. Le GUID « aucun chiffrement » DXVA \_ Noencrypt ne doit pas être envoyé dans cette liste, car sa prise en charge est requise et par conséquent implicite.
3.  Après l’appel de [**IPIN :: ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) pour tenter une connexion à la broche d’entrée en aval, le décodeur [**IAMVideoAcceleratorNotify :: GetCreateVideoAcceleratorData**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getcreatevideoacceleratordata) doit retourner un pointeur vers une \_ structure de données DXVA connectMode contenant les informations relatives au mode de connexion pour la connexion. [**IAMVideoAccelerator :: GetCompBufferInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getcompbufferinfo) est appelé avec \* pdwNumTypesCompBuffers = 16 et retourne des informations sur la mémoire tampon compressées en fonction de la Convention selon laquelle le numéro de type de chaque mémoire tampon (tel que défini dans la section 3,4 de la spécification DirectX va) peut être utilisé directement comme index de base zéro dans le tableau de structures de données **AMVACompBufferInfo** qui est retourné. Cela requiert que pour tous les types de mémoire tampon qui ne seront pas utilisés (y compris le type de mémoire tampon 0, étant donné qu’il n’y a aucune utilisation définie de ce type de tampon), le pilote d’accélérateur fournira des structures de données AMVACompBufferInfo avec une forme de valeurs de paramètre « factices » (par exemple, dwNumCompBuffers = 0, dwWidthToCreate = 0, dwHeightToCreate = 0 et
4.  Les indications de fonction DXVA et les mémoires tampons de données associées sont envoyées à l’aide de [**IAMVideoAccelerator :: Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute). La fonction DXVA est indiquée dans le paramètre dwFunction de l’appel. Les seules fonctions DXVA pertinentes pour l’initialisation sont DXVA \_ ConfigQueryOrReplyFunc et DXVA \_ EncryptProtocolFunc.
    -   Si dwFunction contient un \_ CONFIGQUERYORREPLYFUNC DXVA, le pointeur lpPrivateInputData pour passer des données à l’accélérateur dans cet appel doit pointer vers une structure de données de configuration, le pointeur lpPrivateOutputData pour la réception d’informations à partir de l’accélérateur pointera vers une zone dans laquelle une autre structure ou une structure de données de configuration dupliquée peut être placée Le HRESULT retourné contient l' \_ indication s OK ou s \_ false, ou e \_ Fail ou e \_ INVALIDARG ou une autre indication d’erreur HRESULT en cas de problème grave dans l’exécution du protocole (par exemple, un paramètre de configuration non valide). Tous les appels à **IAMVideoAccelerator :: Execute** pour toutes les utilisations de DXVA \_ ConfigQueryOrReplyFunc doivent précéder tous les autres appels à **IAMVideoAccelerator :: Execute**.
    -   Si dwFunction contient un \_ ENCRYPTPROTOCOLFUNC DXVA, le pointeur lpPrivateInputData pour passer des données à l’accélérateur dans cet appel doit pointer vers une structure de données de protocole de chiffrement qui commence par DXVA \_ EncryptProtocolHeader, le pointeur lpPrivateOutputData pour la réception d’informations à partir de l’accélérateur doit pointer vers une zone où les données à retourner (par exemple, un certificat) par le protocole de chiffrement (qui commence par DXVA \_ EncryptProtocolHeader) peuvent être placées, le pointeur pamvaBufferInfo pour un tableau de AMVABUFFERINFO doit avoir la **valeur null**, et dwNumBuffers doit être égal à zéro. Le HRESULT retourné contient la \_ valeur S tant que le protocole de chiffrement fonctionne normalement et contient e \_ Fail ou e \_ INVALIDARG ou une autre indication d’erreur HRESULT en cas de problème grave dans l’exécution du protocole.

        Après l’initialisation de l’opération de la manière décrite ci-dessus, le fonctionnement réel du décodeur se déroule comme suit :

5.  **IAMVideoAccelerator :: BeginFrame** doit être appelé avant l’envoi d’une \_ fonction bDXVA avec des paramètres de mémoire tampon compressés, ce qui entraîne des écritures sur une surface de destination non compressée. L’objectif de [**IAMVideoAccelerator :: BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) dans DirectX va est d’associer des surfaces de destination à des valeurs d’index et de notifier le pilote d’accélérateur vidéo de l’intention de lancer l’écriture d’une surface afin que le pilote puisse répondre en indiquant si la surface est prête à être remplacée. La structure **AMVABeginFrameInfo** transmise dans **IAMVideoAccelerator :: BeginFrame** doit contenir un pointeur pInputData vers un paramètre de mot wBeginPictureIndex unique correspondant à l’index de frame passé dans **IAMVideoAccelerator :: BeginFrame** (et dwSizeInputData doit avoir la valeur 2). Il s’agit de l’index à utiliser dans une mémoire tampon compressée pour commander une écriture sur la surface (par exemple, pour être utilisé en tant que wDecodedPictureIndex, wDeblockedPictureIndex, wBlendedDestinationIndex ou wPicResampleDestPicIndex). Chaque appel à **IAMVideoAccelerator :: BeginFrame** doit être associé à un appel correspondant à [**IAMVideoAccelerator :: EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) , comme décrit ci-dessous. Par exemple, si une image compressée doit être décodée, puis fusionnée à l’aide de la fusion d’une mémoire tampon vers une mémoire tampon frontale vers une image graphique, un appel à **IAMVideoAccelerator :: BeginFrame** avant de décoder l’image compressée dans une surface spécifiée dans wDecodedPictureIndex, ensuite, un appel à **IAMVideoAccelerator :: EndFrame** après avoir passé toutes les mémoires tampons compressées utilisées pour décoder l’image, puis un deuxième appel à **IAMVideoAccelerator :: BeginFrame** avant d’effectuer le contrôle de la combinaison alpha de la source graphique avec l’image décodée dans une surface spécifiée dans wBlendedDestinationIndex, puis un deuxième appel à **IAMVideoAccelerator :: EndFrame** après l’opération de combinaison alpha Blend Le pointeur pOutputData dans AMVABeginFrameInfo doit avoir la **valeur null** (et dwSizeOutputData doit être « 0 »). Le HRESULT retourné par **IAMVideoAccelerator :: BeginFrame** doit être :
    -   \_OK si l’aire non compressée est disponible et prête à l’emploi.
    -   E \_ en attente si la surface non compressée n’est pas encore disponible pour une utilisation mais sera bientôt disponible (si la surface non compressée est lue pour l’affichage et que la lecture/l’affichage de la surface n’est pas encore terminé).
    -   E \_ échoue ou e \_ INVALIDARG une autre indication d’erreur uniquement si un format de données ou une erreur de protocole est détecté (par exemple, une valeur incorrecte de dwSizeInputData ou un POutputData non **null** ).
6.  Les indications de fonction DXVA et les mémoires tampons de données associées sont envoyées à l’aide de **IAMVideoAccelerator :: Execute**. Plusieurs \_ valeurs Func bDXVA peuvent être indiquées dans le même appel à [**IAMVideoAccelerator :: Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute). Les \_ valeurs Func bDXVA doivent être empaquetées dans le paramètre dwFunction de l’appel, avec la première commande de fonction dans les huit MSBS, la commande suivante dans les huit bits suivants, et ainsi de suite, avec les bits restants complétés par des zéros. La valeur 0xFF pour bDXVA \_ Func indique que la \_ Func bDXVA est étendue à deux ou quatre octets. Si le deuxième octet est également 0xFF, cela indique que la fonction bDXVA \_ Func est étendue à quatre octets. Si les quatre bits supérieurs du troisième octet sont 0xF ou 0x0, cela indique que bDXVA \_ Func contient un CONFIGQUERYORREPLYFUNC DXVA \_ ou un \_ EncryptProtocolFunc DXVA. Les commandes multi-octets ne doivent pas indiquer la continuation au-delà de la fin de dwFunction. Le décodeur doit veiller à ce qu’aucune dépendance séquentielle ne soit présente entre différentes \_ valeurs Func bDXVA spécifiées dans le même appel à **IAMVideoAccelerator :: exécutez** et que toutes les conditions de concurrence potentielles (telles que le décodage d’image et la fusion de sous-image, entre le chargement de sous-image et la fusion de sous-image, etc.) sont évitées par les appels appropriés à **IAMVideoAccelerator :: BeginFrame** et [**IAMVideoAccelerator :: QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) avant les appels suivants à **IAMVideoAccelerator :: Execute**.
    -   Si dwFunction contient un \_ CONFIGQUERYORREPLYFUNC DXVA, le pointeur lpPrivateInputData pour passer des données à l’accélérateur dans cet appel doit pointer vers une structure de données de configuration, le pointeur lpPrivateOutputData pour la réception d’informations à partir de l’accélérateur pointera vers une zone dans laquelle une autre structure ou une structure de données de configuration dupliquée peut être placée Le HRESULT retourné contient l' \_ indication s OK ou s \_ false en réponse à la requête, ou e \_ échoue ou e \_ INVALIDARG une autre indication d’erreur HRESULT en cas de problème grave dans l’exécution du protocole (par exemple, un paramètre invalid.configfiguration). Tous les appels à **IAMVideoAccelerator :: Execute** pour toutes les utilisations de DXVA \_ ConfigQueryOrReplyFunc doivent précéder tous les autres appels à **IAMVideoAccelerator :: Execute**.
    -   Si dwFunction contient un \_ ENCRYPTPROTOCOLFUNC DXVA, le pointeur lpPrivateInputData pour passer des données à l’accélérateur dans cet appel doit pointer vers une structure de données de protocole de chiffrement qui commence par DXVA \_ EncryptProtocolHeader, le pointeur lpPrivateOutputData pour la réception d’informations à partir de l’accélérateur doit pointer vers une zone où les données à retourner (par exemple, un certificat) par le protocole de chiffrement (qui commence par DXVA \_ EncryptProtocolHeader) peuvent être placées, le pointeur pamvaBufferInfo pour un tableau de AMVABUFFERINFO doit avoir la **valeur null**, et dwNumBuffers doit être égal à zéro. Le HRESULT retourné contient la \_ valeur S tant que le protocole de chiffrement fonctionne normalement et contient e \_ Fail ou e \_ INVALIDARG ou une autre indication d’erreur HRESULT en cas de problème grave dans l’exécution du protocole.
    -   Si dwFunction ne contient pas de \_ ENCRYPTPROTOCOLFUNC DXVA ConfigQueryOrReplyFunc ou DXVA \_ , le pointeur lpPrivateInputData pour passer des données à l’accélérateur doit pointer vers une liste de descriptions de mémoire tampon. Les quatre premières entrées de la structure de la liste de description de la mémoire tampon pour chaque mémoire tampon (dwTypeIndex, dwBufferIndex, dwDataOffset et dwDataSize) doivent être égales à celles de la structure de données AMVABUFFERINFO pour la même mémoire tampon. Si la fonction bDXVA \_ Func est égale à « 1 » est spécifiée dans dwFunction et que bPicReadbackRequests a la valeur « 1 », le pointeur lpPrivateOutputData pour la réception d’informations à partir de l’accélérateur doit pointer vers une zone de mémoire persistante (par exemple, le tas) à remplir avec les données bloc macro en lecture à partir de l’accélérateur (ces données ne sont pas garanties comme étant présentes jusqu’à ce que **IAMVideoAccelerator :: QueryRenderStatus** pour l’écriture dans la même mémoire tampon des paramètres d’image indique le paramètre \_ OK comme décrit dans Dans le cas contraire, le pointeur lpPrivateOutputData pour la réception d’informations à partir de l’accélérateur doit pointer vers une valeur DWORD unique pour être définie sur l’une des valeurs d’indication suivantes (particulièrement utile pour signaler des erreurs de flux binaire dans une opération de VLD hors hôte).

        | Valeur | Description                                     |
        |-------|-------------------------------------------------|
        | 0     | Exécution OK.                                   |
        | 1     | Problème mineur au format de données rencontré.       |
        | 2     | Problème significatif au format de données rencontré. |
        | 3     | Un problème grave s’est produit au format de données.      |
        | 4     | Autre problème grave rencontré.               |

        

         

        Si l’un des types de problèmes « sérieux » est indiqué, le décodeur logiciel doit cesser d’utiliser la ou les fonctions à moins que des mesures correctives puissent être prises. Les données retournées par l’accélérateur ne seront pas lues par l’hôte tant que le rendu de la mémoire tampon de l’image n’est pas terminé, comme il peut être testé par [**IAMVideoAccelerator :: QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus). La valeur HRESULT retournée contient des S \_ OK tant que l’opération d’interface fonctionne normalement et peut retourner e \_ Fail ou e \_ INVALIDARG ou une autre indication d’erreur HRESULT en cas de problème grave.

7.  La mémoire tampon des paramètres de décodage d’image doit figurer parmi les premières mémoires tampons envoyées pour le décodage de chaque image lors de l’utilisation de [**IAMVideoAccelerator :: Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute) avec bDXVA \_ Func égal à « 1 », et toutes les mémoires tampons pour le décodage d’une image dans un flux binaire doivent être envoyées avant les mémoires tampons pour décoder les images suivantes. Si une mémoire tampon de commande de contrôle bloc macro est envoyée, une mémoire tampon de données de différence résiduelle correspondante doit être envoyée (contenant les données du même blocs macros) avec le même appel **IAMVideoAccelerator :: Execute** .
8.  [**IAMVideoAccelerator :: EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) doit être appelé après l’envoi de toutes les mémoires tampons compressées qui provoqueront la création du contenu de sortie dans une surface non compressée spécifiée (résultat d’opérations spécifiées pour WDecodedPictureIndex, WDeblockedPictureIndex, WBlendedDestinationIndex ou wPicResampleDestPicIndex). L’objectif de cet appel à **IAMVideoAccelerator :: EndFrame** est d’informer le matériel de l’accélérateur vidéo que toutes les données nécessaires pour l’opération spécifiée ont été envoyées. Le pointeur vers les données à envoyer en aval via **IAMVideoAccelerator :: EndFrame** doit pointer vers un mot unique wEndPictureIndex contenant l’index du cadre qui se termine. Ce paramètre doit correspondre à la valeur wBeginPictureIndex spécifiée dans l’appel précédent à [**IAMVideoAccelerator :: BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) avant l’envoi des mémoires tampons compressées pertinentes. À la suite d’un appel à **IAMVideoAccelerator :: EndFrame**, la surface non compressée avec l’index wEndPictureIndex ne sera trouvée dans aucune WDecodedPictureIndex, WDeblockedPictureIndex, WBlendedDestinationIndex ou wPicResampleDestPicIndex d’image tant qu’un autre appel à **IAMVideoAccelerator :: BeginFrame** n’aura pas été émis pour annoncer que cela se produira et \_ qu’une valeur OK a été retournée en tant que résultat. Toutefois, cet index de surface de destination peut apparaître dans les commandes d’accès en lecture suivantes, telles que wForwardRefPictureIndex, wBackwardRefPictureIndex, wPicResampleSourcePicIndex ou bRefPicSelect \[ i \] . Le HRESULT retourné par **IAMVideoAccelerator :: EndFrame** doit être \_ OK, sauf s’il existe un type de données ou une erreur de protocole, auquel cas il peut s’agir de E \_ Fail ou e \_ INVALIDARG ou d’une autre indication d’erreur.
9.  Dans le cas du décodage basé sur les champs (par exemple, dans les flux de bits MPEG-2), il n’y aura pas de mappage un-à-un des images fonctionnelles dans le flux binaire aux surfaces non compressées dans l’interface d’accélérateur. Lors du décodage d’images de champ dans un flux de bits MPEG-2, deux « images » sont décodées pour produire une surface de sortie non compressée complète. Dans la définition de l’interface DirectX VA, chaque frame correspond à chaque utilisation de wDecodedPictureIndex, wDeblockedPictureIndex, wBlendedDestinationIndex ou wPicResampleDestPicIndex. Par conséquent, deux paires d’appels à **IAMVideoAccelerator :: BeginFrame** et **IAMVideoAccelerator :: EndFrame** sont requises pour le décodage des images de champ dans les surfaces non compressées de sortie.
10. Un appel à [**IAMVideoAccelerator :: QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) avec dwFlags égal à zéro qui se produit quelque temps après un appel à **IAMVideoAccelerator :: EndFrame** avec un wEndPictureIndex particulier et vérifie l’état d’une mémoire tampon qui a été envoyée qui contenait le WEndPictureIndex dans WDecodedPictureIndex, WDeblockedPictureIndex, wBlendedDestinationIndex ou WPicResampleDestPicIndex retourne une \_ indication S OK si toutes les opérations d’écriture des données sur la surface non compressée sont terminées et retournent E \_ en attente si l’opération n’est pas encore terminée. E \_ Fail ou e \_ INVALIDARG ou une autre indication d’erreur peut être retournée en cas d’erreur de protocole.

## <a name="related-topics"></a>Rubriques connexes

<dl> <dt>

[Mappage de l’accélération vidéo DirectX sur IAMVideoAccelerator](mapping-directx-video-acceleration-to-iamvideoaccelerator.md)
</dt> </dl>

 

 



