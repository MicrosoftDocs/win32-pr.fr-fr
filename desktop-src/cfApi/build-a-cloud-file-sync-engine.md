---
description: Découvrez comment créer un moteur de synchronisation de fichiers Cloud qui utilise des fichiers d’espace réservé à l’aide de l’API de fichiers Cloud.
title: Créer un moteur de synchronisation Cloud qui prend en charge les fichiers d’espace réservé
ms.topic: article
ms.date: 11/12/2020
ms.openlocfilehash: 4f1330285d0c8ef0359639f2be84162f8bc2ef3b
ms.sourcegitcommit: 3bdf30edb314e0fcd17dc4ddbc70e4ec7d3596e6
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 02/10/2021
ms.locfileid: "104561505"
---
# <a name="build-a-cloud-sync-engine-that-supports-placeholder-files"></a><span data-ttu-id="1d78b-103">Créer un moteur de synchronisation Cloud qui prend en charge les fichiers d’espace réservé</span><span class="sxs-lookup"><span data-stu-id="1d78b-103">Build a Cloud Sync Engine that Supports Placeholder Files</span></span>

<span data-ttu-id="1d78b-104">Un moteur de synchronisation est un service qui synchronise les fichiers, généralement entre un hôte distant et un client local.</span><span class="sxs-lookup"><span data-stu-id="1d78b-104">A sync engine is a service that syncs files, typically between a remote host and a local client.</span></span> <span data-ttu-id="1d78b-105">Les moteurs de synchronisation sur Windows présentent souvent ces fichiers à l’utilisateur par le biais du système de fichiers Windows et de l’Explorateur de fichiers.</span><span class="sxs-lookup"><span data-stu-id="1d78b-105">Sync engines on Windows often present those files to the user through the Windows file system and File Explorer.</span></span> <span data-ttu-id="1d78b-106">Avant Windows 10, version 1709, la prise en charge du moteur de synchronisation dans Windows était limitée aux surfaces ad hoc indépendantes des scénarios, telles que le volet de navigation de l’Explorateur de fichiers, la barre d’état système Windows et (pour les applications plus techniques) pilotes de filtre du système de fichiers.</span><span class="sxs-lookup"><span data-stu-id="1d78b-106">Before Windows 10, version 1709, sync engine support in Windows was limited to scenario-agnostic ad-hoc surfaces, such as File Explorer’s navigation pane, the Windows system tray, and (for more technical applications) file system filter drivers.</span></span>

<span data-ttu-id="1d78b-107">Windows 10 version 1709 (également appelée « mise à jour des créateurs de automne ») a introduit l' *API de fichiers Cloud*.</span><span class="sxs-lookup"><span data-stu-id="1d78b-107">Windows 10 version 1709 (also called the Fall Creators Update) introduced the *cloud files API*.</span></span> <span data-ttu-id="1d78b-108">Cette API est une nouvelle plateforme qui formalise la prise en charge des moteurs de synchronisation.</span><span class="sxs-lookup"><span data-stu-id="1d78b-108">This API is a new platform that formalizes support for sync engines.</span></span> <span data-ttu-id="1d78b-109">L’API de fichiers Cloud prend en charge les moteurs de synchronisation d’une manière qui offre de nombreux nouveaux avantages aux développeurs et aux utilisateurs finaux.</span><span class="sxs-lookup"><span data-stu-id="1d78b-109">The cloud files API provides support for sync engines in a way that offers many new benefits to developers and end users.</span></span>

<span data-ttu-id="1d78b-110">L’API de fichiers Cloud contient les API Win32 natives et les API Windows Runtime (WinRT) suivantes :</span><span class="sxs-lookup"><span data-stu-id="1d78b-110">The cloud files API contains the following native Win32 APIs and Windows Runtime (WinRT) APIs:</span></span>

* <span data-ttu-id="1d78b-111">[API de filtre Cloud](cloud-filter-reference.md): cette API Win32 native fournit des fonctionnalités à la limite entre le mode utilisateur et le système de fichiers.</span><span class="sxs-lookup"><span data-stu-id="1d78b-111">[Cloud Filter API](cloud-filter-reference.md): This native Win32 API provides functionality at the boundary between the user mode and the file system.</span></span> <span data-ttu-id="1d78b-112">Cette API gère la création et la gestion de fichiers et de répertoires d’espace réservé.</span><span class="sxs-lookup"><span data-stu-id="1d78b-112">This API handles the creation and management of placeholder files and directories.</span></span>
* <span data-ttu-id="1d78b-113">[Espace de noms Windows. Storage. Provider](/uwp/api/windows.storage.provider): cette API WinRT permet aux applications de configurer le fournisseur de stockage cloud et d’inscrire la racine de synchronisation auprès du système d’exploitation.</span><span class="sxs-lookup"><span data-stu-id="1d78b-113">[Windows.Storage.Provider namespace](/uwp/api/windows.storage.provider): This WinRT API enables applications to configure the cloud storage provider and register the sync root with the operating system.</span></span>

> [!NOTE]
> <span data-ttu-id="1d78b-114">L’API de fichiers Cloud ne prend pas actuellement en charge l’implémentation de moteurs de synchronisation Cloud dans des applications UWP.</span><span class="sxs-lookup"><span data-stu-id="1d78b-114">The cloud files API does not currently support implementing cloud sync engines in UWP apps.</span></span> <span data-ttu-id="1d78b-115">Les moteurs de synchronisation Cloud doivent être implémentés dans les applications de bureau.</span><span class="sxs-lookup"><span data-stu-id="1d78b-115">Cloud sync engines must be implemented in desktop apps.</span></span>

## <a name="supported-features"></a><span data-ttu-id="1d78b-116">Fonctionnalités prises en charge</span><span class="sxs-lookup"><span data-stu-id="1d78b-116">Supported features</span></span>

<span data-ttu-id="1d78b-117">L’API de fichiers Cloud fournit les fonctionnalités suivantes pour créer des moteurs de synchronisation Cloud.</span><span class="sxs-lookup"><span data-stu-id="1d78b-117">The cloud files API provides the following features for building cloud sync engines.</span></span>

### <a name="placeholder-files"></a><span data-ttu-id="1d78b-118">Fichiers d’espace réservé</span><span class="sxs-lookup"><span data-stu-id="1d78b-118">Placeholder files</span></span>

* <span data-ttu-id="1d78b-119">Les moteurs de synchronisation peuvent créer des fichiers d’espace réservé qui consomment uniquement 1 Ko de stockage pour l’en-tête du système de fichiers, et qui sont automatiquement alimentés en fichiers complets dans des conditions d’utilisation normales.</span><span class="sxs-lookup"><span data-stu-id="1d78b-119">Sync engines can create placeholder files that consume only 1 KB of storage for the filesystem header, and that automatically hydrate into full files under normal use conditions.</span></span> <span data-ttu-id="1d78b-120">Fichiers d’espace réservé présents en tant que fichiers standard pour les applications et pour les utilisateurs finaux dans le shell Windows.</span><span class="sxs-lookup"><span data-stu-id="1d78b-120">Placeholder files present as typical files to apps and to end users in the Windows Shell.</span></span>
* <span data-ttu-id="1d78b-121">Les fichiers d’espace réservé sont intégrés verticalement à partir du noyau Windows jusqu’au shell Windows, et la compatibilité des applications avec les espaces réservés n’est généralement pas un problème.</span><span class="sxs-lookup"><span data-stu-id="1d78b-121">Placeholder files are vertically integrated from the Windows kernel up to the Windows Shell, and app compatibility with placeholder files is generally a non-issue.</span></span> <span data-ttu-id="1d78b-122">Que vous utilisiez des API de système de fichiers, l’invite de commandes ou un ordinateur de bureau ou une application UWP pour accéder à un fichier d’espace réservé, le fichier est hydraté sans modification de code supplémentaire et cette application peut utiliser le fichier normalement.</span><span class="sxs-lookup"><span data-stu-id="1d78b-122">Whether you use file system APIs, the Command Prompt, or a desktop or a UWP app to access a placeholder file, the file will hydrate without additional code changes and that app can use the file normally.</span></span>
* <span data-ttu-id="1d78b-123">Les fichiers peuvent exister dans trois États :</span><span class="sxs-lookup"><span data-stu-id="1d78b-123">Files can exist in three states:</span></span>
  * <span data-ttu-id="1d78b-124">**Fichier d’espace réservé**: représentation vide du fichier et disponible uniquement si le service de synchronisation est disponible.</span><span class="sxs-lookup"><span data-stu-id="1d78b-124">**Placeholder file**: An empty representation of the file and only available if the sync service is available.</span></span>
  * <span data-ttu-id="1d78b-125">**Fichier complet**: le fichier a été mis en attente implicitement et peut être mis en attente par le système si de l’espace est nécessaire.</span><span class="sxs-lookup"><span data-stu-id="1d78b-125">**Full file**: The file has been hydrated implicitly and could be dehydrated by the system if space is needed.</span></span>
  * <span data-ttu-id="1d78b-126">**Fichier complet épinglé**: le fichier a été mis en attente explicitement par l’utilisateur via l’Explorateur de fichiers et est assuré d’être disponible hors connexion.</span><span class="sxs-lookup"><span data-stu-id="1d78b-126">**Pinned full file**: The file has been hydrated explicitly by the user through File Explorer and is guaranteed to be available offline.</span></span>

<span data-ttu-id="1d78b-127">L’illustration suivante montre comment les États d’espace réservé, de remplissage complet et de fichier complet épinglé sont affichés dans l’Explorateur de fichiers.</span><span class="sxs-lookup"><span data-stu-id="1d78b-127">The following image demonstrates how the placeholder, full, and pinned full file states are shown in File Explorer.</span></span>

  ![Exemple de trois États de fichiers dans l’Explorateur de fichiers](images/cloud-file-states-file-explorer.png)

### <a name="standardized-sync-root-registration"></a><span data-ttu-id="1d78b-129">Inscription de la racine de synchronisation standardisée</span><span class="sxs-lookup"><span data-stu-id="1d78b-129">Standardized sync root registration</span></span>

* <span data-ttu-id="1d78b-130">L’inscription d’une racine de synchronisation est simple et standardisée.</span><span class="sxs-lookup"><span data-stu-id="1d78b-130">Registering a sync root is straightforward and standardized.</span></span> <span data-ttu-id="1d78b-131">Cela comprend la création d’un nœud de personnalisation dans le volet de navigation de l’Explorateur de fichiers, comme illustré dans la capture d’écran suivante.</span><span class="sxs-lookup"><span data-stu-id="1d78b-131">This includes creation of a branded node in the navigation pane of File Explorer, as shown in the following screenshot.</span></span> <span data-ttu-id="1d78b-132">Les racines peuvent être créées en tant qu’entrées de niveau supérieur individuelles ou en tant qu’enfants d’un regroupement parent.</span><span class="sxs-lookup"><span data-stu-id="1d78b-132">Roots can be created either as individual top-level entries, or as children of a parent grouping.</span></span>

  ![Exemple d’entrée racine de synchronisation dans l’Explorateur de fichiers](images/register-sync-root-file-explorer.png)

### <a name="shell-integration"></a><span data-ttu-id="1d78b-134">Intégration de Shell</span><span class="sxs-lookup"><span data-stu-id="1d78b-134">Shell integration</span></span>

* <span data-ttu-id="1d78b-135">Icônes d’État :</span><span class="sxs-lookup"><span data-stu-id="1d78b-135">State icons:</span></span>
  * <span data-ttu-id="1d78b-136">L’API fichiers Cloud fournit des icônes standardisées et automatiques d’état d’hydratation affichées dans l’Explorateur de fichiers et sur le bureau Windows.</span><span class="sxs-lookup"><span data-stu-id="1d78b-136">The cloud files API provides standardized, automatic hydration state icons shown in File Explorer and on the Windows desktop.</span></span>
  * <span data-ttu-id="1d78b-137">Outre les icônes d’État Windows standard utilisées pour l’état d’hydratation, vous pouvez fournir des icônes d’état personnalisées pour les propriétés supplémentaires spécifiques au service.</span><span class="sxs-lookup"><span data-stu-id="1d78b-137">In addition to the standard Windows state icons used for hydration state, you can provide custom state icons for additional service-specific properties.</span></span>
  * <span data-ttu-id="1d78b-138">Remplace les extensions d’environnement de superposition d’icône héritées.</span><span class="sxs-lookup"><span data-stu-id="1d78b-138">Replaces legacy icon overlay Shell extensions.</span></span>
* <span data-ttu-id="1d78b-139">Indication de la progression :</span><span class="sxs-lookup"><span data-stu-id="1d78b-139">Progress indication:</span></span>
  * <span data-ttu-id="1d78b-140">L’ouverture d’un fichier d’espace réservé qui prend plus de quelques secondes pour être en attente indique la progression de l’attente.</span><span class="sxs-lookup"><span data-stu-id="1d78b-140">Opening a placeholder file that takes more than a few seconds to hydrate will show hydration progress.</span></span> <span data-ttu-id="1d78b-141">La progression est affichée à quelques emplacements en fonction du contexte :</span><span class="sxs-lookup"><span data-stu-id="1d78b-141">Progress is shown in a few locations depending on context:</span></span>
    * <span data-ttu-id="1d78b-142">Dans une fenêtre de boîte de dialogue du moteur de copie.</span><span class="sxs-lookup"><span data-stu-id="1d78b-142">In a copy engine dialog window.</span></span>
    * <span data-ttu-id="1d78b-143">La progression Inline est affichée en regard du fichier dans l’Explorateur de fichiers.</span><span class="sxs-lookup"><span data-stu-id="1d78b-143">Inline progress is shown next to the file in File Explorer.</span></span>
    * <span data-ttu-id="1d78b-144">Si le fichier n’est pas ouvert à l’instruction spécifique de l’utilisateur, une notification Toast est présentée pour informer l’utilisateur et fournir un moyen de contrôler l’activité d’alimentation involontaire.</span><span class="sxs-lookup"><span data-stu-id="1d78b-144">If the file is not opened at the user’s specific instruction, a toast notification is shown to inform the user and provide a way to control unintended hydration activity.</span></span>
* <span data-ttu-id="1d78b-145">Miniatures et métadonnées :</span><span class="sxs-lookup"><span data-stu-id="1d78b-145">Thumbnails and metadata:</span></span>
  * <span data-ttu-id="1d78b-146">Les fichiers d’espace réservé peuvent avoir des miniatures riches en service et des métadonnées de fichier étendues pour fournir à l’utilisateur une expérience d’Explorateur de fichiers transparente.</span><span class="sxs-lookup"><span data-stu-id="1d78b-146">Placeholder files can have rich service-provided thumbnails and extended file metadata to provide the user with a seamless File Explorer experience.</span></span>
* <span data-ttu-id="1d78b-147">Volet de navigation de l’Explorateur de fichiers :</span><span class="sxs-lookup"><span data-stu-id="1d78b-147">File Explorer navigation pane:</span></span>
  * <span data-ttu-id="1d78b-148">L’inscription d’une racine de synchronisation avec l’API fichiers Cloud provoque l’affichage de la racine de synchronisation (avec une icône et un nom personnalisé) dans le volet de navigation de l’Explorateur de fichiers.</span><span class="sxs-lookup"><span data-stu-id="1d78b-148">Registering a sync root with the cloud files API causes that sync root (with an icon and custom name) to appear in File Explorer’s navigation pane.</span></span>
* <span data-ttu-id="1d78b-149">Menus contextuels de l’Explorateur de fichiers :</span><span class="sxs-lookup"><span data-stu-id="1d78b-149">File Explorer context menus:</span></span>
  * <span data-ttu-id="1d78b-150">L’inscription d’une racine de synchronisation avec l’API fichiers Cloud fournit automatiquement plusieurs verbes (entrées de menu) dans le menu contextuel de l’Explorateur de fichiers qui permettent à l’utilisateur de contrôler l’état d’hydratation de son fichier.</span><span class="sxs-lookup"><span data-stu-id="1d78b-150">Registering a sync root with the cloud files API automatically provides several verbs (menu entries) in File Explorer’s context menu that let the user control the hydration state of their file.</span></span>
  * <span data-ttu-id="1d78b-151">Des verbes supplémentaires peuvent être ajoutés à cette section du menu contextuel à l’aide des API compatibles Desktop Bridge.</span><span class="sxs-lookup"><span data-stu-id="1d78b-151">Additional verbs can be added to this section of the context menu using Desktop Bridge-compatible APIs.</span></span>
* <span data-ttu-id="1d78b-152">Contrôle utilisateur de l’hydratation de fichiers :</span><span class="sxs-lookup"><span data-stu-id="1d78b-152">User control of file hydration:</span></span>
  * <span data-ttu-id="1d78b-153">Les utilisateurs contrôlent toujours l’hydratation des fichiers, même si les fichiers ne sont pas alimentés explicitement par l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="1d78b-153">Users are always in control of file hydration, even when the files are not hydrated explicitly by the user.</span></span> <span data-ttu-id="1d78b-154">Un toast interactif est affiché pour l’hydratation en arrière-plan afin d’alerter l’utilisateur et de fournir des options.</span><span class="sxs-lookup"><span data-stu-id="1d78b-154">An interactive toast is shown for background hydration to alert the user and provide options.</span></span> <span data-ttu-id="1d78b-155">L’image suivante montre une notification toast pour un fichier hydratation.</span><span class="sxs-lookup"><span data-stu-id="1d78b-155">The following image demonstrates a toast notification for a hydrating file.</span></span>
    <span data-ttu-id="1d78b-156">![Exemple d’un toast interactif affiché pour l’attente de fichiers en arrière-plan](images/file-hydration-interactive-toast.png)</span><span class="sxs-lookup"><span data-stu-id="1d78b-156">![Example of an interactive toast shown for background file hydration](images/file-hydration-interactive-toast.png)</span></span>
  * <span data-ttu-id="1d78b-157">Si un utilisateur empêche une application d’en bloquer les fichiers par le biais d’un toast interactif, elle peut débloquer l’application dans la page de **téléchargement automatique des fichiers** dans **paramètres**.</span><span class="sxs-lookup"><span data-stu-id="1d78b-157">If a user blocks an app from hydrating files through an interactive toast, they can unblock the app in the **Automatic file downloads** page in **Settings**.</span></span>
    <span data-ttu-id="1d78b-158">![Capture d’écran du paramètre de téléchargement automatique des fichiers](images/allow-automatic-file-downloads-setting.png)</span><span class="sxs-lookup"><span data-stu-id="1d78b-158">![Screenshot of the automatic file downloads setting](images/allow-automatic-file-downloads-setting.png)</span></span>
* <span data-ttu-id="1d78b-159">Raccordement des opérations du moteur de copie (pris en charge dans Windows 10 Insider preview version 19624 et versions ultérieures) :</span><span class="sxs-lookup"><span data-stu-id="1d78b-159">Hooking copy engine operations (supported in Windows 10 Insider Preview Build 19624 and later versions):</span></span>
  * <span data-ttu-id="1d78b-160">Les fournisseurs de stockage cloud peuvent inscrire un hook de copie de Shell pour analyser les opérations de fichiers au sein de leur racine de synchronisation.</span><span class="sxs-lookup"><span data-stu-id="1d78b-160">Cloud storage providers can register a shell copy hook for monitoring file operations within their sync root.</span></span>
  * <span data-ttu-id="1d78b-161">Le fournisseur inscrit son raccordement de copie en affectant à la valeur de Registre **CopyHook** sous sa clé de Registre racine de synchronisation le CLSID de l’objet serveur local com.</span><span class="sxs-lookup"><span data-stu-id="1d78b-161">The provider registers their copy hook by setting the **CopyHook** registry value under their sync root registry key to a the CLSID of their COM local server object.</span></span> <span data-ttu-id="1d78b-162">Cet objet serveur local implémente l’interface [IStorageProviderCopyHook](../shell/nn-shobjidl-istorageprovidercopyhook.md) .</span><span class="sxs-lookup"><span data-stu-id="1d78b-162">This local server object implements the [IStorageProviderCopyHook](../shell/nn-shobjidl-istorageprovidercopyhook.md) interface.</span></span>

### <a name="desktop-bridge"></a><span data-ttu-id="1d78b-163">Pont du bureau</span><span class="sxs-lookup"><span data-stu-id="1d78b-163">Desktop Bridge</span></span>

* <span data-ttu-id="1d78b-164">Les moteurs de synchronisation utilisant les API de fichiers Cloud sont conçus pour utiliser le [pont Desktop](/windows/uwp/porting/desktop-to-uwp-root) comme condition d’implémentation.</span><span class="sxs-lookup"><span data-stu-id="1d78b-164">Sync engines using the cloud files APIs are designed to use the [Desktop Bridge](/windows/uwp/porting/desktop-to-uwp-root) as an implementation requirement.</span></span>

## <a name="cloud-mirror-sample"></a><span data-ttu-id="1d78b-165">Exemple de miroir Cloud</span><span class="sxs-lookup"><span data-stu-id="1d78b-165">Cloud Mirror sample</span></span>

<span data-ttu-id="1d78b-166">L' [exemple Cloud Mirror](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/CloudMirror) illustre la création d’une solution qui utilise l’API de fichiers Cloud.</span><span class="sxs-lookup"><span data-stu-id="1d78b-166">The [Cloud Mirror sample](https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/CloudMirror) illustrates how to build a solution that uses the cloud files API.</span></span> <span data-ttu-id="1d78b-167">Il n’est pas destiné à être utilisé comme code de production.</span><span class="sxs-lookup"><span data-stu-id="1d78b-167">It is not intended to be used as production code.</span></span> <span data-ttu-id="1d78b-168">Il manque une gestion fiable des erreurs et il est conçu pour être aussi facilement compréhensible que possible.</span><span class="sxs-lookup"><span data-stu-id="1d78b-168">It lacks robust error handling and it is written to be as easily understood as possible.</span></span> <span data-ttu-id="1d78b-169">Il s’agit d’un miroir Cloud, car il reflète simplement un dossier local sur votre disque local.</span><span class="sxs-lookup"><span data-stu-id="1d78b-169">It's called Cloud Mirror because it simply mirrors a local folder on your local disk.</span></span> <span data-ttu-id="1d78b-170">Vous spécifiez un dossier de serveur destiné à représenter votre serveur de fichiers Cloud et un dossier client destiné à spécifier le chemin d’accès racine de synchronisation.</span><span class="sxs-lookup"><span data-stu-id="1d78b-170">You specify a server folder that is meant to represent your cloud file server and a client folder that is meant to specify the sync root path.</span></span> <span data-ttu-id="1d78b-171">Un nœud de niveau supérieur apparaît dans le volet de navigation de l’Explorateur de fichiers appelé **TestStorageProviderDisplayName**, et ce nœud est mappé au dossier client spécifié.</span><span class="sxs-lookup"><span data-stu-id="1d78b-171">A top-level node appears in the navigation pane in File Explorer called **TestStorageProviderDisplayName**, and this node maps to the specified client folder.</span></span>

<span data-ttu-id="1d78b-172">Lorsqu’il s’agit de la synchronisation, il s’agit des éléments qu’un fournisseur de synchronisation de fichiers Cloud entièrement développé doit implémenter :</span><span class="sxs-lookup"><span data-stu-id="1d78b-172">When it comes to syncing, these are the things that a fully-developed cloud files sync provider must implement:</span></span>

* <span data-ttu-id="1d78b-173">Lorsque le fichier racine de synchronisation est simplement un espace réservé, le service est responsable de la copie du contenu du fichier pour l’hydratation.</span><span class="sxs-lookup"><span data-stu-id="1d78b-173">When the sync root file is just a placeholder, the service is responsible for copying down the contents of the file for hydration.</span></span> <span data-ttu-id="1d78b-174">Elle est implémentée dans l’exemple.</span><span class="sxs-lookup"><span data-stu-id="1d78b-174">This is implemented in the sample.</span></span>
* <span data-ttu-id="1d78b-175">Lorsque le fichier racine de synchronisation est un fichier complet et que le contenu du fichier dans le service Cloud change, le service est chargé de notifier le client de synchronisation local de la modification et le client de synchronisation local doit gérer les fusions en fonction de leurs propres spécifications.</span><span class="sxs-lookup"><span data-stu-id="1d78b-175">When the sync root file is a full file and the contents of the file in the cloud service change, the service is responsible of notifying the local sync client of the change and the local sync client must handle merges according to their own specifications.</span></span> <span data-ttu-id="1d78b-176">Cela n’est pas implémenté dans l’exemple.</span><span class="sxs-lookup"><span data-stu-id="1d78b-176">This is not implemented in the sample.</span></span>
* <span data-ttu-id="1d78b-177">Lorsque le fichier racine de synchronisation est un fichier complet et que le contenu du fichier dans le chemin racine de synchronisation (client local) change, le client de synchronisation local doit notifier le service Cloud et gérer les fusions en fonction de leurs propres spécifications.</span><span class="sxs-lookup"><span data-stu-id="1d78b-177">When the sync root file is a full file and the contents of the file in the sync root path (the local client) change, the local sync client must notify the cloud service and handle merges according to their own specifications.</span></span> <span data-ttu-id="1d78b-178">La notification de modification de fichier local est implémentée dans l’exemple, mais elle ne fait rien.</span><span class="sxs-lookup"><span data-stu-id="1d78b-178">The local file change notification is implemented in the sample, but it does not do anything.</span></span>

### <a name="use-the-sample"></a><span data-ttu-id="1d78b-179">Utiliser l’exemple</span><span class="sxs-lookup"><span data-stu-id="1d78b-179">Use the sample</span></span>

1. <span data-ttu-id="1d78b-180">Créez deux dossiers sur votre disque dur local.</span><span class="sxs-lookup"><span data-stu-id="1d78b-180">Create two folders on your local hard drive.</span></span> <span data-ttu-id="1d78b-181">L’un d’eux fera office de serveur et l’autre en tant que client.</span><span class="sxs-lookup"><span data-stu-id="1d78b-181">One of them will act as the server and the other as the client.</span></span>
2. <span data-ttu-id="1d78b-182">Ajoutez des fichiers au dossier serveur.</span><span class="sxs-lookup"><span data-stu-id="1d78b-182">Add some files to the server folder.</span></span> <span data-ttu-id="1d78b-183">Assurez-vous que le dossier client est vide.</span><span class="sxs-lookup"><span data-stu-id="1d78b-183">Make sure the client folder is empty.</span></span>
3. <span data-ttu-id="1d78b-184">Ouvrez l’exemple de miroir Cloud dans Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="1d78b-184">Open the Cloud Mirror sample in Visual Studio.</span></span> <span data-ttu-id="1d78b-185">Définissez le projet **CloudMirrorPackage** comme projet de démarrage, puis générez et exécutez l’exemple.</span><span class="sxs-lookup"><span data-stu-id="1d78b-185">Set the **CloudMirrorPackage** project as your startup project and then build and run the sample.</span></span> <span data-ttu-id="1d78b-186">Lorsque l’exemple vous y invite, entrez les deux chemins d’accès à vos dossiers serveur et client.</span><span class="sxs-lookup"><span data-stu-id="1d78b-186">When prompted by the sample, enter the two paths to your server and client folders.</span></span> <span data-ttu-id="1d78b-187">Après cela, vous verrez une fenêtre de console avec des informations de diagnostic.</span><span class="sxs-lookup"><span data-stu-id="1d78b-187">After this you will see a console window with diagnostic information.</span></span>
4. <span data-ttu-id="1d78b-188">Ouvrez l’Explorateur de fichiers et vérifiez que vous voyez le nœud **TestStorageProviderDisplayName** et les espaces réservés pour tous les fichiers que vous avez copiés dans le dossier serveur.</span><span class="sxs-lookup"><span data-stu-id="1d78b-188">Open File Explorer and confirm that you see the **TestStorageProviderDisplayName** node and the placeholders for all the files that you copied into the server folder.</span></span> <span data-ttu-id="1d78b-189">Pour simuler une application qui tente d’ouvrir des fichiers sans utiliser le sélecteur, copiez plusieurs images dans le dossier serveur.</span><span class="sxs-lookup"><span data-stu-id="1d78b-189">To simulate an application that tries to open files without using the picker, copy several images to the server folder.</span></span> <span data-ttu-id="1d78b-190">Double-cliquez sur l’un d’entre eux dans votre dossier racine de synchronisation et confirmez qu’il est en attente.</span><span class="sxs-lookup"><span data-stu-id="1d78b-190">Double-click one of them in your sync root folder and confirm that it hydrates.</span></span> <span data-ttu-id="1d78b-191">Ensuite, ouvrez l’application photos.</span><span class="sxs-lookup"><span data-stu-id="1d78b-191">Then, open the Photos app.</span></span> <span data-ttu-id="1d78b-192">L’application préchargera les fichiers adjacents en arrière-plan pour augmenter la probabilité que l’utilisateur ne rencontre pas de retards lors de la consultation des autres images.</span><span class="sxs-lookup"><span data-stu-id="1d78b-192">The app will pre-load adjacent files in the background to make it more likely the user does not experience delays when looking through the other pictures.</span></span> <span data-ttu-id="1d78b-193">Vous pouvez observer que la mise en attente de l’arrière-plan se produit via des toasts ou dans l’Explorateur de fichiers.</span><span class="sxs-lookup"><span data-stu-id="1d78b-193">You can observe the background dehydration happen via toasts or in File Explorer.</span></span>
5. <span data-ttu-id="1d78b-194">Cliquez avec le bouton droit sur un fichier dans l’Explorateur de fichiers pour afficher un menu contextuel et vérifiez que l’élément de menu **test** s’affiche.</span><span class="sxs-lookup"><span data-stu-id="1d78b-194">Right-click a file in File Explorer to bring up a context menu, and confirm that you see the **TestCommand** menu item.</span></span> <span data-ttu-id="1d78b-195">Cliquez sur cet élément de menu pour afficher une boîte de message.</span><span class="sxs-lookup"><span data-stu-id="1d78b-195">Clicking this menu item will display a message box.</span></span>
6. <span data-ttu-id="1d78b-196">Pour arrêter l’exemple, définissez le focus sur la sortie de la console et appuyez sur **Ctrl-C**.</span><span class="sxs-lookup"><span data-stu-id="1d78b-196">To stop the sample, set focus to the console output and press **Ctrl-C**.</span></span> <span data-ttu-id="1d78b-197">Cela permet de nettoyer l’inscription de la racine de synchronisation afin que le fournisseur soit désinstallé.</span><span class="sxs-lookup"><span data-stu-id="1d78b-197">This will cleanup the sync root registration so that the provider is uninstalled.</span></span> <span data-ttu-id="1d78b-198">Si l’exemple se bloque, il est possible que la racine de synchronisation reste inscrite.</span><span class="sxs-lookup"><span data-stu-id="1d78b-198">If the sample crashes, it’s possible that the sync root will remain registered.</span></span> <span data-ttu-id="1d78b-199">Cela entraînera le redémarrage de l’Explorateur de fichiers chaque fois que vous cliquerez sur quoi que ce soit, et vous seriez invité à entrer les emplacements fictifs du client et du serveur.</span><span class="sxs-lookup"><span data-stu-id="1d78b-199">This will cause File Explorer to relaunch every time you click on anything, and you would get prompted for the fake client and server locations.</span></span> <span data-ttu-id="1d78b-200">Si cela se produit, désinstallez l’exemple d’application **CloudMirrorPackage** sur votre ordinateur.</span><span class="sxs-lookup"><span data-stu-id="1d78b-200">If this occurs, uninstall the **CloudMirrorPackage** sample application from your computer.</span></span>

### <a name="sample-architecture"></a><span data-ttu-id="1d78b-201">Exemple d’architecture</span><span class="sxs-lookup"><span data-stu-id="1d78b-201">Sample architecture</span></span>

<span data-ttu-id="1d78b-202">L’exemple est délibérément simple.</span><span class="sxs-lookup"><span data-stu-id="1d78b-202">The sample is deliberately simple.</span></span> <span data-ttu-id="1d78b-203">Il utilise des classes statiques pour éviter de passer des pointeurs d’instance.</span><span class="sxs-lookup"><span data-stu-id="1d78b-203">It uses static classes to make it unnecessary to pass instance pointers.</span></span> <span data-ttu-id="1d78b-204">Voici les principales classes de l’exemple :</span><span class="sxs-lookup"><span data-stu-id="1d78b-204">Here are the main classes in the sample:</span></span>

* <span data-ttu-id="1d78b-205">**FakeCloudProvider**: cette classe de niveau supérieur contrôle les classes de travail suivantes :</span><span class="sxs-lookup"><span data-stu-id="1d78b-205">**FakeCloudProvider**: This top-level class controls the following worker classes:</span></span>
  * <span data-ttu-id="1d78b-206">**CloudProviderRegistrar**: enregistre les informations de la racine de synchronisation avec le shell Windows.</span><span class="sxs-lookup"><span data-stu-id="1d78b-206">**CloudProviderRegistrar**: Registers the sync root information with the Windows Shell.</span></span>
  * <span data-ttu-id="1d78b-207">**Espaces réservés**: génère les fichiers d’espace réservé dans le chemin racine de synchronisation.</span><span class="sxs-lookup"><span data-stu-id="1d78b-207">**Placeholders**: Generates the placeholder files in the sync root path.</span></span>
  * <span data-ttu-id="1d78b-208">**ShellServices**: construit les fournisseurs de shell Windows pour le menu contextuel, les miniatures et d’autres services.</span><span class="sxs-lookup"><span data-stu-id="1d78b-208">**ShellServices**: Constructs the Windows Shell providers for the context menu, thumbnails, and other services.</span></span>
  * <span data-ttu-id="1d78b-209">**CloudProviderSyncRootWatcher**: instancie un DirectoryWatcher pour surveiller les modifications apportées au chemin d’accès racine de synchronisation et agir sur les modifications.</span><span class="sxs-lookup"><span data-stu-id="1d78b-209">**CloudProviderSyncRootWatcher**: Instantiates a DirectoryWatcher to monitor changes to the sync root path and act on changes.</span></span>
  * <span data-ttu-id="1d78b-210">**FileCopierWithProgress**: copie les fichiers du dossier du serveur vers le dossier client, lentement en segments pour simuler leur téléchargement à partir d’un serveur Cloud réel.</span><span class="sxs-lookup"><span data-stu-id="1d78b-210">**FileCopierWithProgress**: Copies files from the server folder to the client folder slowly in chunks to simulate downloading them from a real cloud server.</span></span> <span data-ttu-id="1d78b-211">Fournit une indication de progression afin que les toasts et l’interface utilisateur de l’Explorateur de fichiers affichent l’information sur l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="1d78b-211">Provides progress indication so that toasts and File Explorer UI shows the user something informative.</span></span>

<span data-ttu-id="1d78b-212">Outre les classes ci-dessus, l’exemple fournit également plusieurs classes d’assistance pour inviter l’utilisateur à fournir des dossiers et certains utilitaires.</span><span class="sxs-lookup"><span data-stu-id="1d78b-212">In addition to the classes above, the sample also provides several helper classes to prompt the user for folders and some utilities.</span></span> <span data-ttu-id="1d78b-213">**TestExplorerCommandHandler**, **CustomStateProvider**, **ThumbnailProvider** et **uriSource** sont tous des exemples de fournisseurs de services de Shell.</span><span class="sxs-lookup"><span data-stu-id="1d78b-213">The **TestExplorerCommandHandler**, **CustomStateProvider**, **ThumbnailProvider**, and **UriSource** are all examples of Shell service providers.</span></span>

## <a name="cloud-files-api-architecture"></a><span data-ttu-id="1d78b-214">Architecture des API de fichiers Cloud</span><span class="sxs-lookup"><span data-stu-id="1d78b-214">Cloud files API architecture</span></span>

<span data-ttu-id="1d78b-215">Au cœur de la pile de stockage dans l’API des fichiers Cloud se trouve un pilote de minifiltre de système de fichiers appelé cldflt.sys.</span><span class="sxs-lookup"><span data-stu-id="1d78b-215">At the core of the storage stack in the cloud files API is a file system minifilter driver called cldflt.sys.</span></span> <span data-ttu-id="1d78b-216">Ce pilote agit comme un proxy entre les applications de l’utilisateur et votre moteur de synchronisation.</span><span class="sxs-lookup"><span data-stu-id="1d78b-216">This driver acts as a proxy between the user’s applications and your sync engine.</span></span> <span data-ttu-id="1d78b-217">Votre moteur de synchronisation sait comment télécharger et télécharger les données à la demande, alors qu’il est responsable de cldflt.sys à utiliser l’interpréteur de commandes pour présenter des fichiers comme si les données Cloud étaient disponibles localement.</span><span class="sxs-lookup"><span data-stu-id="1d78b-217">Your sync engine knows how to download and upload the data on demand while it is responsibility of cldflt.sys to work with the Shell to present files as if the cloud data were locally available.</span></span>

<span data-ttu-id="1d78b-218">Cldflt.sys prend actuellement en charge uniquement les volumes NTFS, car cela dépend de certaines fonctionnalités propres à NTFS.</span><span class="sxs-lookup"><span data-stu-id="1d78b-218">Cldflt.sys currently only supports NTFS volumes because it depends on some features unique to NTFS.</span></span>

<span data-ttu-id="1d78b-219">Il existe de nombreux pilotes de minifiltre de système de fichiers dans un système qui peuvent être actifs simultanément sur un volume donné.</span><span class="sxs-lookup"><span data-stu-id="1d78b-219">There are many file system minifilter drivers in a system and they can be active on a given volume at the same time.</span></span> <span data-ttu-id="1d78b-220">Les pilotes qui sont le plus intéressants pour l’API des fichiers Cloud sont les filtres du système de fichiers antivirus.</span><span class="sxs-lookup"><span data-stu-id="1d78b-220">The drivers that are of most interest to the cloud files API are the anti-virus file system filters.</span></span>

<span data-ttu-id="1d78b-221">Les pilotes de minifiltre du système de fichiers sont gérés et pris en charge par un composant en mode noyau spécial appelé gestionnaire de filtres.</span><span class="sxs-lookup"><span data-stu-id="1d78b-221">File system minifilter drivers are managed and supported by a special kernel-mode component called the filter manager.</span></span> <span data-ttu-id="1d78b-222">Entre autres tâches, le gestionnaire de filtres facilite la communication non filtrée entre les filtres et les composants du mode utilisateur via une construction appelée port de message de filtre.</span><span class="sxs-lookup"><span data-stu-id="1d78b-222">Among many other duties, the filter manager facilitates unfiltered communication between filters and user mode components via a construct known as filter message port.</span></span>

## <a name="hydration-policies"></a><span data-ttu-id="1d78b-223">Stratégies d’hydratation</span><span class="sxs-lookup"><span data-stu-id="1d78b-223">Hydration Policies</span></span>

<span data-ttu-id="1d78b-224">Windows prend en charge une grande variété de [stratégies d’hydratation principales](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_primary) et de modificateurs de [stratégie d’hydratation secondaire](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_modifier) .</span><span class="sxs-lookup"><span data-stu-id="1d78b-224">Windows supports a variety of [primary hydration policies](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_primary) and [secondary hydration policy](/windows/desktop/api/cfapi/ne-cfapi-cf_hydration_policy_modifier) modifiers.</span></span> <span data-ttu-id="1d78b-225">Les stratégies de mise en attente principales sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="1d78b-225">Primary hydration policies have this order:</span></span>

  <span data-ttu-id="1d78b-226">**Toujours plein > > progressif complet > partiel**</span><span class="sxs-lookup"><span data-stu-id="1d78b-226">**Always full > Full > Progressive > Partial**</span></span>

<span data-ttu-id="1d78b-227">Les applications et les moteurs de synchronisation peuvent définir la stratégie d’alimentation principale par défaut.</span><span class="sxs-lookup"><span data-stu-id="1d78b-227">Both applications and sync engines can define their preferred primary hydration policy.</span></span> <span data-ttu-id="1d78b-228">S’il n’est pas spécifié, la stratégie d’hydratation par défaut est progressive pour les applications et les moteurs de synchronisation.</span><span class="sxs-lookup"><span data-stu-id="1d78b-228">If not specified, the default hydration policy is progressive for both applications and sync engines.</span></span>

<span data-ttu-id="1d78b-229">La stratégie d’hydratation d’un fichier Cloud est déterminée au moment de l’ouverture du fichier par la formule suivante :</span><span class="sxs-lookup"><span data-stu-id="1d78b-229">The hydration policy of a cloud file is determined at the file open time by this formula:</span></span>

  ```File hydration policy = max(app hydration policy, provider hydration policy)```

<span data-ttu-id="1d78b-230">Supposons, par exemple, que l’utilisateur essaie d’ouvrir un fichier PDF stocké sur le lecteur Cloud Fabrikam à l’aide de la visionneuse PDF contoso, qui ne spécifie pas de stratégie d’hydratation préférée.</span><span class="sxs-lookup"><span data-stu-id="1d78b-230">For example, let’s say the user is trying to open a PDF file stored on Fabrikam Cloud Drive using Contoso PDF Viewer, which doesn’t specify a preferred hydration policy.</span></span> <span data-ttu-id="1d78b-231">La stratégie d’hydratation d’application est donc une alimentation progressive, dans ce cas par défaut.</span><span class="sxs-lookup"><span data-stu-id="1d78b-231">The application hydration policy is therefore progressive hydration, in this case by default.</span></span> <span data-ttu-id="1d78b-232">Toutefois, étant donné que le lecteur Cloud Fabrikam est un moteur de synchronisation en alimentation complète, la stratégie finale d’hydratation sur le fichier devient une alimentation complète, ce qui entraîne l’alimentation intégrale du fichier au premier accès.</span><span class="sxs-lookup"><span data-stu-id="1d78b-232">However, because Fabrikam Cloud Drive is a full hydration sync engine, the final hydration policy on the file becomes full hydration, which will result in the file being fully hydrated on first access.</span></span> <span data-ttu-id="1d78b-233">Le même résultat se produit dans les cas où le moteur de synchronisation prend en charge l’hydratation progressive, mais la préférence de l’application est l’hydratation complète.</span><span class="sxs-lookup"><span data-stu-id="1d78b-233">The same outcome happens in cases where the sync engine supports progressive hydration, but the app’s preference is full hydration.</span></span>

<span data-ttu-id="1d78b-234">Notez que la stratégie d’alimentation des fichiers ne peut pas être modifiée une fois que le fichier est ouvert.</span><span class="sxs-lookup"><span data-stu-id="1d78b-234">Note that the file hydration policy cannot be changed after the file is opened.</span></span>

## <a name="compatibility-with-applications-that-use-reparse-points"></a><span data-ttu-id="1d78b-235">Compatibilité avec les applications qui utilisent des points d’analyse</span><span class="sxs-lookup"><span data-stu-id="1d78b-235">Compatibility with applications that use reparse points</span></span>

<span data-ttu-id="1d78b-236">L’API de fichiers Cloud implémente le système d’espace réservé à l’aide de [points d’analyse](/windows/desktop/FileIO/reparse-points).</span><span class="sxs-lookup"><span data-stu-id="1d78b-236">The cloud files API implements the placeholder system using [reparse points](/windows/desktop/FileIO/reparse-points).</span></span> <span data-ttu-id="1d78b-237">La fausse idée des points d’analyse est qu’ils sont identiques aux liens symboliques.</span><span class="sxs-lookup"><span data-stu-id="1d78b-237">A common misconception about reparse points is that they are the same as symbolic links.</span></span> <span data-ttu-id="1d78b-238">Cette idée fausse est parfois reflétée dans les implémentations d’application et, par conséquent, de nombreuses applications existantes ont rencontré des erreurs lors de la rencontre d’un point d’analyse.</span><span class="sxs-lookup"><span data-stu-id="1d78b-238">This misconception is occasionally reflected in application implementations, and as a result, many existing applications hit errors when encountering any reparse point.</span></span>

<span data-ttu-id="1d78b-239">Pour atténuer ce problème de compatibilité, l’API de fichiers Cloud masque toujours ses points d’analyse à partir de toutes les applications, à l’exception des moteurs de synchronisation et des processus dont l’image principale réside sous **% systemroot%**.</span><span class="sxs-lookup"><span data-stu-id="1d78b-239">To mitigate this compatibility issue, the cloud files API always hides its reparse points from all applications except for sync engines and processes whose main image resides under **%systemroot%**.</span></span> <span data-ttu-id="1d78b-240">Les applications qui comprennent correctement les points d’analyse peuvent forcer la plateforme à exposer des points d’analyse de l’API des fichiers Cloud à l’aide de [RtlSetProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetprocessplaceholdercompatibilitymode) ou [RtlSetThreadProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetthreadplaceholdercompatibilitymode).</span><span class="sxs-lookup"><span data-stu-id="1d78b-240">Applications that understand reparse points correctly can force the platform to expose cloud files API reparse points using [RtlSetProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetprocessplaceholdercompatibilitymode) or [RtlSetThreadProcessPlaceholderCompatibilityMode](/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-rtlsetthreadplaceholdercompatibilitymode).</span></span>