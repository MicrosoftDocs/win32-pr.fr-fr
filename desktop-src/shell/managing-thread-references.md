---
description: Cet article contient des informations sur la gestion des références de thread à l’aide des fonctions des fonctions utilitaires légères de l’interpréteur de commandes.
ms.assetid: d8d479fd-c45a-4dfa-b496-76abc7c09a42
title: Gestion des références de thread
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: b629cd97c99e3b30e66810b5f54720d0dbb1c87d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "104973367"
---
# <a name="managing-thread-references"></a><span data-ttu-id="310c0-103">Gestion des références de thread</span><span class="sxs-lookup"><span data-stu-id="310c0-103">Managing Thread References</span></span>

<span data-ttu-id="310c0-104">Cet article contient des informations sur la gestion des références de thread à l’aide des fonctions des fonctions utilitaires légères de l’interpréteur de commandes.</span><span class="sxs-lookup"><span data-stu-id="310c0-104">This article contains information about the management of thread references using functions from the Shell lightweight utility functions.</span></span>


<span data-ttu-id="310c0-105">Des situations se produisent lorsqu’un thread parent doit être maintenu actif pendant la durée de vie d’un thread enfant.</span><span class="sxs-lookup"><span data-stu-id="310c0-105">Situations arise when a parent thread must be kept active for the lifetime of a child thread.</span></span> <span data-ttu-id="310c0-106">Par exemple, si un objet COM (Component Object Model) est créé sur le thread parent et marshalé vers le thread enfant, ce thread parent ne peut pas se terminer avant le thread enfant.</span><span class="sxs-lookup"><span data-stu-id="310c0-106">For instance, if a Component Object Model (COM) object is created on the parent thread and marshaled to the child thread, that parent thread cannot terminate before the child thread.</span></span> <span data-ttu-id="310c0-107">Pour ce faire, l’interpréteur de commandes fournit ces fonctions.</span><span class="sxs-lookup"><span data-stu-id="310c0-107">To accomplish this, the Shell provides these functions.</span></span>

-   [<span data-ttu-id="310c0-108">**SHCreateThreadRef**</span><span class="sxs-lookup"><span data-stu-id="310c0-108">**SHCreateThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref)
-   [<span data-ttu-id="310c0-109">**SHSetThreadRef**</span><span class="sxs-lookup"><span data-stu-id="310c0-109">**SHSetThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref)
-   [<span data-ttu-id="310c0-110">**SHGetThreadRef**</span><span class="sxs-lookup"><span data-stu-id="310c0-110">**SHGetThreadRef**</span></span>](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref)

<span data-ttu-id="310c0-111">Utilisez ces fonctions dans votre thread parent comme indiqué ici.</span><span class="sxs-lookup"><span data-stu-id="310c0-111">Use these functions in your parent thread as outlined here.</span></span>

1.  <span data-ttu-id="310c0-112">Déclarez une procédure de thread définie par l’application suivant la forme de la fonction [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) .</span><span class="sxs-lookup"><span data-stu-id="310c0-112">Declare an application-defined thread procedure following the form of the [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) function.</span></span>

    ``` syntax
    DWORD WINAPI ThreadProc(LPVOID lpParameter);
    ```

2.  <span data-ttu-id="310c0-113">Dans votre [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)), appelez [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) pour créer une référence au thread.</span><span class="sxs-lookup"><span data-stu-id="310c0-113">In your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)), call [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) to create a reference to the thread.</span></span> <span data-ttu-id="310c0-114">Cela fournit un pointeur vers une instance de [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown).</span><span class="sxs-lookup"><span data-stu-id="310c0-114">This provides a pointer to an instance of [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown).</span></span> <span data-ttu-id="310c0-115">Ce **IUnknown** utilise la valeur pointée par *pcRef* pour conserver un décompte de références.</span><span class="sxs-lookup"><span data-stu-id="310c0-115">This **IUnknown** uses the value pointed to by *pcRef* to maintain a reference count.</span></span> <span data-ttu-id="310c0-116">Tant que ce nombre est supérieur à 0, le thread reste actif.</span><span class="sxs-lookup"><span data-stu-id="310c0-116">As long as this count is greater than 0, the thread remains active.</span></span>
3.  <span data-ttu-id="310c0-117">En utilisant ce pointeur vers [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), appelez [**SHSetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref) dans votre [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="310c0-117">Using that pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown), call [**SHSetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shsetthreadref) in your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)).</span></span> <span data-ttu-id="310c0-118">Cela définit la référence afin que les appels suivants à [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) aient une valeur à récupérer.</span><span class="sxs-lookup"><span data-stu-id="310c0-118">This sets the reference so that subsequent calls to [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) have something to retrieve.</span></span>
4.  <span data-ttu-id="310c0-119">Si votre [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) crée un autre thread, le *ThreadProc* de ce thread peut appeler [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) avec le pointeur vers [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtenu par [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref).</span><span class="sxs-lookup"><span data-stu-id="310c0-119">If your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) creates another thread, that thread's *ThreadProc* can call [**SHGetThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shgetthreadref) with the pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtained by [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref).</span></span> <span data-ttu-id="310c0-120">Cela incrémente le nombre de références vers lequel pointe le paramètre *pcRef* dans **SHCreateThreadRef**.</span><span class="sxs-lookup"><span data-stu-id="310c0-120">This increments the reference count pointed to by the *pcRef* parameter in **SHCreateThreadRef**.</span></span>
5.  <span data-ttu-id="310c0-121">Créez le thread.</span><span class="sxs-lookup"><span data-stu-id="310c0-121">Create the thread.</span></span> <span data-ttu-id="310c0-122">Cela s’effectue généralement en appelant [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread), en passant un pointeur à votre [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) dans le paramètre *pfnThreadProc* .</span><span class="sxs-lookup"><span data-stu-id="310c0-122">This is usually done by calling [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread), passing a pointer to your [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) in the *pfnThreadProc* parameter.</span></span> <span data-ttu-id="310c0-123">Transmettez également l' \_ \_ indicateur de référence de thread CTF dans le paramètre *dwFlags* .</span><span class="sxs-lookup"><span data-stu-id="310c0-123">Also pass the CTF\_THREAD\_REF flag in the *dwFlags* parameter.</span></span> <span data-ttu-id="310c0-124">Le thread est actif tant que *ThreadProc* est en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="310c0-124">The thread is active as long as *ThreadProc* is executing.</span></span>
6.  <span data-ttu-id="310c0-125">Quand un thread enfant est créé, transmettez l’indicateur **CTF \_ Ref \_ compté** dans le paramètre *dwFlags* de l’appel à son [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread).</span><span class="sxs-lookup"><span data-stu-id="310c0-125">When a child thread is created, pass the **CTF\_REF\_COUNTED** flag in the *dwFlags* parameter in the call to its [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread).</span></span>
7.  <span data-ttu-id="310c0-126">À mesure que les threads enfants sont terminés et libérés, la valeur vers laquelle pointe le *pcRef* du thread parent diminue.</span><span class="sxs-lookup"><span data-stu-id="310c0-126">As child threads complete and are released, the value pointed to by the parent thread's *pcRef* decreases.</span></span> <span data-ttu-id="310c0-127">Une fois tous les threads enfants terminés, le [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) d’origine peut terminer et libérer la référence de thread finale, en supprimant le décompte de références à 0.</span><span class="sxs-lookup"><span data-stu-id="310c0-127">Once all child threads are complete, the original [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) can complete and release the final thread reference, dropping the reference count to 0.</span></span> <span data-ttu-id="310c0-128">À ce stade, la référence au thread d’origine ouvert par [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) est libérée et le thread est terminé.</span><span class="sxs-lookup"><span data-stu-id="310c0-128">At that point, the reference to the original thread opened by [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) is released and the thread completed.</span></span>

<span data-ttu-id="310c0-129">Une autre fonction associée est [**SHReleaseThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shreleasethreadref).</span><span class="sxs-lookup"><span data-stu-id="310c0-129">Another related function is [**SHReleaseThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shreleasethreadref).</span></span> <span data-ttu-id="310c0-130">Cette fonction est appelée par [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) si le thread a été créé à l’aide de [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) avec l’indicateur de **\_ \_ référence de thread CTF** .</span><span class="sxs-lookup"><span data-stu-id="310c0-130">This function is called by the [*ThreadProc*](/previous-versions/windows/desktop/legacy/ms686736(v=vs.85)) if the thread has been created using [**SHCreateThread**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethread) with the **CTF\_THREAD\_REF** flag.</span></span> <span data-ttu-id="310c0-131">Toutefois, l’opération *ThreadProc* n’est pas nécessaire pour le faire implicitement.</span><span class="sxs-lookup"><span data-stu-id="310c0-131">However, the *ThreadProc* is not required to do so implicitly.</span></span> <span data-ttu-id="310c0-132">L’appel de [**IUnknown :: Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) sur le pointeur vers [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtenu par le biais de [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) est tout ce qui doit être effectué.</span><span class="sxs-lookup"><span data-stu-id="310c0-132">Calling [**IUnknown::Release**](/windows/win32/api/unknwn/nf-unknwn-iunknown-release) on the pointer to [**IUnknown**](/windows/win32/api/unknwn/nn-unknwn-iunknown) obtained through [**SHCreateThreadRef**](/windows/desktop/api/Shlwapi/nf-shlwapi-shcreatethreadref) is all that needs to be done.</span></span>

 

 
