---
title: Modification des interfaces d’une manière à compatibilité descendante
description: Les méthodes expliquées dans la théorie de la gestion des versions pour RPC et COM peuvent être inacceptables pour de nombreuses raisons.
ms.assetid: 7dec4b67-3d50-453f-b0ef-290d091186fd
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 314daecc6b55aaf4a348411010eb578149f86921
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/20/2020
ms.locfileid: "103729804"
---
# <a name="changing-interfaces-in-a-backward-compatible-manner"></a><span data-ttu-id="c5305-103">Modification des interfaces d’une manière à compatibilité descendante</span><span class="sxs-lookup"><span data-stu-id="c5305-103">Changing Interfaces in a Backward Compatible Manner</span></span>

<span data-ttu-id="c5305-104">Les méthodes expliquées dans [la théorie de la gestion des versions pour RPC et com](the-versioning-theory-for-rpc-and-com.md) peuvent être inacceptables pour de nombreuses raisons.</span><span class="sxs-lookup"><span data-stu-id="c5305-104">The methods explained in [The Versioning Theory for RPC and COM](the-versioning-theory-for-rpc-and-com.md) may be unacceptable for many reasons.</span></span> <span data-ttu-id="c5305-105">La modification d’une version d’interface selon les règles exige essentiellement que les nouveaux clients ne communiquent pas avec les anciens serveurs.</span><span class="sxs-lookup"><span data-stu-id="c5305-105">Changing an interface version according to the rules essentially requires that new clients not communicate with old servers.</span></span> <span data-ttu-id="c5305-106">Cela est souvent impossible avec les logiciels commerciaux déployés dans le domaine.</span><span class="sxs-lookup"><span data-stu-id="c5305-106">This is frequently impossible with commercial software deployed in the field.</span></span> <span data-ttu-id="c5305-107">Parfois, Windows a introduit des modifications d’interface absentes des GUID ou versions modifiés.</span><span class="sxs-lookup"><span data-stu-id="c5305-107">Sometimes, Windows has introduced interface changes absent of changed GUIDs or versions.</span></span> <span data-ttu-id="c5305-108">Cela était dû au fait que de nouveaux clients ont besoin de communiquer avec des serveurs hérités et que la solution qu’un nouveau client prennait en charge à la fois les anciennes et nouvelles interfaces était jugée indésirable.</span><span class="sxs-lookup"><span data-stu-id="c5305-108">This was a result of new clients needing to communicate with legacy servers, and because the solution that a new client would support both the old and new interfaces was deemed undesirable.</span></span>

## <a name="best-practice"></a><span data-ttu-id="c5305-109">Bonne pratique</span><span class="sxs-lookup"><span data-stu-id="c5305-109">Best practice</span></span>

<span data-ttu-id="c5305-110">Il s’agit des méthodes raisonnables de contournement du problème d’incompatibilité de câble lorsque le GUID et la version de l’interface ne peuvent pas être modifiés.</span><span class="sxs-lookup"><span data-stu-id="c5305-110">These are the reasonable methods of working around the wire incompatibility issue when the interface GUID and version cannot be changed.</span></span>

1.  <span data-ttu-id="c5305-111">Faire en sorte que l’application soit consciente des capacités de l’autre côté.</span><span class="sxs-lookup"><span data-stu-id="c5305-111">Have the application be aware of the other side's capabilities.</span></span>

    <span data-ttu-id="c5305-112">Le client et le serveur ont un protocole qui permet à chacun (ou au moins au nouveau client) d’établir l’identité du partenaire.</span><span class="sxs-lookup"><span data-stu-id="c5305-112">The client and server have a protocol that enables each (or at least the new client) to establish the identity of the partner.</span></span> <span data-ttu-id="c5305-113">En général, il suffit que le nouveau client prenne en charge les fonctionnalités prises en charge par les anciens et nouveaux serveurs.</span><span class="sxs-lookup"><span data-stu-id="c5305-113">Typically it is sufficient to have the new client be aware of features supported by old and new servers.</span></span> <span data-ttu-id="c5305-114">Cela peut être facilement fait quand une application s’exécute sur un contexte de connexion et être prise en charge par le biais d’un *XxxGetInfo* type d’appel de fonction exécuté par le client avant d’effectuer des opérations RPC.</span><span class="sxs-lookup"><span data-stu-id="c5305-114">This may easily be done when an application holds on to a connection context, and be supported through an *XxxGetInfo* type of function call executed by the client before performing any RPC operations.</span></span> <span data-ttu-id="c5305-115">Quand une application gère les fonctionnalités sur la base d’une version par serveur, un appel avec une incompatibilité avec l’ancien serveur/client ne peut jamais se produire, puisque l’application contrôle les appels émis vers le serveur.</span><span class="sxs-lookup"><span data-stu-id="c5305-115">When an application manages the features on a per-server release basis, a call with an incompatibility to the old server/client can never occur, since the application controls which calls are issued to which server.</span></span> <span data-ttu-id="c5305-116">La ligne inférieure est que l’application est proactive pour empêcher une incompatibilité.</span><span class="sxs-lookup"><span data-stu-id="c5305-116">The bottom line is that the application is proactive in preventing a mismatch from happening.</span></span> <span data-ttu-id="c5305-117">Cela peut être effectué conjointement avec la deuxième pratique.</span><span class="sxs-lookup"><span data-stu-id="c5305-117">This may be performed in conjunction with the second practice.</span></span>

2.  <span data-ttu-id="c5305-118">Introduisez une nouvelle API distante.</span><span class="sxs-lookup"><span data-stu-id="c5305-118">Introduce a new remote API.</span></span>

    <span data-ttu-id="c5305-119">Une nouvelle méthode distante n’entre pas en conflit avec les méthodes existantes si elle est ajoutée à la fin de l’interface.</span><span class="sxs-lookup"><span data-stu-id="c5305-119">A new remote method does not collide with existing methods if it is added at the very end of the interface.</span></span> <span data-ttu-id="c5305-120">Les anciens clients peuvent appeler de nouveaux serveurs comme ils le font toujours.</span><span class="sxs-lookup"><span data-stu-id="c5305-120">Old clients can call new servers as they always have.</span></span> <span data-ttu-id="c5305-121">Le nouveau client peut appeler la nouvelle méthode sans connaître l’identité du serveur, à condition qu’il surveille les erreurs provenant du serveur appelé.</span><span class="sxs-lookup"><span data-stu-id="c5305-121">The new client can call the new method without knowing the server's identity, provided it watches for the errors coming from the server being called.</span></span> <span data-ttu-id="c5305-122">Le temps d’exécution RPC vérifie toujours le numéro de la méthode pour chaque interface avant une distribution pour s’assurer que la méthode se trouve dans une table v appropriée.</span><span class="sxs-lookup"><span data-stu-id="c5305-122">The RPC run time always checks the method number for each interface before a dispatch to ensure the method is within an appropriate v-table.</span></span> <span data-ttu-id="c5305-123">Pour une méthode inconnue pour un serveur, la durée d’exécution RPC déclenche l’exception RPC \_ S \_ PROCNUM \_ hors \_ \_ limites.</span><span class="sxs-lookup"><span data-stu-id="c5305-123">For a method that is unknown to a server, the RPC run time raises the exception RPC\_S\_PROCNUM\_OUT\_OF\_RANGE.</span></span> <span data-ttu-id="c5305-124">Cette exception est déclenchée uniquement dans cette situation particulière.</span><span class="sxs-lookup"><span data-stu-id="c5305-124">This exception is raised only in this particular situation.</span></span> <span data-ttu-id="c5305-125">Par conséquent, un nouveau client peut surveiller l’exception en tant que signe que l’appel a été passé à un ancien serveur et peut modifier son comportement de manière appropriée.</span><span class="sxs-lookup"><span data-stu-id="c5305-125">Therefore, a new client can watch for the exception as a sign that the call went to an old server and can modify its behavior gracefully.</span></span>

3.  <span data-ttu-id="c5305-126">Introduisez de nouveaux paramètres ou de nouveaux types de données uniquement dans les nouvelles méthodes.</span><span class="sxs-lookup"><span data-stu-id="c5305-126">Introduce new parameters or new data types only in the new methods.</span></span>

    <span data-ttu-id="c5305-127">L’une des raisons d’introduire une nouvelle méthode consiste à éviter l’incompatibilité des données.</span><span class="sxs-lookup"><span data-stu-id="c5305-127">One reason to introduce a new method is to avoid data incompatibility.</span></span> <span data-ttu-id="c5305-128">En principe, si un nouveau type de données est introduit ou simplement modifié, il doit être utilisé uniquement dans une nouvelle méthode (ou les méthodes).</span><span class="sxs-lookup"><span data-stu-id="c5305-128">If a new data type is introduced or simply modified, in principle it should be used only in a new method (or methods).</span></span> <span data-ttu-id="c5305-129">Consultez des [exemples de modifications incompatibles](examples-of-incompatible-changes.md) pour obtenir des exemples de modifications de types de données incompatibles.</span><span class="sxs-lookup"><span data-stu-id="c5305-129">See [Examples of Incompatible Changes](examples-of-incompatible-changes.md) for examples of incompatible data type changes.</span></span> <span data-ttu-id="c5305-130">La seule exception notable à cette règle est décrite dans l’élément 4.</span><span class="sxs-lookup"><span data-stu-id="c5305-130">The only notable exception to this rule is described in item four.</span></span>

4.  <span data-ttu-id="c5305-131">Mapper de nouveaux paramètres ou de nouveaux types de données via un wrapper.</span><span class="sxs-lookup"><span data-stu-id="c5305-131">Map new parameters or new data types through a wrapper.</span></span>

    <span data-ttu-id="c5305-132">Cette solution s’applique lorsqu’un nouveau paramètre ou type de données doit être exposé à un utilisateur, mais n’a en fait pas à être mis à distance séparément ou peut être mappé aux anciens types de données ou paramètres.</span><span class="sxs-lookup"><span data-stu-id="c5305-132">This solution applies when a new parameter or data type must be exposed to a user, but actually does not have to be remoted separately or can be mapped to the old data types or parameters.</span></span> <span data-ttu-id="c5305-133">Par exemple, de nombreuses API système contournent et exécutent un appel distant.</span><span class="sxs-lookup"><span data-stu-id="c5305-133">For example, many system APIs turn around and execute a remote call.</span></span> <span data-ttu-id="c5305-134">Ils peuvent, ou non, faire un type de mappage des types de données connus de l’utilisateur aux types de données réellement utilisés dans l’appel RPC sous-jacent.</span><span class="sxs-lookup"><span data-stu-id="c5305-134">They may or may not be doing some kind of mapping from the user known data types to the data types actually used in the underlying RPC call.</span></span> <span data-ttu-id="c5305-135">Il est donc toujours utile d’examiner si la modification de l’interface utilisateur doit se propager en tant que modification d’une interface distante.</span><span class="sxs-lookup"><span data-stu-id="c5305-135">It is therefore always worth examining if the change in the user interface needs to propagate as a change to a remote interface.</span></span>

    <span data-ttu-id="c5305-136">Une situation similaire peut se produire lorsque l’utilisateur appelle directement une API distante, mais qu’un wrapper peut être introduit pour effectuer un nouveau mappage de type ou d’autres actions supplémentaires devenues nécessaires.</span><span class="sxs-lookup"><span data-stu-id="c5305-136">A similar situation may happen when the user calls a remote API directly, but a wrapper could be introduced to do a new type mapping or some other additional actions that have become necessary.</span></span> <span data-ttu-id="c5305-137">Le langage IDL (Interface Definition Language) offre plusieurs moyens de faciliter ce remappage, à savoir \[ [**appeler \_ en**](/windows/desktop/Midl/call-as)tant que \] , \[ [**transmettre \_ en tant que**](/windows/desktop/Midl/transmit-as) \] et \[ [**\_ marshaler par câble**](/windows/desktop/Midl/wire-marshal) \] .</span><span class="sxs-lookup"><span data-stu-id="c5305-137">Interface Definition Language (IDL) has several ways of facilitating such remapping, namely \[[**call\_as**](/windows/desktop/Midl/call-as)\], \[[**transmit\_as**](/windows/desktop/Midl/transmit-as)\], and \[[**wire\_marshal**](/windows/desktop/Midl/wire-marshal)\].</span></span> <span data-ttu-id="c5305-138">L' \[ **appel \_ en tant qu'** \] attribut introduit un wrapper de fonction sur le client et le serveur.</span><span class="sxs-lookup"><span data-stu-id="c5305-138">The \[**call\_as**\] attribute introduces a function wrapper on the client and server.</span></span> <span data-ttu-id="c5305-139">Les deux sont placés entre le code utilisateur et le marshaleur.</span><span class="sxs-lookup"><span data-stu-id="c5305-139">Both are placed between the user code and the marshaler.</span></span> <span data-ttu-id="c5305-140">Les autres attributs concernent le mappage de type direct.</span><span class="sxs-lookup"><span data-stu-id="c5305-140">The other attributes deal with direct type mapping.</span></span> <span data-ttu-id="c5305-141">Pour les problèmes d’extension, \[ **appelez \_ en tant que** \] est le plus fréquemment utilisé et est plus facile à comprendre et à manipuler sans pièges.</span><span class="sxs-lookup"><span data-stu-id="c5305-141">For extension problems, \[**call\_as**\] is the most frequently used, and is easiest to understand and manipulate without pitfalls.</span></span>

5.  <span data-ttu-id="c5305-142">Modifiez les types de données par le biais d’une Union par défaut.</span><span class="sxs-lookup"><span data-stu-id="c5305-142">Modify data types through a defaultless union.</span></span>

    <span data-ttu-id="c5305-143">La modification d’un attribut ou d’un type de données provoque généralement l’incompatibilité des câbles.</span><span class="sxs-lookup"><span data-stu-id="c5305-143">Changing an attribute or data type typically leads to wire incompatibility.</span></span> <span data-ttu-id="c5305-144">Consultez des [exemples de modifications incompatibles](examples-of-incompatible-changes.md) pour obtenir des exemples.</span><span class="sxs-lookup"><span data-stu-id="c5305-144">See [Examples of Incompatible Changes](examples-of-incompatible-changes.md) for examples.</span></span> <span data-ttu-id="c5305-145">Toutefois, dans le cas d’une Union sans clause par défaut, l’incompatibilité peut être gérée d’une manière similaire à la casse d’une procédure hors limites, comme décrit précédemment.</span><span class="sxs-lookup"><span data-stu-id="c5305-145">However, in the case of a union without a default clause, the incompatibility may be managed in a way similar to the case of a procedure out of range, as described previously.</span></span> <span data-ttu-id="c5305-146">Ce schéma est facilement applicable aux types *XxxINFO* populaires qui utilisent des unions.</span><span class="sxs-lookup"><span data-stu-id="c5305-146">This scheme is readily applicable to the popular *XxxINFO* types that use unions.</span></span>

    <span data-ttu-id="c5305-147">Par exemple, un appel similaire à celui-ci</span><span class="sxs-lookup"><span data-stu-id="c5305-147">For example, a call like this</span></span>

    ```C++
    XxxGetInfo( [in] level, [out] XxxINFO  * pInfo );
    ```

    

    <span data-ttu-id="c5305-148">peut retourner des informations au niveau 1, 2 ou 3, *XxxINFO* étant une Union avec trois branches : 1, 2 et 3.</span><span class="sxs-lookup"><span data-stu-id="c5305-148">could return information at level 1, 2 or 3, with *XxxINFO* being a union with three branches: 1, 2 and 3.</span></span>

6.  <span data-ttu-id="c5305-149">Utilisez l' \[ attribut [**Range**](/windows/desktop/Midl/range) \] pour spécifier Range.</span><span class="sxs-lookup"><span data-stu-id="c5305-149">Use the \[[**range**](/windows/desktop/Midl/range)\] attribute to specify range.</span></span>

    <span data-ttu-id="c5305-150">Vous pouvez spécifier l' \[ [](/windows/desktop/Midl/range) \] attribut de plage sur un type de mise à l’échelle simple sans interrompre la compatibilité descendante.</span><span class="sxs-lookup"><span data-stu-id="c5305-150">You can specify the \[[**range**](/windows/desktop/Midl/range)\] attribute on a simple scale type without breaking backward compatibility.</span></span> <span data-ttu-id="c5305-151">Cet attribut n’affecte pas le format de câble, mais pendant le démarshaling, RPC vérifie la valeur sur Cable pour confirmer qu’il se trouve dans la plage spécifiée dans le fichier. idl.</span><span class="sxs-lookup"><span data-stu-id="c5305-151">This attribute does not affect wire format, but during unmarshalling RPC checks the value on wire to confirm that it is within the range specified in the .idl file.</span></span> <span data-ttu-id="c5305-152">Si ce n’est pas le cas, une \_ \_ exception de liaison non valide RPC X \_ est levée.</span><span class="sxs-lookup"><span data-stu-id="c5305-152">If not, a RPC\_X\_INVALID\_BOUND exception is thrown.</span></span> <span data-ttu-id="c5305-153">Cela s’avère particulièrement utile si le serveur connaît la taille maximale d’un tableau dimensionné.</span><span class="sxs-lookup"><span data-stu-id="c5305-153">This is especially useful if the server knows the maximum size of a sized array.</span></span>

    <span data-ttu-id="c5305-154">Par exemple :</span><span class="sxs-lookup"><span data-stu-id="c5305-154">For example:</span></span>

    ```C++
    HRESULT Method1( [in, range(0,100)] ULONG m, [size_is(m)] ULONG *plong); 
    ```

    

<span data-ttu-id="c5305-155">Le comportement RPC lorsque le niveau indiqué est 4 et que le ARM est manquant, dépend de la définition de l’Union.</span><span class="sxs-lookup"><span data-stu-id="c5305-155">The RPC behavior when the indicated level is 4 and the arm is missing, depends on the definition of the union.</span></span> <span data-ttu-id="c5305-156">Pour une Union avec la clause default définie, RPC transmet un type indiqué dans la clause default pour tout ce qui est différent des étiquettes ARM connues (dans ce cas, toute autre valeur que 1, 2 ou 3).</span><span class="sxs-lookup"><span data-stu-id="c5305-156">For a union with the default clause defined, RPC transmits a type indicated in the default clause for anything different than the known arm labels (in this case, anything other than 1, 2 or 3).</span></span> <span data-ttu-id="c5305-157">Pour une Union sans valeur par défaut, le unmarshaleur lève une exception, car par définition il n’y a pas de valeur par défaut vers laquelle revenir.</span><span class="sxs-lookup"><span data-stu-id="c5305-157">For a defaultless union, the unmarshaler raises an exception because by definition there is no default to fall back to.</span></span> <span data-ttu-id="c5305-158">L’exception est la \_ \_ balise RPC S non valide \_ .</span><span class="sxs-lookup"><span data-stu-id="c5305-158">The exception is RPC\_S\_INVALID\_TAG.</span></span>

<span data-ttu-id="c5305-159">Là encore, un nouveau client peut ajuster son comportement lors de la découverte qu’il a appelé un ancien serveur.</span><span class="sxs-lookup"><span data-stu-id="c5305-159">Again, a new client can adjust its behavior upon discovering that it called an old server.</span></span>

<span data-ttu-id="c5305-160">Les pratiques recommandées sont les suivantes : si un type de données accessible à distance doit être conçu et peut être étendu à l’avenir, utilisez une Union non définie par défaut dans le fichier IDL.</span><span class="sxs-lookup"><span data-stu-id="c5305-160">What follows from these recommended practices is that if a remotable data type must be designed that can be extended in future, use a defaultless union in the IDL file.</span></span> <span data-ttu-id="c5305-161">Pour un choix donné, une Union encapsulée est légèrement plus propre.</span><span class="sxs-lookup"><span data-stu-id="c5305-161">Given a choice, an encapsulated union is slightly cleaner.</span></span>

<span data-ttu-id="c5305-162">En raison des excentriques de la représentation interne du protocole NDR64 Wire, la recommandation pour l’ajout des bras fournis plus haut dans cette section doit être qualifiée comme suit : le nouveau bras ajouté ne peut pas modifier l’alignement de l’Union, et en particulier, l’alignement le plus grand des bras ne doit pas changer.</span><span class="sxs-lookup"><span data-stu-id="c5305-162">Due to quirks of internal representation of the NDR64 wire protocol, the recommendation for adding arms provided earlier in this section needs to be qualified as follows: The new arm being added cannot change the alignment of the union, and in particular, the biggest alignment of the arms should not change.</span></span> <span data-ttu-id="c5305-163">Ce n’est généralement pas un problème, car un pointeur dans ARM force l’alignement sur 8.</span><span class="sxs-lookup"><span data-stu-id="c5305-163">This is typically not an issue, as a pointer in an arm forces alignment to 8.</span></span> <span data-ttu-id="c5305-164">Une conception où chaque ARM est un pointeur vers un type ARM est un bon moyen de satisfaire l’exigence.</span><span class="sxs-lookup"><span data-stu-id="c5305-164">A design where each arm is a pointer to an arm type is one clean way of satisfying the requirement.</span></span>

 

 