---
title: Prévention des blocages côté client
description: Il existe deux manières pour lesquelles votre client peut bloquer la connectivité réseau, les demandes du serveur peuvent être perdues ou le serveur lui-même peut se bloquer. Avec les options par défaut, RPC n’expire jamais un appel, et votre thread client attend indéfiniment une réponse.
ms.assetid: 2c201e29-9d9c-48e6-b0b5-68e4b25c3fb7
keywords:
- RPC appel de procédure distante, meilleures pratiques, prévention des blocages du client
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 18d4b5fc92ca18b575d081cd7b5abf90929e7df5
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/20/2020
ms.locfileid: "103727788"
---
# <a name="preventing-client-side-hangs"></a><span data-ttu-id="2c21b-105">Prévention des blocages côté client</span><span class="sxs-lookup"><span data-stu-id="2c21b-105">Preventing Client-side Hangs</span></span>

<span data-ttu-id="2c21b-106">Il existe deux façons de bloquer le client : la connectivité réseau peut entraîner la perte des demandes du serveur, ou le serveur lui-même peut se bloquer.</span><span class="sxs-lookup"><span data-stu-id="2c21b-106">There are two ways your client can hang: network connectivity can cause server requests to become lost, or the server itself can crash.</span></span> <span data-ttu-id="2c21b-107">Avec les options par défaut, RPC n’expire jamais un appel, et votre thread client attend indéfiniment une réponse.</span><span class="sxs-lookup"><span data-stu-id="2c21b-107">With default options, RPC will never time out a call, and your client thread will wait forever for a response.</span></span>

<span data-ttu-id="2c21b-108">Il existe deux méthodes pour éviter cela : conserver les actifs et les délais d’expiration.</span><span class="sxs-lookup"><span data-stu-id="2c21b-108">There are two methods to prevent this: keep alives and time outs.</span></span>

## <a name="tcp-keep-alives"></a><span data-ttu-id="2c21b-109">TCP Keep Alive</span><span class="sxs-lookup"><span data-stu-id="2c21b-109">TCP Keep Alives</span></span>

<span data-ttu-id="2c21b-110">Le client peut être configuré pour effectuer un test ping périodique du serveur afin de s’assurer que le serveur est actif et en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="2c21b-110">The client can be set up to periodically ping the server to ensure the server is alive and running.</span></span> <span data-ttu-id="2c21b-111">Les pings sont des connexions TCP persistantes pour les séquences de protocole [**\_ http**](/windows/desktop/Midl/ncacn-http) [**ncacn \_ IP \_ TCP**](/windows/desktop/Midl/ncacn-ip-tcp) et ncacn, et par conséquent, elles sont efficaces dans l’utilisation du processeur et la bande passante réseau.</span><span class="sxs-lookup"><span data-stu-id="2c21b-111">The pings are TCP keep-alives for the [**ncacn\_ip\_tcp**](/windows/desktop/Midl/ncacn-ip-tcp) and [**ncacn\_http**](/windows/desktop/Midl/ncacn-http) protocol sequences, and as such, they are efficient in CPU utilization and network bandwidth.</span></span> <span data-ttu-id="2c21b-112">Pour activer Keep Alive sur un appel de procédure distante donné, utilisez la fonction [**RpcMgmtSetComTimeout**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetcomtimeout) avant d’initier l’appel.</span><span class="sxs-lookup"><span data-stu-id="2c21b-112">To enable keep alives on a given remote procedure call, use the [**RpcMgmtSetComTimeout**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetcomtimeout) function before the call is initiated.</span></span> <span data-ttu-id="2c21b-113">Cette fonction prend un handle de liaison et un délai d’attente comme arguments.</span><span class="sxs-lookup"><span data-stu-id="2c21b-113">This function takes a binding handle and a time out as arguments.</span></span> <span data-ttu-id="2c21b-114">Chaque appel de procédure distante sur ce handle de liaison après **RpcMgmtSetComTimeout** utilise le délai d’expiration fourni.</span><span class="sxs-lookup"><span data-stu-id="2c21b-114">Every remote procedure call on this binding handle after **RpcMgmtSetComTimeout** uses the supplied time out.</span></span>

<span data-ttu-id="2c21b-115">Le paramètre timeout de la fonction [**RpcMgmtSetComTimeout**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetcomtimeout) spécifie la durée d’attente de l’exécution de l’appel de procédure distante avant qu’il active Keep Alive.</span><span class="sxs-lookup"><span data-stu-id="2c21b-115">The Timeout parameter for the [**RpcMgmtSetComTimeout**](/windows/desktop/api/Rpcdce/nf-rpcdce-rpcmgmtsetcomtimeout) function specifies how long the RPC run time waits before it turns on keep alives.</span></span> <span data-ttu-id="2c21b-116">Le délai d’attente est une valeur comprise entre 0 et 10, où 0 correspond au délai d’expiration minimal et 10 à un délai d’attente infini (pas de délai d’attente).</span><span class="sxs-lookup"><span data-stu-id="2c21b-116">The time out is a value between 0 and 10, where 0 is the minimal time out, and 10 is infinite time out (no time out).</span></span> <span data-ttu-id="2c21b-117">Le délai d’attente n’est pas en secondes. la traduction de la valeur de délai d’attente fournie à la fonction **RpcMgmtSetComTimeout** en secondes est effectuée par le runtime RPC, et est spécifique à l’implémentation.</span><span class="sxs-lookup"><span data-stu-id="2c21b-117">The time out itself is not in seconds; the translation from the time-out value supplied to the **RpcMgmtSetComTimeout** function to seconds is done by the RPC run time, and is implementation specific.</span></span>

<span data-ttu-id="2c21b-118">Le tableau suivant fournit la traduction en secondes pour Windows 2000 et Windows XP.</span><span class="sxs-lookup"><span data-stu-id="2c21b-118">The following table provides the translation to seconds for Windows 2000 and Windows XP.</span></span> <span data-ttu-id="2c21b-119">Les futures versions de Windows peuvent modifier le mappage entre le paramètre de délai d’attente et la valeur du délai d’attente, en secondes :</span><span class="sxs-lookup"><span data-stu-id="2c21b-119">Future versions of Windows may change the mapping between the Timeout parameter and the time-out value in seconds:</span></span>

| <span data-ttu-id="2c21b-120">Paramètre timeout</span><span class="sxs-lookup"><span data-stu-id="2c21b-120">Timeout parameter</span></span>                       | <span data-ttu-id="2c21b-121">Délai d’expiration réel en secondes</span><span class="sxs-lookup"><span data-stu-id="2c21b-121">Actual time out in seconds</span></span> |
|-----------------------------------------|----------------------------|
| <span data-ttu-id="2c21b-122">0 ( \_ \_ \_ délai d’expiration minimal de liaison RPC C \_ )</span><span class="sxs-lookup"><span data-stu-id="2c21b-122">0 (RPC\_C\_BINDING\_MIN\_TIMEOUT)</span></span>       | <span data-ttu-id="2c21b-123">120</span><span class="sxs-lookup"><span data-stu-id="2c21b-123">120</span></span>                        |
| <span data-ttu-id="2c21b-124">1</span><span class="sxs-lookup"><span data-stu-id="2c21b-124">1</span></span>                                       | <span data-ttu-id="2c21b-125">240</span><span class="sxs-lookup"><span data-stu-id="2c21b-125">240</span></span>                        |
| <span data-ttu-id="2c21b-126">2</span><span class="sxs-lookup"><span data-stu-id="2c21b-126">2</span></span>                                       | <span data-ttu-id="2c21b-127">360</span><span class="sxs-lookup"><span data-stu-id="2c21b-127">360</span></span>                        |
| <span data-ttu-id="2c21b-128">3</span><span class="sxs-lookup"><span data-stu-id="2c21b-128">3</span></span>                                       | <span data-ttu-id="2c21b-129">480</span><span class="sxs-lookup"><span data-stu-id="2c21b-129">480</span></span>                        |
| <span data-ttu-id="2c21b-130">4</span><span class="sxs-lookup"><span data-stu-id="2c21b-130">4</span></span>                                       | <span data-ttu-id="2c21b-131">600</span><span class="sxs-lookup"><span data-stu-id="2c21b-131">600</span></span>                        |
| <span data-ttu-id="2c21b-132">5 ( \_ \_ \_ délai d’attente par défaut de liaison C RPC \_ )</span><span class="sxs-lookup"><span data-stu-id="2c21b-132">5 (RPC\_C\_BINDING\_DEFAULT\_TIMEOUT)</span></span>   | <span data-ttu-id="2c21b-133">720</span><span class="sxs-lookup"><span data-stu-id="2c21b-133">720</span></span>                        |
| <span data-ttu-id="2c21b-134">6</span><span class="sxs-lookup"><span data-stu-id="2c21b-134">6</span></span>                                       | <span data-ttu-id="2c21b-135">840</span><span class="sxs-lookup"><span data-stu-id="2c21b-135">840</span></span>                        |
| <span data-ttu-id="2c21b-136">7</span><span class="sxs-lookup"><span data-stu-id="2c21b-136">7</span></span>                                       | <span data-ttu-id="2c21b-137">960</span><span class="sxs-lookup"><span data-stu-id="2c21b-137">960</span></span>                        |
| <span data-ttu-id="2c21b-138">8</span><span class="sxs-lookup"><span data-stu-id="2c21b-138">8</span></span>                                       | <span data-ttu-id="2c21b-139">1080</span><span class="sxs-lookup"><span data-stu-id="2c21b-139">1080</span></span>                       |
| <span data-ttu-id="2c21b-140">9 ( \_ \_ délai maximal de liaison RPC C \_ \_ )</span><span class="sxs-lookup"><span data-stu-id="2c21b-140">9 (RPC\_C\_BINDING\_MAX\_TIMEOUT)</span></span>       | <span data-ttu-id="2c21b-141">1200</span><span class="sxs-lookup"><span data-stu-id="2c21b-141">1200</span></span>                       |
| <span data-ttu-id="2c21b-142">10 ( \_ \_ \_ délai d’expiration infini de liaison RPC c \_ )</span><span class="sxs-lookup"><span data-stu-id="2c21b-142">10 (RPC\_C\_BINDING\_INFINITE\_TIMEOUT)</span></span> | <span data-ttu-id="2c21b-143">Délai d’expiration infini</span><span class="sxs-lookup"><span data-stu-id="2c21b-143">Infinite time out</span></span>          |



 

<span data-ttu-id="2c21b-144">Une fois les connexions persistantes activées, le client envoie un paquet Keep Alive chaque seconde.</span><span class="sxs-lookup"><span data-stu-id="2c21b-144">Once the keep alives are turned on, the client sends one keep alive packet every second.</span></span> <span data-ttu-id="2c21b-145">S’il n’y a pas d’accusé de réception du serveur pour trois ou plusieurs Keep Alive, le client déclare que la connexion est inactive et fait échouer l’appel de procédure distante.</span><span class="sxs-lookup"><span data-stu-id="2c21b-145">If there is no acknowledgment from the server for three or more keep alives, the client declares the connection dead and fails the remote procedure call.</span></span> <span data-ttu-id="2c21b-146">Si le serveur envoie une réponse dans le délai imparti, Keep Alive n’est pas activé.</span><span class="sxs-lookup"><span data-stu-id="2c21b-146">If the server sends a response within the specified time out, keep alives will not be turned on.</span></span> <span data-ttu-id="2c21b-147">Si le serveur répond à Keep Alive, mais ne répond pas à l’appel de procédure distante, le client continue à envoyer Keep Alive.</span><span class="sxs-lookup"><span data-stu-id="2c21b-147">If the server responds to keep alives, but does not respond to the remote procedure call, the client continues sending keep alives.</span></span> <span data-ttu-id="2c21b-148">Une fois que le serveur répond à l’appel RPC, les connexions persistantes sont désactivées.</span><span class="sxs-lookup"><span data-stu-id="2c21b-148">Once the server responds to the RPC call, the keep alives are turned off.</span></span> <span data-ttu-id="2c21b-149">Pour Windows 2000, les connexions persistantes sont activées uniquement pour les appels RPC synchrones.</span><span class="sxs-lookup"><span data-stu-id="2c21b-149">For Windows 2000, keep alives are turned on only for synchronous RPC calls.</span></span> <span data-ttu-id="2c21b-150">Pour Windows XP, conserver les actifs sont activés pour les appels RPC asynchrones.</span><span class="sxs-lookup"><span data-stu-id="2c21b-150">For Windows XP, keep alives are turned on for asynchronous RPC calls as well.</span></span>

<span data-ttu-id="2c21b-151">Il est tentant de définir Keep Alive à la valeur la plus faible pour garantir que l’application cliente réponde aux problèmes de réseau en temps opportun.</span><span class="sxs-lookup"><span data-stu-id="2c21b-151">It is tempting to set keep alives to the lowest value to ensure the client application responds to network problems in a timely fashion.</span></span> <span data-ttu-id="2c21b-152">Une attention particulière doit être apportée à une telle tentation, et les contrôles appliqués déterminent si une valeur agressive est justifiée.</span><span class="sxs-lookup"><span data-stu-id="2c21b-152">Careful consideration should be given to such temptation, and scrutiny applied to whether an aggressive value is warranted.</span></span> <span data-ttu-id="2c21b-153">Une fois la connectivité restaurée, un serveur qui perd temporairement la connectivité peut se trouver submergé par l’activité Keep Alive à partir de nombreux clients.</span><span class="sxs-lookup"><span data-stu-id="2c21b-153">A server that temporarily loses connectivity may find itself flooded with keep alives from numerous clients once connectivity is restored.</span></span> <span data-ttu-id="2c21b-154">En outre, des tâches de calcul longues peuvent prendre plus de deux minutes et le serveur peut se retrouver consacrer plus de temps processeur à conserver les Alives que l’exécution d’un travail utile.</span><span class="sxs-lookup"><span data-stu-id="2c21b-154">In addition, long computational tasks can take more than two minutes, and the server may find itself spending more CPU time answering keep alives than performing useful work.</span></span> <span data-ttu-id="2c21b-155">Par conséquent, il convient d’utiliser l’utilisation de Keep Alive avec modération.</span><span class="sxs-lookup"><span data-stu-id="2c21b-155">Therefore, keep alives should be used with moderation.</span></span> <span data-ttu-id="2c21b-156">Si le client ne peut pas tolérer que son thread soit lié pendant de longues périodes, il convient de prendre en compte RPC asynchrone.</span><span class="sxs-lookup"><span data-stu-id="2c21b-156">If the client cannot tolerate its thread being tied up for long periods, asynchronous RPC should be considered.</span></span>

<span data-ttu-id="2c21b-157">D’autres séquences de protocole peuvent implémenter des mécanismes différents pour détecter les serveurs qui ne répondent pas, en fonction du transport utilisé.</span><span class="sxs-lookup"><span data-stu-id="2c21b-157">Other protocol sequences may implement different mechanisms for detecting unresponsive servers, depending on which transport is used.</span></span> <span data-ttu-id="2c21b-158">Le transport [**Ncalrpc**](/windows/desktop/Midl/ncalrpc) n’utilise pas Keep Alive.</span><span class="sxs-lookup"><span data-stu-id="2c21b-158">The [**ncalrpc**](/windows/desktop/Midl/ncalrpc) transport does not use keep alives.</span></span> <span data-ttu-id="2c21b-159">Étant donné que toutes les communications dans **Ncalrpc** sont locales, si le serveur ne répond pas pendant qu’un appel est en cours, l’exécution de RPC sur le client échoue immédiatement à l’appel.</span><span class="sxs-lookup"><span data-stu-id="2c21b-159">Since all communications in **ncalrpc** are local, if the server becomes unresponsive while a call is in progress, the RPC run time on the client immediately fails the call.</span></span>

## <a name="call-time-outs"></a><span data-ttu-id="2c21b-160">Délais d’appel</span><span class="sxs-lookup"><span data-stu-id="2c21b-160">Call Time Outs</span></span>

<span data-ttu-id="2c21b-161">Le protocole TCP Keep Alive est parfait si la connectivité réseau est perdue ou si le serveur tombe en panne.</span><span class="sxs-lookup"><span data-stu-id="2c21b-161">TCP keep alives are fine if network connectivity is lost, or if the server crashes.</span></span> <span data-ttu-id="2c21b-162">Toutefois, si le serveur bloque les blocages en mode utilisateur, TCP Keep Alive retourne correctement, mais l’appel ne retourne jamais.</span><span class="sxs-lookup"><span data-stu-id="2c21b-162">But if the server deadlocks in user mode, TCP keep alives return successfully but the call will never return.</span></span> <span data-ttu-id="2c21b-163">Pour traiter ce scénario, une nouvelle option d’exécution a été ajoutée pour Windows XP : \_ \_ \_ délai d’attente de l’appel RPC C opt \_ .</span><span class="sxs-lookup"><span data-stu-id="2c21b-163">To deal with this scenario, a new run-time option was added for Windows XP: RPC\_C\_OPT\_CALL\_TIMEOUT.</span></span> <span data-ttu-id="2c21b-164">Cette option indique à l’exécution RPC de configurer un minuteur chaque fois qu’il envoie une demande au serveur.</span><span class="sxs-lookup"><span data-stu-id="2c21b-164">This option instructs the RPC run time to set up a timer each time it sends a request to the server.</span></span> <span data-ttu-id="2c21b-165">Si le minuteur expire, l’appel est automatiquement annulé et se termine avec \_ l' \_ appel RPC S \_ annulé.</span><span class="sxs-lookup"><span data-stu-id="2c21b-165">If the timer expires, the call is automatically canceled and completes with RPC\_S\_CALL\_CANCELLED.</span></span> <span data-ttu-id="2c21b-166">Tant que le serveur répond dans le délai imparti, le client n’annule pas l’appel.</span><span class="sxs-lookup"><span data-stu-id="2c21b-166">As long as the server responds within the specified time limit, the client will not cancel the call.</span></span> <span data-ttu-id="2c21b-167">Cela signifie qu’un appel multifragment peut prendre plus de temps que le délai d’attente, car chaque réponse du serveur est reçue pendant le délai d’attente, même si la durée de l’arrivée de toutes les réponses était supérieure à celle du délai d’attente.</span><span class="sxs-lookup"><span data-stu-id="2c21b-167">This means a multifragment call may take more than the time-out period to complete, as each response from the server is received within the time-out period, even though the time period for all responses to arrive was more than the time-out period.</span></span>

<span data-ttu-id="2c21b-168">En outre, lorsqu’un appel est annulé, le serveur n’est pas averti de l’annulation.</span><span class="sxs-lookup"><span data-stu-id="2c21b-168">Also, when a call is canceled the server is not notified of the cancellation.</span></span> <span data-ttu-id="2c21b-169">Par conséquent, le serveur exécutera probablement l’appel à un moment donné et le client ignorera simplement la réponse du serveur.</span><span class="sxs-lookup"><span data-stu-id="2c21b-169">The server, therefore, will likely execute the call at some point, and the client will simply ignore the response from the server.</span></span>

<span data-ttu-id="2c21b-170">Le piège le plus dangereux avec délais d’appel est d’établir un court délai d’attente et de retenter l’appel sur le même serveur.</span><span class="sxs-lookup"><span data-stu-id="2c21b-170">The most dangerous pitfall with call time outs is establishing a short time out and retrying the call on the same server.</span></span> <span data-ttu-id="2c21b-171">Le scénario suivant illustre les dangers de cette approche :</span><span class="sxs-lookup"><span data-stu-id="2c21b-171">The following scenario illustrates the dangers of this approach:</span></span>

<span data-ttu-id="2c21b-172">Imaginez un serveur qui fonctionne en proche de sa capacité.</span><span class="sxs-lookup"><span data-stu-id="2c21b-172">Imagine a server that operates near capacity.</span></span> <span data-ttu-id="2c21b-173">Il a un certain nombre de clients avec des délais très courts, par exemple cinq secondes.</span><span class="sxs-lookup"><span data-stu-id="2c21b-173">It has a number of clients with very short time outs, such as five seconds.</span></span> <span data-ttu-id="2c21b-174">Une perte temporaire de la connectivité réseau ou de l’encombrement sur un routeur provoque des réponses de quelques secondes à l’expiration du serveur.</span><span class="sxs-lookup"><span data-stu-id="2c21b-174">A temporary loss of network connectivity or congestion at a router causes a lapse in server replies for a few seconds.</span></span> <span data-ttu-id="2c21b-175">Sur les réseaux Ethernet, cette situation peut être facilement due à une rafale d’activité sur un lien que le serveur partage avec un autre ordinateur.</span><span class="sxs-lookup"><span data-stu-id="2c21b-175">On Ethernet networks, this situation can easily be caused by a burst of activity on a link that the server shares with another machine.</span></span> <span data-ttu-id="2c21b-176">Le serveur ne gère pas pour envoyer toutes les réponses avant l’expiration du délai de cinq secondes. Les clients obtiennent leurs appels annulés, puis réessayent immédiatement.</span><span class="sxs-lookup"><span data-stu-id="2c21b-176">The server does not manage to send all replies before the five-second time out. The clients get their calls canceled, and immediately retry.</span></span> <span data-ttu-id="2c21b-177">Le serveur n’a pas conscience que les appels sont retentés et les exécutent également.</span><span class="sxs-lookup"><span data-stu-id="2c21b-177">The server is not aware the calls are retries, and executes them as well.</span></span> <span data-ttu-id="2c21b-178">Par conséquent, au lieu d’exécuter sa charge de travail normale des appels, il exécute 30-50% d’appels supplémentaires, en fonction du nombre de clients ayant dépassé le délai d’attente. Si cela dépasse sa capacité et que le serveur ne peut pas répondre à tous les clients dans un délai de cinq secondes, un autre appel est envoyé au serveur.</span><span class="sxs-lookup"><span data-stu-id="2c21b-178">Thus, instead of executing its normal workload of calls, it executes 30-50% more calls, depending on how many clients timed out. If this exceeds its capacity, and the server cannot respond to all clients within five seconds, another round of calls are sent to the server.</span></span> <span data-ttu-id="2c21b-179">Les clients continuent de réémettre les mêmes appels, et étant donné que le serveur est surchargé par le traitement des appels précédents, il ne peut pas répondre dans le délai imparti. Une fois qu’il répond, les clients ont atteint le délai d’expiration, émis un nouvel appel et ignoré la réponse.</span><span class="sxs-lookup"><span data-stu-id="2c21b-179">The clients keep reissuing the same calls, and since the server is overloaded processing previous calls, it is unable to respond within the time out. Once it responds, the clients have hit the time out, issued a new call, and discarded the answer.</span></span> <span data-ttu-id="2c21b-180">Dans le pire des cas, le serveur ne récupérera pas jusqu’au redémarrage, et selon le modèle d’accès client, risque de ne pas être récupéré tant qu’un nombre suffisant de clients ne sont pas arrêtés.</span><span class="sxs-lookup"><span data-stu-id="2c21b-180">In a worst case scenario, the server will not recover until reboot, and depending on client access pattern, may not recover until a sufficient number of clients are stopped.</span></span>

> [!Note]  
> <span data-ttu-id="2c21b-181">Les expirations de délai d’appel fonctionnent uniquement sur les séquences de protocole [**\_ http**](/windows/desktop/Midl/ncacn-http) [**\_ IP ncacn \_ TCP**](/windows/desktop/Midl/ncacn-ip-tcp) et ncacn.</span><span class="sxs-lookup"><span data-stu-id="2c21b-181">Call time outs work only on the [**ncacn\_ip\_tcp**](/windows/desktop/Midl/ncacn-ip-tcp) and [**ncacn\_http**](/windows/desktop/Midl/ncacn-http) protocol sequences.</span></span>

 

 

 