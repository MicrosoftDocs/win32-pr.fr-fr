---
title: Architecture et composants
description: Cette rubrique décrit les composants qui composent Microsoft DirectComposition.
ms.assetid: 7C79B330-41EA-4BA0-9103-BB5A0C3D4CE2
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: fb2de495aa170560b1e7082cacf1893a8c94905a
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/20/2020
ms.locfileid: "104031674"
---
# <a name="architecture-and-components"></a><span data-ttu-id="035f8-103">Architecture et composants</span><span class="sxs-lookup"><span data-stu-id="035f8-103">Architecture and components</span></span>

> [!NOTE]
> <span data-ttu-id="035f8-104">Pour les applications sur Windows 10, nous vous recommandons d’utiliser des API Windows. UI. composition au lieu de DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="035f8-104">For apps on Windows 10, we recommend using Windows.UI.Composition APIs instead of DirectComposition.</span></span> <span data-ttu-id="035f8-105">Pour plus d’informations, consultez [moderniser votre application de bureau à l’aide de la couche visuelle](/windows/uwp/composition/visual-layer-in-desktop-apps).</span><span class="sxs-lookup"><span data-stu-id="035f8-105">For more info, see [Modernize your desktop app using the Visual layer](/windows/uwp/composition/visual-layer-in-desktop-apps).</span></span>

<span data-ttu-id="035f8-106">Cette rubrique décrit les composants qui composent Microsoft DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="035f8-106">This topic describes the components that make up Microsoft DirectComposition.</span></span> <span data-ttu-id="035f8-107">Il se compose des sections suivantes.</span><span class="sxs-lookup"><span data-stu-id="035f8-107">It consists of the following sections.</span></span>

-   [<span data-ttu-id="035f8-108">Composants logiciels</span><span class="sxs-lookup"><span data-stu-id="035f8-108">Software components</span></span>](#software-components)
-   [<span data-ttu-id="035f8-109">Bibliothèque d’applications</span><span class="sxs-lookup"><span data-stu-id="035f8-109">Application library</span></span>](#application-library)
-   [<span data-ttu-id="035f8-110">Moteur de composition</span><span class="sxs-lookup"><span data-stu-id="035f8-110">Composition engine</span></span>](#composition-engine)
-   [<span data-ttu-id="035f8-111">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="035f8-111">Related topics</span></span>](#related-topics)

## <a name="software-components"></a><span data-ttu-id="035f8-112">Composants logiciels</span><span class="sxs-lookup"><span data-stu-id="035f8-112">Software components</span></span>

<span data-ttu-id="035f8-113">DirectComposition comprend les principaux composants logiciels suivants.</span><span class="sxs-lookup"><span data-stu-id="035f8-113">DirectComposition consists of the following main software components.</span></span>

-   <span data-ttu-id="035f8-114">Bibliothèque d’applications en mode utilisateur (dcomp.dll) qui implémente l’API publique basée sur le modèle COM (Component Object Model).</span><span class="sxs-lookup"><span data-stu-id="035f8-114">A user-mode application library (dcomp.dll) that implements the Component Object Model (COM)-based public API.</span></span>
-   <span data-ttu-id="035f8-115">Un moteur de composition en mode utilisateur (dwmcore.dll) qui est hébergé dans le processus de Gestionnaire de fenêtrage (DWM) (dwm.exe) et effectue la composition du bureau.</span><span class="sxs-lookup"><span data-stu-id="035f8-115">A user-mode composition engine (dwmcore.dll) that is hosted in the Desktop Window Manager (DWM) process (dwm.exe), and performs the actual desktop composition.</span></span>
-   <span data-ttu-id="035f8-116">Base de données d’objets en mode noyau (partie de win32k.sys) qui marshale les commandes de l’application vers le moteur de composition.</span><span class="sxs-lookup"><span data-stu-id="035f8-116">A kernel-mode object database (part of win32k.sys) that marshals commands from the application to the composition engine.</span></span>

<span data-ttu-id="035f8-117">Une seule instance du moteur de composition gère les arborescences de composition DirectComposition pour toutes les applications et l’arborescence de composition DWM, qui représente l’intégralité du bureau.</span><span class="sxs-lookup"><span data-stu-id="035f8-117">A single instance of the composition engine handles the DirectComposition composition trees for all applications and the DWM composition tree, which represents the entire desktop.</span></span> <span data-ttu-id="035f8-118">La base de données d’objets en mode noyau et le moteur de composition en mode utilisateur sont instanciés une fois par session, de sorte qu’un ordinateur Terminal Server avec plusieurs utilisateurs a plusieurs instances de ces deux composants.</span><span class="sxs-lookup"><span data-stu-id="035f8-118">Both the kernel-mode object database and the user-mode composition engine are instantiated once per session, so a Terminal Server machine with multiple users has multiple instances of both of those components.</span></span>

<span data-ttu-id="035f8-119">Le diagramme suivant montre les principaux composants DirectComposition et la façon dont ils sont liés les uns aux autres.</span><span class="sxs-lookup"><span data-stu-id="035f8-119">The following diagram shows the main DirectComposition components and how they relate to one another.</span></span>

![architecture de niveau supérieur directcomposition](images/directcomposition-top-level-architecture.png)

## <a name="application-library"></a><span data-ttu-id="035f8-121">Bibliothèque d’applications</span><span class="sxs-lookup"><span data-stu-id="035f8-121">Application library</span></span>

<span data-ttu-id="035f8-122">La bibliothèque d’applications DirectComposition est une API COM publique avec un point d’entrée unique à deux dimensions qui est exporté à partir de dcomp.dll et retourne un pointeur d’interface vers un objet appareil.</span><span class="sxs-lookup"><span data-stu-id="035f8-122">The DirectComposition application library is a public COM-based API with a single flat entry-point that is exported from dcomp.dll and returns an interface pointer to a device object.</span></span> <span data-ttu-id="035f8-123">L’objet périphérique a, à son tour, des méthodes pour créer tous les autres objets, chacun d’eux étant représenté par un pointeur d’interface.</span><span class="sxs-lookup"><span data-stu-id="035f8-123">The device object, in turn, has methods for creating all other objects, each of which is represented by an interface pointer.</span></span> <span data-ttu-id="035f8-124">Toutes les interfaces DirectComposition héritent de l’interface [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) et l’implémentent entièrement.</span><span class="sxs-lookup"><span data-stu-id="035f8-124">All DirectComposition interfaces inherit from and fully implement the [**IUnknown**](/windows/desktop/api/unknwn/nn-unknwn-iunknown) interface.</span></span> <span data-ttu-id="035f8-125">Toutes les méthodes qui acceptent des interfaces DirectComposition vérifient si l’interface est implémentée à l’intérieur de dcomp.dll ou si elle est implémentée par un autre composant.</span><span class="sxs-lookup"><span data-stu-id="035f8-125">All methods that accept DirectComposition interfaces check whether the interface is implemented inside of dcomp.dll or whether it is implemented by another component.</span></span> <span data-ttu-id="035f8-126">Étant donné que DirectComposition n’est pas extensible, les méthodes qui prennent des interfaces comme paramètres retournent E \_ INVALIDARG si les interfaces ne sont pas implémentées dans dcomp.dll.</span><span class="sxs-lookup"><span data-stu-id="035f8-126">Because DirectComposition is not extensible, methods that take interfaces as parameters return E\_INVALIDARG if the interfaces are not implemented in dcomp.dll.</span></span> <span data-ttu-id="035f8-127">L’API ne requiert pas de privilèges spéciaux. Il peut être appelé par des processus s’exécutant au niveau d’accès le plus bas.</span><span class="sxs-lookup"><span data-stu-id="035f8-127">The API requires no special privileges; it can be called by processes running at the lowest level of access.</span></span> <span data-ttu-id="035f8-128">Toutefois, étant donné que l’API ne fonctionne pas dans la session 0, elle ne convient pas aux services.</span><span class="sxs-lookup"><span data-stu-id="035f8-128">However, because the API does not operate in session 0, it is not suitable for services.</span></span> <span data-ttu-id="035f8-129">À ces égards, l’API DirectComposition est similaire à d’autres API Microsoft DirectX, notamment Direct2D, Microsoft Direct3D et Microsoft DirectWrite.</span><span class="sxs-lookup"><span data-stu-id="035f8-129">In these respects, the DirectComposition API is similar to other Microsoft DirectX APIs, most notably Direct2D, Microsoft Direct3D, and Microsoft DirectWrite.</span></span>

<span data-ttu-id="035f8-130">Étant donné que le moteur de composition est conçu exclusivement pour une exécution asynchrone, les propriétés d’objet dans l’API DirectComposition sont en écriture seule.</span><span class="sxs-lookup"><span data-stu-id="035f8-130">Because the composition engine is designed exclusively for asynchronous execution, object properties in the DirectComposition API are write-only.</span></span> <span data-ttu-id="035f8-131">Toutes les propriétés ont des méthodes setter, mais pas des méthodes getter.</span><span class="sxs-lookup"><span data-stu-id="035f8-131">All properties have setter methods, but not getter methods.</span></span> <span data-ttu-id="035f8-132">La lecture des propriétés n’est pas seulement gourmande en ressources, mais elle peut également être inexacte, car toute valeur retournée par le moteur de composition peut devenir immédiatement non valide.</span><span class="sxs-lookup"><span data-stu-id="035f8-132">Reading properties is not only resource intensive, but can also be inaccurate because any value that the composition engine returns can immediately become invalid.</span></span> <span data-ttu-id="035f8-133">Cela peut se produire si, par exemple, une animation indépendante est liée à la propriété en cours de lecture.</span><span class="sxs-lookup"><span data-stu-id="035f8-133">This can happen if, for example, an independent animation is bound to the property that is being read.</span></span>

<span data-ttu-id="035f8-134">L’API est thread-safe.</span><span class="sxs-lookup"><span data-stu-id="035f8-134">The API is thread-safe.</span></span> <span data-ttu-id="035f8-135">Une application peut appeler n’importe quelle méthode à tout moment à partir de n’importe quel thread.</span><span class="sxs-lookup"><span data-stu-id="035f8-135">An application can call any method from any thread at any time.</span></span> <span data-ttu-id="035f8-136">Toutefois, étant donné que de nombreuses méthodes d’API doivent être appelées dans une séquence particulière, sans synchronisation, une application peut rencontrer un comportement imprévisible en fonction de la façon dont les threads entrelacent.</span><span class="sxs-lookup"><span data-stu-id="035f8-136">However, because many API methods must be called in a particular sequence, without any synchronization an application can experience unpredictable behavior depending on how the threads interleave.</span></span> <span data-ttu-id="035f8-137">Par exemple, si deux threads modifient la même propriété du même objet en différentes valeurs en même temps, l’application ne peut pas prédire laquelle des deux valeurs sera la valeur finale de la propriété.</span><span class="sxs-lookup"><span data-stu-id="035f8-137">For example, if two threads change the same property of the same object to different values at the same time, the application cannot predict which of the two values will be the final value of the property.</span></span> <span data-ttu-id="035f8-138">De même, si deux threads appellent une [**validation**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) sur le même appareil, aucun thread ne reçoit véritablement le comportement transactionnel, car un appel à **Commit** sur un thread envoie le lot de toutes les commandes émises par les deux threads, pas seulement celui qui a appelé **Commit**.</span><span class="sxs-lookup"><span data-stu-id="035f8-138">Similarly, if two threads call [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) on the same device, neither thread gets truly transactional behavior because a call to **Commit** on one thread will submit the batch of all commands issued by both threads, not just the one that called **Commit**.</span></span>

<span data-ttu-id="035f8-139">Le système conserve tous les États internes par objet appareil.</span><span class="sxs-lookup"><span data-stu-id="035f8-139">The system maintains all internal state per device object.</span></span> <span data-ttu-id="035f8-140">Si une application crée au moins deux objets d’appareil DirectComposition, l’application peut gérer des lots indépendants et d’autres États entre les deux.</span><span class="sxs-lookup"><span data-stu-id="035f8-140">If an application creates two or more DirectComposition device objects, the application can maintain independent batches and other state between the two.</span></span>

<span data-ttu-id="035f8-141">Tous les objets DirectComposition ont une affinité d’objet d’appareil ; les objets créés par un objet appareil particulier ne peuvent être utilisés qu’avec cet objet appareil et ne peuvent être associés qu’à d’autres objets créés par le même objet appareil.</span><span class="sxs-lookup"><span data-stu-id="035f8-141">All DirectComposition objects have device object affinity; objects created by a particular device object can be used only with that device object, and can be associated only with other objects created by the same device object.</span></span> <span data-ttu-id="035f8-142">En d’autres termes, chaque objet d’appareil est un îlot de fonctionnalités séparé.</span><span class="sxs-lookup"><span data-stu-id="035f8-142">In other words, each device object is a separate disjoint island of functionality.</span></span> <span data-ttu-id="035f8-143">La seule exception est la classe visuelle, qui permet de générer des arborescences visuelles où un visuel peut appartenir à un objet appareil différent de son parent.</span><span class="sxs-lookup"><span data-stu-id="035f8-143">The one exception is the visual class, which permits the building of visual trees where a visual can belong to a different device object than its parent.</span></span> <span data-ttu-id="035f8-144">Cela permet des scénarios dans lesquels une application et un contrôle peuvent gérer une arborescence de composition unique sans avoir besoin de partager un seul objet d’appareil DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="035f8-144">This enables scenarios where an application and a control can manage a single composition tree without also needing to share a single DirectComposition device object.</span></span>

## <a name="composition-engine"></a><span data-ttu-id="035f8-145">Moteur de composition</span><span class="sxs-lookup"><span data-stu-id="035f8-145">Composition engine</span></span>

<span data-ttu-id="035f8-146">Le moteur de composition DirectComposition s’exécute sur un processus dédié, distinct de tout processus d’application.</span><span class="sxs-lookup"><span data-stu-id="035f8-146">The DirectComposition composition engine runs on a dedicated process, separate from any application process.</span></span> <span data-ttu-id="035f8-147">Un processus de composition unique, dwm.exe, prend en charge toutes les applications d’une session.</span><span class="sxs-lookup"><span data-stu-id="035f8-147">A single composition process, dwm.exe, supports every application in a session.</span></span> <span data-ttu-id="035f8-148">Chaque application peut créer deux arborescences d’éléments visuels pour chaque fenêtre qu’elle possède.</span><span class="sxs-lookup"><span data-stu-id="035f8-148">Each application can create two visual trees for each window that it owns.</span></span> <span data-ttu-id="035f8-149">Toutes les arborescences sont réellement implémentées sous la forme de sous-arborescences d’une arborescence d’éléments visuels plus grande qui englobe également les structures de composition du DWM.</span><span class="sxs-lookup"><span data-stu-id="035f8-149">All of the trees are actually implemented as subtrees of a larger visual tree that also encompasses the composition structures of DWM.</span></span> <span data-ttu-id="035f8-150">Le DWM construit une arborescence d’éléments visuels importante pour chaque bureau dans une session.</span><span class="sxs-lookup"><span data-stu-id="035f8-150">The DWM constructs one large visual tree for each desktop in a session.</span></span> <span data-ttu-id="035f8-151">Voici les principaux avantages de cette architecture :</span><span class="sxs-lookup"><span data-stu-id="035f8-151">Here are the key advantages to this architecture:</span></span>

-   <span data-ttu-id="035f8-152">Le moteur de composition a accès à toutes les bitmaps d’application et aux arborescences d’éléments visuels, ce qui permet l’interopérabilité entre les fenêtres et la composition.</span><span class="sxs-lookup"><span data-stu-id="035f8-152">The composition engine has access to all application bitmaps and visual trees, which enables cross-process window interoperability and composition.</span></span>
-   <span data-ttu-id="035f8-153">Le moteur de composition s’exécute dans un processus système approuvé distinct de tout processus d’application, ce qui permet aux applications disposant de droits d’accès insuffisants de composer en toute sécurité du contenu protégé.</span><span class="sxs-lookup"><span data-stu-id="035f8-153">The composition engine runs in a trusted system process that is separate from any application process, enabling applications that have low access rights to securely compose protected content.</span></span>
-   <span data-ttu-id="035f8-154">Le moteur de composition peut détecter si une fenêtre particulière est entièrement bloqués et éviter de gaspiller des ressources de processeur et d’unité de traitement graphique (GPU) pour la fenêtre.</span><span class="sxs-lookup"><span data-stu-id="035f8-154">The composition engine can detect when a particular window is fully occluded and avoid wasting CPU and graphics processing unit (GPU) resources composing for the window.</span></span>
-   <span data-ttu-id="035f8-155">Le moteur de composition peut composer directement la mémoire tampon d’arrière-plan de l’écran, ce qui évite d’avoir besoin d’une copie supplémentaire requise pour les moteurs de composition par processus.</span><span class="sxs-lookup"><span data-stu-id="035f8-155">The composition engine can compose directly to the screen back buffer, avoiding the need for an extra copy that is required for per-process composition engines.</span></span>
-   <span data-ttu-id="035f8-156">Toutes les applications partagent un seul appareil Direct3D pour la composition, ce qui permet d’économiser beaucoup de mémoire</span><span class="sxs-lookup"><span data-stu-id="035f8-156">All applications share a single Direct3D device for composition, which offers considerable memory savings</span></span>

<span data-ttu-id="035f8-157">L’arborescence d’éléments visuels est une structure conservée.</span><span class="sxs-lookup"><span data-stu-id="035f8-157">The visual tree is a retained structure.</span></span> <span data-ttu-id="035f8-158">L’API DirectComposition expose des méthodes pour modifier la structure dans des lots de modifications traitées atomiquement.</span><span class="sxs-lookup"><span data-stu-id="035f8-158">The DirectComposition API exposes methods to edit the structure in batches of changes that are processed atomically.</span></span> <span data-ttu-id="035f8-159">L’objet racine dans l’API DirectComposition est l’objet appareil, qui sert de fabrique pour tous les autres objets DirectComposition et contient une méthode appelée [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit).</span><span class="sxs-lookup"><span data-stu-id="035f8-159">The root object in the DirectComposition API is the device object, which serves as the factory for all other DirectComposition objects and contains a method called [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit).</span></span> <span data-ttu-id="035f8-160">Le moteur de composition ne reflète pas les modifications apportées par l’application à l’arborescence d’éléments visuels tant que l’application n’appelle pas la **validation**, auquel cas toutes les modifications apportées depuis la dernière **validation** sont traitées comme une transaction unique.</span><span class="sxs-lookup"><span data-stu-id="035f8-160">The composition engine does not reflect any changes that the application makes to the visual tree until the application calls **Commit**, at which point all changes since the last **Commit** are processed as a single transaction.</span></span>

<span data-ttu-id="035f8-161">La nécessité d’appeler la [**validation**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) est similaire au concept de « frame », à l’exception du fait que le moteur de composition s’exécute de façon asynchrone, il peut présenter plusieurs frames différents entre les appels à **Commit**.</span><span class="sxs-lookup"><span data-stu-id="035f8-161">The requirement to call [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit) is similar to the concept of a "frame" except that, because the composition engine runs asynchronously, it can present several different frames between calls to **Commit**.</span></span> <span data-ttu-id="035f8-162">Dans DirectComposition, un *Frame* est une itération unique du moteur de composition, et l’intervalle passé par une application entre deux appels à **Commit** est appelé un *lot*.</span><span class="sxs-lookup"><span data-stu-id="035f8-162">In DirectComposition, a *frame* is a single iteration of the composition engine, and the interval spent by an application between two calls to **Commit** is called a *batch*.</span></span>

<span data-ttu-id="035f8-163">DirectComposition regroupe tous les appels d’application à l’API DirectComposition.</span><span class="sxs-lookup"><span data-stu-id="035f8-163">DirectComposition batches all application calls to the DirectComposition API.</span></span> <span data-ttu-id="035f8-164">La base de données d’objets de noyau, qui est implémentée dans le pilote de session win32k.sys, stocke toutes les informations d’état associées aux appels d’API.</span><span class="sxs-lookup"><span data-stu-id="035f8-164">The kernel object database, which is implemented in the win32k.sys session driver, stores all state information that is associated with the API calls.</span></span>

<span data-ttu-id="035f8-165">Le moteur de composition produit une image pour chaque espace vertical dans l’affichage.</span><span class="sxs-lookup"><span data-stu-id="035f8-165">The composition engine produces one frame for each vertical blank in the display.</span></span> <span data-ttu-id="035f8-166">Le frame est démarré à un espace vertical et cible le champ vertical suivant.</span><span class="sxs-lookup"><span data-stu-id="035f8-166">The frame is started at a vertical blank and targets the subsequent vertical blank.</span></span> <span data-ttu-id="035f8-167">Lorsque le frame démarre, le moteur de composition récupère tous les lots en attente et comprend leurs commandes dans ce frame.</span><span class="sxs-lookup"><span data-stu-id="035f8-167">When the frame starts, the composition engine picks up all pending batches and includes their commands in that frame.</span></span> <span data-ttu-id="035f8-168">Les lots sont placés dans une file d’attente en attente lorsque l’application appelle [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit), et la file d’attente en attente est vidée atomiquement au début du frame.</span><span class="sxs-lookup"><span data-stu-id="035f8-168">Batches are placed in a pending queue when the application calls [**Commit**](/windows/win32/api/dcomp/nf-dcomp-idcompositiondevice-commit), and the pending queue is flushed atomically at the beginning of the frame.</span></span> <span data-ttu-id="035f8-169">Par conséquent, il existe un point unique dans le temps qui marque le début d’une image.</span><span class="sxs-lookup"><span data-stu-id="035f8-169">Therefore, there is a single point in time that marks the beginning of a frame.</span></span> <span data-ttu-id="035f8-170">Tous les lots soumis avant ce point sont inclus dans le cadre, tandis que tous les lots soumis après doivent attendre que le frame suivant soit traité.</span><span class="sxs-lookup"><span data-stu-id="035f8-170">Any batches submitted before this point are included in the frame, while any batches submitted after must wait until the next frame to be processed.</span></span> <span data-ttu-id="035f8-171">La boucle de composition complète se présente comme suit :</span><span class="sxs-lookup"><span data-stu-id="035f8-171">The full composition loop is as follows:</span></span>

1.  <span data-ttu-id="035f8-172">Estimer l’heure de la zone verticale suivante.</span><span class="sxs-lookup"><span data-stu-id="035f8-172">Estimate the time of the next vertical blank.</span></span>
2.  <span data-ttu-id="035f8-173">Récupérer tous les lots en attente.</span><span class="sxs-lookup"><span data-stu-id="035f8-173">Retrieve all pending batches.</span></span>
3.  <span data-ttu-id="035f8-174">Traitez les lots récupérés.</span><span class="sxs-lookup"><span data-stu-id="035f8-174">Process the retrieved batches.</span></span>
4.  <span data-ttu-id="035f8-175">Mettez à jour toutes les animations à l’aide du temps estimé à l’étape 1.</span><span class="sxs-lookup"><span data-stu-id="035f8-175">Update all animations using the time estimated in step 1.</span></span>
5.  <span data-ttu-id="035f8-176">Déterminez les régions de l’écran qui doivent être recomposées.</span><span class="sxs-lookup"><span data-stu-id="035f8-176">Determine the regions of the screen that need to be re-composed.</span></span>
6.  <span data-ttu-id="035f8-177">Ré-composez les régions modifiées.</span><span class="sxs-lookup"><span data-stu-id="035f8-177">Re-compose the dirty regions.</span></span>
7.  <span data-ttu-id="035f8-178">Présentez le frame en retournant les mémoires tampons d’arrière-plan et d’avant pour chaque écran.</span><span class="sxs-lookup"><span data-stu-id="035f8-178">Present the frame by flipping the back and front buffers for each screen.</span></span>
8.  <span data-ttu-id="035f8-179">Si rien n’a été composé et présenté aux étapes 6 et 7, attendez la validation d’un lot.</span><span class="sxs-lookup"><span data-stu-id="035f8-179">If nothing was composed and presented in steps 6 and 7, wait for a batch to be committed.</span></span>
9.  <span data-ttu-id="035f8-180">Attendez le prochain espace vertical.</span><span class="sxs-lookup"><span data-stu-id="035f8-180">Wait for the next vertical blank.</span></span>

<span data-ttu-id="035f8-181">Si plusieurs moniteurs sont attachés à une seule carte vidéo, le moteur de composition utilise la zone verticale du moniteur principal pour piloter la boucle de composition et définir les heures d’échantillonnage de l’animation.</span><span class="sxs-lookup"><span data-stu-id="035f8-181">If there are multiple monitors attached to a single video adapter, the composition engine uses the vertical blank of the primary monitor to drive the composition loop and set the animation sampling times.</span></span> <span data-ttu-id="035f8-182">Chaque moniteur est représenté par une chaîne de retournement plein écran distincte ; le moteur de composition répète les étapes 6 et 7 pour chaque analyse, en mode tourniquet (Round Robin), à l’aide d’un seul appareil Direct3D.</span><span class="sxs-lookup"><span data-stu-id="035f8-182">Each monitor is represented by a separate full-screen flip chain; the composition engine repeats steps 6 and 7 for each monitor, in a round-robin fashion, using a single Direct3D device.</span></span> <span data-ttu-id="035f8-183">S’il existe également plusieurs cartes vidéo, le moteur de composition utilise un appareil Direct3D distinct pour chaque carte vidéo des étapes 6 et 7.</span><span class="sxs-lookup"><span data-stu-id="035f8-183">If there are also multiple video adapters, the composition engine uses a separate Direct3D device for each video adapter in steps 6 and 7.</span></span>

<span data-ttu-id="035f8-184">Les frames de composition sont planifiés pour toujours démarrer à un espace vertical, comme le montre l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="035f8-184">Composition frames are scheduled to always start at a vertical blank, as the following illustration shows.</span></span>

![planification du cadre de la composition](images/composition-frame-scheduling.png)

<span data-ttu-id="035f8-186">Si le moteur de composition n’a pas de travail à effectuer parce que l’arborescence de composition n’a pas changé, le thread de composition se met en veille en attendant un nouveau lot.</span><span class="sxs-lookup"><span data-stu-id="035f8-186">If the composition engine has no work to do because the composition tree has not changed, the composition thread sleeps while waiting for a new batch.</span></span> <span data-ttu-id="035f8-187">Lors de l’envoi d’un nouveau lot, le thread de composition s’active, mais revient immédiatement en mode veille jusqu’à ce que le champ vertical suivant soit renseigné.</span><span class="sxs-lookup"><span data-stu-id="035f8-187">When a new batch is submitted, the composition thread wakes up but immediately goes back to sleep until the next vertical blank.</span></span> <span data-ttu-id="035f8-188">Ce comportement garantit des heures de début et de fin de trame prévisibles pour les applications et pour le moteur de composition.</span><span class="sxs-lookup"><span data-stu-id="035f8-188">This behavior ensures predictable frame start and end times for applications and for the composition engine.</span></span>

<span data-ttu-id="035f8-189">Le moteur de composition publie les durées de présentation du cadre et la fréquence d’images actuelle.</span><span class="sxs-lookup"><span data-stu-id="035f8-189">The composition engine publishes the frame presentation times and the current frame rate.</span></span> <span data-ttu-id="035f8-190">La publication de ces informations permet aux applications d’estimer l’heure de présentation de leurs propres lots, ce qui à son tour permet la synchronisation des animations.</span><span class="sxs-lookup"><span data-stu-id="035f8-190">Publishing this information enables applications to estimate the presentation time for their own batches, which in turns enables animations to be synchronized.</span></span> <span data-ttu-id="035f8-191">En particulier, une application peut utiliser une combinaison de statistiques de frame à partir du moteur de composition, et un modèle historique de la durée de son thread de l’interface utilisateur pour produire un lot, afin de déterminer la durée d’échantillonnage pour ses propres animations.</span><span class="sxs-lookup"><span data-stu-id="035f8-191">In particular, an application can use a combination of frame statistics from the composition engine, and a historical model of how long its UI thread takes to produce a batch, to determine the sampling time for its own animations.</span></span>

<span data-ttu-id="035f8-192">Par exemple, au début du lot d’applications présenté dans l’illustration précédente, l’application peut interroger le moteur de composition pour déterminer l’heure exacte de présentation du cadre suivant.</span><span class="sxs-lookup"><span data-stu-id="035f8-192">For example, at the beginning of the application batch shown in the previous illustration, the application can query the composition engine to determine the exact presentation time of the next frame.</span></span> <span data-ttu-id="035f8-193">L’application peut ensuite utiliser l’heure actuelle, ainsi que des informations sur les traitements précédents qu’elle a générés, afin de déterminer si l’application peut terminer le traitement en cours avant le prochain espace vertical.</span><span class="sxs-lookup"><span data-stu-id="035f8-193">The application can then use the current time, along with information about previous batches that it has produced, to determine whether the application can complete the current batch before the next vertical blank.</span></span> <span data-ttu-id="035f8-194">Par conséquent, l’application utilise l’heure de présentation du frame comme durée d’échantillonnage pour ses propres animations.</span><span class="sxs-lookup"><span data-stu-id="035f8-194">Therefore, the application uses the frame presentation time as the sampling time for its own animations.</span></span> <span data-ttu-id="035f8-195">Si l’application détermine qu’il est peu probable qu’elle ne termine pas son travail dans le champ vertical actuel, l’application peut utiliser la durée d’image suivante comme durée d’échantillonnage à la place, en utilisant les informations de fréquence d’images retournées par le moteur de composition pour calculer cette durée.</span><span class="sxs-lookup"><span data-stu-id="035f8-195">If the application determines that it is unlikely to complete its work in the current vertical blank, the application can use the subsequent frame time as the sampling time instead, using the frame rate information returned by the composition engine to compute that time.</span></span>

## <a name="related-topics"></a><span data-ttu-id="035f8-196">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="035f8-196">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="035f8-197">Concepts DirectComposition</span><span class="sxs-lookup"><span data-stu-id="035f8-197">DirectComposition Concepts</span></span>](directcomposition-concepts.md)
</dt> </dl>

 

 