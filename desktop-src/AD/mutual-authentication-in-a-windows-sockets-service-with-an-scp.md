---
title: Authentification mutuelle dans un service Windows Sockets avec SCP
description: Les rubriques de cette section incluent des exemples de code qui montrent comment effectuer une authentification mutuelle avec un service qui se publie lui-même à l’aide d’un point de connexion de service (SCP).
ms.assetid: f730464c-95ac-4285-960c-18862f6f7852
ms.tgt_platform: multiple
keywords:
- Authentification mutuelle dans un service Windows Sockets avec une publicité SCP
- Active Directory, utilisation de, authentification mutuelle, service Windows Sockets avec un SCP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 527715c4a35dc15cd67f5820e6fa891b56452399
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/17/2020
ms.locfileid: "103842061"
---
# <a name="mutual-authentication-in-a-windows-sockets-service-with-scp"></a><span data-ttu-id="a4bc6-105">Authentification mutuelle dans un service Windows Sockets avec SCP</span><span class="sxs-lookup"><span data-stu-id="a4bc6-105">Mutual Authentication in a Windows Sockets Service with SCP</span></span>

<span data-ttu-id="a4bc6-106">Les rubriques de cette section incluent des exemples de code qui montrent comment effectuer une authentification mutuelle avec un service qui se publie lui-même à l’aide d’un point de connexion de service (SCP).</span><span class="sxs-lookup"><span data-stu-id="a4bc6-106">The topics in this section include code examples that show how to perform mutual authentication with a service that publishes itself using a service connection point (SCP).</span></span> <span data-ttu-id="a4bc6-107">Les exemples sont basés sur un service Microsoft Windows Sockets qui utilise un package SSPI pour gérer la négociation de l’authentification mutuelle entre un client et le service.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-107">The examples are based on a Microsoft Windows Sockets service that uses an SSPI package to handle the mutual authentication negotiation between a client and the service.</span></span> <span data-ttu-id="a4bc6-108">Utilisez les procédures suivantes pour implémenter l’authentification mutuelle dans ce scénario.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-108">Use the following procedures to implement mutual authentication within this scenario.</span></span>

<span data-ttu-id="a4bc6-109">**Pour inscrire des noms de principal du service dans un répertoire lors de l’installation d’un service**</span><span class="sxs-lookup"><span data-stu-id="a4bc6-109">**To register SPNs in a directory when a service is installed**</span></span>

1.  <span data-ttu-id="a4bc6-110">Appelez la fonction [**DsGetSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) pour composer des noms de principal du service (SPN) pour le service.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-110">Call the [**DsGetSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) function to compose service principal names (SPNs) for the service.</span></span>
2.  <span data-ttu-id="a4bc6-111">Appelez la fonction [**DsWriteAccountSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) pour enregistrer les noms de principal du service sur le compte de service ou le compte d’ordinateur dans le contexte duquel le service s’exécutera.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-111">Call the [**DsWriteAccountSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) function to register the SPNs on the service account or computer account in whose context the service will run.</span></span> <span data-ttu-id="a4bc6-112">Cette étape doit être effectuée par un administrateur de domaine. une exception est qu’un service s’exécutant sous le compte LocalSystem peut inscrire son SPN sous la forme « <service class> / <host> » sur le compte d’ordinateur de l’hôte de service.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-112">This step must be performed by a domain administrator; an exception is that a service running under the LocalSystem account can register its SPN in the form "<service class>/<host>" on the computer account of the service host.</span></span>

<span data-ttu-id="a4bc6-113">**Pour vérifier la configuration au démarrage du service**</span><span class="sxs-lookup"><span data-stu-id="a4bc6-113">**To verify configuration at service startup**</span></span>

-   <span data-ttu-id="a4bc6-114">Vérifiez que les SPN appropriés sont enregistrés sur le compte sous lequel le service est en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-114">Verify that the appropriate SPNs are registered on the account under which the service is running.</span></span> <span data-ttu-id="a4bc6-115">Pour plus d’informations, consultez [tâches de maintenance de compte d’ouverture de session](logon-account-maintenance-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="a4bc6-115">For more information, see [Logon Account Maintenance Tasks](logon-account-maintenance-tasks.md).</span></span>

<span data-ttu-id="a4bc6-116">**Pour authentifier le service au démarrage du client**</span><span class="sxs-lookup"><span data-stu-id="a4bc6-116">**To authenticate the service at client startup**</span></span>

1.  <span data-ttu-id="a4bc6-117">Récupérez les données de connexion du point de connexion de service du service.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-117">Retrieve connection data from the service's service connection point.</span></span>
2.  <span data-ttu-id="a4bc6-118">Établissez une connexion au service.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-118">Establish a connection to the service.</span></span>
3.  <span data-ttu-id="a4bc6-119">Appelez la fonction [**DsMakeSpn**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) pour composer un SPN pour le service.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-119">Call the [**DsMakeSpn**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) function to compose an SPN for the service.</span></span> <span data-ttu-id="a4bc6-120">Composez le nom de principal du service à partir de la chaîne de classe de service connue et les données récupérées à partir du point de connexion de service.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-120">Compose the SPN from the known service class string, and the data retrieved from the service connection point.</span></span> <span data-ttu-id="a4bc6-121">Ces données incluent le nom d’hôte du serveur sur lequel le service est en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-121">This data includes the host name of the server on which the service is running.</span></span> <span data-ttu-id="a4bc6-122">N’oubliez pas que le nom d’hôte doit être un nom DNS.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-122">Be aware that the host name must be a DNS name.</span></span>
4.  <span data-ttu-id="a4bc6-123">Utilisez un package de sécurité SSPI pour effectuer l’authentification :</span><span class="sxs-lookup"><span data-stu-id="a4bc6-123">Use an SSPI security package to perform the authentication:</span></span>
    1.  <span data-ttu-id="a4bc6-124">Appelez la fonction [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) pour obtenir les informations d’identification du client.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-124">Call the [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) function to acquire the client's credentials.</span></span>
    2.  <span data-ttu-id="a4bc6-125">Transmettez les informations d’identification du client et le SPN à la fonction [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) pour générer un objet blob de sécurité à envoyer au service à des fins d’authentification.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-125">Pass the client credentials and the SPN to the [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) function to generate a security blob to send to the service for authentication.</span></span> <span data-ttu-id="a4bc6-126">Définissez l’indicateur d’authentification **\_ \_ mutuelle \_ d’ISC req** pour demander l’authentification mutuelle.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-126">Set the **ISC\_REQ\_MUTUAL\_AUTH** flag to request mutual authentication.</span></span>
    3.  <span data-ttu-id="a4bc6-127">Échangez des objets BLOB avec le service jusqu’à ce que l’authentification soit terminée.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-127">Exchange blobs with the service until the authentication is complete.</span></span>
5.  <span data-ttu-id="a4bc6-128">Vérifiez le masque des fonctionnalités renvoyées pour l’indicateur d’authentification **\_ \_ mutuelle \_ req req** pour vérifier que l’authentification mutuelle a été effectuée.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-128">Verify the returned capabilities mask for the **ISC\_REQ\_MUTUAL\_AUTH** flag to verify that mutual authentication was performed.</span></span>
6.  <span data-ttu-id="a4bc6-129">Si l’authentification a réussi, échangez le trafic avec le service authentifié.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-129">If the authentication was successful, exchange traffic with the authenticated service.</span></span> <span data-ttu-id="a4bc6-130">Utilisez la signature numérique pour vous assurer que les messages entre le client et le service n’ont pas été falsifiés.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-130">Use digital signing to ensure that messages between client and service have not been tampered with.</span></span> <span data-ttu-id="a4bc6-131">À moins que les exigences en matière de performances ne soient graves, utilisez le chiffrement.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-131">Unless performance requirements are severe, use encryption.</span></span> <span data-ttu-id="a4bc6-132">Pour plus d’informations et pour obtenir un exemple de code qui montre comment utiliser les fonctions [**MakeSignature**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**EncryptMessage**](../SecAuthN/encryptmessage--general.md)et [**DecryptMessage**](../SecAuthN/decryptmessage--general.md) dans un package SSPI, consultez [garantie de l’intégrité des communications pendant l’échange de messages](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).</span><span class="sxs-lookup"><span data-stu-id="a4bc6-132">For more information and a code example that shows how to use the [**MakeSignature**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**EncryptMessage**](../SecAuthN/encryptmessage--general.md), and [**DecryptMessage**](../SecAuthN/decryptmessage--general.md) functions in an SSPI package, see [Ensuring Communication Integrity During Message Exchange](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).</span></span>

<span data-ttu-id="a4bc6-133">**Pour authentifier le client par le service lorsqu’un client se connecte**</span><span class="sxs-lookup"><span data-stu-id="a4bc6-133">**To authenticate the client by the service when a client connects**</span></span>

1.  <span data-ttu-id="a4bc6-134">Chargez un package de sécurité SSPI qui prend en charge l’authentification mutuelle.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-134">Load an SSPI security package that supports mutual authentication.</span></span>
2.  <span data-ttu-id="a4bc6-135">Lorsqu’un client se connecte, utilisez le package de sécurité pour effectuer l’authentification :</span><span class="sxs-lookup"><span data-stu-id="a4bc6-135">When a client connects, use the security package to perform the authentication:</span></span>
    1.  <span data-ttu-id="a4bc6-136">Appelez la fonction [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) pour obtenir les informations d’identification du service.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-136">Call the [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) function to acquire the service credentials.</span></span>
    2.  <span data-ttu-id="a4bc6-137">Transmettez les informations d’identification du service et l’objet blob de sécurité reçues du client à la fonction [**AcceptSecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) pour générer un objet blob de sécurité à renvoyer au client.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-137">Pass the service credentials and the security blob received from the client to the [**AcceptSecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) function to generate a security blob to send back to the client.</span></span>
    3.  <span data-ttu-id="a4bc6-138">Échangez des objets BLOB avec le client jusqu’à ce que l’authentification soit terminée.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-138">Exchange blobs with the client until the authentication is complete.</span></span>
3.  <span data-ttu-id="a4bc6-139">Vérifiez le masque des fonctionnalités renvoyées pour l’indicateur d’authentification **\_ \_ mutuelle \_ ASC RET** afin de vérifier que l’authentification mutuelle a été effectuée.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-139">Check the returned capabilities mask for the **ASC\_RET\_MUTUAL\_AUTH** flag to verify that mutual authentication was performed.</span></span>
4.  <span data-ttu-id="a4bc6-140">Si l’authentification a réussi, échangez le trafic avec le client authentifié.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-140">If the authentication was successful, exchange traffic with the authenticated client.</span></span> <span data-ttu-id="a4bc6-141">Utilisez la signature numérique et le chiffrement, sauf si les performances sont un problème.</span><span class="sxs-lookup"><span data-stu-id="a4bc6-141">Use digital signing and encryption unless performance is an issue.</span></span>

<span data-ttu-id="a4bc6-142">Pour plus d’informations et pour obtenir un exemple de code pour ce scénario d’authentification mutuelle, consultez :</span><span class="sxs-lookup"><span data-stu-id="a4bc6-142">For more information and a code example for this mutual authentication scenario, see:</span></span>

-   [<span data-ttu-id="a4bc6-143">Comment un client authentifie un service Windows Sockets SCP</span><span class="sxs-lookup"><span data-stu-id="a4bc6-143">How a Client Authenticates an SCP-based Windows Sockets Service</span></span>](how-a-client-authenticates-an-scp-based-windows-sockets-service.md)
-   [<span data-ttu-id="a4bc6-144">Composition et inscription de SPN pour un service Windows Sockets SCP</span><span class="sxs-lookup"><span data-stu-id="a4bc6-144">Composing and Registering SPNs for an SCP-based Windows Sockets Service</span></span>](composing-and-registering-spns-for-an-scp-based-windows-sockets-service.md)
-   [<span data-ttu-id="a4bc6-145">Comment un service Windows Sockets authentifie un client</span><span class="sxs-lookup"><span data-stu-id="a4bc6-145">How a Windows Sockets Service Authenticates a Client</span></span>](how-a-windows-sockets-service-authenticates-a-client.md)

<span data-ttu-id="a4bc6-146">Pour plus d’informations, consultez :</span><span class="sxs-lookup"><span data-stu-id="a4bc6-146">For more information, see:</span></span>

-   [<span data-ttu-id="a4bc6-147">Publication avec des points de connexion de service</span><span class="sxs-lookup"><span data-stu-id="a4bc6-147">Publishing with service connection points</span></span>](publishing-with-service-connection-points.md)
-   [<span data-ttu-id="a4bc6-148">Documentation SSPI</span><span class="sxs-lookup"><span data-stu-id="a4bc6-148">SSPI documentation</span></span>](/windows/desktop/SecAuthN/sspi)
-   [<span data-ttu-id="a4bc6-149">Documentation Windows Sockets</span><span class="sxs-lookup"><span data-stu-id="a4bc6-149">Windows Sockets documentation</span></span>](/windows/desktop/WinSock/windows-sockets-start-page-2)

 

 