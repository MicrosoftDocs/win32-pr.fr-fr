---
title: Interrogation des modifications à l’aide de USNChanged
description: Les modifications de Active Directory peuvent également être obtenues en interrogeant l’attribut uSNChanged, ce qui évite les limitations du contrôle DirSync.
ms.assetid: 83bda359-09e5-4abf-8f60-9c63bccfcdd1
ms.tgt_platform: multiple
keywords:
- Interrogation des modifications à l’aide de USNChanged AD
- USNChanged AD
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a8e062c84fae575f837f45d78be7c92e5e284c1e
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/17/2020
ms.locfileid: "103842049"
---
# <a name="polling-for-changes-using-usnchanged"></a><span data-ttu-id="60230-105">Interrogation des modifications à l’aide de USNChanged</span><span class="sxs-lookup"><span data-stu-id="60230-105">Polling for Changes Using USNChanged</span></span>

<span data-ttu-id="60230-106">Le contrôle DirSync est puissant et efficace, mais il présente deux limitations importantes :</span><span class="sxs-lookup"><span data-stu-id="60230-106">The DirSync control is powerful and efficient, but has two significant limitations:</span></span>

-   <span data-ttu-id="60230-107">Pour les applications à privilèges élevés : pour utiliser le contrôle DirSync, une application doit s’exécuter sous un compte dont le nom de l' **\_ agent de synchronisation \_ \_ se** porte sur le contrôleur de domaine.</span><span class="sxs-lookup"><span data-stu-id="60230-107">Only for highly privileged applications: To use the DirSync control, an application must run under an account that has the **SE\_SYNC\_AGENT\_NAME** privilege on the domain controller.</span></span> <span data-ttu-id="60230-108">Peu de comptes sont tellement privilégiés. par conséquent, une application qui utilise le contrôle DirSync ne peut pas être exécutée par des utilisateurs ordinaires.</span><span class="sxs-lookup"><span data-stu-id="60230-108">Few accounts are so highly privileged, so an application that uses the DirSync control cannot be run by ordinary users.</span></span>
-   <span data-ttu-id="60230-109">Aucune étendue de sous-arborescence : le contrôle DirSync retourne toutes les modifications qui se produisent dans un contexte d’appellation.</span><span class="sxs-lookup"><span data-stu-id="60230-109">No subtree scoping: The DirSync control returns all changes that occur within a naming context.</span></span> <span data-ttu-id="60230-110">Une application qui s’intéresse uniquement aux modifications apportées à une petite sous-arborescence d’un contexte d’appellation doit parcourir de nombreuses modifications non pertinentes, ce qui est inefficace à la fois pour l’application et pour le contrôleur de domaine.</span><span class="sxs-lookup"><span data-stu-id="60230-110">An application interested only in changes that occur in a small subtree of a naming context must wade through many irrelevant changes, which is inefficient both for the application and for the domain controller.</span></span>

<span data-ttu-id="60230-111">Les modifications de Active Directory peuvent également être obtenues en interrogeant l’attribut [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) , ce qui évite les limitations du contrôle DirSync.</span><span class="sxs-lookup"><span data-stu-id="60230-111">Changes from Active Directory can also be obtained by querying the [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute, which avoids the limitations of the DirSync control.</span></span> <span data-ttu-id="60230-112">Cette alternative n’est pas mieux que le contrôle DirSync dans tous les cas, car elle implique la transmission de tous les attributs lorsqu’un attribut change et qu’elle nécessite plus de travail du développeur de l’application pour gérer correctement certains scénarios d’échec.</span><span class="sxs-lookup"><span data-stu-id="60230-112">This alternative is not better than the DirSync control in all respects because it involves transmitting all attributes when any attribute changes and it requires more work from the application developer to handle certain failure scenarios correctly.</span></span> <span data-ttu-id="60230-113">Il s’agit actuellement de la meilleure façon d’écrire certaines applications de suivi des modifications.</span><span class="sxs-lookup"><span data-stu-id="60230-113">It is, currently, the best way to write certain change-tracking applications.</span></span>

<span data-ttu-id="60230-114">Lorsqu’un contrôleur de domaine modifie un objet, il définit l’attribut [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) de cet objet sur une valeur supérieure à la valeur précédente de l’attribut **uSNChanged** pour cet objet, et supérieure à la valeur actuelle de l’attribut **uSNChanged** pour tous les autres objets détenus sur ce contrôleur de domaine.</span><span class="sxs-lookup"><span data-stu-id="60230-114">When a domain controller modifies an object it sets that object's [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute to a value that is larger than the previous value of the **uSNChanged** attribute for that object, and larger than the current value of the **uSNChanged** attribute for all other objects held on that domain controller.</span></span> <span data-ttu-id="60230-115">Par conséquent, une application peut trouver l’objet le plus récemment modifié sur un contrôleur de domaine en recherchant l’objet avec la plus grande valeur **uSNChanged** .</span><span class="sxs-lookup"><span data-stu-id="60230-115">As a consequence, an application can find the most recently changed object on a domain controller by finding the object with the largest **uSNChanged** value.</span></span> <span data-ttu-id="60230-116">Le deuxième objet récemment modifié sur un contrôleur de domaine aura la deuxième valeur **uSNChanged** la plus grande, et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="60230-116">The second most recently changed object on a domain controller will have the second largest **uSNChanged** value, and so on.</span></span>

<span data-ttu-id="60230-117">L’attribut [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) n’est pas répliqué. par conséquent, la lecture de l’attribut **uSNChanged** d’un objet sur deux contrôleurs de domaine différents donne généralement des valeurs différentes.</span><span class="sxs-lookup"><span data-stu-id="60230-117">The [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute is not replicated, therefore reading an object's **uSNChanged** attribute at two different domain controllers will typically give different values.</span></span>

<span data-ttu-id="60230-118">Par exemple, l’attribut [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) peut être utilisé pour suivre les modifications apportées à une sous-arborescence S. Tout d’abord, effectuez une « synchronisation complète » de la sous-arborescence S. Supposons que la plus grande valeur **uSNChanged** pour tout objet dans s est U. interrogez régulièrement tous les objets de la sous-arborescence s dont la valeur **uSNChanged** est supérieure à u. La requête retourne tous les objets qui ont été modifiés depuis la synchronisation complète. Définissez la plus grande **uSNChanged** parmi ces objets modifiés, et vous êtes prêt à interroger à nouveau.</span><span class="sxs-lookup"><span data-stu-id="60230-118">For example, the [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute can be used to track changes in a subtree S. First, perform a "full sync" of the subtree S. Suppose the largest **uSNChanged** value for any object in S is U. Periodically query for all objects in subtree S whose **uSNChanged** value is greater than U. The query will return all objects that have changed since the full sync. Set U to the largest **uSNChanged** among these changed objects, and you are ready to poll again.</span></span>

<span data-ttu-id="60230-119">Les subtilités de l’implémentation d’une application de synchronisation [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="60230-119">The subtleties of implementing a [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) synchronization application include:</span></span>

-   <span data-ttu-id="60230-120">Utilisez l’attribut **highestCommittedUSN** de rootDSE pour lier vos filtres [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) .</span><span class="sxs-lookup"><span data-stu-id="60230-120">Use the **highestCommittedUSN** attribute of rootDSE to bound your [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) filters.</span></span> <span data-ttu-id="60230-121">Autrement dit, avant de démarrer une synchronisation complète, lisez le **highestCommittedUSN** de votre contrôleur de domaine affilié.</span><span class="sxs-lookup"><span data-stu-id="60230-121">That is, before starting a full sync, read the **highestCommittedUSN** of your affiliated domain controller.</span></span> <span data-ttu-id="60230-122">Effectuez ensuite une requête de synchronisation complète (à l’aide des résultats paginés) pour initialiser la base de données.</span><span class="sxs-lookup"><span data-stu-id="60230-122">Then, perform a full synchronization query (using paged results) to initialize the database.</span></span> <span data-ttu-id="60230-123">Une fois cette valeur effectuée, stockez la valeur **highestCommittedUSN** lue avant la requête de synchronisation complète. à utiliser comme limite inférieure de l’attribut **uSNChanged** pour la synchronisation suivante.</span><span class="sxs-lookup"><span data-stu-id="60230-123">When this is complete, store the **highestCommittedUSN** value read before the full sync query; to use as the lower bounds of the **uSNChanged** attribute for the next synchronization.</span></span> <span data-ttu-id="60230-124">Par la suite, pour effectuer une synchronisation incrémentielle, relisez l’attribut RootDSE **highestCommittedUSN** .</span><span class="sxs-lookup"><span data-stu-id="60230-124">Later, to perform an incremental synchronization, reread the **highestCommittedUSN** rootDSE attribute.</span></span> <span data-ttu-id="60230-125">Interrogez ensuite les objets pertinents à l’aide des résultats paginés, dont la valeur de **uSNChanged** est supérieure à la limite inférieure de la valeur d’attribut **uSNChanged** enregistrée à partir de la synchronisation précédente.</span><span class="sxs-lookup"><span data-stu-id="60230-125">Then query for relevant objects, using paged results, whose **uSNChanged** is greater than the lower bounds of the **uSNChanged** attribute value saved from the previous synchronization.</span></span> <span data-ttu-id="60230-126">Mettez à jour la base de données à l’aide de ces informations.</span><span class="sxs-lookup"><span data-stu-id="60230-126">Update the database using this information.</span></span> <span data-ttu-id="60230-127">Lorsque vous avez terminé, mettez à jour les limites inférieures de l’attribut **uSNChanged** à partir de la valeur **highestCommittedUSN** lue avant la requête de synchronisation incrémentielle.</span><span class="sxs-lookup"><span data-stu-id="60230-127">When complete, update the lower bounds of the **uSNChanged** attribute from the **highestCommittedUSN** value read before the incremental synchronization query.</span></span> <span data-ttu-id="60230-128">Stockez toujours les limites inférieures de la valeur de l’attribut **uSNChanged** dans le même stockage que l’application est en cours de synchronisation avec le contenu du contrôleur de domaine.</span><span class="sxs-lookup"><span data-stu-id="60230-128">Always store the lower bounds of the **uSNChanged** attribute value in the same storage that the application is synchronizing with the domain controller content.</span></span>

    <span data-ttu-id="60230-129">À la suite de cette procédure, plutôt que d’être basée sur les valeurs [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) sur les objets récupérés, vous évitez de faire en sorte que le serveur réexamine les objets mis à jour qui sont en dehors de l’ensemble applicable à l’application.</span><span class="sxs-lookup"><span data-stu-id="60230-129">Following this procedure, rather than that based on [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) values on retrieved objects, avoids making the server reexamine updated objects that fall outside the set that is applicable to the application.</span></span>

-   <span data-ttu-id="60230-130">Étant donné que [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) est un attribut non répliqué, l’application doit se lier au même contrôleur de domaine à chaque exécution.</span><span class="sxs-lookup"><span data-stu-id="60230-130">Because [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) is a non-replicated attribute, the application must bind to the same domain controller every time it runs.</span></span> <span data-ttu-id="60230-131">S’il ne peut pas effectuer de liaison à ce contrôleur de domaine, il doit attendre qu’il le fasse, ou être affilié à un nouveau contrôleur de domaine et effectuer une synchronisation complète avec ce contrôleur de domaine.</span><span class="sxs-lookup"><span data-stu-id="60230-131">If it cannot bind to that domain controller it must either wait until it can do so, or affiliate with some new domain controller and perform a full synchronization with that domain controller.</span></span> <span data-ttu-id="60230-132">Lorsque l’application est affiliée à un contrôleur de domaine, elle enregistre le nom DNS de ce contrôleur de domaine dans un stockage stable, qui est le même que celui qu’elle conserve en cohérence avec le contenu du contrôleur de domaine.</span><span class="sxs-lookup"><span data-stu-id="60230-132">When the application affiliates with a domain controller it records the DNS name of that domain controller in stable storage, which is the same storage it is keeping consistent with the domain controller content.</span></span> <span data-ttu-id="60230-133">Ensuite, il utilise le nom DNS stocké pour établir une liaison avec le même contrôleur de domaine pour les synchronisations suivantes.</span><span class="sxs-lookup"><span data-stu-id="60230-133">Then it uses the stored DNS name to bind to the same domain controller for subsequent synchronizations.</span></span>
-   <span data-ttu-id="60230-134">L’application doit détecter si le contrôleur de domaine auquel elle est actuellement affiliée a été restauré à partir d’une sauvegarde, car cela peut entraîner une incohérence.</span><span class="sxs-lookup"><span data-stu-id="60230-134">The application must detect when the domain controller it is currently affiliated with has been restored from backup, because this can cause inconsistency.</span></span> <span data-ttu-id="60230-135">Lorsque l’application est affiliée à un contrôleur de domaine, elle met en cache l’ID d’invocation de ce contrôleur de domaine dans un stockage stable, autrement dit, le même stockage que celui-ci est cohérent avec le contenu du contrôleur de domaine.</span><span class="sxs-lookup"><span data-stu-id="60230-135">When the application affiliates with a domain controller it caches the "invocation id" of that domain controller in stable storage, that is, the same storage it is keeping consistent with the domain controller content.</span></span> <span data-ttu-id="60230-136">L’ID d’invocation d’un contrôleur de domaine est un GUID stocké dans **l’attribut d’invocation de** l’objet de service du contrôleur de domaine.</span><span class="sxs-lookup"><span data-stu-id="60230-136">The "invocation id" of a domain controller is a GUID stored in the **invocationID** attribute of the domain controller's service object.</span></span> <span data-ttu-id="60230-137">Pour obtenir le nom unique de l’objet de service d’un contrôleur de domaine, lisez l’attribut **dsServiceName** de l’objet rootDSE.</span><span class="sxs-lookup"><span data-stu-id="60230-137">To get the distinguished name of a domain controller's service object, read the **dsServiceName** attribute of the rootDSE.</span></span>

    <span data-ttu-id="60230-138">Sachez que lorsque le stockage stable de l’application est restauré à partir d’une sauvegarde, il n’existe aucun problème de cohérence, car le nom du contrôleur de domaine, l’ID d’invocation et les limites inférieures de la valeur de l’attribut [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) sont stockés avec les données synchronisées avec le contenu du contrôleur de domaine.</span><span class="sxs-lookup"><span data-stu-id="60230-138">Be aware that when the application's stable storage is restored from backup there are no consistency problems because the domain controller name, invocation id, and lower bounds of the [**uSNChanged**](/windows/desktop/ADSchema/a-usnchanged) attribute value are stored with the data synchronized with the domain controller content.</span></span>

-   <span data-ttu-id="60230-139">Utilisez la pagination lors de l’interrogation du serveur, à la fois des synchronisations complètes et incrémentielles, afin d’éviter la possibilité de récupérer simultanément des jeux de résultats volumineux.</span><span class="sxs-lookup"><span data-stu-id="60230-139">Use paging when querying the server, both full and incremental synchronizations, to avoid the possibility of retrieving large result sets simultaneously.</span></span> <span data-ttu-id="60230-140">Pour plus d’informations, consultez [spécification d’autres options de recherche](specifying-other-search-options.md).</span><span class="sxs-lookup"><span data-stu-id="60230-140">For more information, see [Specifying Other Search Options](specifying-other-search-options.md).</span></span>
-   <span data-ttu-id="60230-141">Effectuez des requêtes basées sur les index pour éviter de forcer le serveur à stocker des résultats intermédiaires importants lors de l’utilisation de résultats paginés.</span><span class="sxs-lookup"><span data-stu-id="60230-141">Perform index-based queries to avoid forcing the server to store large intermediate results when using paged results.</span></span> <span data-ttu-id="60230-142">Pour plus d’informations, consultez [attributs indexés](indexed-attributes.md).</span><span class="sxs-lookup"><span data-stu-id="60230-142">For more information, see [Indexed Attributes](indexed-attributes.md).</span></span>
-   <span data-ttu-id="60230-143">En général, n’utilisez pas le tri côté serveur des résultats de recherche, ce qui peut forcer le serveur à stocker et à trier des résultats intermédiaires volumineux.</span><span class="sxs-lookup"><span data-stu-id="60230-143">In general, do not use server-side sorting of search results, which can force the server to store and sort large intermediate results.</span></span> <span data-ttu-id="60230-144">Cela s’applique à la fois aux synchronisations complètes et incrémentielles.</span><span class="sxs-lookup"><span data-stu-id="60230-144">This applies to both full and incremental synchronizations.</span></span> <span data-ttu-id="60230-145">Pour plus d’informations, consultez [spécification d’autres options de recherche](specifying-other-search-options.md).</span><span class="sxs-lookup"><span data-stu-id="60230-145">For more information, see [Specifying Other Search Options](specifying-other-search-options.md).</span></span>
-   <span data-ttu-id="60230-146">Ne gérez pas les conditions parentes normalement.</span><span class="sxs-lookup"><span data-stu-id="60230-146">Handle no parent conditions gracefully.</span></span> <span data-ttu-id="60230-147">L’application peut reconnaître un objet avant qu’il n’ait reconnu son parent.</span><span class="sxs-lookup"><span data-stu-id="60230-147">The application may recognize an object before it has recognized its parent.</span></span> <span data-ttu-id="60230-148">En fonction de l’application, cela peut ne pas être un problème.</span><span class="sxs-lookup"><span data-stu-id="60230-148">Depending upon the application, this may or may not be a problem.</span></span> <span data-ttu-id="60230-149">L’application peut toujours lire l’état actuel du parent à partir de l’annuaire.</span><span class="sxs-lookup"><span data-stu-id="60230-149">The application can always read the current state of the parent from the directory.</span></span>
-   <span data-ttu-id="60230-150">Pour gérer les objets déplacés ou supprimés, stockez l’attribut [**objectGUID**](/windows/desktop/ADSchema/a-objectguid) de chaque objet suivi.</span><span class="sxs-lookup"><span data-stu-id="60230-150">To handle moved or deleted objects, store the [**objectGUID**](/windows/desktop/ADSchema/a-objectguid) attribute of each tracked object.</span></span> <span data-ttu-id="60230-151">L’attribut **objectGUID** d’un objet reste inchangé, quel que soit l’emplacement où il est déplacé dans la forêt.</span><span class="sxs-lookup"><span data-stu-id="60230-151">An object's **objectGUID** attribute remains unchanged regardless of where it is moved throughout the forest.</span></span>
-   <span data-ttu-id="60230-152">Pour gérer les objets déplacés, effectuez des synchronisations complètes périodiques ou augmentez la portée de la recherche et filtrez les modifications non intéressantes à l’extrémité du client.</span><span class="sxs-lookup"><span data-stu-id="60230-152">To handle moved objects, either perform periodic full synchronizations or increase the search scope and filter out uninteresting changes at the client end.</span></span>
-   <span data-ttu-id="60230-153">Pour gérer les objets supprimés, effectuez des synchronisations complètes périodiques ou effectuez une recherche distincte des objets supprimés lorsque vous effectuez une synchronisation incrémentielle.</span><span class="sxs-lookup"><span data-stu-id="60230-153">To handle deleted objects, either perform periodic full synchronizations or perform a separate search for deleted objects when you perform an incremental synchronization.</span></span> <span data-ttu-id="60230-154">Lorsque vous interrogez des objets supprimés, récupérez l' [**objectGUID**](/windows/desktop/ADSchema/a-objectguid) des objets supprimés pour déterminer les objets à supprimer de votre base de données.</span><span class="sxs-lookup"><span data-stu-id="60230-154">When you query for deleted objects, retrieve the [**objectGUID**](/windows/desktop/ADSchema/a-objectguid) of the deleted objects to determine the objects to delete from your database.</span></span> <span data-ttu-id="60230-155">Pour plus d’informations, consultez [récupération des objets supprimés](retrieving-deleted-objects.md).</span><span class="sxs-lookup"><span data-stu-id="60230-155">For more information, see [Retrieving Deleted Objects](retrieving-deleted-objects.md).</span></span>
-   <span data-ttu-id="60230-156">Sachez que les résultats de la recherche incluent uniquement les objets et les attributs que l’appelant est autorisé à lire (en fonction des descripteurs de sécurité et des DACL sur les différents objets).</span><span class="sxs-lookup"><span data-stu-id="60230-156">Be aware that the search results include only the objects and attributes that the caller has permission to read (based on the security descriptors and DACLs on the various objects).</span></span> <span data-ttu-id="60230-157">Pour plus d’informations, consultez [effets de la sécurité sur les requêtes](effects-of-security-on-queries.md).</span><span class="sxs-lookup"><span data-stu-id="60230-157">For more information, see [Effects of Security on Queries](effects-of-security-on-queries.md).</span></span>

<span data-ttu-id="60230-158">Pour plus d’informations et pour obtenir un exemple de code qui illustre les principes de base d’une application de synchronisation USNChanged, consultez l' [exemple de code permettant de récupérer des modifications à l’aide de USNChanged](example-code-to-retrieve-changes-using-usnchanged.md).</span><span class="sxs-lookup"><span data-stu-id="60230-158">For more information, and a code example that shows the basics of a USNChanged synchronization application, see [Example Code to Retrieve Changes Using USNChanged](example-code-to-retrieve-changes-using-usnchanged.md).</span></span>

 

 