---
title: Restauration d’un serveur Active Directory
description: Les serveurs Active Directory doivent être restaurés hors connexion.
ms.assetid: 91fbbdc1-0e84-4b89-8a38-4c8d0268992b
ms.tgt_platform: multiple
keywords:
- Restauration de Active Directory Active Directory
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 273d02fd50d6b3bd68a055a6a783566e4ebddcf7
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/17/2020
ms.locfileid: "103842026"
---
# <a name="restoring-an-active-directory-server"></a><span data-ttu-id="fc4f5-104">Restauration d’un serveur Active Directory</span><span class="sxs-lookup"><span data-stu-id="fc4f5-104">Restoring an Active Directory Server</span></span>

<span data-ttu-id="fc4f5-105">Les serveurs Active Directory doivent être restaurés hors connexion.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-105">Active Directory servers must be restored offline.</span></span> <span data-ttu-id="fc4f5-106">Le système doit être redémarré en mode de restauration des services d’annuaire.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-106">The system must be restarted in Directory Services Restore mode.</span></span> <span data-ttu-id="fc4f5-107">Dans ce mode, le système d’exploitation s’exécute sans Active Directory Domain Services et toute la validation de l’utilisateur s’effectue par le biais du gestionnaire de comptes de sécurité (SAM) dans le registre.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-107">In this mode, the operating system is running without Active Directory Domain Services and all user validation occurs through the Security Accounts Manager (SAM) in the registry.</span></span> <span data-ttu-id="fc4f5-108">Pour restaurer Active Directory Domain Services, utilisez les informations d’identification d’un administrateur local sur le contrôleur de domaine qui est restauré.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-108">To restore Active Directory Domain Services, use the credentials of a local administrator on the domain controller that is restored.</span></span>

<span data-ttu-id="fc4f5-109">L’appelant des fonctions de restauration doit avoir le privilège d’accès au **\_ \_ nom** de la restauration.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-109">The caller of the restore functions must have the **SE\_RESTORE\_NAME** access privilege.</span></span> <span data-ttu-id="fc4f5-110">Utilisez la fonction [**DsSetAuthIdentity**](dssetauthidentity.md) pour définir le contexte de sécurité sous lequel les fonctions de sauvegarde et de restauration d’annuaire sont appelées.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-110">Use the [**DsSetAuthIdentity**](dssetauthidentity.md) function to set the security context under which the directory backup and restore functions are called.</span></span>

<span data-ttu-id="fc4f5-111">Sachez que lorsque vous restaurez des Active Directory Domain Services, vous devez également restaurer les autres composants d’État du système.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-111">Be aware that when you restore Active Directory Domain Services, you must also restore the other system state components.</span></span>

<span data-ttu-id="fc4f5-112">**Pour restaurer Active Directory Domain Services**</span><span class="sxs-lookup"><span data-stu-id="fc4f5-112">**To restore Active Directory Domain Services**</span></span>

1.  <span data-ttu-id="fc4f5-113">Appelez la fonction [**DsIsNTDSOnline**](dsisntdsonline.md) pour déterminer si Active Directory Domain Services sont en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-113">Call the [**DsIsNTDSOnline**](dsisntdsonline.md) function to determine if Active Directory Domain Services are running.</span></span>
2.  <span data-ttu-id="fc4f5-114">Si Active Directory Domain Services ne sont pas en cours d’exécution, la fonction [**DsRestorePrepare**](dsrestoreprepare.md) est appelée pour initialiser l’opération de restauration et obtenir un handle de contexte de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-114">If Active Directory Domain Services are not running, the [**DsRestorePrepare**](dsrestoreprepare.md) function is called to initialize the restore operation and obtain a backup context handle.</span></span> <span data-ttu-id="fc4f5-115">Si Active Directory Domain Services sont en cours d’exécution, il ne peut pas être restauré et l’application de restauration doit faire échouer l’opération de restauration.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-115">If Active Directory Domain Services are running, it cannot be restored and the restore application must fail the restore operation.</span></span> <span data-ttu-id="fc4f5-116">La fonction **DsRestorePrepare** nécessite l’obtention du jeton d’expiration à partir de la fonction [**DsBackupPrepare**](dsbackupprepare.md) pendant l’opération de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-116">The **DsRestorePrepare** function requires that the expiry token be obtained from the [**DsBackupPrepare**](dsbackupprepare.md) function during the backup operation.</span></span>
3.  <span data-ttu-id="fc4f5-117">Appelez la fonction [**DsRestoreGetDatabaseLocations**](dsrestoregetdatabaselocations.md) pour déterminer les répertoires dans lesquels les fichiers doivent être restaurés.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-117">Call the [**DsRestoreGetDatabaseLocations**](dsrestoregetdatabaselocations.md) function to determine the directories where the files are to be restored.</span></span> <span data-ttu-id="fc4f5-118">Si cette fonction échoue, restaurez les données dans le répertoire source de sauvegarde d’origine ; Il s’agit du répertoire à partir duquel les données ont été sauvegardées.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-118">If this function fails, restore the data back to the original backup source directory; that is the directory from which the data was backed up.</span></span>
4.  <span data-ttu-id="fc4f5-119">Appelez la fonction [**DsRestoreRegister**](dsrestoreregister.md) pour préparer le serveur de Active Directory pour l’opération de restauration et verrouiller les répertoires de restauration.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-119">Call the [**DsRestoreRegister**](dsrestoreregister.md) function to prepare the Active Directory server for the restore operation and lock the restore directories.</span></span>
5.  <span data-ttu-id="fc4f5-120">Utilisez les fonctions Win32 standard pour restaurer les fichiers.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-120">Use standard Win32 functions to restore the files.</span></span> <span data-ttu-id="fc4f5-121">Tout d’abord, supprimez tous les fichiers du répertoire de destination. Copiez ensuite les fichiers de sauvegarde dans le répertoire de destination.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-121">First, delete all files in the destination directory; then copy the backup files to the destination directory.</span></span>
6.  <span data-ttu-id="fc4f5-122">Appelez la fonction [**DsRestoreRegisterComplete**](dsrestoreregistercomplete.md) pour indiquer que la restauration est terminée.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-122">Call the [**DsRestoreRegisterComplete**](dsrestoreregistercomplete.md) function to indicate that the restore has completed.</span></span>
7.  <span data-ttu-id="fc4f5-123">Appelez la fonction [**DsRestoreEnd**](dsrestoreend.md) pour libérer toutes les ressources associées au contexte.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-123">Call the [**DsRestoreEnd**](dsrestoreend.md) function to release any resources associated with the context.</span></span>

<span data-ttu-id="fc4f5-124">Après une restauration en mode de restauration des services d’annuaire, le contrôleur de domaine doit être redémarré en mode normal.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-124">After a restore in Directory Services Restore mode, the domain controller should be restarted in normal mode.</span></span> <span data-ttu-id="fc4f5-125">Au démarrage du service d’annuaire, le contrôleur de domaine effectue la vérification de cohérence normale et le répertoire restauré est alors en ligne.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-125">When the directory service starts, the domain controller will perform the normal consistency check and the restored directory will then be online.</span></span>

<span data-ttu-id="fc4f5-126">N’oubliez pas que la restauration d’un serveur Active Directory est toujours une opération en deux parties.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-126">Be aware that restoring an Active Directory server is always a two-part operation.</span></span> <span data-ttu-id="fc4f5-127">Tout d’abord, restaurez la base de données jusqu’au moment où la sauvegarde a été effectuée.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-127">First, restore the database to a time when the backup was taken.</span></span> <span data-ttu-id="fc4f5-128">Ensuite, répliquez le répertoire dans lequel le DSA nouvellement restauré réplique les mises à jour après la sauvegarde à partir d’autres DSA dans le domaine et la forêt d’entreprise.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-128">Second, replicate the directory, where the newly restored DSA replicates post-backup updates from other DSAs in the domain and enterprise forest.</span></span>

<span data-ttu-id="fc4f5-129">Un ordinateur s’exécutant sur Windows 2000 ou Windows Server 2003, qui contient un réplica du service d’annuaire, est un contrôleur de domaine.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-129">A computer running on Windows 2000 or Windows Server 2003, that contains a replica of the directory service, is a domain controller.</span></span>

<span data-ttu-id="fc4f5-130">La fonction [**DsRestoreRegister**](dsrestoreregister.md) ajoute des données au registre qui doivent survivre au processus de restauration du Registre pour que la restauration fonctionne correctement.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-130">The [**DsRestoreRegister**](dsrestoreregister.md) function adds data to the registry that must survive the registry restoration process for the restoration to work correctly.</span></span> <span data-ttu-id="fc4f5-131">Pour vous assurer que ces données de Registre sont conservées, restaurez Active Directory Domain Services avec les fonctions **DsRestore \*** avant de redémarrer l’ordinateur après l’appel de la fonction [**RegReplaceKey**](/windows/desktop/api/winreg/nf-winreg-regreplacekeya) .</span><span class="sxs-lookup"><span data-stu-id="fc4f5-131">To ensure this registry data is preserved, restore Active Directory Domain Services with the **DsRestore\*** functions prior to restarting the computer after the [**RegReplaceKey**](/windows/desktop/api/winreg/nf-winreg-regreplacekeya) function is called.</span></span> <span data-ttu-id="fc4f5-132">Ce processus fonctionne parce que **RegReplaceKey** ne remplace pas la ruche du Registre tant que l’ordinateur n’est pas redémarré et que les données de Registre ajoutées par la fonction **DsRestoreRegister** n’ont pas été spécifiquement remplacées lors d’une opération de restauration du Registre.</span><span class="sxs-lookup"><span data-stu-id="fc4f5-132">This process works because **RegReplaceKey** does not actually replace the registry hive until the computer is restarted and the registry data added by the **DsRestoreRegister** function is specifically excluded from being replaced during a registry restore operation.</span></span>

 

 