---
title: Minutage des jeux et processeurs multicœurs.
description: Cet article propose une solution plus précise et fiable pour obtenir des minutages processeur haute résolution à l’aide des API Windows QueryPerformanceCounter et QueryPerformanceFrequency.
ms.assetid: 1512324d-dffa-3681-be3f-f63a3b8f11db
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9c5c511f558b59e94945e63c44db225f34ac2583
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/20/2020
ms.locfileid: "106510080"
---
# <a name="game-timing-and-multicore-processors"></a><span data-ttu-id="bace2-103">Minutage des jeux et processeurs multicœurs.</span><span class="sxs-lookup"><span data-stu-id="bace2-103">Game Timing and Multicore Processors</span></span>

<span data-ttu-id="bace2-104">Les technologies de gestion de l’alimentation devenant de plus en plus répandues sur les ordinateurs d’aujourd’hui, une méthode couramment utilisée pour obtenir des minutages UC haute résolution, l’instruction RDTSC, peut ne plus fonctionner comme prévu.</span><span class="sxs-lookup"><span data-stu-id="bace2-104">With power management technologies becoming more commonplace in today's computers, a commonly-used method to obtain high-resolution CPU timings, the RDTSC instruction, may no longer work as expected.</span></span> <span data-ttu-id="bace2-105">Cet article propose une solution plus précise et fiable pour obtenir des minutages processeur haute résolution à l’aide des API Windows [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) et [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span><span class="sxs-lookup"><span data-stu-id="bace2-105">This article suggests a more accurate, reliable solution to obtain high-resolution CPU timings by using the Windows APIs [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

-   [<span data-ttu-id="bace2-106">Contexte</span><span class="sxs-lookup"><span data-stu-id="bace2-106">Background</span></span>](#background)
-   [<span data-ttu-id="bace2-107">Recommandations</span><span class="sxs-lookup"><span data-stu-id="bace2-107">Recommendations</span></span>](#recommendations)
-   [<span data-ttu-id="bace2-108">Compatibilité des applications</span><span class="sxs-lookup"><span data-stu-id="bace2-108">Application Compatibility</span></span>](#application-compatibility)

## <a name="background"></a><span data-ttu-id="bace2-109">Arrière-plan</span><span class="sxs-lookup"><span data-stu-id="bace2-109">Background</span></span>

<span data-ttu-id="bace2-110">Depuis l’introduction du jeu d’instructions x86 P5, de nombreux développeurs de jeux ont utilisé le compteur d’horodatage de lecture, l’instruction RDTSC, pour effectuer un minutage haute résolution.</span><span class="sxs-lookup"><span data-stu-id="bace2-110">Since the introduction of the x86 P5 instruction set, many game developers have made use of read time stamp counter, the RDTSC instruction, to perform high-resolution timing.</span></span> <span data-ttu-id="bace2-111">Les minuteurs Windows Media sont suffisamment précis pour le traitement des sons et des vidéos, mais avec des temps d’image d’une douzaine de millisecondes ou moins, ils n’ont pas suffisamment de résolution pour fournir des informations sur le delta.</span><span class="sxs-lookup"><span data-stu-id="bace2-111">The Windows multimedia timers are precise enough for sound and video processing, but with frame times of a dozen milliseconds or less, they don't have enough resolution to provide delta-time information.</span></span> <span data-ttu-id="bace2-112">De nombreux jeux utilisent toujours un minuteur multimédia au démarrage pour établir la fréquence de l’UC, et ils utilisent cette valeur de fréquence pour mettre à l’échelle les résultats de RDTSC pour obtenir un temps précis.</span><span class="sxs-lookup"><span data-stu-id="bace2-112">Many games still use a multimedia timer at start-up to establish the frequency of the CPU, and they use that frequency value to scale results from RDTSC to get accurate time.</span></span> <span data-ttu-id="bace2-113">En raison des limitations de RDTSC, l’API Windows expose la manière la plus correcte d’accéder à cette fonctionnalité via les routines de [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) et [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span><span class="sxs-lookup"><span data-stu-id="bace2-113">Due to the limitations of RDTSC, the Windows API exposes the more correct way to access this functionality through the routines of [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

<span data-ttu-id="bace2-114">Cette utilisation de RDTSC pour la synchronisation souffre de ces problèmes fondamentaux :</span><span class="sxs-lookup"><span data-stu-id="bace2-114">This use of RDTSC for timing suffers from these fundamental issues:</span></span>

-   <span data-ttu-id="bace2-115">Valeurs discontinues.</span><span class="sxs-lookup"><span data-stu-id="bace2-115">Discontinuous values.</span></span> <span data-ttu-id="bace2-116">L’utilisation directe de RDTSC suppose que le thread est toujours en cours d’exécution sur le même processeur.</span><span class="sxs-lookup"><span data-stu-id="bace2-116">Using RDTSC directly assumes that the thread is always running on the same processor.</span></span> <span data-ttu-id="bace2-117">Les systèmes multiprocesseurs et à double cœur ne garantissent pas la synchronisation de leurs compteurs de cycles entre les cœurs.</span><span class="sxs-lookup"><span data-stu-id="bace2-117">Multiprocessor and dual-core systems do not guarantee synchronization of their cycle counters between cores.</span></span> <span data-ttu-id="bace2-118">Cela est aggravé lorsqu’il est associé à des technologies de gestion de l’alimentation modernes qui inactivent et restaurent différents cœurs à des moments différents, ce qui entraîne généralement une désynchronisation des cœurs.</span><span class="sxs-lookup"><span data-stu-id="bace2-118">This is exacerbated when combined with modern power management technologies that idle and restore various cores at different times, which results in the cores typically being out of synchronization.</span></span> <span data-ttu-id="bace2-119">Pour une application, cela entraîne généralement des problèmes ou des pannes potentielles à mesure que le thread saute entre les processeurs et obtient des valeurs de minutage qui entraînent des deltas de grande taille, des deltas négatifs ou une interruption du minutage.</span><span class="sxs-lookup"><span data-stu-id="bace2-119">For an application, this generally results in glitches or in potential crashes as the thread jumps between the processors and gets timing values that result in large deltas, negative deltas, or halted timing.</span></span>
-   <span data-ttu-id="bace2-120">Disponibilité du matériel dédié.</span><span class="sxs-lookup"><span data-stu-id="bace2-120">Availability of dedicated hardware.</span></span> <span data-ttu-id="bace2-121">RDTSC verrouille les informations de minutage que l’application demande au compteur de cycle du processeur.</span><span class="sxs-lookup"><span data-stu-id="bace2-121">RDTSC locks the timing information that the application requests to the processor's cycle counter.</span></span> <span data-ttu-id="bace2-122">Pendant de nombreuses années, il s’agissait de la meilleure façon d’obtenir des informations de temporisation de haute précision, mais les cartes mères plus récentes incluent maintenant des appareils de synchronisation dédiés qui fournissent des informations de minutage haute résolution sans les inconvénients de RDTSC.</span><span class="sxs-lookup"><span data-stu-id="bace2-122">For many years this was the best way to get high-precision timing information, but newer motherboards are now including dedicated timing devices which provide high-resolution timing information without the drawbacks of RDTSC.</span></span>
-   <span data-ttu-id="bace2-123">Variabilité de la fréquence du processeur.</span><span class="sxs-lookup"><span data-stu-id="bace2-123">Variability of the CPU's frequency.</span></span> <span data-ttu-id="bace2-124">L’hypothèse est souvent faite que la fréquence du processeur est fixée pour la durée de vie du programme.</span><span class="sxs-lookup"><span data-stu-id="bace2-124">The assumption is often made that the frequency of the CPU is fixed for the life of the program.</span></span> <span data-ttu-id="bace2-125">Toutefois, avec les technologies de gestion de l’alimentation modernes, il s’agit d’une hypothèse incorrecte.</span><span class="sxs-lookup"><span data-stu-id="bace2-125">However, with modern power management technologies, this is an incorrect assumption.</span></span> <span data-ttu-id="bace2-126">S’il est initialement limité aux ordinateurs portables et aux autres appareils mobiles, la technologie qui modifie la fréquence de l’UC est utilisée sur de nombreux ordinateurs de bureau haut de gamme. la désactivation de sa fonction pour maintenir une fréquence cohérente n’est généralement pas acceptable pour les utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="bace2-126">While initially limited to laptop computers and other mobile devices, technology that changes the frequency of the CPU is in use in many high-end desktop PCs; disabling its function to maintain a consistent frequency is generally not acceptable to users.</span></span>

## <a name="recommendations"></a><span data-ttu-id="bace2-127">Recommandations</span><span class="sxs-lookup"><span data-stu-id="bace2-127">Recommendations</span></span>

<span data-ttu-id="bace2-128">Les jeux ont besoin d’informations de temporisation précises, mais vous devez également implémenter le code de minutage de manière à éviter les problèmes associés à l’utilisation de RDTSC.</span><span class="sxs-lookup"><span data-stu-id="bace2-128">Games need accurate timing information, but you also need to implement timing code in a way that avoids the problems associated with using RDTSC.</span></span> <span data-ttu-id="bace2-129">Lorsque vous implémentez le minutage haute résolution, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="bace2-129">When you implement high-resolution timing, take the following steps:</span></span>

1.  <span data-ttu-id="bace2-130">Utilisez [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) et [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) au lieu de RDTSC.</span><span class="sxs-lookup"><span data-stu-id="bace2-130">Use [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) instead of RDTSC.</span></span> <span data-ttu-id="bace2-131">Ces API peuvent utiliser RDTSC, mais peuvent utiliser à la place des périphériques de minuterie sur la carte mère ou d’autres services système qui fournissent des informations de minutage haute résolution haute qualité.</span><span class="sxs-lookup"><span data-stu-id="bace2-131">These APIs may make use of RDTSC, but might instead make use of a timing devices on the motherboard or some other system services that provide high-quality high-resolution timing information.</span></span> <span data-ttu-id="bace2-132">Bien que RDTSC soit beaucoup plus rapide que **QueryPerformanceCounter**, puisque ce dernier est un appel d’API, il s’agit d’une API qui peut être appelée plusieurs centaines de fois par trame sans aucun impact notable.</span><span class="sxs-lookup"><span data-stu-id="bace2-132">While RDTSC is much faster than **QueryPerformanceCounter**, since the latter is an API call, it is an API that can be called several hundred times per frame without any noticeable impact.</span></span> <span data-ttu-id="bace2-133">(Toutefois, les développeurs doivent tenter d’appeler **QueryPerformanceCounter** le moins possible pour éviter toute altération des performances.)</span><span class="sxs-lookup"><span data-stu-id="bace2-133">(Nevertheless, developers should attempt to have their games call **QueryPerformanceCounter** as little as possible to avoid any performance penalty.)</span></span>
2.  <span data-ttu-id="bace2-134">Lors du calcul des deltas, les valeurs doivent être ancrées pour garantir que tous les bogues dans les valeurs de minutage ne provoquent pas de blocages ou des calculs liés à l’heure instables.</span><span class="sxs-lookup"><span data-stu-id="bace2-134">When computing deltas, the values should be clamped to ensure that any bugs in the timing values do not cause crashes or unstable time-related computations.</span></span> <span data-ttu-id="bace2-135">La plage de brides doit être comprise entre 0 (pour empêcher les valeurs Delta négatives) et une valeur raisonnable en fonction de votre fréquence de cadence la plus faible attendue.</span><span class="sxs-lookup"><span data-stu-id="bace2-135">The clamp range should be from 0 (to prevent negative delta values) to some reasonable value based on your lowest expected framerate.</span></span> <span data-ttu-id="bace2-136">Le verrouillage est susceptible d’être utile dans tout débogage de votre application, mais veillez à garder l’esprit en cas d’analyse des performances ou d’exécution du jeu en mode non optimisé.</span><span class="sxs-lookup"><span data-stu-id="bace2-136">Clamping is likely to be useful in any debugging of your application, but be sure to keep it in mind if doing performance analysis or running the game in some unoptimized mode.</span></span>
3.  <span data-ttu-id="bace2-137">Calculez tout le minutage sur un thread unique.</span><span class="sxs-lookup"><span data-stu-id="bace2-137">Compute all timing on a single thread.</span></span> <span data-ttu-id="bace2-138">Le calcul du minutage sur plusieurs threads, par exemple, avec chaque thread associé à un processeur spécifique, réduit considérablement les performances des systèmes multicœurs.</span><span class="sxs-lookup"><span data-stu-id="bace2-138">Computation of timing on multiple threads — for example, with each thread associated with a specific processor — greatly reduces performance of multi-core systems.</span></span>
4.  <span data-ttu-id="bace2-139">Définissez ce thread unique de façon à ce qu’il reste sur un processeur unique à l’aide de l’API Windows [**SetThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask).</span><span class="sxs-lookup"><span data-stu-id="bace2-139">Set that single thread to remain on a single processor by using the Windows API [**SetThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask).</span></span> <span data-ttu-id="bace2-140">En règle générale, il s’agit du thread de jeu principal.</span><span class="sxs-lookup"><span data-stu-id="bace2-140">Typically, this is the main game thread.</span></span> <span data-ttu-id="bace2-141">Alors que [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) et [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) s’ajustent généralement pour plusieurs processeurs, les bogues dans le BIOS ou les pilotes peuvent entraîner le retour de valeurs différentes par les routines à mesure que le thread passe d’un processeur à un autre.</span><span class="sxs-lookup"><span data-stu-id="bace2-141">While [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) typically adjust for multiple processors, bugs in the BIOS or drivers may result in these routines returning different values as the thread moves from one processor to another.</span></span> <span data-ttu-id="bace2-142">Par conséquent, il est préférable de conserver le thread sur un processeur unique.</span><span class="sxs-lookup"><span data-stu-id="bace2-142">So, it's best to keep the thread on a single processor.</span></span>

    <span data-ttu-id="bace2-143">Tous les autres threads doivent fonctionner sans collecter leurs propres données de minuteur.</span><span class="sxs-lookup"><span data-stu-id="bace2-143">All other threads should operate without gathering their own timer data.</span></span> <span data-ttu-id="bace2-144">Nous vous déconseillons d’utiliser un thread de travail pour calculer la durée, car cela deviendra un goulot d’étranglement de synchronisation.</span><span class="sxs-lookup"><span data-stu-id="bace2-144">We do not recommend using a worker thread to compute timing, as this will become a synchronization bottleneck.</span></span> <span data-ttu-id="bace2-145">Au lieu de cela, les threads de travail doivent lire les horodateurs du thread principal, et comme les threads de travail lisent uniquement les horodateurs, il n’est pas nécessaire d’utiliser des sections critiques.</span><span class="sxs-lookup"><span data-stu-id="bace2-145">Instead, worker threads should read timestamps from the main thread, and because the worker threads only read timestamps, there is no need to use critical sections.</span></span>

5.  <span data-ttu-id="bace2-146">Appelez [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) une seule fois, car la fréquence ne change pas pendant l’exécution du système.</span><span class="sxs-lookup"><span data-stu-id="bace2-146">Call [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) only once, because the frequency will not change while the system is running.</span></span>

## <a name="application-compatibility"></a><span data-ttu-id="bace2-147">Compatibilité des applications</span><span class="sxs-lookup"><span data-stu-id="bace2-147">Application Compatibility</span></span>

<span data-ttu-id="bace2-148">De nombreux développeurs ont fait des suppositions sur le comportement de RDTSC sur de nombreuses années. il est donc très probable que certaines applications existantes présenteront des problèmes lorsqu’ils s’exécuteront sur un système avec plusieurs processeurs ou cœurs en raison de l’implémentation du minutage.</span><span class="sxs-lookup"><span data-stu-id="bace2-148">Many developers have made assumptions about the behavior of RDTSC over many years, so it is quite likely that some existing applications will exhibit problems when run on a system with multiple processors or cores due to the timing implementation.</span></span> <span data-ttu-id="bace2-149">Ces problèmes se manifestent généralement comme un problème ou un mouvement lent.</span><span class="sxs-lookup"><span data-stu-id="bace2-149">These problems will usually manifest as glitching or slow-motion movement.</span></span> <span data-ttu-id="bace2-150">Il n’existe pas de solution facile pour les applications qui ne sont pas informées de la gestion de l’alimentation, mais il existe un shim pour forcer une application à toujours s’exécuter sur un processeur unique dans un système multiprocesseur.</span><span class="sxs-lookup"><span data-stu-id="bace2-150">There is no easy remedy for applications that are not aware of power management, but there is an existing shim for forcing an application to always run on a single processor in a multiprocessor system.</span></span>

<span data-ttu-id="bace2-151">Pour créer ce shim, téléchargez Microsoft Application Compatibility Toolkit à partir de la [compatibilité des applications Windows](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).</span><span class="sxs-lookup"><span data-stu-id="bace2-151">To create this shim, download the Microsoft Application Compatibility Toolkit from [Windows Application Compatibility](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).</span></span>

<span data-ttu-id="bace2-152">À l’aide de l’administrateur de compatibilité, qui fait partie de la boîte à outils, créez une base de données de votre application et les correctifs associés.</span><span class="sxs-lookup"><span data-stu-id="bace2-152">Using the Compatibility Administrator, part of the toolkit, create a database of your application and associated fixes.</span></span> <span data-ttu-id="bace2-153">Créez un nouveau mode de compatibilité pour cette base de données et sélectionnez le correctif de compatibilité **SingleProcAffinity** pour forcer tous les threads de l’application à s’exécuter sur un seul processeur/cœur.</span><span class="sxs-lookup"><span data-stu-id="bace2-153">Create a new compatibility mode for this database and select the compatibility fix **SingleProcAffinity** to force all of the threads of the application to run on a single processor/core.</span></span> <span data-ttu-id="bace2-154">À l’aide de l’outil de ligne de commande Fixpack.exe (également inclus dans la boîte à outils), vous pouvez convertir cette base de données en package installable pour l’installation, le test et la distribution.</span><span class="sxs-lookup"><span data-stu-id="bace2-154">By using the command-line tool Fixpack.exe (also part of the toolkit), you can convert this database into an installable package for installation, testing, and distribution.</span></span>

<span data-ttu-id="bace2-155">Pour obtenir des instructions sur l’utilisation de l’administrateur de compatibilité, consultez la documentation de la boîte à outils.</span><span class="sxs-lookup"><span data-stu-id="bace2-155">For instruction on using Compatibility Administrator, see the toolkit's documentation.</span></span> <span data-ttu-id="bace2-156">Pour obtenir la syntaxe des et des exemples d’utilisation de Fixpack.exe, consultez l’aide de la ligne de commande.</span><span class="sxs-lookup"><span data-stu-id="bace2-156">For syntax for and examples of using Fixpack.exe, see its command-line help.</span></span>

<span data-ttu-id="bace2-157">Pour obtenir des informations sur les clients, consultez les articles suivants de la base de connaissances de la rubrique aide et support Microsoft :</span><span class="sxs-lookup"><span data-stu-id="bace2-157">For customer-oriented information, see the following knowledge base articles from Microsoft Help and Support:</span></span>

-   <span data-ttu-id="bace2-158">[Les programmes dont l’utilisateur a la fonction QueryPerformanceCounter peuvent fonctionner mal dans Windows Server 2003 et Windows XP](https://support.microsoft.com/kb/895980) (article 895980)</span><span class="sxs-lookup"><span data-stu-id="bace2-158">[Programs that user the QueryPerformanceCounter function may perform poorly in Windows Server 2003 and in Windows XP](https://support.microsoft.com/kb/895980) (article 895980)</span></span>
-   <span data-ttu-id="bace2-159">[Les performances du jeu peuvent être médiocres sur un ordinateur Windows XP qui utilise un processeur double cœur](https://support.microsoft.com/kb/909944) (article 909944)</span><span class="sxs-lookup"><span data-stu-id="bace2-159">[Game performance may be poor on a Windows XP-based computer that is using a dual-core processor](https://support.microsoft.com/kb/909944) (article 909944)</span></span>

 

 