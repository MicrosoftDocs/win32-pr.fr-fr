---
title: Meilleures pratiques pour la gestion des ressources
description: Cet article décrit les meilleures pratiques pour traiter les ressources en général, le comportement des ressources managées et non managées, et fournit des détails sur la façon dont les ressources sont généralement gérées par le runtime et les pilotes.
ms.assetid: 265ae0b2-f268-a4a4-551e-9d3dae886517
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 27cdadb8cee3cb57f4208657054784937ecd1ea2
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/20/2020
ms.locfileid: "104315857"
---
# <a name="resource-management-best-practices"></a><span data-ttu-id="19f27-103">Meilleures pratiques pour la gestion des ressources</span><span class="sxs-lookup"><span data-stu-id="19f27-103">Resource Management Best Practices</span></span>

<span data-ttu-id="19f27-104">Les textures gérées, également appelées « gestion de texture automatique », sont disponibles dans DirectX depuis la version 6, avec plusieurs révisions et améliorations apportées dans les versions ultérieures.</span><span class="sxs-lookup"><span data-stu-id="19f27-104">Managed textures, also known as automatic texture management, have been available in DirectX since version 6, with several revisions and enhancements made in subsequent releases.</span></span> <span data-ttu-id="19f27-105">À compter de la sortie de l’API Direct3D 9, la gestion automatique des ressources prend en charge les textures, les mémoires tampons de vertex et les tampons d’index, avec une interface partagée cohérente.</span><span class="sxs-lookup"><span data-stu-id="19f27-105">As of the release of the Direct3D 9 API, the automatic resource management includes support for textures, vertex buffers, and index buffers, all with a consistent shared interface.</span></span> <span data-ttu-id="19f27-106">À l’aide de Direct3D Resource Manager, les applications peuvent simplifier de manière considérable la gestion des situations de périphériques perdus et peuvent compter sur le système pour gérer une quantité raisonnable de ressources de mémoire vidéo.</span><span class="sxs-lookup"><span data-stu-id="19f27-106">By using the Direct3D resource manager, applications can greatly simplify the handling of lost-device situations and can rely on the system to handle a reasonable amount of over-commitment of video memory resources.</span></span>

<span data-ttu-id="19f27-107">Les développeurs ont parfois des difficultés à utiliser les ressources managées, en partie en raison de la nature abstraite du système.</span><span class="sxs-lookup"><span data-stu-id="19f27-107">Developers sometimes have difficulties using managed resources, in part due to the abstract nature of the system.</span></span> <span data-ttu-id="19f27-108">Si de nombreux scénarios courants pour les ressources sont adaptés aux ressources managées, certains cas fonctionnent mieux lors de l’utilisation de ressources non managées.</span><span class="sxs-lookup"><span data-stu-id="19f27-108">While many common scenarios for resources are a good fit for managed resources, some cases perform better when using unmanaged resources.</span></span> <span data-ttu-id="19f27-109">Cet article décrit les meilleures pratiques pour traiter les ressources en général, le comportement des ressources managées et non managées, et fournit des détails sur la façon dont les ressources sont généralement gérées par le runtime et les pilotes.</span><span class="sxs-lookup"><span data-stu-id="19f27-109">This article discusses best practices for dealing with resources generally, how managed and unmanaged resources behave, and provides some detail on how resources are typically handled by the runtime and drivers.</span></span>

<span data-ttu-id="19f27-110">Cet article aborde les concepts suivants :</span><span class="sxs-lookup"><span data-stu-id="19f27-110">This article covers these concepts:</span></span>

-   [<span data-ttu-id="19f27-111">Mémoire vidéo</span><span class="sxs-lookup"><span data-stu-id="19f27-111">Video Memory</span></span>](#video-memory)
-   [<span data-ttu-id="19f27-112">Ressources managées</span><span class="sxs-lookup"><span data-stu-id="19f27-112">Managed Resources</span></span>](#managed-resources)
-   [<span data-ttu-id="19f27-113">Ressources gérées par le pilote</span><span class="sxs-lookup"><span data-stu-id="19f27-113">Driver-Managed Resources</span></span>](#driver-managed-resources)
-   [<span data-ttu-id="19f27-114">Ressources par défaut</span><span class="sxs-lookup"><span data-stu-id="19f27-114">Default Resources</span></span>](#default-resources)
    -   [<span data-ttu-id="19f27-115">Utilisation des ressources gérées et par défaut</span><span class="sxs-lookup"><span data-stu-id="19f27-115">Using Both Managed and Default Resources</span></span>](#using-both-managed-and-default-resources)
    -   [<span data-ttu-id="19f27-116">Ressources dynamiques par défaut</span><span class="sxs-lookup"><span data-stu-id="19f27-116">Dynamic Default Resources</span></span>](#dynamic-default-resources)
-   [<span data-ttu-id="19f27-117">Ressources mémoire système</span><span class="sxs-lookup"><span data-stu-id="19f27-117">System Memory Resources</span></span>](#system-memory-resources)
-   [<span data-ttu-id="19f27-118">Recommandations générales</span><span class="sxs-lookup"><span data-stu-id="19f27-118">General Recommendations</span></span>](#general-recommendations)
-   [<span data-ttu-id="19f27-119">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="19f27-119">Related topics</span></span>](#related-topics)

## <a name="video-memory"></a><span data-ttu-id="19f27-120">Mémoire vidéo</span><span class="sxs-lookup"><span data-stu-id="19f27-120">Video Memory</span></span>

<span data-ttu-id="19f27-121">Pour que le système vidéo utilise une ressource, il doit se trouver dans la mémoire accessible au GPU.</span><span class="sxs-lookup"><span data-stu-id="19f27-121">For the video system to make use of a resource, it must be located in memory that is accessible to the GPU.</span></span> <span data-ttu-id="19f27-122">La mémoire vidéo locale offre les meilleures performances pour le GPU, et certaines ressources (telles que les cibles de rendu et les tampons de profondeur/stencil) doivent se trouver dans la mémoire vidéo locale.</span><span class="sxs-lookup"><span data-stu-id="19f27-122">Local video memory provides the best performance for the GPU, and certain resources (such as render targets and depth/stencil buffers) must be located in local video memory.</span></span> <span data-ttu-id="19f27-123">Avec l’avènement de l’AGP, le GPU peut également accéder directement à une partie de la mémoire système.</span><span class="sxs-lookup"><span data-stu-id="19f27-123">With the advent of AGP, the GPU can also access a portion of the system memory directly.</span></span> <span data-ttu-id="19f27-124">Cette zone mémoire, connue sous le nom d’ouverture AGP, est appelée mémoire vidéo non locale et n’est pas disponible à d’autres fins.</span><span class="sxs-lookup"><span data-stu-id="19f27-124">This memory area, known as the AGP aperture, is referred to as non-local video memory and is not available for other purposes.</span></span> <span data-ttu-id="19f27-125">La mémoire vidéo non locale peut être lue et écrite par le processeur, ce qui n’a généralement aucun accès hautes performances à la mémoire vidéo locale et est donc idéal pour une utilisation en tant que ressource de mémoire partagée.</span><span class="sxs-lookup"><span data-stu-id="19f27-125">Non-local video memory can be read from and written to by the CPU, which typically has no high-performance access to local video memory, and is thus ideal for use as a shared memory resource.</span></span> <span data-ttu-id="19f27-126">L’un des éléments clés à retenir au sujet de la mémoire AGP est qu’elle n’est pas validée dans les situations de perte de l’appareil et que les ressources persistantes qu’elle contient doivent être restaurées.</span><span class="sxs-lookup"><span data-stu-id="19f27-126">A key thing to remember about AGP memory is that it, like local video memory, is invalidated in lost-device situations, and persistent assets located there must be restored.</span></span>

<span data-ttu-id="19f27-127">**Figure 1. Relation entre le GPU, le processeur, la RAM vidéo et la RAM système**</span><span class="sxs-lookup"><span data-stu-id="19f27-127">**Figure 1. Relationship of the GPU, CPU, video RAM, and system RAM**</span></span>

![relation entre le GPU, le processeur, la RAM vidéo et la RAM système](images/managingresources1.gif)

<span data-ttu-id="19f27-129">Certaines solutions vidéo intégrées utilisent une architecture de mémoire unifiée (UMA), où la mémoire principale est adressable par tous les composants des systèmes.</span><span class="sxs-lookup"><span data-stu-id="19f27-129">Some integrated video solutions make use of a unified memory architecture (UMA), where main memory is addressable by all components of the systems.</span></span> <span data-ttu-id="19f27-130">Direct3D prend en charge la UMA sans nécessiter de modification de l’application, en utilisant les mêmes indications que pour les configurations de mémoire vidéo locales.</span><span class="sxs-lookup"><span data-stu-id="19f27-130">Direct3D supports UMA without requiring any change to the application, utilizing the same hints as for local video memory configurations.</span></span> <span data-ttu-id="19f27-131">Pour ces systèmes, les ressources se trouvent toujours dans la mémoire système, et le pilote est chargé de s’assurer que les ressources fonctionnent comme dans une architecture plus traditionnelle tout en tirant parti des propriétés de la mémoire UMA et de tout comportement spécifique de l’implémentation matérielle.</span><span class="sxs-lookup"><span data-stu-id="19f27-131">For such systems, resources are always located in system memory, and the driver is responsible for ensuring that resources work much like they do in a more traditional architecture while taking advantage of UMA's properties and any specific behavior of the hardware implementation.</span></span>

<span data-ttu-id="19f27-132">**Figure 2. Le GPU et le processeur ont un accès égal à la RAM système dans une architecture de mémoire unifiée**</span><span class="sxs-lookup"><span data-stu-id="19f27-132">**Figure 2. GPU and CPU have equal access to system RAM in a unified memory architecture**</span></span>

![le GPU et le processeur ont un accès égal à la RAM système dans une architecture de mémoire unifiée](images/managingresources2.gif)

## <a name="managed-resources"></a><span data-ttu-id="19f27-134">Ressources managées</span><span class="sxs-lookup"><span data-stu-id="19f27-134">Managed Resources</span></span>

<span data-ttu-id="19f27-135">La majorité de vos ressources doit être créée en tant que ressources managées dans le POOL \_ géré.</span><span class="sxs-lookup"><span data-stu-id="19f27-135">The majority of your resources should be created as managed resources in POOL\_MANAGED.</span></span> <span data-ttu-id="19f27-136">Toutes vos ressources seront créées dans la mémoire système, puis copiées en fonction des besoins dans la mémoire vidéo.</span><span class="sxs-lookup"><span data-stu-id="19f27-136">All your resources will be created in system memory and then copied as needed into video memory.</span></span> <span data-ttu-id="19f27-137">Les situations de périphérique perdu seront gérées automatiquement à partir de la copie de la mémoire système.</span><span class="sxs-lookup"><span data-stu-id="19f27-137">Lost-device situations will be handled automatically from the system memory copy.</span></span> <span data-ttu-id="19f27-138">Étant donné que toutes les ressources managées ne doivent pas être intégrées à la mémoire vidéo en même temps, vous pouvez surcharger la mémoire là où une plus petite plage de travail de mémoire vidéo est nécessaire pour effectuer le rendu dans un frame donné.</span><span class="sxs-lookup"><span data-stu-id="19f27-138">Since not all managed resources are required to fit into video memory all at once, you can over-commit memory where a smaller video memory working set of resources is all that is required to render in any given frame.</span></span> <span data-ttu-id="19f27-139">Notez qu’il est probable que la majeure partie de la mémoire système du magasin de stockage soit paginée sur le disque dans le temps, ce qui explique pourquoi l’opération de réinitialisation peut être lente en raison de la nécessité de repaginer ces données pour restaurer la mémoire vidéo perdue.</span><span class="sxs-lookup"><span data-stu-id="19f27-139">Note that it is likely that the majority of this backing-store system memory will be paged out to disk over time, which is why the Reset operation can be slow due to the need to page this data back in to restore the lost video memory.</span></span>

<span data-ttu-id="19f27-140">Le runtime conserve un horodateur pour la dernière fois qu’une ressource est utilisée, et lorsqu’une allocation de mémoire vidéo échoue pour le chargement d’une ressource managée nécessaire, elle libère les ressources en fonction de cet horodatage de manière LRU.</span><span class="sxs-lookup"><span data-stu-id="19f27-140">The runtime keeps a timestamp for the last time a resource is used, and when a video memory allocation fails for loading a needed managed resource, it will release resources based on this timestamp in a LRU fashion.</span></span> <span data-ttu-id="19f27-141">L’utilisation de [**SetPriority**](/windows/desktop/api/d3d9helper/nf-d3d9helper-idirect3dresource9-setpriority) est prioritaire sur l’horodatage, donc les ressources les plus couramment utilisées doivent être définies sur une valeur de priorité plus élevée.</span><span class="sxs-lookup"><span data-stu-id="19f27-141">Usage of [**SetPriority**](/windows/desktop/api/d3d9helper/nf-d3d9helper-idirect3dresource9-setpriority) takes precedence over the timestamp, so more commonly used resources should be set to a higher priority value.</span></span> <span data-ttu-id="19f27-142">Direct3D 9,0 a des informations limitées sur la mémoire vidéo gérée par le pilote. par conséquent, le runtime devra peut-être supprimer plusieurs ressources pour créer une région suffisamment grande pour que l’allocation aboutisse.</span><span class="sxs-lookup"><span data-stu-id="19f27-142">Direct3D 9.0 has limited information about the video memory managed by the driver, so the runtime may need to evict several resources to create a large enough region for the allocation to succeed.</span></span> <span data-ttu-id="19f27-143">Des priorités appropriées peuvent vous aider à éliminer les situations où un événement est supprimé, puis retenu à peu près après.</span><span class="sxs-lookup"><span data-stu-id="19f27-143">Proper priorities can help eliminate situations where something gets evicted and then is required again shortly thereafter.</span></span> <span data-ttu-id="19f27-144">L’application peut également appeler [**EvictManagedResources**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-evictmanagedresources) pour forcer la suppression de toutes les ressources managées.</span><span class="sxs-lookup"><span data-stu-id="19f27-144">The application can also call [**EvictManagedResources**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-evictmanagedresources) to force all the managed resources to be removed.</span></span> <span data-ttu-id="19f27-145">Là encore, cette opération peut prendre du temps pour recharger toutes les ressources requises pour le frame suivant, mais elle est très utile pour les transitions de niveau où la plage de travail change de façon significative et pour la suppression de la fragmentation de la mémoire vidéo.</span><span class="sxs-lookup"><span data-stu-id="19f27-145">Again, this can be a time-consuming operation to reload all the resources required for the next frame, but is very useful for level transitions where the working set changes significantly and for removing video memory fragmentation.</span></span>

<span data-ttu-id="19f27-146">Un nombre de frames est également conservé pour permettre au runtime de détecter si la ressource qu’il vient de choisir de supprimer a été utilisée au début du frame actuel, ce qui implique une situation de surcharge où davantage de ressources sont utilisées dans une trame unique que dans la mémoire vidéo.</span><span class="sxs-lookup"><span data-stu-id="19f27-146">A frame count is also kept to allow the runtime to detect if the resource it just chose to evict was used early the current frame, which implies a thrashing situation where more resources are in use in a single frame than will fit into video memory.</span></span> <span data-ttu-id="19f27-147">Cela déclenche la stratégie de remplacement pour basculer vers un dernier format au lieu d’un LRU pour le reste du cadre, car cela a tendance à s’exécuter légèrement mieux dans de telles conditions.</span><span class="sxs-lookup"><span data-stu-id="19f27-147">This triggers the replacement policy to switch to a MRU fashion rather than LRU for the remainder of the frame as this tends to perform slightly better under such conditions.</span></span> <span data-ttu-id="19f27-148">Ce comportement de surcharge aura un impact significatif sur les performances de rendu.</span><span class="sxs-lookup"><span data-stu-id="19f27-148">Such thrashing behavior will significantly impact the rendering performance.</span></span> <span data-ttu-id="19f27-149">Notez que la notion de frame actuel est liée à [**EndScene**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-endscene), de sorte que toute application qui utilise des ressources managées doit effectuer des appels réguliers à cette méthode.</span><span class="sxs-lookup"><span data-stu-id="19f27-149">Note that the notion of current frame is tied to [**EndScene**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-endscene), so any application making use of managed resources needs to make regular calls to this method.</span></span>

<span data-ttu-id="19f27-150">Les développeurs qui cherchent à trouver plus d’informations sur la façon dont les ressources managées se comportent dans leur application peuvent utiliser la requête d’événement RESOURCEMANAGER par le biais de l’interface [**IDirect3DQuery9**](/windows/desktop/api/d3d9helper/nn-d3d9helper-idirect3dquery9) .</span><span class="sxs-lookup"><span data-stu-id="19f27-150">Developers looking to find more information about how managed resources are behaving in their application can make use of the RESOURCEMANAGER event query via the [**IDirect3DQuery9**](/windows/desktop/api/d3d9helper/nn-d3d9helper-idirect3dquery9) interface.</span></span> <span data-ttu-id="19f27-151">Cela ne fonctionne que lorsque vous utilisez les runtimes de débogage. par conséquent, ces informations ne peuvent pas dépendre de l’application, mais elles fournissent des détails détaillés sur les ressources gérées par le Runtime.</span><span class="sxs-lookup"><span data-stu-id="19f27-151">This only works when using the debug runtimes, so this information cannot be depended upon by the application, but it provides deep detail on the resources managed by the runtime.</span></span>

<span data-ttu-id="19f27-152">Bien que la compréhension du fonctionnement du gestionnaire de ressources puisse vous aider lors du paramétrage et du débogage de vos applications, il est important de ne pas lier trop étroitement votre application aux détails d’implémentation du runtime ou des pilotes actuels.</span><span class="sxs-lookup"><span data-stu-id="19f27-152">While understanding how the resource manager works can help when tuning and debugging your applications, it is important to not tie your application too tightly to the implementation details of the current runtime or drivers.</span></span> <span data-ttu-id="19f27-153">Les révisions du pilote ou les modifications apportées au matériel peuvent considérablement changer le comportement, et les futures versions de Direct3D auront une gestion des ressources considérablement améliorée et sophistiquée.</span><span class="sxs-lookup"><span data-stu-id="19f27-153">Revisions of the driver or changes in hardware can significantly change the behavior, and future versions of Direct3D will have significantly improved and sophisticated resource management.</span></span>

## <a name="driver-managed-resources"></a><span data-ttu-id="19f27-154">Ressources Driver-Managed</span><span class="sxs-lookup"><span data-stu-id="19f27-154">Driver-Managed Resources</span></span>

<span data-ttu-id="19f27-155">Les pilotes Direct3D sont libres d’implémenter la fonctionnalité de texture gérée par le pilote, indiquée par D3DCAPS2 \_ CANMANAGERESOURCE, qui permet au pilote de gérer la gestion des ressources au lieu du Runtime.</span><span class="sxs-lookup"><span data-stu-id="19f27-155">Direct3D drivers are free to implement the driver managed textures capability, indicated by D3DCAPS2\_CANMANAGERESOURCE, which allows the driver to handle the resource management instead of the runtime.</span></span> <span data-ttu-id="19f27-156">Pour le pilote (rare) qui implémente cette fonctionnalité, le comportement exact du gestionnaire de ressources du pilote peut varier considérablement, et vous devez contacter le fournisseur du pilote pour plus d’informations sur la façon dont cela fonctionne pour son implémentation.</span><span class="sxs-lookup"><span data-stu-id="19f27-156">For the (rare) driver that implements this feature, the exact behavior of the driver's resource manager can vary widely, and you should contact the driver's vendor for details on how this works for their implementation.</span></span> <span data-ttu-id="19f27-157">Vous pouvez également vous assurer que le gestionnaire Runtime est toujours utilisé à la place en spécifiant D3DCREATE \_ désactiver \_ \_ la gestion des pilotes lors de la création de l’appareil.</span><span class="sxs-lookup"><span data-stu-id="19f27-157">Alternatively, you can ensure that the runtime manager is always used instead by specifying D3DCREATE\_DISABLE\_DRIVER\_MANAGEMENT when creating the device.</span></span>

## <a name="default-resources"></a><span data-ttu-id="19f27-158">Ressources par défaut</span><span class="sxs-lookup"><span data-stu-id="19f27-158">Default Resources</span></span>

<span data-ttu-id="19f27-159">Bien que les ressources managées soient simples, efficaces et faciles à utiliser, il peut arriver que l’utilisation directe de la mémoire vidéo soit préférable ou même requise.</span><span class="sxs-lookup"><span data-stu-id="19f27-159">While managed resources are simple, efficient, and easy to use, there are times when using video memory directly is preferred or even required.</span></span> <span data-ttu-id="19f27-160">Ces ressources sont créées dans la \_ catégorie par défaut du pool.</span><span class="sxs-lookup"><span data-stu-id="19f27-160">Such resources are created in the POOL\_DEFAULT category.</span></span> <span data-ttu-id="19f27-161">L’utilisation de ces ressources entraîne des complications supplémentaires pour votre application.</span><span class="sxs-lookup"><span data-stu-id="19f27-161">Making use of such resources does cause additional complications for your application.</span></span> <span data-ttu-id="19f27-162">Le code est nécessaire pour faire face à la situation de l’appareil perdu pour toutes les \_ ressources par défaut du pool, et les considérations relatives aux performances doivent être prises en compte lors de la copie des données dans ces derniers.</span><span class="sxs-lookup"><span data-stu-id="19f27-162">Code is required to cope with the lost-device situation for all the POOL\_DEFAULT resources, and performance considerations must be taken into account when copying data into them.</span></span> <span data-ttu-id="19f27-163">Si vous ne spécifiez pas l’utilisation de \_ WRITEONLY ou si vous rendez une cible de rendu verrouillable, cela peut également entraîner des pénalités graves.</span><span class="sxs-lookup"><span data-stu-id="19f27-163">Failure to specify USAGE\_WRITEONLY or making a render target lockable can also impose serious performance penalties.</span></span>

<span data-ttu-id="19f27-164">L’appel de **Lock** sur une ressource de pool \_ par défaut est plus susceptible de provoquer l’arrêt du GPU que l’utilisation d’une \_ ressource managée de pool, sauf en cas d’utilisation de certains indicateurs d’indicateur.</span><span class="sxs-lookup"><span data-stu-id="19f27-164">Calling **Lock** on a POOL\_DEFAULT resource is more likely to cause the GPU to stall than working with a POOL\_MANAGED resource, unless using certain hint flags.</span></span> <span data-ttu-id="19f27-165">Selon l’emplacement de la ressource, le pointeur retourné peut être un tampon de mémoire système temporaire ou un pointeur directement dans la mémoire AGP.</span><span class="sxs-lookup"><span data-stu-id="19f27-165">Depending on the location of the resource, the pointer returned could be to a temporary system memory buffer, or it can be a pointer directly into AGP memory.</span></span> <span data-ttu-id="19f27-166">S’il s’agit d’une mémoire tampon système temporaire, les données doivent être transférées vers la mémoire vidéo après l’appel de **déverrouillage** .</span><span class="sxs-lookup"><span data-stu-id="19f27-166">If it is a temporary system memory buffer, data will need to be transferred to the video memory after the **Unlock** call.</span></span> <span data-ttu-id="19f27-167">Si la ressource vidéo n’est pas en écriture seule, les données doivent être transférées dans la mémoire tampon temporaire pendant le **verrouillage**.</span><span class="sxs-lookup"><span data-stu-id="19f27-167">If the video resource is not write-only, data will have to be transferred into the temporary buffer during the **Lock**.</span></span> <span data-ttu-id="19f27-168">S’il s’agit d’une zone de mémoire AGP, les copies temporaires sont évitées, mais le comportement de cache requis peut entraîner un ralentissement des performances.</span><span class="sxs-lookup"><span data-stu-id="19f27-168">If it is an AGP memory area, temporary copies are avoided but the cache behavior required can result in slow performance.</span></span>

<span data-ttu-id="19f27-169">Vous devez veiller à écrire une ligne de données de cache complète dans n’importe quel pointeur vers la mémoire d’ouverture AGP afin d’éviter la pénalité de l’écriture dans le peigne, ce qui entraîne un cycle de lecture-écriture, et l’accès séquentiel de la zone de mémoire est préférable.</span><span class="sxs-lookup"><span data-stu-id="19f27-169">Care should be taken to write a full cache line of data into any pointer to AGP aperture memory to avoid the penalty of write-combing, which induces a read-write cycle, and sequential access of the memory area is preferred.</span></span> <span data-ttu-id="19f27-170">Si votre application doit effectuer un accès aléatoire aux données lors de la création, et que vous ne souhaitez pas utiliser une ressource managée pour la mémoire tampon, vous devez utiliser une copie de mémoire système à la place.</span><span class="sxs-lookup"><span data-stu-id="19f27-170">If your application needs to make random access to data during creation, and you do not wish to make use of a managed resource for the buffer, you should work with a system memory copy instead.</span></span> <span data-ttu-id="19f27-171">Une fois les données créées, vous pouvez diffuser le résultat dans la mémoire de ressource verrouillée pour éviter de payer une pénalité importante pour l’opération de combinaison d’écriture dans le cache.</span><span class="sxs-lookup"><span data-stu-id="19f27-171">Once the data has been created, you can then stream the result into the locked resource memory to avoid paying a high penalty for the cache write-combining operation.</span></span>

<span data-ttu-id="19f27-172">L' \_ indicateur LOCK NOOVERWRITE peut être utilisé pour ajouter des données de manière efficace pour certaines ressources, mais idéalement, plusieurs appels de **verrouillage** et de **déverrouillage** à la même ressource peuvent être évités.</span><span class="sxs-lookup"><span data-stu-id="19f27-172">The LOCK\_NOOVERWRITE flag can be used to append data in an efficient manner for some resources, but ideally, multiple **Lock** and **Unlock** calls to the same resource can be avoided.</span></span> <span data-ttu-id="19f27-173">L’utilisation correcte des différents indicateurs de verrou est importante pour des performances optimales, tout comme l’utilisation d’un modèle convivial du cache d’accès aux données lors du remplissage de la mémoire verrouillée.</span><span class="sxs-lookup"><span data-stu-id="19f27-173">Making proper use of the various lock flags is important to optimal performance, as is using a cache-friendly pattern of data access when filling locked memory.</span></span>

### <a name="using-both-managed-and-default-resources"></a><span data-ttu-id="19f27-174">Utilisation des ressources gérées et par défaut</span><span class="sxs-lookup"><span data-stu-id="19f27-174">Using Both Managed and Default Resources</span></span>

<span data-ttu-id="19f27-175">Le mélange des allocations de ressources par défaut gérées et regroupées \_ peut provoquer une fragmentation de la mémoire vidéo et confondre la vue du runtime de la mémoire vidéo disponible pour les ressources managées.</span><span class="sxs-lookup"><span data-stu-id="19f27-175">Mixing allocations of managed and POOL\_DEFAULT resources can cause video memory fragmentation and confuse the runtime's view of the video memory available for managed resources.</span></span> <span data-ttu-id="19f27-176">Dans l’idéal, vous devez créer toutes les \_ ressources par défaut du pool avant d’utiliser des \_ ressources gérées par le pool ou utiliser l’appel [**EvictManagedResources**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-evictmanagedresources) avant d’allouer des ressources non managées.</span><span class="sxs-lookup"><span data-stu-id="19f27-176">Ideally, you should create all POOL\_DEFAULT resources before making use of POOL\_MANAGED resources or make use of the [**EvictManagedResources**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-evictmanagedresources) call before allocating unmanaged resources.</span></span> <span data-ttu-id="19f27-177">N’oubliez pas que toutes les allocations effectuées à partir de \_ la valeur par défaut du pool qui résident dans la mémoire vidéo mobilisent de la mémoire pour la durée pendant laquelle les ressources ne peuvent pas être utilisées par le gestionnaire de ressources ou à d’autres fins.</span><span class="sxs-lookup"><span data-stu-id="19f27-177">Remember that all allocations made from POOL\_DEFAULT that reside in video memory tie up memory for the life that resource that is unavailable for use by the resource manager or for any other purpose.</span></span>

<span data-ttu-id="19f27-178">Notez qu’à la différence des versions antérieures de Direct3D, le runtime de la version 9 supprime automatiquement certaines ressources managées avant d’abandonner une allocation de ressources non managées en cas d’échec pour un manque de mémoire vidéo, mais cela peut potentiellement créer une fragmentation supplémentaire et même forcer une ressource dans un emplacement moins optimal (par exemple, en utilisant une texture statique dans la mémoire vidéo non locale).</span><span class="sxs-lookup"><span data-stu-id="19f27-178">Note that unlike previous versions of Direct3D, the version 9 runtime automatically evicts some managed resources before giving up on a failed unmanaged resource allocation for a lack of video memory, but this can potentially create additional fragmentation and even force a resource into a sub-optimal location (for example, having a static texture in non-local video memory).</span></span> <span data-ttu-id="19f27-179">Là encore, il est préférable d’allouer toutes les ressources non managées avant et avant d’utiliser des ressources managées.</span><span class="sxs-lookup"><span data-stu-id="19f27-179">Again, it is best to allocate all required unmanaged resources up front and before using any managed resources.</span></span>

### <a name="dynamic-default-resources"></a><span data-ttu-id="19f27-180">Ressources dynamiques par défaut</span><span class="sxs-lookup"><span data-stu-id="19f27-180">Dynamic Default Resources</span></span>

<span data-ttu-id="19f27-181">Les données générées et mises à jour à une fréquence élevée n’ont pas besoin du magasin de stockage, car toutes les informations seront recréées lors de la restauration de l’appareil.</span><span class="sxs-lookup"><span data-stu-id="19f27-181">Data that is generated and updated at a high frequency has no need for the backing-store since all the information will be re-created when restoring the device.</span></span> <span data-ttu-id="19f27-182">Ce type de données est généralement le mieux créé dans \_ le pool par défaut, en spécifiant l’indicateur d’utilisation \_ dynamique, afin que le pilote puisse prendre des décisions d’optimisation lors du placement de la ressource, sachant qu’il sera souvent mis à jour.</span><span class="sxs-lookup"><span data-stu-id="19f27-182">Such data is typically best created in POOL\_DEFAULT, specifying the USAGE\_DYNAMIC hint, so that the driver can make optimization decisions when placing the resource, knowing that it will be updated often.</span></span> <span data-ttu-id="19f27-183">Cela implique généralement de placer la ressource dans une mémoire vidéo non locale, et par conséquent, il est généralement beaucoup plus lent que le GPU accède à la mémoire vidéo locale.</span><span class="sxs-lookup"><span data-stu-id="19f27-183">This typically means putting the resource into non-local video memory, and thus, it is usually much slower for the GPU to access than local video memory.</span></span> <span data-ttu-id="19f27-184">Pour les architectures UMA, le pilote peut choisir un emplacement particulier pour les ressources dynamiques à optimiser pour l’accès en écriture de l’UC.</span><span class="sxs-lookup"><span data-stu-id="19f27-184">For UMA architectures, the driver might choose a particular placement for dynamic resources to optimize for CPU write access.</span></span>

<span data-ttu-id="19f27-185">Cette utilisation est courante pour les solutions de pelures de logiciels et les systèmes de particule basés sur le processeur qui remplissent des tampons de vertex/d’index, et l’indicateur de rejet de verrou \_ garantit que les blocages ne sont pas créés dans les cas où la ressource est toujours utilisée à partir de l’image précédente.</span><span class="sxs-lookup"><span data-stu-id="19f27-185">This usage is typical for software skinning solutions and CPU-based particle systems filling out vertex/index buffers, and the LOCK\_DISCARD flag will ensure that stalls are not created in cases where the resource is still in use from the previous frame.</span></span> <span data-ttu-id="19f27-186">Dans ce cas, l’utilisation d’une ressource managée met à jour une mémoire tampon système qui serait ensuite copiée dans la mémoire vidéo, puis utilisée uniquement pour un ou deux frames avant d’être remplacé.</span><span class="sxs-lookup"><span data-stu-id="19f27-186">Using a managed resource in this case would update a system memory buffer, which would then be copied to video memory, and then used for only a frame or two before being replaced.</span></span> <span data-ttu-id="19f27-187">Pour les systèmes avec une mémoire vidéo non locale, la copie supplémentaire est éliminée en utilisant correctement ce modèle dynamique.</span><span class="sxs-lookup"><span data-stu-id="19f27-187">For systems with non-local video memory, the extra copy is eliminated by proper use of this dynamic pattern.</span></span>

<span data-ttu-id="19f27-188">Les textures standard ne peuvent pas être verrouillées et ne peuvent être mises à jour qu’à l’aide de [**UpdateSurface**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatesurface) ou [**UpdateTexture**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatetexture).</span><span class="sxs-lookup"><span data-stu-id="19f27-188">Standard textures cannot be locked, and can only be updated via [**UpdateSurface**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatesurface) or [**UpdateTexture**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatetexture).</span></span> <span data-ttu-id="19f27-189">Certains systèmes prennent en charge les textures dynamiques, qui peuvent être verrouillées et utilisent le modèle de rejet de verrou \_ , mais un bit des fonctionnalités (D3DCAPS2 \_ DYNAMICTEXTURES) doit être vérifié avant d’utiliser ces ressources.</span><span class="sxs-lookup"><span data-stu-id="19f27-189">Some systems support dynamic textures, which can be locked, and use the LOCK\_DISCARD pattern, but a capabilities bit (D3DCAPS2\_DYNAMICTEXTURES) must be checked before making use of such resources.</span></span> <span data-ttu-id="19f27-190">Pour les textures hautement dynamiques (vidéo ou procédurale), votre application peut créer des ressources de pool et de SYSTEMMEM de pool correspondantes \_ \_ et gérer les mises à jour de la mémoire vidéo à l’aide de **UpdateTexture**.</span><span class="sxs-lookup"><span data-stu-id="19f27-190">For highly dynamic textures (video or procedural), your application could create matching POOL\_DEFAULT and POOL\_SYSTEMMEM resources and handle video-memory updates by using **UpdateTexture**.</span></span> <span data-ttu-id="19f27-191">Pour les mises à jour très fréquentes et partielles, le paradigme **UpdateTexture** est probablement le meilleur choix.</span><span class="sxs-lookup"><span data-stu-id="19f27-191">For highly frequent and partial updates, the **UpdateTexture** paradigm is likely the better choice.</span></span>

<span data-ttu-id="19f27-192">Aussi utile que les ressources dynamiques peuvent l’être, soyez prudent lors de la conception de systèmes qui s’appuient fortement sur l’envoi dynamique.</span><span class="sxs-lookup"><span data-stu-id="19f27-192">As useful as dynamic resources can be, be careful when designing systems that rely heavily on dynamic submission.</span></span> <span data-ttu-id="19f27-193">Les ressources statiques doivent être placées dans un POOL \_ géré pour garantir une utilisation correcte de la mémoire vidéo locale et pour utiliser plus efficacement la bande passante de la mémoire centrale et de bus limité.</span><span class="sxs-lookup"><span data-stu-id="19f27-193">Static resources should be placed into POOL\_MANAGED to ensure both good utilization of local video memory, and to make more efficient use of limited bus and main memory bandwidth.</span></span> <span data-ttu-id="19f27-194">Pour les ressources semi-statiques, vous constaterez peut-être que le coût d’un chargement occasionnel vers la mémoire vidéo locale est bien inférieur au trafic de bus constant généré en les rendant dynamiques.</span><span class="sxs-lookup"><span data-stu-id="19f27-194">For resources that are semi-static, you may find that the cost of an occasional upload to local video memory is much less than the constant bus traffic generated by making them dynamic.</span></span>

## <a name="system-memory-resources"></a><span data-ttu-id="19f27-195">Ressources mémoire système</span><span class="sxs-lookup"><span data-stu-id="19f27-195">System Memory Resources</span></span>

<span data-ttu-id="19f27-196">Les ressources peuvent également être créées dans le POOL \_ SYSTEMMEM.</span><span class="sxs-lookup"><span data-stu-id="19f27-196">Resources can also be created in POOL\_SYSTEMMEM.</span></span> <span data-ttu-id="19f27-197">Bien qu’ils ne puissent pas être utilisés par le pipeline Graphics, ils peuvent être utilisés comme sources pour la mise à jour des \_ ressources par défaut du pool à l’aide de [**UpdateSurface**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatesurface) ou [**UpdateTexture**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatetexture).</span><span class="sxs-lookup"><span data-stu-id="19f27-197">While they cannot be used by the graphics pipeline, they can be used as sources for updating POOL\_DEFAULT resources by using [**UpdateSurface**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatesurface) or [**UpdateTexture**](/windows/desktop/api/d3d9/nf-d3d9-idirect3ddevice9-updatetexture).</span></span> <span data-ttu-id="19f27-198">Leur comportement de verrouillage est simple, mais les blocages peuvent se produire s’ils sont utilisés par l’une des méthodes mentionnées précédemment.</span><span class="sxs-lookup"><span data-stu-id="19f27-198">Their locking behavior is simple, although stalls might occur if they are in use by one of the previously mentioned methods.</span></span>

<span data-ttu-id="19f27-199">Bien qu’ils résident dans la mémoire système, les \_ ressources SYSTEMMEM de pool sont limitées aux mêmes formats et capacités (par exemple, la taille maximale) pris en charge par le pilote de périphérique.</span><span class="sxs-lookup"><span data-stu-id="19f27-199">Though they reside in system memory, POOL\_SYSTEMMEM resources are limited to the same formats and capabilities (such as maximum size) supported by the device driver.</span></span> <span data-ttu-id="19f27-200">Le \_ type de ressource Scratch du pool est une autre forme de ressource de mémoire système qui peut utiliser tous les formats et fonctionnalités pris en charge par le runtime, mais qui ne sont pas accessibles par l’appareil.</span><span class="sxs-lookup"><span data-stu-id="19f27-200">The POOL\_SCRATCH resource type is another form of system memory resource that can utilize all formats and capabilities supported by the runtime, but cannot be accessed by the device.</span></span> <span data-ttu-id="19f27-201">Les ressources Scratch sont principalement destinées à être utilisées par les outils de contenu.</span><span class="sxs-lookup"><span data-stu-id="19f27-201">Scratch resources are intended primarily for use by content tools.</span></span>

<span data-ttu-id="19f27-202">**Figure 3. Ressources mémoire dans la RAM vidéo, l’ouverture AGP et la RAM système**</span><span class="sxs-lookup"><span data-stu-id="19f27-202">**Figure 3. Memory resources in video RAM, AGP aperture, and system RAM**</span></span>

![ressources mémoire dans la RAM vidéo, l’ouverture AGP et la RAM système](images/managingresources3.gif)

## <a name="general-recommendations"></a><span data-ttu-id="19f27-204">Recommandations générales</span><span class="sxs-lookup"><span data-stu-id="19f27-204">General Recommendations</span></span>

<span data-ttu-id="19f27-205">L’obtention des détails de l’implémentation technique de la gestion des ressources va vous aider à atteindre vos objectifs en matière de performances pour votre application.</span><span class="sxs-lookup"><span data-stu-id="19f27-205">Getting the technical implementation details of resource management correct will go a long way toward achieving your performance goals for your application.</span></span> <span data-ttu-id="19f27-206">La planification de la présentation des ressources à Direct3D et la conception architecturale pour l’obtention des données en temps opportun sont une tâche plus complexe.</span><span class="sxs-lookup"><span data-stu-id="19f27-206">Planning how the resources are presented to Direct3D and the architectural design around getting the data loaded in a timely fashion is a more complicated task.</span></span> <span data-ttu-id="19f27-207">Nous vous recommandons d’utiliser un certain nombre de meilleures pratiques pour prendre ces décisions pour votre application :</span><span class="sxs-lookup"><span data-stu-id="19f27-207">We recommend a number of best practices when making these decisions for your application:</span></span>

-   <span data-ttu-id="19f27-208">Prétraitez toutes vos ressources.</span><span class="sxs-lookup"><span data-stu-id="19f27-208">Pre-process all your resources.</span></span> <span data-ttu-id="19f27-209">Le fait de s’appuyer sur une conversion et une optimisation des ressources au moment du chargement pour vos ressources est pratique pendant le développement, mais cela permet d’obtenir une charge considérable en matière de performances sur les ordinateurs des utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="19f27-209">Relying on expensive load-time conversion and optimization for your resources is convenient during development, but doing so puts a great performance burden on your users' computers.</span></span> <span data-ttu-id="19f27-210">Les ressources prétraitées sont plus rapides à charger, plus rapides à utiliser et vous donnent la possibilité d’effectuer des tâches hors ligne sophistiquées.</span><span class="sxs-lookup"><span data-stu-id="19f27-210">Pre-processed resources are faster to load, faster to use, and give you the option of doing sophisticated off-line work.</span></span>
-   <span data-ttu-id="19f27-211">Évitez de créer de nombreuses ressources par frame.</span><span class="sxs-lookup"><span data-stu-id="19f27-211">Avoid creating many resources per frame.</span></span> <span data-ttu-id="19f27-212">Les interactions de pilote requises peuvent sérialiser le processeur et le GPU, et les opérations impliquées sont lourdes, car elles nécessitent souvent des transitions de noyau.</span><span class="sxs-lookup"><span data-stu-id="19f27-212">The driver interactions required can serialize the CPU and GPU, and the operations involved are heavy-weight, as they often require kernel transitions.</span></span> <span data-ttu-id="19f27-213">Répartissez la création sur plusieurs frames ou réutilisez les ressources sans les créer/les libérer.</span><span class="sxs-lookup"><span data-stu-id="19f27-213">Spread out creation over several frames or reuse resources without creating/releasing them.</span></span> <span data-ttu-id="19f27-214">Idéalement, vous devez attendre plusieurs images avant de verrouiller ou de libérer des ressources récemment utilisées pour le rendu.</span><span class="sxs-lookup"><span data-stu-id="19f27-214">Ideally, you should wait several frames before locking or releasing resources that were recently used to render.</span></span>
-   <span data-ttu-id="19f27-215">À la fin du cadre, veillez à dissocier tous les canaux de ressources (c’est-à-dire les sources de flux, les étapes de texture et les index actuels).</span><span class="sxs-lookup"><span data-stu-id="19f27-215">At the end of the frame, be sure to unbind all resource channels (that is, stream sources, texture stages, and current indices).</span></span> <span data-ttu-id="19f27-216">Cela permet de s’assurer que les références non résolues aux ressources sont supprimées avant que Resource Manager ne conserve les ressources résidantes qui ne sont en fait plus utilisées.</span><span class="sxs-lookup"><span data-stu-id="19f27-216">Doing so will ensure that dangling references to resources are removed before they cause the resource manager to keep resources resident that are actually no longer in use.</span></span>
-   <span data-ttu-id="19f27-217">Pour les textures, utilisez des formats compressés (par exemple, DXTn) avec MIP-Maps et envisagez d’utiliser un Atlas de textures.</span><span class="sxs-lookup"><span data-stu-id="19f27-217">For textures, use compressed formats (for example, DXTn) with mip-maps, and consider making use of a texture atlas.</span></span> <span data-ttu-id="19f27-218">Ces dernières réduisent les besoins en bande passante et peuvent réduire la taille globale des ressources, ce qui les rend plus efficaces.</span><span class="sxs-lookup"><span data-stu-id="19f27-218">These greatly reduce bandwidth requirements, and they can reduce the overall size of the resources, thus making them more efficient.</span></span>
-   <span data-ttu-id="19f27-219">Pour Geometry, utilisez la géométrie indexée, car cela permet de compresser les ressources de mémoire tampon de vertex et le matériel vidéo moderne est fortement optimisé autour de la réutilisation des vertex.</span><span class="sxs-lookup"><span data-stu-id="19f27-219">For geometry, make use of indexed geometry as this helps compress vertex buffer resources, and modern video hardware is heavily optimized around reuse of vertices.</span></span> <span data-ttu-id="19f27-220">En utilisant des nuanceurs de vertex programmables, vous pouvez compresser les informations de vertex et les développer pendant le traitement du vertex.</span><span class="sxs-lookup"><span data-stu-id="19f27-220">By making use of programmable vertex shaders, you can compress the vertex information and expand it during the vertex processing.</span></span> <span data-ttu-id="19f27-221">Là encore, cela permet de réduire les besoins en bande passante et rend les ressources de tampon de vertex plus efficaces.</span><span class="sxs-lookup"><span data-stu-id="19f27-221">Again, this helps reduce bandwidth requirements and makes vertex buffer resources more efficient.</span></span>
-   <span data-ttu-id="19f27-222">Évitez l’optimisation de la gestion des ressources.</span><span class="sxs-lookup"><span data-stu-id="19f27-222">Avoid over-optimizing your resource management.</span></span> <span data-ttu-id="19f27-223">Les révisions ultérieures des pilotes, du matériel et du système d’exploitation peuvent potentiellement entraîner des problèmes de compatibilité si l’application est réglée trop lourdement sur une combinaison particulière.</span><span class="sxs-lookup"><span data-stu-id="19f27-223">Future revisions of drivers, hardware, and the operating system can potentially cause compatibility problems if the application is tuned too heavily to a particularly combination.</span></span> <span data-ttu-id="19f27-224">Étant donné que la plupart des applications sont liées à l’UC, la gestion coûteuse basée sur le processeur entraîne généralement des problèmes de performances supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="19f27-224">Since most applications are CPU-bound, expensive CPU-based management generally causes more performance issues than it solves.</span></span>

## <a name="related-topics"></a><span data-ttu-id="19f27-225">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="19f27-225">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="19f27-226">Gestion des ressources</span><span class="sxs-lookup"><span data-stu-id="19f27-226">Managing Resources</span></span>](/windows/desktop/direct3d9/managing-resources)
</dt> <dt>

[<span data-ttu-id="19f27-227">Appareils perdus</span><span class="sxs-lookup"><span data-stu-id="19f27-227">Lost Devices</span></span>](/windows/desktop/direct3d9/lost-devices)
</dt> <dt>

[<span data-ttu-id="19f27-228">Optimisations des performances</span><span class="sxs-lookup"><span data-stu-id="19f27-228">Performance Optimizations</span></span>](/windows/desktop/direct3d9/performance-optimizations)
</dt> <dt>

[<span data-ttu-id="19f27-229">Ressources de texture compressées</span><span class="sxs-lookup"><span data-stu-id="19f27-229">Compressed Texture Resources</span></span>](/windows/desktop/direct3d9/compressed-texture-resources)
</dt> <dt>

[<span data-ttu-id="19f27-230">Requêtes</span><span class="sxs-lookup"><span data-stu-id="19f27-230">Queries</span></span>](/windows/desktop/direct3d9/queries)
</dt> <dt>

[<span data-ttu-id="19f27-231">**D3DUSAGE**</span><span class="sxs-lookup"><span data-stu-id="19f27-231">**D3DUSAGE**</span></span>](/windows/desktop/direct3d9/d3dusage)
</dt> <dt>

[<span data-ttu-id="19f27-232">**D3DPOOL**</span><span class="sxs-lookup"><span data-stu-id="19f27-232">**D3DPOOL**</span></span>](/windows/desktop/direct3d9/d3dpool)
</dt> <dt>

[<span data-ttu-id="19f27-233">D3DCREATE</span><span class="sxs-lookup"><span data-stu-id="19f27-233">D3DCREATE</span></span>](/windows/desktop/direct3d9/d3dcreate)
</dt> </dl>

 

 