---
description: Création de clichés instantanés pour les fournisseurs
ms.assetid: d5042945-ba81-40d0-b204-1f08d153a788
title: Création de clichés instantanés pour les fournisseurs
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 91cc7306e7a13ef8e96ab032016a922411a70f95
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104034340"
---
# <a name="shadow-copy-creation-for-providers"></a><span data-ttu-id="d0624-103">Création de clichés instantanés pour les fournisseurs</span><span class="sxs-lookup"><span data-stu-id="d0624-103">Shadow Copy Creation for Providers</span></span>

## <a name="the-shadow-copy-creation-process"></a><span data-ttu-id="d0624-104">Processus de création de clichés instantanés</span><span class="sxs-lookup"><span data-stu-id="d0624-104">The Shadow Copy Creation Process</span></span>

<span data-ttu-id="d0624-105">Un demandeur est l’application qui initie la demande de création d’un cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="d0624-105">A requester is the application that initiates the request to create a shadow copy.</span></span> <span data-ttu-id="d0624-106">En général, le demandeur est une application de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="d0624-106">Typically the requester is a backup application.</span></span> <span data-ttu-id="d0624-107">Le cas échéant, VSS appellera les fournisseurs concernés.</span><span class="sxs-lookup"><span data-stu-id="d0624-107">As necessary, VSS will call the providers involved.</span></span> <span data-ttu-id="d0624-108">La plupart des fournisseurs sont intéressés par trois demandes spécifiques du demandeur.</span><span class="sxs-lookup"><span data-stu-id="d0624-108">Most providers are interested in three specific requests from the requester.</span></span>

1.  <span data-ttu-id="d0624-109">Le demandeur commence l’activité de création de clichés instantanés à l’aide d’un appel à [**IVssBackupComponents :: StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span><span class="sxs-lookup"><span data-stu-id="d0624-109">The requester begins the shadow copy creation activity with a call to [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span></span> <span data-ttu-id="d0624-110">Cela génère un **GUID** de type **\_ ID VSS** qui identifie de façon unique ce jeu de clichés instantanés spécifique-the SnapshotSetId.</span><span class="sxs-lookup"><span data-stu-id="d0624-110">This generates a **GUID** of type **VSS\_ID** that uniquely identifies this specific shadow copy set - the SnapshotSetId.</span></span> <span data-ttu-id="d0624-111">Le fournisseur n’est pas impliqué dans cette étape, mais SnapshotSetId est largement utilisé dans toutes les étapes suivantes.</span><span class="sxs-lookup"><span data-stu-id="d0624-111">The provider is not involved in this step, but the SnapshotSetId is used extensively in all subsequent steps.</span></span>
2.  <span data-ttu-id="d0624-112">Pour chaque volume qu’il souhaite inclure dans ce jeu de clichés instantanés, le demandeur appelle [**IVssBackupComponents :: AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span><span class="sxs-lookup"><span data-stu-id="d0624-112">For each volume it wishes to include in this shadow copy set, the requester calls [**IVssBackupComponents::AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span></span> <span data-ttu-id="d0624-113">VSS détermine le fournisseur qui sera utilisé pour copier par cliché instantané le volume.</span><span class="sxs-lookup"><span data-stu-id="d0624-113">VSS determines which provider will be used to shadow copy the volume.</span></span>
    -   <span data-ttu-id="d0624-114">Plusieurs fournisseurs peuvent participer à un jeu de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="d0624-114">Multiple providers may participate in a shadow copy set.</span></span> <span data-ttu-id="d0624-115">Par exemple, si le volume système et un volume de données font partie du même jeu de clichés instantanés, le fournisseur système peut faire office de fournisseur de clichés instantanés pour le volume système alors qu’un fournisseur de matériel peut servir de fournisseur de clichés instantanés pour le volume de données.</span><span class="sxs-lookup"><span data-stu-id="d0624-115">For example, if the system volume and a data volume are part of the same shadow copy set, the system provider may serve as the shadow copy provider for the system volume while a hardware provider may serve as the shadow copy provider for the data volume.</span></span> <span data-ttu-id="d0624-116">Les deux fournisseurs font partie du même jeu de clichés instantanés et l’utilisateur s’attend à obtenir la même cohérence ponctuelle sur les deux volumes.</span><span class="sxs-lookup"><span data-stu-id="d0624-116">Both providers would be part of the same shadow copy set and the user would expect the same point-in-time consistency across both volumes.</span></span>
    -   <span data-ttu-id="d0624-117">Pour pouvoir sélectionner un fournisseur de matériel, le fournisseur de matériel doit être en mesure de prendre en charge tous les numéros d’unités logiques contribuant au volume spécifié.</span><span class="sxs-lookup"><span data-stu-id="d0624-117">For a hardware provider to be selected, the hardware provider must be able to support all LUNs contributing to the specified volume.</span></span>
    -   <span data-ttu-id="d0624-118">Tous les fournisseurs inscrits ont la possibilité d’indiquer la prise en charge d’un volume donné lors de la création de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="d0624-118">All registered providers are given the opportunity to indicate support for a given volume during shadow copy creation.</span></span> <span data-ttu-id="d0624-119">Si plusieurs fournisseurs indiquent la prise en charge, VSS utilise par défaut les fournisseurs de matériel, les fournisseurs de logiciels et enfin le fournisseur système (si aucun autre fournisseur n’indique la prise en charge de ce volume).</span><span class="sxs-lookup"><span data-stu-id="d0624-119">If more than one provider indicates support, VSS will first default to hardware providers, then software providers, and finally the system provider (if no other provider indicates support for that volume).</span></span>
    -   <span data-ttu-id="d0624-120">Un demandeur peut remplacer cet ordre par défaut en indiquant explicitement le fournisseur requis pour créer le cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="d0624-120">A requester may override this default order by explicitly indicating the provider it requires to create the shadow copy.</span></span>
    -   <span data-ttu-id="d0624-121">Si plusieurs fournisseurs de matériel prennent en charge un volume donné, il n’existe aucune garantie quant à l’ordre dans lequel les fournisseurs de matériel sont appelés.</span><span class="sxs-lookup"><span data-stu-id="d0624-121">If there are multiple hardware providers that support a given volume, there is no guarantee to the order in which the hardware providers will be called.</span></span>
3.  <span data-ttu-id="d0624-122">Après un ou plusieurs appels à [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset), le demandeur peut demander la création du cliché instantané à l’aide de la méthode [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) .</span><span class="sxs-lookup"><span data-stu-id="d0624-122">After one or more calls to [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset), the requester can ask for the shadow copy to be created by using the [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) method.</span></span> <span data-ttu-id="d0624-123">VSS utilise ensuite le système pour créer le cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="d0624-123">VSS then works with the system to create the shadow copy.</span></span> <span data-ttu-id="d0624-124">La méthode **DoSnapshotSet** effectue ce travail de façon asynchrone et le demandeur peut interroger ou attendre la fin du processus de création de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="d0624-124">The **DoSnapshotSet** method performs this work asynchronously, and the requester can either poll or wait for the shadow copy creation process to complete.</span></span>

<span data-ttu-id="d0624-125">Ce diagramme illustre les interactions entre le demandeur, le service VSS, la prise en charge du noyau VSS, tous les enregistreurs VSS impliqués et tous les fournisseurs de matériel VSS.</span><span class="sxs-lookup"><span data-stu-id="d0624-125">This diagram shows the interactions between the requester, the VSS service, the VSS kernel support, any VSS writers involved, and any VSS hardware providers.</span></span> <span data-ttu-id="d0624-126">Consultez [le processus de création](the-shadow-copy-creation-process.md) de clichés instantanés pour obtenir une description détaillée de ces interactions.</span><span class="sxs-lookup"><span data-stu-id="d0624-126">See [The Shadow Copy Creation Process](the-shadow-copy-creation-process.md) for a detailed description of these interactions.</span></span>

![interactions entre le demandeur, les composants de sauvegarde, les rédacteurs et les fournisseurs](images/vssimpl.png)

<span data-ttu-id="d0624-128">Lorsque le processus de création de clichés instantanés est terminé, le demandeur peut déterminer si la création du cliché instantané a réussi et, si ce n’est pas le cas, déterminer la source de l’échec.</span><span class="sxs-lookup"><span data-stu-id="d0624-128">When the shadow copy creation process is complete, the requester can determine if the shadow copy creation was successful, and if not, determine the source of the failure.</span></span>

<span data-ttu-id="d0624-129">L’intervalle de temps entre le gel et le dégel des applications du writer doit être réduit.</span><span class="sxs-lookup"><span data-stu-id="d0624-129">The time interval between the freeze and thaw of the writer applications must be minimized.</span></span> <span data-ttu-id="d0624-130">Le fournisseur doit démarrer de façon asynchrone tout le travail de préparation lié au cliché instantané (par exemple, un fournisseur de matériel qui utilise des plex démarrant la synchronisation) dans la méthode [**IVssHardwareSnapshotProvider :: BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) , puis attendre la fin de la méthode [**IVssProviderCreateSnapshotSet :: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) .</span><span class="sxs-lookup"><span data-stu-id="d0624-130">Provider must asynchronously start all preparation work related to the shadow copy (such as a hardware provider that uses plexes starting the synchronization) in the [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) method, and then wait for the completions in the [**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) method.</span></span>

<span data-ttu-id="d0624-131">Il existe plusieurs fenêtres de limite de minutage que les fournisseurs doivent suivre.</span><span class="sxs-lookup"><span data-stu-id="d0624-131">There are multiple timing limit windows that providers must follow.</span></span> <span data-ttu-id="d0624-132">Par conséquent, les fournisseurs corrects effectuent tout traitement inutile avant [**IVssProviderCreateSnapshotSet ::P recommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) et après [**IVssProviderCreateSnapshotSet ::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots).</span><span class="sxs-lookup"><span data-stu-id="d0624-132">As a result, well-behaved providers will perform all unnecessary processing before [**IVssProviderCreateSnapshotSet::PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) and after [**IVssProviderCreateSnapshotSet::PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots).</span></span>

<span data-ttu-id="d0624-133">Le jeu de clichés instantanés est fixe lorsque [**DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) est appelé.</span><span class="sxs-lookup"><span data-stu-id="d0624-133">The shadow copy set is fixed when [**DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) is called.</span></span> <span data-ttu-id="d0624-134">Des volumes supplémentaires ne peuvent pas être ajoutés ultérieurement, car les volumes supplémentaires ne partagent pas le même point dans le temps.</span><span class="sxs-lookup"><span data-stu-id="d0624-134">Additional volumes cannot be added later because the additional volumes would not share the same point-in-time.</span></span>

<span data-ttu-id="d0624-135">Il existe une limite de 64 volumes dans le jeu de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="d0624-135">There is a limit of 64 volumes in the shadow copy set.</span></span> <span data-ttu-id="d0624-136">Un volume spécifique peut correspondre à un numéro d’unité logique (LUN) entier, à une partie d’un numéro d’unité logique ou à des parties de plusieurs numéros d’unités logiques.</span><span class="sxs-lookup"><span data-stu-id="d0624-136">A specific volume may map to an entire LUN, a portion of a LUN, or portions of multiple LUNs.</span></span> <span data-ttu-id="d0624-137">La plupart des configurations auront un volume par LUN, bien que des mappages arbitraires soient possibles.</span><span class="sxs-lookup"><span data-stu-id="d0624-137">Most configurations will have one volume per LUN, although arbitrary mappings are possible.</span></span>

<span data-ttu-id="d0624-138">Il n’existe aucune limite quant au nombre de jeux de clichés instantanés ou au nombre de jeux de clichés instantanés d’un volume d’origine.</span><span class="sxs-lookup"><span data-stu-id="d0624-138">There is no limit on the number of shadow copy sets or the number of shadow copy sets of an original volume.</span></span> <span data-ttu-id="d0624-139">Un fournisseur peut définir des limites spécifiques ou limiter dynamiquement en fonction des ressources matérielles disponibles.</span><span class="sxs-lookup"><span data-stu-id="d0624-139">A provider may define specific limits, or dynamically limit based on hardware resources available.</span></span>

### <a name="point-in-time-for-writerless-applications"></a><span data-ttu-id="d0624-140">Point dans le temps pour les applications qui n’ont pas été en écriture</span><span class="sxs-lookup"><span data-stu-id="d0624-140">Point-in-time for Writerless Applications</span></span>

<span data-ttu-id="d0624-141">VSS comprend une prise en charge spéciale qui définit le point dans le temps qui est commun pour tous les volumes d’un jeu de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="d0624-141">VSS includes special support that defines the point-in-time that is common for all volumes in a shadow copy set.</span></span> <span data-ttu-id="d0624-142">Les fournisseurs de matériel n’ont pas besoin d’interagir directement avec ces technologies de noyau, car ils sont appelés dans le cadre du traitement normal des validations de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="d0624-142">Hardware providers do not need to directly interface with these kernel technologies, since they are invoked as part of the normal shadow copy commit processing.</span></span> <span data-ttu-id="d0624-143">Toutefois, il est utile de comprendre les mécanismes utilisés, car il explique la définition du « point dans le temps » pour les applications sans écriture (les applications qui n’ont pas exposé une interface d’enregistreur VSS et ne participent donc pas au processus de création de cliché instantané de volume.)</span><span class="sxs-lookup"><span data-stu-id="d0624-143">However, it is useful to understand the mechanisms used because it explains the definition of 'point-in-time' for writerless applications (applications that have not exposed a VSS Writer interface and therefore do not participate in the volume shadow copy creation process.)</span></span>

<span data-ttu-id="d0624-144">Cette prise en charge du noyau VSS pour un point dans le temps commun est distribuée entre le pilote VolSnap.sys, les systèmes de fichiers et VSS.</span><span class="sxs-lookup"><span data-stu-id="d0624-144">This VSS kernel support for common point-in-time is distributed between the VolSnap.sys driver, the file systems, and VSS.</span></span>

1.  <span data-ttu-id="d0624-145">Pour que la prise en charge du noyau VSS soit appelée, VSS a déjà effectué les opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="d0624-145">Before the VSS kernel support is invoked, VSS has already:</span></span>
    1.  <span data-ttu-id="d0624-146">Déterminez les volumes qui doivent être impliqués dans le cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="d0624-146">Determined which volumes are to be involved in the shadow copy.</span></span>
    2.  <span data-ttu-id="d0624-147">Déterminez le fournisseur à utiliser sur chaque volume.</span><span class="sxs-lookup"><span data-stu-id="d0624-147">Determined which provider is to be used on each volume.</span></span>
    3.  <span data-ttu-id="d0624-148">Applications figées qui acceptent des messages de blocage/libération.</span><span class="sxs-lookup"><span data-stu-id="d0624-148">Frozen applications that are accepting freeze/thaw messages.</span></span>
    4.  <span data-ttu-id="d0624-149">Préparez les fournisseurs pour le cliché instantané en appelant les méthodes [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="d0624-149">Prepared the providers for the shadow copy by calling the [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) methods.</span></span> <span data-ttu-id="d0624-150">Tous les fournisseurs sont en attente de la création du cliché instantané réel.</span><span class="sxs-lookup"><span data-stu-id="d0624-150">All providers are now waiting to do the actual shadow copy creation.</span></span>
2.  <span data-ttu-id="d0624-151">Le point dans le temps est alors créé.</span><span class="sxs-lookup"><span data-stu-id="d0624-151">The point-in-time is then created.</span></span> <span data-ttu-id="d0624-152">VSS vide simultanément les systèmes de fichiers sur tous les volumes qui doivent faire l’objet de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="d0624-152">VSS concurrently flushes the file systems on all of the volumes that are to be shadow copied.</span></span>
    1.  <span data-ttu-id="d0624-153">VSS émet une \_ \_ \_ \_ \_ commande de contrôle de vidage et de conservation des écritures IOCTL VOLSNAP sur chaque volume qui vide les systèmes de fichiers.</span><span class="sxs-lookup"><span data-stu-id="d0624-153">VSS issues an IOCTL\_VOLSNAP\_FLUSH\_AND\_HOLD\_WRITES control command on each volume that flushes the file systems.</span></span> <span data-ttu-id="d0624-154">Cette IOCTL est passée dans la pile de stockage à VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="d0624-154">That IOCTL is passed down the storage stack to VolSnap.sys.</span></span> <span data-ttu-id="d0624-155">VolSnap.sys contient ensuite tous les paquets IRP d’écriture jusqu’à l’étape 4 ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="d0624-155">VolSnap.sys then holds all write IRPs until step 4 below.</span></span> <span data-ttu-id="d0624-156">Tout système de fichiers (par exemple, RAW) sans prise en charge de ce nouvel IOCTL passe l’IOCTL inconnu, où il est de nouveau détenu par VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="d0624-156">Any file system (such as RAW) without support for this new IOCTL passes the unknown IOCTL down—where it is again held by VolSnap.sys.</span></span> <span data-ttu-id="d0624-157">Sur les volumes NTFS, le vidage valide également le journal NTFS.</span><span class="sxs-lookup"><span data-stu-id="d0624-157">On NTFS volumes, the flush also commits the NTFS log.</span></span>
    2.  <span data-ttu-id="d0624-158">Cela interrompt toutes les activités de métadonnées NTFS/FAT ; les métadonnées du système de fichiers sont correctement validées.</span><span class="sxs-lookup"><span data-stu-id="d0624-158">This suspends all NTFS/FAT metadata activity; the file system metadata is cleanly committed.</span></span>
    3.  <span data-ttu-id="d0624-159">Le cliché instantané instantané : VolSnap.sys entraîne la mise en file d’attente de tous les paquets IRP d’écriture suivants sur tous les volumes qui doivent être des clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="d0624-159">The shadow copy instant: VolSnap.sys causes all subsequent write IRPs to be queued on all of the volumes that are to be shadow copied.</span></span>
    4.  <span data-ttu-id="d0624-160">VolSnap.sys attend la fin de toutes les écritures en attente sur les volumes de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="d0624-160">VolSnap.sys waits for all pending writes on the shadow copied volumes to complete.</span></span> <span data-ttu-id="d0624-161">Les volumes sont à présent inutilisables en ce qui concerne les écritures et ont été reposés à exactement le même moment sur chaque volume.</span><span class="sxs-lookup"><span data-stu-id="d0624-161">The volumes are now quiescent with respect to writes, and were quiescent at exactly the same moment on each volume.</span></span> <span data-ttu-id="d0624-162">Il n’existe aucune garantie concernant les écritures dans les sections mappées par l’utilisateur ou les écritures émises entre (a) et (b) sur les systèmes de fichiers qui n’implémentent pas l’IOCTL de vidage (par exemple, RAW).</span><span class="sxs-lookup"><span data-stu-id="d0624-162">There are no guarantees about writes to user mapped sections or writes issued between (a) and (b) on file systems that do not implement the flush IOCTL (e.g. RAW).</span></span>
3.  <span data-ttu-id="d0624-163">VSS ordonne à chaque fournisseur d’effectuer le cliché instantané en appelant les méthodes [**IVssProviderCreateSnapshotSet :: CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="d0624-163">VSS instructs each provider to take in the shadow copy by calling the [**IVssProviderCreateSnapshotSet::CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods.</span></span> <span data-ttu-id="d0624-164">La préparation des fournisseurs doit être terminée afin qu’il s’agit d’une opération rapide.</span><span class="sxs-lookup"><span data-stu-id="d0624-164">The providers should have all preparation done so that this is a quick operation.</span></span>

    <span data-ttu-id="d0624-165">Notez que le système d’e/s n’est pas utilisé pendant l’exécution de ces méthodes [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="d0624-165">Note that the I/O system is quiescent only while these [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods are executing.</span></span> <span data-ttu-id="d0624-166">Si un fournisseur effectue une synchronisation des numéros d’unités logiques de la source et des clichés instantanés, cette synchronisation doit être effectuée avant le retour de la méthode **CommitSnapshots** du fournisseur.</span><span class="sxs-lookup"><span data-stu-id="d0624-166">If a provider performs any synchronization of the source and shadow copy LUNs, this synchronization must be completed before the provider's **CommitSnapshots** method returns.</span></span> <span data-ttu-id="d0624-167">Elle ne peut pas être exécutée de façon asynchrone.</span><span class="sxs-lookup"><span data-stu-id="d0624-167">It cannot be performed asynchronously.</span></span>

4.  <span data-ttu-id="d0624-168">Immédiatement après le retour de la méthode [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) du dernier fournisseur, VSS libère tous les paquets IRP d’écriture en attente (y compris les IRP qui bloquent les systèmes de fichiers à la fin de leurs chemins de validation) en appelant un autre IRP transmis à VolSnap.sys.</span><span class="sxs-lookup"><span data-stu-id="d0624-168">Immediately after the last provider's [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) method returns, VSS releases all pending write IRPs (including the IRPs that were blocking the file systems at the conclusion of their commit paths) by invoking another IRP passed to VolSnap.sys.</span></span>
5.  <span data-ttu-id="d0624-169">Si le processus de cliché instantané a réussi, alors VSS :</span><span class="sxs-lookup"><span data-stu-id="d0624-169">If the shadow copy process was successful, then VSS now:</span></span>
    1.  <span data-ttu-id="d0624-170">Appelle [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) pour les fournisseurs impliqués.</span><span class="sxs-lookup"><span data-stu-id="d0624-170">Calls [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) for the providers involved.</span></span>
    2.  <span data-ttu-id="d0624-171">Appelle [**CVssWriter :: OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) pour les Writers impliqués.</span><span class="sxs-lookup"><span data-stu-id="d0624-171">Calls [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) for the writers involved.</span></span>
    3.  <span data-ttu-id="d0624-172">Informe le demandeur que le processus de cliché instantané est terminé.</span><span class="sxs-lookup"><span data-stu-id="d0624-172">Informs the requester that the shadow copy process has completed.</span></span>

<span data-ttu-id="d0624-173">[**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) sont tout à la fois critiques.</span><span class="sxs-lookup"><span data-stu-id="d0624-173">[**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), to [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) are all time critical.</span></span> <span data-ttu-id="d0624-174">Toutes les e/s des applications avec des enregistreurs sont figées de **PreCommitSnapshots** à **PostCommitSnapshots**; tout retard affecte la disponibilité de l’application.</span><span class="sxs-lookup"><span data-stu-id="d0624-174">All I/O from applications with writers is frozen from **PreCommitSnapshots** to **PostCommitSnapshots**; any delays affect application availability.</span></span> <span data-ttu-id="d0624-175">Toutes les e/s de fichier, y compris les e/s d’application sans enregistreur, sont interrompues pendant **CommitSnapshots**.</span><span class="sxs-lookup"><span data-stu-id="d0624-175">All file I/O, including writerless application I/O, is suspended during **CommitSnapshots**.</span></span>

<span data-ttu-id="d0624-176">Les fournisseurs doivent effectuer tout le travail critique avant de retourner à partir de [**EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots).</span><span class="sxs-lookup"><span data-stu-id="d0624-176">Providers should complete all time-critical work prior to returning from [**EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots).</span></span>

-   <span data-ttu-id="d0624-177">[**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) doit être retourné en quelques secondes.</span><span class="sxs-lookup"><span data-stu-id="d0624-177">[**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) should be returned within seconds.</span></span> <span data-ttu-id="d0624-178">La phase **CommitSnapshots** se trouve dans la fenêtre de vidage et de suspension.</span><span class="sxs-lookup"><span data-stu-id="d0624-178">The **CommitSnapshots** phase is located within the Flush and Hold window.</span></span> <span data-ttu-id="d0624-179">La prise en charge du noyau VSS annule le vidage et le blocage qui maintiennent les e/s si la version suivante n’est pas reçue dans les 10 secondes, et VSS ne parvient pas à créer le cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="d0624-179">VSS kernel support will cancel the Flush and Hold that is holding the I/O if the subsequent release is not received within 10 seconds, and VSS will fail the shadow copy creation process.</span></span> <span data-ttu-id="d0624-180">D’autres activités se produiront sur le système, de sorte qu’un fournisseur ne doit pas s’appuyer sur la durée totale de 10 secondes.</span><span class="sxs-lookup"><span data-stu-id="d0624-180">Other activities will be happening on the system, so a provider should not rely on having the full 10 seconds.</span></span> <span data-ttu-id="d0624-181">Le fournisseur ne doit pas appeler les API Win32 au cours de la validation, car le nombre d’écritures et de bloc est inattendu.</span><span class="sxs-lookup"><span data-stu-id="d0624-181">The provider should not call Win32 APIs during commit as many will result in unexpected writes and block.</span></span> <span data-ttu-id="d0624-182">Si le fournisseur prend plus de quelques secondes pour terminer l’appel, il y a une forte probabilité que cette opération échoue.</span><span class="sxs-lookup"><span data-stu-id="d0624-182">If the provider takes more than a few seconds to complete the call, there is a high probability that this will fail.</span></span>
-   <span data-ttu-id="d0624-183">La séquence complète de [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) au retour de [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) est mappée à la fenêtre entre les enregistreurs recevant les événements Freeze et dégeler.</span><span class="sxs-lookup"><span data-stu-id="d0624-183">The full sequence from [**PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots) to the return of [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) maps to the window between writers receiving the Freeze and Thaw events.</span></span> <span data-ttu-id="d0624-184">La valeur par défaut de l’enregistreur pour cette fenêtre est de 60 secondes, mais un enregistreur peut remplacer cette valeur par un délai d’expiration plus court.</span><span class="sxs-lookup"><span data-stu-id="d0624-184">The writer default for this window is 60 seconds, but a writer may override this value with a smaller timeout.</span></span> <span data-ttu-id="d0624-185">Par exemple, l’enregistreur Microsoft Exchange Server change le délai d’expiration à 20 secondes.</span><span class="sxs-lookup"><span data-stu-id="d0624-185">For example, the Microsoft Exchange Server writer changes the timeout to 20 seconds.</span></span> <span data-ttu-id="d0624-186">Les fournisseurs ne doivent pas passer plus d’une seconde ou deux dans cette méthode.</span><span class="sxs-lookup"><span data-stu-id="d0624-186">Providers should not spend more than a second or two in this method.</span></span>

<span data-ttu-id="d0624-187">Pendant la [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) , le fournisseur doit éviter toute e/s de fichier non paginée ; ces e/s ont une probabilité très élevée de blocage.</span><span class="sxs-lookup"><span data-stu-id="d0624-187">During [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) the provider must avoid any non-paging file I/O; such I/O has a very high probability of deadlocking.</span></span> <span data-ttu-id="d0624-188">En particulier, le fournisseur ne doit pas écrire de manière synchrone les journaux de débogage ou de suivi.</span><span class="sxs-lookup"><span data-stu-id="d0624-188">In particular, the provider should not synchronously write any debug or trace logs.</span></span>

 

 



