---
description: Les tâches de pré-sauvegarde sous VSS sont axées sur la création d’un cliché instantané des volumes contenant des données pour la sauvegarde.
ms.assetid: e6b082af-719b-4426-8217-0fc940f5884d
title: Vue d’ensemble des tâches de pré-sauvegarde
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 709345b8aa0421699efe26ad2901cc497b7d4ac0
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "106533841"
---
# <a name="overview-of-pre-backup-tasks"></a><span data-ttu-id="a1d14-103">Vue d’ensemble des tâches de pré-sauvegarde</span><span class="sxs-lookup"><span data-stu-id="a1d14-103">Overview of Pre-Backup Tasks</span></span>

<span data-ttu-id="a1d14-104">Les tâches de pré-sauvegarde sous VSS sont axées sur la création d’un cliché instantané des volumes contenant des données pour la sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="a1d14-104">Pre-backup tasks under VSS are focused on creating a shadow copy of the volumes containing data for backup.</span></span> <span data-ttu-id="a1d14-105">L’application de sauvegarde enregistre les données du cliché instantané, et non pas le volume réel.</span><span class="sxs-lookup"><span data-stu-id="a1d14-105">The backup application will save data from the shadow copy, not the actual volume.</span></span> <span data-ttu-id="a1d14-106">Pour plus d’informations, consultez [vue d’ensemble du traitement d’une sauvegarde sous VSS](overview-of-processing-a-backup-under-vss.md).</span><span class="sxs-lookup"><span data-stu-id="a1d14-106">For more information, see [Overview of Processing a Backup Under VSS](overview-of-processing-a-backup-under-vss.md).</span></span>

<span data-ttu-id="a1d14-107">En général, les demandeurs attendent que les Writers se préparent à la sauvegarde et à la création du cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="a1d14-107">Requesters typically wait for writers to prepare for backup and creating the shadow copy.</span></span> <span data-ttu-id="a1d14-108">L’enregistreur doit déterminer s’il doit participer à la sauvegarde et, si c’est le cas, configurer ses fichiers et lui-même pour qu’il soit prêt pour la sauvegarde et le cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="a1d14-108">The writer must determine if it is to participate in the backup and, if it is, configure its files and itself to be ready for backup and shadow copy.</span></span> <span data-ttu-id="a1d14-109">Le tableau suivant présente la séquence des actions et des événements qui sont requis pour préparer une opération de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="a1d14-109">The following table shows the sequence of actions and events that are required to prepare for a backup operation.</span></span>



| <span data-ttu-id="a1d14-110">Action du demandeur</span><span class="sxs-lookup"><span data-stu-id="a1d14-110">Requester action</span></span>                                                                                                                                                                                                                                                                                                            | <span data-ttu-id="a1d14-111">Événement</span><span class="sxs-lookup"><span data-stu-id="a1d14-111">Event</span></span>                                                                      | <span data-ttu-id="a1d14-112">Action d’écriture</span><span class="sxs-lookup"><span data-stu-id="a1d14-112">Writer action</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="a1d14-113">Le demandeur peut définir des options de sauvegarde (consultez [**IVssBackupComponents :: SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions))</span><span class="sxs-lookup"><span data-stu-id="a1d14-113">The requester can set backup options (see [**IVssBackupComponents::SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions))</span></span>                                                                                                                                                                                          | <span data-ttu-id="a1d14-114">Aucune</span><span class="sxs-lookup"><span data-stu-id="a1d14-114">None</span></span>                                                                       | <span data-ttu-id="a1d14-115">Aucune</span><span class="sxs-lookup"><span data-stu-id="a1d14-115">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span data-ttu-id="a1d14-116">Prendre en charge les opérations de sauvegarde incrémentielle et différentielle en examinant les tampons de sauvegarde stockés (voir [**IVssComponent :: GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp), [**IVssBackupComponents :: SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp))</span><span class="sxs-lookup"><span data-stu-id="a1d14-116">Support incremental and differential backup operations by examining any stored backup stamps (see [**IVssComponent::GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp), [**IVssBackupComponents::SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp))</span></span>                                               | <span data-ttu-id="a1d14-117">Aucune</span><span class="sxs-lookup"><span data-stu-id="a1d14-117">None</span></span>                                                                       | <span data-ttu-id="a1d14-118">Aucune</span><span class="sxs-lookup"><span data-stu-id="a1d14-118">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span data-ttu-id="a1d14-119">Notification aux rédacteurs de se préparer pour une opération de sauvegarde à l’aide de [ **IVssBackupComponents ::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)</span><span class="sxs-lookup"><span data-stu-id="a1d14-119">Notify writers to prepare for a backup operation using [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)</span></span>                                                                                                                                                                              | [<span data-ttu-id="a1d14-120">*PrepareForBackup*</span><span class="sxs-lookup"><span data-stu-id="a1d14-120">*PrepareForBackup*</span></span>](vssgloss-p.md)  | <span data-ttu-id="a1d14-121">Les préparatifs du writer permettent de déterminer si les fichiers doivent être sauvegardés, si l’enregistreur doit participer au gel des clichés instantanés, et de créer des métadonnées spécifiques au writer (consultez [**CVssWriter :: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup), [**CVssWriter :: IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected), [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent :: GetBackupOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions), [**CVssWriter :: AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected), [**IVssComponent :: SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata)et [**IVssComponent ::**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp)GetPreviousBackupStamp.</span><span class="sxs-lookup"><span data-stu-id="a1d14-121">Writer preparations include determining if files are to be backed up, whether the writer will participate in the shadow copy freeze, as well as creating writer-specific metadata (see [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup), [**CVssWriter::IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected), [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent::GetBackupOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions), [**CVssWriter::AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected), [**IVssComponent::SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata), and [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).</span></span> |
| <span data-ttu-id="a1d14-122">Le demandeur attend que les Writers soient configurés pour la sauvegarde à l’aide de [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync).</span><span class="sxs-lookup"><span data-stu-id="a1d14-122">The requester waits for writers to set up for backup using [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync).</span></span> <span data-ttu-id="a1d14-123">Il doit également vérifier l’état de l’enregistreur (consultez [**IVssBackupComponents :: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents :: GetWriterStatus).**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)</span><span class="sxs-lookup"><span data-stu-id="a1d14-123">It should also verify writer status (see [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus))</span></span>     | <span data-ttu-id="a1d14-124">Aucune</span><span class="sxs-lookup"><span data-stu-id="a1d14-124">None</span></span>                                                                       | <span data-ttu-id="a1d14-125">Aucune</span><span class="sxs-lookup"><span data-stu-id="a1d14-125">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span data-ttu-id="a1d14-126">Le demandeur demande un cliché instantané à l’aide de [ **IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)</span><span class="sxs-lookup"><span data-stu-id="a1d14-126">Requester requests a shadow copy using [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)</span></span>                                                                                                                                                                                                    | <span data-ttu-id="a1d14-127">Aucune</span><span class="sxs-lookup"><span data-stu-id="a1d14-127">None</span></span>                                                                       | <span data-ttu-id="a1d14-128">Aucune</span><span class="sxs-lookup"><span data-stu-id="a1d14-128">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| <span data-ttu-id="a1d14-129">Aucune</span><span class="sxs-lookup"><span data-stu-id="a1d14-129">None</span></span>                                                                                                                                                                                                                                                                                                                        | [<span data-ttu-id="a1d14-130">*PrepareForSnapshot*</span><span class="sxs-lookup"><span data-stu-id="a1d14-130">*PrepareForSnapshot*</span></span>](vssgloss-p.md) | <span data-ttu-id="a1d14-131">[**CVssWriter :: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot): Placez l’enregistreur dans un état prêt pour les clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="a1d14-131">[**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot): Put the writer into a shadow copy ready state.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| <span data-ttu-id="a1d14-132">Aucun</span><span class="sxs-lookup"><span data-stu-id="a1d14-132">None</span></span>                                                                                                                                                                                                                                                                                                                        | [<span data-ttu-id="a1d14-133">*Freeze*</span><span class="sxs-lookup"><span data-stu-id="a1d14-133">*Freeze*</span></span>](vssgloss-f.md)                      | <span data-ttu-id="a1d14-134">[**CVssWriter :: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze): installation finale avant le cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="a1d14-134">[**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze): Final setup before the shadow copy.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| <span data-ttu-id="a1d14-135">Aucun</span><span class="sxs-lookup"><span data-stu-id="a1d14-135">None</span></span>                                                                                                                                                                                                                                                                                                                        | [<span data-ttu-id="a1d14-136">*Congelé*</span><span class="sxs-lookup"><span data-stu-id="a1d14-136">*Thaw*</span></span>](vssgloss-t.md)                          | <span data-ttu-id="a1d14-137">[**CVssWriter :: OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw): le fonctionnement normal (y compris les e/s) peut reprendre.</span><span class="sxs-lookup"><span data-stu-id="a1d14-137">[**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw): Normal functioning (including I/O) can resume.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| <span data-ttu-id="a1d14-138">Aucun</span><span class="sxs-lookup"><span data-stu-id="a1d14-138">None</span></span>                                                                                                                                                                                                                                                                                                                        | [<span data-ttu-id="a1d14-139">*PostSnapshot*</span><span class="sxs-lookup"><span data-stu-id="a1d14-139">*PostSnapshot*</span></span>](vssgloss-p.md)          | <span data-ttu-id="a1d14-140">[**CVssWriter :: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot): nettoyage final des préparatifs des clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="a1d14-140">[**CVssWriter::OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot): Final clean ups of shadow copy preparations.</span></span> <span data-ttu-id="a1d14-141">Consultez [**IVssComponent :: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) et [**IVssComponent :: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span><span class="sxs-lookup"><span data-stu-id="a1d14-141">See [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) and [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| <span data-ttu-id="a1d14-142">Le demandeur attend la fin du cliché instantané à l’aide de : [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync), il doit également vérifier l’état de l’enregistreur (consultez [**IVssBackupComponents :: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents :: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)</span><span class="sxs-lookup"><span data-stu-id="a1d14-142">Requester waits for completion of shadow copy using: [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync), it should also verify writer status (see [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)</span></span><br/> | <span data-ttu-id="a1d14-143">Aucune</span><span class="sxs-lookup"><span data-stu-id="a1d14-143">None</span></span>                                                                       | <span data-ttu-id="a1d14-144">Aucune</span><span class="sxs-lookup"><span data-stu-id="a1d14-144">None</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |



 

## <a name="requester-pre-backup-tasks"></a><span data-ttu-id="a1d14-145">Tâches de pré-sauvegarde du demandeur</span><span class="sxs-lookup"><span data-stu-id="a1d14-145">Requester Pre-Backup Tasks</span></span>

<span data-ttu-id="a1d14-146">En outre, avant de créer un événement [**IVssBackupComponents ::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , un demandeur peut également définir des options de sauvegarde pour des Writers individuels à l’aide de [**IVssBackupComponents :: SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) en fonction des spécificités de chaque enregistreur et si un demandeur en est conscient.</span><span class="sxs-lookup"><span data-stu-id="a1d14-146">In addition, before creating a [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event, a requester may also set backup options for individual writers using [**IVssBackupComponents::SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) depending on the specifics of each writer and whether a requester is aware of them.</span></span>

<span data-ttu-id="a1d14-147">Pour prendre en charge les opérations incrémentielles et différentielles, les demandeurs peuvent à ce stade choisir d’examiner les composants pour les horodatages d’une opération de sauvegarde antérieure (à l’aide de [**IVssComponent :: GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)) et d’utiliser ces informations pour définir un horodatage précédent pour un writer à traiter (à l’aide de [**IVssBackupComponents :: SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)).</span><span class="sxs-lookup"><span data-stu-id="a1d14-147">To support incremental and differential operations, requesters may at this point choose to examine components for time stamps of earlier backup operation (using [**IVssComponent::GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)) and use that information to set a previous time stamp for a writer to process (using [**IVssBackupComponents::SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)).</span></span> <span data-ttu-id="a1d14-148">Pour plus d’informations [, consultez sauvegardes incrémentielles et différentielles](incremental-and-differential-backups.md) .</span><span class="sxs-lookup"><span data-stu-id="a1d14-148">See [Incremental and Differential Backups](incremental-and-differential-backups.md) for more information.</span></span>

<span data-ttu-id="a1d14-149">Un demandeur peut désormais demander aux rédacteurs du système d’effectuer les préparatifs de pré-sauvegarde et de gérer la création d’un cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="a1d14-149">A requester can now direct the system's writers to complete pre-backup preparations and to handle the creation of a shadow copy.</span></span>

<span data-ttu-id="a1d14-150">Tout d’abord, le demandeur génère un événement [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) en appelant [**IVssBackupComponents ::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).</span><span class="sxs-lookup"><span data-stu-id="a1d14-150">First, the requester generates a [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event by calling [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).</span></span>

<span data-ttu-id="a1d14-151">Une fois que tous les enregistreurs participants ont retourné la gestion de l’événement [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) (qu’un demandeur détermine à l’aide de l’instance de l’interface [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync) retournée par **PrepareForBackup**), le demandeur peut lancer le cliché instantané en appelant [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), qui, à mesure qu’il progresse, génère des événements [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*dégeler*](vssgloss-t.md)et [*PostSnapshot*](vssgloss-p.md) que les rédacteurs doivent gérer.</span><span class="sxs-lookup"><span data-stu-id="a1d14-151">After all participating writers return from handling the [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event (which a requester determines by using the instance of the [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync) interface returned by **PrepareForBackup**), the requester can initiate the shadow copy by calling [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), which, as it progresses, will generate [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*Thaw*](vssgloss-t.md), and [*PostSnapshot*](vssgloss-p.md) events for the writers to handle.</span></span>

<span data-ttu-id="a1d14-152">Dans certains cas, il se peut qu’un demandeur n’ait pas besoin de créer un cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="a1d14-152">There are some cases where a requester may not need to create a shadow copy.</span></span> <span data-ttu-id="a1d14-153">Plus précisément, chaque [*jeu de fichiers*](vssgloss-f.md) géré par l’un des composants d’un générateur donné possède un masque de sauvegarde de spécification de fichier (indiqué par une opération or au niveau du bit des valeurs de [**\_ \_ \_ \_ type de sauvegarde spec**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) ) défini lors de l’événement d' [*identification*](vssgloss-i.md) .</span><span class="sxs-lookup"><span data-stu-id="a1d14-153">Specifically, each [*file set*](vssgloss-f.md) managed by one of a given writer's components has a File Specification Backup mask (indicated by a bitwise OR of [**VSS\_FILE\_SPEC\_BACKUP\_TYPE**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) values) set during the [*Identify*](vssgloss-i.md) event.</span></span> <span data-ttu-id="a1d14-154">Ce masque spécifie, entre autres choses, si un jeu de fichiers requiert un cliché instantané du système avant l’exécution de sa sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="a1d14-154">This mask specifies, among other things, whether a file set requires the system to be shadow copied before its backup is performed.</span></span>

<span data-ttu-id="a1d14-155">Si aucun jeu de fichiers à sauvegarder sur un volume ne requiert de cliché instantané, [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) n’a pas besoin d’être appelé.</span><span class="sxs-lookup"><span data-stu-id="a1d14-155">If no file sets to be backed up on any volumes require a shadow copy, then [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) need not be called.</span></span>

## <a name="writer-pre-backup-tasks"></a><span data-ttu-id="a1d14-156">Tâches de pré-sauvegarde de l’enregistreur</span><span class="sxs-lookup"><span data-stu-id="a1d14-156">Writer Pre-Backup Tasks</span></span>

<span data-ttu-id="a1d14-157">Lors du traitement de l’événement [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , VSS appelle la méthode [**CVssWriter :: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) de chaque enregistreur, une méthode virtuelle qui, par défaut, retourne simplement true.</span><span class="sxs-lookup"><span data-stu-id="a1d14-157">When handling the [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event, VSS will call each writer's [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method, a virtual method, which by default simply returns true.</span></span>

<span data-ttu-id="a1d14-158">Les enregistreurs peuvent remplacer cette implémentation par défaut et utiliser la gestion pour rechercher des informations sur la sauvegarde à venir et agir.</span><span class="sxs-lookup"><span data-stu-id="a1d14-158">Writers can override this default implementation and use the handling to find information about the upcoming backup and take action.</span></span>

<span data-ttu-id="a1d14-159">Un enregistreur peut déterminer les informations relatives au type de l’opération de sauvegarde, en utilisant les méthodes suivantes :</span><span class="sxs-lookup"><span data-stu-id="a1d14-159">A writer can determine information about the sort of backup operation contemplated by using the following methods:</span></span>

1.  [<span data-ttu-id="a1d14-160">**CVssWriter::GetBackupType**</span><span class="sxs-lookup"><span data-stu-id="a1d14-160">**CVssWriter::GetBackupType**</span></span>](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-getbackuptype)
2.  [<span data-ttu-id="a1d14-161">**CVssWriter::IsBootableStateBackedUp**</span><span class="sxs-lookup"><span data-stu-id="a1d14-161">**CVssWriter::IsBootableStateBackedUp**</span></span>](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-isbootablesystemstatebackedup)
3.  [<span data-ttu-id="a1d14-162">**CVssWriter::AreComponentsSelected**</span><span class="sxs-lookup"><span data-stu-id="a1d14-162">**CVssWriter::AreComponentsSelected**</span></span>](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected)

<span data-ttu-id="a1d14-163">Un enregistreur détermine si les fichiers qu’il gère sera impliqué dans le cliché instantané à l’aide de [**CVssWriter :: IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected).</span><span class="sxs-lookup"><span data-stu-id="a1d14-163">A writer determines if the files it manages will be involved in the shadow copy by using [**CVssWriter::IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected).</span></span>

<span data-ttu-id="a1d14-164">Plus important, lorsque VSS appelle la méthode [**CVssWriter :: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) , il passe dans une instance de l’interface [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) , qui permet un accès direct via l’interface [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) à ceux de ses composants [*explicitement inclus*](vssgloss-e.md) dans le document des composants de sauvegarde du demandeur.</span><span class="sxs-lookup"><span data-stu-id="a1d14-164">More important, when VSS calls the [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method, it passes in an instance of the [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) interface, which allows direct access through the [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) interface to those of its components [*explicitly included*](vssgloss-e.md) in the requester's Backup Components Document.</span></span> <span data-ttu-id="a1d14-165">Le writer a utilisé les instances de l’interface **IVssComponent** qui définissent les jeux de composants pour accéder à son composant *inclus implicitement* (voir la [sélectivité et l’utilisation des propriétés de composant](selectability-and-working-with-component-properties.md)).</span><span class="sxs-lookup"><span data-stu-id="a1d14-165">The writer used the instances of the **IVssComponent** interface that define component sets to gain access to its *implicitly included* component (see [Selectability and working with Component Properties](selectability-and-working-with-component-properties.md)).</span></span>

<span data-ttu-id="a1d14-166">Pendant la gestion de l’événement [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , les enregistreurs utilisent l’interface [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) pour effectuer des opérations composant par composant (ou jeu de composants par jeu de composants), y compris :</span><span class="sxs-lookup"><span data-stu-id="a1d14-166">During the handling of the [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) event, writers use the [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) interface to perform component-by-component (or component set by component set) operations, including:</span></span>

1.  <span data-ttu-id="a1d14-167">Ajout de [*fichiers partiels*](vssgloss-p.md) (si pris en charge) en appelant [**IVssComponent :: AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span><span class="sxs-lookup"><span data-stu-id="a1d14-167">Adding [*partial files*](vssgloss-p.md) (if supported) by calling [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span></span>
2.  <span data-ttu-id="a1d14-168">Définition des métadonnées privées dont le writer aura besoin pour gérer la restauration.</span><span class="sxs-lookup"><span data-stu-id="a1d14-168">Setting any private metadata that the writer will need to handle the restore.</span></span>
3.  <span data-ttu-id="a1d14-169">Si le writer prend en charge les sauvegardes incrémentielles et différentielles (consultez [sauvegardes incrémentielles et différentielles](incremental-and-differential-backups.md)), procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="a1d14-169">If the writer supports incremental and differential backups (see [Incremental and Differential Backups](incremental-and-differential-backups.md)), doing the following:</span></span>
    -   <span data-ttu-id="a1d14-170">Vérification des horodatages de sauvegarde précédents en appelant [**IVssComponent :: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).</span><span class="sxs-lookup"><span data-stu-id="a1d14-170">Checking for previous backup time stamps by calling [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).</span></span>
    -   <span data-ttu-id="a1d14-171">Ajout de tous les [*fichiers différenciés*](vssgloss-d.md) requis en appelant [**IVssComponent :: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).</span><span class="sxs-lookup"><span data-stu-id="a1d14-171">Adding any required [*differenced files*](vssgloss-d.md) by calling [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).</span></span>
    -   <span data-ttu-id="a1d14-172">Si le writer prend en charge le schéma **VSS \_ BS \_ horodaté** , ajoutez des chaînes de date et d’heure de sauvegarde dans le format de l’enregistreur à l’aide de [**IVssComponent :: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span><span class="sxs-lookup"><span data-stu-id="a1d14-172">If the writer supports the **VSS\_BS\_TIMESTAMPED** schema, adding backup time-stamp strings in the writer's own format using [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span></span>
4.  <span data-ttu-id="a1d14-173">Lancement d’opérations asynchrones très longues, telles que la synchronisation de données sur plusieurs disques.</span><span class="sxs-lookup"><span data-stu-id="a1d14-173">Initiating very time-consuming asynchronous operations, such as synchronizing data across multiple disks.</span></span> <span data-ttu-id="a1d14-174">Cela permet à l’enregistreur de continuer à fonctionner pendant le traitement de l’opération, y compris la gestion d’autres événements VSS.</span><span class="sxs-lookup"><span data-stu-id="a1d14-174">This will allow the writer to continue working while the operation is processed, including handling other VSS events.</span></span> <span data-ttu-id="a1d14-175">Ces opérations doivent se terminer avant l’événement [*Freeze*](vssgloss-f.md) .</span><span class="sxs-lookup"><span data-stu-id="a1d14-175">These operations must terminate before the [*Freeze*](vssgloss-f.md) event.</span></span>

<span data-ttu-id="a1d14-176">L’appel du demandeur à [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) initie le cliché instantané et génère les événements suivants pour les rédacteurs à gérer :</span><span class="sxs-lookup"><span data-stu-id="a1d14-176">The requester's call to [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) initiates the shadow copy and generates the following events for the writers to handle:</span></span>

-   [<span data-ttu-id="a1d14-177">*PrepareForSnapshot*</span><span class="sxs-lookup"><span data-stu-id="a1d14-177">*PrepareForSnapshot*</span></span>](vssgloss-p.md)
-   [<span data-ttu-id="a1d14-178">*Freeze*</span><span class="sxs-lookup"><span data-stu-id="a1d14-178">*Freeze*</span></span>](vssgloss-f.md)
-   [<span data-ttu-id="a1d14-179">*Congelé*</span><span class="sxs-lookup"><span data-stu-id="a1d14-179">*Thaw*</span></span>](vssgloss-t.md)
-   [<span data-ttu-id="a1d14-180">*PostSnapshot*</span><span class="sxs-lookup"><span data-stu-id="a1d14-180">*PostSnapshot*</span></span>](vssgloss-p.md)

<span data-ttu-id="a1d14-181">Trois des gestionnaires de l’enregistreur ([**CVssWriter :: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot), [**CVssWriter :: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)et [**CVssWriter :: OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)) sont des méthodes virtuelles pures, et chaque enregistreur doit les implémenter au lieu de s’appuyer sur les valeurs par défaut.</span><span class="sxs-lookup"><span data-stu-id="a1d14-181">Three of the writer's handlers—[**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot), [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze), and [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)—are pure virtual methods, and each writer must implement them rather than relying on defaults.</span></span> <span data-ttu-id="a1d14-182">En fonction des besoins d’un enregistreur, ils peuvent être codés en tant que méthodes factices, renvoyant simplement **true**.</span><span class="sxs-lookup"><span data-stu-id="a1d14-182">Depending on a writer's needs, they may be coded as dummy methods, simply returning **TRUE**.</span></span>

<span data-ttu-id="a1d14-183">Étant donné qu’il y a généralement une fenêtre temporelle étroite entre l’émission d’un événement [*Freeze*](vssgloss-f.md) et l’émission d’un événement de [*libération*](vssgloss-t.md) , la plupart des tâches majeures de préparation du cliché instantané, telles que l’arrêt des processus, la création de fichiers temporaires ou la vidange des files d’attente d’e/s, seraient gérées dans [**CVssWriter :: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot).</span><span class="sxs-lookup"><span data-stu-id="a1d14-183">Because there is typically a narrow time window between the issuing of a [*Freeze*](vssgloss-f.md) event and the issuing of a [*Thaw*](vssgloss-t.md) event, most of the major work in preparing for the shadow copy—such as shutting down processes, creating temporary files, or draining I/O queues—would be handled in [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot).</span></span>

<span data-ttu-id="a1d14-184">Comment un enregistreur peut utiliser [**CVssWriter :: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) pour gérer ses e/s avant que la création d’un cliché instantané dépende fortement de l’architecture de l’enregistreur.</span><span class="sxs-lookup"><span data-stu-id="a1d14-184">How a writer might use [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) to handle its I/O before the creation of a shadow copy is highly dependent on the writer's own architecture.</span></span>

<span data-ttu-id="a1d14-185">Les writers qui peuvent se permettre de conserver toutes les écritures et de conserver les données dans un état cohérent avant le [*blocage*](vssgloss-f.md), doivent le faire.</span><span class="sxs-lookup"><span data-stu-id="a1d14-185">Writers that can afford to hold all writes and keep the data in an absolute consistent state before [*Freeze*](vssgloss-f.md), should do so.</span></span>

<span data-ttu-id="a1d14-186">Si l’enregistreur ne peut pas geler ses e/s, il doit prendre des mesures pour créer une source stable pour la sauvegarde et réduire le temps de récupération d’un cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="a1d14-186">If the writer cannot freeze its I/O, then it should take actions to create a stable source for backup and to reduce the recovery time for a shadow copy.</span></span> <span data-ttu-id="a1d14-187">Par exemple, la mise en file d’attente des demandes d’e/s entrantes ou la génération d’un jeu de fichiers en double dans un [*autre chemin d’accès*](vssgloss-a.md) à utiliser comme source d’une sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="a1d14-187">Examples of this might include queuing incoming I/O requests or generating a duplicate set of files in an [*alternate path*](vssgloss-a.md) to be used as the source of a backup.</span></span>

<span data-ttu-id="a1d14-188">La méthode [**CVssWriter :: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze) exécute des tâches simples et courtes, telles que la vérification de l’état correct des e/s à gauche de [**CVssWriter :: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) , et la fin de toutes les tâches asynchrones démarrées par [**CVssWriter :: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) .</span><span class="sxs-lookup"><span data-stu-id="a1d14-188">The [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze) method performs simple, short tasks such as verifying that the [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) left I/O in the correct state, and that any asynchronous tasks started by [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) completed.</span></span> <span data-ttu-id="a1d14-189">Cette méthode est la dernière chance d’un auteur de refuser un cliché instantané en cas de problème (voir [les erreurs et les refus d’écriture](writer-errors-and-vetoes.md)).</span><span class="sxs-lookup"><span data-stu-id="a1d14-189">This method is a writer's last chance to veto a shadow copy if there are problems (see [Writer Errors and Vetoes](writer-errors-and-vetoes.md)).</span></span>

<span data-ttu-id="a1d14-190">Il est généralement possible pour un enregistreur de reprendre l’opération normale à la suite d’un événement de [*libération*](vssgloss-t.md) : un cliché instantané peut ne pas être immédiatement prêt pour la sauvegarde après libération, mais un enregistreur doit pouvoir reprendre son fonctionnement normal.</span><span class="sxs-lookup"><span data-stu-id="a1d14-190">It is generally possible for a writer to resume normal operation following a [*Thaw*](vssgloss-t.md) event: a shadow copy may not be immediately ready for backup after the Thaw, but a writer should be able to resume normal operation.</span></span> <span data-ttu-id="a1d14-191">Par conséquent, en général, [**CVssWriter :: OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) est utilisé par les Writers pour revenir à un état de précongélation.</span><span class="sxs-lookup"><span data-stu-id="a1d14-191">Therefore, typically [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) is used by writers to return to a pre-freeze state.</span></span> <span data-ttu-id="a1d14-192">Toutefois, tous les fichiers temporaires créés pour prendre en charge le cliché instantané doivent rester en place jusqu’à l’événement [*PostSnapshot*](vssgloss-p.md) .</span><span class="sxs-lookup"><span data-stu-id="a1d14-192">However, any temporary files created to support the shadow copy should be left in place until the [*PostSnapshot*](vssgloss-p.md) event.</span></span> <span data-ttu-id="a1d14-193">En général, vous utilisez [**CVssWriter :: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) pour ce type de nettoyage.</span><span class="sxs-lookup"><span data-stu-id="a1d14-193">Typically, you would use [**CVssWriter::OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) for this sort of cleanup.</span></span> <span data-ttu-id="a1d14-194">Étant donné que de nombreuses applications n’ont pas besoin de ce type de nettoyage, **CVssWriter :: OnPostSnapshot** est une méthode virtuelle avec une implémentation par défaut qui retourne simplement **true**.</span><span class="sxs-lookup"><span data-stu-id="a1d14-194">Because many applications do not require this sort of cleanup, **CVssWriter::OnPostSnapshot** is a virtual method with a default implementation that simply returns **TRUE**.</span></span> <span data-ttu-id="a1d14-195">Si une sauvegarde incrémentielle ou différentielle est en cours d’exécution, l’enregistreur peut appeler [**IVssComponent :: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) et [**IVssComponent :: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span><span class="sxs-lookup"><span data-stu-id="a1d14-195">If an incremental or differential backup is being performed, the writer may call [**IVssComponent::GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) and [**IVssComponent::SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).</span></span> <span data-ttu-id="a1d14-196">Pour plus d’informations, consultez [rôle de rédacteur dans sauvegarde de magasins complexes](writer-role-in-backing-up-complex-stores.md).</span><span class="sxs-lookup"><span data-stu-id="a1d14-196">For more information, see [Writer Role in Backing Up Complex Stores](writer-role-in-backing-up-complex-stores.md).</span></span> <span data-ttu-id="a1d14-197">[**IVssComponent :: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime)est une autre méthode qui peut être appelée à ce stade.</span><span class="sxs-lookup"><span data-stu-id="a1d14-197">Another method that can be called at this time is [**IVssComponent::AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).</span></span>

 

 




