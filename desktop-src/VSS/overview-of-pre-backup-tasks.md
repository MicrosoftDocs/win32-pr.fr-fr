---
description: Les tâches de pré-sauvegarde sous VSS sont axées sur la création d’un cliché instantané des volumes contenant des données pour la sauvegarde.
ms.assetid: e6b082af-719b-4426-8217-0fc940f5884d
title: Vue d’ensemble des tâches de pré-sauvegarde
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 709345b8aa0421699efe26ad2901cc497b7d4ac0
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "106533841"
---
# <a name="overview-of-pre-backup-tasks"></a>Vue d’ensemble des tâches de pré-sauvegarde

Les tâches de pré-sauvegarde sous VSS sont axées sur la création d’un cliché instantané des volumes contenant des données pour la sauvegarde. L’application de sauvegarde enregistre les données du cliché instantané, et non pas le volume réel. Pour plus d’informations, consultez [vue d’ensemble du traitement d’une sauvegarde sous VSS](overview-of-processing-a-backup-under-vss.md).

En général, les demandeurs attendent que les Writers se préparent à la sauvegarde et à la création du cliché instantané. L’enregistreur doit déterminer s’il doit participer à la sauvegarde et, si c’est le cas, configurer ses fichiers et lui-même pour qu’il soit prêt pour la sauvegarde et le cliché instantané. Le tableau suivant présente la séquence des actions et des événements qui sont requis pour préparer une opération de sauvegarde.



| Action du demandeur                                                                                                                                                                                                                                                                                                            | Événement                                                                      | Action d’écriture                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Le demandeur peut définir des options de sauvegarde (consultez [**IVssBackupComponents :: SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions))                                                                                                                                                                                          | Aucune                                                                       | Aucune                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Prendre en charge les opérations de sauvegarde incrémentielle et différentielle en examinant les tampons de sauvegarde stockés (voir [**IVssComponent :: GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp), [**IVssBackupComponents :: SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp))                                               | Aucune                                                                       | Aucune                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Notification aux rédacteurs de se préparer pour une opération de sauvegarde à l’aide de [ **IVssBackupComponents ::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)                                                                                                                                                                              | [*PrepareForBackup*](vssgloss-p.md)  | Les préparatifs du writer permettent de déterminer si les fichiers doivent être sauvegardés, si l’enregistreur doit participer au gel des clichés instantanés, et de créer des métadonnées spécifiques au writer (consultez [**CVssWriter :: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup), [**CVssWriter :: IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected), [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent :: GetBackupOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupoptions), [**CVssWriter :: AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected), [**IVssComponent :: SetBackupMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupmetadata)et [**IVssComponent ::**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp)GetPreviousBackupStamp. |
| Le demandeur attend que les Writers soient configurés pour la sauvegarde à l’aide de [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync). Il doit également vérifier l’état de l’enregistreur (consultez [**IVssBackupComponents :: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents :: GetWriterStatus).**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)     | Aucune                                                                       | Aucune                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Le demandeur demande un cliché instantané à l’aide de [ **IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset)                                                                                                                                                                                                    | Aucune                                                                       | Aucune                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Aucune                                                                                                                                                                                                                                                                                                                        | [*PrepareForSnapshot*](vssgloss-p.md) | [**CVssWriter :: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot): Placez l’enregistreur dans un état prêt pour les clichés instantanés.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Aucun                                                                                                                                                                                                                                                                                                                        | [*Freeze*](vssgloss-f.md)                      | [**CVssWriter :: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze): installation finale avant le cliché instantané.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Aucun                                                                                                                                                                                                                                                                                                                        | [*Congelé*](vssgloss-t.md)                          | [**CVssWriter :: OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw): le fonctionnement normal (y compris les e/s) peut reprendre.<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Aucun                                                                                                                                                                                                                                                                                                                        | [*PostSnapshot*](vssgloss-p.md)          | [**CVssWriter :: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot): nettoyage final des préparatifs des clichés instantanés. Consultez [**IVssComponent :: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime) et [**IVssComponent :: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| Le demandeur attend la fin du cliché instantané à l’aide de : [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync), il doit également vérifier l’état de l’enregistreur (consultez [**IVssBackupComponents :: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents :: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus)<br/> | Aucune                                                                       | Aucune                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |



 

## <a name="requester-pre-backup-tasks"></a>Tâches de pré-sauvegarde du demandeur

En outre, avant de créer un événement [**IVssBackupComponents ::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , un demandeur peut également définir des options de sauvegarde pour des Writers individuels à l’aide de [**IVssBackupComponents :: SetBackupOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupoptions) en fonction des spécificités de chaque enregistreur et si un demandeur en est conscient.

Pour prendre en charge les opérations incrémentielles et différentielles, les demandeurs peuvent à ce stade choisir d’examiner les composants pour les horodatages d’une opération de sauvegarde antérieure (à l’aide de [**IVssComponent :: GetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getbackupstamp)) et d’utiliser ces informations pour définir un horodatage précédent pour un writer à traiter (à l’aide de [**IVssBackupComponents :: SetPreviousBackupStamp**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setpreviousbackupstamp)). Pour plus d’informations [, consultez sauvegardes incrémentielles et différentielles](incremental-and-differential-backups.md) .

Un demandeur peut désormais demander aux rédacteurs du système d’effectuer les préparatifs de pré-sauvegarde et de gérer la création d’un cliché instantané.

Tout d’abord, le demandeur génère un événement [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) en appelant [**IVssBackupComponents ::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup).

Une fois que tous les enregistreurs participants ont retourné la gestion de l’événement [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) (qu’un demandeur détermine à l’aide de l’instance de l’interface [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync) retournée par **PrepareForBackup**), le demandeur peut lancer le cliché instantané en appelant [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), qui, à mesure qu’il progresse, génère des événements [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*dégeler*](vssgloss-t.md)et [*PostSnapshot*](vssgloss-p.md) que les rédacteurs doivent gérer.

Dans certains cas, il se peut qu’un demandeur n’ait pas besoin de créer un cliché instantané. Plus précisément, chaque [*jeu de fichiers*](vssgloss-f.md) géré par l’un des composants d’un générateur donné possède un masque de sauvegarde de spécification de fichier (indiqué par une opération or au niveau du bit des valeurs de [**\_ \_ \_ \_ type de sauvegarde spec**](/windows/desktop/api/Vss/ne-vss-vss_file_spec_backup_type) ) défini lors de l’événement d' [*identification*](vssgloss-i.md) . Ce masque spécifie, entre autres choses, si un jeu de fichiers requiert un cliché instantané du système avant l’exécution de sa sauvegarde.

Si aucun jeu de fichiers à sauvegarder sur un volume ne requiert de cliché instantané, [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) n’a pas besoin d’être appelé.

## <a name="writer-pre-backup-tasks"></a>Tâches de pré-sauvegarde de l’enregistreur

Lors du traitement de l’événement [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , VSS appelle la méthode [**CVssWriter :: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) de chaque enregistreur, une méthode virtuelle qui, par défaut, retourne simplement true.

Les enregistreurs peuvent remplacer cette implémentation par défaut et utiliser la gestion pour rechercher des informations sur la sauvegarde à venir et agir.

Un enregistreur peut déterminer les informations relatives au type de l’opération de sauvegarde, en utilisant les méthodes suivantes :

1.  [**CVssWriter::GetBackupType**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-getbackuptype)
2.  [**CVssWriter::IsBootableStateBackedUp**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-isbootablesystemstatebackedup)
3.  [**CVssWriter::AreComponentsSelected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-arecomponentsselected)

Un enregistreur détermine si les fichiers qu’il gère sera impliqué dans le cliché instantané à l’aide de [**CVssWriter :: IsPathAffected**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispathaffected).

Plus important, lorsque VSS appelle la méthode [**CVssWriter :: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) , il passe dans une instance de l’interface [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents) , qui permet un accès direct via l’interface [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) à ceux de ses composants [*explicitement inclus*](vssgloss-e.md) dans le document des composants de sauvegarde du demandeur. Le writer a utilisé les instances de l’interface **IVssComponent** qui définissent les jeux de composants pour accéder à son composant *inclus implicitement* (voir la [sélectivité et l’utilisation des propriétés de composant](selectability-and-working-with-component-properties.md)).

Pendant la gestion de l’événement [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) , les enregistreurs utilisent l’interface [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) pour effectuer des opérations composant par composant (ou jeu de composants par jeu de composants), y compris :

1.  Ajout de [*fichiers partiels*](vssgloss-p.md) (si pris en charge) en appelant [**IVssComponent :: AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).
2.  Définition des métadonnées privées dont le writer aura besoin pour gérer la restauration.
3.  Si le writer prend en charge les sauvegardes incrémentielles et différentielles (consultez [sauvegardes incrémentielles et différentielles](incremental-and-differential-backups.md)), procédez comme suit :
    -   Vérification des horodatages de sauvegarde précédents en appelant [**IVssComponent :: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp).
    -   Ajout de tous les [*fichiers différenciés*](vssgloss-d.md) requis en appelant [**IVssComponent :: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime).
    -   Si le writer prend en charge le schéma **VSS \_ BS \_ horodaté** , ajoutez des chaînes de date et d’heure de sauvegarde dans le format de l’enregistreur à l’aide de [**IVssComponent :: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp).
4.  Lancement d’opérations asynchrones très longues, telles que la synchronisation de données sur plusieurs disques. Cela permet à l’enregistreur de continuer à fonctionner pendant le traitement de l’opération, y compris la gestion d’autres événements VSS. Ces opérations doivent se terminer avant l’événement [*Freeze*](vssgloss-f.md) .

L’appel du demandeur à [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) initie le cliché instantané et génère les événements suivants pour les rédacteurs à gérer :

-   [*PrepareForSnapshot*](vssgloss-p.md)
-   [*Freeze*](vssgloss-f.md)
-   [*Congelé*](vssgloss-t.md)
-   [*PostSnapshot*](vssgloss-p.md)

Trois des gestionnaires de l’enregistreur ([**CVssWriter :: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot), [**CVssWriter :: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze)et [**CVssWriter :: OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw)) sont des méthodes virtuelles pures, et chaque enregistreur doit les implémenter au lieu de s’appuyer sur les valeurs par défaut. En fonction des besoins d’un enregistreur, ils peuvent être codés en tant que méthodes factices, renvoyant simplement **true**.

Étant donné qu’il y a généralement une fenêtre temporelle étroite entre l’émission d’un événement [*Freeze*](vssgloss-f.md) et l’émission d’un événement de [*libération*](vssgloss-t.md) , la plupart des tâches majeures de préparation du cliché instantané, telles que l’arrêt des processus, la création de fichiers temporaires ou la vidange des files d’attente d’e/s, seraient gérées dans [**CVssWriter :: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot).

Comment un enregistreur peut utiliser [**CVssWriter :: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) pour gérer ses e/s avant que la création d’un cliché instantané dépende fortement de l’architecture de l’enregistreur.

Les writers qui peuvent se permettre de conserver toutes les écritures et de conserver les données dans un état cohérent avant le [*blocage*](vssgloss-f.md), doivent le faire.

Si l’enregistreur ne peut pas geler ses e/s, il doit prendre des mesures pour créer une source stable pour la sauvegarde et réduire le temps de récupération d’un cliché instantané. Par exemple, la mise en file d’attente des demandes d’e/s entrantes ou la génération d’un jeu de fichiers en double dans un [*autre chemin d’accès*](vssgloss-a.md) à utiliser comme source d’une sauvegarde.

La méthode [**CVssWriter :: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze) exécute des tâches simples et courtes, telles que la vérification de l’état correct des e/s à gauche de [**CVssWriter :: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) , et la fin de toutes les tâches asynchrones démarrées par [**CVssWriter :: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) . Cette méthode est la dernière chance d’un auteur de refuser un cliché instantané en cas de problème (voir [les erreurs et les refus d’écriture](writer-errors-and-vetoes.md)).

Il est généralement possible pour un enregistreur de reprendre l’opération normale à la suite d’un événement de [*libération*](vssgloss-t.md) : un cliché instantané peut ne pas être immédiatement prêt pour la sauvegarde après libération, mais un enregistreur doit pouvoir reprendre son fonctionnement normal. Par conséquent, en général, [**CVssWriter :: OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) est utilisé par les Writers pour revenir à un état de précongélation. Toutefois, tous les fichiers temporaires créés pour prendre en charge le cliché instantané doivent rester en place jusqu’à l’événement [*PostSnapshot*](vssgloss-p.md) . En général, vous utilisez [**CVssWriter :: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) pour ce type de nettoyage. Étant donné que de nombreuses applications n’ont pas besoin de ce type de nettoyage, **CVssWriter :: OnPostSnapshot** est une méthode virtuelle avec une implémentation par défaut qui retourne simplement **true**. Si une sauvegarde incrémentielle ou différentielle est en cours d’exécution, l’enregistreur peut appeler [**IVssComponent :: GetPreviousBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpreviousbackupstamp) et [**IVssComponent :: SetBackupStamp**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setbackupstamp). Pour plus d’informations, consultez [rôle de rédacteur dans sauvegarde de magasins complexes](writer-role-in-backing-up-complex-stores.md). [**IVssComponent :: AddDifferencedFilesByLastModifyTime**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddifferencedfilesbylastmodifytime)est une autre méthode qui peut être appelée à ce stade.

 

 




