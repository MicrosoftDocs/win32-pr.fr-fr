---
description: Il est parfois utile de sauvegarder et de restaurer uniquement des sections de fichiers. VSS fournit des mécanismes de fichiers partiels, qui, si les demandeurs le prennent en charge, permet aux rédacteurs de spécifier des sauvegardes de fichiers partielles et des restaurations.
ms.assetid: 02b74a4e-d69f-4eeb-866a-3399598b7035
title: Utilisation de fichiers partiels
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 7194f01df11f6c0e368941e17ef6ab1620b17f67
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "106517273"
---
# <a name="working-with-partial-files"></a><span data-ttu-id="b5a05-104">Utilisation de fichiers partiels</span><span class="sxs-lookup"><span data-stu-id="b5a05-104">Working with Partial Files</span></span>

<span data-ttu-id="b5a05-105">Il est parfois utile de sauvegarder et de restaurer uniquement des sections de fichiers.</span><span class="sxs-lookup"><span data-stu-id="b5a05-105">It is sometimes useful to back up and restore only sections of files.</span></span> <span data-ttu-id="b5a05-106">VSS fournit des mécanismes de [*fichiers partiels*](vssgloss-p.md) , qui, si les demandeurs le prennent en charge, permet aux rédacteurs de spécifier des sauvegardes de fichiers partielles et des restaurations.</span><span class="sxs-lookup"><span data-stu-id="b5a05-106">VSS provides [*partial file*](vssgloss-p.md) mechanisms, which, if requesters support it, allows writers to specify partial file backups and restores.</span></span>

<span data-ttu-id="b5a05-107">Les opérations de fichiers partielles sont souvent les plus utilisées pour les enregistreurs qui gèrent des fichiers très volumineux, mais uniquement une petite fraction de la modification entre les opérations de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="b5a05-107">Partial file operations are frequently of greatest use to writers that maintain very large files, only a small fraction of which change between backup operations.</span></span> <span data-ttu-id="b5a05-108">Dans ce cas, il est souvent utile de copier uniquement la section qui a changé sur le support de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="b5a05-108">This being the case, it is frequently useful to copy only that section that changed to backup media.</span></span> <span data-ttu-id="b5a05-109">Pour cette raison, les opérations de fichiers partielles sont généralement, mais pas exclusivement, utilisées pour prendre en charge les opérations de sauvegarde et de restauration incrémentielles.</span><span class="sxs-lookup"><span data-stu-id="b5a05-109">For this reason, partial file operations are typically, but not exclusively, used to support incremental backup and restore operations.</span></span>

<span data-ttu-id="b5a05-110">Si un writer souhaite implémenter une opération de fichier partielle, il utilise [**CVssWriter :: IsPartialFileSupportEnabled**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispartialfilesupportenabled) pour déterminer si le demandeur avec lequel il travaille prend en charge l’opération.</span><span class="sxs-lookup"><span data-stu-id="b5a05-110">If a writer wants to implement a partial file operation, it uses [**CVssWriter::IsPartialFileSupportEnabled**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-ispartialfilesupportenabled) to determine whether the requester it is working with supports the operation.</span></span>

<span data-ttu-id="b5a05-111">Si le demandeur prend en charge les opérations de fichiers partielles et, s’il ajoute le composant qui gère le fichier (ou le composant qui définit le jeu de composants qui contient le fichier) au document des composants de sauvegarde, un writer indique les sections du fichier à enregistrer (en général, lors de la gestion d’un événement [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) ou [*PostSnapshot*](vssgloss-p.md) ) en appelant [**IVssComponent :: AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span><span class="sxs-lookup"><span data-stu-id="b5a05-111">If the requester supports partial file operations, and if it adds the component that manages the file (or the component that defines the component set that contains the file) to the Backup Components Document, a writer indicates which sections of the file to save (typically while handling a [**PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) or [*PostSnapshot*](vssgloss-p.md) event) by calling [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span></span>

<span data-ttu-id="b5a05-112">En plus d’un chemin d’accès et d’un nom de fichier, l’enregistreur fournit les informations de métadonnées facultatives à [**IVssComponent :: AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span><span class="sxs-lookup"><span data-stu-id="b5a05-112">In addition to a path and file name, the writer supplies the range, optional metadata information to [**IVssComponent::AddPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-addpartialfile).</span></span>

<span data-ttu-id="b5a05-113">Les informations de plage sont fournies sous la forme d’une chaîne qui contient l’un des éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="b5a05-113">The range information is provided as a string that contains either of the following:</span></span>

-   <span data-ttu-id="b5a05-114">Paires d’offsets dans le fichier à sauvegarder (en octets) et longueur de la section à sauvegarder (en octets), le décalage et la longueur séparés par un signe deux-points, et chaque paire séparée par une virgule, par exemple \*Offset1 \***:**_length1_*_,_* \* Offset2 \***:**_length2_.</span><span class="sxs-lookup"><span data-stu-id="b5a05-114">Pairs of offsets into the file to be backed up (in bytes) and the length of the section to be backed up (in bytes), the offset and length being separated by a colon, and each pair separated by a comma, for example, *Offset1\***:**_Length1_*_,_\* \*Offset2\***:**_Length2_.</span></span>

    <span data-ttu-id="b5a05-115">Chaque valeur est un entier 64 bits (au format hexadécimal ou décimal) spécifiant respectivement un décalage d’octet et une longueur en octets.</span><span class="sxs-lookup"><span data-stu-id="b5a05-115">Each value is a 64-bit integer (in either hexadecimal or decimal format) specifying a byte offset and length in bytes, respectively.</span></span>

-   <span data-ttu-id="b5a05-116">Chemin d’accès complet, y compris le nom de fichier, sur le système actuel d’un fichier de plages binaires contenant les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="b5a05-116">The full path, including file name, on the current system of a binary ranges file containing the following:</span></span>
    -   <span data-ttu-id="b5a05-117">Nombre (exprimé sous la forme d’un entier 64 bits) des différentes plages de fichiers contenues dans le fichier</span><span class="sxs-lookup"><span data-stu-id="b5a05-117">The number (expressed as a 64-bit integer) of distinct file ranges contained in the file</span></span>
    -   <span data-ttu-id="b5a05-118">Chaque plage exprimée sous la forme d’une paire d’entiers 64 bits : le premier membre de la paire étant le décalage dans le fichier sauvegardé (en octets) et le deuxième membre étant la longueur des données à sauvegarder (en octets)</span><span class="sxs-lookup"><span data-stu-id="b5a05-118">Each range expressed as a pair of 64-bit integers: the first member of the pair being the offset into the file being backed up (in bytes), and the second member being the length of data to be backed up (in bytes)</span></span>

<span data-ttu-id="b5a05-119">Si un writer utilise un fichier de plages pour spécifier une opération de fichier partielle, un demandeur doit garantir que ce fichier est sauvegardé (même si le fichier ne fait pas nécessairement partie du jeu de sauvegarde par défaut) ou que les informations de plages sont conservées sur le support de sauvegarde d’une autre façon.</span><span class="sxs-lookup"><span data-stu-id="b5a05-119">If a writer uses a ranges file to specify a partial file operation, a requester must guarantee that either this file is backed up (even if the file is not necessarily part of the default backup set) or that the ranges information is preserved on the backup media in some other way.</span></span> <span data-ttu-id="b5a05-120">Si les informations du fichier de plages ne sont pas sauvegardées, il est impossible de restaurer le fichier partiellement sauvegardé.</span><span class="sxs-lookup"><span data-stu-id="b5a05-120">If the ranges file's information is not backed up, restoring the partially backed up file will be impossible.</span></span>

<span data-ttu-id="b5a05-121">Le writer peut également ajouter une chaîne contenant des métadonnées.</span><span class="sxs-lookup"><span data-stu-id="b5a05-121">The writer can also add a string containing metadata.</span></span> <span data-ttu-id="b5a05-122">Ces métadonnées peuvent être dans un format spécifique au writer, car elles sont destinées à permettre à l’enregistreur de valider toutes les restaurations ultérieures.</span><span class="sxs-lookup"><span data-stu-id="b5a05-122">This metadata can be in a writer-specific format because it is intended to allow the writer to validate any future restores.</span></span>

<span data-ttu-id="b5a05-123">Avec ces informations, un demandeur de support peut effectuer une sauvegarde de fichiers partielle.</span><span class="sxs-lookup"><span data-stu-id="b5a05-123">With this information, a supporting requester can perform a partial file backup.</span></span>

<span data-ttu-id="b5a05-124">Par exemple, imaginez un fichier volumineux dont l’en-tête (octets 64-512) contient un nombre d’enregistrements et d’autres informations fréquemment mises à jour, et dont les données les plus récentes doivent être recherchées dans les 65536 derniers octets du fichier, octets 0x1239E8577A à 0x1239E7577A.</span><span class="sxs-lookup"><span data-stu-id="b5a05-124">As an example, consider a large file whose header (bytes 64-512) contains a record count and other frequently updated information, and whose most recent data is to be found in the file's last 65536 bytes—bytes 0x1239E8577A to 0x1239E7577A.</span></span>

<span data-ttu-id="b5a05-125">Un enregistreur peut spécifier une liste de plages comme chaîne «**64:448, 0x1239E8577A : 65536**».</span><span class="sxs-lookup"><span data-stu-id="b5a05-125">A writer could specify a range list as the string "**64:448,0x1239E8577A:65536**."</span></span>

<span data-ttu-id="b5a05-126">Lors de la restauration, et avant l’exécution d’une opération de restauration, un demandeur doit vérifier si des fichiers nécessitent une prise en charge partielle des fichiers.</span><span class="sxs-lookup"><span data-stu-id="b5a05-126">On restore, and prior to actually performing a restore operation, a requester should check to see if any files require partial file support.</span></span>

<span data-ttu-id="b5a05-127">Pour ce faire, le demandeur itère d’abord sur les enregistreurs avec des composants stockés dans son document composants de sauvegarde à l’aide de [**IVssBackupComponents :: GetWriterComponentsCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) et [**IVssBackupComponents :: GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents).</span><span class="sxs-lookup"><span data-stu-id="b5a05-127">To do this, the requester first iterates over the writers with stored components in its Backup Components Document using [**IVssBackupComponents::GetWriterComponentsCount**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponentscount) and [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents).</span></span>

<span data-ttu-id="b5a05-128">L’interface [**IVssBackupComponents :: GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents) est ensuite utilisée pour retourner des instances de l’interface [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) , qui fournissent [**IVssWriterComponentsExt :: GetComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponent) et [**IVssWriterComponentsExt :: GetComponentCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponentcount), qui permettent au demandeur d’obtenir des instances [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) .</span><span class="sxs-lookup"><span data-stu-id="b5a05-128">The [**IVssBackupComponents::GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents) interface is then used to return instances of the [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) interface, which provide [**IVssWriterComponentsExt::GetComponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponent) and [**IVssWriterComponentsExt::GetComponentCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsswritercomponents-getcomponentcount), that allow the requester to obtain [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) instances.</span></span>

<span data-ttu-id="b5a05-129">Cela permet à un demandeur d’obtenir des informations sur les fichiers partiellement sauvegardés afin de participer à une restauration à l’aide de [**IVssComponent :: GetPartialFileCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfilecount) et de [**IVssComponent :: GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) pour l’instance de [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) correspondant au composant qui gère le fichier (ou le composant qui définit le jeu de composants qui contient le fichier).</span><span class="sxs-lookup"><span data-stu-id="b5a05-129">This allows a requester to obtain information about the partially backed up files to participate in a restore by using [**IVssComponent::GetPartialFileCount**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfilecount) and [**IVssComponent::GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) for the instance of [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) corresponding to the component that manages the file (or the component that defines the component set that contains the file).</span></span>

<span data-ttu-id="b5a05-130">Si l’opération de fichier partielle est contrôlée par un fichier de plages, ce fichier doit être restauré avant les données copiées sur le disque.</span><span class="sxs-lookup"><span data-stu-id="b5a05-130">If the partial file operation was controlled by a ranges file, that file should be restored prior to copied data back to disk.</span></span> <span data-ttu-id="b5a05-131">Cela peut se produire si le demandeur devait copier le fichier de plages vers un nouvel emplacement sur le disque.</span><span class="sxs-lookup"><span data-stu-id="b5a05-131">It may happen that the requester needed to copy the ranges file back to a new location on disk.</span></span> <span data-ttu-id="b5a05-132">Dans ce cas, elle indique qu’elle s’est exécutée par le biais de [**IVssBackupComponents :: SetRangesFilePath**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrangesfilepath).</span><span class="sxs-lookup"><span data-stu-id="b5a05-132">In this case, it indicates that it has done so through the [**IVssBackupComponents::SetRangesFilePath**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrangesfilepath).</span></span>

<span data-ttu-id="b5a05-133">Le demandeur poursuit ensuite la copie des données dans les emplacements appropriés dans la destination de restauration déjà sur le disque.</span><span class="sxs-lookup"><span data-stu-id="b5a05-133">The requester then proceeds to copy data into the appropriate locations in the restore destination already on disk.</span></span>

<span data-ttu-id="b5a05-134">Un enregistreur (lors de la gestion d’un événement [**postRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) ), en examinant [**IVssComponent :: GetFileRestoreStatus**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getfilerestorestatus) pour les fichiers indiqués par [**IVssComponent :: GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile), détermine si l’opération de fichier partielle a réussi.</span><span class="sxs-lookup"><span data-stu-id="b5a05-134">A writer (while handling a [**PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) event), by examining [**IVssComponent::GetFileRestoreStatus**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getfilerestorestatus) for the files indicated by [**IVssComponent::GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile), determines if the partial file operation was successful.</span></span> <span data-ttu-id="b5a05-135">L’enregistreur doit toujours essayer de vérifier l’exactitude de cette restauration à l’aide des informations de décalage et des métadonnées incluses dans le document des composants de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="b5a05-135">The writer should always attempt to verify the correctness of this restore using the offset information and any metadata included in the Backup Components Document.</span></span>

<span data-ttu-id="b5a05-136">Si le demandeur a dû restaurer le fichier de plages à un nouvel emplacement, VSS met à jour ces informations pour que le chemin d’accès retourné par [**IVssComponent :: GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) soit correct.</span><span class="sxs-lookup"><span data-stu-id="b5a05-136">If the requester has had to restore the ranges file to a new location, VSS will update this information so that the path returned by [**IVssComponent::GetPartialFile**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getpartialfile) is correct.</span></span>

 

 
