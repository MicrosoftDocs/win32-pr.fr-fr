---
description: Remarque Cette rubrique s’applique uniquement à Windows Server 2003 R2 et Windows Server 2003 avec Service Pack 1 (SP1).
ms.assetid: a192d9a7-1c65-4251-acb1-4df03ebfe910
title: Sauvegarde et restauration de l’état du système dans Windows Server 2003 R2 et Windows Server 2003 SP1
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: de2fdb50e3f719a5208c2894f5659f927bcc922d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "103952985"
---
# <a name="backing-up-and-restoring-system-state-in-windows-server-2003-r2-and-windows-server-2003-sp1"></a><span data-ttu-id="43a48-103">Sauvegarde et restauration de l’état du système dans Windows Server 2003 R2 et Windows Server 2003 SP1</span><span class="sxs-lookup"><span data-stu-id="43a48-103">Backing Up and Restoring System State in Windows Server 2003 R2 and Windows Server 2003 SP1</span></span>

> [!Note]  
> <span data-ttu-id="43a48-104">Cette rubrique s’applique uniquement à Windows Server 2003 R2 et Windows Server 2003 avec Service Pack 1 (SP1).</span><span class="sxs-lookup"><span data-stu-id="43a48-104">This topic only applies to Windows Server 2003 R2 and Windows Server 2003 with Service Pack 1 (SP1).</span></span> <span data-ttu-id="43a48-105">Pour plus d’informations sur les autres versions de système d’exploitation, consultez [sauvegarde et restauration de l’état du système](locating-additional-system-files.md).</span><span class="sxs-lookup"><span data-stu-id="43a48-105">For information about other operating system versions, see [Backing Up and Restoring System State](locating-additional-system-files.md).</span></span>

 

> [!Note]  
> <span data-ttu-id="43a48-106">Microsoft ne fournit pas de support technique pour les développeurs ou les professionnels de l’informatique pour l’implémentation de restaurations en ligne sur l’état du système sur Windows (toutes les versions).</span><span class="sxs-lookup"><span data-stu-id="43a48-106">Microsoft does not provide developer or IT professional technical support for implementing online system state restores on Windows (all releases).</span></span> <span data-ttu-id="43a48-107">Pour plus d’informations sur l’utilisation des API et des procédures fournies par Microsoft pour implémenter des restaurations en ligne de l’état du système, consultez les ressources de la communauté disponibles dans le [Centre de communauté MSDN](https://msdn.microsoft.com/community/default.aspx).</span><span class="sxs-lookup"><span data-stu-id="43a48-107">For information about using Microsoft-provided APIs and procedures to implement online system state restores, see the community resources available at the [MSDN Community Center](https://msdn.microsoft.com/community/default.aspx).</span></span>

 

<span data-ttu-id="43a48-108">Lorsque vous effectuez une sauvegarde ou une restauration VSS, l’état du système Windows est défini comme étant une collection de plusieurs éléments clés du système d’exploitation et de leurs fichiers.</span><span class="sxs-lookup"><span data-stu-id="43a48-108">When performing a VSS backup or restore, the Windows system state is defined as being a collection of several key operating system elements and their files.</span></span> <span data-ttu-id="43a48-109">Ces éléments doivent toujours être traités par les opérations de sauvegarde et de restauration en tant qu’unité.</span><span class="sxs-lookup"><span data-stu-id="43a48-109">These elements should always be treated by backup and restore operations as a unit.</span></span>

<span data-ttu-id="43a48-110">Dans Windows Server 2003 R2 et Windows Server 2003 avec SP1, il n’existe aucune API Windows conçue pour traiter ces objets comme un seul. il est donc recommandé que les demandeurs aient leur propre objet d’État du système afin qu’ils puissent traiter ces composants de manière cohérente.</span><span class="sxs-lookup"><span data-stu-id="43a48-110">In Windows Server 2003 R2 and Windows Server 2003 with SP1, there is no Windows API designed to treat these objects as one, so it is recommended that requesters have their own system state object so that they can process these components in a consistent manner.</span></span>

<span data-ttu-id="43a48-111">Étant donné que le service VSS s’exécute sur les versions de Windows où la protection des fichiers [*système*](vssgloss-s.md) (WFP) protège les fichiers d’État du système contre toute altération, des étapes spéciales sont nécessaires pour sauvegarder et restaurer l’état du système.</span><span class="sxs-lookup"><span data-stu-id="43a48-111">Because VSS runs on versions of Windows where [*System File Protection*](vssgloss-s.md) (WFP) protects system state files from corruption, special steps are needed to back up and restore system state.</span></span>

<span data-ttu-id="43a48-112">L’état du système se compose des éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="43a48-112">System state consists of the following:</span></span>

-   <span data-ttu-id="43a48-113">Tous les fichiers protégés par WFP, fichiers de démarrage, y compris NTLDR, Ntdetect et configurations des compteurs de performances</span><span class="sxs-lookup"><span data-stu-id="43a48-113">All files protected by WFP, boot files including ntldr, ntdetect, and performance counter configurations</span></span>
-   <span data-ttu-id="43a48-114">Le Active Directory (ADSI) (sur les systèmes qui sont des contrôleurs de domaine)</span><span class="sxs-lookup"><span data-stu-id="43a48-114">The Active Directory (ADSI) (on systems that are domain controllers)</span></span>
-   <span data-ttu-id="43a48-115">Le dossier de volume système (SYSVOL) qui est répliqué par le service de réplication de fichiers (FRS) (sur les systèmes qui sont des contrôleurs de domaine)</span><span class="sxs-lookup"><span data-stu-id="43a48-115">The System Volume Folder (SYSVOL) that is replicated by the File Replication Service (FRS) (on systems that are domain controllers)</span></span>
-   <span data-ttu-id="43a48-116">Serveur de certificats (sur les systèmes qui fournissent l’autorité de certification)</span><span class="sxs-lookup"><span data-stu-id="43a48-116">Certificate server (on systems that provide Certification Authority)</span></span>
-   <span data-ttu-id="43a48-117">Base de données de cluster (sur les systèmes qui sont un nœud d’un cluster Windows)</span><span class="sxs-lookup"><span data-stu-id="43a48-117">Cluster database (on systems that are a node of a Windows cluster)</span></span>
-   <span data-ttu-id="43a48-118">Service de registre</span><span class="sxs-lookup"><span data-stu-id="43a48-118">Registry service</span></span>
-   <span data-ttu-id="43a48-119">Base de données d’inscription de classe COM+</span><span class="sxs-lookup"><span data-stu-id="43a48-119">COM+ class registration database</span></span>

<span data-ttu-id="43a48-120">L’état du système peut être sauvegardé dans n’importe quel ordre.</span><span class="sxs-lookup"><span data-stu-id="43a48-120">The system state can be backed up in any order.</span></span>

<span data-ttu-id="43a48-121">Toutefois, la restauration de l’état du système doit remplacer d’abord les fichiers de démarrage et valider la section système (Hive) du Registre comme dernière étape du processus, et peut se produire dans l’ordre suivant :</span><span class="sxs-lookup"><span data-stu-id="43a48-121">However, the restoration of the system state should replace boot files first and commit the system section (hive) of the registry as a final step in the process, and might occur in the following order:</span></span>

1.  <span data-ttu-id="43a48-122">Restaurez les fichiers de démarrage.</span><span class="sxs-lookup"><span data-stu-id="43a48-122">Restore the boot files.</span></span>
2.  <span data-ttu-id="43a48-123">Base de données d’inscription de classe COM+</span><span class="sxs-lookup"><span data-stu-id="43a48-123">COM+ class registration database</span></span>
3.  <span data-ttu-id="43a48-124">Restaurez les bases de données SYSVOL, du serveur de certificats et du cluster (si nécessaire).</span><span class="sxs-lookup"><span data-stu-id="43a48-124">Restore SYSVOL, Certificate Server, and Cluster databases (if needed).</span></span>
4.  <span data-ttu-id="43a48-125">Restaurez les Active Directory (si nécessaire).</span><span class="sxs-lookup"><span data-stu-id="43a48-125">Restore Active Directory (if needed).</span></span>
5.  <span data-ttu-id="43a48-126">Restaurez le registre.</span><span class="sxs-lookup"><span data-stu-id="43a48-126">Restore the registry.</span></span>

<span data-ttu-id="43a48-127">Certains services système, tels que l’autorité de certification, comportent des enregistreurs VSS conventionnels et suivent les algorithmes de sauvegarde et de restauration VSS.</span><span class="sxs-lookup"><span data-stu-id="43a48-127">Some system services, such as the Certification Authority, have conventional VSS writers and follow the VSS backup and restore algorithms.</span></span> <span data-ttu-id="43a48-128">D’autres, telles que le registre, nécessitent des opérations de sauvegarde ou de restauration personnalisées ; Pour plus d’informations, consultez [sauvegardes et restaurations personnalisées](custom-backups-and-restores.md).</span><span class="sxs-lookup"><span data-stu-id="43a48-128">Others, such as the registry, require custom backup or restore operations; for more information, see [Custom Backups and Restores](custom-backups-and-restores.md).</span></span>

## <a name="vss-backup-and-restores-of-boot-and-system-files"></a><span data-ttu-id="43a48-129">Sauvegarde et restauration VSS des fichiers système et de démarrage</span><span class="sxs-lookup"><span data-stu-id="43a48-129">VSS Backup and Restores of Boot and System Files</span></span>

<span data-ttu-id="43a48-130">Les fichiers système et de démarrage doivent être sauvegardés et restaurés uniquement en tant qu’entité unique.</span><span class="sxs-lookup"><span data-stu-id="43a48-130">The boot and system files should be backed up and restored only as a single entity.</span></span>

<span data-ttu-id="43a48-131">Un demandeur peut utiliser en toute sécurité des versions cliché instantané de ces fichiers et s’assurer que le volume système et le périphérique de démarrage sont des [*clichés instantanés*](vssgloss-s.md).</span><span class="sxs-lookup"><span data-stu-id="43a48-131">A requester can safely use shadow-copied versions of these files, and should be sure that the system volume and boot device are [*shadow copied*](vssgloss-s.md).</span></span>

<span data-ttu-id="43a48-132">Les fichiers système et de démarrage sont les suivants :</span><span class="sxs-lookup"><span data-stu-id="43a48-132">The system and boot files include:</span></span>

-   <span data-ttu-id="43a48-133">Les principaux fichiers de démarrage :</span><span class="sxs-lookup"><span data-stu-id="43a48-133">The core boot files:</span></span> <dl> <span data-ttu-id="43a48-134">NtLdr.exe</span><span class="sxs-lookup"><span data-stu-id="43a48-134">NtLdr.exe</span></span>  
    <span data-ttu-id="43a48-135">Boot.ini</span><span class="sxs-lookup"><span data-stu-id="43a48-135">Boot.ini</span></span>  
    <span data-ttu-id="43a48-136">NtDetect.com</span><span class="sxs-lookup"><span data-stu-id="43a48-136">NtDetect.com</span></span>  
    <span data-ttu-id="43a48-137">NtBootDD.sys (le cas échéant)</span><span class="sxs-lookup"><span data-stu-id="43a48-137">NtBootDD.sys (if present)</span></span>  
    </dl>
-   The WFP service catalog file must be backed up prior to backing up the WFP files, and it is found under: <dl> <span data-ttu-id="43a48-138">% SystemRoot% \\ system32 \\ CatRoot \\ {F750E6C3-38EE-11D1-85E5-00C04FC295EE}</span><span class="sxs-lookup"><span data-stu-id="43a48-138">%SystemRoot%\\System32\\CatRoot\\{F750E6C3-38EE-11D1-85E5-00C04FC295EE}</span></span> </dl><span data-ttu-id="43a48-139">
-   Tous les fichiers protégés par la protection des fichiers [\*système*](vssgloss-s.md) et énumérés par [\*\*SfcGetNextProtectedFile**](/windows/win32/api/sfc/nf-sfc-sfcgetnextprotectedfile) (voir opérations de restauration VSS des fichiers protégés par WFP) -   les fichiers de configuration du compteur de performances :</span><span class="sxs-lookup"><span data-stu-id="43a48-139">
-   All files protected by [\*System File Protection*](vssgloss-s.md) and enumerated by [\*\*SfcGetNextProtectedFile**](/windows/win32/api/sfc/nf-sfc-sfcgetnextprotectedfile) (see VSS Restore Operations of WFP Protected Files) -   The Performance Counter Configuration files:</span></span> <dl> <span data-ttu-id="43a48-140">% SystemRoot% \\ system32 \\ perf ? 00 ?. anciens</span><span class="sxs-lookup"><span data-stu-id="43a48-140">%SystemRoot%\\System32\\Perf?00?.dat</span></span>  
    <span data-ttu-id="43a48-141">% SystemRoot% \\ system32 \\ perf ? 00 ?. bak</span><span class="sxs-lookup"><span data-stu-id="43a48-141">%SystemRoot%\\System32\\Perf?00?.bak</span></span> </dl><span data-ttu-id="43a48-142">
-   Le cas échéant, le fichier de métabase Internet Information Server (IIS) doit être inclus dans les opérations de sauvegarde et de restauration, car il contient l’État utilisé par Microsoft Exchange et d’autres applications réseau.</span><span class="sxs-lookup"><span data-stu-id="43a48-142">
-   If present, the Internet Information Server (IIS) metabase file should be included in backup and restore operations because it contains state that is used by Microsoft Exchange and other network applications.</span></span> <span data-ttu-id="43a48-143">Ce fichier se trouve à l'emplacement suivant :</span><span class="sxs-lookup"><span data-stu-id="43a48-143">This file can be found at:</span></span> <dl> <span data-ttu-id="43a48-144">% SystemRoot% \\ system32 \\ inetsrv \\ Metabase. bin</span><span class="sxs-lookup"><span data-stu-id="43a48-144">%SystemRoot%\\System32\\InetSrv\\Metabase.bin</span></span> </dl><span data-ttu-id="43a48-145">
-   Si le fichier de la métabase IIS est sauvegardé, les clés pour permettre aux applications de lire certaines entrées chiffrées doivent être restaurées dans le cadre de l’état du système.</span><span class="sxs-lookup"><span data-stu-id="43a48-145">
-   If the IIS metabase file is backed up, keys to enable applications to read certain encrypted entries should be restored as part of the system state.</span></span> <span data-ttu-id="43a48-146">Les fichiers se trouvent sous :</span><span class="sxs-lookup"><span data-stu-id="43a48-146">The files can be found under:</span></span> <dl> <span data-ttu-id="43a48-147">% SystemRoot% \\ system32 \\ Microsoft \\ Protect\\\*</span><span class="sxs-lookup"><span data-stu-id="43a48-147">%SystemRoot%\\System32\\Microsoft\\Protect\\\*</span></span>  
    <span data-ttu-id="43a48-148">% AllUsersProfile% \\ Microsoft \\ crypto \\ RSA \\ MachineKeys\\\*</span><span class="sxs-lookup"><span data-stu-id="43a48-148">%AllUsersProfile%\\Microsoft\\Crypto\\RSA\\MachineKeys\\\*</span></span> </dl><span data-ttu-id="43a48-149">
-Lors de la sauvegarde des fichiers système et de démarrage, il peut s’avérer nécessaire de déterminer le périphérique de démarrage DOS en procédant comme suit : 1. recherchez la partition système sous \*\*HKEY \_ local \_ machine*\* \\ \*\*System*\* \\ \*\*Setup*\* \\ \*\*SystemPartition\**.</span><span class="sxs-lookup"><span data-stu-id="43a48-149">
-   When backing up boot and system files, it may become necessary to determine the DOS boot device by doing the following: 1.  Find the system partition under \*\*HKEY\_LOCAL\_MACHINE\*\*\\*\*System\*\*\\*\*Setup\*\*\\*\*SystemPartition\**.</span></span>
    <span data-ttu-id="43a48-150">2.  Passer la variable d’environnement racine système (% SystemRoot%) au gestionnaire de montage pour obtenir le nom de l’appareil NT.</span><span class="sxs-lookup"><span data-stu-id="43a48-150">2.  Pass the System Root environment variable (%SystemRoot%) to the mount manager to obtain the NT device name.</span></span>

## <a name="vss-restore-operations-of-wfp-protected-files"></a><span data-ttu-id="43a48-151">Opérations de restauration VSS des fichiers protégés par WFP</span><span class="sxs-lookup"><span data-stu-id="43a48-151">VSS Restore Operations of WFP Protected Files</span></span>

<span data-ttu-id="43a48-152">Le service WFP est conçu pour empêcher le remplacement accidentel ou fragmentaire des fichiers système.</span><span class="sxs-lookup"><span data-stu-id="43a48-152">The WFP service is designed to prevent accidental or piecemeal replacement of system files.</span></span> <span data-ttu-id="43a48-153">Par conséquent, des étapes spéciales doivent être effectuées pour restaurer les données WFP.</span><span class="sxs-lookup"><span data-stu-id="43a48-153">Therefore, special steps need to be undertaken to restore WFP data.</span></span>

<span data-ttu-id="43a48-154">Signifie que l’enregistreur WFP doit spécifier la méthode **VSS \_ RME \_ Restore \_ au \_ redémarrage de** la restauration lors de la définition de son document de métadonnées d’écriture.</span><span class="sxs-lookup"><span data-stu-id="43a48-154">The means the WFP writer should specify the **VSS\_RME\_RESTORE\_AT\_REBOOT** restore method when defining its Writer Metadata Document.</span></span> <span data-ttu-id="43a48-155">Si un demandeur détermine que le scripteur WFP n’a pas pu spécifier cette méthode de restauration, il indique une erreur de writer.</span><span class="sxs-lookup"><span data-stu-id="43a48-155">If a requester determines that the WFP writer has failed to specify this restore method, it indicates a writer error.</span></span>

<span data-ttu-id="43a48-156">Un demandeur doit implémenter une méthode de restauration de la **\_ restauration VSS RME \_ \_ au \_ redémarrage** à l’aide de la fonction Win32 [**MoveFileEx**](/windows/win32/api/winbase/nf-winbase-movefileexa) avec le **délai MOVEFILE jusqu’au paramètre \_ \_ \_ reboot** pour remplacer les fichiers système.</span><span class="sxs-lookup"><span data-stu-id="43a48-156">A requester should implement a restore method of **VSS\_RME\_RESTORE\_AT\_REBOOT** using the Win32 function [**MoveFileEx**](/windows/win32/api/winbase/nf-winbase-movefileexa) with the **MOVEFILE\_DELAY\_UNTIL\_REBOOT** parameter to replace system files.</span></span> <span data-ttu-id="43a48-157">Les fichiers restaurés ne sont pas copiés dans les répertoires de fichiers système réels tant que le système n’a pas redémarré.</span><span class="sxs-lookup"><span data-stu-id="43a48-157">The restored files are not copied into the actual system file directories until after system reboot.</span></span> <span data-ttu-id="43a48-158">Le remplacement des fichiers système protégés se produit uniquement si la valeur de l’entrée de Registre **reg \_ Word** suivante est définie sur 1 :</span><span class="sxs-lookup"><span data-stu-id="43a48-158">The overwriting of protected system files will occur only if the value of the following **REG\_WORD** registry entry is set to 1:</span></span>

<span data-ttu-id="43a48-159">**HKEY \_ \_** Gestionnaire de session du contrôle CurrentControlSet du système de l’ordinateur local \\  \\  \\  \\  \\ **AllowProtectedRenames** = 1</span><span class="sxs-lookup"><span data-stu-id="43a48-159">**HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Control**\\**Session Manager**\\**AllowProtectedRenames** = 1</span></span>

<span data-ttu-id="43a48-160">Cette valeur doit être définie avant tout démarrage où les fichiers protégés doivent être remplacés par [**MoveFileEx**](/windows/win32/api/winbase/nf-winbase-movefileexa) et sont supprimés après le redémarrage.</span><span class="sxs-lookup"><span data-stu-id="43a48-160">This value must be set before any boot where protected files are to be replaced via [**MoveFileEx**](/windows/win32/api/winbase/nf-winbase-movefileexa) and is deleted after reboot.</span></span>

<span data-ttu-id="43a48-161">Le répertoire système dllcache doit également être sauvegardé ou restauré, avec la sauvegarde et la restauration du volume de démarrage, et se trouve en examinant l’entrée de Registre **reg \_ expand \_ SZ** :</span><span class="sxs-lookup"><span data-stu-id="43a48-161">The system dllcache directory should also be backed up or restored, with boot volume backup and restore, and is located by examining the **REG\_EXPAND\_SZ** registry entry:</span></span>

<span data-ttu-id="43a48-162">**HKEY \_ Logiciel de l' \_ ordinateur local** \\  \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **Winlogon** \\ **SfcDllCache**</span><span class="sxs-lookup"><span data-stu-id="43a48-162">**HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**WinLogon**\\**SfcDllCache**</span></span><dl> <dt>

                  Data type
</dt> <dd>                  <span data-ttu-id="43a48-163">REG \_ développer \_ SZ</span><span class="sxs-lookup"><span data-stu-id="43a48-163">REG\_EXPAND\_SZ</span></span></dd> </dl>

<span data-ttu-id="43a48-164">Le contenu du répertoire System dllcache est reconstruit à l’aide de l’outil de vérification des fichiers système (SFC) à partir de l’invite de commandes :</span><span class="sxs-lookup"><span data-stu-id="43a48-164">The contents of the system dllcache directory are rebuilt by using the System File Checker (SFC) from the command prompt:</span></span>

-   <span data-ttu-id="43a48-165">L’option **/scanonce** analyse tous les fichiers protégés au prochain démarrage du système.</span><span class="sxs-lookup"><span data-stu-id="43a48-165">The **/SCANONCE** option scans all protected files at the next system boot.</span></span>
-   <span data-ttu-id="43a48-166">L’option **/scannow** analyse immédiatement tous les fichiers protégés.</span><span class="sxs-lookup"><span data-stu-id="43a48-166">The **/SCANNOW** option scans all protected files immediately.</span></span>

<span data-ttu-id="43a48-167">Tous les fichiers protégés sont analysés, et toutes les versions qui ne sont pas valides seront remplacées à la fois dans le répertoire et dans l’emplacement dllcache.</span><span class="sxs-lookup"><span data-stu-id="43a48-167">All protected files will be scanned, and any versions that are not valid will be replaced in both the directory and dllcache location.</span></span>

<span data-ttu-id="43a48-168">Il y a quatre fichiers qui font partie de la plateforme WFP qui ne peuvent pas être restaurés avec les fichiers WFP :</span><span class="sxs-lookup"><span data-stu-id="43a48-168">There are four files that are part of the WFP that cannot be restored with the WFP files:</span></span>

<dl> <span data-ttu-id="43a48-169">Ctl3dv2.dll</span><span class="sxs-lookup"><span data-stu-id="43a48-169">Ctl3dv2.dll</span></span>  
<span data-ttu-id="43a48-170">DtcSetup.exe</span><span class="sxs-lookup"><span data-stu-id="43a48-170">DtcSetup.exe</span></span>  
<span data-ttu-id="43a48-171">NtDll.dll</span><span class="sxs-lookup"><span data-stu-id="43a48-171">NtDll.dll</span></span>  
<span data-ttu-id="43a48-172">Smss.exe</span><span class="sxs-lookup"><span data-stu-id="43a48-172">Smss.exe</span></span>  
</dl>

<span data-ttu-id="43a48-173">Ces fichiers facilitent le processus de restauration des fichiers WFP et, par conséquent, une dépendance circulaire.</span><span class="sxs-lookup"><span data-stu-id="43a48-173">These files help in the process of restoring the WFP files and as such there is a circular dependency.</span></span> <span data-ttu-id="43a48-174">Actuellement, il n’existe aucun moyen de restaurer ces fichiers, sauf pour réinstaller Windows.</span><span class="sxs-lookup"><span data-stu-id="43a48-174">Currently, there is no way to restore these files except to reinstall Windows.</span></span>

 

 
