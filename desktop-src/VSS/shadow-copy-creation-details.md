---
description: En général, la création d’un cliché instantané dépend du type de cliché instantané à créer, de son contexte et du rôle accordé aux rédacteurs dans l’opération de cliché instantané.
ms.assetid: eab3b39b-dfa7-43ea-adba-cd0b495c373f
title: Détails de la création de clichés instantanés
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8b9281b899593ca0751f1d549aed60305041b18c
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "106519854"
---
# <a name="shadow-copy-creation-details"></a><span data-ttu-id="5776a-103">Détails de la création de clichés instantanés</span><span class="sxs-lookup"><span data-stu-id="5776a-103">Shadow Copy Creation Details</span></span>

<span data-ttu-id="5776a-104">En général, la création d’un cliché instantané dépend du type de cliché instantané à créer, de son contexte et du rôle accordé aux rédacteurs dans l’opération de cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="5776a-104">In general, how a shadow copy is created depends on the type of shadow copy to be created, its context, and the role accorded to writers in the shadow copy operation.</span></span> <span data-ttu-id="5776a-105">(Pour plus d’informations, consultez [configurations du contexte de cliché instantané](shadow-copy-context-configurations.md) .)</span><span class="sxs-lookup"><span data-stu-id="5776a-105">(See [Shadow Copy Context Configurations](shadow-copy-context-configurations.md) for more information.)</span></span>

<span data-ttu-id="5776a-106">Le contexte de cliché instantané est défini en appelant la méthode [**IVssBackupComponents :: SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) .</span><span class="sxs-lookup"><span data-stu-id="5776a-106">The shadow copy context is set by calling the [**IVssBackupComponents::SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) method.</span></span> <span data-ttu-id="5776a-107">Avant d’appeler la méthode [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) pour créer un cliché instantané, les demandeurs doivent appeler les méthodes [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) dans l’ordre spécifié dans les sections suivantes.</span><span class="sxs-lookup"><span data-stu-id="5776a-107">Before calling the [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) method to create a shadow copy, requesters must call the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) methods in the order specified in the following sections.</span></span>

## <a name="prerequisites-for-all-shadow-copies"></a><span data-ttu-id="5776a-108">Conditions préalables pour tous les clichés instantanés</span><span class="sxs-lookup"><span data-stu-id="5776a-108">Prerequisites for All Shadow Copies</span></span>

<span data-ttu-id="5776a-109">Quel que soit le niveau de participation du writer, la création d’un cliché instantané requiert toujours l’initialisation du demandeur avec les appels à [**IVssBackupComponents :: InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) et [**IVssBackupComponents :: StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span><span class="sxs-lookup"><span data-stu-id="5776a-109">Regardless of the level of writer participation, the creation of any shadow copy will always require the requestor be initialized with calls to [**IVssBackupComponents::InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) and [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset).</span></span>

<span data-ttu-id="5776a-110">Si cet appel n’est pas effectué, la méthode [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) renvoie une erreur.</span><span class="sxs-lookup"><span data-stu-id="5776a-110">If this call is not made, the [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) method will return an error.</span></span>

## <a name="shadow-copies-with-writer-participation"></a><span data-ttu-id="5776a-111">Clichés instantanés avec participation au rédacteur</span><span class="sxs-lookup"><span data-stu-id="5776a-111">Shadow Copies with Writer Participation</span></span>

<span data-ttu-id="5776a-112">Si le contexte de cliché instantané spécifie la participation de l’enregistreur (c’est-à-dire que [**IVssBackupComponents :: SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) est appelé avec la **\_ \_ sauvegarde VSS CTX**, ou la restauration de l' **\_ \_ application \_ VSS CTX**) :</span><span class="sxs-lookup"><span data-stu-id="5776a-112">If the shadow copy context specifies writer participation (that is, [**IVssBackupComponents::SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) is called with **VSS\_CTX\_BACKUP**, or **VSS\_CTX\_APP\_ROLLBACK**):</span></span>

-   <span data-ttu-id="5776a-113">Les demandeurs doivent toujours appeler [**IVssBackupComponents :: GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) lorsque le contexte de cliché instantané prend en charge la participation de l’enregistreur.</span><span class="sxs-lookup"><span data-stu-id="5776a-113">Requesters must always call [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) when the shadow copy context supports writer participation.</span></span> <span data-ttu-id="5776a-114">Si le contexte de cliché instantané prend en charge la participation de l’enregistreur et **IVssBackupComponents :: GatherWriterMetadata** n’est pas appelé avant [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), une erreur est retournée.</span><span class="sxs-lookup"><span data-stu-id="5776a-114">If the shadow copy context supports writer participation and **IVssBackupComponents::GatherWriterMetadata** is not called prior to [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset), an error will be returned.</span></span>
-   <span data-ttu-id="5776a-115">Si un demandeur souhaite sélectionner des composants d’enregistreur spécifiques, il doit appeler [**IVssBackupComponents :: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) avant d’appeler [**StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) pour créer le jeu de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="5776a-115">If a requester wants to select specific writer components, it must call [**IVssBackupComponents::AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) before calling [**StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) to create the shadow copy set.</span></span>
-   <span data-ttu-id="5776a-116">[**StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) doit être appelé pour créer le jeu de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="5776a-116">[**StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) must be called to create the shadow copy set.</span></span>
-   <span data-ttu-id="5776a-117">Les demandeurs peuvent ajouter un ou plusieurs volumes au jeu de clichés instantanés en appelant [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span><span class="sxs-lookup"><span data-stu-id="5776a-117">Requesters may add one or more volumes to the shadow copy set by calling [**AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset).</span></span> <span data-ttu-id="5776a-118">Certains composants de l’enregistreur peuvent ne pas spécifier de volumes affectés.</span><span class="sxs-lookup"><span data-stu-id="5776a-118">Some writer components may not specify any affected volumes.</span></span> <span data-ttu-id="5776a-119">Dans ce cas, il est acceptable qu’un instantané soit vide (c’est-à-dire qu’il ne contienne aucun volume).</span><span class="sxs-lookup"><span data-stu-id="5776a-119">In this case, it is acceptable for a snapshot set to be empty (that is, to contain no volumes).</span></span>
-   <span data-ttu-id="5776a-120">Pour garantir la cohérence des métadonnées de l’enregistreur, un demandeur doit toujours appeler [**IVssBackupComponents ::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) même si aucun composant n’est sélectionné.</span><span class="sxs-lookup"><span data-stu-id="5776a-120">To guarantee the consistency of writer metadata, a requester should always call [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) even if no components are selected.</span></span> <span data-ttu-id="5776a-121">VSS génère alors un événement **PrepareForBackup** , dans lequel VSS appelle la méthode [**CVssWriter :: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) pour chaque rédacteur participant.</span><span class="sxs-lookup"><span data-stu-id="5776a-121">This causes VSS to generate a **PrepareForBackup** event, in which VSS calls the [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method for each participating writer.</span></span>
-   <span data-ttu-id="5776a-122">VSS génère [*PrepareForSnapshot*](vssgloss-p.md) et [*fige*](vssgloss-f.md) les événements avant de créer le cliché instantané en réponse à [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset).</span><span class="sxs-lookup"><span data-stu-id="5776a-122">VSS will generate [*PrepareForSnapshot*](vssgloss-p.md) and [*Freeze*](vssgloss-f.md) events before creating the shadow copy in response to [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset).</span></span> <span data-ttu-id="5776a-123">Les enregistreurs vont gérer les événements avec [**CVssWriter :: OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) et [**CVssWriter :: OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze).</span><span class="sxs-lookup"><span data-stu-id="5776a-123">Writers will handle the events with [**CVssWriter::OnPrepareSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparesnapshot) and [**CVssWriter::OnFreeze**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onfreeze).</span></span>
-   <span data-ttu-id="5776a-124">VSS génère des événements de [*libération*](vssgloss-t.md) et des événements [*PostSnapshot*](vssgloss-p.md) après la création d’un cliché instantané en réponse à [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset).</span><span class="sxs-lookup"><span data-stu-id="5776a-124">VSS will generate [*Thaw*](vssgloss-t.md) events and [*PostSnapshot*](vssgloss-p.md) events after creating a shadow copy in response to [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset).</span></span> <span data-ttu-id="5776a-125">Les enregistreurs vont gérer les événements avec [**CVssWriter :: OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) et [**CVssWriter :: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot).</span><span class="sxs-lookup"><span data-stu-id="5776a-125">Writers will handle the events with [**CVssWriter::OnThaw**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onthaw) and [**CVssWriter::OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot).</span></span>

## <a name="shadow-copies-without-writer-participation"></a><span data-ttu-id="5776a-126">Clichés instantanés sans participation au rédacteur</span><span class="sxs-lookup"><span data-stu-id="5776a-126">Shadow Copies without Writer Participation</span></span>

<span data-ttu-id="5776a-127">La création de clichés instantanés sans participation à l’écriture est déconseillée pour les applications de sauvegarde standard (voir [sauvegardes sans participation](backups-without-writer-participation.md)de l’enregistreur).</span><span class="sxs-lookup"><span data-stu-id="5776a-127">Creating shadow copies without writer participation is discouraged for standard backup applications (see [Backups without Writer Participation](backups-without-writer-participation.md)).</span></span>

<span data-ttu-id="5776a-128">Il existe des utilisations, telles que des sauvegardes rapides d’un disque, pour fournir un filet de sécurité contre les dommages accidentels de fichiers, ce qui peut être effectué sans participation explicite du writer.</span><span class="sxs-lookup"><span data-stu-id="5776a-128">There are uses, such as fast backups of a disk to provide a safety net against accidental file corruption, which can be conducted without explicit writer participation.</span></span> <span data-ttu-id="5776a-129">Ce cliché instantané aurait un contexte de **sauvegarde de partage de \_ \_ fichiers CTX \_ \_ VSS** ou de **\_ \_ \_ restauration du NAS CTX VSS**.</span><span class="sxs-lookup"><span data-stu-id="5776a-129">Such a shadow copy would have a context of either **VSS\_CTX\_FILE\_SHARE\_BACKUP** or **VSS\_CTX\_NAS\_ROLLBACK**.</span></span>

<span data-ttu-id="5776a-130">Pour ce type de cliché instantané, notez les points suivants :</span><span class="sxs-lookup"><span data-stu-id="5776a-130">For this type of shadow copy, note the following:</span></span>

-   <span data-ttu-id="5776a-131">Les demandeurs doivent toujours appeler les méthodes requises indiquées dans [conditions préalables pour tous les clichés instantanés](#prerequisites-for-all-shadow-copies).</span><span class="sxs-lookup"><span data-stu-id="5776a-131">Requesters must still call the required methods listed in [Prerequisites for All Shadow Copies](#prerequisites-for-all-shadow-copies).</span></span>
-   <span data-ttu-id="5776a-132">Les demandeurs peuvent appeler [**IVssBackupComponents :: GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata), mais cela n’est pas obligatoire.</span><span class="sxs-lookup"><span data-stu-id="5776a-132">Requesters may call [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata), but this is not required.</span></span>
-   <span data-ttu-id="5776a-133">Si les demandeurs appellent [**IVssBackupComponents :: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent), [**IVssBackupComponents ::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup)ou [**IVssBackupComponents :: BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete), une erreur est retournée.</span><span class="sxs-lookup"><span data-stu-id="5776a-133">If requesters call [**IVssBackupComponents::AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent), [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup), or [**IVssBackupComponents::BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete), an error will be returned.</span></span>
-   <span data-ttu-id="5776a-134">Les fournisseurs ne génèrent pas d’événements [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*dégeler*](vssgloss-t.md)ou [*PostSnapshot*](vssgloss-p.md) pour ce type de cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="5776a-134">Providers will not generate [*PrepareForSnapshot*](vssgloss-p.md), [*Freeze*](vssgloss-f.md), [*Thaw*](vssgloss-t.md), or [*PostSnapshot*](vssgloss-p.md) events for this type of shadow copy.</span></span>

 

 



