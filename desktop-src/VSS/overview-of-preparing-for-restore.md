---
description: Lors de la préparation d’une restauration, un demandeur utilise les documents de métadonnées de l’enregistreur stocké conjointement avec son propre document de composants de sauvegarde récupérés pour déterminer ce qui doit être restauré et comment.
ms.assetid: 36cf188f-fce6-467c-a200-cbd9dc8f31a6
title: Vue d’ensemble de la préparation pour la restauration
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d8b1bc3e429da5be9872e8345fe6da32a5340005
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "106534465"
---
# <a name="overview-of-preparing-for-restore"></a>Vue d’ensemble de la préparation pour la restauration

Lors de la préparation d’une restauration, un demandeur utilise les documents de métadonnées de l’enregistreur stocké conjointement avec son propre document de composants de sauvegarde récupérés pour déterminer ce qui doit être restauré et comment. Pour plus d’informations, consultez [vue d’ensemble du traitement d’une restauration sous VSS](overview-of-processing-a-restore-under-vss.md).

Après la sélection des composants candidats à la restauration, les enregistreurs en cours d’exécution sur le système accèdent au document des composants de sauvegarde du demandeur. Les enregistreurs utilisent cet accès pour indiquer comment entraîner une difficulté minimale pour l’exécution des services en raison de la restauration.

Une fois cette opération terminée, le demandeur dispose de suffisamment d’informations pour déterminer les fichiers qui devront être restaurés, ainsi que l’emplacement et la manière dont ils doivent être restaurés. (Pour plus d’informations, consultez [génération d’un jeu de restauration](generating-a-restore-set.md).)

Le tableau suivant présente la séquence des actions et des événements qui sont nécessaires à la préparation d’une opération de restauration.



| Action du demandeur                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Événement                                                         | Action d’écriture                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Récupérez des informations à partir du document sur les composants de sauvegarde à propos des composants [*explicitement inclus*](vssgloss-e.md) dans l’opération de sauvegarde (voir [**IVssBackupComponents :: GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents)) Examinez les documents de métadonnées de l’enregistreur récupéré pour obtenir des détails sur les composants inclus explicitement dans la sauvegarde, ainsi que tous les sous-composants de Find [*implicitement inclus*](vssgloss-i.md) . (Consultez [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata), [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent).)<br/> | Aucune                                                          | Aucune                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Sélectionnez les composants et les ensembles de composants à restaurer (consultez [**IVssBackupComponents :: SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) et [**IVssBackupComponents :: AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent).)                                                                                                                                                                                                                                                                                                                                                                                          | Aucune                                                          | Aucune                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Le demandeur permet à l’enregistreur de mettre à jour le document des composants de sauvegarde et peut éventuellement communiquer des options de restauration spéciales à l’enregistreur. (Consultez [**IVssBackupComponents :: SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions), [**IVssBackupComponents :: AddNewTarget**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addnewtarget)et [**IVssBackupComponents ::P Restore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore).)                                                                                                                                                                                                                                         | [*Prérestauration*](vssgloss-p.md) | L’enregistreur détermine la participation à la restauration, prépare les fichiers à restaurer et éventuellement modifie le document des composants de sauvegarde, si nécessaire. (Consultez [**CVssWriter :: OnPreRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore), [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent), [**IVssComponent :: IsSelectedForRestore**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-isselectedforrestore), [**IVssComponent :: GetRestoreOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoreoptions), [**IVssComponent :: SetRestoreTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoretarget), [**IVssComponent :: SetRestoreMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoremetadata), [**IVssComponent :: AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget).) |
| Le demandeur attend les enregistreurs pour gérer l’événement de [**prérestauration**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) avec [**IVssAsync**](/windows/desktop/api/Vss/nn-vss-ivssasync). Il doit également vérifier l’état de l’enregistreur. (Consultez [**IVssBackupComponents :: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus), [**IVssBackupComponents :: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).)                                                                                                                                                                                                                                                                                  | Aucune                                                          | Aucune                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |



 

## <a name="requester-actions-during-restore-preparations"></a>Actions du demandeur pendant les préparatifs de restauration

Pour déterminer quels sont les composants candidats à la restauration, le demandeur doit effectuer les opérations suivantes :

-   Établissez le composant et la structure du [*jeu de composants*](vssgloss-c.md) utilisée pour effectuer la sauvegarde.
-   Examinez la [*sélectivité des composants pour la restauration*](vssgloss-s.md).
-   Utilisez les instructions de sélectivité (utilisation de la[sélectivité pour la restauration et](working-with-selectability-for-restore-and-subcomponents.md)les sous-composants) pour choisir les composants à inclure.
-   Utilisez les informations du [*jeu de fichiers*](vssgloss-f.md) du composant pour déterminer quels fichiers sur le support de sauvegarde doivent être restaurés.

Pour ce faire, le demandeur doit examiner les composants [*inclus explicitement*](vssgloss-e.md) dans le document des composants de sauvegarde stocké. Ces informations sur les composants sont disponibles à la base de l’enregistreur à l’aide de [**IVssBackupComponents :: GetWriterComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritercomponents), qui retourne des instances de l’interface [**IVssWriterComponentsExt**](/windows/win32/api/vsbackup/nl-vsbackup-ivsswritercomponentsext) , à partir desquelles les informations de Writer et les instances de l’interface [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) peuvent être récupérées.

Comme indiqué ailleurs ([à l’aide de composants par le demandeur](use-of-components-by-the-requestor.md)), le document sur les composants de sauvegarde et l’interface **IVssComponent** ne contiennent pas suffisamment d’informations pour prendre en charge la sauvegarde. Par conséquent, le demandeur doit examiner le document de métadonnées de l’enregistreur stocké correspondant à l’aide de [**IVssExamineWriterMetadata**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssexaminewritermetadata) (consultez les [informations d’identification du rédacteur](writer-metadata-document-contents.md)).

Le nombre de composants gérés par chaque Writer est retourné par [**IVssExamineWriterMetadata :: GetFileCounts**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getfilecounts). Le demandeur peut ensuite utiliser [**IVssExamineWriterMetadata :: GetComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-getcomponent) pour obtenir une interface [**IVssWMComponent**](/windows/desktop/api/VsBackup/nl-vsbackup-ivsswmcomponent) pour chaque composant géré par un enregistreur.

En examinant la [*sélectivité des composants pour la sauvegarde*](vssgloss-s.md) et les [*chemins logiques*](vssgloss-l.md) (voir [utilisation de la sélectivité et des chemins logiques](working-with-selectability-and-logical-paths.md)), un demandeur est en mesure d’identifier les composants qui ont défini les jeux de composants de sauvegarde (composants inclus explicitement) et les membres des sous-composants de ces ensembles (composants inclus implicitement).

Les demandeurs indiquent par le biais du document sur les composants de sauvegarde si un composant doit être restauré explicitement, à l’aide de [**IVssBackupComponents :: SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) ou [**IVssBackupComponents :: AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent). Le choix de la méthode dépend de la manière dont le composant a été sauvegardé à l’origine et [*de sa sélectivité pour la restauration*](vssgloss-s.md). Ces composants inclus explicitement pour la restauration désignent d’autres composants inclus implicitement (voir utilisation de la [sélectivité pour la restauration et](working-with-selectability-for-restore-and-subcomponents.md) des sous-composants pour plus d’informations).

Un demandeur peut inclure explicitement aucun des composants de l’enregistreur en cours d’exécution pour la restauration à l’aide de [**IVssBackupComponents :: SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) ou [**IVssBackupComponents :: AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent). Dans ce cas, ce writer ne recevra aucun événement VSS pour le reste de l’opération de restauration.

L’utilisation explicite de [**IVssBackupComponents :: SetSelectedForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setselectedforrestore) ou de [**IVssBackupComponents :: AddRestoreSubcomponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addrestoresubcomponent) pour sélectionner un composant d’un writer qui n’est pas en cours d’exécution retourne une \_ \_ erreur objet VSS E \_ \_ introuvable. Pour plus d’informations sur la restauration des données des enregistreurs manquants, consultez restaurations [sans participation au rédacteur](restores-without-writer-participation.md) .

Pour permettre à un enregistreur d’avoir des informations complètes sur lesquelles agir, les options de restauration spécifiques à l’enregistreur et l’indication d’une restauration incrémentielle peuvent être envoyées aux enregistreurs par les appels du demandeur à [**IVssBackupComponents :: SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) et [**IVssBackupComponents :: SetAdditionalRestores**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setadditionalrestores), respectivement.

À ce stade, un demandeur a terminé sa préparation et génère un événement de **prérestauration** en appelant [**IVssBackupComponents ::P Restore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore), ce qui permet aux rédacteurs de se préparer pour la restauration réelle.

## <a name="writer-actions-during-restore-preparations"></a>Actions d’écriture pendant les préparatifs de restauration

La préparation de l’enregistreur pour l’opération de restauration se produit lors de la gestion de l’événement de [**prérestauration**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) avec la méthode virtuelle [**CVssWriter :: OnPreRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore). L’implémentation par défaut retourne simplement sans entreprendre aucune action. Les enregistreurs peuvent choisir de substituer l’implémentation par défaut pour exercer davantage de contrôle :

-   Substitution des [*méthodes de restauration*](vssgloss-r.md) avec les [*cibles de restauration*](vssgloss-r.md)
-   Définition des [ *cibles dirigées*](vssgloss-d.md)
-   Création de messages d’erreur et de données supplémentaires
-   Indication des informations de tampon de sauvegarde

Le gestionnaire d’événements [**CVssWriter :: OnPreRestore**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onprerestore) reçoit une instance du [**IVssWriterComponents**](/windows/desktop/api/VsWriter/nl-vswriter-ivsswritercomponents), à partir de laquelle il peut obtenir des interfaces [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) pour ceux de ses composants explicitement inclus dans le document des composants de sauvegarde lors de la sauvegarde.

Informations sur les sous-composants inclus implicitement dans les opérations de sauvegarde et inclus explicitement dans les restaurations à l’aide d’une instance du **IVssComponent** correspondant au composant qui a défini son [*jeu de composants*](vssgloss-c.md)de sauvegarde.

La méthode [**IVssComponent :: IsSelectedForRestore**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-isselectedforrestore) est utilisée pour déterminer si un composant explicitement inclus pour la sauvegarde doit être restauré.

Pour déterminer si un sous-composant de sauvegarde a été inclus explicitement dans la restauration, les enregistreurs utilisent [**IVssComponent :: GetRestoreSubcomponent**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoresubcomponent).

L’enregistreur doit examiner le [*jeu de fichiers*](vssgloss-f.md) dans chaque composant et déterminer s’il doit prendre des mesures pour prendre en charge la restauration. Le writer devra évaluer s’il souhaite que ses fichiers actuels soient remplacés, ou s’il nécessite la restauration vers de nouveaux emplacements. Les actions peuvent inclure les éléments suivants :

-   Obtention et action des options spécifiques du writer ou du demandeur régissant les opérations de restauration (voir [**IVssComponent :: GetRestoreOptions**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-getrestoreoptions))
-   Fermer et rendre accessibles en écriture les fichiers actuellement ouverts
-   Mise à jour de la cible de restauration (par exemple, pour forcer la restauration vers un autre mappage d’emplacement). Consultez [**IVssComponent :: SetRestoreTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoretarget).
-   Communication avec le demandeur via des métadonnées privées (voir [**IVssComponent :: SetRestoreMetadata**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-setrestoremetadata))
-   Indiquant qu’un fichier doit être restauré par remappage via la définition des [*cibles dirigées*](vssgloss-d.md) (consultez [**IVssComponent :: AddDirectedTarget**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponent-adddirectedtarget))

L’instance de [**IVssComponent**](/windows/desktop/api/VsWriter/nl-vswriter-ivsscomponent) utilisée est celle créée par l’inclusion explicite du composant dans le document des composants de sauvegarde pendant la sauvegarde, ou celle du composant définissant le jeu de composants de sauvegarde dont il était membre (voir utilisation de la [sélectivité pour la restauration et](working-with-selectability-for-restore-and-subcomponents.md)les sous-composants).

 

 
