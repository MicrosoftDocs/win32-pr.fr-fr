---
description: Un fournisseur de clichés instantanés doit se conformer aux indications pour garantir la compatibilité du demandeur.
ms.assetid: 49baeb89-1dc9-45c2-a532-071085a8e52f
title: Comportements requis pour les fournisseurs de clichés instantanés
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f451dea7154a313cd64a3a46fbcc3b5fe663ec12
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "106519855"
---
# <a name="required-behaviors-for-shadow-copy-providers"></a><span data-ttu-id="0c0c4-103">Comportements requis pour les fournisseurs de clichés instantanés</span><span class="sxs-lookup"><span data-stu-id="0c0c4-103">Required Behaviors for Shadow Copy Providers</span></span>

<span data-ttu-id="0c0c4-104">Un fournisseur de clichés instantanés doit se conformer aux indications pour garantir la compatibilité du demandeur.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-104">A shadow copy provider must conform to guidelines to ensure requester compatibility.</span></span> <span data-ttu-id="0c0c4-105">Lors de l’exécution, une application de sauvegarde ou tout autre demandeur qui utilise des clichés instantanés doit fonctionner correctement sans aucune connaissance des détails spécifiques de l’implémentation du fournisseur.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-105">At runtime, a backup application or any other requester that uses shadow copies must function correctly without any knowledge of specific provider implementation details.</span></span>

## <a name="automagic-resource-management"></a><span data-ttu-id="0c0c4-106">Gestion des ressources automagic</span><span class="sxs-lookup"><span data-stu-id="0c0c4-106">Automagic Resource Management</span></span>

<span data-ttu-id="0c0c4-107">Le demandeur doit être en mesure d’ajouter simplement un volume à un jeu de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-107">It must be possible for the requester to simply add a volume to a shadow copy set.</span></span> <span data-ttu-id="0c0c4-108">Le demandeur peut spécifier des attributs de cliché instantané tels **que VSS \_ Volsnap \_ attr \_ transportable**, **VSS \_ Volsnap \_ attr \_ Differential** et/ou **VSS \_ Volsnap \_ attr \_ Plex** dans le contexte de l' [**\_ \_ instantané \_ VSS**](/windows/desktop/api/Vss/ne-vss-vss_snapshot_context).</span><span class="sxs-lookup"><span data-stu-id="0c0c4-108">The requester can specify shadow copy attributes such as **VSS\_VOLSNAP\_ATTR\_TRANSPORTABLE**, **VSS\_VOLSNAP\_ATTR\_DIFFERENTIAL**, and/or **VSS\_VOLSNAP\_ATTR\_PLEX** in the [**\_VSS\_SNAPSHOT\_CONTEXT**](/windows/desktop/api/Vss/ne-vss-vss_snapshot_context).</span></span> <span data-ttu-id="0c0c4-109">Le fournisseur doit respecter ces attributs.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-109">The provider must honor those attributes.</span></span> <span data-ttu-id="0c0c4-110">S’il ne peut pas honorer ces attributs, il doit indiquer que le jeu de clichés instantanés n’est pas pris en charge en affectant \* à *PbIsSupported* dans [**IVssHardwareSnapshotProvider :: AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) la **valeur false**.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-110">If it cannot honor those attributes, then it should indicate that the shadow copy set is unsupported by setting the \**pbIsSupported* in [**IVssHardwareSnapshotProvider::AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) to **FALSE**.</span></span>

<span data-ttu-id="0c0c4-111">Le fournisseur ne doit jamais accepter de prendre en charge un cliché instantané qu’il ne peut pas créer.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-111">The provider must never agree to support a shadow copy that it cannot create.</span></span> <span data-ttu-id="0c0c4-112">Si le demandeur ne spécifie pas d’attribut Plex ou Differential, le fournisseur doit inclure la logique automagic pour allouer l’espace du sous-système pour le cliché instantané et créer le cliché instantané à l’aide de la méthode la plus appropriée.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-112">If the requester does not specify a plex or differential attribute, the provider must include automagic logic for allocating subsystem space for the shadow copy and create the shadow copy using the most appropriate method.</span></span> <span data-ttu-id="0c0c4-113">Le fournisseur de matériel ne doit pas inclure d’API spécifique au fournisseur pour la gestion des propriétés de clichés instantanés requises.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-113">The hardware provider must not include a provider-specific API for managing required shadow copy properties.</span></span>

## <a name="created-shadow-copy-volumes-are-read-only-and-hidden"></a><span data-ttu-id="0c0c4-114">Les volumes de clichés instantanés créés sont Read-Only et masqués</span><span class="sxs-lookup"><span data-stu-id="0c0c4-114">Created Shadow Copy Volumes Are Read-Only and Hidden</span></span>

<span data-ttu-id="0c0c4-115">VSS définit les indicateurs sur chaque numéro d’unité logique affecté de telle sorte que les volumes de clichés instantanés résultants soient masqués et en lecture seule lorsqu’ils sont détectés par un ordinateur exécutant Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-115">VSS sets flags on each affected LUN such that the resulting shadow copy volumes will be hidden and read-only when detected by a computer running Windows Server 2003.</span></span> <span data-ttu-id="0c0c4-116">Les lettres de lecteur et les dossiers montés ne sont pas attribués automatiquement.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-116">Drive letters and mounted folders are not automatically assigned.</span></span> <span data-ttu-id="0c0c4-117">VSS gère ces indicateurs tout au long du cycle de vie d’un cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-117">VSS maintains these flags throughout the life cycle of a shadow copy.</span></span>

## <a name="hardware-shadow-copy-luns-must-be-readwrite"></a><span data-ttu-id="0c0c4-118">Les numéros d’unité logique de cliché instantané matériel doivent être en lecture/écriture</span><span class="sxs-lookup"><span data-stu-id="0c0c4-118">Hardware Shadow Copy LUNs Must Be Read/Write</span></span>

<span data-ttu-id="0c0c4-119">VSS prend en charge les clichés instantanés matériels uniquement lorsque le numéro d’unité logique sous-jacent est mappé en lecture/écriture.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-119">VSS supports hardware shadow copies only where the underlying LUN is mapped as read/write.</span></span> <span data-ttu-id="0c0c4-120">Cette opération doit être effectuée avant la création du cliché instantané. elle ne peut pas être effectuée après le fait.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-120">This must be done before the shadow copy is created; it cannot be done after the fact.</span></span> <span data-ttu-id="0c0c4-121">Les fournisseurs de matériel ne doivent pas modifier ces indicateurs.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-121">Hardware providers should not modify these flags.</span></span> <span data-ttu-id="0c0c4-122">Pour plus d’informations sur la façon dont VSS utilise ces indicateurs, consultez [le processus de création](the-shadow-copy-creation-process.md)de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-122">For more information about how VSS uses these flags, see [The Shadow Copy Creation Process](the-shadow-copy-creation-process.md).</span></span>

## <a name="auto-import-hardware-shadow-copies-are-not-supported-on-windows-cluster-service"></a><span data-ttu-id="0c0c4-123">Les clichés instantanés matériels à importation automatique ne sont pas pris en charge sur le service de cluster Windows</span><span class="sxs-lookup"><span data-stu-id="0c0c4-123">Auto-Import Hardware Shadow Copies Are Not Supported on Windows Cluster Service</span></span>

<span data-ttu-id="0c0c4-124">Windows service de cluster ne peut pas prendre en charge les numéros d’unité logique avec des signatures et une disposition de partition dupliquées</span><span class="sxs-lookup"><span data-stu-id="0c0c4-124">Windows Cluster service cannot accommodate LUNs with duplicate signatures and partition layout.</span></span> <span data-ttu-id="0c0c4-125">Les numéros d’unités logiques des clichés instantanés doivent être transportés vers un ordinateur hôte situé en dehors du cluster.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-125">The shadow copy LUNs must be transported to a host outside the cluster.</span></span> <span data-ttu-id="0c0c4-126">Pour plus d’informations, consultez [récupération rapide à l’aide de volumes de clichés instantanés transportables](fast-recovery-using-transportable-shadow-copied-volumes.md).</span><span class="sxs-lookup"><span data-stu-id="0c0c4-126">For more information, see [Fast Recovery Using Transportable Shadow Copied Volumes](fast-recovery-using-transportable-shadow-copied-volumes.md).</span></span>

## <a name="shadow-copies-that-contain-dynamic-disks-must-be-transported-to-a-different-host"></a><span data-ttu-id="0c0c4-127">Les clichés instantanés qui contiennent des disques dynamiques doivent être transportés vers un autre hôte</span><span class="sxs-lookup"><span data-stu-id="0c0c4-127">Shadow Copies That Contain Dynamic Disks Must Be Transported to a Different Host</span></span>

<span data-ttu-id="0c0c4-128">**Avant Windows Server 2008 :** La prise en charge native des disques dynamiques ne peut pas prendre en charge les numéros d’unités logiques avec des signatures et des contenus de base de données</span><span class="sxs-lookup"><span data-stu-id="0c0c4-128">**Prior to Windows Server 2008:** The native support for dynamic disks cannot accommodate LUNs with duplicate signatures and configuration database contents.</span></span> <span data-ttu-id="0c0c4-129">Les numéros d’unités logiques des clichés instantanés doivent être acheminés vers un autre hôte.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-129">The shadow copy LUNs must be transported to a different host.</span></span> <span data-ttu-id="0c0c4-130">VSS applique cela en n’autorisant pas l’importation automatique des clichés instantanés de disques dynamiques.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-130">VSS enforces this by not allowing auto-import shadow copies of dynamic disks.</span></span> <span data-ttu-id="0c0c4-131">Un demandeur ne doit pas importer un cliché instantané transportable sur le même hôte.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-131">A requester should not import a transportable shadow copy back to the same host.</span></span>

<span data-ttu-id="0c0c4-132">**À partir de Windows Server 2008 :** Cette limitation est supprimée.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-132">**Beginning with Windows Server 2008:** This limitation is removed.</span></span>

## <a name="providers-are-out-of-process"></a><span data-ttu-id="0c0c4-133">Les fournisseurs sont hors processus</span><span class="sxs-lookup"><span data-stu-id="0c0c4-133">Providers Are Out-of-Process</span></span>

<span data-ttu-id="0c0c4-134">Tous les fournisseurs doivent être implémentés en tant que composants COM hors processus.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-134">All providers must be implemented as out-of-process COM components.</span></span>

## <a name="time-critical-operations"></a><span data-ttu-id="0c0c4-135">Opérations de Time-Critical</span><span class="sxs-lookup"><span data-stu-id="0c0c4-135">Time-Critical Operations</span></span>

<span data-ttu-id="0c0c4-136">Les opérations longues, telles que la synchronisation des plex, doivent être lancées dans [**IVssHardwareSnapshotProvider :: BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot).</span><span class="sxs-lookup"><span data-stu-id="0c0c4-136">Long operations, such as syncing plexes, should be initiated in [**IVssHardwareSnapshotProvider::BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot).</span></span> <span data-ttu-id="0c0c4-137">Cette fonction doit démarrer le travail de préparation asynchrone et retourner rapidement.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-137">This function should start the asynchronous preparation work and return quickly.</span></span> <span data-ttu-id="0c0c4-138">[**IVssProviderCreateSnapshotSet :: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) sert de fonction « Rendezvous » : le fournisseur peut attendre de façon synchrone dans cette méthode pour terminer le travail de préparation qui a été démarré par **BeginPrepareSnapshot**.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-138">[**IVssProviderCreateSnapshotSet::EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots) serves as a "rendezvous" function—the provider can wait synchronously in this method for the completion of the preparation work that was started by **BeginPrepareSnapshot**.</span></span>

<span data-ttu-id="0c0c4-139">Les fournisseurs ne doivent pas ajouter de retards dans [**IVssProviderCreateSnapshotSet ::P recommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**IVssProviderCreateSnapshotSet :: CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)ou [**IVssProviderCreateSnapshotSet ::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) , car les applications sont figées pendant ces appels.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-139">Providers must not add delays in [**IVssProviderCreateSnapshotSet::PreCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-precommitsnapshots), [**IVssProviderCreateSnapshotSet::CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), or [**IVssProviderCreateSnapshotSet::PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) as applications are frozen during these calls.</span></span> <span data-ttu-id="0c0c4-140">**CommitSnapshots** doit retourner en quelques secondes, car cette opération est appelée pendant la fenêtre de vidage et de suspension, et la prise en charge du noyau VSS annule le vidage et le blocage si la mise en service n’est pas reçue dans les 10 secondes, ce qui entraîne l’échec du processus de création de clichés instantanés par VSS.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-140">**CommitSnapshots** should return within seconds, because this is called during the Flush and Hold window, and VSS Kernel Support will cancel the Flush and Hold if the release is not received within 10 seconds, which would cause VSS to fail the shadow copy creation process.</span></span> <span data-ttu-id="0c0c4-141">Si le fournisseur prend plus de quelques secondes pour effectuer cet appel, il est fort probable que la création du cliché instantané échoue.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-141">If the provider takes more than a few seconds to complete this call, there is a high probability that the shadow copy creation will fail.</span></span>

## <a name="careful-io-during-commitsnapshots"></a><span data-ttu-id="0c0c4-142">E/s avec prudence lors de la CommitSnapshots</span><span class="sxs-lookup"><span data-stu-id="0c0c4-142">Careful I/O During CommitSnapshots</span></span>

<span data-ttu-id="0c0c4-143">Les fournisseurs de matériel ne doivent pas avoir besoin d’effectuer des e/s sur les volumes impliqués dans le cliché instantané pendant [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots).</span><span class="sxs-lookup"><span data-stu-id="0c0c4-143">Hardware providers should not need to do any I/O to the volumes involved in the shadow copy during [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots).</span></span> <span data-ttu-id="0c0c4-144">Si des e/s sont requises, les fournisseurs ne doivent pas initialiser les e/s sur un volume d’origine lors de la gestion de la méthode **CommitSnapshots** .</span><span class="sxs-lookup"><span data-stu-id="0c0c4-144">If any I/O is required, providers must not initiate any I/O to an original volume while handling the **CommitSnapshots** method.</span></span>

<span data-ttu-id="0c0c4-145">Pendant la [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), les pilotes de prise en charge du noyau VSS bloquent les e/s des volumes d’origine qui sont des clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-145">During [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), VSS Kernel Support drivers block I/O to the original volumes that are being shadow copied.</span></span> <span data-ttu-id="0c0c4-146">Si le fournisseur utilise des e/s synchrones sur un volume qui se trouve dans le jeu de clichés instantanés, ces e/s seront bloquées et le processus de validation de cliché instantané sera bloqué.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-146">If the provider uses synchronous I/O to a volume which is in the shadow copy set, then that I/O will be blocked and the shadow copy commit process will be deadlocked.</span></span> <span data-ttu-id="0c0c4-147">Le fournisseur ne doit pas appeler d’API Win32 pendant **CommitSnapshots** , car il aura une probabilité élevée de provoquer des e/s et un blocage.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-147">The provider should not call any Win32 APIs during **CommitSnapshots** as they will have a high probability of causing I/O and a deadlock.</span></span> <span data-ttu-id="0c0c4-148">Le délai d’attente de la prise en charge du noyau VSS interrompt ce blocage au bout de 10 secondes, mais cela entraîne l’échec de la création de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-148">The VSS Kernel Support timeout will break this deadlock after 10 seconds, but this will cause the shadow copy creation to fail.</span></span>

<span data-ttu-id="0c0c4-149">Si des e/s doivent être tentées, elles doivent être exécutées de façon asynchrone.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-149">If I/O must be attempted, it must be performed asynchronously.</span></span> <span data-ttu-id="0c0c4-150">L’e/s ne se termine pas tant que tous les fournisseurs n’ont pas retourné leurs méthodes [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="0c0c4-150">The I/O will not complete until after all providers have returned from their [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots) methods.</span></span> <span data-ttu-id="0c0c4-151">En général, il est préférable d’effectuer ces opérations dans l’appel [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) .</span><span class="sxs-lookup"><span data-stu-id="0c0c4-151">In general, it is better to perform such operations in the [**PostCommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots) call.</span></span>

## <a name="readwrite-shadow-copy-luns"></a><span data-ttu-id="0c0c4-152">LUN de clichés instantanés en lecture/écriture</span><span class="sxs-lookup"><span data-stu-id="0c0c4-152">Read/Write Shadow Copy LUNs</span></span>

<span data-ttu-id="0c0c4-153">Dans cette version, VSS prend en charge uniquement les numéros d’unités logiques de clichés instantanés en lecture/écriture même si les volumes sont exposés en lecture seule.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-153">In this version, VSS supports only read/write shadow copy LUNs even if the volumes are exposed as read-only.</span></span> <span data-ttu-id="0c0c4-154">La raison en est que le système doit modifier les structures de données sur disque, telles que :</span><span class="sxs-lookup"><span data-stu-id="0c0c4-154">The reason is that the system needs to change on-disk data structures such as:</span></span>

-   <span data-ttu-id="0c0c4-155">Signature de disque, qui change pendant le processus de cliché instantané</span><span class="sxs-lookup"><span data-stu-id="0c0c4-155">Disk signature, which changes during the shadow copy process</span></span>
-   <span data-ttu-id="0c0c4-156">Les structures de données liées aux partitions, y compris celles indiquant que la partition est en lecture seule, masquée, un cliché instantané, et ne doivent pas recevoir de lettre de lecteur.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-156">Partition-related data structures, including those indicating the partition is read-only, hidden, a shadow copy, and should not be assigned a drive letter.</span></span>

## <a name="unique-page-83-information"></a><span data-ttu-id="0c0c4-157">Page unique 83 informations</span><span class="sxs-lookup"><span data-stu-id="0c0c4-157">Unique Page 83 Information</span></span>

<span data-ttu-id="0c0c4-158">Le numéro d’unité logique d’origine et le numéro d’unité logique de cliché instantané nouvellement créé doivent avoir au moins un identificateur de stockage unique dans les données de la page 83.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-158">Both the original LUN and the newly created shadow copy LUN must have at least one unique storage identifier in the page 83 data.</span></span> <span data-ttu-id="0c0c4-159">Au moins un identificateur de stockage de \_ type 1, 2, 3 ou 8, et une association de 0 doit être unique sur le numéro d’unité logique d’origine et le numéro d’unité logique de cliché instantané nouvellement créé.</span><span class="sxs-lookup"><span data-stu-id="0c0c4-159">At least one STORAGE\_IDENTIFIER with a type of 1, 2, 3, or 8, and an association of 0 must be unique on the original LUN and the newly created shadow copy LUN.</span></span>

 

 



