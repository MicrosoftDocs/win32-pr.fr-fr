---
description: Une application de sauvegarde et de récupération VSS qui effectue une récupération d’urgence (également appelée récupération complète) peut utiliser l’enregistreur de récupération automatique du système (ASR) avec environnement de préinstallation Windows (WinPE) (Windows PE) pour sauvegarder et restaurer les volumes critiques et d’autres composants de l’état du système de démarrage. L’application de sauvegarde est implémentée en tant que demandeur VSS.
ms.assetid: 13adfd79-f26a-4385-9b59-129d06fa72eb
title: Utilisation de la récupération automatique du système VSS pour la récupération d’urgence
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1e31ef8ba223f40928e2422fa92240656f94592d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "106515462"
---
# <a name="using-vss-automated-system-recovery-for-disaster-recovery"></a><span data-ttu-id="21076-104">Utilisation de la récupération automatique du système VSS pour la récupération d’urgence</span><span class="sxs-lookup"><span data-stu-id="21076-104">Using VSS Automated System Recovery for Disaster Recovery</span></span>

<span data-ttu-id="21076-105">Une application de sauvegarde et de récupération VSS qui effectue une récupération d’urgence (également appelée récupération complète) peut utiliser l’enregistreur de récupération automatique du système (ASR) avec environnement de préinstallation Windows (WinPE) (Windows PE) pour sauvegarder et restaurer les volumes critiques et d’autres composants de l’état du système de démarrage.</span><span class="sxs-lookup"><span data-stu-id="21076-105">A VSS backup-and-recovery application that performs disaster recovery (also called bare-metal recovery) can use the Automated System Recovery (ASR) writer together with Windows Preinstallation Environment (Windows PE) to back up and restore critical volumes and other components of the bootable system state.</span></span> <span data-ttu-id="21076-106">L’application de sauvegarde est implémentée en tant que demandeur VSS.</span><span class="sxs-lookup"><span data-stu-id="21076-106">The backup application is implemented as a VSS requester.</span></span>

<span data-ttu-id="21076-107">**Remarque**  Les applications qui utilisent ASR doivent disposer d’une licence Windows PE.</span><span class="sxs-lookup"><span data-stu-id="21076-107">**Note**  Applications that use ASR must license Windows PE.</span></span>

<span data-ttu-id="21076-108">**Windows Server 2003 et Windows XP :** La récupération automatique du système n’est pas implémentée en tant qu’enregistreur VSS.</span><span class="sxs-lookup"><span data-stu-id="21076-108">**Windows Server 2003 and Windows XP:** ASR is not implemented as a VSS writer.</span></span>

<span data-ttu-id="21076-109">Pour plus d’informations sur les outils de suivi que vous pouvez utiliser avec la récupération automatique du système, consultez [utilisation des outils de suivi avec les applications ASR VSS](using-tracing-tools-with-vss-asr-applications.md).</span><span class="sxs-lookup"><span data-stu-id="21076-109">For information about tracing tools that you can use with ASR, see [Using Tracing Tools with VSS ASR Applications](using-tracing-tools-with-vss-asr-applications.md).</span></span>

<span data-ttu-id="21076-110">**Dans cet article :**</span><span class="sxs-lookup"><span data-stu-id="21076-110">**In this article:**</span></span>

-   [<span data-ttu-id="21076-111">Vue d’ensemble des tâches de phase de sauvegarde</span><span class="sxs-lookup"><span data-stu-id="21076-111">Overview of Backup Phase Tasks</span></span>](#overview-of-backup-phase-tasks)
-   [<span data-ttu-id="21076-112">Choix des composants critiques à sauvegarder</span><span class="sxs-lookup"><span data-stu-id="21076-112">Choosing Which Critical Components to Back Up</span></span>](#choosing-which-critical-components-to-back-up)
-   [<span data-ttu-id="21076-113">Vue d’ensemble des tâches de la phase de restauration</span><span class="sxs-lookup"><span data-stu-id="21076-113">Overview of Restore Phase Tasks</span></span>](#overview-of-restore-phase-tasks)
-   [<span data-ttu-id="21076-114">Exclusion de tous les disques d’un volume</span><span class="sxs-lookup"><span data-stu-id="21076-114">Excluding All Disks for a Volume</span></span>](#excluding-all-disks-for-a-volume)

## <a name="overview-of-backup-phase-tasks"></a><span data-ttu-id="21076-115">Vue d’ensemble des tâches de phase de sauvegarde</span><span class="sxs-lookup"><span data-stu-id="21076-115">Overview of Backup Phase Tasks</span></span>

<span data-ttu-id="21076-116">Au moment de la sauvegarde, le demandeur effectue les étapes suivantes.</span><span class="sxs-lookup"><span data-stu-id="21076-116">At backup time, the requester performs the following steps.</span></span>

> [!Note]  
> <span data-ttu-id="21076-117">Toutes les étapes sont requises sauf indication contraire.</span><span class="sxs-lookup"><span data-stu-id="21076-117">All steps are required unless otherwise indicated.</span></span>

 

1.  <span data-ttu-id="21076-118">Appelez la fonction [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) pour créer une instance de l’interface [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) et appelez la méthode [**IVssBackupComponents :: InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) pour initialiser l’instance afin de gérer une sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="21076-118">Call the [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) function to create an instance of the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface and call the [**IVssBackupComponents::InitializeForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforbackup) method to initialize the instance to manage a backup.</span></span>
2.  <span data-ttu-id="21076-119">Appelez [**IVssBackupComponents :: SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) pour définir le contexte de l’opération de cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="21076-119">Call [**IVssBackupComponents::SetContext**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setcontext) to set the context for the shadow copy operation.</span></span>
3.  <span data-ttu-id="21076-120">Appelez [**IVssBackupComponents :: SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) pour configurer la sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="21076-120">Call [**IVssBackupComponents::SetBackupState**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupstate) to configure the backup.</span></span> <span data-ttu-id="21076-121">Affectez la **valeur true** au paramètre *bBackupBootableSystemState* pour indiquer que la sauvegarde inclura un État du système de démarrage.</span><span class="sxs-lookup"><span data-stu-id="21076-121">Set the *bBackupBootableSystemState* parameter to **true** to indicate that the backup will include a bootable system state.</span></span>
4.  <span data-ttu-id="21076-122">Choisissez les composants critiques dans le document de métadonnées de l’enregistreur de l’Enregistreur ASR à sauvegarder et appelez [**IVssBackupComponents :: AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) pour chacun d’eux.</span><span class="sxs-lookup"><span data-stu-id="21076-122">Choose which critical components in the ASR writer's Writer Metadata Document to back up and call [**IVssBackupComponents::AddComponent**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addcomponent) for each of them.</span></span>
5.  <span data-ttu-id="21076-123">Appelez [**IVssBackupComponents :: StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) pour créer un jeu de clichés instantanés vide.</span><span class="sxs-lookup"><span data-stu-id="21076-123">Call [**IVssBackupComponents::StartSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-startsnapshotset) to create a new, empty shadow copy set.</span></span>
6.  <span data-ttu-id="21076-124">Appelez [**IVssBackupComponents :: GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) pour initier un contact asynchrone avec des enregistreurs.</span><span class="sxs-lookup"><span data-stu-id="21076-124">Call [**IVssBackupComponents::GatherWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwritermetadata) to initiate asynchronous contact with writers.</span></span>
7.  <span data-ttu-id="21076-125">Appelez [**IVssBackupComponents :: GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) pour récupérer le document des métadonnées de l’enregistreur de l’Enregistreur ASR.</span><span class="sxs-lookup"><span data-stu-id="21076-125">Call [**IVssBackupComponents::GetWriterMetadata**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwritermetadata) to retrieve the ASR writer's Writer Metadata Document.</span></span> <span data-ttu-id="21076-126">L’ID d’enregistreur pour l’Enregistreur ASR est BE000CBE-11FE-4426-9C58-531AA6355FC4 et la chaîne du nom de l’enregistreur est « Enregistreur ASR ».</span><span class="sxs-lookup"><span data-stu-id="21076-126">The writer ID for the ASR writer is BE000CBE-11FE-4426-9C58-531AA6355FC4, and the writer name string is "ASR Writer".</span></span>
8.  <span data-ttu-id="21076-127">Appelez [**IVssExamineWriterMetadata :: SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) pour enregistrer une copie du document de métadonnées de l’enregistreur de l’Enregistreur ASR.</span><span class="sxs-lookup"><span data-stu-id="21076-127">Call [**IVssExamineWriterMetadata::SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssexaminewritermetadata-saveasxml) to save a copy of the ASR writer's Writer Metadata Document.</span></span>
9.  <span data-ttu-id="21076-128">Appelez [**IVssBackupComponents :: AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset) pour chaque volume qui peut participer aux clichés instantanés pour ajouter le volume au jeu de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="21076-128">Call [**IVssBackupComponents::AddToSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-addtosnapshotset) for each volume that can participate in shadow copies to add the volume to the shadow copy set.</span></span>
10. <span data-ttu-id="21076-129">Appelez [**IVssBackupComponents ::P repareforbackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) pour notifier aux rédacteurs de se préparer pour une opération de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="21076-129">Call [**IVssBackupComponents::PrepareForBackup**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prepareforbackup) to notify writers to prepare for a backup operation.</span></span>
11. <span data-ttu-id="21076-130">Appelez [**IVssBackupComponents :: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) et [**IVssBackupComponents :: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) (ou [**IVssBackupComponentsEx3 :: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex3-getwriterstatusex)) pour vérifier l’état de l’Enregistreur ASR.</span><span class="sxs-lookup"><span data-stu-id="21076-130">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) (or [**IVssBackupComponentsEx3::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponentsex3-getwriterstatusex)) to verify the status of the ASR writer.</span></span>
12. <span data-ttu-id="21076-131">À ce stade, vous pouvez interroger les messages d’échec qui ont été définis par le writer dans sa méthode [**CVssWriter :: OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) .</span><span class="sxs-lookup"><span data-stu-id="21076-131">At this point, you can query for failure messages that were set by the writer in its [**CVssWriter::OnPrepareBackup**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpreparebackup) method.</span></span> <span data-ttu-id="21076-132">Pour obtenir un exemple de code qui montre comment afficher ces messages, consultez [**IVssComponentEx :: GetPrepareForBackupFailureMsg**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponentex-getprepareforbackupfailuremsg).</span><span class="sxs-lookup"><span data-stu-id="21076-132">For example code that shows how to view these messages, see [**IVssComponentEx::GetPrepareForBackupFailureMsg**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscomponentex-getprepareforbackupfailuremsg).</span></span>
13. <span data-ttu-id="21076-133">Appelez [**IVssBackupComponents ::D osnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) pour créer un cliché instantané du volume.</span><span class="sxs-lookup"><span data-stu-id="21076-133">Call [**IVssBackupComponents::DoSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-dosnapshotset) to create a volume shadow copy.</span></span>
14. <span data-ttu-id="21076-134">Appelez [**IVssBackupComponents :: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) et [**IVssBackupComponents :: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) pour vérifier l’état de l’Enregistreur ASR.</span><span class="sxs-lookup"><span data-stu-id="21076-134">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus) to verify the status of the ASR writer.</span></span>
15. <span data-ttu-id="21076-135">Sauvegardez les données.</span><span class="sxs-lookup"><span data-stu-id="21076-135">Back up the data.</span></span>
16. <span data-ttu-id="21076-136">Indiquez si l’opération de sauvegarde a réussi en appelant [**IVssBackupComponents :: SetBackupSucceeded**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded).</span><span class="sxs-lookup"><span data-stu-id="21076-136">Indicate whether the backup operation succeeded by calling [**IVssBackupComponents::SetBackupSucceeded**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setbackupsucceeded).</span></span>
17. <span data-ttu-id="21076-137">Appelez [**IVssBackupComponents :: BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) pour indiquer que l’opération de sauvegarde est terminée.</span><span class="sxs-lookup"><span data-stu-id="21076-137">Call [**IVssBackupComponents::BackupComplete**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-backupcomplete) to indicate that the backup operation has completed.</span></span>
18. <span data-ttu-id="21076-138">Appelez [**IVssBackupComponents :: GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) et [**IVssBackupComponents :: GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).</span><span class="sxs-lookup"><span data-stu-id="21076-138">Call [**IVssBackupComponents::GatherWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-gatherwriterstatus) and [**IVssBackupComponents::GetWriterStatus**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-getwriterstatus).</span></span> <span data-ttu-id="21076-139">La mémoire de l’état de session du writer est une ressource limitée, et les enregistreurs doivent finalement réutiliser les États de session.</span><span class="sxs-lookup"><span data-stu-id="21076-139">The writer session state memory is a limited resource, and writers must eventually reuse session states.</span></span> <span data-ttu-id="21076-140">Cette étape marque l’état de la session de sauvegarde du writer comme étant terminé et notifie à VSS que cet emplacement de session de sauvegarde peut être réutilisé par une opération de sauvegarde ultérieure.</span><span class="sxs-lookup"><span data-stu-id="21076-140">This step marks the writer’s backup session state as completed and notifies VSS that this backup session slot can be reused by a subsequent backup operation.</span></span>
    > [!Note]  
    > <span data-ttu-id="21076-141">Cela n’est nécessaire que sur Windows Server 2008 avec Service Pack 2 (SP2) et versions antérieures.</span><span class="sxs-lookup"><span data-stu-id="21076-141">This is only necessary on Windows Server 2008 with Service Pack 2 (SP2) and earlier.</span></span>

     

19. <span data-ttu-id="21076-142">Appelez [**IVssBackupComponents :: SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) pour enregistrer une copie du document des composants de sauvegarde du demandeur.</span><span class="sxs-lookup"><span data-stu-id="21076-142">Call [**IVssBackupComponents::SaveAsXML**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-saveasxml) to save a copy of the requester's Backup Components Document.</span></span> <span data-ttu-id="21076-143">Les informations contenues dans le document composants de sauvegarde sont utilisées au moment de la restauration lorsque le demandeur appelle la méthode [**IVssBackupComponents :: InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) .</span><span class="sxs-lookup"><span data-stu-id="21076-143">The information in the Backup Components Document is used at restore time when the requester calls the [**IVssBackupComponents::InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) method.</span></span>

## <a name="choosing-which-critical-components-to-back-up"></a><span data-ttu-id="21076-144">Choix des composants critiques à sauvegarder</span><span class="sxs-lookup"><span data-stu-id="21076-144">Choosing Which Critical Components to Back Up</span></span>

<span data-ttu-id="21076-145">Dans la phase d’initialisation de la sauvegarde, le rédacteur ASR signale les types de composants suivants dans son document de métadonnées d’écriture :</span><span class="sxs-lookup"><span data-stu-id="21076-145">In the backup initialization phase, the ASR writer reports the following types of components in its Writer Metadata Document:</span></span>

-   <span data-ttu-id="21076-146">Volumes critiques, tels que les volumes de démarrage, de système et d’environnement de récupération Windows (Windows RE) et la partition Windows RE qui est associée à l’instance de Windows Vista ou Windows Server 2008 en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="21076-146">Critical volumes, such as the boot, system, and Windows Recovery Environment (Windows RE) volumes and the Windows RE partition that is associated with the instance of Windows Vista or Windows Server 2008 that is currently running.</span></span> <span data-ttu-id="21076-147">Un volume est un *volume critique* s’il contient des informations sur l’état du système.</span><span class="sxs-lookup"><span data-stu-id="21076-147">A volume is a *critical volume* if it contains system state information.</span></span> <span data-ttu-id="21076-148">Les volumes de démarrage et système sont inclus automatiquement.</span><span class="sxs-lookup"><span data-stu-id="21076-148">The boot and system volumes are included automatically.</span></span> <span data-ttu-id="21076-149">Le demandeur doit inclure tous les volumes qui contiennent les composants critiques du système signalés par les writers, tels que les volumes qui contiennent le Active Directory.</span><span class="sxs-lookup"><span data-stu-id="21076-149">The requester must include all volumes that contain system-critical components reported by writers, such as the volumes that contain the Active Directory.</span></span> <span data-ttu-id="21076-150">Les composants critiques du système sont marqués comme étant « non sélectionnables pour la sauvegarde ».</span><span class="sxs-lookup"><span data-stu-id="21076-150">System-critical components are marked as "not selectable for backup."</span></span> <span data-ttu-id="21076-151">Dans VSS, « non sélectionnable » signifie « non facultatif ».</span><span class="sxs-lookup"><span data-stu-id="21076-151">In VSS, "not selectable" means "not optional."</span></span> <span data-ttu-id="21076-152">Ainsi, le demandeur doit les sauvegarder dans le cadre de l’état du système.</span><span class="sxs-lookup"><span data-stu-id="21076-152">Thus, the requester is required to back them up as part of system state.</span></span> <span data-ttu-id="21076-153">Pour plus d’informations, consultez [sauvegarde et restauration](locating-additional-system-files.md)de l’état du système.</span><span class="sxs-lookup"><span data-stu-id="21076-153">For more information, see [Backing Up and Restoring System State](locating-additional-system-files.md).</span></span> <span data-ttu-id="21076-154">Les composants pour lesquels l’indicateur de l’état du système du service de configuration n' \_ \_ est pas défini ne \_ \_ sont pas critiques du système.</span><span class="sxs-lookup"><span data-stu-id="21076-154">Components for which the VSS\_CF\_NOT\_SYSTEM\_STATE flag is set are not system-critical.</span></span>
    > [!Note]  
    > <span data-ttu-id="21076-155">Le composant ASR est un composant critique du système qui est signalé par l’Enregistreur ASR.</span><span class="sxs-lookup"><span data-stu-id="21076-155">The ASR component is a system-critical component that is reported by the ASR writer.</span></span>

     

-   <span data-ttu-id="21076-156">Disques.</span><span class="sxs-lookup"><span data-stu-id="21076-156">Disks.</span></span> <span data-ttu-id="21076-157">Chaque disque fixe de l’ordinateur est exposé en tant que composant dans ASR.</span><span class="sxs-lookup"><span data-stu-id="21076-157">Every fixed disk on the computer is exposed as a component in ASR.</span></span> <span data-ttu-id="21076-158">Si un disque n’a pas été exclu lors de la sauvegarde, il sera affecté lors de la restauration et peut être recréé et reformaté.</span><span class="sxs-lookup"><span data-stu-id="21076-158">If a disk was not excluded during backup, it will be assigned during restore and can be re-created and reformatted.</span></span> <span data-ttu-id="21076-159">Notez que pendant la restauration, le demandeur peut toujours recréer un disque qui a été exclu pendant la sauvegarde en appelant la méthode [**IVssBackupComponents :: SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) .</span><span class="sxs-lookup"><span data-stu-id="21076-159">Note that during restore, the requester can still re-create a disk that was excluded during backup by calling the [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) method.</span></span> <span data-ttu-id="21076-160">Si un disque d’un pack de disques dynamique est sélectionné, tous les autres disques de ce Pack doivent également être sélectionnés.</span><span class="sxs-lookup"><span data-stu-id="21076-160">If one disk in a dynamic disk pack is selected, all other disks in that pack must also be selected.</span></span> <span data-ttu-id="21076-161">Si un volume est sélectionné parce qu’il s’agit d’un volume critique (autrement dit, un volume qui contient des informations sur l’état du système), chaque disque contenant une étendue pour ce volume doit également être sélectionné.</span><span class="sxs-lookup"><span data-stu-id="21076-161">If a volume is selected because it is a critical volume (that is, a volume that contains system state information), every disk that contains an extent for that volume must also be selected.</span></span> <span data-ttu-id="21076-162">Pour rechercher les étendues d’un volume, utilisez le code de contrôle d' [**\_ \_ \_ \_ \_ étendues du disque**](/windows/win32/api/winioctl/ni-winioctl-ioctl_volume_get_volume_disk_extents) du volume de la récupération du volume ioctl.</span><span class="sxs-lookup"><span data-stu-id="21076-162">To find the extents for a volume, use the [**IOCTL\_VOLUME\_GET\_VOLUME\_DISK\_EXTENTS**](/windows/win32/api/winioctl/ni-winioctl-ioctl_volume_get_volume_disk_extents) control code.</span></span>

    > [!Note]  
    > <span data-ttu-id="21076-163">Pendant la sauvegarde, le demandeur doit inclure tous les disques fixes.</span><span class="sxs-lookup"><span data-stu-id="21076-163">During backup, the requester should include all fixed disks.</span></span> <span data-ttu-id="21076-164">Si le disque qui contient le jeu de sauvegarde du demandeur est un disque local, ce disque doit être inclus.</span><span class="sxs-lookup"><span data-stu-id="21076-164">If the disk that contains the requester's backup set is a local disk, this disk should be included.</span></span> <span data-ttu-id="21076-165">Pendant la restauration, le demandeur doit exclure le disque qui contient le jeu de sauvegarde du demandeur pour empêcher son remplacement.</span><span class="sxs-lookup"><span data-stu-id="21076-165">During restore, the requester must exclude the disk that contains the requester's backup set to prevent it from being overwritten.</span></span>

     

    <span data-ttu-id="21076-166">Dans un environnement de clustering, la récupération automatique du système ne recrée pas la disposition des disques partagés du cluster.</span><span class="sxs-lookup"><span data-stu-id="21076-166">In a clustering environment, ASR does not re-create the layout of the cluster's shared disks.</span></span> <span data-ttu-id="21076-167">Ces disques doivent être restaurés en ligne après la restauration du système d’exploitation dans Windows RE.</span><span class="sxs-lookup"><span data-stu-id="21076-167">Those disks should be restored online after the operating system is restored in the Windows RE.</span></span>

-   <span data-ttu-id="21076-168">Magasin Données de configuration de démarrage (BCD) (BCD).</span><span class="sxs-lookup"><span data-stu-id="21076-168">Boot Configuration Data (BCD) store.</span></span> <span data-ttu-id="21076-169">Ce composant spécifie le chemin d’accès du répertoire qui contient le magasin BCD.</span><span class="sxs-lookup"><span data-stu-id="21076-169">This component specifies the path of the directory that contains the BCD store.</span></span> <span data-ttu-id="21076-170">Le demandeur doit spécifier ce composant et sauvegarder tous les fichiers du répertoire du magasin BCD.</span><span class="sxs-lookup"><span data-stu-id="21076-170">The requester must specify this component and back up all of the files in the BCD store directory.</span></span> <span data-ttu-id="21076-171">Pour plus d’informations sur le magasin BCD, consultez [à propos de BCD](/previous-versions/windows/desktop/bcd/about-bcd).</span><span class="sxs-lookup"><span data-stu-id="21076-171">For more information about the BCD store, see [About BCD](/previous-versions/windows/desktop/bcd/about-bcd).</span></span>
    > [!Note]  
    > <span data-ttu-id="21076-172">Sur les ordinateurs qui utilisent l’interface EFI (Extended firmware interface), la partition système EFI (ESP) est toujours masquée et ne peut pas être incluse dans un cliché instantané de volume.</span><span class="sxs-lookup"><span data-stu-id="21076-172">On computers that use the Extended Firmware Interface (EFI), the EFI System Partition (ESP) is always hidden and cannot be included in a volume shadow copy.</span></span> <span data-ttu-id="21076-173">Le demandeur doit sauvegarder le contenu de cette partition.</span><span class="sxs-lookup"><span data-stu-id="21076-173">The requester must back up the contents of this partition.</span></span> <span data-ttu-id="21076-174">Étant donné que cette partition ne peut pas être incluse dans un cliché instantané de volume, la sauvegarde ne peut être effectuée qu’à partir du volume actif, et non à partir du cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="21076-174">Because this partition cannot be included in a volume shadow copy, the backup can only be performed from the live volume, not from the shadow copy.</span></span> <span data-ttu-id="21076-175">Pour plus d’informations sur EFI et ESP, consultez la rubrique afficher le [Guide](/windows-hardware/drivers/bringup/).</span><span class="sxs-lookup"><span data-stu-id="21076-175">For more information about EFI and ESP, see [Bring up guide](/windows-hardware/drivers/bringup/).</span></span>

<span data-ttu-id="21076-176">Les noms des composants utilisent les formats suivants :</span><span class="sxs-lookup"><span data-stu-id="21076-176">The component names use the following formats:</span></span>

-   <span data-ttu-id="21076-177">Pour les composants de disque, le format est</span><span class="sxs-lookup"><span data-stu-id="21076-177">For disk components, the format is</span></span>

    <COMPONENT logicalPath="Disks" componentName="harddisk*n*" componentType="filegroup" />

    <span data-ttu-id="21076-178">où *n* est le numéro du disque.</span><span class="sxs-lookup"><span data-stu-id="21076-178">where *n* is the disk number.</span></span> <span data-ttu-id="21076-179">Seul le numéro de disque est enregistré.</span><span class="sxs-lookup"><span data-stu-id="21076-179">Only the disk number is recorded.</span></span> <span data-ttu-id="21076-180">Pour récupérer le numéro du disque, utilisez le code de contrôle de l' [**\_ \_ \_ \_ appareil de stockage IOCTL**](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_get_device_number) .</span><span class="sxs-lookup"><span data-stu-id="21076-180">To get the disk number, use the [**IOCTL\_STORAGE\_GET\_DEVICE\_NUMBER**](/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_get_device_number) control code.</span></span>

-   <span data-ttu-id="21076-181">Pour les composants de volume, le format est</span><span class="sxs-lookup"><span data-stu-id="21076-181">For volume components, the format is</span></span>

    <COMPONENT logicalPath="Volumes" componentName="Volume{*GUID*}" componentType="filegroup" />

    <span data-ttu-id="21076-182">où *GUID* est le GUID du volume.</span><span class="sxs-lookup"><span data-stu-id="21076-182">where *GUID* is the volume GUID.</span></span>

-   <span data-ttu-id="21076-183">Pour le composant magasin BCD, le format est</span><span class="sxs-lookup"><span data-stu-id="21076-183">For the BCD store component, the format is</span></span>

    <COMPONENT logicalPath="BCD" componentName="BCD" componentType="filegroup" componentCaption = "This is the path to the boot BCD store and the boot managers...All the files in this directory need to be backed up...">

    <span data-ttu-id="21076-184">Si la partition système a un nom de GUID de volume, ce composant peut être sélectionné.</span><span class="sxs-lookup"><span data-stu-id="21076-184">If the system partition has a volume GUID name, this component is selectable.</span></span> <span data-ttu-id="21076-185">Dans le cas contraire, il ne peut pas être sélectionné.</span><span class="sxs-lookup"><span data-stu-id="21076-185">Otherwise, it is not selectable.</span></span>

    > [!Note]  
    > <span data-ttu-id="21076-186">La récupération automatique du système ajoute les fichiers au groupe de fichiers du composant de stockage BCD comme suit :</span><span class="sxs-lookup"><span data-stu-id="21076-186">ASR adds the files to the BCD store component's file group as follows:</span></span>
    >
    > -   <span data-ttu-id="21076-187">Pour les disques EFI, l’ASR ajoute</span><span class="sxs-lookup"><span data-stu-id="21076-187">For EFI disks, ASR adds</span></span>
    >
    >     <span data-ttu-id="21076-188">*SystemPartitionPath* \\ \\Démarrage de Microsoft EFI \\ \\ \* .\*</span><span class="sxs-lookup"><span data-stu-id="21076-188">*SystemPartitionPath*\\EFI\\Microsoft\\Boot\\\*.\*</span></span>
    >
    >     <span data-ttu-id="21076-189">où *SystemPartitionPath* est le chemin d’accès à la partition système.</span><span class="sxs-lookup"><span data-stu-id="21076-189">where *SystemPartitionPath* is the path to the system partition.</span></span>
    >
    > -   <span data-ttu-id="21076-190">Pour les disques GPT, l’ASR ajoute</span><span class="sxs-lookup"><span data-stu-id="21076-190">For GPT disks, ASR adds</span></span>
    >
    >     <span data-ttu-id="21076-191">*SystemPartitionPath* \\ Démarrez \\ \* .\*</span><span class="sxs-lookup"><span data-stu-id="21076-191">*SystemPartitionPath*\\Boot\\\*.\*</span></span>
    >
    >     <span data-ttu-id="21076-192">où *SystemPartitionPath* est le chemin d’accès à la partition système.</span><span class="sxs-lookup"><span data-stu-id="21076-192">where *SystemPartitionPath* is the path to the system partition.</span></span>
    >
    > -   <span data-ttu-id="21076-193">Le chemin d’accès de la partition système se trouve sous la clé de Registre suivante : **HKEY \_ local \_ machine** \\ **System** \\ **Setup** \\ **SystemPartition**</span><span class="sxs-lookup"><span data-stu-id="21076-193">The system partition path can be found under the following registry key: **HKEY\_LOCAL\_MACHINE**\\**System**\\**Setup**\\**SystemPartition**</span></span>

     

<span data-ttu-id="21076-194">Lors de la restauration, tous les composants marqués comme volumes critiques doivent être restaurés.</span><span class="sxs-lookup"><span data-stu-id="21076-194">On restore, all components that are marked as critical volumes must be restored.</span></span> <span data-ttu-id="21076-195">Si un ou plusieurs volumes critiques ne peuvent pas être restaurés, l’opération de restauration échoue.</span><span class="sxs-lookup"><span data-stu-id="21076-195">If one or more critical volumes cannot be restored, the restore operation fails.</span></span>

<span data-ttu-id="21076-196">Dans la phase de [**prérestauration**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) de la séquence de restauration, les disques qui n’ont pas été exclus lors de la sauvegarde sont recréés et reformatés par défaut.</span><span class="sxs-lookup"><span data-stu-id="21076-196">In the [**PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) phase of the restore sequence, disks that were not excluded during backup are re-created and reformatted by default.</span></span> <span data-ttu-id="21076-197">Toutefois, ils ne sont pas recréés ou reformatés s’ils remplissent les conditions suivantes :</span><span class="sxs-lookup"><span data-stu-id="21076-197">However, they are not re-created or reformatted if they meet the following conditions:</span></span>

-   <span data-ttu-id="21076-198">Un disque de base n’est pas recréé si sa disposition du disque est intacte ou si seules des modifications supplémentaires ont été apportées à celui-ci.</span><span class="sxs-lookup"><span data-stu-id="21076-198">A basic disk is not re-created if its disk layout is intact or only additive changes have been made to it.</span></span> <span data-ttu-id="21076-199">La disposition du disque est intacte si les conditions suivantes sont remplies :</span><span class="sxs-lookup"><span data-stu-id="21076-199">The disk layout is intact if the following conditions are true:</span></span>
    -   <span data-ttu-id="21076-200">La signature de disque, le style de disque (GPT ou MBR), la taille de secteur logique et le décalage de début de volume ne sont pas modifiés.</span><span class="sxs-lookup"><span data-stu-id="21076-200">The disk signature, disk style (GPT or MBR), logical sector size, and volume start offset are not changed.</span></span>
    -   <span data-ttu-id="21076-201">La taille du volume n’est pas réduite.</span><span class="sxs-lookup"><span data-stu-id="21076-201">The volume size is not decreased.</span></span>
    -   <span data-ttu-id="21076-202">Pour les disques GPT, l’identificateur de partition n’est pas modifié.</span><span class="sxs-lookup"><span data-stu-id="21076-202">For GPT disks, the partition identifier is not changed.</span></span>
-   <span data-ttu-id="21076-203">Un disque dynamique n’est pas recréé si sa disposition du disque est intacte ou si seules des modifications supplémentaires ont été apportées à celui-ci.</span><span class="sxs-lookup"><span data-stu-id="21076-203">A dynamic disk is not re-created if its disk layout is intact or only additive changes have been made to it.</span></span> <span data-ttu-id="21076-204">Pour qu’un disque dynamique soit intact, toutes les conditions d’un disque de base doivent être remplies.</span><span class="sxs-lookup"><span data-stu-id="21076-204">For a dynamic disk to be intact, all of the conditions for a basic disk must be met.</span></span> <span data-ttu-id="21076-205">En outre, la structure du volume de l’ensemble du disque dur doit être intacte.</span><span class="sxs-lookup"><span data-stu-id="21076-205">In addition, the entire disk pack's volume structure must be intact.</span></span> <span data-ttu-id="21076-206">La structure du volume du Pack de disque est intacte si elle remplit les conditions suivantes, qui s’appliquent aux disques MBR et GPT :</span><span class="sxs-lookup"><span data-stu-id="21076-206">The disk pack's volume structure is intact if it meets the following conditions, which apply to both MBR and GPT disks:</span></span>
    -   <span data-ttu-id="21076-207">Le nombre de volumes disponibles dans le Pack physique durant la restauration doit être supérieur ou égal au nombre de volumes spécifiés dans les métadonnées de l’Enregistreur ASR lors de la sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="21076-207">The number of volumes that are available in the physical pack during restore must be greater than or equal to the number of volumes that were specified in the ASR writer metadata during backup.</span></span>
    -   <span data-ttu-id="21076-208">Le nombre de [*Plex*](../vds/virtual-disk-service-glossary-all.md) par volume doit être inchangé.</span><span class="sxs-lookup"><span data-stu-id="21076-208">The number of [*plexes*](../vds/virtual-disk-service-glossary-all.md) per volume must be unchanged.</span></span>
    -   <span data-ttu-id="21076-209">Le nombre de [*membres*](../vds/virtual-disk-service-glossary-all.md) doit être inchangé.</span><span class="sxs-lookup"><span data-stu-id="21076-209">The number of [*members*](../vds/virtual-disk-service-glossary-all.md) must be unchanged.</span></span>
    -   <span data-ttu-id="21076-210">Le nombre d’étendues de disque physique doit être supérieur au nombre d’étendues de disque spécifiées dans les métadonnées de l’Enregistreur ASR.</span><span class="sxs-lookup"><span data-stu-id="21076-210">The number of physical disk extents must be greater than the number of disk extents specified in the ASR writer metadata.</span></span>
    -   <span data-ttu-id="21076-211">Un pack intact reste intact lors de l’ajout de volumes supplémentaires, ou si un volume du Pack est étendu (par exemple, d’un volume simple à un volume fractionné).</span><span class="sxs-lookup"><span data-stu-id="21076-211">An intact pack remains intact when additional volumes are added, or if a volume in the pack is extended (for example, from a simple volume to a spanned volume).</span></span>
        > [!Note]  
        > <span data-ttu-id="21076-212">Si un volume simple est mis en miroir, le Pack n’est pas intact et sera recréé pour garantir que l’état du volume BCD et du volume de démarrage reste cohérent après la restauration.</span><span class="sxs-lookup"><span data-stu-id="21076-212">If a simple volume is mirrored, the pack is not intact and will be re-created to ensure that the BCD and boot volume state remain consistent after restore.</span></span> <span data-ttu-id="21076-213">Si des volumes sont supprimés, le Pack est recréé.</span><span class="sxs-lookup"><span data-stu-id="21076-213">If volumes are deleted, the pack is re-created.</span></span>

         
-   <span data-ttu-id="21076-214">Si la structure du volume du Pack de disque dynamique est intacte et que seules des modifications supplémentaires ont été apportées à celui-ci, les disques du Pack ne sont pas recréés.</span><span class="sxs-lookup"><span data-stu-id="21076-214">If the dynamic disk pack's volume structure is intact and only additive changes have been made to it, the disks in the pack are not re-created.</span></span>

    <span data-ttu-id="21076-215">**Windows Vista :** Les disques dynamiques sont toujours recréés.</span><span class="sxs-lookup"><span data-stu-id="21076-215">**Windows Vista:** Dynamic disks are always re-created.</span></span> <span data-ttu-id="21076-216">Notez que ce comportement a changé avec Windows Server 2008 et Windows Vista avec Service Pack 1 (SP1).</span><span class="sxs-lookup"><span data-stu-id="21076-216">Note that this behavior has changed with Windows Server 2008 and Windows Vista with Service Pack 1 (SP1).</span></span>

<span data-ttu-id="21076-217">À tout moment avant le début de la phase de restauration, le demandeur peut spécifier que les disques doivent être au format rapide en définissant la clé de Registre **HKEY \_ local \_ machine** \\ **Software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **RestoreSession** .</span><span class="sxs-lookup"><span data-stu-id="21076-217">At any time before the beginning of the restore phase, the requester can specify that the disks should be quick-formatted by setting the **HKEY\_LOCAL\_MACHINE**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession** registry key.</span></span> <span data-ttu-id="21076-218">Sous cette clé, il existe une valeur nommée **QuickFormat** avec le type de données « reg \_ DWORD ».</span><span class="sxs-lookup"><span data-stu-id="21076-218">Under this key, there is a value named **QuickFormat** with the data type REG\_DWORD.</span></span> <span data-ttu-id="21076-219">Si cette valeur n’existe pas, vous devez la créer.</span><span class="sxs-lookup"><span data-stu-id="21076-219">If this value does not exist, you should create it.</span></span> <span data-ttu-id="21076-220">Définissez les données de la valeur **QuickFormat** sur 1 pour la mise en forme rapide ou sur 0 pour une mise en forme lente.</span><span class="sxs-lookup"><span data-stu-id="21076-220">Set the data of the **QuickFormat** value to 1 for quick formatting or 0 for slow formatting.</span></span>

<span data-ttu-id="21076-221">Si la valeur **QuickFormat** n’existe pas, les disques seront au format lent.</span><span class="sxs-lookup"><span data-stu-id="21076-221">If the **QuickFormat** value does not exist, the disks will be slow-formatted.</span></span>

<span data-ttu-id="21076-222">La mise en forme rapide est beaucoup plus rapide que la mise en forme lente (également appelée mise en forme complète).</span><span class="sxs-lookup"><span data-stu-id="21076-222">Quick formatting is significantly faster than slow formatting (also called full formatting).</span></span> <span data-ttu-id="21076-223">Toutefois, le formatage rapide ne vérifie pas chaque secteur sur le volume.</span><span class="sxs-lookup"><span data-stu-id="21076-223">However, quick formatting does not verify each sector on the volume.</span></span>

## <a name="overview-of-restore-phase-tasks"></a><span data-ttu-id="21076-224">Vue d’ensemble des tâches de la phase de restauration</span><span class="sxs-lookup"><span data-stu-id="21076-224">Overview of Restore Phase Tasks</span></span>

<span data-ttu-id="21076-225">Au moment de la restauration, le demandeur effectue les étapes suivantes :</span><span class="sxs-lookup"><span data-stu-id="21076-225">At restore time, the requester performs the following steps:</span></span>

> [!Note]  
> <span data-ttu-id="21076-226">Toutes les étapes sont requises sauf indication contraire.</span><span class="sxs-lookup"><span data-stu-id="21076-226">All steps are required unless otherwise indicated.</span></span>

 

1.  <span data-ttu-id="21076-227">Appelez la fonction [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) pour créer une instance de l’interface [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) et appelez la méthode [**IVssBackupComponents :: InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) pour initialiser l’instance pour la restauration en chargeant le document des composants de sauvegarde du demandeur dans l’instance.</span><span class="sxs-lookup"><span data-stu-id="21076-227">Call the [**CreateVssBackupComponents**](/windows/desktop/api/VsBackup/nf-vsbackup-createvssbackupcomponents) function to create an instance of the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) interface and call the [**IVssBackupComponents::InitializeForRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-initializeforrestore) method to initialize the instance for restore by loading the requester's Backup Components Document into the instance.</span></span>
2.  <span data-ttu-id="21076-228">\[Cette étape est requise uniquement si le demandeur doit changer si « IncludeDisk » ou « ExcludeDisk » est spécifié pour un ou plusieurs disques. \] Appelez [**IVssBackupComponents :: SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) pour définir les options de restauration des composants de l’Enregistreur ASR.</span><span class="sxs-lookup"><span data-stu-id="21076-228">\[This step is required only if the requester needs to change whether "IncludeDisk" or "ExcludeDisk" is specified for one or more disks.\] Call [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) to set the restore options for the ASR writer components.</span></span> <span data-ttu-id="21076-229">Le rédacteur ASR prend en charge les options suivantes : « IncludeDisk » permet au demandeur d’inclure un disque sur le système cible à prendre en compte pour la restauration, même s’il n’a pas été sélectionné pendant la phase de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="21076-229">The ASR writer supports the following options: "IncludeDisk" allows the requester to include a disk on the target system to be considered for restore, even if it was not selected during the backup phase.</span></span> <span data-ttu-id="21076-230">« ExcludeDisk » permet au demandeur d’empêcher la recréation d’un disque sur le système cible.</span><span class="sxs-lookup"><span data-stu-id="21076-230">"ExcludeDisk" allows the requester to prevent a disk on the target system from being re-created.</span></span> <span data-ttu-id="21076-231">Notez que si « ExcludeDisk » est spécifié pour un disque contenant un volume critique, l’appel suivant à [**IVssBackupComponents ::P Restore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) échoue.</span><span class="sxs-lookup"><span data-stu-id="21076-231">Note that if "ExcludeDisk" is specified for a disk that contains a critical volume, the subsequent call to [**IVssBackupComponents::PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) will fail.</span></span>

    <span data-ttu-id="21076-232">L’exemple suivant montre comment utiliser [**SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) pour empêcher la recréation du disque 0 et du disque 1 et injecter des pilotes tiers dans le volume de démarrage restauré.</span><span class="sxs-lookup"><span data-stu-id="21076-232">The following example shows how to use [**SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) to prevent disk 0 and disk 1 from being re-created and inject third-party drivers into the restored boot volume.</span></span>

    <span data-ttu-id="21076-233">**Windows server 2008, Windows Vista, Windows server 2003 et Windows XP :** L’injection de pilotes tiers n’est pas prise en charge.</span><span class="sxs-lookup"><span data-stu-id="21076-233">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** Injection of third-party drivers is not supported.</span></span>

    <span data-ttu-id="21076-234">L’exemple suppose que le pointeur [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) , m \_ pBackupComponents, est valide.</span><span class="sxs-lookup"><span data-stu-id="21076-234">The example assumes that the [**IVssBackupComponents**](/windows/desktop/api/VsBackup/nl-vsbackup-ivssbackupcomponents) pointer, m\_pBackupComponents, is valid.</span></span>

    ```C++
        m_pBackupComponents->SetRestoreOptions(
            AsrWriterId,
            VSS_CT_FILEGROUP,
            NULL,
            TEXT("ASR"),
            TEXT("\"ExcludeDisk\"=\"0\", \"ExcludeDisk\"=\"1\" "),
            TEXT("\"InjectDrivers\"=\"1\" ")
            );
    ```

    

    <span data-ttu-id="21076-235">Pour exclure tous les disques d’un volume spécifié, reportez-vous à la section « exclusion de tous les disques d’un volume ».</span><span class="sxs-lookup"><span data-stu-id="21076-235">To exclude all disks for a specified volume, see the following "Excluding All Disks for a Volume."</span></span>

3.  <span data-ttu-id="21076-236">Appelez [**IVssBackupComponents ::P Restore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) pour indiquer à l’Enregistreur ASR de se préparer à une opération de restauration.</span><span class="sxs-lookup"><span data-stu-id="21076-236">Call [**IVssBackupComponents::PreRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-prerestore) to notify the ASR writer to prepare for a restore operation.</span></span> <span data-ttu-id="21076-237">Appelez [**IVssAsync :: QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) autant de fois que nécessaire jusqu’à ce que la valeur d’État retournée dans le paramètre *pHrResult* ne soit pas VSS \_ S \_ Async \_ en attente.</span><span class="sxs-lookup"><span data-stu-id="21076-237">Call [**IVssAsync::QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) as many times as necessary until the status value returned in the *pHrResult* parameter is not VSS\_S\_ASYNC\_PENDING.</span></span>
4.  <span data-ttu-id="21076-238">Restaurer les données.</span><span class="sxs-lookup"><span data-stu-id="21076-238">Restore the data.</span></span> <span data-ttu-id="21076-239">Au cours de la phase de restauration, ASR reconfigure le chemin d’accès au GUID du volume ( \\ \\ ? \\ Volume {GUID}) pour chaque volume afin qu’il corresponde au chemin d’accès du GUID de volume utilisé pendant la phase de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="21076-239">In the restore phase, ASR reconfigures the volume GUID path (\\\\?\\Volume{GUID}) for each volume to match the volume GUID path that was used during the backup phase.</span></span> <span data-ttu-id="21076-240">Toutefois, les lettres de lecteur ne sont pas conservées, car cela entraînerait des collisions avec les lettres de lecteur qui sont automatiquement affectées dans l’environnement de récupération.</span><span class="sxs-lookup"><span data-stu-id="21076-240">However, drive letters are not preserved, because this would cause collisions with the drive letters that are automatically assigned in the recovery environment.</span></span> <span data-ttu-id="21076-241">Ainsi, lors de la restauration de données, le demandeur doit utiliser des chemins d’accès de GUID de volume, et non des lettres de lecteur, pour accéder aux volumes.</span><span class="sxs-lookup"><span data-stu-id="21076-241">Thus, when restoring data, the requester must use volume GUID paths, not drive letters, to access the volumes.</span></span>
5.  <span data-ttu-id="21076-242">Définissez la  \\  \\ clé de Registre HKLM Software **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **RestoreSession** pour indiquer l’ensemble des volumes qui ont été restaurés ou reformatés.</span><span class="sxs-lookup"><span data-stu-id="21076-242">Set the **HKLM**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession** registry key to indicate the set of volumes that have been restored or reformatted.</span></span>

    <span data-ttu-id="21076-243">Sous cette clé, il existe une valeur nommée **RestoredVolumes** avec le type de données reg \_ multi \_ sz.</span><span class="sxs-lookup"><span data-stu-id="21076-243">Under this key, there is a value named **RestoredVolumes** with the data type REG\_MULTI\_SZ.</span></span> <span data-ttu-id="21076-244">Si cette valeur n’existe pas, vous devez la créer.</span><span class="sxs-lookup"><span data-stu-id="21076-244">If this value does not exist, you should create it.</span></span> <span data-ttu-id="21076-245">Sous cette valeur, votre demandeur doit créer une entrée de GUID de volume pour chaque volume qui a été restauré.</span><span class="sxs-lookup"><span data-stu-id="21076-245">Under this value, your requester should create a volume GUID entry for each volume that has been restored.</span></span> <span data-ttu-id="21076-246">Cette entrée doit être au format suivant : \\ \\ ? \\ Volume {78618c8f-aefd-11da-A898-806e6f6e6963}.</span><span class="sxs-lookup"><span data-stu-id="21076-246">This entry should be in the following format: \\\\?\\Volume{78618c8f-aefd-11da-a898-806e6f6e6963}.</span></span> <span data-ttu-id="21076-247">À chaque fois qu’une récupération complète est effectuée, la récupération automatique du système définit la valeur **RestoredVolumes** sur l’ensemble des volumes restaurés par ASR.</span><span class="sxs-lookup"><span data-stu-id="21076-247">Each time a bare-metal recovery is performed, ASR sets the **RestoredVolumes** value to the set of volumes that ASR restored.</span></span> <span data-ttu-id="21076-248">Si le demandeur a restauré des volumes supplémentaires, il doit définir cette valeur sur l’Union de l’ensemble des volumes restaurés par le demandeur et l’ensemble des volumes restaurés par ASR.</span><span class="sxs-lookup"><span data-stu-id="21076-248">If the requester restored additional volumes, it should set this value to the union of the set of volumes that the requester restored and the set of volumes that ASR restored.</span></span> <span data-ttu-id="21076-249">Si le demandeur n’utilise pas ASR, il doit remplacer la liste des volumes.</span><span class="sxs-lookup"><span data-stu-id="21076-249">If the requester did not use ASR, it should replace the list of volumes.</span></span>

    <span data-ttu-id="21076-250">Vous devez également créer une valeur nommée **LastInstance** avec le type de données « reg \_ sz ».</span><span class="sxs-lookup"><span data-stu-id="21076-250">You should also create a value named **LastInstance** with the data type REG\_SZ.</span></span> <span data-ttu-id="21076-251">Cette clé doit contenir un cookie aléatoire qui identifie de façon unique l’opération de restauration en cours.</span><span class="sxs-lookup"><span data-stu-id="21076-251">This key should contain a random cookie that uniquely identifies the current restore operation.</span></span> <span data-ttu-id="21076-252">Un cookie de ce type peut être créé à l’aide des fonctions [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) et [**UuidToString**](/windows/win32/api/rpcdce/nf-rpcdce-uuidtostring) .</span><span class="sxs-lookup"><span data-stu-id="21076-252">Such a cookie can be created by using the [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) and [**UuidToString**](/windows/win32/api/rpcdce/nf-rpcdce-uuidtostring) functions.</span></span> <span data-ttu-id="21076-253">À chaque fois qu’une récupération complète est effectuée, ASR réinitialise cette valeur de Registre pour notifier les demandeurs et les applications de sauvegarde non-VSS que la récupération s’est produite.</span><span class="sxs-lookup"><span data-stu-id="21076-253">Each time a bare-metal recovery is performed, ASR resets this registry value to notify requesters and non-VSS backup applications that the recovery has occurred.</span></span>

6.  <span data-ttu-id="21076-254">Appelez [**IVssBackupComponents ::P ostrestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) pour indiquer la fin de l’opération de restauration.</span><span class="sxs-lookup"><span data-stu-id="21076-254">Call [**IVssBackupComponents::PostRestore**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-postrestore) to indicate the end of the restore operation.</span></span> <span data-ttu-id="21076-255">Appelez [**IVssAsync :: QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) autant de fois que nécessaire jusqu’à ce que la valeur d’État retournée dans le paramètre *pHrResult* ne soit pas VSS \_ S \_ Async \_ en attente.</span><span class="sxs-lookup"><span data-stu-id="21076-255">Call [**IVssAsync::QueryStatus**](/windows/desktop/api/Vss/nf-vss-ivssasync-querystatus) as many times as necessary until the status value returned in the *pHrResult* parameter is not VSS\_S\_ASYNC\_PENDING.</span></span>

<span data-ttu-id="21076-256">Au cours de la phase de restauration, la récupération automatique du système peut créer ou supprimer des partitions pour restaurer l’ordinateur à son état précédent.</span><span class="sxs-lookup"><span data-stu-id="21076-256">In the restore phase, ASR may create or remove partitions to restore the computer to its previous state.</span></span> <span data-ttu-id="21076-257">Les demandeurs ne doivent pas essayer de mapper les numéros de disque de la phase de sauvegarde à la phase de restauration.</span><span class="sxs-lookup"><span data-stu-id="21076-257">Requesters must not attempt to map disk numbers from the backup phase to the restore phase.</span></span>

<span data-ttu-id="21076-258">Lors de la restauration, le demandeur doit exclure le disque qui contient le jeu de sauvegarde du demandeur.</span><span class="sxs-lookup"><span data-stu-id="21076-258">On restore, the requester must exclude the disk that contains the requester's backup set.</span></span> <span data-ttu-id="21076-259">Dans le cas contraire, le jeu de sauvegarde peut être remplacé par l’opération de restauration.</span><span class="sxs-lookup"><span data-stu-id="21076-259">Otherwise, the backup set can be overwritten by the restore operation.</span></span>

<span data-ttu-id="21076-260">Lors de la restauration, un disque est exclu s’il n’a pas été sélectionné en tant que composant lors de la sauvegarde, ou s’il est explicitement exclu en appelant [**IVssBackupComponents :: SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) avec l’option « ExcludeDisk » lors de la restauration.</span><span class="sxs-lookup"><span data-stu-id="21076-260">On restore, a disk is excluded if it was not selected as a component during backup, or if it is explicitly excluded by calling [**IVssBackupComponents::SetRestoreOptions**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-setrestoreoptions) with the "ExcludeDisk" option during restore.</span></span>

<span data-ttu-id="21076-261">Il est important de noter que lors de la récupération d’urgence de WinPE, la fonctionnalité d’enregistreur ASR est présente, mais aucun autre Writer n’est disponible et le service VSS n’est pas en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="21076-261">It is important to note that during WinPE disaster recovery, ASR writer functionality is present, but no other writers are available, and the VSS service is not running.</span></span> <span data-ttu-id="21076-262">Une fois la récupération d’urgence de WinPE terminée, l’ordinateur a redémarré et le système d’exploitation Windows s’exécute normalement, le service VSS peut être démarré et le demandeur peut effectuer des opérations de restauration supplémentaires qui nécessitent la participation d’enregistreurs autres que le rédacteur ASR.</span><span class="sxs-lookup"><span data-stu-id="21076-262">After WinPE disaster recovery has completed, the computer has restarted, and the Windows operating system is running normally, the VSS service can be started, and the requester can perform any additional restore operations that require participation of writers other than the ASR writer.</span></span>

<span data-ttu-id="21076-263">Si, au cours de la session de restauration, l’application de sauvegarde détecte que les ID uniques du volume ne sont pas modifiés, et que tous les volumes de l’heure de la sauvegarde sont présents et intacts dans WinPE, l’application de sauvegarde peut continuer à restaurer uniquement le contenu des volumes, sans impliquer la récupération automatique du système.</span><span class="sxs-lookup"><span data-stu-id="21076-263">If during the restore session the backup application detects that the volume unique IDs are unchanged, and therefore all volumes from the time of the backup are present and intact in WinPE, the backup application can proceed to restore only the contents of the volumes, without involving ASR.</span></span> <span data-ttu-id="21076-264">Dans ce cas, l’application de sauvegarde doit indiquer que l’ordinateur a été restauré en définissant la clé de Registre suivante dans le système d’exploitation restauré : **HKEY \_ local \_ machine** \\ **Software** \\ **Microsoft** \\ **Windows NT** \\ **CurrentVersion** \\ **ASR** \\ **RestoreSession**</span><span class="sxs-lookup"><span data-stu-id="21076-264">In this case, the backup application should indicate that the computer was restored by setting the following registry key in the restored operating system: **HKEY\_LOCAL\_MACHINE**\\**SOFTWARE**\\**Microsoft**\\**Windows NT**\\**CurrentVersion**\\**ASR**\\**RestoreSession**</span></span>

<span data-ttu-id="21076-265">Sous cette clé, spécifiez **LastInstance** pour le nom de la valeur, reg \_ SZ pour le type de valeur et un cookie aléatoire (tel qu’un GUID créé par la fonction [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) ) pour les données de la valeur.</span><span class="sxs-lookup"><span data-stu-id="21076-265">Under this key, specify **LastInstance** for the value name, REG\_SZ for the value type, and a random cookie (such as a GUID created by the [**UuidCreate**](/windows/win32/api/rpcdce/nf-rpcdce-uuidcreate) function) for the value data.</span></span>

<span data-ttu-id="21076-266">Si, au cours de la session de restauration, l’application de sauvegarde détecte qu’un ou plusieurs volumes sont modifiés ou manquants, l’application de sauvegarde doit utiliser ASR pour effectuer la restauration.</span><span class="sxs-lookup"><span data-stu-id="21076-266">If during the restore session the backup application detects that one or more volumes are changed or missing, the backup application should use ASR to perform the restore.</span></span> <span data-ttu-id="21076-267">ASR recrée les volumes exactement comme ils l’étaient au moment de la sauvegarde et définit la clé de Registre **RestoreSession** .</span><span class="sxs-lookup"><span data-stu-id="21076-267">ASR will re-create the volumes exactly the way they were at the time of the backup and set the **RestoreSession** registry key.</span></span>

## <a name="excluding-all-disks-for-a-volume"></a><span data-ttu-id="21076-268">Exclusion de tous les disques d’un volume</span><span class="sxs-lookup"><span data-stu-id="21076-268">Excluding All Disks for a Volume</span></span>

<span data-ttu-id="21076-269">L’exemple suivant montre comment exclure tous les disques d’un volume spécifié.</span><span class="sxs-lookup"><span data-stu-id="21076-269">The following example shows how to exclude all disks for a specified volume.</span></span>


```C++
HRESULT BuildRestoreOptionString
(
    const WCHAR             *pwszVolumeNamePath,
    CMyString               *pstrExclusionList
)
{
    HANDLE                  hVolume           = INVALID_HANDLE_VALUE;
    DWORD                   cbSize            = 0;
    VOLUME_DISK_EXTENTS     * pExtents        = NULL;
    DISK_EXTENT             * pExtent         = NULL;
    ULONG                   i                 = 0;
    BOOL                    fIoRet            = FALSE;
    WCHAR                   wszDest[MAX_PATH] = L"";
    CMyString               strVolumeName;
    CMyString               strRestoreOption;

    // Open a handle to the volume device.
    strVolumeName.Set( pwszVolumeNamePath );
    // If the volume name contains a trailing backslash, remove it.
    strVolumeName.UnTrailing( L'\\' );
    hVolume = ::CreateFile(strVolumeName, 0, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, NULL, 0);
    // Check whether the call to CreateFile succeeded.

    // Get the list of disks used by this volume.
    cbSize = sizeof(VOLUME_DISK_EXTENTS);
    pExtents = (VOLUME_DISK_EXTENTS *)::CoTaskMemAlloc(cbSize);

    ::ZeroMemory(pExtents, cbSize);

    fIoRet = ::DeviceIoControl(hVolume, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, NULL, 0, pExtents, cbSize, &cbSize, 0);
    if ( !fIoRet && GetLastError() == ERROR_MORE_DATA )
    {
        // Allocate more memory.
        cbSize = FIELD_OFFSET(VOLUME_DISK_EXTENTS, Extents) + pExtents->NumberOfDiskExtents * sizeof(DISK_EXTENT);
        ::CoTaskMemFree(pExtents);
        pExtents = NULL;

        pExtents = (VOLUME_DISK_EXTENTS *) ::CoTaskMemAlloc(cbSize);
        // Check whether CoTaskMemAlloc returned an out-of-memory error.
        ::ZeroMemory(pExtents, cbSize);

        // Now the buffer should be big enough.
        ::DeviceIoControl(hVolume, IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS, NULL, 0, pExtents, cbSize, &cbSize, 0);
        // Check whether the IOCTL succeeded.
    }
    // Check for errors; note that the IOCTL can fail for a reason other than insufficient memory.

    // For each disk, mark it to be excluded in the Restore Option string.
    for (i = 0; i < pExtents->NumberOfDiskExtents; i++)
    {
        pExtent = &pExtents->Extents[i];

        *wszDest = L'\0';
        StringCchPrintf(wszDest, MAX_PATH, L"\"ExcludeDisk\"=\"%d\", ", pExtent->DiskNumber); // check errors

        strRestoreOption.Append(wszDest);
        // Check for an out-of-memory error.
    }

    // Remove the trailing comma.
    strRestoreOption.TrimRight();
    strRestoreOption.UnTrailing(',');

    // Set the output parameter.
    strRestoreOption.Transfer( pstrExclusionList );

Exit:
    if( pExtents )
    {
        ::CoTaskMemFree(pExtents);
        pExtents = NULL;
    }

    if( hVolume != INVALID_HANDLE_VALUE )
    {
        ::CloseHandle(hVolume);
        hVolume = INVALID_HANDLE_VALUE;
    }

    return ( hr );
}

```



 

 
