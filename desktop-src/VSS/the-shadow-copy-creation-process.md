---
description: Processus de création de clichés instantanés
ms.assetid: ca484eec-31c6-4790-9232-3ed67263f6fb
title: Processus de création de clichés instantanés
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4239e2b671edcaeb35b404d9b9411b43316c0212
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103751597"
---
# <a name="the-shadow-copy-creation-process"></a>Processus de création de clichés instantanés

Vous trouverez ci-dessous une description détaillée du rôle du fournisseur de matériel lors de la création d’un jeu de clichés instantanés. Pour obtenir un diagramme de ce processus, consultez [création de clichés instantanés pour les fournisseurs](shadow-copy-creation-for-providers.md).

1.  Au fur et à mesure que le demandeur ajoute chaque volume au jeu de clichés instantanés, VSS détermine les numéros d’unités logiques associés. Par exemple, un volume fractionné peut être composé de plusieurs numéros d’unité logique (LUN). VSS crée des [**informations de \_ lun \_ VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) initiales à l’aide d’informations sur l’appareil physique pour chaque numéro d’unité logique.
2.  VSS appelle [**AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) pour déterminer si le fournisseur prend en charge un cliché instantané pour ce numéro d’unité logique. Le fournisseur de matériel utilise [**les \_ \_ informations de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) pour déterminer si les numéros d’unités logiques sont pris en charge. Cette détermination doit être tout ou rien : le même fournisseur de matériel doit prendre en charge tous les numéros d’unités logiques contribuant à un volume spécifique. Dans l’exemple de volume fractionné, le fournisseur ne peut pas indiquer qu’il ne prend en charge qu’un seul des numéros d’unités logiques qui composent le volume.
3.  Pour chaque volume du jeu de clichés instantanés, VSS appelle [**IVssHardwareSnapshotProvider :: BeginPrepareSnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) avec le même tableau de structures d' [**\_ \_ informations de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) . Dans un seul appel, tous les numéros d’unités logiques du tableau sont uniques, mais le même numéro d’unité logique peut apparaître dans un appel suivant chaque fois que le même numéro d’unité logique contribue à plusieurs volumes. Le fournisseur doit gérer ce cas correctement.
4.  Immédiatement après [**IVssProviderCreateSnapshotSet :: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots), VSS définit les indicateurs en lecture seule, masqué, sans lettre de lecteur et de cliché instantané sur tous les numéros d’unités logiques affectés. Les indicateurs sont mis en œuvre à l’aide de secteurs cachés sur des disques MBR ou des bits spécifiques du système d’exploitation dans l’entrée d’en-tête de partition sur des disques GPT. Les indicateurs entraînent la surface de tous les volumes sur les disques affectés sur les ordinateurs de réception en lecture seule et masqués. Notez que les numéros d’unités logiques des clichés instantanés n’ont pas été validés à ce niveau. ainsi, en cas de panne du système, les indicateurs sont effacés et le numéro d’unité logique d’origine n’est pas affecté. Autrement dit, tous les volumes sur le numéro d’unité logique d’origine sont traités comme normaux et conservent leurs attributions de lettres de lecteur, dossiers montés et état de lecture/écriture d’origine.
    > [!Note]  
    > Les fournisseurs ne doivent pas tenter de modifier l’un des indicateurs LUN.

     

5.  À [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), les numéros d’unité logique de cliché instantané sont validés. **CommitSnapshots** doit être retourné en quelques secondes, sans quoi le processus de création de cliché instantané peut échouer.
6.  Après [**CommitSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots), VSS efface les indicateurs sur tous les numéros d’unités logiques d’origine impliqués dans le cliché instantané. Étant donné que les numéros d’unités logiques des clichés instantanés ont été validés à ce stade, les LUN des clichés instantanés conservent ces indicateurs.
7.  Après [**IVssProviderCreateSnapshotSet ::P ostcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots), VSS efface les indicateurs LUN (qu’il a définis après [**IVssProviderCreateSnapshotSet :: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)) et notifie les enregistreurs à libérer. VSS appelle ensuite les méthodes [**IVssProviderCreateSnapshotSet ::P refinalcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) et [**IVssProviderCreateSnapshotSet ::P ostfinalcommitsnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots) du fournisseur.
8.  VSS récupère un tableau des structures [**d' \_ \_ informations de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , une pour chaque numéro d’unité logique de cliché instantané nouvellement créé, en appelant [**IVssHardwareSnapshotProvider :: GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns). Le fournisseur doit fournir suffisamment d’informations pour permettre à VSS et au fournisseur d’identifier les clichés instantanés à un moment ultérieur et sur tout système connecté au sous-système. À ce stade, les numéros d’unité logique de clichés instantanés doivent être inaccessibles à cet ordinateur. le fournisseur doit utiliser un mécanisme autre que simplement en lisant les informations du numéro d’unité logique.
9.  Pour les clichés instantanés transportables, VSS ajoute les éléments suivants au document des composants de sauvegarde décrivant le jeu de clichés instantanés :
    1.  Tableau d' [**\_ \_ informations LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) d’origine.
    2.  Nouveau groupe d' [**\_ \_ informations LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) LUN de cliché instantané.
    3.  Les étendues de disque pour chaque volume dans le jeu de clichés instantanés.
10. Pour les clichés instantanés à importation automatique, le processus d’importation commence. Dans [**IVssHardwareSnapshotProvider :: LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), le fournisseur recevra les [**informations de \_ lun \_ VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) générées dans [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) au moment de la création. Pendant la **LocateLuns**, le fournisseur doit rendre les numéros d’unités logiques de clichés instantanés visibles au système. Le fournisseur ne doit pas provoquer une nouvelle analyse de bus. VSS entraînera une nouvelle analyse et une énumération pour permettre la découverte des numéros d’unités logiques par PNP et les volumes à mettre en ligne.
11. VSS appelle [**IVssHardwareSnapshotProvider :: FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) pour les disques nouvellement arrivés dans le système. VSS utilise le tableau d' [**\_ \_ informations LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) LUN de cliché instantané de **FillInLunInfo**, en le comparant aux **\_ \_ informations de LUN VDS** générées lors de la création dans [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) et aux étendues de disque pour chaque volume dans le jeu de clichés instantanés afin d’identifier les numéros d’unités logiques de clichés instantanés nouvellement arrivés.
12. À ce stade, tous les volumes contenus sur les numéros d’unités logiques de clichés instantanés sont montés masqués et en lecture seule, et VSS a un mappage du volume original au volume de clichés instantanés.

Étant donné qu’un même numéro d’unité logique peut contenir des portions de plusieurs volumes, l’ensemble des numéros d’unités logiques de clichés instantanés peut inclure des volumes « supplémentaires ». Ces volumes ne font pas partie du jeu de clichés instantanés et ne doivent pas être utilisés, car leur cohérence n’est pas garantie.

Après l’importation, le cliché instantané est accessible via la méthode [**IVssBackupComponents :: Query**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) . Un cliché instantané peut également être exposé sous la forme d’une lettre de lecteur, d’un dossier monté ou d’un partage à l’aide de [**IVssBackupComponents :: ExposeSnapshot**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot). Un jeu de clichés instantanés peut également être converti en numéro d’unité logique standard à l’aide de la méthode [**IVssBackupComponents :: BreakSnapshotSet**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) . À partir de là, les applications de gestion peuvent utiliser les API de gestion de disque appropriées pour gérer davantage le numéro d’unité logique (par exemple, modifier les attributs de lecture/écriture).

### <a name="transportable-shadow-copies-on-a-san"></a>Clichés instantanés transportables sur un réseau SAN

À compter de Windows Server 2003, Datacenter Edition et Windows Server 2003, Enterprise Edition, VSS active les jeux de clichés instantanés transportables sur un réseau SAN. Du point de vue d’un fournisseur qui peut transporter des numéros d’unités logiques entre les ordinateurs hôtes, il y a peu ou pas de différence entre un ensemble non transportable et un jeu de clichés instantanés transportables.

**Windows server 2003, Standard Edition, Windows server 2003, Web Edition et Windows XP :** Les jeux de clichés instantanés transportables ne sont pas pris en charge. Toutes les éditions de Windows Server 2003 avec Service Pack 1 (SP1) prennent en charge les jeux de clichés instantanés transportables.

Les jeux de clichés instantanés transportables doivent être créés à l’aide de l’attribut transportable de l’attribut **\_ \_ \_ transportable** [**de l’environnement \_ \_ \_ \_**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) VSS Tous les volumes de l’ensemble doivent être transportables. En retournant la réussite de [**IVssHardwareSnapshotProvider :: AreLunsSupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported), le fournisseur indique que non seulement il prend en charge le numéro d’unité logique, mais également qu’il peut transporter le numéro d’unité logique. La création d’un jeu de clichés instantanés transportables se termine lorsque le service VSS enregistre les informations sur le numéro d’unité logique dans le document des composants de sauvegarde. Un jeu de clichés instantanés ne peut être importé qu’une seule fois après la création initiale.

Sur l’ordinateur récepteur, le demandeur importe le jeu de clichés instantanés. La méthode [**IVssBackupComponents :: ImportSnapshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) utilise le document composants de sauvegarde décrivant le jeu de clichés instantanés comme entrée. L’importation continue par :

1.  VSS construit un tableau de structures d' [**informations de \_ lun \_ VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de clichés instantanés à partir du document sur les composants de sauvegarde.
2.  Lorsque VSS appelle [**IVssHardwareSnapshotProvider :: LocateLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns), le tableau des structures d' [**\_ \_ informations de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) générées dans [**IVssHardwareSnapshotProvider :: GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) est passé au fournisseur. Lors du traitement de cette méthode, le fournisseur doit rendre les numéros d’unités logiques de clichés instantanés visibles au système. Le fournisseur ne doit pas provoquer une nouvelle analyse de bus. VSS déclenchera la nouvelle analyse et l’énumération pour permettre aux numéros d’unités logiques d’être détectés par PNP et les volumes à mettre en ligne.
3.  VSS appelle [**IVssHardwareSnapshotProvider :: FillInLunInfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) pour les disques nouvellement arrivés dans le système. VSS utilise le tableau LUN des clichés instantanés des structures d' [**\_ \_ informations de LUN VDS**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) de **FillInLunInfo**, en le comparant aux **\_ \_ informations de LUN VDS** générées pendant la création du jeu de clichés instantanés dans [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) et aux étendues de disque pour chaque volume du jeu de clichés instantanés afin d’identifier les numéros d’unités logiques des clichés instantanés nouvellement arrivés.
4.  À ce stade, tous les volumes contenus sur les numéros d’unités logiques transportés sont montés masqués et en lecture seule et VSS ont un mappage du volume d’origine au volume de clichés instantanés.

Pour la seule machine et le cas transportable, la séquence est semblable à partir du point où [**GetTargetLuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) est appelé. Pour l’importation automatique, les étapes se produisent directement après la création.

 

 
