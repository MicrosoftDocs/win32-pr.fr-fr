---
description: Le service de Registre Windows prend en charge un enregistreur VSS, appelé Registry Writer, qui permet aux demandeurs de sauvegarder un registre système à l’aide des données stockées sur un volume de clichés instantanés.
ms.assetid: 94a45b04-0bdc-4211-bed0-caeabba774af
title: Opérations de sauvegarde et de restauration du Registre sous VSS
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: db1a3022ec2fb08b07bcff8b28455ae7154e4c40
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "106543109"
---
# <a name="registry-backup-and-restore-operations-under-vss"></a><span data-ttu-id="07ce0-103">Opérations de sauvegarde et de restauration du Registre sous VSS</span><span class="sxs-lookup"><span data-stu-id="07ce0-103">Registry Backup and Restore Operations Under VSS</span></span>

<span data-ttu-id="07ce0-104">Le service de Registre Windows prend en charge un enregistreur VSS, appelé Registry Writer, qui permet aux demandeurs de sauvegarder un registre système à l’aide des données stockées sur un volume de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="07ce0-104">The Windows Registry Service supports a VSS writer, called the registry writer, which allows requesters to back up a system registry using data stored on a shadow copied volume.</span></span> <span data-ttu-id="07ce0-105">Pour plus d’informations sur l’enregistreur du Registre, consultez la page [enregistreurs VSS](in-box-vss-writers.md).</span><span class="sxs-lookup"><span data-stu-id="07ce0-105">For more information about the registry writer, see [In-Box VSS Writers](in-box-vss-writers.md).</span></span>

<span data-ttu-id="07ce0-106">L’enregistreur du registre effectue des sauvegardes et des restaurations sur place du Registre.</span><span class="sxs-lookup"><span data-stu-id="07ce0-106">The registry writer performs in-place backups and restores of the registry.</span></span> <span data-ttu-id="07ce0-107">En outre, l’enregistreur du Registre signale uniquement les ruches système. il ne signale pas les ruches utilisateur.</span><span class="sxs-lookup"><span data-stu-id="07ce0-107">In addition, the registry writer reports only system hives; it does not report user hives.</span></span>

<span data-ttu-id="07ce0-108">**Windows Server 2003 :** Le rédacteur du Registre utilise un fichier de référentiel intermédiaire (également appelé fichier de fractionnement) pour stocker les données de registre.</span><span class="sxs-lookup"><span data-stu-id="07ce0-108">**Windows Server 2003:** The registry writer uses an intermediate repository file (also known as a spit file) to store registry data.</span></span> <span data-ttu-id="07ce0-109">En outre, l’enregistreur du Registre signale les ruches système et les ruches utilisateur.</span><span class="sxs-lookup"><span data-stu-id="07ce0-109">In addition, the registry writer reports system hives and user hives.</span></span>

<span data-ttu-id="07ce0-110">L’ID du writer du Registre est AFBAB4A2-367D-4D15-A586-71DBB18F8485.</span><span class="sxs-lookup"><span data-stu-id="07ce0-110">The writer ID for the registry writer is AFBAB4A2-367D-4D15-A586-71DBB18F8485.</span></span>

<span data-ttu-id="07ce0-111">**Windows XP :** Il n’y a pas d’enregistreur de registre.</span><span class="sxs-lookup"><span data-stu-id="07ce0-111">**Windows XP:** There is no registry writer.</span></span> <span data-ttu-id="07ce0-112">Les données du Registre sont signalées par l’enregistreur d’état de démarrage, dont l’ID d’enregistreur est F2436E37-09F5-41AF-9B2A-4CA2435DBFD5.</span><span class="sxs-lookup"><span data-stu-id="07ce0-112">The registry data is reported by the Bootable State writer, whose writer ID is F2436E37-09F5-41AF-9B2A-4CA2435DBFD5.</span></span>

> [!Note]  
> <span data-ttu-id="07ce0-113">Microsoft ne fournit pas de support technique pour les développeurs ou les professionnels de l’informatique pour l’implémentation de restaurations en ligne sur l’état du système sur Windows (toutes les versions).</span><span class="sxs-lookup"><span data-stu-id="07ce0-113">Microsoft does not provide developer or IT professional technical support for implementing online system state restores on Windows (all releases).</span></span> <span data-ttu-id="07ce0-114">Pour plus d’informations sur l’utilisation des API et des procédures fournies par Microsoft pour implémenter des restaurations en ligne de l’état du système, consultez les ressources de la communauté disponibles dans le [Centre de communauté MSDN](https://msdn.microsoft.com/community/default.aspx).</span><span class="sxs-lookup"><span data-stu-id="07ce0-114">For information about using Microsoft-provided APIs and procedures to implement online system state restores, see the community resources available at the [MSDN Community Center](https://msdn.microsoft.com/community/default.aspx).</span></span>

 

> [!Note]  
> <span data-ttu-id="07ce0-115">Les informations suivantes s’appliquent uniquement à Windows Server 2003 et Windows XP.</span><span class="sxs-lookup"><span data-stu-id="07ce0-115">The following information only applies to Windows Server 2003 and Windows XP.</span></span>

 

## <a name="registry-backup-using-vss"></a><span data-ttu-id="07ce0-116">Sauvegarde du Registre à l’aide de VSS</span><span class="sxs-lookup"><span data-stu-id="07ce0-116">Registry Backup Using VSS</span></span>

<span data-ttu-id="07ce0-117">Le rédacteur du Registre exporte et enregistre les fichiers de Registre actifs dans les emplacements définis par la clé **HKEY \_ local \_ machine** \\ **System** \\ **CurrentControlSet** \\ **Control** \\ **hivelist**.</span><span class="sxs-lookup"><span data-stu-id="07ce0-117">The registry writer will export and save active registry files in the locations defined by the key **HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Control**\\**hivelist**.</span></span>

<span data-ttu-id="07ce0-118">Les noms des valeurs sous cette entrée de Registre identifient la ruche de Registre à enregistrer, et les données de la valeur fournissent le fichier contenant le fichier (le fichier Hive).</span><span class="sxs-lookup"><span data-stu-id="07ce0-118">The names of the values under this registry entry identify the registry hive to be saved, and the value's data provides the file containing the file (the hive file).</span></span> <span data-ttu-id="07ce0-119">Les fichiers Hive sont spécifiés au format suivant : \\ Device \\ *HarddiskVolumeX* \\ *path* \\ *filename*.</span><span class="sxs-lookup"><span data-stu-id="07ce0-119">The hive files are specified with the following format: \\Device\\*HarddiskVolumeX*\\*path*\\*filename*.</span></span>

<span data-ttu-id="07ce0-120">Par exemple, sous **HKEY \_ local \_ machine** \\ **System** \\ **CurrentControlSet** \\ **Control** \\ **hivelist**, vous pouvez voir le logiciel **\\ Registry \\ machine \\ Software**  =  \\ Device \\ HarddiskVolume1 \\ Windows \\ system32 \\ config \\ Software.</span><span class="sxs-lookup"><span data-stu-id="07ce0-120">For example, under **HKEY\_LOCAL\_MACHINE**\\**System**\\**CurrentControlSet**\\**Control**\\**hivelist**, you might see **\\REGISTRY\\MACHINE\\SOFTWARE** = \\Device\\HarddiskVolume1\\Windows\\System32\\config\\SOFTWARE.</span></span>

<span data-ttu-id="07ce0-121">L’enregistreur du registre s’assure que les fichiers Hive sont enregistrés sur le disque avant le cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="07ce0-121">The registry writer ensures that hive files are saved to disk prior to its shadow copy.</span></span>

<span data-ttu-id="07ce0-122">Lors de la sauvegarde des ruches du Registre, un demandeur remplace le \\ \\ *HarddiskVolumeX* d’appareil par la chaîne de l' [*objet périphérique*](vssgloss-d.md) du cliché instantané du volume.</span><span class="sxs-lookup"><span data-stu-id="07ce0-122">When backing up the registry hives, a requester would replace \\Device\\*HarddiskVolumeX* with the [*device object*](vssgloss-d.md) string of the volume's shadow copy.</span></span>

> [!Note]  
> <span data-ttu-id="07ce0-123">Vous pouvez convertir le \\ chemin d’accès du \\ *HarddiskVolumeX* d’appareil en un chemin Win32 équivalent à l’aide de la fonction [**QueryDosDevice**](/windows/win32/api/fileapi/nf-fileapi-querydosdevicew) .</span><span class="sxs-lookup"><span data-stu-id="07ce0-123">You can convert the \\Device\\*HarddiskVolumeX* path to an equivalent Win32 path by using the [**QueryDosDevice**](/windows/win32/api/fileapi/nf-fileapi-querydosdevicew) function.</span></span> <span data-ttu-id="07ce0-124">Pour plus d’informations, consultez [obtention d’un nom de fichier à partir d’un handle de fichier](../memory/obtaining-a-file-name-from-a-file-handle.md) ou [affichage de noms de chemin d’accès de volume](../fileio/displaying-volume-paths.md).</span><span class="sxs-lookup"><span data-stu-id="07ce0-124">For more information, see [Obtaining a File Name From a File Handle](../memory/obtaining-a-file-name-from-a-file-handle.md) or [Displaying Volume Path Names](../fileio/displaying-volume-paths.md).</span></span>

 

## <a name="registry-restore-using-non-vss-win32-apis"></a><span data-ttu-id="07ce0-125">Restauration du Registre à l’aide des API Win32 non-VSS</span><span class="sxs-lookup"><span data-stu-id="07ce0-125">Registry Restore Using Non-VSS Win32 APIs</span></span>

<span data-ttu-id="07ce0-126">Pour une restauration en ligne (mode sans échec ou système d’exploitation complet), les sous-clés de la clé de Registre au sein de la clé de registre de la commande de système d’exploitation de l' **\_ \_ ordinateur local HKEY** du \\  \\  \\  \\ **Gestionnaire de sessions** \\  .</span><span class="sxs-lookup"><span data-stu-id="07ce0-126">For an online (safe mode or full operating system) restore, the subkeys in the **HKEY\_LOCAL\_MACHINE**\\**SYSTEM**\\**CurrentControlSet**\\**Control**\\**Session Manager**\\**PendingFileRenameOperations** registry key must be preserved.</span></span>

<span data-ttu-id="07ce0-127">Les fonctions [**MoveFileEx**](/windows/win32/api/winbase/nf-winbase-movefileexa) et [**MoveFileTransacted**](/windows/win32/api/winbase/nf-winbase-movefiletransacteda) utilisent cette clé de Registre pour stocker des informations sur les fichiers qui ont été renommés à l’aide du \_ délai MOVEFILE \_ jusqu’à la \_ valeur de redémarrage dans le paramètre *dwFlags* .</span><span class="sxs-lookup"><span data-stu-id="07ce0-127">The [**MoveFileEx**](/windows/win32/api/winbase/nf-winbase-movefileexa) and [**MoveFileTransacted**](/windows/win32/api/winbase/nf-winbase-movefiletransacteda) functions use this registry key to store information about files that were renamed by using the MOVEFILE\_DELAY\_UNTIL\_REBOOT value in the *dwFlags* parameter.</span></span>

<span data-ttu-id="07ce0-128">Pour conserver le contenu de la clé de Registre **PendingFileRenameOperations** , votre application de sauvegarde doit appeler la fonction [**RegLoadKey**](/windows/win32/api/winreg/nf-winreg-regloadkeya) pour connecter le fichier de Registre à restaurer dans le Registre actif.</span><span class="sxs-lookup"><span data-stu-id="07ce0-128">To preserve the contents of the **PendingFileRenameOperations** registry key, your backup application should call the [**RegLoadKey**](/windows/win32/api/winreg/nf-winreg-regloadkeya) function to connect the registry file to be restored to the active registry.</span></span> <span data-ttu-id="07ce0-129">Votre application de sauvegarde peut ensuite utiliser les différentes fonctions de Registre pour copier les clés et valeurs souhaitées dans la ruche chargée.</span><span class="sxs-lookup"><span data-stu-id="07ce0-129">Your backup application can then use the various registry functions to copy the desired keys and values into the loaded hive.</span></span> <span data-ttu-id="07ce0-130">Une fois la copie terminée, les fonctions [**regflushkey a**](/windows/win32/api/winreg/nf-winreg-regflushkey) et [**RegUnloadKey**](/windows/win32/api/winreg/nf-winreg-regunloadkeya) doivent être appelées.</span><span class="sxs-lookup"><span data-stu-id="07ce0-130">After the copy is complete, the [**RegFlushKey**](/windows/win32/api/winreg/nf-winreg-regflushkey) and [**RegUnloadKey**](/windows/win32/api/winreg/nf-winreg-regunloadkeya) functions should be called.</span></span>

<span data-ttu-id="07ce0-131">Pour une restauration hors connexion (environnement de récupération Windows ou Windows PE), il n’est pas nécessaire d’honorer la clé de Registre **PendingFileRenameOperations** .</span><span class="sxs-lookup"><span data-stu-id="07ce0-131">For an offline (Windows Recovery Environment or Windows PE) restore, it is not necessary to honor the **PendingFileRenameOperations** registry key.</span></span>

## <a name="registry-restore-using-non-vss-win32-apis-in-windows-server-2003"></a><span data-ttu-id="07ce0-132">Restauration du Registre à l’aide des API Win32 non-VSS dans Windows Server 2003</span><span class="sxs-lookup"><span data-stu-id="07ce0-132">Registry Restore Using Non-VSS Win32 APIs in Windows Server 2003</span></span>

> [!Note]  
> <span data-ttu-id="07ce0-133">Les informations suivantes s’appliquent uniquement aux opérations de restauration liées à la récupération d’urgence (également appelée récupération complète) effectuées dans Windows Server 2003.</span><span class="sxs-lookup"><span data-stu-id="07ce0-133">The following information applies only to restore operations related to disaster recovery (also known as bare-metal recovery) that are performed in Windows Server 2003.</span></span>

 

<span data-ttu-id="07ce0-134">Lors de la restauration du Registre, une application de sauvegarde doit déplacer certaines des sous-clés du registre actuel vers le registre à restaurer.</span><span class="sxs-lookup"><span data-stu-id="07ce0-134">When restoring the registry, a backup application needs to move some of the subkeys from the current registry into the registry that is to be restored.</span></span>

<span data-ttu-id="07ce0-135">Pour ce faire, une application de sauvegarde peut appeler **RegLoadKey** pour connecter le fichier de Registre à restaurer dans le registre actuellement actif.</span><span class="sxs-lookup"><span data-stu-id="07ce0-135">To do this, a backup application can call **RegLoadKey** to connect the registry file to be restored to the currently active registry.</span></span> <span data-ttu-id="07ce0-136">Il peut ensuite utiliser les différentes fonctions de Registre pour copier les clés et les valeurs souhaitées dans la ruche chargée.</span><span class="sxs-lookup"><span data-stu-id="07ce0-136">It can then use the various registry functions to copy the desired keys and values into the loaded hive.</span></span> <span data-ttu-id="07ce0-137">Une fois la copie terminée, **regflushkey a** et **RegUnloadKey** sont appelés.</span><span class="sxs-lookup"><span data-stu-id="07ce0-137">After the copy is complete, **RegFlushKey** and **RegUnloadKey** are called.</span></span>

<span data-ttu-id="07ce0-138">Une clé de registre indique à une application de restauration (demandeur) les clés de Registre sous **HKEY \_ local \_ machine \\ System** qui ne doivent pas être remplacées au moment de la restauration :</span><span class="sxs-lookup"><span data-stu-id="07ce0-138">There is a registry key that indicates to a restore application (requester) the registry keys under **HKEY\_LOCAL\_MACHINE\\SYSTEM** that should not be overwritten at restore time:</span></span>

<span data-ttu-id="07ce0-139">**HKEY \_ local \_ machine \\ System \\ CurrentControlSet \\ Control \\ backuprestore \\ KeysNotToRestore**</span><span class="sxs-lookup"><span data-stu-id="07ce0-139">**HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Control\\BackupRestore\\KeysNotToRestore**</span></span>

<span data-ttu-id="07ce0-140">Une partie du processus de restauration de l’état du système implique la restauration d’un registre sauvegardé précédemment.</span><span class="sxs-lookup"><span data-stu-id="07ce0-140">Part of the system state restore process involves restoring a previously backed-up registry.</span></span>

<span data-ttu-id="07ce0-141">Les applications de sauvegarde doivent faire particulièrement attention lors de la restauration de la ruche du **\_ \_ \\ système HKEY local machine** , car le processus d’installation d’une version temporaire du système d’exploitation Windows aura des clés établies dans la ruche système nouvellement installée dont les valeurs doivent survivre à l’opération de restauration.</span><span class="sxs-lookup"><span data-stu-id="07ce0-141">Backup applications need to take special care when restoring the **HKEY\_LOCAL\_MACHINE\\SYSTEM** hive because the process of installing a temporary version of the Windows operating system will have established keys in the newly installed system hive whose values must survive the restore operation.</span></span>

<span data-ttu-id="07ce0-142">Par exemple, lorsque le système de remplacement a une carte d’interface réseau différente du système d’origine, la restauration des clés d’origine pour la carte précédente entraîne des résultats imprévisibles.</span><span class="sxs-lookup"><span data-stu-id="07ce0-142">For example, when the replacement system has a network interface card different from the original system, restoration of the original keys for the previous card will lead to unpredictable results.</span></span> <span data-ttu-id="07ce0-143">Cela est dû au fait que le service de Plug-and-Play a détecté et placé les entrées de Registre appropriées du service et du pilote dans le registre.</span><span class="sxs-lookup"><span data-stu-id="07ce0-143">This is because the Plug and Play service has detected and placed proper service and driver registry entries into the registry.</span></span> <span data-ttu-id="07ce0-144">Ces valeurs doivent être conservées pour démarrer correctement après la restauration du système.</span><span class="sxs-lookup"><span data-stu-id="07ce0-144">These values must be preserved to properly boot after system restore.</span></span>

<span data-ttu-id="07ce0-145">Cette section décrit comment les applications de sauvegarde peuvent découvrir les clés et les fichiers qui doivent être conservés lors de l’exécution d’une restauration de la ruche **\_ \_ \\ système HKEY local machine** .</span><span class="sxs-lookup"><span data-stu-id="07ce0-145">This section describes how backup applications can discover which keys and files are to be preserved when executing a restore of the **HKEY\_LOCAL\_MACHINE\\SYSTEM** hive.</span></span> <span data-ttu-id="07ce0-146">Dans certains cas, cela implique la copie par programmation des clés de la ruche d’installation récemment installée dans la ruche à restaurer.</span><span class="sxs-lookup"><span data-stu-id="07ce0-146">In some cases, this will involve programmatically copying the keys from the newly installed installation hive into the hive to be restored.</span></span> <span data-ttu-id="07ce0-147">Dans d’autres cas, le fait de s’assurer que les clés de registre d’un produit ne sont pas remplacées est aussi simple que de spécifier de telles clés dans le fichier de configuration INF du produit.</span><span class="sxs-lookup"><span data-stu-id="07ce0-147">In other cases, ensuring that a product's registry keys are not replaced is as simple as specifying such keys in the product's INF configuration file.</span></span>

<span data-ttu-id="07ce0-148">Les clés (et les données de clé) qui doivent être préservées sont énumérées dans la ruche du **\_ \_ \\ système HKEY local machine** sous le</span><span class="sxs-lookup"><span data-stu-id="07ce0-148">Keys (and key data) that are to be preserved are enumerated in the **HKEY\_LOCAL\_MACHINE\\SYSTEM** hive under the</span></span>

<span data-ttu-id="07ce0-149">**HKEY \_ local \_ machine \\ System \\ CurrentControlSet \\ Control \\ backuprestore \\ KeysNotToRestore**</span><span class="sxs-lookup"><span data-stu-id="07ce0-149">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\BackupRestore\\KeysNotToRestore**</span></span>

<span data-ttu-id="07ce0-150">clé sous forme d’ensembles \_ de \_ chaînes reg multisz (appelées *chaînes de clé* dans ce document).</span><span class="sxs-lookup"><span data-stu-id="07ce0-150">key as sets of REG\_MULTI\_SZ strings (called *key strings* in this document).</span></span>

<span data-ttu-id="07ce0-151">Une application de sauvegarde (demandeur) doit examiner les valeurs de ces clés dans le Registre actif et le Registre qui vient d’être restauré, car une application ou un service peut ajouter des valeurs à tout moment.</span><span class="sxs-lookup"><span data-stu-id="07ce0-151">A backup application (requester) must examine the values of these keys in the active registry and the newly restored registry because any application or service can add values at any time.</span></span>

<span data-ttu-id="07ce0-152">La manière dont les chaînes de clé doivent être interprétées par les applications de sauvegarde est déterminée par leur caractère terminal :</span><span class="sxs-lookup"><span data-stu-id="07ce0-152">How key strings are to be interpreted by backup applications is determined by their terminal character:</span></span>

1.  <span data-ttu-id="07ce0-153">Les chaînes de clé se terminant par une barre oblique inverse (« \\ ») sont interprétées comme des sous-clés.</span><span class="sxs-lookup"><span data-stu-id="07ce0-153">Key strings terminated with a backslash ('\\') are interpreted as subkeys.</span></span> <span data-ttu-id="07ce0-154">Lorsqu’une telle sous-chaîne est rencontrée, l’application de sauvegarde doit conserver toutes les données et toutes les clés subordonnées.</span><span class="sxs-lookup"><span data-stu-id="07ce0-154">When such a substring is encountered, the backup application must preserve all data and all subordinate keys.</span></span>

    <span data-ttu-id="07ce0-155">Par exemple, le code suivant spécifie que toutes les clés et données subordonnées doivent être conservées dans une opération de restauration :</span><span class="sxs-lookup"><span data-stu-id="07ce0-155">For example, the following specifies that all subordinate keys and data are to be preserved across a restore operation:</span></span>

    <span data-ttu-id="07ce0-156">**HKEY \_ local \_ machine \\ System \\ CurrentControlSet \\ services \\ dmio \\ informations de démarrage\\**</span><span class="sxs-lookup"><span data-stu-id="07ce0-156">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\dmio\\boot info\\**</span></span>

    <span data-ttu-id="07ce0-157">À cette fin, cette clé et toutes les clés et données subordonnées doivent être copiées à partir du Registre existant (c’est-à-dire celui créé par l’installation de Windows) dans le Registre qui vient d’être restauré.</span><span class="sxs-lookup"><span data-stu-id="07ce0-157">To this end, this key and all subordinate keys and data must be copied from the existing registry (that is, the one created by the installation of Windows) into the newly restored registry.</span></span> <span data-ttu-id="07ce0-158">C’est ce que l’on appelle une opération de *remplacement de clé* .</span><span class="sxs-lookup"><span data-stu-id="07ce0-158">This is called a *key replace* operation.</span></span> <span data-ttu-id="07ce0-159">Cette opération remplace la clé correspondante dans le registre restauré.</span><span class="sxs-lookup"><span data-stu-id="07ce0-159">This operation replaces the corresponding key in the restored registry.</span></span>

2.  <span data-ttu-id="07ce0-160">Les chaînes de clé dont le caractère de fin est un astérisque (« \* ») spécifient que toutes les sous-clés doivent être fusionnées.</span><span class="sxs-lookup"><span data-stu-id="07ce0-160">Key strings whose termination character is an asterisk ('\*') specifies that all subkeys should be merged.</span></span> <span data-ttu-id="07ce0-161">Par exemple, la chaîne de clé :</span><span class="sxs-lookup"><span data-stu-id="07ce0-161">For example, the key string:</span></span>

    <span data-ttu-id="07ce0-162">\**HKEY \_ Services de CurrentControlSet de système d’ordinateur LOCAL _ \_ \\ \\ \\ \\ \**</span><span class="sxs-lookup"><span data-stu-id="07ce0-162">\**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\\** _</span></span>

    <span data-ttu-id="07ce0-163">Spécifie que la clé services dans le Registre existant (par exemple, celles créées par l’installation de Windows) doit être fusionnée dans le registre restauré.</span><span class="sxs-lookup"><span data-stu-id="07ce0-163">specifies that the services key in the existing registry (for example those created by the installation of Windows) must be merged into the restored registry.</span></span> <span data-ttu-id="07ce0-164">C’est ce que l’on appelle une opération _key Merge \* et si une sous-clé existe à la fois dans la ruche existante et dans la ruche restaurée, la clé du répertoire restauré est conservée avec les exceptions suivantes :</span><span class="sxs-lookup"><span data-stu-id="07ce0-164">This is called a _key merge\* operation, and if a subkey exists in both the existing hive and the restored hive, the key in the restored directory is preserved with the following exceptions:</span></span>

    -   <span data-ttu-id="07ce0-165">Si la sous-clé de la ruche existante contient une valeur nommée « Start », et que la sous-clé dans la restaurée ne le fait pas.</span><span class="sxs-lookup"><span data-stu-id="07ce0-165">If the subkey in the existing hive contains a value named "start", and the subkey in the restored does not.</span></span>
    -   <span data-ttu-id="07ce0-166">Si la sous-clé de la ruche existante et restaurée contient une valeur nommée « Start » et que sa valeur numérique dans la ruche existante est inférieure.</span><span class="sxs-lookup"><span data-stu-id="07ce0-166">If the subkey in both the existing and restored hive contain a value named "start", and its numeric value in the existing hive is less.</span></span>

    <span data-ttu-id="07ce0-167">La valeur « START » dans le registre spécifie quand un service ou un pilote démarre et peut avoir une valeur numérique comprise entre 0-4.</span><span class="sxs-lookup"><span data-stu-id="07ce0-167">The "start" value in the registry specifies when a service or driver will start and can have a numeric value from 0-4.</span></span> <span data-ttu-id="07ce0-168">Plus la valeur est faible, plus tôt dans le processus de démarrage, le service démarre.</span><span class="sxs-lookup"><span data-stu-id="07ce0-168">The lower the value, the sooner in the boot process the service will start.</span></span>

    <span data-ttu-id="07ce0-169">Si cette clé existe dans le répertoire existant et dans le répertoire restauré, vous devez examiner la valeur de la clé de démarrage dans chaque Hive.</span><span class="sxs-lookup"><span data-stu-id="07ce0-169">If this key exists in both the existing and the restored directory, you must examine the value of the start key in each hive.</span></span> <span data-ttu-id="07ce0-170">Si la valeur de la ruche existante est inférieure à la valeur du répertoire restauré, la valeur inférieure doit être conservée.</span><span class="sxs-lookup"><span data-stu-id="07ce0-170">If the value in the existing hive is lower than the value in the restored directory, the lower value must be preserved.</span></span>

    <span data-ttu-id="07ce0-171">Une fois encore, cette clé est utilisée pour déterminer si un service ou un pilote doit être démarré au moment du démarrage, à l’heure système, manuellement, automatiquement ou désactivée.</span><span class="sxs-lookup"><span data-stu-id="07ce0-171">Once again, this key is used to determine whether a service or driver is to be started at boot time, at system time, manually, automatically, or be disabled.</span></span> <span data-ttu-id="07ce0-172">La valeur inférieure représente une heure de début antérieure.</span><span class="sxs-lookup"><span data-stu-id="07ce0-172">The lower value represents an earlier start time.</span></span> <span data-ttu-id="07ce0-173">L’heure de début précédente doit être appliquée au nouveau registre pour s’assurer que le service ou les pilotes sont démarrés correctement au démarrage suivant.</span><span class="sxs-lookup"><span data-stu-id="07ce0-173">The earlier start time must be applied to the new registry to ensure that the service or drivers are started properly at the next boot.</span></span>

3.  <span data-ttu-id="07ce0-174">Les chaînes de clé dont le caractère de fin n’est ni une barre oblique inverse, ni un astérisque sont interprétées comme des valeurs de Registre à conserver.</span><span class="sxs-lookup"><span data-stu-id="07ce0-174">Key strings whose termination character is neither a backslash nor an asterisk are interpreted as registry values to be preserved.</span></span>

    <span data-ttu-id="07ce0-175">Par exemple, la chaîne de clé :</span><span class="sxs-lookup"><span data-stu-id="07ce0-175">For example, the key string:</span></span>

    <span data-ttu-id="07ce0-176">**HKEY \_ local \_ machine \\ System \\ CurrentControlSet \\ contrôler le \\ Gestionnaire de sessions \\ PendingFileRenameOperations**</span><span class="sxs-lookup"><span data-stu-id="07ce0-176">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\PendingFileRenameOperations**</span></span>

    <span data-ttu-id="07ce0-177">Le mécanisme par lequel les clés peuvent être conservées par programme implique l’API du Registre Win32.</span><span class="sxs-lookup"><span data-stu-id="07ce0-177">The mechanism by which keys can be preserved programmatically involves the Win32 registry API.</span></span> <span data-ttu-id="07ce0-178">Par exemple, un algorithme est énuméré ci-dessous :</span><span class="sxs-lookup"><span data-stu-id="07ce0-178">For example, one algorithm is enumerated below:</span></span>

    1.  <span data-ttu-id="07ce0-179">Restaurez le fichier ruche du système sauvegardé dans un fichier.</span><span class="sxs-lookup"><span data-stu-id="07ce0-179">Restore the backed-up system hive file to a file.</span></span> <span data-ttu-id="07ce0-180">Pour cet exemple, laissez le nom System. reg.</span><span class="sxs-lookup"><span data-stu-id="07ce0-180">For this example, let the name be System.reg.</span></span>
    2.  <span data-ttu-id="07ce0-181">Utilisez **RegLoadKey** pour charger System. reg dans **HKEY \_ local \_ machine** sous un nom temporaire.</span><span class="sxs-lookup"><span data-stu-id="07ce0-181">Use **RegLoadKey** to load System.reg into **HKEY\_LOCAL\_MACHINE** under a temporary name.</span></span> <span data-ttu-id="07ce0-182">Par exemple, un tel nom peut être</span><span class="sxs-lookup"><span data-stu-id="07ce0-182">For example, one such name might be</span></span>

        <span data-ttu-id="07ce0-183">**HKEY \_ local \_ machine \\ tmp \_ système**</span><span class="sxs-lookup"><span data-stu-id="07ce0-183">**HKEY\_LOCAL\_MACHINE\\TMP\_SYSTEM**</span></span>

    3.  <span data-ttu-id="07ce0-184">Énumérez les valeurs dans la sous-clé **KeysNotToRestore** à partir des deux copies du Registre et créez un sur-ensemble des listes.</span><span class="sxs-lookup"><span data-stu-id="07ce0-184">Enumerate the values in the **KeysNotToRestore** subkey from both of the registry copies and create a superset of the lists.</span></span> <span data-ttu-id="07ce0-185">Copier chaque clé de ce type à partir du</span><span class="sxs-lookup"><span data-stu-id="07ce0-185">Copy each such key from the existing</span></span>

        <span data-ttu-id="07ce0-186">**HKEY \_ local \_ machine \\ System**</span><span class="sxs-lookup"><span data-stu-id="07ce0-186">**HKEY\_LOCAL\_MACHINE\\SYSTEM**</span></span>

        <span data-ttu-id="07ce0-187">clé dans</span><span class="sxs-lookup"><span data-stu-id="07ce0-187">key into the</span></span>

        <span data-ttu-id="07ce0-188">**HKEY \_ local \_ machine \\ tmp \_ système**</span><span class="sxs-lookup"><span data-stu-id="07ce0-188">**HKEY\_LOCAL\_MACHINE\\TMP\_SYSTEM**</span></span>

        <span data-ttu-id="07ce0-189">clé selon la sémantique décrite ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="07ce0-189">key according to the semantics described above.</span></span>

    4.  <span data-ttu-id="07ce0-190">Lorsque vous avez terminé , utilisez les  &  points d’entrée regflushkey a **RegUnloadKey** pour enregistrer le</span><span class="sxs-lookup"><span data-stu-id="07ce0-190">When complete use the **RegFlushKey** & **RegUnloadKey** entry points to save the</span></span>

        <span data-ttu-id="07ce0-191">**HKEY \_ local \_ machine \\ tmp \_ système**</span><span class="sxs-lookup"><span data-stu-id="07ce0-191">**HKEY\_LOCAL\_MACHINE\\TMP\_SYSTEM**</span></span>

        <span data-ttu-id="07ce0-192">clé dans System. reg.</span><span class="sxs-lookup"><span data-stu-id="07ce0-192">key back to System.reg.</span></span>

    5.  <span data-ttu-id="07ce0-193">Enfin, utilisez **RegReplaceKey** pour spécifier que System. reg doit remplacer</span><span class="sxs-lookup"><span data-stu-id="07ce0-193">Finally, use **RegReplaceKey** to specify that System.reg is to replace the</span></span>

        <span data-ttu-id="07ce0-194">**HKEY \_ local \_ machine \\ System**</span><span class="sxs-lookup"><span data-stu-id="07ce0-194">**HKEY\_LOCAL\_MACHINE\\SYSTEM**</span></span>

        <span data-ttu-id="07ce0-195">fichier Hive, système.</span><span class="sxs-lookup"><span data-stu-id="07ce0-195">hive file, SYSTEM.</span></span>

 

 
