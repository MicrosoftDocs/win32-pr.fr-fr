---
description: Dans Windows Vista et Windows Server 2008 et versions ultérieures, le développeur d’une application ou d’un rédacteur VSS peut choisir d’exclure certains fichiers des clichés instantanés.
ms.assetid: 4fe1ae94-7b2f-421a-9009-3a7e88822458
title: Exclusion de fichiers des clichés instantanés
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 52546c8ddc6da62433dc610f2bf4fc2c46c5e53f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "104210569"
---
# <a name="excluding-files-from-shadow-copies"></a><span data-ttu-id="7a064-103">Exclusion de fichiers des clichés instantanés</span><span class="sxs-lookup"><span data-stu-id="7a064-103">Excluding Files from Shadow Copies</span></span>

<span data-ttu-id="7a064-104">Dans Windows Vista et Windows Server 2008 et versions ultérieures, le développeur d’une application ou d’un rédacteur VSS peut choisir d’exclure certains fichiers des clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="7a064-104">In Windows Vista and Windows Server 2008 and later, the developer of a VSS writer or application may choose to exclude certain files from shadow copies.</span></span>

<span data-ttu-id="7a064-105">L’impact sur les performances et la zone de stockage des clichés instantanés (également appelée « zone diff ») de l’utilisation d’un fichier dans un cliché instantané sont directement liés à la quantité de modification dans le contenu du fichier après la création du cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="7a064-105">The performance impact and shadow copy storage area (also called "diff area") usage of a file in a shadow copy are directly related to the amount of change in the file's contents after the shadow copy is created.</span></span> <span data-ttu-id="7a064-106">En outre, l’exclusion de fichiers des clichés instantanés peut ralentir la création de clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="7a064-106">In addition, excluding files from shadow copies may slow down shadow copy creation.</span></span>

<span data-ttu-id="7a064-107">Pour ces raisons, un fichier doit être exclu des clichés instantanés uniquement s’il est volumineux, subit une modification importante entre un cliché instantané et le suivant, et n’a pas besoin d’être sauvegardé.</span><span class="sxs-lookup"><span data-stu-id="7a064-107">For these reasons, a file should be excluded from shadow copies only if it is large, undergoes significant change between one shadow copy and the next, and does not need to be backed up.</span></span>

<span data-ttu-id="7a064-108">Vous ne devez exclure que les fichiers appartenant à votre application.</span><span class="sxs-lookup"><span data-stu-id="7a064-108">You should only exclude files that belong to your application.</span></span>

<span data-ttu-id="7a064-109">Si le contexte de cliché instantané n’a \_ \_ pas été \_ \_ défini dans le contexte de cliché instantané, cela signifie que la récupération automatique est désactivée et qu’aucun fichier ne peut être exclu du cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="7a064-109">If the VSS\_VOLSNAP\_ATTR\_NO\_AUTORECOVERY flag is set in the shadow copy context, this means that auto-recovery is disabled, and no files can be excluded from the shadow copy.</span></span> <span data-ttu-id="7a064-110">Pour plus d’informations, consultez l’énumération des [**\_ \_ attributs d' \_ instantané \_ de volume VSS**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) .</span><span class="sxs-lookup"><span data-stu-id="7a064-110">For more information, see the [**\_VSS\_VOLUME\_SNAPSHOT\_ATTRIBUTES**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) enumeration.</span></span>

## <a name="using-the-addexcludefilesfromsnapshot-method"></a><span data-ttu-id="7a064-111">Utilisation de la méthode AddExcludeFilesFromSnapshot</span><span class="sxs-lookup"><span data-stu-id="7a064-111">Using the AddExcludeFilesFromSnapshot Method</span></span>

<span data-ttu-id="7a064-112">Un enregistreur VSS peut exclure des fichiers d’un cliché instantané comme suit :</span><span class="sxs-lookup"><span data-stu-id="7a064-112">A VSS writer can exclude files from a shadow copy as follows:</span></span>

1.  <span data-ttu-id="7a064-113">Appelez la méthode [**IVssCreateWriterMetadataEx :: AddExcludeFilesFromSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadataex-addexcludefilesfromsnapshot) pour signaler les fichiers à exclure.</span><span class="sxs-lookup"><span data-stu-id="7a064-113">Call the [**IVssCreateWriterMetadataEx::AddExcludeFilesFromSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadataex-addexcludefilesfromsnapshot) method to report the files to be excluded.</span></span>
2.  <span data-ttu-id="7a064-114">Dans la méthode [**CVssWriter :: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) du writer, supprimez les fichiers du cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="7a064-114">In the writer's [**CVssWriter::OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) method, delete the files from the shadow copy.</span></span>

## <a name="using-the-filesnottosnapshot-registry-key"></a><span data-ttu-id="7a064-115">Utilisation de la clé de Registre FilesNotToSnapshot</span><span class="sxs-lookup"><span data-stu-id="7a064-115">Using the FilesNotToSnapshot Registry Key</span></span>

> [!Note]  
> <span data-ttu-id="7a064-116">La clé de Registre **FilesNotToSnapshot** est destinée à être utilisée uniquement par les applications.</span><span class="sxs-lookup"><span data-stu-id="7a064-116">The **FilesNotToSnapshot** registry key is intended to be used only by applications.</span></span> <span data-ttu-id="7a064-117">Les utilisateurs qui essaient de l’utiliser rencontrent les limitations suivantes :</span><span class="sxs-lookup"><span data-stu-id="7a064-117">Users who attempt to use it will encounter limitations such as the following:</span></span>
>
> -   <span data-ttu-id="7a064-118">Elle ne permet pas de supprimer des fichiers d’un cliché instantané créé sur un serveur Windows Server à l’aide de la fonctionnalité Versions précédentes.</span><span class="sxs-lookup"><span data-stu-id="7a064-118">It cannot delete files from a shadow copy that was created on a Windows Server by using the Previous Versions feature.</span></span>
> -   <span data-ttu-id="7a064-119">Elle ne permet pas de supprimer des fichiers des clichés instantanés pour dossiers partagés.</span><span class="sxs-lookup"><span data-stu-id="7a064-119">It cannot delete files from shadow copies for shared folders.</span></span>
> -   <span data-ttu-id="7a064-120">Il peut supprimer des fichiers d’un cliché instantané qui a été créé à l’aide de l’utilitaire [DiskShadow](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc772172(v=ws.11)) , mais il ne peut pas supprimer les fichiers d’un cliché instantané qui a été créé à l’aide de l’utilitaire [vssadmin](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc754968(v=ws.11)) .</span><span class="sxs-lookup"><span data-stu-id="7a064-120">It can delete files from a shadow copy that was created by using the [DiskShadow](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc772172(v=ws.11)) utility, but it cannot delete files from a shadow copy that was created by using the [Vssadmin](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc754968(v=ws.11)) utility.</span></span>
> -   <span data-ttu-id="7a064-121">Les fichiers sont supprimés d’un cliché instantané autant que faire se peut.</span><span class="sxs-lookup"><span data-stu-id="7a064-121">Files are deleted from a shadow copy on a best-effort basis.</span></span> <span data-ttu-id="7a064-122">Cela signifie que leur suppression n’est pas garantie.</span><span class="sxs-lookup"><span data-stu-id="7a064-122">This means that they are not guaranteed to be deleted.</span></span>

 

<span data-ttu-id="7a064-123">Une application VSS peut supprimer des fichiers d’un cliché instantané lors de la création de clichés instantanés à l’aide de la clé de Registre suivante :</span><span class="sxs-lookup"><span data-stu-id="7a064-123">A VSS application can delete files from a shadow copy during shadow copy creation by using the following registry key:</span></span>

<span data-ttu-id="7a064-124">**HKEY \_ local \_ machine \\ System \\ CurrentControlSet \\ Control \\ backuprestore \\ FilesNotToSnapshot**</span><span class="sxs-lookup"><span data-stu-id="7a064-124">**HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Control\\BackupRestore\\FilesNotToSnapshot**</span></span>

<span data-ttu-id="7a064-125">Cette clé de registre a \_ \_ des valeurs REG multisz pour chaque application dont les fichiers peuvent être exclus.</span><span class="sxs-lookup"><span data-stu-id="7a064-125">This registry key has REG\_MULTI\_SZ values for each application whose files can be excluded.</span></span> <span data-ttu-id="7a064-126">Les fichiers sont spécifiés par des chemins d’accès complets, qui peuvent contenir le \* caractère générique.</span><span class="sxs-lookup"><span data-stu-id="7a064-126">The files are specified by fully qualified paths, which can contain the \* wildcard.</span></span>

<span data-ttu-id="7a064-127">Dans tous les cas, l’entrée est ignorée si aucun fichier ne correspond à la chaîne de chemin d’accès.</span><span class="sxs-lookup"><span data-stu-id="7a064-127">In all cases, the entry is ignored if there are no files that match the path string.</span></span>

<span data-ttu-id="7a064-128">Une fois qu’un fichier a été ajouté à la valeur de clé de registre appropriée, il est supprimé du cliché instantané lors de la création par le writer d’optimisation du cliché instantané.</span><span class="sxs-lookup"><span data-stu-id="7a064-128">After a file is added to the appropriate registry key value, it is deleted from the shadow copy during creation by the shadow copy optimization writer on a best-effort basis.</span></span>

<span data-ttu-id="7a064-129">Si un chemin d’accès qualifié complet ne peut pas être spécifié, un chemin d’accès peut également être implicite à l’aide de la variable $UserProfile $ ou $AllVolumes $.</span><span class="sxs-lookup"><span data-stu-id="7a064-129">If a fully qualified path cannot be specified, then a path can also be implied by using the $UserProfile$ or $AllVolumes$ variable.</span></span> <span data-ttu-id="7a064-130">Par exemple :</span><span class="sxs-lookup"><span data-stu-id="7a064-130">For example:</span></span>

-   <span data-ttu-id="7a064-131">\\ \\ Nom du sous-répertoire $USERPROFILE $ Directory \\ .\*</span><span class="sxs-lookup"><span data-stu-id="7a064-131">$UserProfile$\\Directory\\Subdirectory\\FileName.\*</span></span>
-   <span data-ttu-id="7a064-132">$AllVolumes $ \\ TemporaryFiles \\ \* .\*</span><span class="sxs-lookup"><span data-stu-id="7a064-132">$AllVolumes$\\TemporaryFiles\\\*.\*</span></span>

<span data-ttu-id="7a064-133">Pour rendre le chemin d’accès récursif, ajoutez « /s » à la fin.</span><span class="sxs-lookup"><span data-stu-id="7a064-133">To make the path recursive, append " /s" to the end.</span></span> <span data-ttu-id="7a064-134">Par exemple :</span><span class="sxs-lookup"><span data-stu-id="7a064-134">For example:</span></span>

-   <span data-ttu-id="7a064-135">\\ \\ Nom du sous-répertoire $USERPROFILE $ Directory \\ . \* /s</span><span class="sxs-lookup"><span data-stu-id="7a064-135">$UserProfile$\\Directory\\Subdirectory\\FileName.\* /s</span></span>
-   <span data-ttu-id="7a064-136">$AllVolumes $ \\ TemporaryFiles \\ \* . \* /s</span><span class="sxs-lookup"><span data-stu-id="7a064-136">$AllVolumes$\\TemporaryFiles\\\*.\* /s</span></span>

<span data-ttu-id="7a064-137">La variable $UserProfile $ provoque l’application de la chaîne de chemin d’accès à tous les profils utilisateur sur l’ordinateur.</span><span class="sxs-lookup"><span data-stu-id="7a064-137">The $UserProfile$ variable causes the path string to be applied to all user profiles on the computer.</span></span> <span data-ttu-id="7a064-138">Les profils utilisateur sont énumérés en examinant la clé de Registre suivante :</span><span class="sxs-lookup"><span data-stu-id="7a064-138">The user profiles are enumerated by examining the following registry key:</span></span>

<span data-ttu-id="7a064-139">**HKEY \_ local \_ machine \\ Software \\ Microsoft \\ Windows NT \\ CurrentVersion \\ ProfileList**</span><span class="sxs-lookup"><span data-stu-id="7a064-139">**HKEY\_LOCAL\_MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\ProfileList**</span></span>

<span data-ttu-id="7a064-140">La variable $AllVolumes $ provoque l’application de la chaîne de chemin d’accès à tous les clichés instantanés sur l’ordinateur.</span><span class="sxs-lookup"><span data-stu-id="7a064-140">The $AllVolumes$ variable causes the path string to be applied to all shadow copies on the computer.</span></span> <span data-ttu-id="7a064-141">Supposons, par exemple, que le chemin d’accès est «$AllVolumes $ \\ TemporaryFiles \\ \* . \* /s», et l’ordinateur a trois volumes : C :, D : et E :.</span><span class="sxs-lookup"><span data-stu-id="7a064-141">For example, suppose the path is "$AllVolumes$\\TemporaryFiles\\\*.\* /s", and the computer has three volumes: C:, D:, and E:.</span></span> <span data-ttu-id="7a064-142">Si C : et E : contiennent le chemin d’accès « \\ TemporaryFiles \\ » et que le volume d : contient uniquement le chemin d : \\ Data \\ , l’arborescence de répertoires c : \\ TemporaryFiles \\ est supprimée des clichés instantanés de C :, et l’arborescence de répertoires E : \\ TemporaryFiles \\ est supprimée des clichés instantanés de E :.</span><span class="sxs-lookup"><span data-stu-id="7a064-142">If C: and E: contain the path "\\TemporaryFiles\\", and volume D: contains only the path D:\\Data\\, the directory tree C:\\TemporaryFiles\\ is deleted from shadow copies of C:, and the directory tree E:\\TemporaryFiles\\ is deleted from shadow copies of E:.</span></span>

<span data-ttu-id="7a064-143">Les administrateurs peuvent désactiver l’extension de la variable $UserProfile $ à l’aide de la clé de Registre suivante :</span><span class="sxs-lookup"><span data-stu-id="7a064-143">Administrators can disable expansion of the $UserProfile$ variable by using the following registry key:</span></span>

<span data-ttu-id="7a064-144">**HKEY \_ local \_ machine \\ System \\ système \\ CurrentControlSet \\ services \\ paramètres VSS**</span><span class="sxs-lookup"><span data-stu-id="7a064-144">**HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Services\\Vss\\Settings**</span></span>

<span data-ttu-id="7a064-145">Sous cette clé de Registre, spécifiez DisableUserProfileExpansion pour le nom de la valeur, REG \_ DWORD pour le type de valeur et une valeur différente de zéro pour les données de la valeur.</span><span class="sxs-lookup"><span data-stu-id="7a064-145">Under this registry key, specify DisableUserProfileExpansion for the value name, REG\_DWORD for the value type, and a nonzero value for the value data.</span></span>

## <a name="about-the-filesnottobackup-registry-key"></a><span data-ttu-id="7a064-146">À propos de la clé de Registre FilesNotToBackup</span><span class="sxs-lookup"><span data-stu-id="7a064-146">About the FilesNotToBackup Registry Key</span></span>

<span data-ttu-id="7a064-147">La clé de Registre **FilesNotToBackup** peut être utilisée pour spécifier les noms des fichiers et répertoires que les applications de sauvegarde ne doivent pas sauvegarder ou restaurer.</span><span class="sxs-lookup"><span data-stu-id="7a064-147">The **FilesNotToBackup** registry key can be used to specify the names of the files and directories that backup applications should not backup or restore.</span></span> <span data-ttu-id="7a064-148">Toutefois, il n’exclut pas ces fichiers des clichés instantanés.</span><span class="sxs-lookup"><span data-stu-id="7a064-148">However, it does not exclude those files from shadow copies.</span></span> <span data-ttu-id="7a064-149">Pour plus d’informations sur cette clé de Registre, consultez [clés et valeurs de Registre pour la sauvegarde et la restauration](../backup/registry-keys-for-backup-and-restore.md).</span><span class="sxs-lookup"><span data-stu-id="7a064-149">For more information about this registry key, see [Registry Keys and Values for Backup and Restore](../backup/registry-keys-for-backup-and-restore.md).</span></span>

 

 
