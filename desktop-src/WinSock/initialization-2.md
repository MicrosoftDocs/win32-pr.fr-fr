---
description: Le \_32.dll Ws2 charge la dll d’interface du fournisseur de services dans le système à l’aide des mécanismes de chargement standard de la bibliothèque dynamique Microsoft Windows et l’initialise en appelant WSPStartup.
ms.assetid: 6df28d93-8757-45b3-8f05-86381c3be64e
title: Initialisation
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 84d6ef10db421ef15f2bb94eb67e96fc2cfc5924
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "106515449"
---
# <a name="initialization"></a><span data-ttu-id="e46cb-103">Initialisation</span><span class="sxs-lookup"><span data-stu-id="e46cb-103">Initialization</span></span>

<span data-ttu-id="e46cb-104">Le *\_32.dllWs2* charge la dll d’interface du fournisseur de services dans le système à l’aide des mécanismes de chargement standard de la bibliothèque dynamique Microsoft Windows et l’initialise en appelant [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span><span class="sxs-lookup"><span data-stu-id="e46cb-104">The *Ws2\_32.dll* loads the service provider's interface DLL into the system by using the standard Microsoft Windows dynamic library loading mechanisms, and initializes it by calling [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span></span> <span data-ttu-id="e46cb-105">Cette valeur est généralement déclenchée par une application qui appelle [**Socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) ou [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) pour créer un socket à associer à un fournisseur de services dont la dll d’interface n’est pas actuellement chargée en mémoire.</span><span class="sxs-lookup"><span data-stu-id="e46cb-105">This is typically triggered by an application calling either [**socket**](/windows/desktop/api/Winsock2/nf-winsock2-socket) or [**WSASocket**](/windows/desktop/api/Winsock2/nf-winsock2-wsasocketa) to create a new socket to be associated with a service provider whose interface DLL is not currently loaded into memory.</span></span> <span data-ttu-id="e46cb-106">Le chemin d’accès à chaque DLL d’interface du fournisseur de services est stocké par le *\_32.dllWs2* au moment de l’installation du fournisseur de services.</span><span class="sxs-lookup"><span data-stu-id="e46cb-106">The path to each service provider's interface DLL is stored by the *Ws2\_32.dll* at the time the service provider is being installed.</span></span> <span data-ttu-id="e46cb-107">Pour plus d’informations, consultez [fonctions d’installation et de configuration](installation-and-configuration-functions-2.md) .</span><span class="sxs-lookup"><span data-stu-id="e46cb-107">See [Installation and Configuration Functions](installation-and-configuration-functions-2.md) for more information.</span></span>

<span data-ttu-id="e46cb-108">Au fil du temps, différentes versions peuvent exister pour les dll, les applications et les fournisseurs de services Winsock.</span><span class="sxs-lookup"><span data-stu-id="e46cb-108">Over time, different versions may exist for the Winsock DLLs, applications, and service providers.</span></span> <span data-ttu-id="e46cb-109">Les nouvelles versions peuvent définir de nouvelles fonctionnalités et de nouveaux paramètres pour les structures de données et les paramètres de bits, etc. Les numéros de version indiquent donc comment interpréter diverses structures de données.</span><span class="sxs-lookup"><span data-stu-id="e46cb-109">New versions may define new features and new parameters to data structures and bit parameters, etc. Version numbers therefore indicate how to interpret various data structures.</span></span>

<span data-ttu-id="e46cb-110">Pour permettre un mixage optimal et une correspondance avec les différentes versions d’applications, les versions de l' \_32.dll Ws2 et les versions des fournisseurs de services par différents fournisseurs, le SPI fournit un mécanisme de négociation de version pour une utilisation entre le *\_32.dllWs2* et les fournisseurs de services.</span><span class="sxs-lookup"><span data-stu-id="e46cb-110">To allow optimal mixing and matching of different versions of applications, versions of the Ws2\_32.dll itself, and versions of service providers by different vendors, the SPI provides a version negotiation mechanism for use between the *Ws2\_32.dll* and the service providers.</span></span> <span data-ttu-id="e46cb-111">Cette négociation de version est gérée par [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span><span class="sxs-lookup"><span data-stu-id="e46cb-111">This version negotiation is handled by [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span></span> <span data-ttu-id="e46cb-112">En fait, le *Ws2 \_32.dll* transmet au fournisseur de service les numéros de version les plus élevés avec lesquels il est compatible.</span><span class="sxs-lookup"><span data-stu-id="e46cb-112">Basically, the *Ws2\_32.dll* passes to the service provider the highest version numbers with which it is compatible.</span></span> <span data-ttu-id="e46cb-113">Le fournisseur de services compare ce avec sa propre plage de numéros de version prise en charge.</span><span class="sxs-lookup"><span data-stu-id="e46cb-113">The service provider compares this with its own supported range of version numbers.</span></span> <span data-ttu-id="e46cb-114">Si ces plages se chevauchent, le fournisseur de services retourne une valeur dans la partie chevauchante de la plage en tant que résultat de la négociation.</span><span class="sxs-lookup"><span data-stu-id="e46cb-114">If these ranges overlap, the service provider returns a value within the overlapping portion of the range as the result of the negotiation.</span></span> <span data-ttu-id="e46cb-115">En règle générale, il doit s’agir de la valeur la plus élevée possible.</span><span class="sxs-lookup"><span data-stu-id="e46cb-115">Usually, this should be the highest possible value.</span></span> <span data-ttu-id="e46cb-116">Si les plages ne se chevauchent pas, les deux parties sont incompatibles et la fonction retourne une erreur.</span><span class="sxs-lookup"><span data-stu-id="e46cb-116">If the ranges do not overlap, the two parties are incompatible and the function returns an error.</span></span>

<span data-ttu-id="e46cb-117">[**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) doit être appelé au moins une fois par chaque processus client et peut être appelé plusieurs fois par Ws2 \_32.dll ou d’autres entités.</span><span class="sxs-lookup"><span data-stu-id="e46cb-117">[**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) must be called at least once by each client process, and may be called multiple times by Ws2\_32.dll or other entities.</span></span> <span data-ttu-id="e46cb-118">Un [**WSPCleanup**](/previous-versions/windows/hardware/network/ff566270(v=vs.85)) correspondant doit être appelé pour chaque appel **WSPStartup** réussi.</span><span class="sxs-lookup"><span data-stu-id="e46cb-118">A matching [**WSPCleanup**](/previous-versions/windows/hardware/network/ff566270(v=vs.85)) must be called for each successful **WSPStartup** call.</span></span> <span data-ttu-id="e46cb-119">Le fournisseur de services doit conserver un décompte de références pour chaque processus.</span><span class="sxs-lookup"><span data-stu-id="e46cb-119">The service provider should maintain a reference count on a per-process basis.</span></span> <span data-ttu-id="e46cb-120">À chaque appel de **WSPStartup** , l’appelant peut spécifier n’importe quel numéro de version pris en charge par la dll SP.</span><span class="sxs-lookup"><span data-stu-id="e46cb-120">On each **WSPStartup** call, the caller may specify any version number supported by the SP DLL.</span></span>

<span data-ttu-id="e46cb-121">Un fournisseur de services doit stocker le pointeur vers la table de distribution des appels de client qui est reçue en tant que paramètre [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) pour chaque processus.</span><span class="sxs-lookup"><span data-stu-id="e46cb-121">A service provider must store the pointer to the client's upcall dispatch table that is received as a [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) parameter on a per-process basis.</span></span> <span data-ttu-id="e46cb-122">Si un processus donné appelle plusieurs fois **WSPStartup** , le fournisseur de services doit utiliser uniquement le pointeur de table de dispatch fourni le plus récemment.</span><span class="sxs-lookup"><span data-stu-id="e46cb-122">If a given process calls **WSPStartup** multiple times, the service provider must use only the most recently supplied dispatch table pointer.</span></span>

<span data-ttu-id="e46cb-123">Dans le cadre du processus d’initialisation du fournisseur de services, le \_32.dll Ws2 récupère la table de dispatch du fournisseur de services via le paramètre *lpProcTable* afin d’obtenir des points d’entrée pour le reste des fonctions SPI spécifiées dans ce document.</span><span class="sxs-lookup"><span data-stu-id="e46cb-123">As part of the service provider initialization process The Ws2\_32.dll retrieves the service provider's dispatch table through the *lpProcTable* parameter in order to obtain entry points to the rest of the SPI functions specified in this document.</span></span>

<span data-ttu-id="e46cb-124">L’utilisation d’une table de dispatch (par opposition aux mécanismes de DLL habituels pour l’accès aux points d’entrée) remplit deux fonctions :</span><span class="sxs-lookup"><span data-stu-id="e46cb-124">Using a dispatch table (as opposed to the usual DLL mechanisms for accessing entry points) serves two purposes:</span></span>

-   <span data-ttu-id="e46cb-125">Il est plus pratique pour la32.dll Ws2, \_ car un seul appel peut être fait pour découvrir l’ensemble des points d’entrée.</span><span class="sxs-lookup"><span data-stu-id="e46cb-125">It is more convenient for the Ws2\_32.dll since a single call can be made to discover the entire set of entry points.</span></span>
-   <span data-ttu-id="e46cb-126">Elle permet aux fournisseurs de services en couche formés dans des chaînes de protocole de fonctionner plus efficacement.</span><span class="sxs-lookup"><span data-stu-id="e46cb-126">It enables layered service providers formed into protocol chains to operate more efficiently.</span></span>

## <a name="initializing-protocol-chains"></a><span data-ttu-id="e46cb-127">Initialisation des chaînes de protocole</span><span class="sxs-lookup"><span data-stu-id="e46cb-127">Initializing Protocol Chains</span></span>

<span data-ttu-id="e46cb-128">Au moment où la structure d' [**\_ informations WSAPROTOCOL**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) pour une chaîne de protocole est installée, le chemin d’accès au premier fournisseur superposé dans la chaîne est également spécifié.</span><span class="sxs-lookup"><span data-stu-id="e46cb-128">At the time the [**WSAPROTOCOL\_INFO**](/windows/win32/api/winsock2/ns-winsock2-wsaprotocol_infoa) structure for a protocol chain is installed, the path to the first layered provider in the chain is also specified.</span></span> <span data-ttu-id="e46cb-129">Quand une chaîne de protocole est initialisée, le \_32.dll Ws2 utilise ce chemin pour charger la dll du fournisseur, puis appelle [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span><span class="sxs-lookup"><span data-stu-id="e46cb-129">When a protocol chain is initialized, the Ws2\_32.dll uses this path to load the provider DLL and then invokes [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup).</span></span> <span data-ttu-id="e46cb-130">Étant donné que **WSPStartup** contient un pointeur vers la structure **WSAPROTOCOL \_ info** de la chaîne comme l’un de ses paramètres, les fournisseurs superposés peuvent déterminer le type de chaîne dans lequel ils sont initialisés et l’identité de la couche inférieure suivante dans la chaîne.</span><span class="sxs-lookup"><span data-stu-id="e46cb-130">Since **WSPStartup** includes a pointer to the chain's **WSAPROTOCOL\_INFO** structure as one of its parameters, layered providers can determine what type of chain they are being initialized into, and the identity of the next lower layer in the chain.</span></span> <span data-ttu-id="e46cb-131">Un fournisseur superposé chargera ensuite le fournisseur de protocole suivant dans la chaîne et l’initialise avec un appel à **WSPStartup**, et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="e46cb-131">A layered provider would then in turn load the next protocol provider in the chain and initialize it with a call to **WSPStartup**, and so forth.</span></span> <span data-ttu-id="e46cb-132">Chaque fois que la couche inférieure suivante est un autre fournisseur superposé, la structure d' **\_ informations WSAPROTOCOL** de la chaîne doit être référencée dans l’appel **WSPStartup** .</span><span class="sxs-lookup"><span data-stu-id="e46cb-132">Whenever the next lower layer is another layered provider, the chain's **WSAPROTOCOL\_INFO** structure must be referenced in the **WSPStartup** call.</span></span> <span data-ttu-id="e46cb-133">Lorsque la couche inférieure suivante est un protocole de base (signifiant la fin de la chaîne), la structure d' **\_ informations WSAPROTOCOL** de la chaîne n’est plus propagée vers le bas.</span><span class="sxs-lookup"><span data-stu-id="e46cb-133">When the next lower layer is a base protocol (signifying the end of the chain), the chain's **WSAPROTOCOL\_INFO** structure is no longer propagated downward.</span></span> <span data-ttu-id="e46cb-134">Au lieu de cela, la couche actuelle doit faire référence à une structure **WSAPROTOCOL \_ info** qui correspond au protocole que le fournisseur de base doit utiliser.</span><span class="sxs-lookup"><span data-stu-id="e46cb-134">Instead, the current layer must reference a **WSAPROTOCOL\_INFO** structure that corresponds to the protocol that the base provider should use.</span></span> <span data-ttu-id="e46cb-135">Ainsi, le fournisseur de base n’a aucune notion de impliqué dans une chaîne de protocole.</span><span class="sxs-lookup"><span data-stu-id="e46cb-135">Thus, the base provider has no notion of being involved in a protocol chain.</span></span>

<span data-ttu-id="e46cb-136">La table de dispatch fournie par un fournisseur superposé donné, dans de nombreux cas, duplique les points d’entrée d’un fournisseur sous-jacent.</span><span class="sxs-lookup"><span data-stu-id="e46cb-136">The dispatch table provided by any given layered provider will, in many instances, duplicate the entry points of an underlying provider.</span></span> <span data-ttu-id="e46cb-137">Le fournisseur superposé insère uniquement ses propres points d’entrée pour les fonctions dont il devait être directement impliqué.</span><span class="sxs-lookup"><span data-stu-id="e46cb-137">The layered provider would only insert its own entry points for functions that it needed to be directly involved in.</span></span> <span data-ttu-id="e46cb-138">Notez, cependant, qu’il est impératif qu’un fournisseur en couches ne modifie pas le contenu de la table de l’appel qu’il a reçue lors de l’appel de [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) sur la couche inférieure suivante dans une chaîne de protocole.</span><span class="sxs-lookup"><span data-stu-id="e46cb-138">Note, however, that it is imperative that a layered provider not modify the contents of the upcall table that it received when calling [**WSPStartup**](/windows/desktop/api/Ws2spi/nf-ws2spi-wspstartup) on the next lower layer in a protocol chain.</span></span> <span data-ttu-id="e46cb-139">Ces appels doivent être effectués directement sur la DLL Windows Sockets 2.</span><span class="sxs-lookup"><span data-stu-id="e46cb-139">These upcalls must be made directly to the Windows Sockets 2 DLL.</span></span>

 

 
