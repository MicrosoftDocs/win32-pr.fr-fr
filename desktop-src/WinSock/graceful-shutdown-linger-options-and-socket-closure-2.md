---
description: La documentation suivante est fournie pour clarifier l’objet de la fermeture des connexions de socket qui ferment les sockets. Il est important de distinguer la différence entre l’arrêt d’une connexion de socket et la fermeture d’un Socket.
ms.assetid: 383747c3-dd3d-4a18-b4e8-2815d5e5c0c7
title: Arrêt approprié, options de maintien et fermeture de socket
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 59f6791eaa803da561fc9f3c175b5270950cbec3
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104201434"
---
# <a name="graceful-shutdown-linger-options-and-socket-closure"></a><span data-ttu-id="77521-104">Arrêt approprié, options de maintien et fermeture de socket</span><span class="sxs-lookup"><span data-stu-id="77521-104">Graceful Shutdown, Linger Options, and Socket Closure</span></span>

<span data-ttu-id="77521-105">La documentation suivante est fournie pour clarifier l’objet de la fermeture des connexions de socket qui ferment les sockets.</span><span class="sxs-lookup"><span data-stu-id="77521-105">The following material is provided as clarification for the subject of shutting down socket connections closing the sockets.</span></span> <span data-ttu-id="77521-106">Il est important de distinguer la différence entre l’arrêt d’une connexion de socket et la fermeture d’un Socket.</span><span class="sxs-lookup"><span data-stu-id="77521-106">It is important to distinguish the difference between shutting down a socket connection and closing a socket.</span></span>

<span data-ttu-id="77521-107">L’arrêt d’une connexion de socket implique l’échange de messages de protocole entre les deux points de terminaison, ci-après dénommés « séquence d’arrêt ».</span><span class="sxs-lookup"><span data-stu-id="77521-107">Shutting down a socket connection involves an exchange of protocol messages between the two endpoints, hereafter referred to as a shutdown sequence.</span></span> <span data-ttu-id="77521-108">Deux classes générales de séquences d’arrêt sont définies : normal et abortive (également appelé Hard).</span><span class="sxs-lookup"><span data-stu-id="77521-108">Two general classes of shutdown sequences are defined: graceful and abortive (also called hard).</span></span> <span data-ttu-id="77521-109">Dans une séquence d’arrêt appropriée, toutes les données qui ont été mises en file d’attente mais pas encore transmises peuvent être envoyées avant la fermeture de la connexion.</span><span class="sxs-lookup"><span data-stu-id="77521-109">In a graceful shutdown sequence, any data that has been queued, but not yet transmitted can be sent prior to the connection being closed.</span></span> <span data-ttu-id="77521-110">Lors d’un arrêt abandonné, toutes les données non envoyées sont perdues.</span><span class="sxs-lookup"><span data-stu-id="77521-110">In an abortive shutdown, any unsent data is lost.</span></span> <span data-ttu-id="77521-111">L’occurrence d’une séquence d’arrêt (normale ou abandonnée) peut également être utilisée pour fournir une \_ indication FD Close aux applications associées, ce qui signifie qu’un arrêt est en cours.</span><span class="sxs-lookup"><span data-stu-id="77521-111">The occurrence of a shutdown sequence (graceful or abortive) can also be used to provide an FD\_CLOSE indication to the associated applications signifying that a shutdown is in progress.</span></span>

<span data-ttu-id="77521-112">En revanche, si vous fermez un socket, le handle de socket devient désalloué afin que l’application ne puisse plus référencer ou utiliser le socket de quelque manière que ce soit.</span><span class="sxs-lookup"><span data-stu-id="77521-112">Closing a socket, on the other hand, causes the socket handle to become deallocated so that the application can no longer reference or use the socket in any manner.</span></span>

<span data-ttu-id="77521-113">Dans Windows Sockets, la fonction [**Shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown) et la fonction [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) peuvent être utilisées pour initier une séquence d’arrêt, tandis que la fonction [**opération closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) est utilisée pour libérer les descripteurs de socket et libérer les ressources associées.</span><span class="sxs-lookup"><span data-stu-id="77521-113">In Windows Sockets, both the [**shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown) function, and the [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect) function can be used to initiate a shutdown sequence, while the [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) function is used to deallocate socket handles and free up any associated resources.</span></span> <span data-ttu-id="77521-114">Toutefois, une certaine confusion est due au fait que la fonction **opération closesocket** provoque implicitement une séquence d’arrêt si elle ne s’est pas déjà produite.</span><span class="sxs-lookup"><span data-stu-id="77521-114">Some amount of confusion arises, however, from the fact that the **closesocket** function implicitly causes a shutdown sequence to occur if it has not already happened.</span></span> <span data-ttu-id="77521-115">En fait, il est devenu une pratique de programmation assez courante pour s’appuyer sur cette fonctionnalité et pour utiliser **opération closesocket** à la fois pour initier la séquence d’arrêt et pour libérer le handle de Socket.</span><span class="sxs-lookup"><span data-stu-id="77521-115">In fact, it has become a rather common programming practice to rely on this feature and to use **closesocket** to both initiate the shutdown sequence and deallocate the socket handle.</span></span>

<span data-ttu-id="77521-116">Pour faciliter cette utilisation, l’interface de Sockets fournit des contrôles par le biais du mécanisme d’option de socket qui permet au programmeur d’indiquer si la séquence d’arrêt implicite doit être normale ou abandonnée, et également si la fonction [**opération closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) doit rester en attente (ce qui n’est pas immédiatement terminé) pour permettre l’exécution d’une séquence d’arrêt normale.</span><span class="sxs-lookup"><span data-stu-id="77521-116">To facilitate this usage, the sockets interface provides for controls by way of the socket option mechanism that allow the programmer to indicate whether the implicit shutdown sequence should be graceful or abortive, and also whether the [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) function should linger (that is not complete immediately) to allow time for a graceful shutdown sequence to complete.</span></span> <span data-ttu-id="77521-117">Ces différences importantes et les ramifications de l’utilisation de **opération closesocket** de cette façon ne sont toujours pas largement comprises.</span><span class="sxs-lookup"><span data-stu-id="77521-117">These important distinctions and the ramifications of using **closesocket** in this manner are still not widely understood.</span></span>

<span data-ttu-id="77521-118">En définissant les valeurs appropriées pour les options de socket afin d’en \_ attendre, et donc \_ DONTLINGER, les types de comportement suivants peuvent être obtenus avec la fonction [**opération closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) :</span><span class="sxs-lookup"><span data-stu-id="77521-118">By establishing appropriate values for the socket options SO\_LINGER and SO\_DONTLINGER, the following types of behavior can be obtained with the [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) function:</span></span>

-   <span data-ttu-id="77521-119">Séquence d’arrêt abandonnée, retour immédiat de [**opération closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span><span class="sxs-lookup"><span data-stu-id="77521-119">Abortive shutdown sequence, immediate return from [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span></span>
-   <span data-ttu-id="77521-120">Arrêt approprié, retardant le retour jusqu’à la fin de la séquence d’arrêt ou l’expiration d’un intervalle de temps spécifié.</span><span class="sxs-lookup"><span data-stu-id="77521-120">Graceful shutdown, delaying return until either shutdown sequence completes or a specified time interval elapses.</span></span> <span data-ttu-id="77521-121">Si l’intervalle de temps expire avant la fin de la séquence d’arrêt appropriée, une séquence d’arrêt abandonnée se produit et [**opération closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) retourne.</span><span class="sxs-lookup"><span data-stu-id="77521-121">If the time interval expires before the graceful shutdown sequence completes, an abortive shutdown sequence occurs, and [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) returns.</span></span>
-   <span data-ttu-id="77521-122">Arrêt progressif, retour immédiat, ce qui permet à la séquence d’arrêt de se terminer en arrière-plan.</span><span class="sxs-lookup"><span data-stu-id="77521-122">Graceful shutdown, immediate return—allowing the shutdown sequence to complete in the background.</span></span> <span data-ttu-id="77521-123">Bien qu’il s’agisse du comportement par défaut, l’application n’a aucun moyen de savoir quand (ou si) la séquence d’arrêt appropriée est réellement terminée.</span><span class="sxs-lookup"><span data-stu-id="77521-123">Although this is the default behavior, the application has no way of knowing when (or whether) the graceful shutdown sequence actually completes.</span></span>

<span data-ttu-id="77521-124">L’utilisation des options de \_ Socket SO et so \_ DONTLINGER et de la structure restante associée est abordée plus en détail dans les sections de référence sur les options de [](/windows/desktop/api/winsock/ns-winsock-linger) socket de socket [**série sur sol \_**](sol-socket-socket-options.md) et la structure de **Lingo** .</span><span class="sxs-lookup"><span data-stu-id="77521-124">The use of the SO\_LINGER and SO\_DONTLINGER socket options and the associated [**linger**](/windows/desktop/api/winsock/ns-winsock-linger) structure is discussed in more detail in the reference sections on [**SOL\_SOCKET Socket Options**](sol-socket-socket-options.md) and the **linger** structure.</span></span>

<span data-ttu-id="77521-125">Une technique qui peut être utilisée pour réduire le risque de problèmes survenant au cours de la destruction de la connexion consiste à éviter d’utiliser un arrêt implicite initié par [**opération closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span><span class="sxs-lookup"><span data-stu-id="77521-125">One technique that can be used to minimize the chance of problems occurring during connection teardown is to avoid relying on an implicit shutdown being initiated by [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span></span> <span data-ttu-id="77521-126">Utilisez plutôt l’une des deux fonctions d’arrêt explicites, [**Shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown) ou [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect).</span><span class="sxs-lookup"><span data-stu-id="77521-126">Instead, use one of the two explicit shutdown functions, [**shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown) or [**WSASendDisconnect**](/windows/desktop/api/Winsock2/nf-winsock2-wsasenddisconnect).</span></span> <span data-ttu-id="77521-127">Cela provoque à son tour \_ la réception d’une indication FD close par l’application homologue indiquant que toutes les données en attente ont été reçues.</span><span class="sxs-lookup"><span data-stu-id="77521-127">This in turn causes an FD\_CLOSE indication to be received by the peer application indicating that all pending data has been received.</span></span> <span data-ttu-id="77521-128">Pour illustrer cela, le tableau suivant présente les fonctions qui seraient appelées par les composants client et serveur d’une application, où le client est responsable de l’initialisation d’un arrêt approprié.</span><span class="sxs-lookup"><span data-stu-id="77521-128">To illustrate this, the following table shows the functions that would be invoked by the client and server components of an application, where the client is responsible for initiating a graceful shutdown.</span></span>

| <span data-ttu-id="77521-129">Côté client</span><span class="sxs-lookup"><span data-stu-id="77521-129">Client side</span></span>                                                                                                                | <span data-ttu-id="77521-130">Côté serveur</span><span class="sxs-lookup"><span data-stu-id="77521-130">Server side</span></span>                                                                                           |
|----------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="77521-131">(1) appelle [**Shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD \_ Send) pour signaler la fin de la session et ce dernier n’a plus de données à envoyer.</span><span class="sxs-lookup"><span data-stu-id="77521-131">(1) Invokes [**shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD\_SEND) to signal end of session and that client has no more data to send.</span></span> |                                                                                                       |
|                                                                                                                            | <span data-ttu-id="77521-132">(2) reçoit FD \_ Close, ce qui indique un arrêt correct en cours et que toutes les données ont été reçues.</span><span class="sxs-lookup"><span data-stu-id="77521-132">(2) Receives FD\_CLOSE, indicating graceful shutdown in progress and that all data has been received.</span></span> |
|                                                                                                                            | <span data-ttu-id="77521-133">(3) envoie toutes les données de réponse restantes.</span><span class="sxs-lookup"><span data-stu-id="77521-133">(3) Sends any remaining response data.</span></span>                                                                |
| <span data-ttu-id="77521-134">(précision de minuterie locale uniquement) Obtient FD \_ Read et appelle [**recv**](/windows/desktop/api/winsock/nf-winsock-recv) pour obtenir toutes les données de réponse envoyées par le serveur.</span><span class="sxs-lookup"><span data-stu-id="77521-134">(local timing significance only) Gets FD\_READ and calls [**recv**](/windows/desktop/api/winsock/nf-winsock-recv) to get any response data sent by server .</span></span>  | <span data-ttu-id="77521-135">(4) appelle [**Shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD \_ Send) pour indiquer que le serveur n’a plus de données à envoyer.</span><span class="sxs-lookup"><span data-stu-id="77521-135">(4) Invokes [**shutdown**](/windows/desktop/api/winsock/nf-winsock-shutdown)(s, SD\_SEND) to indicate server has no more data to send.</span></span>  |
| <span data-ttu-id="77521-136">(5) reçoit l' \_ indication FD Close.</span><span class="sxs-lookup"><span data-stu-id="77521-136">(5) Receives FD\_CLOSE indication.</span></span>                                                                                         | <span data-ttu-id="77521-137">(précision de minuterie locale uniquement) Appelle [**opération closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) .</span><span class="sxs-lookup"><span data-stu-id="77521-137">(local timing significance only) Invokes [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket) .</span></span>                       |
| <span data-ttu-id="77521-138">(6) appelle [**opération closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span><span class="sxs-lookup"><span data-stu-id="77521-138">(6) Invokes [**closesocket**](/windows/desktop/api/winsock/nf-winsock-closesocket).</span></span>                                                                          |                                                                                                       |



 

 

 



