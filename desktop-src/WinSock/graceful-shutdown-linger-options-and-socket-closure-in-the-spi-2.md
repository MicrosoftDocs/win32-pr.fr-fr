---
description: Il est important de faire la distinction entre l’arrêt d’une connexion de socket et la fermeture d’un Socket.
ms.assetid: f076b1ec-6b96-4386-8519-4728e0a2b1ff
title: Arrêt approprié, options du reste et fermeture des sockets dans le SPI
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 743cae48977421c08611c79053520799420e9e72
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104526164"
---
# <a name="graceful-shutdown-linger-options-and-socket-closure-in-the-spi"></a><span data-ttu-id="413ac-103">Arrêt approprié, options du reste et fermeture des sockets dans le SPI</span><span class="sxs-lookup"><span data-stu-id="413ac-103">Graceful Shutdown, Linger Options, and Socket Closure in the SPI</span></span>

<span data-ttu-id="413ac-104">Il est important de faire la distinction entre l’arrêt d’une connexion de socket et la fermeture d’un Socket.</span><span class="sxs-lookup"><span data-stu-id="413ac-104">It is important to distinguish between shutting down a socket connection and closing a socket.</span></span> <span data-ttu-id="413ac-105">L’arrêt d’une connexion de socket implique un échange de messages de protocole entre les deux points de terminaison, qui est ci-après dénommé « séquence d’arrêt ».</span><span class="sxs-lookup"><span data-stu-id="413ac-105">Shutting down a socket connection involves an exchange of protocol messages between the two endpoints, which is hereafter referred to as a shutdown sequence.</span></span> <span data-ttu-id="413ac-106">Deux classes générales de séquences d’arrêt sont définies : normale et abandonnée.</span><span class="sxs-lookup"><span data-stu-id="413ac-106">Two general classes of shutdown sequences are defined: graceful and abortive.</span></span> <span data-ttu-id="413ac-107">Dans une séquence d’arrêt appropriée, toutes les données qui ont été mises en file d’attente mais pas encore transmises peuvent être envoyées avant la fermeture de la connexion.</span><span class="sxs-lookup"><span data-stu-id="413ac-107">In a graceful shutdown sequence, any data that has been queued but not yet transmitted can be sent prior to the connection being closed.</span></span> <span data-ttu-id="413ac-108">Lors d’un arrêt abandonné, toutes les données non envoyées sont perdues.</span><span class="sxs-lookup"><span data-stu-id="413ac-108">In an abortive shutdown, any unsent data is lost.</span></span> <span data-ttu-id="413ac-109">L’occurrence d’une séquence d’arrêt (normale ou abandonnée) peut également être utilisée pour fournir une \_ indication FD Close aux applications associées, ce qui signifie qu’un arrêt est en cours.</span><span class="sxs-lookup"><span data-stu-id="413ac-109">The occurrence of a shutdown sequence (graceful or abortive) can also be used to provide an FD\_CLOSE indication to the associated applications signifying that a shutdown is in progress.</span></span> <span data-ttu-id="413ac-110">En revanche, si vous fermez un socket, le handle de socket devient désalloué afin que l’application ne puisse plus référencer ou utiliser le socket de quelque manière que ce soit.</span><span class="sxs-lookup"><span data-stu-id="413ac-110">Closing a socket, on the other hand, causes the socket handle to become deallocated so that the application can no longer reference or use the socket in any manner.</span></span>

<span data-ttu-id="413ac-111">Dans Windows Sockets, la fonction [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) et la fonction [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) peuvent être utilisées pour initier une séquence d’arrêt, tandis que la fonction [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) est utilisée pour libérer les descripteurs de socket et libérer les ressources associées.</span><span class="sxs-lookup"><span data-stu-id="413ac-111">In Windows Sockets, both the [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) function and the [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85)) function can be used to initiate a shutdown sequence, while the [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) function is used to deallocate socket handles and free up any associated resources.</span></span> <span data-ttu-id="413ac-112">Toutefois, une certaine confusion est due au fait que la fonction **WSPCloseSocket** entraînera implicitement une séquence d’arrêt si elle ne s’est pas déjà produite.</span><span class="sxs-lookup"><span data-stu-id="413ac-112">Some amount of confusion arises, however, from the fact that the **WSPCloseSocket** function will implicitly cause a shutdown sequence to occur if it has not already happened.</span></span> <span data-ttu-id="413ac-113">En fait, il est devenu une pratique de programmation assez courante pour s’appuyer sur cette fonctionnalité et utiliser **WSPCloseSocket** pour initier la séquence d’arrêt et libérer le handle de Socket.</span><span class="sxs-lookup"><span data-stu-id="413ac-113">In fact, it has become a rather common programming practice to rely on this feature and use **WSPCloseSocket** to both initiate the shutdown sequence and deallocate the socket handle.</span></span>

<span data-ttu-id="413ac-114">Pour faciliter cette utilisation, l’interface de Sockets fournit des contrôles par le biais du mécanisme d’option de socket qui permet au programmeur d’indiquer si la séquence d’arrêt implicite doit être normale ou abandonnée, et également si la fonction doit attendre la fin de l’exécution d’une séquence d’arrêt normale.</span><span class="sxs-lookup"><span data-stu-id="413ac-114">To facilitate this usage, the sockets interface provides for controls through the socket option mechanism that allows the programmer to indicate whether the implicit shutdown sequence should be graceful or abortive, and also whether the function should linger that is, not complete immediately) to allow time for a graceful shutdown sequence to complete.</span></span>

<span data-ttu-id="413ac-115">En définissant les valeurs appropriées pour les options de socket afin d’en \_ attendre, et donc \_ DONTLINGER, les types de comportement suivants peuvent être obtenus avec la fonction [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) .</span><span class="sxs-lookup"><span data-stu-id="413ac-115">By establishing appropriate values for the socket options SO\_LINGER and SO\_DONTLINGER, the following types of behavior can be obtained with the [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) function.</span></span>

-   <span data-ttu-id="413ac-116">Séquence d’arrêt abandonnée, retour immédiat de [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="413ac-116">Abortive shutdown sequence, immediate return from [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)).</span></span>
-   <span data-ttu-id="413ac-117">Arrêt correct, retarder le renvoi jusqu’à la fin de la séquence d’arrêt ou l’expiration d’un intervalle de temps spécifié.</span><span class="sxs-lookup"><span data-stu-id="413ac-117">Graceful shutdown, delay return until either shutdown sequence completes or a specified time interval elapses.</span></span> <span data-ttu-id="413ac-118">Si l’intervalle de temps expire avant la fin de la séquence d’arrêt appropriée, une séquence d’arrêt abandonnée se produit et [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) retourne.</span><span class="sxs-lookup"><span data-stu-id="413ac-118">If the time interval expires before the graceful shutdown sequence completes, an abortive shutdown sequence occurs and [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)) returns.</span></span>
-   <span data-ttu-id="413ac-119">Arrêt correct, retour immédiat et autoriser la fin de la séquence d’arrêt en arrière-plan.</span><span class="sxs-lookup"><span data-stu-id="413ac-119">Graceful shutdown, return immediately, and allow the shutdown sequence to complete in the background.</span></span> <span data-ttu-id="413ac-120">Il s'agit du comportement par défaut.</span><span class="sxs-lookup"><span data-stu-id="413ac-120">This is the default behavior.</span></span> <span data-ttu-id="413ac-121">Notez, toutefois, que l’application n’a aucun moyen de savoir quand (ou si) la séquence d’arrêt appropriée est terminée.</span><span class="sxs-lookup"><span data-stu-id="413ac-121">Note, however, that the application has no way of knowing when (or whether) the graceful shutdown sequence completes.</span></span>

<span data-ttu-id="413ac-122">Une technique qui peut être utilisée pour réduire le risque de problèmes survenant lors de la destruction de la connexion ne s’appuie pas sur un arrêt implicite initié par [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="413ac-122">One technique that can be used to minimize the chance of problems occurring during connection teardown is not to rely on an implicit shutdown being initiated by [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85)).</span></span> <span data-ttu-id="413ac-123">Au lieu de cela, l’une des deux fonctions d’arrêt explicites ([**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) ou [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85))) est utilisée.</span><span class="sxs-lookup"><span data-stu-id="413ac-123">Instead, one of the two explicit shutdown functions ([**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) or [**WSPSendDisconnect**](/previous-versions/windows/desktop/legacy/ms742290(v=vs.85))) are used.</span></span> <span data-ttu-id="413ac-124">Cela entraîne \_ la réception d’une indication FD close par l’application homologue indiquant que toutes les données en attente ont été reçues.</span><span class="sxs-lookup"><span data-stu-id="413ac-124">This in turn will cause an FD\_CLOSE indication to be received by the peer application indicating that all pending data has been received.</span></span> <span data-ttu-id="413ac-125">Pour illustrer cela, le tableau suivant présente les fonctions qui seraient appelées par les composants client et serveur d’une application, où le client est responsable de l’initialisation d’un arrêt approprié.</span><span class="sxs-lookup"><span data-stu-id="413ac-125">To illustrate this, the following table shows the functions that would be invoked by the client and server components of an application, where the client is responsible for initiating a graceful shutdown.</span></span>

| <span data-ttu-id="413ac-126">Côté client</span><span class="sxs-lookup"><span data-stu-id="413ac-126">Client side</span></span>                                                                                                                         | <span data-ttu-id="413ac-127">Côté serveur</span><span class="sxs-lookup"><span data-stu-id="413ac-127">Server side</span></span>                                                                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="413ac-128">(1) appelle [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) (*s*, SD \_ Send) pour signaler la fin de la session et ce client n’a plus de données à envoyer.</span><span class="sxs-lookup"><span data-stu-id="413ac-128">(1) Invokes [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85)) (*s*, SD\_SEND) to signal end of session and that client has no more data to send.</span></span> |                                                                                                              |
|                                                                                                                                     | <span data-ttu-id="413ac-129">(2) reçoit FD \_ Close, ce qui indique un arrêt correct en cours et que toutes les données ont été reçues.</span><span class="sxs-lookup"><span data-stu-id="413ac-129">(2) Receives FD\_CLOSE, indicating graceful shutdown in progress and that all data has been received.</span></span>        |
|                                                                                                                                     | <span data-ttu-id="413ac-130">(3) envoie toutes les données de réponse restantes.</span><span class="sxs-lookup"><span data-stu-id="413ac-130">(3) Sends any remaining response data.</span></span>                                                                       |
| <span data-ttu-id="413ac-131">(5 ') obtient FD \_ Read et Invoke recv pour obtenir toutes les données de réponse envoyées par le serveur.</span><span class="sxs-lookup"><span data-stu-id="413ac-131">(5') Gets FD\_READ and invoke recv to get any response data sent by server.</span></span>                                                         | <span data-ttu-id="413ac-132">(4) appelle [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85))(*s*, SD \_ Send) pour indiquer que le serveur n’a plus de données à envoyer.</span><span class="sxs-lookup"><span data-stu-id="413ac-132">(4) Invokes [**WSPShutdown**](/previous-versions/windows/desktop/legacy/ms742294(v=vs.85))(*s*, SD\_SEND) to indicate server has no more data to send.</span></span> |
| <span data-ttu-id="413ac-133">(5) reçoit l' \_ indication FD Close.</span><span class="sxs-lookup"><span data-stu-id="413ac-133">(5) Receives FD\_CLOSE indication.</span></span>                                                                                                  | <span data-ttu-id="413ac-134">(4 ') appelle [ **WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="413ac-134">(4') Invokes [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span></span>                                                      |
| <span data-ttu-id="413ac-135">(6) appelle [ **WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="413ac-135">(6) Invokes [**WSPCloseSocket**](/previous-versions/windows/hardware/network/ff566273(v=vs.85))</span></span>                                                                              |                                                                                                              |



 

<span data-ttu-id="413ac-136">La séquence de minutage est conservée de l’étape (1) à l’étape (6) entre le client et le serveur. à l’exception des étapes (4 ') et (5 ') qui ont uniquement une importance locale dans le sens où l’étape (5) suit l’étape (5 ') côté client tandis que STEP (4 ') suit STEP (4) côté serveur, sans aucune relation de synchronisation avec le tiers distant.</span><span class="sxs-lookup"><span data-stu-id="413ac-136">The timing sequence is maintained from step (1) to step (6) between the client and the server, except for steps (4') and (5') which only have local timing significance in the sense that step (5) follows step (5') on the client side while step (4') follows step (4) on the server side, with no timing relationship with the remote party.</span></span>

 

 
