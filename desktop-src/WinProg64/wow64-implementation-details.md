---
title: Détails de l’implémentation WOW64
description: L’émulateur WOW64 s’exécute en mode utilisateur.
ms.assetid: 93daf9d0-dfdb-42c3-8c3d-397b21991e83
keywords:
- WOW64 64 bits, programmation Windows, variables d’environnement
- WOW64 (programmation Windows) 64 bits, implémentation
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4c7d095369b883171e39bffd4dc629b7f80a7f39
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/20/2020
ms.locfileid: "104101828"
---
# <a name="wow64-implementation-details"></a><span data-ttu-id="1ee06-105">Détails de l’implémentation WOW64</span><span class="sxs-lookup"><span data-stu-id="1ee06-105">WOW64 Implementation Details</span></span>

<span data-ttu-id="1ee06-106">L’émulateur WOW64 s’exécute en mode utilisateur.</span><span class="sxs-lookup"><span data-stu-id="1ee06-106">The WOW64 emulator runs in user mode.</span></span> <span data-ttu-id="1ee06-107">Il fournit une interface entre la version 32 bits de Ntdll.dll et le noyau du processeur, et intercepte les appels de noyau.</span><span class="sxs-lookup"><span data-stu-id="1ee06-107">It provides an interface between the 32-bit version of Ntdll.dll and the kernel of the processor, and it intercepts kernel calls.</span></span> <span data-ttu-id="1ee06-108">L’émulateur WOW64 se compose des dll suivantes :</span><span class="sxs-lookup"><span data-stu-id="1ee06-108">The WOW64 emulator consists of the following DLLs:</span></span>

-   <span data-ttu-id="1ee06-109">Wow64.dll fournit l’infrastructure d’émulation principale et les thunks pour les fonctions de point d’entrée Ntoskrnl.exe.</span><span class="sxs-lookup"><span data-stu-id="1ee06-109">Wow64.dll provides the core emulation infrastructure and the thunks for the Ntoskrnl.exe entry-point functions.</span></span>
-   <span data-ttu-id="1ee06-110">Wow64Win.dll fournit des thunks pour les fonctions de point d’entrée Win32k.sys.</span><span class="sxs-lookup"><span data-stu-id="1ee06-110">Wow64Win.dll provides thunks for the Win32k.sys entry-point functions.</span></span>
-   <span data-ttu-id="1ee06-111">(x64 uniquement) Wow64Cpu.dll prend en charge l’exécution de programmes x86 sur x64.</span><span class="sxs-lookup"><span data-stu-id="1ee06-111">(x64 only) Wow64Cpu.dll provides support for running x86 programs on x64.</span></span>
-   <span data-ttu-id="1ee06-112">(Intel Itanium uniquement) IA32Exec. bin contient l’émulateur de logiciel x86.</span><span class="sxs-lookup"><span data-stu-id="1ee06-112">(Intel Itanium only) IA32Exec.bin contains the x86 software emulator.</span></span>
-   <span data-ttu-id="1ee06-113">(Intel Itanium uniquement) Wowia32x.dll fournit l’interface entre IA32Exec. bin et WOW64.</span><span class="sxs-lookup"><span data-stu-id="1ee06-113">(Intel Itanium only) Wowia32x.dll provides the interface between IA32Exec.bin and WOW64.</span></span>
-   <span data-ttu-id="1ee06-114">(ARM64 uniquement) xtajit.dll contient l’émulateur de logiciel x86.</span><span class="sxs-lookup"><span data-stu-id="1ee06-114">(ARM64 only) xtajit.dll contains the x86 software emulator.</span></span>
-   <span data-ttu-id="1ee06-115">(ARM64 uniquement) wowarmw.dll prend en charge l’exécution de programmes ARM32 sur ARM64.</span><span class="sxs-lookup"><span data-stu-id="1ee06-115">(ARM64 only) wowarmw.dll provides support for running ARM32 programs on ARM64.</span></span>

<span data-ttu-id="1ee06-116">Ces dll, ainsi que la version 64 bits de Ntdll.dll, sont les seuls binaires 64 bits qui peuvent être chargés dans un processus 32 bits.</span><span class="sxs-lookup"><span data-stu-id="1ee06-116">These DLLs, along with the 64-bit version of Ntdll.dll, are the only 64-bit binaries that can be loaded into a 32-bit process.</span></span> <span data-ttu-id="1ee06-117">Sur Windows 10 sur ARM, les fichiers binaires CHPE (fichier exécutable hybride hybride compilé) peuvent également être chargés dans un processus x86 32 bits.</span><span class="sxs-lookup"><span data-stu-id="1ee06-117">On Windows 10 on ARM, CHPE (Compiled Hybrid Portable Executable) binaries may also be loaded into an x86 32-bit process.</span></span>

<span data-ttu-id="1ee06-118">Au démarrage, Wow64.dll charge la version x86 de Ntdll.dll (ou la version CHPE, si elle est activée) et exécute son code d’initialisation, qui charge toutes les dll 32 bits nécessaires.</span><span class="sxs-lookup"><span data-stu-id="1ee06-118">At startup, Wow64.dll loads the x86 version of Ntdll.dll (or the CHPE version, if enabled) and runs its initialization code, which loads all necessary 32-bit DLLs.</span></span> <span data-ttu-id="1ee06-119">Presque toutes les dll 32 bits sont des copies non modifiées des binaires Windows 32 bits, bien que certaines soient chargées en tant que CHPE pour des raisons de performances.</span><span class="sxs-lookup"><span data-stu-id="1ee06-119">Almost all 32-bit DLLs are unmodified copies of 32-bit Windows binaries, though some are loaded as CHPE for performance reasons.</span></span> <span data-ttu-id="1ee06-120">Certaines de ces dll sont écrites pour se comporter différemment sur WOW64 et sur Windows 32 bits, généralement parce qu’elles partagent la mémoire avec les composants système de 64 bits.</span><span class="sxs-lookup"><span data-stu-id="1ee06-120">Some of these DLLs are written to behave differently on WOW64 than they do on 32-bit Windows, usually because they share memory with 64-bit system components.</span></span> <span data-ttu-id="1ee06-121">Tout l’espace d’adressage en mode utilisateur au-dessus de la limite de 32 bits est réservé par le système.</span><span class="sxs-lookup"><span data-stu-id="1ee06-121">All user-mode address space above the 32-bit limit is reserved by the system.</span></span> <span data-ttu-id="1ee06-122">Pour plus d’informations, consultez [consommation de performances et de mémoire sous WOW64](performance-and-memory-consumption.md).</span><span class="sxs-lookup"><span data-stu-id="1ee06-122">For more information, see [Performance and Memory Consumption under WOW64](performance-and-memory-consumption.md).</span></span>

<span data-ttu-id="1ee06-123">Au lieu d’utiliser la séquence d’appels du service système x86, les binaires 32 bits qui effectuent des appels système sont reconstruits pour utiliser une séquence d’appel personnalisée.</span><span class="sxs-lookup"><span data-stu-id="1ee06-123">Instead of using the x86 system-service call sequence, 32-bit binaries that make system calls are rebuilt to use a custom calling sequence.</span></span> <span data-ttu-id="1ee06-124">Cette séquence d’appel est peu coûteuse pour que WOW64 soit interceptée, car elle reste entièrement en mode utilisateur.</span><span class="sxs-lookup"><span data-stu-id="1ee06-124">This calling sequence is inexpensive for WOW64 to intercept because it remains entirely in user mode.</span></span> <span data-ttu-id="1ee06-125">Lorsque la séquence d’appel personnalisée est détectée, l’UC WOW64 passe en mode natif 64 bits et appelle Wow64.dll.</span><span class="sxs-lookup"><span data-stu-id="1ee06-125">When the custom calling sequence is detected, the WOW64 CPU transitions back to native 64-bit mode and calls into Wow64.dll.</span></span> <span data-ttu-id="1ee06-126">Le thunking est effectué en mode utilisateur pour réduire l’impact sur le noyau 64 bits et pour réduire le risque d’un bogue dans le thunk qui peut provoquer un incident en mode noyau, une altération des données ou une brèche de sécurité.</span><span class="sxs-lookup"><span data-stu-id="1ee06-126">Thunking is done in user mode to reduce the impact on the 64-bit kernel and to reduce the risk of a bug in the thunk that might cause a kernel-mode crash, data corruption, or a security hole.</span></span> <span data-ttu-id="1ee06-127">Les thunks extraient les arguments de la pile 32 bits, les étendent à 64 bits, puis effectuent l’appel système natif.</span><span class="sxs-lookup"><span data-stu-id="1ee06-127">The thunks extract arguments from the 32-bit stack, extend them to 64 bits, then make the native system call.</span></span>

## <a name="environment-variables"></a><span data-ttu-id="1ee06-128">Variables d'environnement</span><span class="sxs-lookup"><span data-stu-id="1ee06-128">Environment Variables</span></span>

<span data-ttu-id="1ee06-129">Quand un processus 32 bits est créé par un processus 64 bits, ou lorsqu’un processus 64 bits est créé par un processus de 32 bits, WOW64 définit les variables d’environnement pour le processus créé, comme indiqué dans le tableau suivant.</span><span class="sxs-lookup"><span data-stu-id="1ee06-129">When a 32-bit process is created by a 64-bit process, or when a 64-bit process is created by a 32-bit process, WOW64 sets the environment variables for the created process as shown in the following table.</span></span>



| <span data-ttu-id="1ee06-130">Process</span><span class="sxs-lookup"><span data-stu-id="1ee06-130">Process</span></span>                   | <span data-ttu-id="1ee06-131">Variables d'environnement</span><span class="sxs-lookup"><span data-stu-id="1ee06-131">Environment variables</span></span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|---------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="1ee06-132">processus 64 bits</span><span class="sxs-lookup"><span data-stu-id="1ee06-132">64-bit process</span></span><br/> | <span data-ttu-id="1ee06-133">Architecture du processeur \_ = amd64 ou \_ architecture du processeur = IA64 ou architecture du processeur \_ = ARM64</span><span class="sxs-lookup"><span data-stu-id="1ee06-133">PROCESSOR\_ARCHITECTURE=AMD64 or PROCESSOR\_ARCHITECTURE=IA64 or PROCESSOR\_ARCHITECTURE=ARM64</span></span><br/> <span data-ttu-id="1ee06-134">ProgramFiles =% ProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="1ee06-134">ProgramFiles=%ProgramFiles%</span></span><br/> <span data-ttu-id="1ee06-135">ProgramW6432 =% ProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="1ee06-135">ProgramW6432=%ProgramFiles%</span></span><br/> <span data-ttu-id="1ee06-136">CommonProgramFiles =% CommonProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="1ee06-136">CommonProgramFiles=%CommonProgramFiles%</span></span><br/> <span data-ttu-id="1ee06-137">CommonProgramW6432 =% CommonProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="1ee06-137">CommonProgramW6432=%CommonProgramFiles%</span></span><br/> <span data-ttu-id="1ee06-138">**Windows server 2008, Windows Vista, Windows server 2003 et Windows XP :** Les variables d’environnement ProgramW6432 et CommonProgramW6432 ont été ajoutées à partir de Windows 7 et de Windows Server 2008 R2.</span><span class="sxs-lookup"><span data-stu-id="1ee06-138">**Windows Server 2008, Windows Vista, Windows Server 2003 and Windows XP:** The ProgramW6432 and CommonProgramW6432 environment variables were added starting with Windows 7 and Windows Server 2008 R2.</span></span> <br/> |
| <span data-ttu-id="1ee06-139">processus 32 bits</span><span class="sxs-lookup"><span data-stu-id="1ee06-139">32-bit process</span></span><br/> | <span data-ttu-id="1ee06-140">ARCHITECTURE du processeur \_ = x86</span><span class="sxs-lookup"><span data-stu-id="1ee06-140">PROCESSOR\_ARCHITECTURE=x86</span></span><br/> <span data-ttu-id="1ee06-141">PROCESSEUR \_ ARCHITEW6432 =% \_ architecture processeur%</span><span class="sxs-lookup"><span data-stu-id="1ee06-141">PROCESSOR\_ARCHITEW6432=%PROCESSOR\_ARCHITECTURE%</span></span><br/> <span data-ttu-id="1ee06-142">ProgramFiles =% ProgramFiles (x86)%</span><span class="sxs-lookup"><span data-stu-id="1ee06-142">ProgramFiles=%ProgramFiles(x86)%</span></span><br/> <span data-ttu-id="1ee06-143">ProgramW6432 =% ProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="1ee06-143">ProgramW6432=%ProgramFiles%</span></span><br/> <span data-ttu-id="1ee06-144">CommonProgramFiles =% CommonProgramFiles (x86)%</span><span class="sxs-lookup"><span data-stu-id="1ee06-144">CommonProgramFiles=%CommonProgramFiles(x86)%</span></span><br/> <span data-ttu-id="1ee06-145">CommonProgramW6432 =% CommonProgramFiles%</span><span class="sxs-lookup"><span data-stu-id="1ee06-145">CommonProgramW6432=%CommonProgramFiles%</span></span><br/>                                                                                                                                                                                                                  |



 

## <a name="global-hooks"></a><span data-ttu-id="1ee06-146">Raccordements globaux</span><span class="sxs-lookup"><span data-stu-id="1ee06-146">Global Hooks</span></span>

<span data-ttu-id="1ee06-147">La fonction [**SetWindowsHookEx**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa) peut être utilisée pour injecter une dll dans un autre processus si les conditions suivantes sont remplies :</span><span class="sxs-lookup"><span data-stu-id="1ee06-147">The [**SetWindowsHookEx**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa) function can be used to inject a DLL into another process if the following conditions are met:</span></span>

-   <span data-ttu-id="1ee06-148">Une DLL 32 bits peut être injectée uniquement dans un processus 32 bits et une DLL 64 bits ne peut être injectée que dans un processus de 64 bits.</span><span class="sxs-lookup"><span data-stu-id="1ee06-148">A 32-bit DLL can be injected only into a 32-bit process, and a 64-bit DLL can be injected only into a 64-bit process.</span></span> <span data-ttu-id="1ee06-149">Il n’est pas possible d’injecter une DLL 32 bits dans un processus 64 bits ou vice versa.</span><span class="sxs-lookup"><span data-stu-id="1ee06-149">It is not possible to inject a 32-bit DLL into a 64-bit process or vice versa.</span></span>
-   <span data-ttu-id="1ee06-150">Les dll 32 bits et 64 bits doivent avoir des noms différents.</span><span class="sxs-lookup"><span data-stu-id="1ee06-150">The 32-bit and 64-bit DLLs must have different names.</span></span>
-   <span data-ttu-id="1ee06-151">Les architectures de la DLL et du processus doivent correspondre.</span><span class="sxs-lookup"><span data-stu-id="1ee06-151">The architectures of the DLL and the process must match.</span></span> <span data-ttu-id="1ee06-152">Par exemple, vous ne pouvez pas injecter une DLL x86 32 bits dans un processus ARM 32 bits.</span><span class="sxs-lookup"><span data-stu-id="1ee06-152">For instance, you cannot inject a 32-bit x86 DLL into a 32-bit ARM process.</span></span>

<span data-ttu-id="1ee06-153">Pour plus d’informations, consultez [**SetWindowsHookEx**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa).</span><span class="sxs-lookup"><span data-stu-id="1ee06-153">For more information, see [**SetWindowsHookEx**](/windows/win32/api/winuser/nf-winuser-setwindowshookexa).</span></span>

<span data-ttu-id="1ee06-154">N’oubliez pas que l’appel de la **\_ souris**, du **\_ clavier**, du **\_ \* Journal** des opérations, de l' **\_ interpréteur** de commandes et des crochets de bas niveau peut être appelé sur le thread qui a installé le hook plutôt que sur le thread traitant le hook.</span><span class="sxs-lookup"><span data-stu-id="1ee06-154">Be aware that the **WH\_MOUSE**, **WH\_KEYBOARD**, **WH\_JOURNAL\***, **WH\_SHELL**, and low-level hooks can be called on the thread that installed the hook rather than the thread processing the hook.</span></span> <span data-ttu-id="1ee06-155">Pour ces raccordements, il est possible que les crochets 32 bits et 64 bits soient appelés si un hook 32 bits est avant un hook 64 bits dans la chaîne de raccordement.</span><span class="sxs-lookup"><span data-stu-id="1ee06-155">For these hooks, it is possible that both the 32-bit and 64-bit hooks will be called if a 32-bit hook is ahead of a 64-bit hook in the hook chain.</span></span> <span data-ttu-id="1ee06-156">Pour plus d’informations, consultez [utilisation de hooks](../winmsg/using-hooks.md).</span><span class="sxs-lookup"><span data-stu-id="1ee06-156">For more information, see [Using Hooks](../winmsg/using-hooks.md).</span></span>

 

