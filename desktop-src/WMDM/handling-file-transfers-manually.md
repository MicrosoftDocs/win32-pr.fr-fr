---
title: Gestion manuelle des transferts de fichiers
description: Gestion manuelle des transferts de fichiers
ms.assetid: ff94191b-a0f2-4118-996c-d040f214fb9b
keywords:
- Gestionnaire de périphériques Windows Media, transferts de fichiers manuels
- Gestionnaire de périphériques, transferts de fichiers manuels
- Guide de programmation, transferts de fichiers manuels
- applications de bureau, transferts de fichiers manuels
- création d’applications Windows Media Gestionnaire de périphériques, transferts de fichiers manuels
- transferts de fichiers manuels
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a2bf12404e8cd83b6f0c0e4f1c8ec8b0b7bda205
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/20/2020
ms.locfileid: "103728940"
---
# <a name="handling-file-transfers-manually"></a><span data-ttu-id="dc110-109">Gestion manuelle des transferts de fichiers</span><span class="sxs-lookup"><span data-stu-id="dc110-109">Handling File Transfers Manually</span></span>

<span data-ttu-id="dc110-110">Votre application peut implémenter l’interface [**IWMDMOperation**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmoperation) pour gérer une partie du processus de lecture ou d’écriture.</span><span class="sxs-lookup"><span data-stu-id="dc110-110">Your application can implement the [**IWMDMOperation**](/windows/desktop/api/mswmdm/nn-mswmdm-iwmdmoperation) interface to manage part of the reading or writing process.</span></span> <span data-ttu-id="dc110-111">Sur une lecture à partir de l’appareil, l’implémentation permet à l’application de recevoir des blocs de données brutes à partir d’un fichier d’appareil.</span><span class="sxs-lookup"><span data-stu-id="dc110-111">On a read from device, the implementation enables the application to receive blocks of raw data from a device file.</span></span> <span data-ttu-id="dc110-112">Sur une écriture sur un appareil, elle permet à l’application d’envoyer des blocs de données brutes à un fichier sur l’appareil.</span><span class="sxs-lookup"><span data-stu-id="dc110-112">On a write to device, it enables the application to send blocks of raw data to a file on the device.</span></span>

<span data-ttu-id="dc110-113">Dans les opérations de lecture et d’écriture, la méthode [**IWMDMOperation :: TransferObjectData**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) passe les données entre l’ordinateur et l’appareil.</span><span class="sxs-lookup"><span data-stu-id="dc110-113">In both read and write operations, the [**IWMDMOperation::TransferObjectData**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) method passes the data between the computer and the device.</span></span> <span data-ttu-id="dc110-114">Pour connaître la direction du transfert de données, votre application doit définir un indicateur lorsque Windows Media Gestionnaire de périphériques appelle [**BeginRead**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginread) ou [**BeginWrite**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginwrite).</span><span class="sxs-lookup"><span data-stu-id="dc110-114">To know the direction of the data transfer, your application must set a flag when Windows Media Device Manager calls [**BeginRead**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginread) or [**BeginWrite**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginwrite).</span></span> <span data-ttu-id="dc110-115">Lorsque la méthode [**end**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) est appelée, l’application doit réinitialiser cet indicateur.</span><span class="sxs-lookup"><span data-stu-id="dc110-115">When the [**End**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) method is called, the application should reset this flag.</span></span>

> [!Note]  
> <span data-ttu-id="dc110-116">Si le fournisseur de services et l’appareil implémentent correctement [**IMDSPObject2**](/windows/desktop/api/mswmdm/nn-mswmdm-imdspobject2), il appelle d’abord la méthode [IWMDMOperation3 :: TransferObjectDataOnClearChannel](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation3-transferobjectdataonclearchannel) de l’application, si elle est implémentée.</span><span class="sxs-lookup"><span data-stu-id="dc110-116">If the service provider and device properly implement [**IMDSPObject2**](/windows/desktop/api/mswmdm/nn-mswmdm-imdspobject2), it will first call the application's [IWMDMOperation3::TransferObjectDataOnClearChannel](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation3-transferobjectdataonclearchannel) method, if implemented.</span></span> <span data-ttu-id="dc110-117">Cette méthode est un moyen plus efficace de transférer des données.</span><span class="sxs-lookup"><span data-stu-id="dc110-117">This method is a more efficient way of transferring data.</span></span> <span data-ttu-id="dc110-118">**TransferObjectDataOnClearChannel** est traité de la même façon que **TransferObjectData**, sauf que les données ne sont jamais chiffrées et n’ont pas de valeurs Mac à vérifier.</span><span class="sxs-lookup"><span data-stu-id="dc110-118">**TransferObjectDataOnClearChannel** is handled the same way as **TransferObjectData**, except that the data is never encrypted and has no MAC values to verify.</span></span>

 

<span data-ttu-id="dc110-119">Les sections suivantes décrivent le processus de lecture et d’écriture, lorsque votre application implémente **IWMDMOperation**.</span><span class="sxs-lookup"><span data-stu-id="dc110-119">The following sections describe both the reading and the writing process, when your application implements **IWMDMOperation**.</span></span>

<span data-ttu-id="dc110-120">**Lire à partir d’un appareil**</span><span class="sxs-lookup"><span data-stu-id="dc110-120">**Reading from a device**</span></span>

<span data-ttu-id="dc110-121">Lors de la lecture d’un fichier à partir d’un appareil, Windows Media Gestionnaire de périphériques appelle les méthodes **IWMDMOperation** suivantes dans l’ordre :</span><span class="sxs-lookup"><span data-stu-id="dc110-121">When reading a file from a device, Windows Media Device Manager calls the following **IWMDMOperation** methods in order:</span></span>

-   <span data-ttu-id="dc110-122">[**BeginRead**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginread) Appelé pour avertir l’application qu’une lecture à partir d’un appareil commence.</span><span class="sxs-lookup"><span data-stu-id="dc110-122">[**BeginRead**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginread) Called to notify the application that a read from device is beginning.</span></span>
-   <span data-ttu-id="dc110-123">[**TransferObjectData**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) Appelée une ou plusieurs fois.</span><span class="sxs-lookup"><span data-stu-id="dc110-123">[**TransferObjectData**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) Called one or more times.</span></span> <span data-ttu-id="dc110-124">Le traitement des données est décrit dans les étapes suivantes :</span><span class="sxs-lookup"><span data-stu-id="dc110-124">The processing of data is described in the following steps:</span></span>
    1.  <span data-ttu-id="dc110-125">**TransferObjectData** reçoit une mémoire tampon, *pData*, de taille *pdwSize* octets, remplie de données et un Mac pour vérifier les données entrantes.</span><span class="sxs-lookup"><span data-stu-id="dc110-125">**TransferObjectData** receives a buffer, *pData*, of size *pdwSize* bytes, filled with data, and a MAC to verify the incoming data.</span></span>
    2.  <span data-ttu-id="dc110-126">L’application vérifie les paramètres entrants avec le MAC des données entrantes.</span><span class="sxs-lookup"><span data-stu-id="dc110-126">The application verifies the incoming parameters with the incoming data MAC.</span></span>
    3.  <span data-ttu-id="dc110-127">L’application déchiffre et lit autant de données que possible dans *pData* , et modifie la valeur retournée de *pdwSize* pour indiquer le nombre d’octets réellement lus.</span><span class="sxs-lookup"><span data-stu-id="dc110-127">The application decrypts and reads as much of the data in *pData* as it can, and modifies the returned value of *pdwSize* to indicate how many bytes were actually read.</span></span>
    4.  <span data-ttu-id="dc110-128">L’application déchiffre les données, à l’aide de [**CSecureChannelClient ::D ecryptparam**](/previous-versions/bb231586(v=vs.85)), et les stocke ou les utilise, si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="dc110-128">The application decrypts the data, using [**CSecureChannelClient::DecryptParam**](/previous-versions/bb231586(v=vs.85)), and stores it or uses it, as needed.</span></span>
    5.  <span data-ttu-id="dc110-129">**TransferObjectData** retourne S \_ OK.</span><span class="sxs-lookup"><span data-stu-id="dc110-129">**TransferObjectData** returns S\_OK.</span></span>
    6.  <span data-ttu-id="dc110-130">Windows Media Gestionnaire de périphériques continue d’appeler **TransferObjectData** jusqu’à ce que l’application ait lu toutes les données du fichier, ou l’application renvoie WMDM \_ E \_ User \_ Cancelled pour annuler l’opération (auquel cas la lecture est annulée, et Windows Media gestionnaire de périphériques appelle **end**).</span><span class="sxs-lookup"><span data-stu-id="dc110-130">Windows Media Device Manager continues to call **TransferObjectData** until the application has read all the data from the file, or the application returns WMDM\_E\_USER\_CANCELLED to cancel the operation (in which case the read is canceled, and Windows Media Device Manager calls **End**).</span></span>
-   <span data-ttu-id="dc110-131">[**Fin**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) Appelé pour avertir l’application qu’une lecture à partir de l’appareil se termine.</span><span class="sxs-lookup"><span data-stu-id="dc110-131">[**End**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) Called to notify the application that a read from device is ending.</span></span>

<span data-ttu-id="dc110-132">**Écriture sur un appareil**</span><span class="sxs-lookup"><span data-stu-id="dc110-132">**Writing to a device**</span></span>

<span data-ttu-id="dc110-133">Lors de l’écriture d’un fichier sur l’appareil, Windows Media Gestionnaire de périphériques appelle les méthodes **IWMDMOperation** suivantes dans l’ordre :</span><span class="sxs-lookup"><span data-stu-id="dc110-133">When writing a file to the device, Windows Media Device Manager calls the following **IWMDMOperation** methods in order:</span></span>

-   <span data-ttu-id="dc110-134">[**GetObjectName**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjectname) Appelé pour permettre à l’application de spécifier un nom pour le nouveau stockage.</span><span class="sxs-lookup"><span data-stu-id="dc110-134">[**GetObjectName**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjectname) Called to allow the application to specify a name for the new storage.</span></span> <span data-ttu-id="dc110-135">Cette méthode est appelée uniquement si l’application n’a pas spécifié de nom dans la méthode **Insert** .</span><span class="sxs-lookup"><span data-stu-id="dc110-135">This method is only called if the application did not specify a name in the **Insert** method.</span></span>
-   <span data-ttu-id="dc110-136">[**GetObjectAttributes**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjectattributes) Appelé pour permettre à l’application de spécifier des attributs pour le nouveau stockage sur l’appareil.</span><span class="sxs-lookup"><span data-stu-id="dc110-136">[**GetObjectAttributes**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjectattributes) Called to allow the application to specify attributes for the new storage on the device.</span></span>
-   <span data-ttu-id="dc110-137">[**BeginWrite**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginwrite) Appelé pour avertir qu’une écriture sur l’appareil commence.</span><span class="sxs-lookup"><span data-stu-id="dc110-137">[**BeginWrite**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-beginwrite) Called to notify that that a write to device is beginning.</span></span>
-   <span data-ttu-id="dc110-138">[**GetObjectTotalSize**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjecttotalsize) Appelé pour extraire la taille totale de l’objet en cours d’écriture sur l’appareil, pour permettre l’optimisation du transfert, et également pour permettre à Windows Media Gestionnaire de périphériques d’annuler le transfert si le fichier est trop grand pour l’appareil.</span><span class="sxs-lookup"><span data-stu-id="dc110-138">[**GetObjectTotalSize**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-getobjecttotalsize) Called to retrieve the total size of the object being written to the device, to enable optimization of the transfer, and also to give Windows Media Device Manager an opportunity to cancel the transfer if the file is too large for the device.</span></span>
-   <span data-ttu-id="dc110-139">[**TransferObjectData**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) Appelée une ou plusieurs fois.</span><span class="sxs-lookup"><span data-stu-id="dc110-139">[**TransferObjectData**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-transferobjectdata) Called one or more times.</span></span> <span data-ttu-id="dc110-140">Le traitement des données est décrit dans les étapes suivantes :</span><span class="sxs-lookup"><span data-stu-id="dc110-140">The processing of data is described in the following steps:</span></span>
    1.  <span data-ttu-id="dc110-141">**TransferObjectData** reçoit un pointeur vers une mémoire tampon de taille *pdwSize* octets.</span><span class="sxs-lookup"><span data-stu-id="dc110-141">**TransferObjectData** receives a pointer to a buffer of size *pdwSize* bytes.</span></span>
    2.  <span data-ttu-id="dc110-142">L’application obtient un bloc de données à envoyer à l’appareil, généralement en lisant les données d’un fichier, et remplit la mémoire tampon de réception avec jusqu’à *pdwSize* d’octets.</span><span class="sxs-lookup"><span data-stu-id="dc110-142">The application gets a block of data to send to the device, usually by reading data from a file, and fills the received buffer with up to *pdwSize* bytes.</span></span> <span data-ttu-id="dc110-143">Il doit modifier *pdwSize* (si nécessaire) pour refléter le nombre d’octets ajoutés à la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="dc110-143">It should modify *pdwSize* (if necessary) to reflect how many bytes were added to the buffer.</span></span>
    3.  <span data-ttu-id="dc110-144">L’application crée un MAC de tous les paramètres de la méthode.</span><span class="sxs-lookup"><span data-stu-id="dc110-144">The application creates a MAC of all the method parameters.</span></span>
    4.  <span data-ttu-id="dc110-145">L’application chiffre les données dans la mémoire tampon, à l’aide de [**CSecureChannelClient :: EncryptParam**](/previous-versions/bb231587(v=vs.85)).</span><span class="sxs-lookup"><span data-stu-id="dc110-145">The application encrypts the data in the buffer, using [**CSecureChannelClient::EncryptParam**](/previous-versions/bb231587(v=vs.85)).</span></span>
    5.  <span data-ttu-id="dc110-146">**TransferObjectData** retourne s \_ OK pour indiquer qu’il y a plus de données, ou a la \_ valeur false pour indiquer qu’il n’y a plus de données.</span><span class="sxs-lookup"><span data-stu-id="dc110-146">**TransferObjectData** returns S\_OK to indicate that there is more data, or S\_FALSE to indicate that there is no more data.</span></span> <span data-ttu-id="dc110-147">Si l’application retourne l' \_ utilisateur WMDM E \_ \_ Cancelled, l’opération d’écriture est annulée et Windows Media gestionnaire de périphériques appellera **end**.</span><span class="sxs-lookup"><span data-stu-id="dc110-147">If the application returns WMDM\_E\_USER\_CANCELLED, the write operation is canceled and Windows Media Device Manager will call **End**.</span></span>
    6.  <span data-ttu-id="dc110-148">Windows Media Gestionnaire de périphériques continue d’appeler **TransferObjectData** tant que l’application renvoie la valeur \_ OK.</span><span class="sxs-lookup"><span data-stu-id="dc110-148">Windows Media Device Manager continues to call **TransferObjectData** as long as the application returns S\_OK.</span></span>
-   <span data-ttu-id="dc110-149">[**Fin**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) Appelé pour avertir qu’une écriture sur l’appareil se termine.</span><span class="sxs-lookup"><span data-stu-id="dc110-149">[**End**](/windows/desktop/api/mswmdm/nf-mswmdm-iwmdmoperation-end) Called to notify that a write to device is ending.</span></span>

<span data-ttu-id="dc110-150">Pour obtenir un exemple de code, consultez [chiffrement et déchiffrement](encryption-and-decryption.md).</span><span class="sxs-lookup"><span data-stu-id="dc110-150">For a code example, see [Encryption and Decryption](encryption-and-decryption.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="dc110-151">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="dc110-151">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="dc110-152">**Création d’une application Windows Media Gestionnaire de périphériques**</span><span class="sxs-lookup"><span data-stu-id="dc110-152">**Creating a Windows Media Device Manager Application**</span></span>](creating-a-windows-media-device-manager-application.md)
</dt> </dl>

 

 