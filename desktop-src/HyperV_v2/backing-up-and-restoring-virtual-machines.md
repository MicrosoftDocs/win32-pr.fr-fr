---
description: Hyper-V utilise le Service VSS (VSS) pour sauvegarder et restaurer des machines virtuelles.
ms.assetid: 94C67F22-658D-49DD-9588-6BB4FCF7ADA9
title: Sauvegarde et restauration de machines virtuelles
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6f9cf6d5b80a4c7392fb38e893a4fafad3f90435
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "106519712"
---
# <a name="backing-up-and-restoring-virtual-machines"></a><span data-ttu-id="ce7a4-103">Sauvegarde et restauration de machines virtuelles</span><span class="sxs-lookup"><span data-stu-id="ce7a4-103">Backing up and restoring virtual machines</span></span>

<span data-ttu-id="ce7a4-104">Hyper-V utilise le Service VSS (VSS) pour sauvegarder et restaurer des machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-104">Hyper-V uses the Volume Shadow Copy Service (VSS) to backup and restore virtual machines.</span></span> <span data-ttu-id="ce7a4-105">Si les services d’intégration de sauvegarde (Volume Snapshot) sont installés dans le système d’exploitation invité, un demandeur VSS est installé pour permettre aux rédacteurs VSS du système d’exploitation invité de participer à la sauvegarde de la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-105">If the backup (volume snapshot) integration services are installed in the guest operating system, a VSS requester is installed that will allow VSS writers in the guest operating system to participate in the backup of the virtual machine.</span></span> <span data-ttu-id="ce7a4-106">Pour plus d’informations, consultez les sections suivantes :</span><span class="sxs-lookup"><span data-stu-id="ce7a4-106">For details, see the following sections:</span></span>

-   [<span data-ttu-id="ce7a4-107">Sauvegarde des machines virtuelles</span><span class="sxs-lookup"><span data-stu-id="ce7a4-107">Backing up the virtual machines</span></span>](#backing-up-the-virtual-machines)
-   [<span data-ttu-id="ce7a4-108">Restauration des machines virtuelles</span><span class="sxs-lookup"><span data-stu-id="ce7a4-108">Restoring the virtual machines</span></span>](#restoring-the-virtual-machines)
-   [<span data-ttu-id="ce7a4-109">Clustering de basculement et VSS Hyper-V</span><span class="sxs-lookup"><span data-stu-id="ce7a4-109">Failover clustering and Hyper-V VSS</span></span>](#failover-clustering-and-hyper-v-vss)
-   [<span data-ttu-id="ce7a4-110">Détails sur l’enregistreur VSS Hyper-V</span><span class="sxs-lookup"><span data-stu-id="ce7a4-110">Details on the Hyper-V VSS Writer</span></span>](#details-on-the-hyper-v-vss-writer)
-   [<span data-ttu-id="ce7a4-111">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="ce7a4-111">Related topics</span></span>](#related-topics)

## <a name="backing-up-the-virtual-machines"></a><span data-ttu-id="ce7a4-112">Sauvegarde des machines virtuelles</span><span class="sxs-lookup"><span data-stu-id="ce7a4-112">Backing up the virtual machines</span></span>

<span data-ttu-id="ce7a4-113">Hyper-V utilise l’un des deux mécanismes pour sauvegarder chaque ordinateur virtuel.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-113">Hyper-V uses one of two mechanisms to back up each virtual machine.</span></span> <span data-ttu-id="ce7a4-114">Le mécanisme de sauvegarde par défaut est appelé la méthode « état enregistré », où l’ordinateur virtuel est placé dans un état enregistré pendant le traitement de l’événement PrepareForSnapshot, les captures instantanées sont effectuées sur les volumes appropriés et l’ordinateur virtuel est rétabli à l’état précédent pendant le traitement de l’événement PostSnapshot.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-114">The default backup mechanism is called the "Saved State" method, where the virtual machine is put into a saved state during the processing of the PrepareForSnapshot event, snapshots are taken of the appropriate volumes, and the virtual machine is returned to the previous state during the processing of the PostSnapshot event.</span></span>

<span data-ttu-id="ce7a4-115">L’autre mécanisme de sauvegarde est appelé la méthode « instantané de machine virtuelle enfant », qui utilise VSS à l’intérieur de la machine virtuelle enfant pour participer à la sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-115">The other backup mechanism is called the "Child VM Snapshot" method, which uses VSS inside the child virtual machine to participate in the backup.</span></span> <span data-ttu-id="ce7a4-116">Pour que la méthode « instantané de machine virtuelle enfant » soit prise en charge, toutes les conditions suivantes doivent être remplies :</span><span class="sxs-lookup"><span data-stu-id="ce7a4-116">For the "Child VM Snapshot" method to be supported, all of the following conditions must be met:</span></span>

-   <span data-ttu-id="ce7a4-117">Le service d’intégration de sauvegarde (Volume Snapshot) est installé et en cours d’exécution sur l’ordinateur virtuel enfant.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-117">Backup (volume snapshot) Integration Service is installed and running in the child virtual machine.</span></span> <span data-ttu-id="ce7a4-118">Le nom du service est « demandeur de cliché instantané du volume Hyper-V ».</span><span class="sxs-lookup"><span data-stu-id="ce7a4-118">The service name is "Hyper-V Volume Shadow Copy Requestor".</span></span>
-   <span data-ttu-id="ce7a4-119">L’ordinateur virtuel enfant doit être à l’État en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-119">The child virtual machine must be in the running state.</span></span>
-   <span data-ttu-id="ce7a4-120">L’emplacement du fichier d’instantané de l’ordinateur virtuel est défini comme étant le même que celui du système d’exploitation hôte en tant que fichiers VHD pour l’ordinateur virtuel.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-120">The Snapshot File Location for the virtual machine is set to be the same volume in the host operating system as the VHD files for the virtual machine.</span></span>
-   <span data-ttu-id="ce7a4-121">Tous les volumes sur la machine virtuelle enfant sont des disques de base et il n’y a pas de disques dynamiques.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-121">All volumes on the child virtual machine are basic disks and there are no dynamic disks.</span></span>
-   <span data-ttu-id="ce7a4-122">Tous les disques sur l’ordinateur virtuel enfant doivent utiliser un système de fichiers qui prend en charge les instantanés (par exemple, NTFS).</span><span class="sxs-lookup"><span data-stu-id="ce7a4-122">All disks on the child virtual machine must use a file system that supports snapshots (for example, NTFS).</span></span>

<span data-ttu-id="ce7a4-123">En général, le processus de sauvegarde des machines virtuelles est le même que celui décrit dans [vue d’ensemble du traitement d’une sauvegarde sous VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span><span class="sxs-lookup"><span data-stu-id="ce7a4-123">In general, the process for backing up virtual machines is the same as described in [Overview of Processing a Backup Under VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span></span> <span data-ttu-id="ce7a4-124">Le comportement unique se produit lorsque l’enregistreur VSS Hyper-V (qui fait partie du service « gestion de l’ordinateur virtuel Hyper-V ») traite l’événement PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-124">The unique behavior happens when the Hyper-V VSS writer (part of the "Hyper-V Virtual Machine Management" service) processes the PrepareForSnapshot event.</span></span> <span data-ttu-id="ce7a4-125">Si la sauvegarde a été effectuée à l’aide de la méthode « instantané de machine virtuelle enfant », un traitement supplémentaire est effectué, mais elle n’est pas visible par l’ordinateur virtuel enfant.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-125">If the backup was done using the "Child VM Snapshot" method, there is additional processing done but it is not visible to the child virtual machine.</span></span>

<span data-ttu-id="ce7a4-126">La procédure suivante décrit comment sauvegarder des machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-126">The following procedure describes how to back up virtual machines.</span></span>

<span data-ttu-id="ce7a4-127">**Pour sauvegarder des machines virtuelles**</span><span class="sxs-lookup"><span data-stu-id="ce7a4-127">**To back up virtual machines**</span></span>

1.  <span data-ttu-id="ce7a4-128">Pour chaque machine virtuelle dans les métadonnées du writer, si la méthode « état enregistré » est utilisée, l’ordinateur virtuel est mis dans un état enregistré.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-128">For each virtual machine in the writer metadata, if the "Saved State" method is used, the virtual machine is put into a saved state.</span></span> <span data-ttu-id="ce7a4-129">Pour les machines virtuelles utilisant la méthode « instantané de machine virtuelle enfant », le service de demande de cliché instantané de volume Hyper-V dans la machine virtuelle enfant traite la sauvegarde comme détaillé dans la [section vue d’ensemble du traitement d’une sauvegarde sous VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span><span class="sxs-lookup"><span data-stu-id="ce7a4-129">For virtual machines using the "Child VM Snapshot" method, the Hyper-V Volume Shadow Copy Requestor Service in the child virtual machine processes the backup as detailed in [Overview of Processing a Backup Under VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span></span> <span data-ttu-id="ce7a4-130">Tous les événements VSS sur la machine virtuelle enfant se produisent pendant le traitement du système d’exploitation hôte de l’événement PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-130">All VSS events on the child virtual machine occur during the host operating system processing of the PrepareForSnapshot event.</span></span>
2.  <span data-ttu-id="ce7a4-131">Une fois que toutes les machines virtuelles ont été placées dans l’état enregistré ou si des captures instantanées ont été effectuées, l’enregistreur VSS Hyper-V retourne à partir de l’événement PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-131">After all virtual machines have either been put in the saved state or had snapshots taken, the Hyper-V VSS writer returns from the PrepareForSnapshot event.</span></span> <span data-ttu-id="ce7a4-132">Aucun traitement n’est effectué par l’enregistreur VSS Hyper-V pendant les événements Freeze et dégeler.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-132">No processing is done by the Hyper-V VSS writer during the Freeze and Thaw events.</span></span>
3.  <span data-ttu-id="ce7a4-133">Lorsque l’enregistreur VSS Hyper-V traite l’événement PostSnapshot, les machines virtuelles qui ont été sauvegardées à l’aide de la méthode « état enregistré » et qui ont été placées dans un état enregistré par l’enregistreur VSS Hyper-V sont retournées à l’État dans lequel elles se trouvaient avant le démarrage de la sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-133">When the Hyper-V VSS writer processes the PostSnapshot event, virtual machines that were backed up using the "Saved State" method and were put into a saved state by the Hyper-V VSS writer are returned to the state they were in before the backup started.</span></span> <span data-ttu-id="ce7a4-134">Pour les machines virtuelles qui ont été sauvegardées à l’aide de la méthode « instantané de machine virtuelle enfant », l’image hôte des fichiers VHD sur lesquels les captures instantanées ont été effectuées est restaurée sur l’instantané pris lors du traitement de l’événement PrepareForSnapshot.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-134">For the virtual machines that were backed up using the "Child VM Snapshot" method, the host image of the VHD files that had the snapshots taken are rolled back to the snapshot taken during the processing of the PrepareForSnapshot event.</span></span> <span data-ttu-id="ce7a4-135">Ce traitement s’effectue indépendamment des enregistreurs VSS sur les machines virtuelles enfants, de sorte que les captures instantanées prises doivent être récupérables automatiquement.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-135">This processing is done independently of the VSS writers on the child virtual machines so the snapshots taken must be auto-recoverable.</span></span> <span data-ttu-id="ce7a4-136">(**VSS \_ VOLSNAP \_ attr \_ aucune \_ récupération automatique** n’est définie dans le contexte.)</span><span class="sxs-lookup"><span data-stu-id="ce7a4-136">(**VSS\_VOLSNAP\_ATTR\_NO\_AUTORECOVERY** is not set in the context.)</span></span>

<span data-ttu-id="ce7a4-137">Les sauvegardes partielles ne sont pas prises en charge.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-137">Partial backups are not supported.</span></span> <span data-ttu-id="ce7a4-138">Si un ordinateur virtuel ne parvient pas à créer un instantané, aucune machine virtuelle n’est sauvegardée.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-138">If any virtual machine fails to create a snapshot, no virtual machines will be backed up.</span></span>

> [!Note]  
> <span data-ttu-id="ce7a4-139">Les disques directs et iSCSI ne sont pas visibles par le système d’exploitation hôte et ne sont donc pas sauvegardés par l’enregistreur VSS Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-139">Pass-through and iSCSI disks are not visible to the host operating system and therefore not backed up by the Hyper-V VSS writer.</span></span> <span data-ttu-id="ce7a4-140">Les sauvegardes de ces volumes doivent être effectuées entièrement sur la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-140">Backups of these volumes must be done entirely on the virtual machine.</span></span>

 

## <a name="restoring-the-virtual-machines"></a><span data-ttu-id="ce7a4-141">Restauration des machines virtuelles</span><span class="sxs-lookup"><span data-stu-id="ce7a4-141">Restoring the virtual machines</span></span>

<span data-ttu-id="ce7a4-142">La restauration des machines virtuelles est entièrement effectuée par le système d’exploitation hôte. les enregistreurs VSS sur les machines virtuelles enfants ne sont pas impliqués.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-142">Restoring the virtual machines is done entirely by the host operating system; the VSS writers on the child virtual machines are not involved.</span></span>

<span data-ttu-id="ce7a4-143">La procédure suivante décrit comment restaurer des machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-143">The following procedure describes how to restore virtual machines.</span></span>

<span data-ttu-id="ce7a4-144">**Pour restaurer des machines virtuelles**</span><span class="sxs-lookup"><span data-stu-id="ce7a4-144">**To restore virtual machines**</span></span>

1.  <span data-ttu-id="ce7a4-145">Pendant le traitement de l’événement de prérestauration, l’enregistreur VSS Hyper-V désactive et supprime tous les ordinateurs virtuels qui sont sur le moment d’être restaurés.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-145">During the processing of the PreRestore event, the Hyper-V VSS writer turns off and deletes any virtual machines that are about to be restored.</span></span>
2.  <span data-ttu-id="ce7a4-146">Une fois que tous les enregistreurs VSS ont traité l’événement de prérestauration, les fichiers sont restaurés.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-146">After all VSS writers have processed the PreRestore event, the files are restored.</span></span>
3.  <span data-ttu-id="ce7a4-147">Pendant le traitement de l’événement PostRestore, l’enregistreur VSS Hyper-V appelle la méthode [**IVssComponent :: GetFileRestoreStatus**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) .</span><span class="sxs-lookup"><span data-stu-id="ce7a4-147">During the processing of the PostRestore event, the Hyper-V VSS writer calls the [**IVssComponent::GetFileRestoreStatus**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) method.</span></span> <span data-ttu-id="ce7a4-148">Si le retour n’est **pas \_ VSS \_ RS All**, l’enregistreur VSS Hyper-V appelle la méthode [**SetWriterFailure**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) et retourne **false** à partir de la méthode [**OnPostRestore**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) .</span><span class="sxs-lookup"><span data-stu-id="ce7a4-148">If the return is not **VSS\_RS\_ALL**, then the Hyper-V VSS writer calls the [**SetWriterFailure**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) method and returns **False** from the [**OnPostRestore**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) method.</span></span>
4.  <span data-ttu-id="ce7a4-149">Pour chaque machine virtuelle restaurée, l’enregistreur VSS Hyper-V inscrit l’ordinateur virtuel auprès du service de gestion Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-149">For each virtual machine that was restored, the Hyper-V VSS writer registers the virtual machine with the Hyper-V management service.</span></span> <span data-ttu-id="ce7a4-150">Si la machine virtuelle est restaurée à un emplacement non défini par défaut, un lien symbolique est créé dans l’emplacement par défaut qui est lié à cet emplacement.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-150">If the virtual machine is restored to a nondefault location, a symbolic link is created in the default location linking to that location.</span></span>
5.  <span data-ttu-id="ce7a4-151">Pour chaque disque dur virtuel qui a été restauré, l’emplacement est comparé à celui spécifié pour cet ordinateur virtuel.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-151">For each VHD that was restored, the location is compared with the one specified for that virtual machine.</span></span> <span data-ttu-id="ce7a4-152">Si l’emplacement est différent, la configuration est mise à jour avec l’emplacement approprié.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-152">If the location is different, then the configuration is updated with the proper location.</span></span>
6.  <span data-ttu-id="ce7a4-153">La configuration réseau est mise à jour.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-153">The network configuration is updated.</span></span> <span data-ttu-id="ce7a4-154">Si les commutateurs virtuels auxquels la machine virtuelle était connectée lorsqu’elle a été sauvegardée se ferment, de nouveaux ports sont créés et connectés à la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-154">If the virtual switches that the virtual machine was connected to when it was backed up still exit, new ports are created and connected to the virtual machine.</span></span>

## <a name="failover-clustering-and-hyper-v-vss"></a><span data-ttu-id="ce7a4-155">Clustering de basculement et VSS Hyper-V</span><span class="sxs-lookup"><span data-stu-id="ce7a4-155">Failover clustering and Hyper-V VSS</span></span>

<span data-ttu-id="ce7a4-156">L’enregistreur VSS Hyper-V ne prend pas en compte les ordinateurs virtuels qui font partie d’un cluster de basculement.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-156">The Hyper-V VSS writer does not give any consideration to virtual machines that are part of a failover cluster.</span></span> <span data-ttu-id="ce7a4-157">Pendant les sauvegardes de la méthode « état enregistré » et toutes les restaurations, la machine virtuelle est placée dans l’état enregistré ou entièrement supprimée.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-157">During both the "Saved State" method backups and all restores, the virtual machine would be put into the saved state or deleted entirely.</span></span> <span data-ttu-id="ce7a4-158">Cela est considéré comme un échec du service de clustering et entraîne le basculement des applications sur ces nœuds vers d’autres nœuds.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-158">This would be seen as a failure by the clustering service and cause the applications on those nodes to be failed over to other nodes.</span></span> <span data-ttu-id="ce7a4-159">Pour éviter cette situation lors des sauvegardes « état enregistré », l’état de l’ordinateur virtuel doit être enregistré à l’aide du service de clustering.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-159">To avoid this during "Saved State" backups, the virtual machine state must be saved using the clustering service.</span></span> <span data-ttu-id="ce7a4-160">Pour éviter cette erreur lors d’une restauration, les ressources sur l’ordinateur virtuel doivent être mises hors connexion.</span><span class="sxs-lookup"><span data-stu-id="ce7a4-160">To avoid this during a restore, the resources on the virtual machine would need to be taken offline.</span></span>

## <a name="details-on-the-hyper-v-vss-writer"></a><span data-ttu-id="ce7a4-161">Détails sur l’enregistreur VSS Hyper-V</span><span class="sxs-lookup"><span data-stu-id="ce7a4-161">Details on the Hyper-V VSS Writer</span></span>

<span data-ttu-id="ce7a4-162">Nom de l’enregistreur : Microsoft Hyper-V l’enregistreur VSS</span><span class="sxs-lookup"><span data-stu-id="ce7a4-162">Writer Name: Microsoft Hyper-V VSS Writer</span></span>

<span data-ttu-id="ce7a4-163">ID de l’enregistreur : 66841CD4-6DED-4F4B-8F17-FD23F8DDC3DE</span><span class="sxs-lookup"><span data-stu-id="ce7a4-163">Writer ID: 66841cd4-6ded-4f4b-8f17-fd23f8ddc3de</span></span>

## <a name="related-topics"></a><span data-ttu-id="ce7a4-164">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="ce7a4-164">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="ce7a4-165">Vue d’ensemble du traitement d’une sauvegarde sous VSS</span><span class="sxs-lookup"><span data-stu-id="ce7a4-165">Overview of Processing a Backup Under VSS</span></span>](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss)
</dt> <dt>

[<span data-ttu-id="ce7a4-166">Vue d’ensemble du traitement d’une restauration sous VSS</span><span class="sxs-lookup"><span data-stu-id="ce7a4-166">Overview of Processing a Restore Under VSS</span></span>](/windows/desktop/VSS/overview-of-processing-a-restore-under-vss)
</dt> </dl>

 

 
