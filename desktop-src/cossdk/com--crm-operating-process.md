---
description: Processus de fonctionnement COM+ CRM
ms.assetid: be50912e-b9fd-4ef7-b81a-e37617a96955
title: Processus de fonctionnement COM+ CRM
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d39dba3dedcbdefebe0f62144547ebb6985fa51f
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "103861637"
---
# <a name="com-crm-operating-process"></a><span data-ttu-id="0a2f0-103">Processus de fonctionnement COM+ CRM</span><span class="sxs-lookup"><span data-stu-id="0a2f0-103">COM+ CRM Operating Process</span></span>

<span data-ttu-id="0a2f0-104">En mode de fonctionnement normal, un composant d’application exécuté dans un processus d’application serveur utilise un CRM COM+ en créant un travail CRM.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-104">In normal operation, an application component running in a server application process would use a COM+ CRM by creating a CRM worker.</span></span> <span data-ttu-id="0a2f0-105">Le processus de travail CRM implémente une interface COM spécifique à la tâche qu’il est conçu pour effectuer.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-105">The CRM worker implements a COM interface specific to the task it is designed to perform.</span></span> <span data-ttu-id="0a2f0-106">Le composant d’application doit s’exécuter sous une transaction afin que le processus de travail CRM hérite de la transaction du composant d’application.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-106">The application component must be running under a transaction so that the CRM worker inherits the transaction of the application component.</span></span> <span data-ttu-id="0a2f0-107">Les Workers CRM requièrent toujours une transaction.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-107">CRM workers always require a transaction.</span></span>

<span data-ttu-id="0a2f0-108">Pour accéder au CRM COM+, le Worker CRM obtient d’abord l’interface [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) , ce qui permet au processus de travail CRM d’écrire des enregistrements dans le journal durable.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-108">To access the COM+ CRM, the CRM worker first obtains the [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) interface, which allows the CRM worker to write records to the durable log.</span></span> <span data-ttu-id="0a2f0-109">Le processus de travail CRM obtient cette interface en créant un composant Clerk CRM.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-109">The CRM worker obtains this interface by creating a CRM clerk component.</span></span>

<span data-ttu-id="0a2f0-110">Ensuite, le CRM Worker doit indiquer au Clerk CRM le nom du compensateur CRM qu’il souhaite utiliser.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-110">Next the CRM worker must tell the CRM clerk the name of the CRM Compensator it wants to use.</span></span> <span data-ttu-id="0a2f0-111">Pour ce faire, il appelle la méthode [**ICrmLogControl :: RegisterCompensator**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) .</span><span class="sxs-lookup"><span data-stu-id="0a2f0-111">It does this by calling the [**ICrmLogControl::RegisterCompensator**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-registercompensator) method.</span></span> <span data-ttu-id="0a2f0-112">Une fois cette méthode appelée, le compensateur CRM est créé par l’infrastructure CRM lorsque la transaction est terminée.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-112">After this method is called, the CRM Compensator is created by the CRM infrastructure when the transaction completes.</span></span>

<span data-ttu-id="0a2f0-113">Une fois que le service CRM a inscrit son compensateur CRM, il peut écrire des enregistrements dans le journal CRM à l’aide de [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span><span class="sxs-lookup"><span data-stu-id="0a2f0-113">After the CRM worker has registered its CRM Compensator, it can write records to the CRM log using [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span></span> <span data-ttu-id="0a2f0-114">Le processus de travail CRM doit écrire à l' *avance*; autrement dit, il doit écrire un enregistrement dans le journal décrivant une action avant d’effectuer l’action, au cas où un incident se produira immédiatement après l’achèvement de l’action.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-114">The CRM worker must *write ahead*; that is, it must write a record to the log describing an action before it actually performs the action, in case a crash occurs immediately after completing the action.</span></span> <span data-ttu-id="0a2f0-115">Sans ces enregistrements de journal avec écriture anticipée, il n’existe aucun moyen de corriger l’action.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-115">Without these write-ahead log records, there is no way to correct for the action.</span></span>

<span data-ttu-id="0a2f0-116">En outre, l’écriture anticipée signifie que le compensateur CRM, qui est le composant qui reçoit les enregistrements de journal en cours de récupération, doit gérer le cas où les enregistrements de journal ont été écrits, mais que l’action n’a pas été effectuée en fait.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-116">Also, write ahead means that the CRM Compensator, which is the component that receives the log records on recovery, must deal with the case where the log records were written but the action did not in fact occur.</span></span> <span data-ttu-id="0a2f0-117">Les actions effectuées par le compensateur CRM doivent être *idempotent*; autrement dit, elles doivent pouvoir être exécutées plusieurs fois, mais doivent entraîner le même résultat.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-117">Actions by the CRM Compensator must be *idempotent*; that is, they should be capable of being performed more than once but should lead to the same outcome.</span></span> <span data-ttu-id="0a2f0-118">Par exemple, la définition d’un solde de compte à la valeur $100 est une action idempotent ; l’ajout de $100 au solde du compte n’est pas.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-118">For example, setting an account balance to the value of $100 is an idempotent action; adding $100 to the account balance is not.</span></span>

<span data-ttu-id="0a2f0-119">L’interface [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) fournit les deux méthodes suivantes pour écrire des enregistrements de journal :</span><span class="sxs-lookup"><span data-stu-id="0a2f0-119">The [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol) interface provides the following two methods for writing log records:</span></span>

-   <span data-ttu-id="0a2f0-120">[**WriteLogRecordVariants**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) est utilisé pour écrire un enregistrement de journal structuré qui est créé sous la forme d’une collection de variantes.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-120">[**WriteLogRecordVariants**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecordvariants) is used for writing a structured log record that is built up as a collection of Variants.</span></span> <span data-ttu-id="0a2f0-121">Il est principalement destiné à une utilisation lors du développement de CRM dans Microsoft Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-121">It is primarily for use when developing CRMs in Microsoft Visual Basic.</span></span>
-   <span data-ttu-id="0a2f0-122">[**WriteLogRecord**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) est utilisé pour l’écriture d’un enregistrement de journal non structuré en tant qu’objet blob d’octets.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-122">[**WriteLogRecord**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-writelogrecord) is used for writing an unstructured log record as BLOBs of bytes.</span></span> <span data-ttu-id="0a2f0-123">Il est principalement destiné à une utilisation lors du développement de CRM dans Microsoft Visual C++.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-123">It is primarily for use when developing CRMs in Microsoft Visual C++.</span></span> <span data-ttu-id="0a2f0-124">Étant donné que les structures d’enregistrement en C sont souvent composées d’un ensemble d’en-têtes et de champs qui peuvent être disséminés en mémoire, la méthode **WriteLogRecord** implémente une fonctionnalité de regroupement qui réduit la copie des données.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-124">Because record structures in C are often made up of a set of headers and fields that may be scattered in memory, the **WriteLogRecord** method implements a gather capability that reduces the copying of data.</span></span>

> [!Note]  
> <span data-ttu-id="0a2f0-125">Vous ne devez pas les types de pointeur utilisateur dans les structures de données d’un enregistrement de journal.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-125">You should not user pointer types within data structures in a log record.</span></span> <span data-ttu-id="0a2f0-126">Les pointeurs ne sont plus valides durant la phase de récupération, car le compensateur CRM s’exécute dans un processus différent de celui du travail CRM qui a écrit l’enregistrement du journal.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-126">Pointers are no longer valid during recovery phase because the CRM Compensator runs in a different process than that of the CRM worker that wrote the log record.</span></span> <span data-ttu-id="0a2f0-127">L’inclusion de types pointeur dans un enregistrement de journal peut entraîner un blocage ou une altération de l’application pendant la récupération.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-127">Including pointer types in a log record might cause an application to crash or corrupt itself during recovery.</span></span>

 

<span data-ttu-id="0a2f0-128">Ces deux méthodes d’écriture écrivent un enregistrement de journal sur le disque, mais ne garantissent pas la durabilité de l’enregistrement.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-128">Both of these write methods write a log record to disk but do not guarantee the record's durability.</span></span> <span data-ttu-id="0a2f0-129">Tout en autorisant l’accumulation des écritures différées avant de forcer le disque à améliorer les performances, vous pouvez utiliser la méthode [**ICrmLogControl :: ForceLog**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) à la place pour garantir que toutes les écritures effectuées par le CRM sont durables sur le disque, ce qui est important pour la récupération en cas d’échec.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-129">While allowing lazy writes to accumulate before forcing to disk can improve performance, you can use the [**ICrmLogControl::ForceLog**](/windows/desktop/api/ComSvcs/nf-comsvcs-icrmlogcontrol-forcelog) method instead to guarantee that all writes done by the CRM are durable on disk, which is important for failure recovery.</span></span>

<span data-ttu-id="0a2f0-130">Lorsque le processus de travail CRM est terminé avec ses actions et a terminé l’écriture et le forçage des enregistrements dans le journal, il doit libérer [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span><span class="sxs-lookup"><span data-stu-id="0a2f0-130">When the CRM worker is done with its actions and has finished writing and forcing records to the log, it must release [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol).</span></span> <span data-ttu-id="0a2f0-131">Une fois la transaction terminée (en général, en raison du composant d’application qui appelle [**SetComplete**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) ou [**SetAbort**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)), l’infrastructure CRM crée le composant CRM compensator, qui implémente l’interface [**ICrmCompensator**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) ou l’interface [**ICrmCompensatorVariants**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) .</span><span class="sxs-lookup"><span data-stu-id="0a2f0-131">When the transaction completes (typically due to the application component calling [**SetComplete**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setcomplete) or [**SetAbort**](/windows/desktop/api/ComSvcs/nf-comsvcs-iobjectcontext-setabort)), the CRM infrastructure creates the CRM Compensator component, which implements either the [**ICrmCompensator**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensator) interface or the [**ICrmCompensatorVariants**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmcompensatorvariants) interface.</span></span> <span data-ttu-id="0a2f0-132">Ces interfaces sont utilisées pour transmettre les enregistrements non structurés (Visual C++) ou structurés (Visual Basic) au compensateur CRM avec les notifications de résultat de la transaction.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-132">These interfaces are used to pass the unstructured (Visual C++) or structured (Visual Basic) records to the CRM Compensator along with the transaction outcome notifications.</span></span>

<span data-ttu-id="0a2f0-133">Le compensateur CRM est tout d’abord notifié de la phase de préparation de l’exécution de la transaction et peut voter oui ou non pour la demande de préparation.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-133">The CRM Compensator is first notified of the prepare phase of the transaction completion and can vote either yes or no to the prepare request.</span></span> <span data-ttu-id="0a2f0-134">Si le compensateur CRM vote non, il ne reçoit pas de notifications d’abandon supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-134">If the CRM Compensator votes no, it does not receive any further abort notifications.</span></span> <span data-ttu-id="0a2f0-135">S’il vote oui pour la demande de préparation, il reçoit les notifications de validation ou d’abandon.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-135">If it votes yes to the prepare request, it receives either the commit or abort notifications.</span></span> <span data-ttu-id="0a2f0-136">En cas d’abandon d’un client, aucune notification de préparation n’est reçue, les notifications d’abandon sont uniquement abandonnées.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-136">In the case of a client abort, no prepare notifications are received, only abort notifications.</span></span> <span data-ttu-id="0a2f0-137">Le compensateur CRM doit être prêt à gérer tous ces cas, et il doit également gérer le cas où aucun enregistrement de journal n’a été écrit avec succès par le Worker CRM.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-137">The CRM Compensator must be prepared to handle all these cases, and it also must handle the case where no log records were successfully written by the CRM worker.</span></span> <span data-ttu-id="0a2f0-138">Le compensateur CRM ne doit pas supposer que la même instance CRM Compensator recevra à la fois les notifications de phase 1 (préparation) et de phase 2 (validation ou abandon), car elles pourraient être interrompues par la récupération.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-138">The CRM Compensator must not assume that the same CRM Compensator instance will receive both the phase 1 (prepare) and the phase 2 (commit or abort) notifications, as these could be interrupted by recovery.</span></span>

<span data-ttu-id="0a2f0-139">En règle générale, un Compensator CRM utilise la notification d’abandon pour inverser l’action effectuée par le processus de travail CRM.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-139">Typically, a CRM Compensator uses the abort notification to reverse the action that was performed by the CRM worker.</span></span> <span data-ttu-id="0a2f0-140">Le processus de travail CRM peut conserver un état disponible au cas où il aurait besoin d’inverser son action.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-140">The CRM worker might leave some state available in case it needs to reverse its action.</span></span> <span data-ttu-id="0a2f0-141">Cet État peut être entièrement contenu dans les enregistrements de journal. dans le cas contraire, le compensateur CRM doit nettoyer cet État si la transaction est validée.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-141">That state might be fully contained in the log records, and if not, the CRM Compensator needs to clean up that state if the transaction commits.</span></span> <span data-ttu-id="0a2f0-142">C’est la raison pour laquelle le compensateur CRM reçoit la notification de validation.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-142">This is the reason why the CRM Compensator receives the commit notification.</span></span> <span data-ttu-id="0a2f0-143">Le compensateur CRM ne s’exécute pas sous une transaction DTC.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-143">The CRM Compensator does not run under a DTC transaction.</span></span>

<span data-ttu-id="0a2f0-144">Le compensateur CRM peut enregistrer de nouveaux enregistrements si nécessaire à l’aide de [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol), qu’il reçoit lorsqu’il est créé.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-144">The CRM Compensator can log new records if required by using [**ICrmLogControl**](/windows/desktop/api/ComSvcs/nn-comsvcs-icrmlogcontrol), which it receives as it is created.</span></span> <span data-ttu-id="0a2f0-145">Le processus de travail CRM et le compensateur CRM peuvent également oublier le dernier enregistrement de journal qu’ils ont écrit, ce qui peut être nécessaire pour éviter une récupération inutile.</span><span class="sxs-lookup"><span data-stu-id="0a2f0-145">Both the CRM worker and CRM Compensator can also forget the last log record they wrote, which might be required to avoid unnecessary recovery.</span></span>

## <a name="related-topics"></a><span data-ttu-id="0a2f0-146">Rubriques connexes</span><span class="sxs-lookup"><span data-stu-id="0a2f0-146">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="0a2f0-147">Concepts de Gestionnaire des ressources de compensation COM+</span><span class="sxs-lookup"><span data-stu-id="0a2f0-147">COM+ Compensating Resource Manager Concepts</span></span>](com--compensating-resource-manager-concepts.md)
</dt> <dt>

[<span data-ttu-id="0a2f0-148">Démarrage et récupération COM+ CRM</span><span class="sxs-lookup"><span data-stu-id="0a2f0-148">COM+ CRM Startup and Recovery</span></span>](com--crm-startup-and-recovery.md)
</dt> </dl>

 

 



