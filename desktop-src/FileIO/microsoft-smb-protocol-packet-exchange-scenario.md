---
description: Exemple d’échange de paquets de protocole SMB Microsoft entre un client et un serveur.
ms.assetid: f831d0de-0e38-4141-811c-892a1b5c4037
title: Scénario d’échange de paquets de protocole SMB Microsoft
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: e8a03e2f75b00aa93e629b3e698631c5efde4694
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/07/2021
ms.locfileid: "104318253"
---
# <a name="microsoft-smb-protocol-packet-exchange-scenario"></a><span data-ttu-id="4debf-103">Scénario d’échange de paquets de protocole SMB Microsoft</span><span class="sxs-lookup"><span data-stu-id="4debf-103">Microsoft SMB Protocol Packet Exchange Scenario</span></span>

<span data-ttu-id="4debf-104">Cette rubrique fournit un exemple d’échange de paquets de protocole SMB Microsoft entre un client et un serveur.</span><span class="sxs-lookup"><span data-stu-id="4debf-104">This topic gives an example of a Microsoft SMB Protocol packet exchange between a client and a server.</span></span> <span data-ttu-id="4debf-105">Les étapes suivantes sont une vue d’ensemble du processus :</span><span class="sxs-lookup"><span data-stu-id="4debf-105">The following steps are an overview of the process:</span></span>

1.  <span data-ttu-id="4debf-106">Le client et le serveur établissent une session NetBIOS.</span><span class="sxs-lookup"><span data-stu-id="4debf-106">The client and server establish a NetBIOS session.</span></span>
2.  <span data-ttu-id="4debf-107">Le client et le serveur négocient le dialecte du protocole SMB Microsoft.</span><span class="sxs-lookup"><span data-stu-id="4debf-107">The client and server negotiate the Microsoft SMB Protocol dialect.</span></span>
3.  <span data-ttu-id="4debf-108">Le client ouvre une session sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="4debf-108">The client logs on to the server.</span></span>
4.  <span data-ttu-id="4debf-109">Le client se connecte à un partage sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="4debf-109">The client connects to a share on the server.</span></span>
5.  <span data-ttu-id="4debf-110">Le client ouvre un fichier sur le partage.</span><span class="sxs-lookup"><span data-stu-id="4debf-110">The client opens a file on the share.</span></span>
6.  <span data-ttu-id="4debf-111">Le client lit à partir du fichier.</span><span class="sxs-lookup"><span data-stu-id="4debf-111">The client reads from the file.</span></span>

<span data-ttu-id="4debf-112">Tout d’abord, une connexion TCP en duplex intégral est établie par le client avec le serveur.</span><span class="sxs-lookup"><span data-stu-id="4debf-112">First, a full-duplex TCP connection is established by the client with the server.</span></span> <span data-ttu-id="4debf-113">Ensuite, le client génère et envoie un paquet de demande de session NetBIOS sur la connexion TCP.</span><span class="sxs-lookup"><span data-stu-id="4debf-113">Then the client builds and sends a NetBIOS session request packet over the TCP connection.</span></span> <span data-ttu-id="4debf-114">Si le paquet a été mis en forme correctement, le serveur retourne alors un paquet qui contient un message confirmant que la session a été établie.</span><span class="sxs-lookup"><span data-stu-id="4debf-114">If the packet was formatted correctly, the server then returns a packet that contains a message acknowledging that the session has been established.</span></span> <span data-ttu-id="4debf-115">Après cela, le client envoie les premiers paquets du protocole SMB Microsoft au serveur.</span><span class="sxs-lookup"><span data-stu-id="4debf-115">After this, the client sends the first Microsoft SMB Protocol packets to the server.</span></span>



|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="4debf-116">**Paquet 1 : SMB \_ com \_ Negotiate**</span><span class="sxs-lookup"><span data-stu-id="4debf-116">**Packet 1:  SMB\_COM\_NEGOTIATE**</span></span><br/> <span data-ttu-id="4debf-117">**Direction :** Client à serveur</span><span class="sxs-lookup"><span data-stu-id="4debf-117">**Direction:** Client to server</span></span><br/> <span data-ttu-id="4debf-118">**Description :** Le client demande que le serveur négocie le dialecte du protocole SMB Microsoft.</span><span class="sxs-lookup"><span data-stu-id="4debf-118">**Description:** The client requests that the server negotiate the Microsoft SMB Protocol dialect.</span></span> <span data-ttu-id="4debf-119">Une liste de chaînes identifiant les dialectes que le client peut utiliser est incluse dans le paquet.</span><span class="sxs-lookup"><span data-stu-id="4debf-119">A list of strings identifying the dialects that the client can work with is included in the packet.</span></span><br/>                                                                                                                                                                                                                                                                                                                                   |
| <span data-ttu-id="4debf-120">**Paquet 2 : SMB \_ com \_ Negotiate**</span><span class="sxs-lookup"><span data-stu-id="4debf-120">**Packet 2:  SMB\_COM\_NEGOTIATE**</span></span><br/> <span data-ttu-id="4debf-121">**Direction :** Serveur à client</span><span class="sxs-lookup"><span data-stu-id="4debf-121">**Direction:** Server to client</span></span><br/> <span data-ttu-id="4debf-122">**Description :** Le serveur répond à la demande du client pour identifier le dialecte du protocole SMB Microsoft qui sera utilisé dans la session.</span><span class="sxs-lookup"><span data-stu-id="4debf-122">**Description:** The server responds to the client's request to identify the Microsoft SMB Protocol dialect that is going to be used in the session.</span></span> <span data-ttu-id="4debf-123">Le paquet retourné comprend également une chaîne aléatoire de 8 octets qui sera utilisée à l’étape suivante pour authentifier le client pendant le processus d’ouverture de session.</span><span class="sxs-lookup"><span data-stu-id="4debf-123">The returned packet also includes an 8-byte random string that will be used in the next step to authenticate the client during the logon process.</span></span><br/>                                                                                                                                                                                                                                   |
| <span data-ttu-id="4debf-124">**Paquet 3 : \_ configuration de \_ session com SMB \_ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="4debf-124">**Packet 3:  SMB\_COM\_SESSION\_SETUP\_ANDX**</span></span><br/> <span data-ttu-id="4debf-125">**Direction :** Client à serveur</span><span class="sxs-lookup"><span data-stu-id="4debf-125">**Direction:** Client to server</span></span><br/> <span data-ttu-id="4debf-126">**Description :** Ce paquet inclut des informations sur les fonctionnalités du client, ce qui signifie que ce paquet doit être envoyé même si le serveur a implémenté uniquement la sécurité au niveau du partage.</span><span class="sxs-lookup"><span data-stu-id="4debf-126">**Description:** This packet includes information about client capabilities, so this packet must be sent even if the server has implemented only share-level security.</span></span><br/> <span data-ttu-id="4debf-127">**Paquet 3 : \_ configuration de \_ session com SMB \_ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="4debf-127">**Packet 3:  SMB\_COM\_SESSION\_SETUP\_ANDX**</span></span><br/> <span data-ttu-id="4debf-128">**Direction :** Serveur à client</span><span class="sxs-lookup"><span data-stu-id="4debf-128">**Direction:** Server to client</span></span><br/> <span data-ttu-id="4debf-129">**Description :** Si la stimulation/réponse est acceptée par le serveur, un UID valide est inclus dans le paquet renvoyé au client.</span><span class="sxs-lookup"><span data-stu-id="4debf-129">**Description:** If the challenge/response is accepted by the server, a valid UID is included in the packet that is returned to the client.</span></span> <span data-ttu-id="4debf-130">Si elle n’est pas acceptée, le serveur renvoie un code d’erreur dans ce paquet et refuse l’accès.</span><span class="sxs-lookup"><span data-stu-id="4debf-130">If it is not accepted, the server will return an error code in this packet and deny access.</span></span><br/> |
| <span data-ttu-id="4debf-131">**Paquet 4 : connexion de l' \_ arborescence com SMB \_ \_ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="4debf-131">**Packet 4:  SMB\_COM\_TREE\_CONNECT\_ANDX**</span></span><br/> <span data-ttu-id="4debf-132">**Direction :** Client à serveur</span><span class="sxs-lookup"><span data-stu-id="4debf-132">**Direction:** Client to server</span></span><br/> <span data-ttu-id="4debf-133">**Description :** Le client demande l’accès au partage.</span><span class="sxs-lookup"><span data-stu-id="4debf-133">**Description:** The client requests access to the share.</span></span> <span data-ttu-id="4debf-134">Le paquet contient le chemin d’accès complet du partage au format UNC.</span><span class="sxs-lookup"><span data-stu-id="4debf-134">The packet contains the fully specified path of the share in UNC format.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                                             |
| <span data-ttu-id="4debf-135">**Paquet 5 : connexion de l' \_ arborescence com SMB \_ \_ \_ ANDX**</span><span class="sxs-lookup"><span data-stu-id="4debf-135">**Packet 5:  SMB\_COM\_TREE\_CONNECT\_ANDX**</span></span><br/> <span data-ttu-id="4debf-136">**Direction :** Serveur à client</span><span class="sxs-lookup"><span data-stu-id="4debf-136">**Direction:** Server to client</span></span><br/> <span data-ttu-id="4debf-137">**Description :** Si l’accès au partage est accordé, le serveur retourne l’ID d’arborescence 16 bits (TID) qui correspond au partage dans ce paquet.</span><span class="sxs-lookup"><span data-stu-id="4debf-137">**Description:** If access to the share is granted, then the server returns the 16-bit tree ID (TID) that corresponds to the share in this packet.</span></span> <span data-ttu-id="4debf-138">Si le partage n’existe pas ou si l’utilisateur ne dispose pas des informations d’identification suffisantes pour accéder au partage, le serveur renvoie un code d’erreur dans ce paquet et refuse l’accès au partage.</span><span class="sxs-lookup"><span data-stu-id="4debf-138">If the share does not exist or the user has insufficient credentials to access the share, the server will return an error code in this packet and deny access to the share.</span></span><br/>                                                                                                                                                                                                 |
| <span data-ttu-id="4debf-139">**Paquet 6 : \_ \_ ANDX Open com \_ ouvert**</span><span class="sxs-lookup"><span data-stu-id="4debf-139">**Packet 6:  SMB\_COM\_OPEN\_ANDX**</span></span><br/> <span data-ttu-id="4debf-140">**Direction :** Client à serveur</span><span class="sxs-lookup"><span data-stu-id="4debf-140">**Direction:** Client to server</span></span><br/> <span data-ttu-id="4debf-141">**Description :** Le client demande au serveur d’ouvrir un fichier sur le partage accessible pour le compte du client.</span><span class="sxs-lookup"><span data-stu-id="4debf-141">**Description:** The client requests the server to open a file on the accessed share on behalf of the client.</span></span> <span data-ttu-id="4debf-142">Ce paquet contient le nom du fichier à ouvrir.</span><span class="sxs-lookup"><span data-stu-id="4debf-142">This packet contains the name of the file to be opened.</span></span><br/>                                                                                                                                                                                                                                                                                                                                                                   |
| <span data-ttu-id="4debf-143">**Paquet 7 : \_ \_ ANDX Open com \_ ouvert**</span><span class="sxs-lookup"><span data-stu-id="4debf-143">**Packet 7:  SMB\_COM\_OPEN\_ANDX**</span></span><br/> <span data-ttu-id="4debf-144">**Direction :** Serveur à client</span><span class="sxs-lookup"><span data-stu-id="4debf-144">**Direction:** Server to client</span></span><br/> <span data-ttu-id="4debf-145">**Description :** Si l’accès au fichier est accordé, le serveur retourne l’ID du fichier demandé.</span><span class="sxs-lookup"><span data-stu-id="4debf-145">**Description:** If access to the file is granted, then the server returns the file ID of the requested file.</span></span> <span data-ttu-id="4debf-146">Si le fichier n’existe pas ou si l’utilisateur ne dispose pas des informations d’identification suffisantes pour accéder au fichier, le serveur renvoie un code d’erreur dans ce paquet et refuse l’accès au fichier.</span><span class="sxs-lookup"><span data-stu-id="4debf-146">If the file does not exist or the user has insufficient credentials to access the file, the server will return an error code in this packet and deny access to the file.</span></span><br/>                                                                                                                                                                                                                                                  |
| <span data-ttu-id="4debf-147">**Paquet 8 : \_ lecture de \_ \_ ANDX SMB com**</span><span class="sxs-lookup"><span data-stu-id="4debf-147">**Packet 8:  SMB\_COM\_READ\_ANDX**</span></span><br/> <span data-ttu-id="4debf-148">**Direction :** Client à serveur</span><span class="sxs-lookup"><span data-stu-id="4debf-148">**Direction:** Client to server</span></span><br/> <span data-ttu-id="4debf-149">**Description :** Le client demande au serveur de lire les données du fichier ouvert pour le compte du client et de renvoyer ces données au client.</span><span class="sxs-lookup"><span data-stu-id="4debf-149">**Description:** The client requests the server to read data from the opened file on behalf of the client and return this data to the client.</span></span> <span data-ttu-id="4debf-150">L’ID de fichier obtenu par le client lors de l’ouverture du fichier est inclus dans ce paquet afin d’identifier le fichier ouvert à partir duquel le serveur doit lire les données.</span><span class="sxs-lookup"><span data-stu-id="4debf-150">The file ID that is obtained by the client when the file was opened is included in this packet in order to identify which opened file the server should read data from.</span></span><br/>                                                                                                                                                                                                                   |
| <span data-ttu-id="4debf-151">**Paquet 9 : \_ lecture de \_ \_ ANDX SMB com**</span><span class="sxs-lookup"><span data-stu-id="4debf-151">**Packet 9:  SMB\_COM\_READ\_ANDX**</span></span><br/> <span data-ttu-id="4debf-152">**Direction :** Serveur à client</span><span class="sxs-lookup"><span data-stu-id="4debf-152">**Direction:** Server to client</span></span><br/> <span data-ttu-id="4debf-153">**Description :** Le serveur retourne les données de fichier demandées dans ce paquet.</span><span class="sxs-lookup"><span data-stu-id="4debf-153">**Description:** The server returns the requested file data in this packet.</span></span> <span data-ttu-id="4debf-154">Une erreur est peu probable, car l’accès au serveur, au partage et au fichier a été accordé.</span><span class="sxs-lookup"><span data-stu-id="4debf-154">An error here is unlikely given that access to the server, share, and file has been granted.</span></span> <span data-ttu-id="4debf-155">Cela peut toutefois se produire dans certains cas : par exemple, si l’accès à un partage est modifié entre l’ouverture du fichier et l’heure à laquelle il est lu.</span><span class="sxs-lookup"><span data-stu-id="4debf-155">It can happen in some situations, however: for example, if access to a share is changed between the time the file is opened and the time it is read from.</span></span><br/>                                                                                                                                                                                                      |



 

> [!Note]  
> <span data-ttu-id="4debf-156">Si vous implémentez un CIFS qui ne prend pas en charge les notifications de modification, Windows ne peut pas conserver un handle en attente pour le système de fichiers et la connexion SMB peut disparaître sans préavis.</span><span class="sxs-lookup"><span data-stu-id="4debf-156">If you implement a CIFS that does not support change notifications, Windows cannot keep an outstanding handle to the file system, and the SMB connection can go away without notice.</span></span>

 

 

 




