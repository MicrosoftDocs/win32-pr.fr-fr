---
description: Gestion des descripteurs de fichiers transactionnels dans NTFS transactionnel.
ms.assetid: 29879a3f-14b4-462c-a001-46c3c3eb74d1
title: Utilisation de NTFS transactionnel
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 43681f0d5b27f0db03d8b6c44564b792fce4b467
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "106536203"
---
# <a name="how-to-use-transactional-ntfs"></a><span data-ttu-id="a4c75-103">Utilisation de NTFS transactionnel</span><span class="sxs-lookup"><span data-stu-id="a4c75-103">How to Use Transactional NTFS</span></span>

## <a name="transacted-file-handles"></a><span data-ttu-id="a4c75-104">Handles de fichiers traités</span><span class="sxs-lookup"><span data-stu-id="a4c75-104">Transacted File Handles</span></span>

<span data-ttu-id="a4c75-105">NTFS transactionnel (TxF) lie un descripteur de fichier à une transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c75-105">Transactional NTFS (TxF) binds a file handle to a transaction.</span></span> <span data-ttu-id="a4c75-106">Pour les opérations qui fonctionnent sur un descripteur (par exemple, les fonctions [**ReadFile**](/windows/desktop/api/FileAPI/nf-fileapi-readfile) et [**WriteFile**](/windows/desktop/api/FileAPI/nf-fileapi-writefile) ), l’appel de la fonction d’API réel ne change pas.</span><span class="sxs-lookup"><span data-stu-id="a4c75-106">For operations that work on a handle (for example, the [**ReadFile**](/windows/desktop/api/FileAPI/nf-fileapi-readfile) and [**WriteFile**](/windows/desktop/api/FileAPI/nf-fileapi-writefile) functions), the actual API function call does not change.</span></span> <span data-ttu-id="a4c75-107">Pour les opérations de fichier qui prennent un nom, il existe des fonctions transactionnelles explicites pour ces opérations.</span><span class="sxs-lookup"><span data-stu-id="a4c75-107">For file operations that take a name, there are explicit transacted functions for these operations.</span></span> <span data-ttu-id="a4c75-108">Par exemple, au lieu d’appeler [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea), appelez [**CreateFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).</span><span class="sxs-lookup"><span data-stu-id="a4c75-108">For example, instead of calling [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea), call [**CreateFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).</span></span> <span data-ttu-id="a4c75-109">Cela crée un descripteur de fichier transactionnel, qui peut ensuite être utilisé pour toutes les opérations de fichier nécessitant un descripteur.</span><span class="sxs-lookup"><span data-stu-id="a4c75-109">This creates a transacted file handle, which can then be used for all file operations requiring a handle.</span></span> <span data-ttu-id="a4c75-110">Toutes les opérations suivantes utilisant ce handle sont des opérations traitées.</span><span class="sxs-lookup"><span data-stu-id="a4c75-110">All subsequent operations using this handle are transacted operations.</span></span>

## <a name="basic-txf-usage"></a><span data-ttu-id="a4c75-111">Utilisation de base de TxF</span><span class="sxs-lookup"><span data-stu-id="a4c75-111">Basic TxF Usage</span></span>

<span data-ttu-id="a4c75-112">La série d’étapes suivante représente l’utilisation la plus basique de TxF.</span><span class="sxs-lookup"><span data-stu-id="a4c75-112">The following series of steps represents the most basic usage for TxF.</span></span> <span data-ttu-id="a4c75-113">Des scénarios plus complexes sont également pris en charge, à la discrétion du concepteur d’application.</span><span class="sxs-lookup"><span data-stu-id="a4c75-113">More complex scenarios are also supported, at the discretion of the application designer.</span></span>

1.  <span data-ttu-id="a4c75-114">Créez une transaction en appelant la fonction KTM [**CreateTransaction**](/windows/desktop/api/ktmw32/nf-ktmw32-createtransaction) ou à l’aide de l’interface **IKernelTransaction** de l' [Distributed Transaction Coordinator](/previous-versions/windows/desktop/mscs/distributed-transaction-coordinator) (DTC).</span><span class="sxs-lookup"><span data-stu-id="a4c75-114">Create a transaction by calling the KTM function [**CreateTransaction**](/windows/desktop/api/ktmw32/nf-ktmw32-createtransaction) or by using the **IKernelTransaction** interface of the [Distributed Transaction Coordinator](/previous-versions/windows/desktop/mscs/distributed-transaction-coordinator) (DTC).</span></span>
2.  <span data-ttu-id="a4c75-115">Récupérez le ou les descripteurs de fichiers traités en appelant [**CreateFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).</span><span class="sxs-lookup"><span data-stu-id="a4c75-115">Get transacted file handle(s) by calling [**CreateFileTransacted**](/windows/desktop/api/WinBase/nf-winbase-createfiletransacteda).</span></span>
3.  <span data-ttu-id="a4c75-116">Modifiez le ou les fichiers en fonction des besoins à l’aide du ou des descripteurs de fichiers traités.</span><span class="sxs-lookup"><span data-stu-id="a4c75-116">Modify the file(s) as necessary using the transacted file handle(s).</span></span>
4.  <span data-ttu-id="a4c75-117">Fermez tous les descripteurs de fichiers traités associés à la transaction créée à l’étape 1.</span><span class="sxs-lookup"><span data-stu-id="a4c75-117">Close all transacted file handles associated with the transaction created in step 1.</span></span>
5.  <span data-ttu-id="a4c75-118">Validez ou annulez la transaction en appelant la fonction KTM ou DTC correspondante.</span><span class="sxs-lookup"><span data-stu-id="a4c75-118">Commit or abort the transaction by calling the corresponding KTM or DTC function.</span></span>

## <a name="key-points-of-the-txf-programming-model"></a><span data-ttu-id="a4c75-119">Points clés du modèle de programmation TxF</span><span class="sxs-lookup"><span data-stu-id="a4c75-119">Key Points of the TxF Programming Model</span></span>

<span data-ttu-id="a4c75-120">Le modèle de programmation TxF contient les points clés suivants que vous devez prendre en compte lorsque vous développez une application TxF :</span><span class="sxs-lookup"><span data-stu-id="a4c75-120">The TxF programming model has the following key points for you to consider when you develop a TxF application:</span></span>

-   <span data-ttu-id="a4c75-121">Il est fortement recommandé qu’une application ferme tous les descripteurs de fichiers transactionnels avant de valider ou de restaurer une transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c75-121">It is highly recommended that an application close all transacted file handles before committing or rolling back a transaction.</span></span> <span data-ttu-id="a4c75-122">Le système invalide tous les descripteurs traités lorsqu’une transaction se termine.</span><span class="sxs-lookup"><span data-stu-id="a4c75-122">The system invalidates all transacted handles when a transaction ends.</span></span> <span data-ttu-id="a4c75-123">Toute opération, à l’exception de Close, effectuée sur un handle traité après la fin de la transaction retourne l’erreur suivante : le **handle d’erreur \_ \_ n' \_ est plus \_ valide**.</span><span class="sxs-lookup"><span data-stu-id="a4c75-123">Any operation, except close, performed on a transacted handle after the transaction ends returns the following error: **ERROR\_HANDLE\_NO\_LONGER\_VALID**.</span></span>
-   <span data-ttu-id="a4c75-124">Un fichier est affiché en tant qu’unité de stockage.</span><span class="sxs-lookup"><span data-stu-id="a4c75-124">A file is viewed as a unit of storage.</span></span> <span data-ttu-id="a4c75-125">Les mises à jour partielles et les remplacements de fichiers complets sont pris en charge.</span><span class="sxs-lookup"><span data-stu-id="a4c75-125">Partial updates and complete file overwrites are supported.</span></span> <span data-ttu-id="a4c75-126">Plusieurs transactions ne peuvent pas modifier simultanément le même fichier.</span><span class="sxs-lookup"><span data-stu-id="a4c75-126">Multiple transactions cannot concurrently modify the same file.</span></span>
-   <span data-ttu-id="a4c75-127">Les e/s mappées en mémoire sont transparentes et cohérentes avec les e/s de fichier normales.</span><span class="sxs-lookup"><span data-stu-id="a4c75-127">Memory mapped I/O is transparent and consistent with the regular file I/O.</span></span> <span data-ttu-id="a4c75-128">Une application doit vider et fermer une section ouverte avant de valider une transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c75-128">An application must flush and close an opened section before committing a transaction.</span></span> <span data-ttu-id="a4c75-129">Si vous ne le faites pas, vous risquez d’avoir des modifications partielles apportées au fichier mappé au sein de la transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c75-129">Failure to do this can result in partial changes to the mapped file within the transaction.</span></span> <span data-ttu-id="a4c75-130">Une restauration échoue si cela n’est pas effectué.</span><span class="sxs-lookup"><span data-stu-id="a4c75-130">A rollback fails if this is not done.</span></span>

## <a name="common-programming-errors"></a><span data-ttu-id="a4c75-131">Erreurs de programmation courantes</span><span class="sxs-lookup"><span data-stu-id="a4c75-131">Common Programming Errors</span></span>

<span data-ttu-id="a4c75-132">Les erreurs courantes suivantes peuvent se produire lors du développement d’applications transactionnelles :</span><span class="sxs-lookup"><span data-stu-id="a4c75-132">The following common errors can occur when developing transacted applications:</span></span>

-   <span data-ttu-id="a4c75-133">Utilisation d’un descripteur de fichier après la fin d’une transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c75-133">Using a file handle after a transaction is completed.</span></span>
-   <span data-ttu-id="a4c75-134">Échec de la fermeture des handles aux fichiers et répertoires supprimés avant la validation d’une transaction, ce qui empêchera les opérations de suppression de se produire.</span><span class="sxs-lookup"><span data-stu-id="a4c75-134">Failing to close handles to deleted files and directories before committing a transaction, which will prevent the delete operations from occurring.</span></span> <span data-ttu-id="a4c75-135">Cet événement doit se produire avant d’effectuer la validation pour que l’opération de suppression soit considérée comme faisant partie de la transaction.</span><span class="sxs-lookup"><span data-stu-id="a4c75-135">This event must occur before performing the commit for the delete operation to be considered part of the transaction.</span></span> <span data-ttu-id="a4c75-136">Cela est dû au fait que le système ne supprime pas réellement un fichier tant que le dernier descripteur n’est pas fermé, même lorsque l’opération n’est pas traitée, dans le cadre du sous-système d’e/s de fichier Windows.</span><span class="sxs-lookup"><span data-stu-id="a4c75-136">This is because the system does not actually delete a file until the last handle to it is closed, even when the operation is not transacted, as part of the Windows file I/O subsystem.</span></span>
-   <span data-ttu-id="a4c75-137">Impossible de tenir compte des restaurations de transactions initiées par le système, qui peuvent se produire à tout moment ; par exemple, une transaction est restaurée si les ressources système sont épuisées.</span><span class="sxs-lookup"><span data-stu-id="a4c75-137">Failing to account for system-initiated transaction rollbacks, which may happen at any time; for example, a transaction is rolled back if the system resources are exhausted.</span></span>

 

 
