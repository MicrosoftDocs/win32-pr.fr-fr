---
description: Décrit les verrous de niveau 1, de niveau 2, de traitement par lots et de filtrage opportuniste.
ms.assetid: 06136348-0c08-4e9c-9c96-fd3af33cbdc0
title: Types de verrous opportunistes
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a755a6ff766f5d19e13d4b269c1ba4bb9803e934
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "103867690"
---
# <a name="types-of-opportunistic-locks"></a><span data-ttu-id="a5ce6-103">Types de verrous opportunistes</span><span class="sxs-lookup"><span data-stu-id="a5ce6-103">Types of Opportunistic Locks</span></span>

<span data-ttu-id="a5ce6-104">Les opérations de verrouillage opportuniste fonctionnent avec quatre types de verrous opportunistes : niveau 1, niveau 2, lot et filtre.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-104">The opportunistic lock operations work with four types of opportunistic locks: level 1, level 2, batch, and filter.</span></span> <span data-ttu-id="a5ce6-105">Les *verrous opportunistes exclusifs* sont les verrous de niveau 1, de lot et de filtre.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-105">*Exclusive opportunistic locks* are level 1, batch, and filter locks.</span></span> <span data-ttu-id="a5ce6-106">Si un thread a un verrou exclusif sur un fichier, il ne peut pas également avoir un verrou de niveau 2 sur le même fichier.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-106">If a thread has any type of exclusive lock on a file, it cannot also have a level 2 lock on the same file.</span></span>

## <a name="level-1-opportunistic-locks"></a><span data-ttu-id="a5ce6-107">Verrous opportunistes de niveau 1</span><span class="sxs-lookup"><span data-stu-id="a5ce6-107">Level 1 Opportunistic Locks</span></span>

<span data-ttu-id="a5ce6-108">Un verrou opportuniste de niveau 1 sur un fichier permet à un client de lire à l’avance dans le fichier et de mettre en cache les données en lecture anticipée et d’écrire les données à partir du fichier localement.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-108">A level 1 opportunistic lock on a file allows a client to read ahead in the file and cache both read-ahead and write data from the file locally.</span></span> <span data-ttu-id="a5ce6-109">Tant que le client dispose d’un seul accès à un fichier, il n’y a aucun danger pour la cohérence des données dans la fourniture d’un verrou opportuniste de niveau 1.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-109">As long as the client has sole access to a file, there is no danger to data coherency in providing a level 1 opportunistic lock.</span></span>

<span data-ttu-id="a5ce6-110">Le client peut demander un verrou opportuniste de niveau 1 après l’ouverture d’un fichier.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-110">The client can request a level 1 opportunistic lock after opening a file.</span></span> <span data-ttu-id="a5ce6-111">Si aucun autre client (ou aucun autre thread sur le même client) n’a ouvert le fichier, le serveur peut accorder le verrou opportuniste.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-111">If no other client (or no other thread on the same client) has the file open, the server may grant the opportunistic lock.</span></span> <span data-ttu-id="a5ce6-112">Le client peut ensuite mettre en cache les données en lecture et en écriture à partir du fichier localement.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-112">The client can then cache read and write data from the file locally.</span></span> <span data-ttu-id="a5ce6-113">Si un autre client a ouvert le fichier, le serveur refuse le verrou opportuniste et le client ne fait pas de mise en cache locale.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-113">If another client has opened the file, then the server refuses the opportunistic lock and the client does no local caching.</span></span> <span data-ttu-id="a5ce6-114">(Le serveur peut refuser le verrouillage opportuniste pour d’autres raisons, par exemple pour ne pas prendre en charge les verrous opportunistes.)</span><span class="sxs-lookup"><span data-stu-id="a5ce6-114">(The server may refuse the opportunistic lock for other reasons as well, such as not supporting opportunistic locks.)</span></span>

<span data-ttu-id="a5ce6-115">Lorsque le serveur ouvre un fichier qui a déjà un verrou opportuniste de niveau 1, le serveur examine l’état de partage du fichier avant de rompre le verrou opportuniste de niveau 1.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-115">When the server opens a file that already has a level 1 opportunistic lock on it, the server examines the sharing state of the file before it breaks the level 1 opportunistic lock.</span></span> <span data-ttu-id="a5ce6-116">Si le serveur interrompt le verrou après cet examen, l’heure à laquelle le client avec le verrou précédent passe de vider son cache d’écriture est le temps que le client qui demande le fichier doit attendre.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-116">If the server breaks the lock after this examination, the time the client with the former lock spends flushing its write cache is time the client requesting the file must wait.</span></span> <span data-ttu-id="a5ce6-117">Cette dépense de temps signifie que les verrous opportunistes de niveau 1 doivent être évités sur les fichiers ouverts par de nombreux clients.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-117">This time expenditure means that level 1 opportunistic locks should be avoided on files that many clients open.</span></span>

<span data-ttu-id="a5ce6-118">Toutefois, étant donné que le serveur vérifie l’état de partage avant de rompre le verrou, dans le cas où le serveur refuse une demande d’ouverture en raison d’un conflit de partage, le serveur n’interrompt pas le verrou.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-118">However, because the server checks the sharing state before it breaks the lock, in the case where the server would deny an open request due to a sharing conflict the server does not break the lock.</span></span> <span data-ttu-id="a5ce6-119">Par exemple, si vous avez ouvert un fichier, refusé le partage pour les opérations d’écriture et obtenu un verrou de niveau 1, le serveur refuse la demande d’ouverture du fichier par un autre client pour l’écriture avant même qu’il n’examine le verrou sur le fichier.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-119">For example, if you have opened a file, denied sharing for write operations, and obtained a level 1 lock, the server denies another client's request to open the file for writing before it even examines your lock on the file.</span></span> <span data-ttu-id="a5ce6-120">Dans ce cas, le verrouillage opportuniste n’est pas interrompu.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-120">In this instance, your opportunistic lock is not broken.</span></span>

<span data-ttu-id="a5ce6-121">Pour obtenir un exemple de fonctionnement d’un verrouillage opportuniste de niveau 1, consultez exemple de verrouillage opportuniste de niveau 1.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-121">For an example of how a level 1 opportunistic lock works, see Level 1 Opportunistic Lock Example.</span></span> <span data-ttu-id="a5ce6-122">Pour plus d’informations sur la rupture des verrous opportunistes, consultez [interruption des verrous opportunistes](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="a5ce6-122">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="level-2-opportunistic-locks"></a><span data-ttu-id="a5ce6-123">Verrous opportunistes de niveau 2</span><span class="sxs-lookup"><span data-stu-id="a5ce6-123">Level 2 Opportunistic Locks</span></span>

<span data-ttu-id="a5ce6-124">Un verrou opportuniste de niveau 2 informe un client qu’il existe plusieurs clients simultanés d’un fichier et qu’aucun ne l’a encore modifié.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-124">A level 2 opportunistic lock informs a client that there are multiple concurrent clients of a file and that none has yet modified it.</span></span> <span data-ttu-id="a5ce6-125">Ce verrou permet au client d’effectuer des opérations de lecture et d’obtenir des attributs de fichier à l’aide d’informations locales mises en cache ou en lecture anticipée, mais le client doit envoyer toutes les autres requêtes (telles que les opérations d’écriture) au serveur.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-125">This lock allows the client to perform read operations and obtain file attributes using cached or read-ahead local information, but the client must send all other requests (such as for write operations) to the server.</span></span> <span data-ttu-id="a5ce6-126">Votre application doit utiliser le verrou opportuniste de niveau 2 lorsque vous vous attendez à ce que d’autres applications écrivent dans le fichier au hasard ou lisent le fichier de façon aléatoire ou séquentielle.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-126">Your application should use the level 2 opportunistic lock when you expect other applications to write to the file at random or read the file at random or sequentially.</span></span>

<span data-ttu-id="a5ce6-127">Un verrou opportuniste de niveau 2 est très similaire à un verrou opportuniste de filtre.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-127">A level 2 opportunistic lock is very similar to a filter opportunistic lock.</span></span> <span data-ttu-id="a5ce6-128">Dans la plupart des cas, votre application doit utiliser le verrou opportuniste de niveau 2.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-128">In most situations, your application should use the level 2 opportunistic lock.</span></span> <span data-ttu-id="a5ce6-129">Utilisez le verrou de filtre uniquement si vous ne souhaitez pas que les opérations d’ouverture pour la lecture entraînent des violations du mode de partage dans l’intervalle de temps entre l’ouverture du fichier par votre application et la réception du verrou.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-129">Only use the filter lock if you do not want open operations for reading to cause sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="a5ce6-130">Pour plus d’informations, consultez filtrer les verrous opportunistes et [réponse du serveur pour ouvrir des demandes sur des fichiers verrouillés](server-response-to-open-requests-on-locked-files.md).</span><span class="sxs-lookup"><span data-stu-id="a5ce6-130">For more information, see Filter Opportunistic Locks and [Server Response to Open Requests on Locked Files](server-response-to-open-requests-on-locked-files.md).</span></span>

<span data-ttu-id="a5ce6-131">Pour plus d’informations sur la rupture des verrous opportunistes, consultez [interruption des verrous opportunistes](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="a5ce6-131">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="batch-opportunistic-locks"></a><span data-ttu-id="a5ce6-132">Verrouillages opportunistes par lots</span><span class="sxs-lookup"><span data-stu-id="a5ce6-132">Batch Opportunistic Locks</span></span>

<span data-ttu-id="a5ce6-133">Un verrou opportuniste de traitement par lots manipule les ouvertures et les fermetures de fichiers.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-133">A batch opportunistic lock manipulates file openings and closings.</span></span> <span data-ttu-id="a5ce6-134">Par exemple, dans l’exécution d’un fichier de commandes, le fichier de commandes peut être ouvert et fermé une fois pour chaque ligne du fichier.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-134">For example, in the execution of a batch file, the batch file may be opened and closed once for each line of the file.</span></span> <span data-ttu-id="a5ce6-135">Un verrou par lot opportuniste ouvre le fichier de commandes sur le serveur et le maintient ouvert.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-135">A batch opportunistic lock opens the batch file on the server and keeps it open.</span></span> <span data-ttu-id="a5ce6-136">À mesure que le processeur de commandes « s’ouvre » et « ferme » le fichier de commandes, le redirecteur réseau intercepte les commandes d’ouverture et de fermeture.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-136">As the command processor "opens" and "closes" the batch file, the network redirector intercepts the open and close commands.</span></span> <span data-ttu-id="a5ce6-137">Tout le serveur reçoit les commandes Seek et Read.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-137">All the server receives are the seek and read commands.</span></span> <span data-ttu-id="a5ce6-138">Si le client est également en lecture anticipée, le serveur reçoit une demande de lecture particulière au plus une fois.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-138">If the client is also reading ahead, the server receives a particular read request at most one time.</span></span>

<span data-ttu-id="a5ce6-139">Lors de l’ouverture d’un fichier qui a déjà un verrou opportuniste par lot, le serveur vérifie l’état de partage du fichier après avoir endommagé le verrou.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-139">When opening a file that already has a batch opportunistic lock, the server checks the sharing state of the file after breaking the lock.</span></span> <span data-ttu-id="a5ce6-140">Cette vérification donne au détenteur du verrou la possibilité de terminer le vidage de son cache et de fermer le descripteur de fichier.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-140">This check gives the holder of the lock a chance to complete flushing its cache and to close the file handle.</span></span> <span data-ttu-id="a5ce6-141">Une opération d’ouverture tentée pendant la vérification du partage n’entraîne pas l’échec de la vérification du partage si le détenteur du verrou libère le verrou.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-141">An open operation attempted during the sharing check does not cause the sharing check to fail if the lock holder releases the lock.</span></span>

<span data-ttu-id="a5ce6-142">Pour obtenir un exemple illustrant le fonctionnement d’un verrouillage opportuniste par lot, consultez exemple de verrouillage opportuniste par lots.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-142">For an example of how a batch opportunistic lock works, see Batch Opportunistic Lock Example.</span></span> <span data-ttu-id="a5ce6-143">Pour plus d’informations sur la rupture des verrous opportunistes, consultez [interruption des verrous opportunistes](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="a5ce6-143">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="filter-opportunistic-locks"></a><span data-ttu-id="a5ce6-144">Filtrer les verrous opportunistes</span><span class="sxs-lookup"><span data-stu-id="a5ce6-144">Filter Opportunistic Locks</span></span>

<span data-ttu-id="a5ce6-145">Un verrou opportuniste de filtre verrouille un fichier afin qu’il ne puisse pas être ouvert pour l’accès en écriture ou en suppression.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-145">A filter opportunistic lock locks a file so that it cannot be opened for either write or delete access.</span></span> <span data-ttu-id="a5ce6-146">Tous les clients doivent être en mesure de partager le fichier.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-146">All clients must be able to share the file.</span></span> <span data-ttu-id="a5ce6-147">Les verrous de filtre permettent aux applications d’effectuer des opérations de filtrage non intrusives sur des données de fichier (par exemple, un compilateur ouvrant du code source ou un programme de catalogage).</span><span class="sxs-lookup"><span data-stu-id="a5ce6-147">Filter locks allow applications to perform nonintrusive filtering operations on file data (for example, a compiler opening source code or a cataloging program).</span></span>

<span data-ttu-id="a5ce6-148">Un verrou opportuniste de filtre diffère d’un verrou opportuniste de niveau 2 dans la mesure où il permet aux opérations d’ouverture de lecture de se produire sans violations du mode de partage dans l’intervalle de temps entre l’ouverture du fichier par votre application et la réception du verrou.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-148">A filter opportunistic lock differs from a level 2 opportunistic lock in that it allows open operations for reading to occur without sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="a5ce6-149">Le verrou opportuniste de filtre est le meilleur verrou à utiliser lorsqu’il est important d’autoriser d’autres clients à lire l’accès.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-149">The filter opportunistic lock is the best lock to use when it is important to allow other clients reading access.</span></span> <span data-ttu-id="a5ce6-150">Dans d’autres cas, votre application doit utiliser un verrou opportuniste de niveau 2.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-150">In other cases, your application should use a level 2 opportunistic lock.</span></span> <span data-ttu-id="a5ce6-151">Un verrou opportuniste de filtre diffère d’un verrou par lot opportuniste dans le sens où il ne permet pas à plusieurs ouvertures et fermetures d’être gérées par le redirecteur réseau à l’aide d’un verrou par lot opportuniste.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-151">A filter opportunistic lock differs from a batch opportunistic lock in that it does not allow multiple openings and closings to be handled by the network redirector the way a batch opportunistic lock does.</span></span>

<span data-ttu-id="a5ce6-152">Votre application doit demander un verrou opportuniste de filtre sur un fichier en trois étapes :</span><span class="sxs-lookup"><span data-stu-id="a5ce6-152">Your application should request a filter opportunistic lock on a file in three steps:</span></span>

1.  <span data-ttu-id="a5ce6-153">Utilisez la fonction [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) pour ouvrir un handle vers le fichier avec le paramètre *desiredAccess* défini sur zéro, indiquant qu’il n’y a pas d’accès, et le paramètre *dwShareMode* défini sur l’indicateur de **\_ \_ lecture de partage de fichiers** pour autoriser le partage pour la lecture.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-153">Use the [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) function to open a handle to the file with the *DesiredAccess* parameter set to zero, indicating no access, and the *dwShareMode* parameter set to the **FILE\_SHARE\_READ** flag to allow sharing for reading.</span></span> <span data-ttu-id="a5ce6-154">Le descripteur obtenu à ce stade est appelé handle de verrouillage.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-154">The handle obtained at this point is called the locking handle.</span></span>
2.  <span data-ttu-id="a5ce6-155">Demandez un verrou sur ce descripteur à l’aide du code de contrôle [**\_ OPLOCK de \_ filtre \_ de requête FSCTL**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) .</span><span class="sxs-lookup"><span data-stu-id="a5ce6-155">Request a lock on this handle with the [**FSCTL\_REQUEST\_FILTER\_OPLOCK**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) control code.</span></span>
3.  <span data-ttu-id="a5ce6-156">Lorsque le verrou est accordé, utilisez [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) pour ouvrir à nouveau le fichier avec *desiredAccess* défini sur l’indicateur de **\_ lecture générique** .</span><span class="sxs-lookup"><span data-stu-id="a5ce6-156">When the lock is granted, use [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) to open the file again with *DesiredAccess* set to the **GENERIC\_READ** flag.</span></span> <span data-ttu-id="a5ce6-157">Définissez *dwShareMode* sur l’indicateur de **\_ \_ lecture de partage de fichiers** pour permettre à d’autres utilisateurs de lire le fichier quand vous l’avez ouvert, l’indicateur de **\_ \_ Suppression de partage de fichiers** pour permettre à d’autres utilisateurs de marquer le fichier pour qu’il soit supprimé, ou les deux.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-157">Set *dwShareMode* to the **FILE\_SHARE\_READ** flag to allow others to read the file while you have it open, the **FILE\_SHARE\_DELETE** flag to allow others to mark the file for deletion while you have it open, or both.</span></span> <span data-ttu-id="a5ce6-158">Le descripteur obtenu à ce stade est appelé handle de lecture.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-158">The handle obtained at this point is called the read handle.</span></span>

<span data-ttu-id="a5ce6-159">Utilisez le handle de lecture pour lire ou écrire dans le contenu du fichier.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-159">Use the read handle to read from or write to the contents of the file.</span></span>

<span data-ttu-id="a5ce6-160">Lors de l’ouverture d’un fichier qui a déjà un verrou opportuniste de filtre, le serveur interrompt le verrou, puis vérifie l’état de partage du fichier.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-160">When opening a file that already has a filter opportunistic lock, the server breaks the lock and then checks the sharing state of the file.</span></span> <span data-ttu-id="a5ce6-161">Cette vérification donne au client qui détenait l’ancien verrou opportuniste la possibilité d’abandonner toutes les données mises en cache et d’accuser réception de l’arrêt.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-161">This check gives the client that held the former opportunistic lock a chance to abandon any cached data and acknowledge the break.</span></span> <span data-ttu-id="a5ce6-162">Une opération d’ouverture tentée pendant cette vérification du partage n’entraîne pas l’échec de la vérification du partage si le détenteur du verrouillage précédent libère le verrou.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-162">An open operation attempted during this sharing check does not cause the sharing check to fail if the former lock holder releases the lock.</span></span> <span data-ttu-id="a5ce6-163">Le système de fichiers contient dans abeyance l’opération d’ouverture jusqu’à ce que le propriétaire du verrou ferme à la fois le handle de lecture et le handle de verrouillage.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-163">The file system holds in abeyance the open operation until the lock's owner closes both the read handle and then the locking handle.</span></span> <span data-ttu-id="a5ce6-164">Une fois cette opération terminée, la demande d’ouverture de l’autre client peut se poursuivre.</span><span class="sxs-lookup"><span data-stu-id="a5ce6-164">After this is done, the other client's open request can proceed.</span></span>

<span data-ttu-id="a5ce6-165">Pour plus d’informations sur la rupture des verrous opportunistes, consultez [interruption des verrous opportunistes](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="a5ce6-165">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

 

 
