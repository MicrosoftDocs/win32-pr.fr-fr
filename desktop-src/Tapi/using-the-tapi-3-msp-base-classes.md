---
description: La procédure suivante décrit comment implémenter un MSP à l’aide d’ATL version 2,1 ou ATL version 3,0 et des classes de base MSP.
ms.assetid: 7485c34a-3c8a-412f-9cb9-8eb895084292
title: Utilisation des classes de base TAPI 3 MSP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: eb8ad4fd160cf0fc4c7dd682a44f3a4ff0bcec25
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "106535657"
---
# <a name="using-the-tapi-3-msp-base-classes"></a><span data-ttu-id="509a7-103">Utilisation des classes de base TAPI 3 MSP</span><span class="sxs-lookup"><span data-stu-id="509a7-103">Using The TAPI 3 MSP Base Classes</span></span>

<span data-ttu-id="509a7-104">La procédure suivante décrit comment implémenter un MSP à l’aide d’ATL version 2,1 ou ATL version 3,0 et des classes de base MSP.</span><span class="sxs-lookup"><span data-stu-id="509a7-104">The following procedure describes how to implement an MSP using ATL version 2.1 or ATL version 3.0 and the MSP base classes.</span></span> <span data-ttu-id="509a7-105">Pour plus d’informations et pour obtenir la liste des bibliothèques et en-têtes, consultez [classes de base TAPI 3 MSP](tapi-3-msp-base-classes.md).</span><span class="sxs-lookup"><span data-stu-id="509a7-105">For more information and a list of libraries and headers, see [TAPI 3 MSP Base Classes](tapi-3-msp-base-classes.md).</span></span> <span data-ttu-id="509a7-106">Le contenu de cette rubrique part du principe que le développeur a une bonne compréhension de ATL et COM, et qu’il a une expérience en matière d’implémentation des DLL COM à l’aide d’ATL.</span><span class="sxs-lookup"><span data-stu-id="509a7-106">The content contained in this topic assumes that the developer has a working understanding of ATL and COM, and has experience implementing COM DLLs using ATL.</span></span>

<span data-ttu-id="509a7-107">**Pour implémenter et MSP en utilisant ATL 2,1 ou ATL 3,0**</span><span class="sxs-lookup"><span data-stu-id="509a7-107">**To implement and MSP using ATL 2.1 or ATL 3.0**</span></span>

1.  <span data-ttu-id="509a7-108">Créez un fichier IDL pour votre MSP.</span><span class="sxs-lookup"><span data-stu-id="509a7-108">Create an IDL file for your MSP.</span></span> <span data-ttu-id="509a7-109">Ce fichier définit un CLSID pour votre MSP.</span><span class="sxs-lookup"><span data-stu-id="509a7-109">This file defines a CLSID for your MSP.</span></span> <span data-ttu-id="509a7-110">Déclarez votre « coclasse » MSP comme implémentant l’interface [**ITMSPAddress**](/windows/desktop/api/msp/nn-msp-itmspaddress) , puis déclarez cette interface comme interface par défaut sur votre objet de classe.</span><span class="sxs-lookup"><span data-stu-id="509a7-110">Declare your MSP "coclass" as implementing the [**ITMSPAddress**](/windows/desktop/api/msp/nn-msp-itmspaddress) interface, and declare this interface as the default interface on your class object.</span></span> <span data-ttu-id="509a7-111">Pour la définition de **ITMSPAddress**, importez le fichier « MSP. idl ».</span><span class="sxs-lookup"><span data-stu-id="509a7-111">For the definition of **ITMSPAddress**, import the file "msp.idl".</span></span> <span data-ttu-id="509a7-112">Incluez votre « coclasse » MSP dans une bibliothèque de types pour votre MSP.</span><span class="sxs-lookup"><span data-stu-id="509a7-112">Include your MSP "coclass" in a type library for your MSP.</span></span> <span data-ttu-id="509a7-113">Si votre MSP prend en charge les interfaces privées (personnalisées), définissez-les ici et incluez-les dans votre bibliothèque de types.</span><span class="sxs-lookup"><span data-stu-id="509a7-113">If your MSP supports private (custom) interfaces, define them here and include them in your type library.</span></span> <span data-ttu-id="509a7-114">L’exemple de code suivant est un fichier IDL comme décrit ci-dessus, sans interfaces personnalisées.</span><span class="sxs-lookup"><span data-stu-id="509a7-114">The following code example is an IDL file as described above, without custom interfaces.</span></span>

    ``` syntax
    import "msp.idl";
    [
          uuid(4DDB6D35-3BC1-11d2-86F2-006008B0E5D2),
          version(2.0),
          helpstring("Wave MSP 2.0 Type Library")
    ]
    library WAVEMSPLib
    {
    importlib("stdole32.tlb");
    importlib("stdole2.tlb");

    [
    uuid(4DDB6D36-3BC1-11d2-86F2-006008B0E5D2),
    helpstring("Wave MSP Class")
    ]
    coclass WaveMSP
    {
    [default] interface ITMSPAddress;
    };
    };
    ```

2.  <span data-ttu-id="509a7-115">Modifiez votre TSP pour publier le CLSID de votre MSP lorsque Tapi3.dll le demande.</span><span class="sxs-lookup"><span data-stu-id="509a7-115">Modify your TSP to advertise the CLSID of your MSP when Tapi3.dll requests it.</span></span> <span data-ttu-id="509a7-116">Assurez-vous que (1) votre TSP peut négocier TAPI \_ VERSION3 \_ 0 ou une version ultérieure dans la fonction TSPI [**TSPI \_ lineNegotiateTSPIVersion**](/windows/win32/api/tspi/nf-tspi-tspi_linenegotiatetspiversion), (2) votre structure de [**LINEDEVCAPS**](/windows/win32/api/tapi/ns-tapi-linedevcaps) du PVC a l' \_ indicateur MSP LINEDEVCAPFLAGS défini dans le membre **DWDEVCAPFLAGS** et (3) votre TSP retourne votre CLSID msp dans la fonction TSPI TSPI [**\_ lineMSPIdentify**](/windows/win32/api/tspi/nf-tspi-tspi_linemspidentify).</span><span class="sxs-lookup"><span data-stu-id="509a7-116">Ensure that (1) your TSP can negotiate TAPI\_VERSION3\_0 or higher in the TSPI function [**TSPI\_lineNegotiateTSPIVersion**](/windows/win32/api/tspi/nf-tspi-tspi_linenegotiatetspiversion), (2) your TSP [**LINEDEVCAPS**](/windows/win32/api/tapi/ns-tapi-linedevcaps) structure has the LINEDEVCAPFLAGS\_MSP flag set in the **dwDevCapFlags** member, and (3) your TSP returns your MSP CLSID in the TSPI function [**TSPI\_lineMSPIdentify**](/windows/win32/api/tspi/nf-tspi-tspi_linemspidentify).</span></span> <span data-ttu-id="509a7-117">Il doit s’agir du même CLSID que celui spécifié dans votre fichier IDL ; par exemple, la deuxième ligne « UUID » dans l’exemple de fichier IDL à l’étape précédente.</span><span class="sxs-lookup"><span data-stu-id="509a7-117">This should be the same CLSID specified in your IDL file; for example, the second "uuid" line in the example IDL file in the previous step.</span></span>
3.  <span data-ttu-id="509a7-118">Compilez l’exemple d’application MSPBase, situé dans le kit de développement logiciel (SDK) de la plateforme, pour créer la bibliothèque MSPBaseSample. lib.</span><span class="sxs-lookup"><span data-stu-id="509a7-118">Compile the MSPBase sample application, located in the Platform Software Development Kit (SDK), to create the MSPBaseSample.lib library.</span></span>
4.  <span data-ttu-id="509a7-119">Liez votre DLL MSP à la bibliothèque MSPBaseSample. lib.</span><span class="sxs-lookup"><span data-stu-id="509a7-119">Link your MSP DLL with the MSPBaseSample.lib library.</span></span>
5.  <span data-ttu-id="509a7-120">Incluez Mspbase. h dans le kit de développement logiciel (SDK) pour les définitions de classe de base MSP.</span><span class="sxs-lookup"><span data-stu-id="509a7-120">Include Mspbase.h from the SDK for MSP base class definitions.</span></span>
6.  <span data-ttu-id="509a7-121">Implémentez vos exportations de DLL (par exemple, DllMain).</span><span class="sxs-lookup"><span data-stu-id="509a7-121">Implement your DLL exports (for example, DllMain).</span></span> <span data-ttu-id="509a7-122">Microsoft Visual C++ les génère pour vous.</span><span class="sxs-lookup"><span data-stu-id="509a7-122">Microsoft Visual C++ will generate these for you.</span></span> <span data-ttu-id="509a7-123">Dans DllMain, sur \_ le processus dll \_ attacher et \_ \_ détacher le processus de dll, utilisez les macros **MSPLOGREGISTER** et **MSPLOGDEREGISTER** pour activer les fonctionnalités de journalisation pour votre dll.</span><span class="sxs-lookup"><span data-stu-id="509a7-123">In DllMain, on DLL\_PROCESS\_ATTACH and DLL\_PROCESS\_DETACH, respectively, use the **MSPLOGREGISTER** and **MSPLOGDEREGISTER** macros to enable up logging features for your DLL.</span></span> <span data-ttu-id="509a7-124">Spécifiez le nom de votre DLL dans l’appel **MSPLOGDEREGISTER** .</span><span class="sxs-lookup"><span data-stu-id="509a7-124">Specify the name of your DLL in the **MSPLOGDEREGISTER** call.</span></span>
7.  <span data-ttu-id="509a7-125">Utilisez la macro LOG, définie dans Msplog. h, pour générer les messages de trace de la même manière que les classes de base.</span><span class="sxs-lookup"><span data-stu-id="509a7-125">Use the LOG macro, defined in Msplog.h, to output trace messages in the same fashion as the base classes.</span></span> <span data-ttu-id="509a7-126">Définissez le symbole de préprocesseur MSPLOG pour inclure la journalisation dans votre DLL ; Laissez-le non défini pour générer une DLL qui n’a pas de journalisation.</span><span class="sxs-lookup"><span data-stu-id="509a7-126">Define the MSPLOG preprocessor symbol to include logging in your DLL; leave it undefined to build a DLL that does not have logging.</span></span>
8.  <span data-ttu-id="509a7-127">Dérivez une classe de CMSPAddress qui implémente des adresses pour votre MSP.</span><span class="sxs-lookup"><span data-stu-id="509a7-127">Derive a class from CMSPAddress that implements addresses for your MSP.</span></span> <span data-ttu-id="509a7-128">Déclarez un mappage d’objet ATL global qui indique à ATL de créer une instance de votre classe d’adresses lorsque vous êtes invité à **cocréer** sur le CLSID que vous avez spécifié dans votre fichier IDL.</span><span class="sxs-lookup"><span data-stu-id="509a7-128">Declare a global ATL object map which instructs ATL to create an instance of your address class when asked to **CoCreate** on the CLSID you specified in your IDL file.</span></span> <span data-ttu-id="509a7-129">En outre, dérivez votre classe Address du modèle ATL **CComCoClass** et incluez une \_ déclaration DECLARE Registry \_ ResourceId dans votre classe Address.</span><span class="sxs-lookup"><span data-stu-id="509a7-129">Also, derive your address class from the ATL **CComCoClass** template, and include a DECLARE\_REGISTRY\_RESOURCEID declaration in your address class.</span></span> <span data-ttu-id="509a7-130">Construisez un script de ressources et un fichier d’en-tête correspondants, comme pour toute autre DLL COM ATL.</span><span class="sxs-lookup"><span data-stu-id="509a7-130">Construct a corresponding resource script and header file, as for any other ATL COM DLL.</span></span>
9.  <span data-ttu-id="509a7-131">Implémentez les remplacements CMSPAddress requis pour votre classe Address.</span><span class="sxs-lookup"><span data-stu-id="509a7-131">Implement the required CMSPAddress overrides for your address class.</span></span> <span data-ttu-id="509a7-132">Pour [**MSPAddressAddRef**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-mspaddressaddref) et [**MSPAddressRelease**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-mspaddressrelease), appelez les modèles de fonction d’assistance fournis.</span><span class="sxs-lookup"><span data-stu-id="509a7-132">For [**MSPAddressAddRef**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-mspaddressaddref) and [**MSPAddressRelease**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-mspaddressrelease), call the provided helper function templates.</span></span> <span data-ttu-id="509a7-133">Pour [**GetCallMediaTypes**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-getcallmediatypes), il vous suffit de retourner une image bitmap **DWORD** avec l’ensemble de vos TAPIMEDIAMODEs pris en charge par le MSP.</span><span class="sxs-lookup"><span data-stu-id="509a7-133">For [**GetCallMediaTypes**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-getcallmediatypes), simply return a **DWORD** bitmap with all of your MSP-supported TAPIMEDIAMODEs ORed together.</span></span> <span data-ttu-id="509a7-134">Pour [**CreateMSPCall**](/windows/desktop/api/msp/nf-msp-itmspaddress-createmspcall) et [**ShutdownMSPCall**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdownmspcall), retournez E \_ NOTIMPL et compilez et liez votre MSP à ce stade.</span><span class="sxs-lookup"><span data-stu-id="509a7-134">For [**CreateMSPCall**](/windows/desktop/api/msp/nf-msp-itmspaddress-createmspcall) and [**ShutdownMSPCall**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdownmspcall), return E\_NOTIMPL and compile and link your MSP at this point.</span></span> <span data-ttu-id="509a7-135">À présent, vérifiez que vous pouvez inscrire et instancier votre MSP à partir d’applications TAPI 3, mais que vous n’avez pas réussi à créer des appels.</span><span class="sxs-lookup"><span data-stu-id="509a7-135">Now, verify that you can register and instantiate your MSP from TAPI 3 applications, but not successfully create calls.</span></span>
10. <span data-ttu-id="509a7-136">Dérivez une classe de CMSPCallMultiGraph pour implémenter vos objets d’appel MSP.</span><span class="sxs-lookup"><span data-stu-id="509a7-136">Derive a class from CMSPCallMultiGraph to implement your MSP call objects.</span></span> <span data-ttu-id="509a7-137">Vous pouvez effectuer une dérivation à partir de [**CMSPCallBase**](/windows/desktop/api/Mspcall/nl-mspcall-cmspcallbase) au lieu de [**CMSPCallMultiGraph**](/windows/desktop/api/Mspcall/nl-mspcall-cmspcallmultigraph) si le modèle de filtre graphique par flux ne répond pas à vos besoins ; Cela augmente la complexité de la tâche (à la rédaction de cet article, tous les MSP dérivent les objets d’appel directement à partir de **CMSPCallMultiGraph**).</span><span class="sxs-lookup"><span data-stu-id="509a7-137">You may want to derive from [**CMSPCallBase**](/windows/desktop/api/Mspcall/nl-mspcall-cmspcallbase) instead of [**CMSPCallMultiGraph**](/windows/desktop/api/Mspcall/nl-mspcall-cmspcallmultigraph) if the filter-graph-per-stream model does not fit your requirements; this will increase the complexity of the task (as of this writing, all MSPs derive call objects directly from **CMSPCallMultiGraph**).</span></span> <span data-ttu-id="509a7-138">Dans votre objet d’adresse, implémentez [**CreateMSPCall**](/windows/desktop/api/msp/nf-msp-itmspaddress-createmspcall) et [**ShutdownMSPCall**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdownmspcall) pour créer et arrêter votre type spécifique d’objet d’appel à l’aide des modèles de fonction d’assistance fournis.</span><span class="sxs-lookup"><span data-stu-id="509a7-138">In your address object, implement [**CreateMSPCall**](/windows/desktop/api/msp/nf-msp-itmspaddress-createmspcall) and [**ShutdownMSPCall**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdownmspcall) to create and shut down your specific type of call object using the provided helper function templates.</span></span> <span data-ttu-id="509a7-139">Dans votre objet d’appel, remplacez [**CreateStreamObject**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-createstreamobject) pour retourner E \_ NOTIMPL.</span><span class="sxs-lookup"><span data-stu-id="509a7-139">In your call object, override [**CreateStreamObject**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-createstreamobject) to return E\_NOTIMPL.</span></span> <span data-ttu-id="509a7-140">Remplacez [**MSPCallAddRef**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-mspcalladdref) et [**MSPCallRelease**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-mspcallrelease) de manière identique aux méthodes d’adresse correspondantes.</span><span class="sxs-lookup"><span data-stu-id="509a7-140">Override [**MSPCallAddRef**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-mspcalladdref) and [**MSPCallRelease**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-mspcallrelease) in a manner identical to the corresponding address methods.</span></span> <span data-ttu-id="509a7-141">Là encore, vous devez être en mesure de compiler et lier votre MSP. il doit maintenant être en mesure de créer et d’arrêter des appels, mais les appels n’effectuent pas de diffusion utile.</span><span class="sxs-lookup"><span data-stu-id="509a7-141">Again, you should be able to compile and link your MSP; it should now be able to create and shut down calls, but the calls will not do any useful streaming.</span></span>
11. <span data-ttu-id="509a7-142">Dérivez une classe de CMSPStream pour implémenter vos objets de flux MSP.</span><span class="sxs-lookup"><span data-stu-id="509a7-142">Derive a class from CMSPStream to implement your MSP stream objects.</span></span> <span data-ttu-id="509a7-143">Dans votre objet d’appel, implémentez [**CreateStreamObject**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-createstreamobject) pour créer et initialiser votre objet de flux (en général, en appelant la fonction ATL **CreateInstance** suivie de la **\_ InternalQueryInterface** ATL pour [**ITStream**](/windows/win32/api/tapi3if/nn-tapi3if-itstream) , puis en appelant **init** sur votre objet de flux).</span><span class="sxs-lookup"><span data-stu-id="509a7-143">In your call object, implement [**CreateStreamObject**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-createstreamobject) to create and initialize your stream object (typically by calling the ATL **CreateInstance** followed by the ATL **\_InternalQueryInterface** for [**ITStream**](/windows/win32/api/tapi3if/nn-tapi3if-itstream) followed by calling **Init** on your stream object).</span></span> <span data-ttu-id="509a7-144">Pour prendre en charge un nombre fixe de flux (cela est courant pour les MSP qui ne prennent pas en charge la modification des configurations de flux par d’autres points de terminaison sur l’appel), remplacez **init**, [**CreateStream,**](/windows/win32/api/tapi3if/nf-tapi3if-itstreamcontrol-createstream)et [**RemoveStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstreamcontrol-removestream) sur votre objet d’appel.</span><span class="sxs-lookup"><span data-stu-id="509a7-144">To support a fixed number of streams (this is common for MSPs which do not support modification of stream configurations by other endpoints on the call), override **Init**, [**CreateStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstreamcontrol-createstream), and [**RemoveStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstreamcontrol-removestream) on your call object.</span></span> <span data-ttu-id="509a7-145">(L' **initialisation** d’appel crée tous vos flux initialement, et **CreateStream,** et **RemoveStream** retournent les codes d’erreur TAPI appropriés pour empêcher l’application de créer ou de supprimer des flux).</span><span class="sxs-lookup"><span data-stu-id="509a7-145">(The call **Init** creates all of your streams initially, and **CreateStream** and **RemoveStream** return the appropriate TAPI error codes to prevent the application from creating or removing streams).</span></span> <span data-ttu-id="509a7-146">Sinon, remplacez la méthode **init** de l’appel pour créer une configuration par défaut initiale des flux à l’aide des types de médias demandés pour l’appel.</span><span class="sxs-lookup"><span data-stu-id="509a7-146">Otherwise, override the call's **Init** method to create some initial default configuration of streams using the media types requested for the call.</span></span> <span data-ttu-id="509a7-147">Quand vous créez des objets de flux par défaut dans la méthode **init** de votre appel, utilisez la méthode d’assistance [**InternalCreateStream**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-internalcreatestream) .</span><span class="sxs-lookup"><span data-stu-id="509a7-147">When creating any default stream objects in your call's **Init** method, use the [**InternalCreateStream**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-internalcreatestream) helper method.</span></span>
12. <span data-ttu-id="509a7-148">Implémentez votre objet de flux.</span><span class="sxs-lookup"><span data-stu-id="509a7-148">Implement your stream object.</span></span> <span data-ttu-id="509a7-149">La seule substitution obligatoire est la méthode [**de \_ nom d’extraction**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-get_name) , qui retourne simplement un nom convivial pour le flux.</span><span class="sxs-lookup"><span data-stu-id="509a7-149">The only required override is the [**get\_Name**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-get_name) method, which simply returns a friendly name for the stream.</span></span> <span data-ttu-id="509a7-150">En outre, vous devrez remplacer plusieurs autres méthodes.</span><span class="sxs-lookup"><span data-stu-id="509a7-150">In addition, you will need to override several other methods.</span></span> <span data-ttu-id="509a7-151">Les méthodes à substituer varient en fonction de votre implémentation et lorsque vous décidez d’effectuer les différentes tâches impliquées dans la construction et la déconstruction de votre graphique de filtre.</span><span class="sxs-lookup"><span data-stu-id="509a7-151">Exactly which methods to override depends on your implementation and when you decide to perform the various tasks involved in constructing and deconstructing your filter graph.</span></span> <span data-ttu-id="509a7-152">Ces tâches incluent la création des filtres de transport, des codecs et ainsi de suite, ainsi que l’insertion et la suppression des filtres dans les graphiques de filtres aux moments appropriés.</span><span class="sxs-lookup"><span data-stu-id="509a7-152">These tasks include creating the appropriate "transport" filters, codecs, and so on, and inserting them and removing them from the filter graphs at the appropriate times.</span></span> <span data-ttu-id="509a7-153">Vous devez également utiliser l’interface [**ITTerminalControl**](/windows/desktop/api/Termmgr/nn-termmgr-itterminalcontrol) sur les objets terminaux pour connecter les terminaux sélectionnés à vos flux.</span><span class="sxs-lookup"><span data-stu-id="509a7-153">You will also have to use the [**ITTerminalControl**](/windows/desktop/api/Termmgr/nn-termmgr-itterminalcontrol) interface on terminal objects to connect the selected terminals to your streams.</span></span> <span data-ttu-id="509a7-154">Vous pouvez remplacer [**SelectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal) et [**UnselectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) sur votre objet de flux pour limiter les configurations de terminal que vos flux accepteront. la limitation de chaque flux à un seul terminal simplifie en particulier la construction de vos graphiques de filtre, mais elle sacrifie les fonctionnalités de l’application telles que la préversion vidéo.</span><span class="sxs-lookup"><span data-stu-id="509a7-154">You may want to override [**SelectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal) and [**UnselectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) on your stream object to limit the terminal configurations that your streams will accept; limiting each stream to a single terminal will especially simplify construction of your filter graphs, but will sacrifice application functionality such as video preview.</span></span> <span data-ttu-id="509a7-155">Selon votre implémentation, vous allez placer votre code de construction de graphe, de déconstruction et de connexion de terminal dans les méthodes [**StartStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-startstream), [**StopStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-stopstream), [**PauseStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-pausestream), [**Initialize**](/windows/desktop/api/msp/nf-msp-itmspaddress-initialize), [**Shutdown**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdown), [**SelectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal)et [**UnselectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) , ou dans vos propres méthodes basées sur la communication de TSP privée.</span><span class="sxs-lookup"><span data-stu-id="509a7-155">Depending on your implementation, you will place your graph construction, deconstruction, and terminal connection code in the [**StartStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-startstream), [**StopStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-stopstream), [**PauseStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-pausestream), [**Initialize**](/windows/desktop/api/msp/nf-msp-itmspaddress-initialize), [**Shutdown**](/windows/desktop/api/msp/nf-msp-itmspaddress-shutdown), [**SelectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal), and [**UnselectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) methods, or in your own methods based on private TSP communication.</span></span> <span data-ttu-id="509a7-156">Sachez qu’un flux sans terminal sélectionné doit suivre l’État graphique souhaité ; un appel **StartStream** suivi d’un appel **SelectTerminal** sur ce type de flux doit générer un flux de données.</span><span class="sxs-lookup"><span data-stu-id="509a7-156">Be aware that a stream with no terminals selected must track the desired graph state; a **StartStream** call followed by a **SelectTerminal** call on such a stream must result in a data stream.</span></span> <span data-ttu-id="509a7-157">Substituez la plupart de ces méthodes pour vous assurer que la construction, la déconstruction, la connexion et la déconnexion appropriées se produisent dans chaque cas, en fonction de l’état du flux.</span><span class="sxs-lookup"><span data-stu-id="509a7-157">Override most of these methods to ensure that the correct construction, deconstruction, connection, and disconnection happens in each case depending on the state of the stream.</span></span>
13. <span data-ttu-id="509a7-158">Implémentez votre communication sur le TSP.</span><span class="sxs-lookup"><span data-stu-id="509a7-158">Implement your TSP communication.</span></span> <span data-ttu-id="509a7-159">Remplacez [**CMSPAddress :: ReceiveTSPAddressData**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-receivetspaddressdata) et/ou [**CMSPCallBase :: ReceiveTSPCallData**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-receivetspcalldata), et/ou en appelant [**PostEvent**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-postevent) sur votre objet Address, ou [**HandleStreamEvent**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-handlestreamevent) sur votre objet d’appel (à partir de votre appel ou de vos objets Stream).</span><span class="sxs-lookup"><span data-stu-id="509a7-159">Override [**CMSPAddress::ReceiveTSPAddressData**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-receivetspaddressdata) and/or [**CMSPCallBase::ReceiveTSPCallData**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-receivetspcalldata), and/or by calling [**PostEvent**](/windows/desktop/api/Mspaddr/nf-mspaddr-cmspaddress-postevent) on your address object, or [**HandleStreamEvent**](/windows/desktop/api/Mspcall/nf-mspcall-cmspcallbase-handlestreamevent) on your call object (from either your call or stream objects).</span></span>
14. <span data-ttu-id="509a7-160">Utilisez PostEvent sur votre objet Address, ou HandleStreamEvent sur votre objet d’appel (à partir de votre appel ou de Stream Objects) pour envoyer des événements de média d’appel à l’application via Tapi3.dll.</span><span class="sxs-lookup"><span data-stu-id="509a7-160">Use PostEvent on your address object, or HandleStreamEvent on your call object (from either your call or stream objects) to send call media events to the application via Tapi3.dll.</span></span> <span data-ttu-id="509a7-161">En général, vous effectuez cette opération sur votre objet de flux, dans les méthodes substituées, notamment les méthodes [**ProcessGraphEvent**](/windows/desktop/api/Mspstrm/nf-mspstrm-cmspstream-processgraphevent), [**StopStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-stopstream), [**StartStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-startstream), [**PauseStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-pausestream), [**SelectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal)et [**UnselectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) , selon la manière dont vous implémentez vos flux.</span><span class="sxs-lookup"><span data-stu-id="509a7-161">You will typically do this on your stream object, in overridden methods including the [**ProcessGraphEvent**](/windows/desktop/api/Mspstrm/nf-mspstrm-cmspstream-processgraphevent), [**StopStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-stopstream), [**StartStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-startstream), [**PauseStream**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-pausestream), [**SelectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-selectterminal), and [**UnselectTerminal**](/windows/win32/api/tapi3if/nf-tapi3if-itstream-unselectterminal) methods, depending on how you implement your streams.</span></span>
15. <span data-ttu-id="509a7-162">Implémentez les interfaces ou sous-flux privés souhaités sur vos objets existants (adresse, appel et flux).</span><span class="sxs-lookup"><span data-stu-id="509a7-162">Implement any desired private interfaces or substreams on your existing objects (address, call, and stream).</span></span> <span data-ttu-id="509a7-163">En général, il n’y en a aucun.</span><span class="sxs-lookup"><span data-stu-id="509a7-163">Usually there are none.</span></span> <span data-ttu-id="509a7-164">Sachez que lors de l’implémentation de vos interfaces privées, spécifiez le LIBID de votre bibliothèque de types à partir de votre fichier IDL.</span><span class="sxs-lookup"><span data-stu-id="509a7-164">Be aware that when implementing your private interfaces, specify the LIBID of your type library from your IDL file.</span></span> <span data-ttu-id="509a7-165">Autrement dit, les programmeurs d’applications doivent utiliser votre bibliothèque de types MSP lorsque vous utilisez vos interfaces personnalisées.</span><span class="sxs-lookup"><span data-stu-id="509a7-165">That is, application programmers must use your MSP type library when using your custom interfaces.</span></span> <span data-ttu-id="509a7-166">Les interfaces MSP standard, implémentées dans les classes de base MSP, utilisent le LIBID Tapi3.dll et sont donc accessibles à toutes les applications TAPI 3.</span><span class="sxs-lookup"><span data-stu-id="509a7-166">The standard MSP interfaces, implemented in the MSP base classes, use the Tapi3.dll LIBID and are therefore accessible to all TAPI 3 applications.</span></span>
16. <span data-ttu-id="509a7-167">Si vous implémentez des objets terminaux statiques ou dynamiques spécifiques à MSP ou des remplacements pour les terminaux statiques par défaut (non standard), vous pouvez utiliser les classes de base de terminal fournies.</span><span class="sxs-lookup"><span data-stu-id="509a7-167">If implementing MSP-specific static or dynamic terminal objects or replacements for the default static terminals (not typical), you can use the provided terminal base classes.</span></span> <span data-ttu-id="509a7-168">Vous devrez remplacer différentes méthodes sur votre objet d’adresse pour fournir des méthodes alternatives ou supplémentaires pour la création d’objets terminaux.</span><span class="sxs-lookup"><span data-stu-id="509a7-168">You will have to override various methods on your address object to provide alternative or additional methods of creating terminal objects.</span></span>
17. <span data-ttu-id="509a7-169">Implémentez l’interface IObjectSafety sur vos objets d’adresse, d’appel, de flux et de terminal.</span><span class="sxs-lookup"><span data-stu-id="509a7-169">Implement the IObjectSafety interface on your Address, Call, Stream, and Terminal objects.</span></span> <span data-ttu-id="509a7-170">Pour utiliser le [Mappeur de dispatch](dispatch-mapper.md) pour interroger les interfaces sur vos objets MSP, marquez vos objets comme sécurisés pour les scripts sur ces interfaces.</span><span class="sxs-lookup"><span data-stu-id="509a7-170">To use [Dispatch Mapper](dispatch-mapper.md) to query for interfaces on your MSP objects, mark your objects as safe for scripting on these interfaces.</span></span> <span data-ttu-id="509a7-171">Pour ce faire, implémentez l’interface **IObjectSafety** sur votre objet.</span><span class="sxs-lookup"><span data-stu-id="509a7-171">To do this, implement the **IObjectSafety** interface on your object.</span></span> <span data-ttu-id="509a7-172">La dérivation à partir de **CMSPObjectSafetyImpl** (une classe d’assistance fournie dans Msputils. h) et l’ajout d' **IOBJECTSAFETY** au mappage COM ATL de votre classe \_ rend vos objets sécurisés pour les scripts sur toutes les interfaces qu’ils exposent.</span><span class="sxs-lookup"><span data-stu-id="509a7-172">Deriving from **CMSPObjectSafetyImpl** (a helper class provided in Msputils.h) and adding **IObjectSafety** to your class's ATL COM\_MAP will make your objects safe for scripting on all the interfaces they expose.</span></span> <span data-ttu-id="509a7-173">N’oubliez pas que l’utilisation du mappeur de répartition sur les objets MSP peut être implicite.</span><span class="sxs-lookup"><span data-stu-id="509a7-173">Be aware that using Dispatch Mapper on MSP objects could be implicit.</span></span> <span data-ttu-id="509a7-174">L’adresse MSP et l’appel MSP sont agrégés par l’adresse TAPI et les objets d’appel TAPI.</span><span class="sxs-lookup"><span data-stu-id="509a7-174">MSP Address and MSP Call are aggregated by TAPI Address and TAPI Call objects.</span></span> <span data-ttu-id="509a7-175">Si le mappeur de répartition est utilisé sur les objets TAPI pour interroger les interfaces exposées par les objets MSP agrégés, les objets MSP agrégés sont interrogés pour la sécurité des interfaces demandées.</span><span class="sxs-lookup"><span data-stu-id="509a7-175">If Dispatch Mapper is used on the TAPI objects to query for the interfaces exposed by the aggregated MSP objects, the aggregated MSP objects will be queried for safety of the requested interfaces.</span></span>

 

 
