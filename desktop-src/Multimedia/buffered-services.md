---
title: Services en mémoire tampon
description: Services en mémoire tampon
ms.assetid: 4816ab05-42fc-4c22-b753-8fd153d88c27
keywords:
- e/s de fichier multimédia, services mis en mémoire tampon
- e/s de fichier, services mis en mémoire tampon
- entrées et sorties (e/s), services mis en mémoire tampon
- E/s (entrée et sortie), services mis en mémoire tampon
- e/s mises en mémoire tampon
- mmioOpen fonction)
- mémoire tampon d’e/s interne
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: d014ed765609dd43886cc7b33987f8fd5ac7e65a
ms.sourcegitcommit: 7ef31bf778e76ce4196205d4c4c632fbdc649805
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 02/05/2021
ms.locfileid: "103953295"
---
# <a name="buffered-services"></a><span data-ttu-id="7a77b-110">Services en mémoire tampon</span><span class="sxs-lookup"><span data-stu-id="7a77b-110">Buffered Services</span></span>

<span data-ttu-id="7a77b-111">La majeure partie de la surcharge des e/s de fichier se produit lors de l’accès à l’appareil multimédia.</span><span class="sxs-lookup"><span data-stu-id="7a77b-111">Most of the overhead in file I/O occurs when accessing the media device.</span></span> <span data-ttu-id="7a77b-112">Si vous lisez ou écrivez de nombreux petits blocs d’informations, l’appareil peut passer beaucoup de temps à se déplacer vers l’emplacement physique sur le support pour chaque opération de lecture ou d’écriture.</span><span class="sxs-lookup"><span data-stu-id="7a77b-112">If you are reading or writing many small blocks of information, the device can spend a lot of time moving to the physical location on the media for each read or write operation.</span></span> <span data-ttu-id="7a77b-113">Dans ce cas, vous pouvez obtenir de meilleures performances en utilisant les services d’e/s de fichier mis en mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-113">In this case, you can achieve better performance by using buffered file I/O services.</span></span> <span data-ttu-id="7a77b-114">Avec les e/s mises en mémoire tampon, le gestionnaire d’e/s de fichier gère une mémoire tampon intermédiaire plus grande que les blocs d’informations que vous lisez ou écrivez.</span><span class="sxs-lookup"><span data-stu-id="7a77b-114">With buffered I/O, the file I/O manager maintains an intermediate buffer larger than the blocks of information you are reading or writing.</span></span> <span data-ttu-id="7a77b-115">Elle accède à l’appareil uniquement lorsque la mémoire tampon doit être remplie ou écrite sur le disque.</span><span class="sxs-lookup"><span data-stu-id="7a77b-115">It accesses the device only when the buffer must be filled from or written to the disk.</span></span>

<span data-ttu-id="7a77b-116">Avant de configurer et d’utiliser des e/s de fichier mises en mémoire tampon, vous devez décider si vous souhaitez que le gestionnaire d’e/s de fichier ou l’application alloue la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-116">Before you set up and use buffered file I/O, you must decide whether you want the file I/O manager or the application to allocate the buffer.</span></span> <span data-ttu-id="7a77b-117">Il est plus simple de laisser le gestionnaire d’e/s de fichier allouer la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-117">It is simpler to let the file I/O manager allocate the buffer.</span></span> <span data-ttu-id="7a77b-118">Toutefois, vous pouvez laisser l’application allouer la mémoire tampon si vous souhaitez accéder directement à la mémoire tampon ou ouvrir un fichier de mémoire.</span><span class="sxs-lookup"><span data-stu-id="7a77b-118">However, you can let the application allocate the buffer if you want to directly access the buffer or open a memory file.</span></span> <span data-ttu-id="7a77b-119">Pour plus d’informations sur l’utilisation des fichiers de mémoire, consultez [exécution d’e/s de fichier mémoire](performing-memory-file-i-o.md).</span><span class="sxs-lookup"><span data-stu-id="7a77b-119">For more information about using memory files, see [Performing Memory File I/O](performing-memory-file-i-o.md).</span></span> <span data-ttu-id="7a77b-120">Pour obtenir un exemple d’accès direct à une mémoire tampon d’e/s, consultez [accès à un tampon d’e/s de fichier](accessing-a-file-i-o-buffer.md)</span><span class="sxs-lookup"><span data-stu-id="7a77b-120">For an example of directly accessing an I/O buffer, see [Accessing a File I/O Buffer](accessing-a-file-i-o-buffer.md)</span></span>

<span data-ttu-id="7a77b-121">Une mémoire tampon allouée par le gestionnaire d’e/s de fichier est appelée une mémoire tampon d’e/s interne.</span><span class="sxs-lookup"><span data-stu-id="7a77b-121">A buffer allocated by the file I/O manager is called an internal I/O buffer.</span></span> <span data-ttu-id="7a77b-122">Pour ouvrir un fichier pour les e/s mises en mémoire tampon à l’aide d’une mémoire tampon interne, spécifiez l' \_ indicateur MMIO ALLOCBUF quand vous ouvrez le fichier avec la fonction [**mmioOpen**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioopen) .</span><span class="sxs-lookup"><span data-stu-id="7a77b-122">To open a file for buffered I/O using an internal buffer, specify the MMIO\_ALLOCBUF flag when you open the file with the [**mmioOpen**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioopen) function.</span></span> <span data-ttu-id="7a77b-123">L’illustration suivante montre l’état initial du tampon d’e/s de fichier une fois qu’un fichier a été ouvert pour une opération de lecture mise en mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-123">The following illustration shows the initial state of the file I/O buffer after a file is opened for a buffered read operation.</span></span> <span data-ttu-id="7a77b-124">La mise en mémoire tampon est transparente : vous lisez et recherchez comme si vous utilisiez des e/s non mises en mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-124">The buffering is transparent — you read and seek as if you were using unbuffered I/O.</span></span> <span data-ttu-id="7a77b-125">La fonction **mmioOpen** a défini PchNext et *pchEndRead* pour qu’elle pointe vers le début de la mémoire tampon d’e/s de fichier.</span><span class="sxs-lookup"><span data-stu-id="7a77b-125">The **mmioOpen** function has set pchNext and *pchEndRead* to point to the beginning of the file I/O buffer.</span></span>

![Capture d’écran montrant « pchEndRead » et « pchNext » pointant vers le début de la mémoire tampon d’e/s de fichier.](images/mmio7.gif)

<span data-ttu-id="7a77b-127">L’illustration suivante montre l’état initial du tampon d’e/s de fichier une fois qu’un fichier a été ouvert pour une opération d’écriture en mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-127">The following illustration shows the initial state of the file I/O buffer after a file is opened for a buffered write operation.</span></span> <span data-ttu-id="7a77b-128">La fonction **mmioOpen** a défini **pchNext** pour pointer vers le début de la mémoire tampon d’e/s de fichier et **pchEndWrite** pour pointer vers la fin de la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-128">The **mmioOpen** function has set **pchNext** to point to the beginning of the file I/O buffer and **pchEndWrite** to point to the end of the buffer.</span></span>

![Capture d’écran montrant « pchNext » au début de la mémoire tampon d’e/s de fichier et « pchEndWrite » à la fin.](images/mmio11.gif)

<span data-ttu-id="7a77b-130">La taille par défaut de la mémoire tampon d’e/s interne est de 8 Ko.</span><span class="sxs-lookup"><span data-stu-id="7a77b-130">The default size of the internal I/O buffer is 8K.</span></span> <span data-ttu-id="7a77b-131">Si cette taille n’est pas appropriée, vous pouvez utiliser la fonction [**mmioSetBuffer**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetbuffer) pour modifier la taille de la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-131">If this size is not adequate, you can use the [**mmioSetBuffer**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetbuffer) function to change the buffer size.</span></span> <span data-ttu-id="7a77b-132">Vous pouvez également utiliser cette fonction pour activer la mise en mémoire tampon sur un fichier ouvert pour des e/s non mises en mémoire tampon, ou pour fournir votre propre mémoire tampon à utiliser comme fichier de mémoire.</span><span class="sxs-lookup"><span data-stu-id="7a77b-132">You can also use this function to enable buffering on a file opened for unbuffered I/O, or to supply your own buffer for use as a memory file.</span></span>

<span data-ttu-id="7a77b-133">Vous pouvez forcer l’écriture du contenu d’une mémoire tampon d’e/s sur le disque à l’aide de la fonction [**mmioFlush**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioflush) .</span><span class="sxs-lookup"><span data-stu-id="7a77b-133">You can force the contents of an I/O buffer to be written to disk by using the [**mmioFlush**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioflush) function.</span></span> <span data-ttu-id="7a77b-134">Toutefois, lorsque vous fermez un fichier à l’aide de la fonction [**mmioClose**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioclose) , il n’est pas nécessaire d’appeler **mmioFlush** pour vider une mémoire tampon d’e/s ; la fonction **mmioClose** la vide automatiquement.</span><span class="sxs-lookup"><span data-stu-id="7a77b-134">However, when you close a file by using the [**mmioClose**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioclose) function, you do not have to call **mmioFlush** to flush an I/O buffer — the **mmioClose** function automatically flushes it.</span></span> <span data-ttu-id="7a77b-135">Si l’espace disque est insuffisant, **mmioFlush** peut échouer, même si les appels précédents à la fonction [**mmioWrite**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiowrite) ont réussi.</span><span class="sxs-lookup"><span data-stu-id="7a77b-135">If you run out of disk space, **mmioFlush** could fail, even if the preceding calls to the [**mmioWrite**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiowrite) function were successful.</span></span> <span data-ttu-id="7a77b-136">De même, **mmioClose** peut échouer lorsqu’il vide son tampon d’e/s.</span><span class="sxs-lookup"><span data-stu-id="7a77b-136">Similarly, **mmioClose** could fail when it is flushing its I/O buffer.</span></span>

<span data-ttu-id="7a77b-137">Les applications qui sont sensibles aux performances, telles que celles qui diffusent des données en temps réel à partir d’un CD-ROM, peuvent optimiser les performances d’e/s de fichier en accédant directement à la mémoire tampon d’e/s.</span><span class="sxs-lookup"><span data-stu-id="7a77b-137">Applications that are performance-sensitive, such as those that stream data in real time from a CD-ROM, can optimize file I/O performance by directly accessing the I/O buffer.</span></span> <span data-ttu-id="7a77b-138">Vous devez faire attention si vous choisissez de le faire, car vous ignorez certaines des protections et la vérification des erreurs fournies par le gestionnaire d’e/s de fichier.</span><span class="sxs-lookup"><span data-stu-id="7a77b-138">You should be careful if you choose to do this, because you bypass some of the safeguards and error checking provided by the file I/O manager.</span></span>

<span data-ttu-id="7a77b-139">Le gestionnaire d’e/s de fichier multimédia utilise la structure [**MMIOINFO**](/previous-versions//dd757322(v=vs.85)) pour conserver les informations d’État relatives à un fichier ouvert.</span><span class="sxs-lookup"><span data-stu-id="7a77b-139">The multimedia file I/O manager uses the [**MMIOINFO**](/previous-versions//dd757322(v=vs.85)) structure to maintain state information about an open file.</span></span> <span data-ttu-id="7a77b-140">Vous utilisez trois membres dans cette structure pour lire et écrire le tampon d’e/s : **pchNext**, **pchEndRead** et **pchEndWrite**.</span><span class="sxs-lookup"><span data-stu-id="7a77b-140">You use three members in this structure to read and write the I/O buffer: **pchNext**, **pchEndRead**, and **pchEndWrite**.</span></span> <span data-ttu-id="7a77b-141">Le membre **pchNext** pointe vers l’emplacement suivant dans la mémoire tampon pour la lecture ou l’écriture.</span><span class="sxs-lookup"><span data-stu-id="7a77b-141">The **pchNext** member points to the next location in the buffer to read or write.</span></span> <span data-ttu-id="7a77b-142">Vous devez incrémenter ce membre lors de la lecture et de l’écriture de la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-142">You must increment this member as you read and write the buffer.</span></span> <span data-ttu-id="7a77b-143">Le membre **pchEndRead** identifie le dernier caractère valide que vous pouvez lire à partir de la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-143">The **pchEndRead** member identifies the last valid character you can read from the buffer.</span></span> <span data-ttu-id="7a77b-144">De même, ce membre identifie le dernier emplacement dans la mémoire tampon que vous pouvez écrire.</span><span class="sxs-lookup"><span data-stu-id="7a77b-144">Likewise, this member identifies the last location in the buffer you can write.</span></span> <span data-ttu-id="7a77b-145">Plus précisément, **pchEndRead** et **pchEndWrite** pointent vers l’emplacement de mémoire qui suit les dernières données valides dans la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-145">More precisely, both **pchEndRead** and **pchEndWrite** point to the memory location that follows the last valid data in the buffer.</span></span> <span data-ttu-id="7a77b-146">Utilisez les fonctions [**mmioGetInfo**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiogetinfo) et [**mmioSetInfo**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetinfo) pour récupérer et définir des informations d’État sur le tampon d’e/s de fichier.</span><span class="sxs-lookup"><span data-stu-id="7a77b-146">Use the [**mmioGetInfo**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiogetinfo) and [**mmioSetInfo**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmiosetinfo) functions to retrieve and set state information about the file I/O buffer.</span></span> <span data-ttu-id="7a77b-147">L’illustration suivante montre l’état de la mémoire tampon d’e/s après que l’application a appelé **mmioAdvance** au cours d’une opération de lecture.</span><span class="sxs-lookup"><span data-stu-id="7a77b-147">The following illustration shows the state of the I/O buffer after the application calls **mmioAdvance** during a read operation.</span></span> <span data-ttu-id="7a77b-148">La fonction **mmioAdvance** remplit la mémoire tampon et définit le pointeur **pchEndRead** à la fin de la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-148">The **mmioAdvance** function fills the buffer and sets the **pchEndRead** pointer to the end of the buffer.</span></span>

![Capture d’écran montrant « pchNext » au début de la mémoire tampon d’e/s de fichier et « pchEndRead » à la fin.](images/mmio8.gif)

<span data-ttu-id="7a77b-150">Dans l’illustration suivante, l’application lit le tampon d’e/s à l’emplacement spécifié par **pchNext** et avance le pointeur.</span><span class="sxs-lookup"><span data-stu-id="7a77b-150">In the following illustration, the application reads from the I/O buffer at the location specified by **pchNext**, and advances the pointer.</span></span>

![Capture d’écran qui affiche « pchNext » au milieu de la mémoire tampon d’e/s de fichier et « pchEndRead » à la fin.](images/mmio9.gif)

<span data-ttu-id="7a77b-152">De même, pour une opération d’écriture, l’application écrit dans la mémoire tampon d’e/s et avance le pointeur **pchNext** , comme indiqué dans l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="7a77b-152">Similarly, for a write operation, the application writes to the I/O buffer and advances the **pchNext** pointer, as shown in the following illustration.</span></span>

![Capture d’écran qui affiche « pchNext » au milieu de la mémoire tampon d’e/s de fichier et « pchEndWrite » à la fin.](images/mmio12.gif)

<span data-ttu-id="7a77b-154">Une fois que l’application a rempli la mémoire tampon, elle appelle **mmioAdvance** pour vider la mémoire tampon sur le disque.</span><span class="sxs-lookup"><span data-stu-id="7a77b-154">After the application fills the buffer, it calls **mmioAdvance** to flush the buffer to disk.</span></span> <span data-ttu-id="7a77b-155">La fonction **mmioAdvance** réinitialise **pchNext** pour qu’elle pointe vers le début de la mémoire tampon, comme indiqué dans l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="7a77b-155">The **mmioAdvance** function resets **pchNext** to point to the beginning of the buffer, as shown in the following illustration.</span></span>

![Capture d’écran qui affiche « pchNext » au début de la mémoire tampon d’e/s de fichier, la mémoire tampon au milieu de l’E O F et « pchEndWrite » à la fin de la mémoire tampon.](images/mmio13.gif)

<span data-ttu-id="7a77b-157">Lorsque vous atteignez la fin de la mémoire tampon d’e/s, vous devez avancer le tampon pour le remplir à partir du disque, si vous lisez ou le videz sur le disque, si vous écrivez.</span><span class="sxs-lookup"><span data-stu-id="7a77b-157">When you reach the end of the I/O buffer, you must advance the buffer to fill it from the disk, if you are reading, or flush it to the disk, if you are writing.</span></span> <span data-ttu-id="7a77b-158">Utilisez la fonction [**mmioAdvance**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioadvance) pour avancer un tampon d’e/s.</span><span class="sxs-lookup"><span data-stu-id="7a77b-158">Use the [**mmioAdvance**](/windows/win32/api/mmiscapi/nf-mmiscapi-mmioadvance) function to advance an I/O buffer.</span></span> <span data-ttu-id="7a77b-159">Pour remplir une mémoire tampon d’e/s à partir du disque, utilisez **mmioAdvance** avec l' \_ indicateur de lecture MMIO.</span><span class="sxs-lookup"><span data-stu-id="7a77b-159">To fill an I/O buffer from disk, use **mmioAdvance** with the MMIO\_READ flag.</span></span> <span data-ttu-id="7a77b-160">Si les données restantes dans le fichier ne sont pas suffisantes pour remplir la mémoire tampon, le membre **pchEndRead** de la structure **MMIOINFO** pointe vers l’emplacement qui suit le dernier octet valide dans la mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="7a77b-160">If there is not enough data remaining in the file to fill the buffer, the **pchEndRead** member of the **MMIOINFO** structure points to the location following the last valid byte in the buffer.</span></span> <span data-ttu-id="7a77b-161">Pour vider un tampon sur un disque, définissez l' \_ indicateur de modification MMIO dans le membre **dwFlags** de la structure **MMIOINFO** , puis appelez **MMIOADVANCE** avec l’indicateur d' \_ écriture MMIO.</span><span class="sxs-lookup"><span data-stu-id="7a77b-161">To flush a buffer to disk, set the MMIO\_DIRTY flag in the **dwFlags** member of the **MMIOINFO** structure and then call **mmioAdvance** with the MMIO\_WRITE flag.</span></span>

<span data-ttu-id="7a77b-162">Par exemple, lors d’une opération de lecture, la fonction **mmioAdvance** définit **pchEndRead** pour qu’elle pointe vers la fin des données valides dans la mémoire tampon, comme indiqué dans l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="7a77b-162">For example, during a read operation, the **mmioAdvance** function sets **pchEndRead** to point to the end of valid data in the buffer, as shown in the following illustration.</span></span>

![Capture d’écran qui affiche « pchNext » au début de la mémoire tampon d’e/s de fichier, la mémoire tampon à la fin de E O F et « pchEndRead » à la fin de la mémoire tampon.](images/mmio10.gif)

<span data-ttu-id="7a77b-164">De même, au cours d’une opération d’écriture, l’application appelle **mmioAdvance** pour vider la mémoire tampon et avancer **pchNext** à la fin des données valides dans la mémoire tampon, comme indiqué dans l’illustration suivante.</span><span class="sxs-lookup"><span data-stu-id="7a77b-164">Similarly, during a write operation, the application calls **mmioAdvance** to flush the buffer and advance **pchNext** to the end of valid data in the buffer, as shown in the following illustration.</span></span>

![image de tampon d’e/s de fichier](images/mmio14.gif)

 

 