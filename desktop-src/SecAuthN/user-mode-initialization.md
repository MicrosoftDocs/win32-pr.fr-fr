---
description: Les applications distribuées (client/serveur) utilisent des packages de sécurité pour obtenir des connexions authentifiées et échanger des messages.
ms.assetid: 8f28177f-335a-4fa2-bf66-2ec1698bebec
title: Initialisation du mode utilisateur
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 473b06daf2e1c3612b02583d203ce4cd9afebabd
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/08/2021
ms.locfileid: "103952580"
---
# <a name="user-mode-initialization"></a><span data-ttu-id="69905-103">Initialisation du mode utilisateur</span><span class="sxs-lookup"><span data-stu-id="69905-103">User Mode Initialization</span></span>

<span data-ttu-id="69905-104">Les applications distribuées (client/serveur) utilisent des [*packages de sécurité*](../secgloss/s-gly.md) pour obtenir des connexions authentifiées et échanger des messages.</span><span class="sxs-lookup"><span data-stu-id="69905-104">Distributed (client/server) applications use [*security packages*](../secgloss/s-gly.md) to obtain authenticated connections and to exchange messages.</span></span> <span data-ttu-id="69905-105">L’application appelle les fonctions SSPI (Security Support Provider Interface) qui sont mappées aux [fonctions implémentées par le fournisseur SSP/APS](authentication-functions.md), ainsi que les [fonctions implémentées par SSP/APS en mode utilisateur](authentication-functions.md).</span><span class="sxs-lookup"><span data-stu-id="69905-105">The application calls security support provider interface (SSPI) functions which are mapped to [functions implemented by SSP/APs](authentication-functions.md), and [functions implemented by User-mode SSP/APs](authentication-functions.md).</span></span> <span data-ttu-id="69905-106">Ce mappage est effectué par la DLL du fournisseur de sécurité (Secur32.dll ou Security.dll), qui peut être chargée dynamiquement dans les processus du client et du serveur.</span><span class="sxs-lookup"><span data-stu-id="69905-106">This mapping is performed by the security provider DLL (Secur32.dll or Security.dll), which can be loaded into the client and server processes dynamically.</span></span> <span data-ttu-id="69905-107">La DLL peut également être liée de manière statique à l’aide de secur32. lib.</span><span class="sxs-lookup"><span data-stu-id="69905-107">The DLL can also be statically linked using Secur32.lib.</span></span> <span data-ttu-id="69905-108">La DLL et la bibliothèque sont fournies avec le kit de développement logiciel (SDK) Microsoft Windows.</span><span class="sxs-lookup"><span data-stu-id="69905-108">Both the DLL and LIB ship with the Microsoft Windows Software Development Kit (SDK).</span></span>

<span data-ttu-id="69905-109">Le chargement du package de sécurité dans le processus du client ou du serveur est géré par le système, si la DLL SSP/AP qui contient le package de sécurité est correctement inscrite.</span><span class="sxs-lookup"><span data-stu-id="69905-109">Loading the security package into the client or server's process is handled by the system, if the SSP/AP DLL that contains the security package is properly registered.</span></span>

<span data-ttu-id="69905-110">Le serveur commence le processus d’obtention d’une connexion sécurisée avec un client en surveillant un port, en attendant qu’un client envoie un message.</span><span class="sxs-lookup"><span data-stu-id="69905-110">The server begins the process of obtaining a secure connection with a client by monitoring a port, waiting for a client to send a message.</span></span> <span data-ttu-id="69905-111">Le client commence le processus d’obtention d’une connexion sécurisée au serveur en appelant la fonction SSPI [**InitializeSecurityContext (général)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span><span class="sxs-lookup"><span data-stu-id="69905-111">The client begins the process of obtaining a secure connection to the server by calling the SSPI function [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span></span> <span data-ttu-id="69905-112">Cette fonction est mappée à la fonction [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) du package de sécurité personnalisé.</span><span class="sxs-lookup"><span data-stu-id="69905-112">This function is mapped to the custom security package's [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function.</span></span> <span data-ttu-id="69905-113">**SpInitLsaModeContext** retourne un jeton au client, qui le transfère au serveur.</span><span class="sxs-lookup"><span data-stu-id="69905-113">**SpInitLsaModeContext** returns a token to the client, who forwards it to the server.</span></span>

<span data-ttu-id="69905-114">Lors de la réception du jeton du client, le serveur appelle la fonction SSPI [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), qui est distribuée à la fonction [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) du package de sécurité.</span><span class="sxs-lookup"><span data-stu-id="69905-114">Upon receiving the token from the client, the server calls the SSPI function [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), which is dispatched to the security package's [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) function.</span></span> <span data-ttu-id="69905-115">Si la fonction **SpAcceptLsaModeContext** réussit et qu’aucun autre traitement n’est nécessaire pour établir le contexte de sécurité, la fonction doit retourner l’état \_ Success à l’appelant.</span><span class="sxs-lookup"><span data-stu-id="69905-115">If the **SpAcceptLsaModeContext** function succeeds and no more processing is required to establish the security context, the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="69905-116">Si un traitement supplémentaire est requis, la fonction doit retourner SEC \_ je \_ continue \_ nécessaire et retourner un jeton au serveur.</span><span class="sxs-lookup"><span data-stu-id="69905-116">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the server.</span></span> <span data-ttu-id="69905-117">Le serveur transfère le jeton au client, qui appelle [**InitializeSecurityContext (général)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) .</span><span class="sxs-lookup"><span data-stu-id="69905-117">The server forwards the token to the client, who calls [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) again.</span></span>

<span data-ttu-id="69905-118">Ce cycle appelant peut être répété aussi souvent que nécessaire, jusqu’à ce qu’une connexion authentifiée soit établie ou échoue.</span><span class="sxs-lookup"><span data-stu-id="69905-118">This calling cycle may be repeated as often as necessary until an authenticated connection is established or fails.</span></span> <span data-ttu-id="69905-119">Au cours de ce processus, si la fonction [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) ou [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) réussit et qu’aucun autre traitement n’est nécessaire pour établir le [*contexte de sécurité*](../secgloss/s-gly.md), la fonction doit retourner l’état \_ Success à l’appelant.</span><span class="sxs-lookup"><span data-stu-id="69905-119">During this process, if the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) or [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function succeeds and no more processing is required to establish the [*security context*](../secgloss/s-gly.md), the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="69905-120">Si un traitement supplémentaire est requis, la fonction doit retourner SEC \_ je \_ continue \_ nécessaire et retourner un jeton à l’appelant, qui est chargé de le transférer.</span><span class="sxs-lookup"><span data-stu-id="69905-120">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the caller, who is responsible for forwarding it.</span></span>

<span data-ttu-id="69905-121">Le protocole implémenté par le package de sécurité détermine le nombre de fois où ce cycle est répété.</span><span class="sxs-lookup"><span data-stu-id="69905-121">The protocol implemented by the security package determines the number of times this cycle is repeated.</span></span> <span data-ttu-id="69905-122">Par exemple, dans les packages de sécurité qui prennent en charge l’authentification mutuelle à trois jambes, la séquence d’appel est la suivante :</span><span class="sxs-lookup"><span data-stu-id="69905-122">For example, in security packages that supports three-leg mutual authentication, the calling sequence is as follows:</span></span>

1.  <span data-ttu-id="69905-123">Le client obtient un jeton en appelant [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)et l’envoie au serveur.</span><span class="sxs-lookup"><span data-stu-id="69905-123">Client obtains a token by calling [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and sends it to the server.</span></span> <span data-ttu-id="69905-124">Le serveur appelle [**AcceptSecurityContext (général)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) la première fois et récupère un jeton de réponse qu’il envoie au client.</span><span class="sxs-lookup"><span data-stu-id="69905-124">The server calls [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) the first time, and gets back a reply token which it sends to the client.</span></span>
2.  <span data-ttu-id="69905-125">Le client utilise le jeton reçu du serveur lors d’un deuxième appel à [**InitializeSecurityContext (général)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)et récupère un jeton final.</span><span class="sxs-lookup"><span data-stu-id="69905-125">The client uses the token received from the server in a second call to [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and gets back a final token.</span></span> <span data-ttu-id="69905-126">Le client envoie ce jeton au serveur.</span><span class="sxs-lookup"><span data-stu-id="69905-126">The client sends this token to the server.</span></span>
3.  <span data-ttu-id="69905-127">Le serveur reçoit le jeton généré dans Leg 2 qu’il utilise dans l’appel final à [**AcceptSecurityContext (général)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).</span><span class="sxs-lookup"><span data-stu-id="69905-127">The server receives the token generated in leg 2 which it uses in the final call to [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).</span></span>

<span data-ttu-id="69905-128">Lorsque les fonctions [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) et [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) réussissent et qu’aucun traitement supplémentaire n’est nécessaire pour établir le contexte de sécurité, les fonctions doivent retourner l’état \_ Success à l’appelant.</span><span class="sxs-lookup"><span data-stu-id="69905-128">When the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) and [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) functions succeed and no more processing is required to establish the security context, the functions should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="69905-129">En outre, si le package de sécurité personnalisé prend en charge les [fonctions implémentées par SSP/APS en mode utilisateur](authentication-functions.md), **SpAcceptLsaModeContext** et **SpInitLsaModeContext** doivent retourner la **valeur true** par le biais du paramètre *MappedContext* .</span><span class="sxs-lookup"><span data-stu-id="69905-129">Additionally, if the custom security package supports the [functions implemented by user-mode SSP/APs](authentication-functions.md), **SpAcceptLsaModeContext** and **SpInitLsaModeContext** must return **TRUE** by way of the *MappedContext* parameter.</span></span> <span data-ttu-id="69905-130">La valeur *MappedContext* n’est pas renvoyée à l’application ; elle est interceptée par l’autorité LSA.</span><span class="sxs-lookup"><span data-stu-id="69905-130">The *MappedContext* value is not passed back to the application; it is intercepted by the LSA.</span></span>

<span data-ttu-id="69905-131">Quand *MappedContext* a la **valeur true**, l’autorité LSA appelle la fonction [**SpUsermodeInitialize**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) de la dll SSP/AP.</span><span class="sxs-lookup"><span data-stu-id="69905-131">When *MappedContext* is **true**, the LSA calls the SSP/AP DLL's [**SpUsermodeInitialize**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) function.</span></span> <span data-ttu-id="69905-132">Cette fonction fournit des tableaux de pointeurs vers les fonctions en mode utilisateur implémentées par chaque package de sécurité.</span><span class="sxs-lookup"><span data-stu-id="69905-132">This function provides tables of pointers to the user-mode functions implemented by each security package.</span></span> <span data-ttu-id="69905-133">La fonction [**SpInstanceInit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) de chaque package est appelée, à l’aide des tables de fonctions retournées par **SpUsermodeInitialize**.</span><span class="sxs-lookup"><span data-stu-id="69905-133">Each package's [**SpInstanceInit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) function is called, using the function tables returned by **SpUsermodeInitialize**.</span></span> <span data-ttu-id="69905-134">**SpInstanceInit** reçoit une table de pointeurs vers les [fonctions LSA appelées par SSP/APS en mode utilisateur](authentication-functions.md).</span><span class="sxs-lookup"><span data-stu-id="69905-134">**SpInstanceInit** receives a table of pointers to [LSA functions called by user-mode SSP/APs](authentication-functions.md).</span></span>

 

 
